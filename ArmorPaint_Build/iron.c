#include <iron.h>

#include "../libs/asim.h"
#include "../libs/asim.h"
#include "const_data.h"
typedef enum{
	dilate_type_t_INSTANT,
	dilate_type_t_DELAYED,
}dilate_type_t;

typedef enum{
	bake_type_t_INIT=-1,
	bake_type_t_AO=0,
	bake_type_t_CURVATURE=1,
	bake_type_t_NORMAL=2,
	bake_type_t_NORMAL_OBJECT=3,
	bake_type_t_HEIGHT=4,
	bake_type_t_DERIVATIVE=5,
	bake_type_t_POSITION=6,
	bake_type_t_TEXCOORD=7,
	bake_type_t_MATERIALID=8,
	bake_type_t_OBJECTID=9,
	bake_type_t_VERTEX_COLOR=10,
	bake_type_t_LIGHTMAP=11,
	bake_type_t_BENT_NORMAL=12,
	bake_type_t_THICKNESS=13,
}bake_type_t;

typedef enum{
	split_type_t_OBJECT=0,
	split_type_t_GROUP=1,
	split_type_t_MATERIAL=2,
	split_type_t_UDIM=3,
}split_type_t;

typedef enum{
	bake_axis_t_XYZ=0,
	bake_axis_t_X=1,
	bake_axis_t_Y=2,
	bake_axis_t_Z=3,
	bake_axis_t_MX=4,
	bake_axis_t_MY=5,
	bake_axis_t_MZ=6,
}bake_axis_t;

typedef enum{
	bake_up_axis_t_Z=0,
	bake_up_axis_t_Y=1,
	bake_up_axis_t_X=2,
}bake_up_axis_t;

typedef enum{
	viewport_mode_t_MINUS_ONE=-1,
	viewport_mode_t_LIT=0,
	viewport_mode_t_BASE_COLOR=1,
	viewport_mode_t_NORMAL_MAP=2,
	viewport_mode_t_OCCLUSION=3,
	viewport_mode_t_ROUGHNESS=4,
	viewport_mode_t_METALLIC=5,
	viewport_mode_t_OPACITY=6,
	viewport_mode_t_HEIGHT=7,
	viewport_mode_t_EMISSION=8,
	viewport_mode_t_SUBSURFACE=9,
	viewport_mode_t_TEXCOORD=10,
	viewport_mode_t_OBJECT_NORMAL=11,
	viewport_mode_t_MATERIAL_ID=12,
	viewport_mode_t_OBJECT_ID=13,
	viewport_mode_t_MASK=14,
	viewport_mode_t_PATH_TRACE=15,
}viewport_mode_t;

typedef enum{
	channel_type_t_BASE_COLOR=0,
	channel_type_t_OCCLUSION=1,
	channel_type_t_ROUGHNESS=2,
	channel_type_t_METALLIC=3,
	channel_type_t_NORMAL_MAP=4,
	channel_type_t_HEIGHT=5,
}channel_type_t;

typedef enum{
	render_mode_t_DEFERRED=0,
	render_mode_t_FORWARD=1,
	render_mode_t_PATH_TRACE=2,
}render_mode_t;

typedef enum{
	export_mode_t_VISIBLE=0,
	export_mode_t_SELECTED=1,
	export_mode_t_PER_OBJECT=2,
	export_mode_t_PER_UDIM_TILE=3,
}export_mode_t;

typedef enum{
	export_destination_t_DISK=0,
	export_destination_t_PACKED=1,
}export_destination_t;

typedef enum{
	pathtrace_mode_t_FAST=0,
	pathtrace_mode_t_QUALITY=1,
}pathtrace_mode_t;

typedef enum{
	fill_type_t_OBJECT=0,
	fill_type_t_FACE=1,
	fill_type_t_ANGLE=2,
	fill_type_t_UV_ISLAND=3,
}fill_type_t;

typedef enum{
	uv_type_t_UVMAP=0,
	uv_type_t_TRIPLANAR=1,
	uv_type_t_PROJECT=2,
}uv_type_t;

typedef enum{
	picker_mask_t_NONE=0,
	picker_mask_t_MATERIAL=1,
}picker_mask_t;

typedef enum{
	blend_type_t_MIX=0,
	blend_type_t_DARKEN=1,
	blend_type_t_MULTIPLY=2,
	blend_type_t_BURN=3,
	blend_type_t_LIGHTEN=4,
	blend_type_t_SCREEN=5,
	blend_type_t_DODGE=6,
	blend_type_t_ADD=7,
	blend_type_t_OVERLAY=8,
	blend_type_t_SOFT_LIGHT=9,
	blend_type_t_LINEAR_LIGHT=10,
	blend_type_t_DIFFERENCE=11,
	blend_type_t_SUBTRACT=12,
	blend_type_t_DIVIDE=13,
	blend_type_t_HUE=14,
	blend_type_t_SATURATION=15,
	blend_type_t_COLOR=16,
	blend_type_t_VALUE=17,
}blend_type_t;

typedef enum{
	camera_controls_t_ORBIT=0,
	camera_controls_t_ROTATE=1,
	camera_controls_t_FLY=2,
}camera_controls_t;

typedef enum{
	camera_type_t_PERSPECTIVE=0,
	camera_type_t_ORTHOGRAPHIC=1,
}camera_type_t;

typedef enum{
	texture_bits_t_BITS8=0,
	texture_bits_t_BITS16=1,
	texture_bits_t_BITS32=2,
}texture_bits_t;

typedef enum{
	texture_ldr_format_t_PNG=0,
	texture_ldr_format_t_JPG=1,
}texture_ldr_format_t;

typedef enum{
	texture_hdr_format_t_EXR=0,
}texture_hdr_format_t;

typedef enum{
	mesh_format_t_OBJ=0,
	mesh_format_t_ARM=1,
}mesh_format_t;

typedef enum{
	menu_category_t_FILE=0,
	menu_category_t_EDIT=1,
	menu_category_t_VIEWPORT=2,
	menu_category_t_MODE=3,
	menu_category_t_CAMERA=4,
	menu_category_t_HELP=5,
}menu_category_t;

typedef enum{
	canvas_type_t_MATERIAL=0,
	canvas_type_t_BRUSH=1,
}canvas_type_t;

typedef enum{
	view_2d_type_t_ASSET=0,
	view_2d_type_t_NODE=1,
	view_2d_type_t_FONT=2,
	view_2d_type_t_LAYER=3,
}view_2d_type_t;

typedef enum{
	view_2d_layer_mode_t_VISIBLE=0,
	view_2d_layer_mode_t_SELECTED=1,
}view_2d_layer_mode_t;

typedef enum{
	border_side_t_LEFT=0,
	border_side_t_RIGHT=1,
	border_side_t_TOP=2,
	border_side_t_BOTTOm=3,
}border_side_t;

typedef enum{
	paint_tex_t_BASE=0,
	paint_tex_t_NORMAL=1,
	paint_tex_t_OCCLUSION=2,
	paint_tex_t_ROUGHNESS=3,
	paint_tex_t_METALLIC=4,
	paint_tex_t_OPACITY=5,
	paint_tex_t_HEIGHT=6,
}paint_tex_t;

typedef enum{
	project_model_t_ROUNDED_CUBE=0,
	project_model_t_SPHERE=1,
	project_model_t_TESSELLATED_PLANE=2,
	project_model_t_CUSTOM=3,
}project_model_t;

typedef enum{
	zoom_direction_t_VERTICAL=0,
	zoom_direction_t_VERTICAL_INVERTED=1,
	zoom_direction_t_HORIZONTAL=2,
	zoom_direction_t_HORIZONTAL_INVERTED=3,
	zoom_direction_t_VERTICAL_HORIZONTAL=4,
	zoom_direction_t_VERTICAL_HORIZONTAL_INVERTED=5,
}zoom_direction_t;

typedef enum{
	layer_slot_type_t_LAYER=0,
	layer_slot_type_t_MASK=1,
	layer_slot_type_t_GROUP=2,
}layer_slot_type_t;

typedef enum{
	space_type_t_SPACE3D=0,
	space_type_t_SPACE2D=1,
}space_type_t;

typedef enum{
	workspace_tool_t_BRUSH=0,
	workspace_tool_t_ERASER=1,
	workspace_tool_t_FILL=2,
	workspace_tool_t_DECAL=3,
	workspace_tool_t_TEXT=4,
	workspace_tool_t_CLONE=5,
	workspace_tool_t_BLUR=6,
	workspace_tool_t_SMUDGE=7,
	workspace_tool_t_PARTICLE=8,
	workspace_tool_t_COLORID=9,
	workspace_tool_t_PICKER=10,
	workspace_tool_t_BAKE=11,
	workspace_tool_t_GIZMO=12,
	workspace_tool_t_MATERIAL=13,
}workspace_tool_t;

typedef enum{
	area_type_t_MINUS_ONE=-1,
	area_type_t_VIEWPORT=0,
	area_type_t_VIEW2D=1,
	area_type_t_LAYERS=2,
	area_type_t_MATERIALS=3,
	area_type_t_NODES=4,
	area_type_t_BROWSER=5,
}area_type_t;

typedef enum{
	tab_area_t_SIDEBAR0=0,
	tab_area_t_SIDEBAR1=1,
	tab_area_t_STATUS=2,
}tab_area_t;

typedef enum{
	texture_res_t_RES128=0,
	texture_res_t_RES256=1,
	texture_res_t_RES512=2,
	texture_res_t_RES1024=3,
	texture_res_t_RES2048=4,
	texture_res_t_RES4096=5,
	texture_res_t_RES8192=6,
	texture_res_t_RES16384=7,
}texture_res_t;

typedef enum{
	layout_size_t_SIDEBAR_W=0,
	layout_size_t_SIDEBAR_H0=1,
	layout_size_t_SIDEBAR_H1=2,
	layout_size_t_NODES_W=3,
	layout_size_t_NODES_H=4,
	layout_size_t_STATUS_H=5,
	layout_size_t_HEADER=6,
}layout_size_t;

typedef enum{
	shortcut_type_t_STARTED,
	shortcut_type_t_REPEAT,
	shortcut_type_t_DOWN,
	shortcut_type_t_RELEASED,
}shortcut_type_t;

typedef enum{
	color_space_t_AUTO,
	color_space_t_LINEAR,
	color_space_t_SRGB,
	color_space_t_DIRECTX_NORMAL_MAP,
}color_space_t;

typedef enum{
	physics_shape_t_BOX=0,
	physics_shape_t_SPHERE=1,
	physics_shape_t_HULL=2,
	physics_shape_t_TERRAIN=3,
	physics_shape_t_MESH=4,
}physics_shape_t;

typedef enum{
	key_code_t_UNKNOWN=0,
	key_code_t_BACK=1,
	key_code_t_CANCEL=3,
	key_code_t_HELP=6,
	key_code_t_BACKSPACE=8,
	key_code_t_TAB=9,
	key_code_t_RETURN=13,
	key_code_t_SHIFT=16,
	key_code_t_CONTROL=17,
	key_code_t_ALT=18,
	key_code_t_PAUSE=19,
	key_code_t_CAPS_LOCK=20,
	key_code_t_ESCAPE=27,
	key_code_t_SPACE=32,
	key_code_t_PAGE_UP=33,
	key_code_t_PAGE_DOWN=34,
	key_code_t_END=35,
	key_code_t_HOME=36,
	key_code_t_LEFT=37,
	key_code_t_UP=38,
	key_code_t_RIGHT=39,
	key_code_t_DOWN=40,
	key_code_t_PRINT_SCREEN=44,
	key_code_t_INSERT=45,
	key_code_t_DELETE=46,
	key_code_t_ZERO=48,
	key_code_t_ONE=49,
	key_code_t_TWO=50,
	key_code_t_THREE=51,
	key_code_t_FOUR=52,
	key_code_t_FIVE=53,
	key_code_t_SIX=54,
	key_code_t_SEVEN=55,
	key_code_t_EIGHT=56,
	key_code_t_NINE=57,
	key_code_t_COLON=58,
	key_code_t_SEMICOLON=59,
	key_code_t_LESS_THAN=60,
	key_code_t_EQUALS=61,
	key_code_t_GREATER_THAN=62,
	key_code_t_QUESTION_MARK=63,
	key_code_t_AT=64,
	key_code_t_A=65,
	key_code_t_B=66,
	key_code_t_C=67,
	key_code_t_D=68,
	key_code_t_E=69,
	key_code_t_F=70,
	key_code_t_G=71,
	key_code_t_H=72,
	key_code_t_I=73,
	key_code_t_J=74,
	key_code_t_K=75,
	key_code_t_L=76,
	key_code_t_M=77,
	key_code_t_N=78,
	key_code_t_O=79,
	key_code_t_P=80,
	key_code_t_Q=81,
	key_code_t_R=82,
	key_code_t_S=83,
	key_code_t_T=84,
	key_code_t_U=85,
	key_code_t_V=86,
	key_code_t_W=87,
	key_code_t_X=88,
	key_code_t_Y=89,
	key_code_t_Z=90,
	key_code_t_WIN=91,
	key_code_t_CONTEXT_MENU=93,
	key_code_t_SLEEP=95,
	key_code_t_NUMPAD0=96,
	key_code_t_NUMPAD1=97,
	key_code_t_NUMPAD2=98,
	key_code_t_NUMPAD3=99,
	key_code_t_NUMPAD4=100,
	key_code_t_NUMPAD5=101,
	key_code_t_NUMPAD6=102,
	key_code_t_NUMPAD7=103,
	key_code_t_NUMPAD8=104,
	key_code_t_NUMPAD9=105,
	key_code_t_MULTIPLY=106,
	key_code_t_ADD=107,
	key_code_t_SEPARATOR=108,
	key_code_t_SUBTRACT=109,
	key_code_t_DECIMAL=110,
	key_code_t_DIVIDE=111,
	key_code_t_F1=112,
	key_code_t_F2=113,
	key_code_t_F3=114,
	key_code_t_F4=115,
	key_code_t_F5=116,
	key_code_t_F6=117,
	key_code_t_F7=118,
	key_code_t_F8=119,
	key_code_t_F9=120,
	key_code_t_F10=121,
	key_code_t_F11=122,
	key_code_t_F12=123,
	key_code_t_F13=124,
	key_code_t_F14=125,
	key_code_t_F15=126,
	key_code_t_F16=127,
	key_code_t_F17=128,
	key_code_t_F18=129,
	key_code_t_F19=130,
	key_code_t_F20=131,
	key_code_t_F21=132,
	key_code_t_F22=133,
	key_code_t_F23=134,
	key_code_t_F24=135,
	key_code_t_NUM_LOCK=144,
	key_code_t_SCROLL_LOCK=145,
	key_code_t_EXCLAMATION=161,
	key_code_t_DOUBLE_QUOTE=162,
	key_code_t_HASH=163,
	key_code_t_DOLLAR=164,
	key_code_t_PERCENT=165,
	key_code_t_AMPERSAND=166,
	key_code_t_UNDERSCORE=167,
	key_code_t_OPEN_PAREN=168,
	key_code_t_CLOSE_PAREN=169,
	key_code_t_ASTERISK=170,
	key_code_t_PLUS=171,
	key_code_t_PIPE=172,
	key_code_t_HYPHEN_MINUS=173,
	key_code_t_OPEN_CURLY_BRACKET=174,
	key_code_t_CLOSE_CURLY_BRACKET=175,
	key_code_t_TILDE=176,
	key_code_t_VOLUME_MUTE=181,
	key_code_t_VOLUME_DOWN=182,
	key_code_t_VOLUME_UP=183,
	key_code_t_COMMA=188,
	key_code_t_PERIOD=190,
	key_code_t_SLASH=191,
	key_code_t_BACK_QUOTE=192,
	key_code_t_OPEN_BRACKET=219,
	key_code_t_BACK_SLASH=220,
	key_code_t_CLOSE_BRACKET=221,
	key_code_t_QUOTE=222,
	key_code_t_META=224,
	key_code_t_ALTGR=225,
}key_code_t;

typedef enum{
	clear_flag_t_NONE=0,
	clear_flag_t_COLOR=1,
	clear_flag_t_DEPTH=2,
}clear_flag_t;

typedef enum{
	tex_format_t_RGBA32,
	tex_format_t_RGBA64,
	tex_format_t_RGBA128,
	tex_format_t_R8,
	tex_format_t_R16,
	tex_format_t_R32,
	tex_format_t_D32,
}tex_format_t;

typedef enum{
	vertex_data_t_F32_1X,
	vertex_data_t_F32_2X,
	vertex_data_t_F32_3X,
	vertex_data_t_F32_4X,
	vertex_data_t_I16_2X_NORM,
	vertex_data_t_I16_4X_NORM,
}vertex_data_t;

typedef enum{
	blend_factor_t_BLEND_ONE,
	blend_factor_t_BLEND_ZERO,
	blend_factor_t_SOURCE_ALPHA,
	blend_factor_t_DEST_ALPHA,
	blend_factor_t_INV_SOURCE_ALPHA,
	blend_factor_t_INV_DEST_ALPHA,
}blend_factor_t;

typedef enum{
	compare_mode_t_ALWAYS,
	compare_mode_t_NEVER,
	compare_mode_t_LESS,
	compare_mode_t_EQUAL,
}compare_mode_t;

typedef enum{
	cull_mode_t_CLOCKWISE,
	cull_mode_t_COUNTER_CLOCKWISE,
	cull_mode_t_NONE,
}cull_mode_t;

typedef enum{
	shader_type_t_VERTEX,
	shader_type_t_FRAGMENT,
}shader_type_t;

typedef enum{
	ui_layout_t_VERTICAL,
	ui_layout_t_HORIZONTAL,
}ui_layout_t;

typedef enum{
	ui_align_t_LEFT,
	ui_align_t_CENTER,
	ui_align_t_RIGHT,
}ui_align_t;

typedef enum{
	ui_state_t_IDLE,
	ui_state_t_STARTED,
	ui_state_t_DOWN,
	ui_state_t_RELEASED,
	ui_state_t_HOVERED,
}ui_state_t;

typedef enum{
	draw_order_t_DIST,
	draw_order_t_SHADER,
}draw_order_t;

typedef enum{
	window_features_t_NONE=0,
	window_features_t_RESIZABLE=1,
	window_features_t_MINIMIZABLE=2,
	window_features_t_MAXIMIZABLE=4,
}window_features_t;

typedef enum{
	window_mode_t_WINDOWED,
	window_mode_t_FULLSCREEN,
}window_mode_t;

typedef enum{
	ease_t_LINEAR,
	ease_t_QUAD_IN,
	ease_t_QUAD_OUT,
	ease_t_QUAD_IN_OUT,
	ease_t_EXPO_IN,
	ease_t_EXPO_OUT,
	ease_t_EXPO_IN_OUT,
	ease_t_BOUNCE_IN,
	ease_t_BOUNCE_OUT,
	ease_t_BOUNCE_IN_OUT,
	ease_t_ELASTIC_IN,
	ease_t_ELASTIC_OUT,
	ease_t_ELASTIC_IN_OUT,
}ease_t;

typedef struct version{
	string_t * sha;
	string_t * date;
}version_t;

typedef struct config{
	string_t * locale;
	i32 window_mode;
	i32 window_w;
	i32 window_h;
	i32 window_x;
	i32 window_y;
	bool window_resizable;
	bool window_maximizable;
	bool window_minimizable;
	bool window_vsync;
	i32 window_frequency;
	f32 window_scale;
	f32 rp_supersample;
	bool rp_ssao;
	bool rp_bloom;
	bool rp_gi;
	f32 rp_vignette;
	f32 rp_grain;
	string_t * version;
	string_t * sha;
	struct string_t_array * recent_projects;
	struct string_t_array * bookmarks;
	struct string_t_array * plugins;
	string_t * keymap;
	string_t * theme;
	i32 undo_steps;
	f32 camera_pan_speed;
	f32 camera_zoom_speed;
	f32 camera_rotation_speed;
	i32 zoom_direction;
	bool wrap_mouse;
	bool show_asset_names;
	bool touch_ui;
	bool splash_screen;
	struct i32_array * layout;
	struct i32_array * layout_tabs;
	i32 workspace;
	i32 camera_controls;
	string_t * server;
	i32 viewport_mode;
	i32 pathtrace_mode;
	bool pressure_radius;
	f32 pressure_sensitivity;
	f32 displace_strength;
	i32 layer_res;
	bool brush_live;
	bool brush_3d;
	bool node_preview;
	bool pressure_hardness;
	bool pressure_angle;
	bool pressure_opacity;
	bool material_live;
	bool brush_depth_reject;
	bool brush_angle_reject;
	i32 dilate;
	i32 dilate_radius;
	bool gpu_inference;
	string_t * blender;
	i32 atlas_res;
	bool grid_snap;
}config_t;

typedef struct context{
	struct asset * texture;
	struct mesh_object * paint_object;
	struct mesh_object * merged_object;
	bool merged_object_is_atlas;
	i32 ddirty;
	i32 pdirty;
	i32 rdirty;
	bool brush_blend_dirty;
	i32 node_preview_socket;
	bool split_view;
	i32 view_index;
	i32 view_index_last;
	struct swatch_color * swatch;
	struct swatch_color * picked_color;
	void(*color_picker_callback)(struct swatch_color *);
	struct f32_array * default_irradiance;
	struct gpu_texture * default_radiance;
	struct gpu_texture_t_array * default_radiance_mipmaps;
	struct gpu_texture * saved_envmap;
	struct gpu_texture * empty_envmap;
	struct gpu_texture * preview_envmap;
	bool envmap_loaded;
	bool show_envmap;
	struct ui_handle * show_envmap_handle;
	bool show_envmap_blur;
	struct ui_handle * show_envmap_blur_handle;
	f32 envmap_angle;
	f32 light_angle;
	bool cull_backfaces;
	bool texture_filter;
	texture_ldr_format_t format_type;
	f32 format_quality;
	export_destination_t layers_destination;
	split_type_t split_by;
	bool parse_transform;
	bool parse_vcols;
	f32 select_time;
	viewport_mode_t viewport_mode;
	render_mode_t render_mode;
	any viewport_shader;
	bool hscale_was_changed;
	mesh_format_t export_mesh_format;
	i32 export_mesh_index;
	bool pack_assets_on_export;
	vec4_t paint_vec;
	f32 last_paint_x;
	f32 last_paint_y;
	bool foreground_event;
	i32 painted;
	f32 brush_time;
	f32 clone_start_x;
	f32 clone_start_y;
	f32 clone_delta_x;
	f32 clone_delta_y;
	bool show_compass;
	project_model_t project_type;
	i32 project_aspect_ratio;
	struct mesh_object_t_array * project_objects;
	f32 last_paint_vec_x;
	f32 last_paint_vec_y;
	f32 prev_paint_vec_x;
	f32 prev_paint_vec_y;
	i32 frame;
	bool paint2d_view;
	f32 lock_started_x;
	f32 lock_started_y;
	bool brush_locked;
	bool brush_can_lock;
	bool brush_can_unlock;
	camera_type_t camera_type;
	struct ui_handle * cam_handle;
	struct ui_handle * fov_handle;
	struct ui_handle * undo_handle;
	struct ui_handle * hssao;
	struct ui_handle * hbloom;
	struct ui_handle * hsupersample;
	struct ui_handle * hvxao;
	f32 vxao_ext;
	f32 vxao_offset;
	f32 vxao_aperture;
	string_t * texture_export_path;
	i32 last_status_position;
	camera_controls_t camera_controls;
	bool pen_painting_only;
	struct slot_material * material;
	struct slot_layer * layer;
	struct slot_brush * brush;
	struct slot_font * font;
	workspace_tool_t tool;
	bool layer_preview_dirty;
	bool layers_preview_dirty;
	bool node_preview_dirty;
	struct gpu_texture * node_preview;
	struct any_map * node_previews;
	struct string_t_array * node_previews_used;
	string_t * node_preview_name;
	struct gpu_texture * mask_preview_rgba32;
	struct slot_layer * mask_preview_last;
	bool colorid_picked;
	bool material_preview;
	mat4_t saved_camera;
	workspace_tool_t color_picker_previous_tool;
	i32 materialid_picked;
	f32 uvx_picked;
	f32 uvy_picked;
	bool picker_select_material;
	struct ui_handle * picker_mask_handle;
	bool pick_pos_nor_tex;
	f32 posx_picked;
	f32 posy_picked;
	f32 posz_picked;
	f32 norx_picked;
	f32 nory_picked;
	f32 norz_picked;
	bool draw_wireframe;
	struct ui_handle * wireframe_handle;
	bool draw_texels;
	struct ui_handle * texels_handle;
	struct ui_handle * colorid_handle;
	export_mode_t layers_export;
	struct gpu_texture * decal_image;
	bool decal_preview;
	f32 decal_x;
	f32 decal_y;
	bool write_icon_on_export;
	struct gpu_texture * text_tool_image;
	string_t * text_tool_text;
	struct material_data * particle_material;
	i32 layer_filter;
	struct brush_output_node * brush_output_node_inst;
	void(*run_brush)(any,i32);
	void(*parse_brush_inputs)(any);
	struct object * gizmo;
	struct object * gizmo_translate_x;
	struct object * gizmo_translate_y;
	struct object * gizmo_translate_z;
	struct object * gizmo_scale_x;
	struct object * gizmo_scale_y;
	struct object * gizmo_scale_z;
	struct object * gizmo_rotate_x;
	struct object * gizmo_rotate_y;
	struct object * gizmo_rotate_z;
	bool gizmo_started;
	f32 gizmo_offset;
	f32 gizmo_drag;
	f32 gizmo_drag_last;
	bool translate_x;
	bool translate_y;
	bool translate_z;
	bool scale_x;
	bool scale_y;
	bool scale_z;
	bool rotate_x;
	bool rotate_y;
	bool rotate_z;
	f32 brush_nodes_radius;
	f32 brush_nodes_opacity;
	struct gpu_texture * brush_mask_image;
	bool brush_mask_image_is_alpha;
	struct gpu_texture * brush_stencil_image;
	bool brush_stencil_image_is_alpha;
	f32 brush_stencil_x;
	f32 brush_stencil_y;
	f32 brush_stencil_scale;
	bool brush_stencil_scaling;
	f32 brush_stencil_angle;
	bool brush_stencil_rotating;
	f32 brush_nodes_scale;
	f32 brush_nodes_angle;
	f32 brush_nodes_hardness;
	bool brush_directional;
	f32 brush_radius;
	struct ui_handle * brush_radius_handle;
	f32 brush_scale_x;
	f32 brush_decal_mask_radius;
	struct ui_handle * brush_decal_mask_radius_handle;
	struct ui_handle * brush_scale_x_handle;
	blend_type_t brush_blending;
	f32 brush_opacity;
	struct ui_handle * brush_opacity_handle;
	f32 brush_scale;
	f32 brush_angle;
	struct ui_handle * brush_angle_handle;
	f32 brush_hardness;
	f32 brush_lazy_radius;
	f32 brush_lazy_step;
	f32 brush_lazy_x;
	f32 brush_lazy_y;
	uv_type_t brush_paint;
	f32 brush_angle_reject_dot;
	bake_type_t bake_type;
	bake_axis_t bake_axis;
	bake_up_axis_t bake_up_axis;
	i32 bake_samples;
	f32 bake_ao_strength;
	f32 bake_ao_radius;
	f32 bake_ao_offset;
	f32 bake_curv_strength;
	f32 bake_curv_radius;
	f32 bake_curv_offset;
	i32 bake_curv_smooth;
	i32 bake_high_poly;
	bool xray;
	bool sym_x;
	bool sym_y;
	bool sym_z;
	struct ui_handle * fill_type_handle;
	bool paint2d;
	i32 last_htab0_pos;
	i32 maximized_sidebar_width;
	i32 drag_dest;
	vec4_t coords;
	f32 start_x;
	f32 start_y;
	bool lock_begin;
	bool lock_x;
	bool lock_y;
	f32 lock_start_x;
	f32 lock_start_y;
	bool registered;
	struct object * selected_object;
	f32 particle_hit_x;
	f32 particle_hit_y;
	f32 particle_hit_z;
	f32 last_particle_hit_x;
	f32 last_particle_hit_y;
	f32 last_particle_hit_z;
	struct tween_anim * particle_timer;
	struct physics_body * paint_body;
}context_t;

typedef struct export_preset{
	struct export_preset_texture_t_array * textures;
}export_preset_t;

typedef struct export_preset_texture{
	string_t * name;
	struct string_t_array * channels;
	string_t * color_space;
}export_preset_texture_t;

typedef struct file_download_data{
	string_t * dst_path;
	void(*done)(string_t *);
}file_download_data_t;

typedef struct file_download_bytes_data{
	string_t * url;
	string_t * save;
	void(*done)(string_t *,struct buffer *);
}file_download_bytes_data_t;

typedef struct file_cache_cloud_data{
	string_t * dest;
	string_t * path;
	void(*done)(string_t *);
}file_cache_cloud_data_t;

typedef struct step{
	string_t * name;
	struct ui_node_canvas * canvas;
	i32 canvas_group;
	i32 layer;
	layer_slot_type_t layer_type;
	i32 layer_parent;
	i32 object;
	i32 material;
	i32 brush;
	f32 layer_opacity;
	i32 layer_object;
	i32 layer_blending;
	i32 prev_order;
	i32 canvas_type;
}step_t;

typedef struct import_texture_data{
	string_t * path;
	struct gpu_texture * image;
}import_texture_data_t;

typedef struct logic_node{
	struct logic_node_input_t_array * inputs;
	struct logic_node_t_array * outputs;
	struct logic_node_value *(*get)(any,i32);
	struct gpu_texture *(*get_as_image)(any,i32);
	struct gpu_texture *(*get_cached_image)(any);
	void(*set)(any,struct f32_array *);
	struct logic_node_ext * ext;
}logic_node_t;

typedef struct logic_node_ext{
	struct logic_node * base;
}logic_node_ext_t;

typedef struct logic_node_value{
	f32 _f32;
	vec4_t _vec4;
	string_t * _str;
}logic_node_value_t;

typedef struct logic_node_input{
	struct logic_node_ext * node;
	i32 from;
}logic_node_input_t;

typedef struct ui_node_t_array * node_list_t;

typedef struct node_shader{
	struct node_shader_context * context;
	struct string_t_array * ins;
	struct string_t_array * outs;
	string_t * frag_out;
	struct string_t_array * consts;
	struct string_t_array * textures;
	struct any_map * functions;
	string_t * vert;
	string_t * vert_end;
	string_t * vert_normal;
	string_t * vert_attribs;
	i32 vert_write_normal;
	string_t * frag;
	string_t * frag_end;
	string_t * frag_normal;
	string_t * frag_attribs;
	i32 frag_write_normal;
	bool vert_n;
	bool frag_bposition;
	bool frag_wposition;
	bool frag_mposition;
	bool frag_vposition;
	bool frag_wvpposition;
	bool frag_ndcpos;
	bool frag_wtangent;
	bool frag_vvec;
	bool frag_vvec_cam;
	bool frag_n;
	bool frag_nattr;
	bool frag_dotnv;
}node_shader_t;

typedef struct material{
	string_t * name;
	struct ui_node_canvas * canvas;
}material_t;

typedef struct node_shader_context{
	struct node_shader * kong;
	struct shader_context * data;
	bool allow_vcols;
	struct material * material;
}node_shader_context_t;

typedef struct shader_out{
	string_t * out_basecol;
	string_t * out_roughness;
	string_t * out_metallic;
	string_t * out_occlusion;
	string_t * out_opacity;
	string_t * out_height;
	string_t * out_emission;
	string_t * out_subsurface;
}shader_out_t;

typedef struct physics_body{
	any _body;
	physics_shape_t shape;
	f32 mass;
	f32 dimx;
	f32 dimy;
	f32 dimz;
	struct object * obj;
}physics_body_t;

typedef struct physics_world{
	i32 empty;
}physics_world_t;

typedef struct plugin{
	any on_ui;
	any on_draw;
	any on_update;
	any on_delete;
	string_t * version;
	string_t * name;
}plugin_t;

typedef struct node_group{
	struct ui_nodes * nodes;
	struct ui_node_canvas * canvas;
}node_group_t;

typedef struct project_format{
	string_t * version;
	struct string_t_array * assets;
	bool is_bgra;
	struct packed_asset_t_array * packed_assets;
	string_t * envmap;
	f32 envmap_strength;
	struct f32_array * camera_world;
	struct f32_array * camera_origin;
	f32 camera_fov;
	struct swatch_color_t_array * swatches;
	struct ui_node_canvas_t_array * brush_nodes;
	struct buffer_t_array * brush_icons;
	struct ui_node_canvas_t_array * material_nodes;
	struct ui_node_canvas_t_array * material_groups;
	struct buffer_t_array * material_icons;
	struct string_t_array * font_assets;
	struct layer_data_t_array * layer_datas;
	struct mesh_data_t_array * mesh_datas;
	struct string_t_array * mesh_assets;
	struct buffer_t_array * mesh_icons;
	struct i32_array * atlas_objects;
	struct string_t_array * atlas_names;
}project_format_t;

typedef struct asset{
	i32 id;
	string_t * name;
	string_t * file;
}asset_t;

typedef struct packed_asset{
	string_t * name;
	struct buffer * bytes;
}packed_asset_t;

typedef struct swatch_color{
	i32 base;
	f32 opacity;
	f32 occlusion;
	f32 roughness;
	f32 metallic;
	i32 normal;
	f32 emission;
	f32 height;
	f32 subsurface;
}swatch_color_t;

typedef struct layer_data{
	string_t * name;
	i32 res;
	i32 bpp;
	struct buffer * texpaint;
	f32 uv_scale;
	f32 uv_rot;
	i32 uv_type;
	struct f32_array * decal_mat;
	f32 opacity_mask;
	i32 fill_layer;
	i32 object_mask;
	i32 blending;
	i32 parent;
	bool visible;
	struct buffer * texpaint_nor;
	struct buffer * texpaint_pack;
	bool paint_base;
	bool paint_opac;
	bool paint_occ;
	bool paint_rough;
	bool paint_met;
	bool paint_nor;
	bool paint_nor_blend;
	bool paint_height;
	bool paint_height_blend;
	bool paint_emis;
	bool paint_subs;
}layer_data_t;

typedef struct rect{
	i32 x;
	i32 y;
	i32 w;
	i32 h;
}rect_t;

typedef struct slot_brush{
	struct ui_nodes * nodes;
	struct ui_node_canvas * canvas;
	struct gpu_texture * image;
	struct gpu_texture * image_icon;
	bool preview_ready;
	i32 id;
}slot_brush_t;

typedef struct slot_font{
	struct gpu_texture * image;
	bool preview_ready;
	i32 id;
	struct draw_font * font;
	string_t * name;
	string_t * file;
}slot_font_t;

typedef struct slot_layer{
	i32 id;
	string_t * name;
	string_t * ext;
	bool visible;
	struct slot_layer * parent;
	struct gpu_texture * texpaint;
	struct gpu_texture * texpaint_nor;
	struct gpu_texture * texpaint_pack;
	struct gpu_texture * texpaint_preview;
	f32 mask_opacity;
	struct slot_material * fill_layer;
	bool show_panel;
	blend_type_t blending;
	i32 object_mask;
	f32 scale;
	f32 angle;
	uv_type_t uv_type;
	bool paint_base;
	bool paint_opac;
	bool paint_occ;
	bool paint_rough;
	bool paint_met;
	bool paint_nor;
	bool paint_nor_blend;
	bool paint_height;
	bool paint_height_blend;
	bool paint_emis;
	bool paint_subs;
	mat4_t decal_mat;
}slot_layer_t;

typedef struct slot_material{
	struct ui_nodes * nodes;
	struct ui_node_canvas * canvas;
	struct gpu_texture * image;
	struct gpu_texture * image_icon;
	bool preview_ready;
	struct material_data * data;
	i32 id;
	bool paint_base;
	bool paint_opac;
	bool paint_occ;
	bool paint_rough;
	bool paint_met;
	bool paint_nor;
	bool paint_height;
	bool paint_emis;
	bool paint_subs;
}slot_material_t;

typedef struct tab_draw{
	void(*f)(struct ui_handle *);
}tab_draw_t;

typedef struct tab_draw_t_array * tab_draw_array_t;

typedef struct draw_cloud_icon_data{
	string_t * f;
	struct gpu_texture * image;
}draw_cloud_icon_data_t;

typedef struct ui_files_make_icon{
	struct gpu_texture * image;
	string_t * shandle;
	i32 w;
}ui_files_make_icon_t;

typedef struct update_info{
	i32 version;
	string_t * version_name;
}update_info_t;

typedef struct camera_object{
	struct object * base;
	struct camera_data * data;
	mat4_t p;
	mat4_t no_jitter_p;
	i32 frame;
	mat4_t v;
	mat4_t vp;
	struct frustum_plane_t_array * frustum_planes;
}camera_object_t;

typedef struct frustum_plane{
	vec4_t normal;
	f32 constant;
}frustum_plane_t;

typedef struct gamepad_stick{
	f32 x;
	f32 y;
	f32 last_x;
	f32 last_y;
	bool moved;
	f32 movement_x;
	f32 movement_y;
}gamepad_stick_t;

typedef struct gamepad{
	struct f32_array * buttons_down;
	struct u8_array * buttons_started;
	struct u8_array * buttons_released;
	struct i32_array * buttons_frame;
	struct gamepad_stick * left_stick;
	struct gamepad_stick * right_stick;
}gamepad_t;

typedef struct mat4_box{
	mat4_t v;
}mat4_box_t;

typedef struct vec4_box{
	vec4_t v;
}vec4_box_t;

typedef struct mesh_object{
	struct object * base;
	struct mesh_data * data;
	struct material_data_t_array * materials;
	i32 material_index;
	f32 camera_dist;
	f32 screen_size;
	bool frustum_culling;
	string_t * skip_context;
	string_t * force_context;
}mesh_object_t;

typedef struct object{
	i32 uid;
	f32 urandom;
	struct obj * raw;
	string_t * name;
	struct transform * transform;
	struct object * parent;
	struct object_t_array * children;
	bool visible;
	bool culled;
	bool is_empty;
	any ext;
	string_t * ext_type;
}object_t;

typedef struct ray{
	vec4_t origin;
	vec4_t dir;
}ray_t;

typedef struct plane{
	vec4_t normal;
	f32 constant;
}plane_t;

typedef struct render_target{
	string_t * name;
	i32 width;
	i32 height;
	string_t * format;
	f32 scale;
	struct gpu_texture * _image;
}render_target_t;

typedef struct cached_shader_context{
	struct shader_context * context;
}cached_shader_context_t;

typedef struct scene{
	string_t * name;
	struct obj_t_array * objects;
	struct mesh_data_t_array * mesh_datas;
	struct camera_data_t_array * camera_datas;
	string_t * camera_ref;
	struct material_data_t_array * material_datas;
	struct shader_data_t_array * shader_datas;
	struct world_data_t_array * world_datas;
	string_t * world_ref;
	struct speaker_data_t_array * speaker_datas;
	struct string_t_array * embedded_datas;
}scene_t;

typedef struct mesh_data{
	string_t * name;
	f32 scale_pos;
	f32 scale_tex;
	struct skin * skin;
	struct vertex_array_t_array * vertex_arrays;
	struct index_array_t_array * index_arrays;
	struct mesh_data_runtime * _;
}mesh_data_t;

typedef struct mesh_data_runtime{
	i32 refcount;
	string_t * handle;
	struct gpu_buffer * vertex_buffer;
	struct any_map * vertex_buffer_map;
	struct gpu_buffer_t_array * index_buffers;
	bool ready;
	struct buffer * vertices;
	struct u32_array_t_array * indices;
	struct i32_array * material_indices;
	struct gpu_vertex_structure * structure;
}mesh_data_runtime_t;

typedef struct skin{
	struct f32_array * transform;
	struct string_t_array * bone_ref_array;
	struct f32_array * bone_len_array;
	struct f32_array_t_array * transforms_inv;
	struct i16_array * bone_count_array;
	struct i16_array * bone_index_array;
	struct i16_array * bone_weight_array;
}skin_t;

typedef struct vertex_array{
	string_t * attrib;
	string_t * data;
	struct i16_array * values;
}vertex_array_t;

typedef struct index_array{
	i32 material;
	struct u32_array * values;
}index_array_t;

typedef struct camera_data{
	string_t * name;
	f32 near_plane;
	f32 far_plane;
	f32 fov;
	f32 aspect;
	bool frustum_culling;
	struct f32_array * ortho;
}camera_data_t;

typedef struct material_data{
	string_t * name;
	string_t * shader;
	struct material_context_t_array * contexts;
	struct material_data_runtime * _;
}material_data_t;

typedef struct material_data_runtime{
	f32 uid;
	struct shader_data * shader;
	struct material_context_t_array * contexts;
}material_data_runtime_t;

typedef struct material_context{
	string_t * name;
	struct bind_const_t_array * bind_constants;
	struct bind_tex_t_array * bind_textures;
	struct material_context_runtime * _;
}material_context_t;

typedef struct material_context_runtime{
	struct gpu_texture_t_array * textures;
}material_context_runtime_t;

typedef struct bind_const{
	string_t * name;
	struct f32_array * vec;
}bind_const_t;

typedef struct bind_tex{
	string_t * name;
	string_t * file;
}bind_tex_t;

typedef struct shader_data{
	string_t * name;
	struct shader_context_t_array * contexts;
	struct shader_data_runtime * _;
}shader_data_t;

typedef struct shader_data_runtime{
	struct shader_context_t_array * contexts;
}shader_data_runtime_t;

typedef struct shader_context{
	string_t * name;
	bool depth_write;
	string_t * compare_mode;
	string_t * cull_mode;
	string_t * vertex_shader;
	string_t * fragment_shader;
	bool shader_from_source;
	string_t * blend_source;
	string_t * blend_destination;
	string_t * alpha_blend_source;
	string_t * alpha_blend_destination;
	struct u8_array * color_writes_red;
	struct u8_array * color_writes_green;
	struct u8_array * color_writes_blue;
	struct u8_array * color_writes_alpha;
	struct string_t_array * color_attachments;
	string_t * depth_attachment;
	struct vertex_element_t_array * vertex_elements;
	struct shader_const_t_array * constants;
	struct tex_unit_t_array * texture_units;
	struct shader_context_runtime * _;
}shader_context_t;

typedef struct shader_context_runtime{
	struct gpu_pipeline * pipe_state;
	struct i32_array * constants;
	struct i32_array * tex_units;
	struct gpu_vertex_structure * structure;
	i32 vertex_shader_size;
	i32 fragment_shader_size;
}shader_context_runtime_t;

typedef struct vertex_element{
	string_t * name;
	string_t * data;
}vertex_element_t;

typedef struct shader_const{
	string_t * name;
	string_t * type;
	string_t * link;
}shader_const_t;

typedef struct tex_unit{
	string_t * name;
	string_t * link;
}tex_unit_t;

typedef struct speaker_data{
	string_t * name;
	string_t * sound;
	bool muted;
	bool loop;
	bool stream;
	f32 volume;
	f32 attenuation;
	bool play_on_start;
}speaker_data_t;

typedef struct world_data{
	string_t * name;
	i32 color;
	f32 strength;
	string_t * irradiance;
	string_t * radiance;
	i32 radiance_mipmaps;
	string_t * envmap;
	struct world_data_runtime * _;
}world_data_t;

typedef struct world_data_runtime{
	struct gpu_texture * envmap;
	struct gpu_texture * radiance;
	struct gpu_texture_t_array * radiance_mipmaps;
	struct f32_array * irradiance;
}world_data_runtime_t;

typedef struct irradiance{
	struct f32_array * irradiance;
}irradiance_t;

typedef struct obj{
	string_t * name;
	string_t * type;
	string_t * data_ref;
	struct f32_array * transform;
	struct f32_array * dimensions;
	bool visible;
	bool spawn;
	struct anim * anim;
	struct string_t_array * material_refs;
	struct obj_t_array * children;
	struct obj_runtime * _;
}obj_t;

typedef struct obj_runtime{
	struct scene * _gc;
}obj_runtime_t;

typedef struct anim{
	struct string_t_array * object_actions;
	struct string_t_array * bone_actions;
	string_t * parent_bone;
	struct f32_array * parent_bone_tail;
	struct f32_array * parent_bone_tail_pose;
	bool parent_bone_connected;
	struct track_t_array * tracks;
	i32 begin;
	i32 end;
	bool has_delta;
	struct u32_array * marker_frames;
	struct string_t_array * marker_names;
}anim_t;

typedef struct track{
	string_t * target;
	struct u32_array * frames;
	struct f32_array * values;
}track_t;

typedef struct sys_callback{
	void(*f)(void);
}sys_callback_t;

typedef struct sys_string_callback{
	void(*f)(string_t *);
}sys_string_callback_t;

typedef struct callback{
	void(*f)(any);
	any data;
}callback_t;

typedef i32 color_t;

typedef struct video{
	any video_;
}video_t;

typedef struct sound{
	any sound_;
}sound_t;

typedef struct tilesheet_data{
	string_t * name;
	i32 tiles_x;
	i32 tiles_y;
	i32 framerate;
	struct tilesheet_action_t_array * actions;
}tilesheet_data_t;

typedef struct tilesheet_action{
	string_t * name;
	i32 start;
	i32 end;
	bool loop;
}tilesheet_action_t;

typedef struct tilesheet{
	f32 tile_x;
	f32 tile_y;
	struct tilesheet_data * raw;
	struct tilesheet_action * action;
	bool ready;
	bool paused;
	i32 frame;
	f32 time;
	void(*on_action_complete)(void);
}tilesheet_t;

typedef struct transform{
	mat4_t world;
	bool local_only;
	mat4_t local;
	vec4_t loc;
	quat_t rot;
	vec4_t scale;
	f32 scale_world;
	mat4_t world_unpack;
	bool dirty;
	struct object * object;
	vec4_t dim;
	f32 radius;
}transform_t;

typedef struct tween_anim{
	any target;
	f32 to;
	f32 duration;
	f32 delay;
	ease_t ease;
	void(*done)(any);
	void(*tick)(void);
	any done_data;
	f32 _from;
	f32 _time;
}tween_anim_t;

typedef struct boolean_node{
	struct logic_node * base;
	bool value;
}boolean_node_t;

typedef struct color_node{
	struct logic_node * base;
	vec4_t value;
	struct gpu_texture * image;
}color_node_t;

typedef struct float_node{
	struct logic_node * base;
	f32 value;
	struct gpu_texture * image;
}float_node_t;

typedef struct integer_node{
	struct logic_node * base;
	i32 value;
}integer_node_t;

typedef struct math_node{
	struct logic_node * base;
	string_t * operation;
	bool use_clamp;
}math_node_t;

typedef struct null_node{
	struct logic_node * base;
}null_node_t;

typedef struct random_node{
	struct logic_node * base;
}random_node_t;

typedef struct separate_vector_node{
	struct logic_node * base;
}separate_vector_node_t;

typedef struct string_node{
	struct logic_node * base;
	string_t * value;
}string_node_t;

typedef struct time_node{
	struct logic_node * base;
}time_node_t;

typedef struct vector_math_node{
	struct logic_node * base;
	string_t * operation;
	vec4_t v;
}vector_math_node_t;

typedef struct vector_node{
	struct logic_node * base;
	vec4_t value;
	struct gpu_texture * image;
}vector_node_t;

typedef struct parse_node_preview_result{
	struct shader_context * scon;
	struct material_context * mcon;
}parse_node_preview_result_t;

typedef struct brush_output_node{
	struct logic_node * base;
	struct ui_node * raw;
}brush_output_node_t;

typedef struct input_node{
	struct logic_node * base;
}input_node_t;

typedef struct tex_image_node{
	struct logic_node * base;
	struct ui_node * raw;
}tex_image_node_t;

typedef struct node_group_t_array{node_group_t**buffer;int length;int capacity;}node_group_t_array_t;
typedef struct material_data_t_array{material_data_t**buffer;int length;int capacity;}material_data_t_array_t;
typedef struct world_data_t_array{world_data_t**buffer;int length;int capacity;}world_data_t_array_t;
typedef struct ui_t_array{ui_t**buffer;int length;int capacity;}ui_t_array_t;
typedef struct buffer_t_array{buffer_t**buffer;int length;int capacity;}buffer_t_array_t;
typedef struct slot_material_t_array{slot_material_t**buffer;int length;int capacity;}slot_material_t_array_t;
typedef struct vertex_array_t_array{vertex_array_t**buffer;int length;int capacity;}vertex_array_t_array_t;
typedef struct bind_tex_t_array{bind_tex_t**buffer;int length;int capacity;}bind_tex_t_array_t;
typedef struct mesh_object_t_array{mesh_object_t**buffer;int length;int capacity;}mesh_object_t_array_t;
typedef struct bind_const_t_array{bind_const_t**buffer;int length;int capacity;}bind_const_t_array_t;
typedef struct node_list_t_array{node_list_t**buffer;int length;int capacity;}node_list_t_array_t;
typedef struct ui_node_canvas_t_array{ui_node_canvas_t**buffer;int length;int capacity;}ui_node_canvas_t_array_t;
typedef struct ui_handle_t_array{ui_handle_t**buffer;int length;int capacity;}ui_handle_t_array_t;
typedef struct sys_string_callback_t_array{sys_string_callback_t**buffer;int length;int capacity;}sys_string_callback_t_array_t;
typedef struct mat4_box_t_array{mat4_box_t**buffer;int length;int capacity;}mat4_box_t_array_t;
typedef struct slot_brush_t_array{slot_brush_t**buffer;int length;int capacity;}slot_brush_t_array_t;
typedef struct f32_array_t_array{f32_array_t**buffer;int length;int capacity;}f32_array_t_array_t;
typedef struct asset_t_array{asset_t**buffer;int length;int capacity;}asset_t_array_t;
typedef struct slot_font_t_array{slot_font_t**buffer;int length;int capacity;}slot_font_t_array_t;
typedef struct sys_callback_t_array{sys_callback_t**buffer;int length;int capacity;}sys_callback_t_array_t;
typedef struct string_t_array{string_t**buffer;int length;int capacity;}string_t_array_t;
typedef struct vertex_element_t_array{vertex_element_t**buffer;int length;int capacity;}vertex_element_t_array_t;
typedef struct ui_coloring_t_array{ui_coloring_t**buffer;int length;int capacity;}ui_coloring_t_array_t;
typedef struct shader_const_t_array{shader_const_t**buffer;int length;int capacity;}shader_const_t_array_t;
typedef struct slot_layer_t_array{slot_layer_t**buffer;int length;int capacity;}slot_layer_t_array_t;
typedef struct callback_t_array{callback_t**buffer;int length;int capacity;}callback_t_array_t;
typedef struct swatch_color_t_array{swatch_color_t**buffer;int length;int capacity;}swatch_color_t_array_t;
typedef struct gpu_texture_t_array{gpu_texture_t**buffer;int length;int capacity;}gpu_texture_t_array_t;
typedef struct step_t_array{step_t**buffer;int length;int capacity;}step_t_array_t;
typedef struct physics_pair_t_array{physics_pair_t**buffer;int length;int capacity;}physics_pair_t_array_t;
typedef struct ui_node_socket_t_array{ui_node_socket_t**buffer;int length;int capacity;}ui_node_socket_t_array_t;
typedef struct logic_node_t_array{logic_node_t**buffer;int length;int capacity;}logic_node_t_array_t;
typedef struct transform_t_array{transform_t**buffer;int length;int capacity;}transform_t_array_t;
typedef struct ui_node_button_t_array{ui_node_button_t**buffer;int length;int capacity;}ui_node_button_t_array_t;
typedef struct tilesheet_action_t_array{tilesheet_action_t**buffer;int length;int capacity;}tilesheet_action_t_array_t;
typedef struct obj_t_array{obj_t**buffer;int length;int capacity;}obj_t_array_t;
typedef struct gpu_buffer_t_array{gpu_buffer_t**buffer;int length;int capacity;}gpu_buffer_t_array_t;
typedef struct index_array_t_array{index_array_t**buffer;int length;int capacity;}index_array_t_array_t;
typedef struct logic_node_input_t_array{logic_node_input_t**buffer;int length;int capacity;}logic_node_input_t_array_t;
typedef struct vec4_box_t_array{vec4_box_t**buffer;int length;int capacity;}vec4_box_t_array_t;
typedef struct u32_array_t_array{u32_array_t**buffer;int length;int capacity;}u32_array_t_array_t;
typedef struct tab_draw_array_t_array{tab_draw_array_t**buffer;int length;int capacity;}tab_draw_array_t_array_t;
typedef struct tab_draw_t_array{tab_draw_t**buffer;int length;int capacity;}tab_draw_t_array_t;
typedef struct object_t_array{object_t**buffer;int length;int capacity;}object_t_array_t;
typedef struct track_t_array{track_t**buffer;int length;int capacity;}track_t_array_t;
typedef struct tex_unit_t_array{tex_unit_t**buffer;int length;int capacity;}tex_unit_t_array_t;
typedef struct scene_t_array{scene_t**buffer;int length;int capacity;}scene_t_array_t;
typedef struct gamepad_t_array{gamepad_t**buffer;int length;int capacity;}gamepad_t_array_t;
typedef struct render_target_t_array{render_target_t**buffer;int length;int capacity;}render_target_t_array_t;
typedef struct camera_data_t_array{camera_data_t**buffer;int length;int capacity;}camera_data_t_array_t;
typedef struct ui_node_link_t_array{ui_node_link_t**buffer;int length;int capacity;}ui_node_link_t_array_t;
typedef struct mesh_data_t_array{mesh_data_t**buffer;int length;int capacity;}mesh_data_t_array_t;
typedef struct shader_context_t_array{shader_context_t**buffer;int length;int capacity;}shader_context_t_array_t;
typedef struct raw_mesh_t_array{raw_mesh_t**buffer;int length;int capacity;}raw_mesh_t_array_t;
typedef struct export_preset_texture_t_array{export_preset_texture_t**buffer;int length;int capacity;}export_preset_texture_t_array_t;
typedef struct speaker_data_t_array{speaker_data_t**buffer;int length;int capacity;}speaker_data_t_array_t;
typedef struct material_context_t_array{material_context_t**buffer;int length;int capacity;}material_context_t_array_t;
typedef struct tween_anim_t_array{tween_anim_t**buffer;int length;int capacity;}tween_anim_t_array_t;
typedef struct camera_object_t_array{camera_object_t**buffer;int length;int capacity;}camera_object_t_array_t;
typedef struct frustum_plane_t_array{frustum_plane_t**buffer;int length;int capacity;}frustum_plane_t_array_t;
typedef struct layer_data_t_array{layer_data_t**buffer;int length;int capacity;}layer_data_t_array_t;
typedef struct tilesheet_data_t_array{tilesheet_data_t**buffer;int length;int capacity;}tilesheet_data_t_array_t;
typedef struct ui_node_t_array{ui_node_t**buffer;int length;int capacity;}ui_node_t_array_t;
typedef struct packed_asset_t_array{packed_asset_t**buffer;int length;int capacity;}packed_asset_t_array_t;
typedef struct shader_data_t_array{shader_data_t**buffer;int length;int capacity;}shader_data_t_array_t;

void args_parse();
void args_run();
void args_run_352();
void args_run_659();
void base_init();
void base_init_1048(string_t * drop_path);
void base_init_1074();
void base_init_1092();
void base_init_1098();
void base_init_1104();
void base_init_1120();
void base_save_and_quit_callback(bool save);
i32 base_w();
i32 base_h();
i32 base_x();
i32 base_y();
void base_on_resize();
void base_save_window_rect();
void base_resize();
void base_redraw_ui();
void base_update();
void base_update_2629();
void base_material_dropped();
void base_handle_drop_paths();
rect_t * base_get_drag_background();
gpu_texture_t * base_get_drag_image();
void base_render();
string_t_array_t * base_enum_texts(string_t * node_type);
i32 base_get_asset_index(string_t * file_name);
void base_toggle_fullscreen();
bool base_is_scrolling();
bool base_is_combo_selected();
ui_t_array_t * base_get_uis();
bool base_is_decal_layer();
void base_redraw_status();
void base_redraw_console();
void base_init_undo_layers();
void base_init_layout();
void base_init_config();
void box_export_show_textures();
void box_export_show_textures_4694(ui_t * ui);
void box_export_show_bake_material();
void box_export_show_bake_material_4773(ui_t * ui);
void box_export_tab_export_textures(ui_t * ui,string_t * title,bool bake_material);
void box_export_tab_export_textures_5338();
void box_export_tab_export_textures_5386(string_t * path);
void box_export_tab_export_textures_5399();
void box_export_tab_presets(ui_t * ui);
void box_export_tab_presets_5550(ui_t * ui);
void box_export_tab_presets_5693(string_t * path);
void box_export_tab_presets_5960(ui_t * ui);
void box_export_tab_atlases(ui_t * ui);
void box_export_show_mesh();
void box_export_show_mesh_6509(ui_t * ui);
void box_export_tab_export_mesh(ui_t * ui,ui_handle_t * htab);
void box_export_tab_export_mesh_6929(string_t * path);
void box_export_show_material();
void box_export_show_material_7026(ui_t * ui);
void box_export_show_material_7160(string_t * path);
void box_export_show_material_7191(string_t * path);
void box_export_show_brush();
void box_export_show_brush_7228(ui_t * ui);
void box_export_show_brush_7362(string_t * path);
void box_export_show_brush_7391(string_t * path);
void box_export_fetch_presets();
void box_export_parse_preset();
void box_export_new_preset(string_t * name);
void box_export_save_preset();
string_t * box_export_preset_to_json(export_preset_t * p);
void box_preferences_show();
void box_preferences_show_7818(ui_t * ui);
void box_preferences_show_8477(ui_t * ui);
void box_preferences_show_8497(ui_t * ui);
void box_preferences_show_8606(string_t * path);
void box_preferences_show_8638(config_t * raw);
void box_preferences_show_8695(ui_t * ui);
void box_preferences_show_8826(ui_t * ui);
void box_preferences_show_9007(string_t * path);
void box_preferences_show_9042(string_t * path);
void box_preferences_show_9234(ui_t * ui);
void box_preferences_show_11275(ui_t * ui);
void box_preferences_show_11458(string_t * path);
void box_preferences_show_11493(string_t * dest);
void box_preferences_show_11732(ui_t * ui);
void box_preferences_show_11900(string_t * path);
void box_preferences_show_12096(ui_t * ui);
void box_preferences_show_12202(string_t * dest);
void box_preferences_show_12323();
void box_preferences_fetch_themes();
void box_preferences_fetch_keymaps();
void box_preferences_fetch_plugins();
i32 box_preferences_get_theme_index();
i32 box_preferences_get_preset_index();
void box_preferences_set_scale();
string_t * box_preferences_theme_to_json(ui_theme_t * theme);
void box_projects_show();
void box_projects_show_12842(ui_t * ui);
void box_projects_tab(ui_t * ui);
void box_projects_tab_13429(string_t * path);
void box_projects_tab_13498(ui_t * ui);
void box_projects_tab_13518();
void box_projects_recent_tab(ui_t * ui);
void box_projects_draw_badge(ui_t * ui);
void box_projects_get_started_tab(ui_t * ui);
void box_projects_align_to_fullscreen();
void camera_init();
void camera_update();
f32 camera_distance();
i32 camera_index();
f32 camera_get_zoom_speed();
void camera_reset(i32 view_index);
void camera_pan_action(bool modif,bool default_keymap);
f32 camera_get_zoom_delta();
void compass_render();
void compass_init_hitbox();
bool _compass_compare_quat(quat_t a,quat_t b);
void compass_update();
void config_load();
void config_save();
void config_init();
string_t * config_get_sha();
string_t * config_get_date();
iron_window_options_t * config_get_options();
void config_restore();
void config_import_from(config_t * from);
void config_apply();
i32 config_get_super_sample_quality(f32 f);
f32 config_get_super_sample_size(i32 i);
i32 config_texture_res_size(i32 pos);
i32 config_get_texture_res();
i32 config_get_layer_res();
i32 config_get_atlas_res();
i32 config_get_texture_res_x();
i32 config_get_texture_res_y();
i32 config_get_texture_res_pos(i32 i);
void config_load_theme(string_t * theme,bool tag_redraw);
void config_enable_plugin(string_t * f);
void config_disable_plugin(string_t * f);
void console_draw_toast(string_t * s);
void _console_toast_render(string_t * s);
void console_toast(string_t * s);
void console_draw_progress();
void console_progress(string_t * s);
void console_info(string_t * s);
void console_error(string_t * s);
void console_log(string_t * s);
void console_trace(string_t * s);
context_t * context_create();
void context_init();
bool context_use_deferred();
void context_select_material(i32 i);
void context_set_material(slot_material_t * m);
void context_select_brush(i32 i);
void context_set_brush(slot_brush_t * b);
void context_select_font(i32 i);
void context_set_font(slot_font_t * f);
void context_select_layer(i32 i);
void context_set_layer(slot_layer_t * l);
void context_select_tool(i32 i);
void context_init_tool();
void context_select_paint_object(mesh_object_t * o);
mesh_object_t * context_main_object();
bool context_layer_filter_used();
bool context_object_mask_used();
bool context_in_viewport();
bool context_in_paint_area();
bool context_in_layers();
bool context_in_materials();
bool context_in_2d_view(view_2d_type_t type);
bool context_in_nodes();
bool context_in_swatches();
bool context_in_browser();
bool context_is_picker();
bool context_is_decal();
bool context_is_decal_mask();
bool context_is_decal_mask_paint();
bool context_is_floating_toolbar();
area_type_t context_get_area_type();
void context_set_viewport_mode(viewport_mode_t mode);
void context_load_envmap();
void context_update_envmap();
void context_set_viewport_shader(any viewport_shader);
void context_set_render_path();
bool context_enable_import_plugin(string_t * file);
void context_set_swatch(swatch_color_t * s);
void export_arm_run_mesh(string_t * path,mesh_object_t_array_t * paint_objects);
void export_arm_run_project();
string_t * export_arm_texture_node_name();
void export_arm_export_node(ui_node_t * n,asset_t_array_t * assets);
void export_arm_run_material(string_t * path);
buffer_t * export_arm_bgra_swap(buffer_t * buffer);
void export_arm_run_brush(string_t * path);
string_t_array_t * export_arm_assets_to_files(string_t * project_path,asset_t_array_t * assets);
string_t_array_t * export_arm_meshes_to_files(string_t * project_path);
string_t_array_t * export_arm_fonts_to_files(string_t * project_path,slot_font_t_array_t * fonts);
packed_asset_t_array_t * export_arm_get_packed_assets(string_t * project_path,string_t_array_t * texture_files);
void export_arm_pack_assets(project_format_t * raw,asset_t_array_t * assets);
void export_arm_run_swatches(string_t * path);
f32_array_t * export_arm_vec3f32(vec4_t v);
void export_mesh_run(string_t * path,mesh_object_t_array_t * paint_objects,bool apply_disp,bool merge_vertices);
void export_obj_write_string(u8_array_t * out,string_t * str);
void export_obj_run(string_t * path,mesh_object_t_array_t * paint_objects,bool apply_disp);
void export_obj_run_fast(string_t * path,mesh_object_t_array_t * paint_objects);
void export_texture_run(string_t * path,bool bake_material);
void export_texture_run_bake_material(string_t * path);
void export_texture_run_layers(string_t * path,slot_layer_t_array_t * layers,string_t * object_name,bool bake_material);
void export_texture_write_texture(string_t * file,buffer_t * pixels,i32 type,i32 off);
void export_texture_copy_channel(buffer_t * from,i32 from_channel,buffer_t * to,i32 to_channel,bool linear);
void export_texture_copy_channel_inv(buffer_t * from,i32 from_channel,buffer_t * to,i32 to_channel,bool linear);
void export_texture_extract_channel(buffer_t * from,i32 from_channel,buffer_t * to,i32 to_channel,i32 step,i32 mask,bool linear);
void export_texture_set_channel(i32 value,buffer_t * to,i32 to_channel,bool linear);
void export_texture_to_srgb(buffer_t * to,i32 to_channel);
string_t_array_t * file_read_directory(string_t * path);
void file_create_directory(string_t * path);
void file_copy(string_t * src_path,string_t * dst_path);
void file_start(string_t * path);
void file_load_url(string_t * url);
void file_delete(string_t * path);
bool file_exists(string_t * path);
void file_download(string_t * url,string_t * dst_path,void(*done)(string_t *),i32 size);
void file_download_32479(string_t * url,buffer_t * ab);
void file_download_bytes(string_t * url,void(*done)(string_t *,buffer_t *));
void file_download_bytes_32618(string_t * url);
void file_cache_cloud(string_t * path,void(*done)(string_t *));
void file_cache_cloud_32861(string_t * url);
void file_init_cloud_bytes(void(*done)(void),string_t * append);
void file_init_cloud_bytes_32983(string_t * url,buffer_t * buffer);
void file_init_cloud(void(*done)(void));
raw_mesh_t * geom_make_plane(f32 size_x,f32 size_y,i32 verts_x,i32 verts_y,f32 uv_scale);
raw_mesh_t * geom_make_uv_sphere(f32 radius,i32 width_segments,i32 height_segments,bool stretch_uv,f32 uv_scale);
void gizmo_update();
void history_undo();
void history_undo_36933();
void history_undo_37551(step_t * step);
void history_redo();
void history_redo_38215(slot_layer_t * l);
void history_redo_38248(slot_layer_t * l);
void history_redo_38288(slot_layer_t * l);
void history_redo_38439();
void history_redo_38553();
void history_redo_38719();
void history_redo_38754(step_t * step);
void history_reset();
void history_edit_nodes(ui_node_canvas_t * canvas,i32 canvas_type,i32 canvas_group);
void history_paint();
void history_new_layer();
void history_new_black_mask();
void history_new_white_mask();
void history_new_fill_mask();
void history_new_group();
void history_duplicate_layer();
void history_delete_layer();
void history_clear_layer();
void history_order_layers(i32 prev_order);
void history_merge_layers();
void history_apply_mask();
void history_invert_mask();
void history_apply_filter();
void history_to_fill_layer();
void history_to_fill_mask();
void history_to_paint_layer();
void history_to_paint_mask();
void history_layer_opacity();
void history_layer_blending();
void history_new_material();
void history_delete_material();
void history_duplicate_material();
void history_delete_material_group(node_group_t * group);
step_t * history_push(string_t * name);
void history_redo_merge_layers();
void history_copy_merging_layers();
void history_copy_merging_layers2(slot_layer_t_array_t * layers);
void history_swap_active();
void history_copy_to_undo(i32 from_id,i32 to_id,bool is_mask);
ui_node_canvas_t * history_get_canvas(step_t * step);
void history_set_canvas(step_t * step,ui_node_canvas_t * canvas);
void history_swap_canvas(step_t * step);
void import_arm_run_project(string_t * path);
void import_arm_run_mesh(project_format_t * raw);
void import_arm_run_material(string_t * path);
void import_arm_run_material_from_project(project_format_t * project,string_t * path);
void import_arm_run_material_from_project_43216(slot_material_t_array_t * imported);
bool import_arm_group_exists(ui_node_canvas_t * c);
void import_arm_rename_group(string_t * name,slot_material_t_array_t * materials,ui_node_canvas_t_array_t * groups);
void import_arm_run_brush(string_t * path);
void import_arm_run_brush_from_project(project_format_t * project,string_t * path);
void import_arm_run_brush_from_project_43769(slot_brush_t_array_t * imported);
void import_arm_run_swatches(string_t * path,bool replace_existing);
void import_arm_run_swatches_from_project(project_format_t * project,string_t * path,bool replace_existing);
void import_arm_make_pink(string_t * abs);
string_t * import_arm_texture_node_name();
void import_arm_init_nodes(ui_node_t_array_t * nodes);
void import_arm_unpack_asset(project_format_t * project,string_t * abs,string_t * file);
ui_node_socket_t_array_t * _import_arm_get_node_socket_array(any_map_t * old,string_t * key);
ui_node_canvas_t_array_t * _import_arm_get_node_canvas_array(any_map_t * map,string_t * key);
bool import_arm_has_version(buffer_t * b);
bool import_arm_is_legacy(buffer_t * b);
project_format_t * import_arm_from_legacy(buffer_t * b);
void import_asset_run(string_t * path,f32 drop_x,f32 drop_y,bool show_box,bool hdr_as_envmap,void(*done)(void));
void import_asset_run_45777(string_t * abs);
void import_blend_material_run(string_t * path);
void import_blend_material_run_46108(ui_t * ui);
void _import_blend_material();
void _import_blend_material_46250();
void import_blend_mesh_ui();
void import_blend_mesh_ui_46420(string_t * path);
void import_blend_mesh_run(string_t * path,bool replace_existing);
void import_envmap_run(string_t * path,gpu_texture_t * image);
void import_envmap_get_radiance_mip(gpu_texture_t * mip,i32 level,gpu_texture_t * radiance);
vec4_t import_envmap_reverse_equirect(f32 x,f32 y);
f32_array_t * import_envmap_get_spherical_harmonics(buffer_t * source,i32 source_width,i32 source_height);
void import_folder_run(string_t * path);
void import_folder_place_image_node(ui_nodes_t * nodes,ui_node_canvas_t * canvas,string_t * asset,i32 ny,i32 to_id,i32 to_socket);
void import_font_run(string_t * path);
void import_font_run_48472(slot_font_t_array_t * font_slots);
void import_keymap_run(string_t * path);
void import_mesh_run(string_t * path,bool _clear_layers,bool replace_existing);
void import_mesh_finish_import();
i32 import_mesh_finish_import_48963(any_ptr pa,any_ptr pb);
void _import_mesh_make_mesh(raw_mesh_t * mesh);
void _import_mesh_make_mesh_49173(mesh_data_t * md);
void import_mesh_first_unwrap_done(raw_mesh_t * mesh);
void import_mesh_make_mesh(raw_mesh_t * mesh);
bool _import_mesh_is_unique_name(string_t * s);
string_t * _import_mesh_number_ext(i32 i);
void _import_mesh_add_mesh(raw_mesh_t * mesh);
void import_mesh_add_mesh(raw_mesh_t * mesh);
mesh_data_t * import_mesh_raw_mesh(raw_mesh_t * mesh);
void import_obj_run(string_t * path,bool replace_existing);
void import_plugin_run(string_t * path);
void import_texture_run(string_t * path,bool hdr_as_envmap);
void import_texture_run_51398(import_texture_data_t * itd);
void import_texture_run_51651(import_texture_data_t * itd);
gpu_texture_t * import_texture_default_importer(string_t * path);
void import_theme_run(string_t * path);
void keymap_load();
void keymap_save();
string_t * keymap_to_json(any_map_t * keymap);
any_map_t * keymap_get_default();
void layers_init();
void layers_resize();
void layers_resize_52777(slot_layer_t * l);
void layers_set_bits();
void layers_make_temp_img();
void layers_make_temp_mask_img();
void layers_make_export_img();
void layers_apply_mask(slot_layer_t * l,slot_layer_t * m);
void layers_commands_merge_pack(gpu_pipeline_t * pipe,gpu_texture_t * i0,gpu_texture_t * i1,gpu_texture_t * i1pack,f32 i1mask_opacity,gpu_texture_t * i1texmask,i32 i1blending);
bool layers_is_fill_material();
void layers_update_fill_layers();
void layers_update_fill_layer(bool parse_paint);
void layers_set_object_mask();
slot_layer_t * layers_new_layer(bool clear,i32 position);
void layers_new_layer_54899(slot_layer_t * l);
slot_layer_t * layers_new_mask(bool clear,slot_layer_t * parent,i32 position);
void layers_new_mask_55010(slot_layer_t * l);
slot_layer_t * layers_new_group();
void layers_create_fill_layer(uv_type_t uv_type,mat4_t decal_mat,i32 position);
void layers_create_fill_layer_55118();
void layers_create_image_mask(asset_t * asset);
void layers_create_color_layer(i32 base_color,f32 occlusion,f32 roughness,f32 metallic,i32 position);
void layers_create_color_layer_55291();
void layers_duplicate_layer(slot_layer_t * l);
void layers_apply_masks(slot_layer_t * l);
void layers_merge_down();
slot_layer_t * layers_merge_group(slot_layer_t * l);
void layers_merge_layer(slot_layer_t * l0,slot_layer_t * l1,bool use_mask);
slot_layer_t * layers_flatten(bool height_to_normal,slot_layer_t_array_t * layers);
void layers_on_resized();
void line_draw_init();
void line_draw_render(mat4_t matrix);
void line_draw_bounds(mat4_t mat,vec4_t dim);
void line_draw_lineb(i32 a,i32 b,i32 c,i32 d,i32 e,i32 f);
void line_draw_line(f32 x1,f32 y1,f32 z1,f32 x2,f32 y2,f32 z2);
void line_draw_begin();
void line_draw_end();
void shape_draw_sphere(mat4_t mat);
logic_node_t * logic_node_create(logic_node_ext_t * ext);
void logic_node_add_input(logic_node_t * self,logic_node_ext_t * node,i32 from);
void logic_node_add_outputs(logic_node_t * self,logic_node_t_array_t * nodes);
any logic_node_get(logic_node_t * self,i32 from);
gpu_texture_t * logic_node_get_as_image(logic_node_t * self,i32 from);
gpu_texture_t * logic_node_get_cached_image(logic_node_t * self);
void logic_node_set(logic_node_t * self,any value);
logic_node_input_t * logic_node_input_create(logic_node_ext_t * node,i32 from);
logic_node_value_t * logic_node_input_get(logic_node_input_t * self);
gpu_texture_t * logic_node_input_get_as_image(logic_node_input_t * self);
void logic_node_input_set(logic_node_input_t * self,f32_array_t * value);
void nodes_material_init();
void nodes_material_vector_curves_button(i32 node_id);
void nodes_material_color_ramp_button(i32 node_id);
void nodes_material_new_group_button(i32 node_id);
void nodes_material_group_input_button(i32 node_id);
void nodes_material_group_output_button(i32 node_id);
void nodes_material_add_socket_button(ui_t * ui,ui_nodes_t * nodes,ui_node_t * node,ui_node_socket_t_array_t * sockets);
void nodes_material_add_socket_button_77026(ui_t * ui);
void nodes_material_sync_sockets(ui_node_t * node);
void nodes_material_sync_group_sockets(ui_node_canvas_t * canvas,string_t * group_name,ui_node_t * node);
i32 nodes_material_get_socket_color(string_t * type);
f32_array_t * nodes_material_get_socket_default_value(string_t * type);
string_t * nodes_material_get_socket_name(string_t * type);
ui_node_socket_t * nodes_material_create_socket(ui_nodes_t * nodes,ui_node_t * node,string_t * name,string_t * type,ui_node_canvas_t * canvas,f32 min,f32 max,any default_value);
ui_node_t * nodes_material_get_node_t(string_t * node_type);
ui_node_t * nodes_material_create_node(string_t * node_type,node_group_t * group);
node_shader_t * node_shader_create(node_shader_context_t * context);
void node_shader_add_in(node_shader_t * raw,string_t * s);
void node_shader_add_out(node_shader_t * raw,string_t * s);
void node_shader_add_constant(node_shader_t * raw,string_t * s,string_t * link);
void node_shader_add_texture(node_shader_t * raw,string_t * s,string_t * link);
void node_shader_add_function(node_shader_t * raw,string_t * s);
void node_shader_write_vert(node_shader_t * raw,string_t * s);
void node_shader_write_end_vert(node_shader_t * raw,string_t * s);
void node_shader_write_attrib_vert(node_shader_t * raw,string_t * s);
void node_shader_write_frag(node_shader_t * raw,string_t * s);
void node_shader_write_attrib_frag(node_shader_t * raw,string_t * s);
string_t * node_shader_data_size(node_shader_t * raw,string_t * data);
void node_shader_vstruct_to_vsin(node_shader_t * raw);
string_t * node_shader_get(node_shader_t * raw);
node_shader_context_t * node_shader_context_create(material_t * material,shader_context_t * props);
void node_shader_context_add_elem(node_shader_context_t * raw,string_t * name,string_t * data_type);
bool node_shader_context_is_elem(node_shader_context_t * raw,string_t * name);
vertex_element_t * node_shader_context_get_elem(node_shader_context_t * raw,string_t * name);
void node_shader_context_add_constant(node_shader_context_t * raw,string_t * ctype,string_t * name,string_t * link);
void node_shader_context_add_texture_unit(node_shader_context_t * raw,string_t * ctype,string_t * name,string_t * link);
node_shader_t * node_shader_context_make_kong(node_shader_context_t * raw);
void operator_register(string_t * name,void(*call)(void));
void operator_run(string_t * name);
void operator_update();
bool operator_shortcut(string_t * s,shortcut_type_t type);
void parser_exr_write_string(u8_array_t * out,string_t * str);
void parser_exr_write_line16(i32 byte_pos);
void parser_exr_write_line32(i32 byte_pos);
void parser_exr_write_bgr(i32 off,i32 pos,i32 byte_size);
void parser_exr_write_single(i32 off,i32 pos,i32 byte_size);
buffer_t * parser_exr_run(i32 width,i32 height,buffer_t * src,i32 bits,i32 type,i32 off);
logic_node_ext_t * parser_logic_get_logic_node(ui_node_t * node);
ui_node_t * parser_logic_get_node(i32 id);
ui_node_link_t * parser_logic_get_link(i32 id);
ui_node_link_t * parser_logic_get_input_link(ui_node_socket_t * inp);
ui_node_link_t_array_t * parser_logic_get_output_links(ui_node_socket_t * out);
string_t * parser_logic_safe_src(string_t * s);
string_t * parser_logic_node_name(ui_node_t * node);
void parser_logic_parse(ui_node_canvas_t * canvas);
string_t * parser_logic_build_node(ui_node_t * node);
ui_node_t_array_t * parser_logic_get_root_nodes(ui_node_canvas_t * node_group);
logic_node_ext_t * parser_logic_build_default_node(ui_node_socket_t * inp);
logic_node_ext_t * parser_logic_create_node_instance(string_t * node_type,ui_node_t * raw,f32_array_t * args);
ui_node_t * parser_material_get_node(i32 id);
ui_node_link_t * parser_material_get_link(i32 id);
ui_node_link_t * parser_material_get_input_link(ui_node_socket_t * inp);
ui_node_link_t_array_t * parser_material_get_output_links(ui_node_socket_t * out);
void parser_material_init();
shader_out_t * parser_material_parse(ui_node_canvas_t * canvas,node_shader_context_t * _con,node_shader_t * _kong,material_context_t * _matcon);
void parser_material_finalize(node_shader_context_t * con);
shader_out_t * parser_material_parse_output(ui_node_t * node);
shader_out_t * parser_material_parse_output_pbr(ui_node_t * node);
ui_node_canvas_t * parser_material_get_group(string_t * name);
void parser_material_push_group(ui_node_canvas_t * g);
void parser_material_pop_group();
string_t * parser_material_parse_group(ui_node_t * node,ui_node_socket_t * socket);
string_t * parser_material_parse_group_input(ui_node_t * node,ui_node_socket_t * socket);
string_t * parser_material_parse_input(ui_node_socket_t * inp);
shader_out_t * parser_material_parse_shader_input(ui_node_socket_t * inp);
shader_out_t * parser_material_parse_shader(ui_node_t * node,ui_node_socket_t * socket);
void parser_material_write(node_shader_t * raw,string_t * s);
string_t * parser_material_parse_vector_input(ui_node_socket_t * inp);
void _parser_material_cache_tex_text_node(string_t * file,string_t * text);
void _parser_material_cache_tex_text_node_85788(string_t * text);
string_t * parser_material_parse_vector(ui_node_t * node,ui_node_socket_t * socket);
void parse_normal_map_color_input(ui_node_socket_t * inp);
string_t * parser_material_parse_value_input(ui_node_socket_t * inp,bool vector_as_grayscale);
string_t * parser_material_parse_value(ui_node_t * node,ui_node_socket_t * socket);
string_t * parser_material_get_coord(ui_node_t * node);
string_t * parser_material_get_gradient(string_t * grad,string_t * co);
string_t * parser_material_vector_curve(string_t * name,string_t * fac,f32_ptr points,i32 num);
string_t * parser_material_res_var_name(ui_node_t * node,ui_node_socket_t * socket);
string_t * parser_material_write_result(ui_node_link_t * l);
string_t * parser_material_store_var_name(ui_node_t * node);
string_t * parser_material_texture_store(ui_node_t * node,bind_tex_t * tex,string_t * tex_name,i32 color_space);
string_t * parser_material_vec1(f32 v);
string_t * parser_material_vec3(f32_array_t * v);
string_t * parser_material_to_vec3(string_t * s);
ui_node_t * parser_material_node_by_type(ui_node_t_array_t * nodes,string_t * ntype);
i32 parser_material_socket_index(ui_node_t * node,ui_node_socket_t * socket);
string_t * parser_material_node_name(ui_node_t * node,ui_node_t_array_t * _parents);
string_t * parser_material_safesrc(string_t * s);
string_t * parser_material_enum_data(string_t * s);
bind_tex_t * parser_material_make_bind_tex(string_t * tex_name,string_t * file);
bind_tex_t * parser_material_make_texture(ui_node_t * image_node,string_t * tex_name);
bool parser_material_is_pow(i32 num);
string_t * parser_material_asset_path(string_t * s);
string_t * parser_material_extract_filename(string_t * s);
string_t * parser_material_safestr(string_t * s);
string_t * u8_array_string_at(u8_array_t * a,i32 i);
string_t * path_data();
string_t * path_to_relative(string_t * from,string_t * to);
string_t * path_normalize(string_t * path);
string_t * path_base_dir(string_t * path);
string_t * path_base_name(string_t * path);
string_t * path_working_dir();
bool path_is_mesh(string_t * path);
bool path_is_texture(string_t * path);
bool path_is_font(string_t * path);
bool path_is_project(string_t * path);
bool path_is_plugin(string_t * path);
bool path_is_json(string_t * path);
bool path_is_text(string_t * path);
bool path_is_gimp_color_palette(string_t * path);
bool path_is_known(string_t * path);
bool path_check_ext(string_t * p,string_t_array_t * exts);
bool path_is_base_color_tex(string_t * p);
bool path_is_opacity_tex(string_t * p);
bool path_is_normal_map_tex(string_t * p);
bool path_is_occlusion_tex(string_t * p);
bool path_is_roughness_tex(string_t * p);
bool path_is_metallic_tex(string_t * p);
bool path_is_displacement_tex(string_t * p);
bool path_is_folder(string_t * p);
bool path_is_protected();
physics_body_t * physics_body_create();
void physics_body_init(physics_body_t * body,object_t * obj);
void physics_body_remove(i32 uid);
void physics_body_apply_impulse(physics_body_t * body,vec4_t dir);
void physics_body_sync_transform(physics_body_t * body);
void physics_body_update(physics_body_t * body);
physics_world_t * physics_world_create();
void physics_world_update(physics_world_t * world);
physics_pair_t_array_t * physics_world_get_contact_pairs(physics_world_t * world,physics_body_t * body);
void physics_world_destroy();
gpu_pipeline_t * _pipes_make_merge(bool red,bool green,bool blue,bool alpha);
void pipes_init();
i32 pipes_get_constant_location(string_t * type);
plugin_t * plugin_create();
void plugin_start(string_t * plugin);
void plugin_stop(string_t * plugin);
void plugin_notify_on_ui(plugin_t * plugin,any f);
void plugin_notify_on_update(plugin_t * plugin,any f);
void plugin_notify_on_delete(plugin_t * plugin,any f);
void project_open();
void project_open_101206(string_t * path);
void project_save(bool save_and_quit);
void project_save_101337();
void project_save_as(bool save_and_quit);
void project_save_as_101381(string_t * path);
void project_new_box();
void project_new_box_101450(ui_t * ui);
void project_new(bool reset_layers);
void project_import_material();
void project_import_material_102523(string_t * path);
ui_node_link_t * project_create_node_link(ui_node_link_t_array_t * links,i32 from_id,i32 from_socket,i32 to_id,i32 to_socket);
void project_import_brush();
void project_import_brush_102640(string_t * path);
void project_import_mesh(bool replace_existing,void(*done)(void));
void project_import_mesh_102868(string_t * path);
void project_append_mesh();
void project_import_mesh_box(string_t * path,bool replace_existing,bool clear_layers,void(*done)(void));
void project_import_mesh_box_102950(ui_t * ui);
void project_reimport_mesh();
string_t_array_t * project_get_unwrap_plugins();
void project_unwrap_mesh_box(raw_mesh_t * mesh,void(*done)(raw_mesh_t *),bool skip_ui);
void project_unwrap_mesh_box_103460(ui_t * ui);
void project_unwrap_mesh(raw_mesh_t * mesh,void(*done)(raw_mesh_t *));
void project_import_asset(string_t * filters,bool hdr_as_envmap);
void project_import_asset_103758(string_t * path);
void project_import_swatches(bool replace_existing);
void project_import_swatches_103804(string_t * path);
void project_reimport_textures();
void project_reimport_texture_load(string_t * path,asset_t * asset);
void project_reimport_texture_load_103986();
void project_reimport_texture(asset_t * asset);
void project_reimport_texture_104051(string_t * path);
gpu_texture_t * project_get_image(asset_t * asset);
string_t_array_t * project_get_used_atlases();
bool project_is_atlas_object(mesh_object_t * p);
mesh_object_t_array_t * project_get_atlas_objects(i32 object_mask);
bool project_packed_asset_exists(packed_asset_t_array_t * packed_assets,string_t * name);
void project_export_swatches();
void project_export_swatches_104472(string_t * path);
swatch_color_t * make_swatch(i32 base);
swatch_color_t * project_clone_swatch(swatch_color_t * swatch);
void project_set_default_swatches();
node_group_t * project_get_material_group_by_name(string_t * group_name);
bool project_is_material_group_in_use(node_group_t * group);
void render_path_base_init();
void render_path_base_apply_config();
f32 render_path_base_get_super_sampling();
void render_path_base_draw_compass();
void render_path_base_begin();
void render_path_base_end();
bool render_path_base_ssaa4();
bool render_path_base_is_cached();
void render_path_base_commands(void(*draw_commands)(void));
void render_path_base_draw_bloom();
void render_path_base_draw_split(void(*draw_commands)(void));
void render_path_base_init_ssao();
void render_path_base_draw_ssao();
void render_path_base_draw_deferred_light();
void render_path_base_draw_taa(string_t * bufa,string_t * bufb);
void render_path_base_draw_gbuffer();
void render_path_base_make_gbuffer_copy_textures();
void render_path_base_copy_to_gbuffer();
void render_path_deferred_init();
void render_path_deferred_commands();
void render_path_deferred_draw_deferred();
void render_path_forward_init();
void render_path_forward_commands();
void render_path_forward_draw_forward();
void render_path_preview_init();
void render_path_preview_commands_preview();
void render_path_preview_commands_decal();
void render_path_raytrace_init();
void render_path_raytrace_commands(bool use_live_layer);
void render_path_raytrace_raytrace_init(string_t * shader_name,bool build,bool bake);
void render_path_raytrace_build_data(bool bake);
void render_path_raytrace_draw(bool use_live_layer);
bool render_path_raytrace_bake_commands(void(*parse_paint_material)(bool));
string_t * render_path_raytrace_bake_get_bake_shader_name();
void resource_load(string_t_array_t * names);
gpu_texture_t * resource_get(string_t * name);
rect_t * resource_tile50(gpu_texture_t * img,i32 x,i32 y);
rect_t * resource_tile25(gpu_texture_t * img,i32 x,i32 y);
rect_t * resource_tile18(gpu_texture_t * img,i32 x,i32 y);
slot_brush_t * slot_brush_create(ui_node_canvas_t * c);
slot_font_t * slot_font_create(string_t * name,draw_font_t * font,string_t * file);
slot_layer_t * slot_layer_create(string_t * ext,layer_slot_type_t type,slot_layer_t * parent);
void slot_layer_delete(slot_layer_t * raw);
void slot_layer_unload(slot_layer_t * raw);
void slot_layer_swap(slot_layer_t * raw,slot_layer_t * other);
void slot_layer_clear(slot_layer_t * raw,i32 base_color,gpu_texture_t * base_image,f32 occlusion,f32 roughness,f32 metallic);
void slot_layer_invert_mask(slot_layer_t * raw);
void slot_layer_apply_mask(slot_layer_t * raw);
slot_layer_t * slot_layer_duplicate(slot_layer_t * raw);
void slot_layer_resize_and_set_bits(slot_layer_t * raw);
void slot_layer_to_fill_layer(slot_layer_t * raw);
void slot_layer_to_fill_layer_113168();
void slot_layer_to_paint_layer(slot_layer_t * raw);
bool slot_layer_is_visible(slot_layer_t * raw);
slot_layer_t_array_t * slot_layer_get_children(slot_layer_t * raw);
slot_layer_t_array_t * slot_layer_get_recursive_children(slot_layer_t * raw);
slot_layer_t_array_t * slot_layer_get_masks(slot_layer_t * raw,bool include_group_masks);
bool slot_layer_has_masks(slot_layer_t * raw,bool include_group_masks);
f32 slot_layer_get_opacity(slot_layer_t * raw);
i32 slot_layer_get_object_mask(slot_layer_t * raw);
bool slot_layer_is_layer(slot_layer_t * raw);
bool slot_layer_is_group(slot_layer_t * raw);
slot_layer_t * slot_layer_get_containing_group(slot_layer_t * raw);
bool slot_layer_is_mask(slot_layer_t * raw);
bool slot_layer_is_group_mask(slot_layer_t * raw);
bool slot_layer_is_layer_mask(slot_layer_t * raw);
bool slot_layer_is_in_group(slot_layer_t * raw);
bool slot_layer_can_move(slot_layer_t * raw,i32 to);
void slot_layer_move(slot_layer_t * raw,i32 to);
slot_material_t * slot_material_create(material_data_t * m,ui_node_canvas_t * c);
void slot_material_unload(slot_material_t * raw);
void slot_material_delete(slot_material_t * raw);
string_t * strings_arm_file_expected();
string_t * strings_unknown_asset_format();
string_t * strings_could_not_locate_texture();
string_t * strings_failed_to_read_mesh_data();
string_t * strings_check_internet_connection();
string_t * strings_asset_already_imported();
string_t * strings_graphics_api();
void tab_browser_show_directory(string_t * directory);
void tab_browser_draw(ui_handle_t * htab);
void tab_browser_draw_116193(string_t * file);
void tab_browser_draw_116237(ui_t * ui);
void tab_browser_draw_116299();
void tab_browser_draw_116305();
void tab_browser_draw_116409();
void tab_browser_draw_116415();
void tab_browser_draw_116514();
void tab_browser_draw_116520();
void tab_browser_draw_116654(string_t * path);
void tab_browser_draw_116859(ui_t * ui);
void tab_brushes_draw(ui_handle_t * htab);
void tab_brushes_draw_117542(ui_t * ui);
void tab_brushes_draw_117590();
void tab_brushes_draw_117693();
void tab_brushes_delete_brush(slot_brush_t * b);
void tab_console_draw(ui_handle_t * htab);
void tab_console_draw_118121(string_t * path);
void tab_fonts_draw(ui_handle_t * htab);
void tab_fonts_draw_118950();
void tab_fonts_draw_119012(ui_t * ui);
void tab_fonts_draw_119082();
void tab_fonts_delete_font(slot_font_t * font);
void tab_fonts_delete_font_119285(slot_font_t * font);
void tab_history_draw(ui_handle_t * htab);
void tab_layers_draw(ui_handle_t * htab);
void tab_layers_draw_mini(ui_handle_t * htab);
void tab_layers_draw_full(ui_handle_t * htab);
void tab_layers_button_2d_view();
void tab_layers_draw_slots(bool mini);
void tab_layers_highlight_odd_lines();
void tab_layers_button_new(string_t * text);
void tab_layers_button_new_119993(ui_t * ui);
void tab_layers_button_new_120104(slot_layer_t * m);
void tab_layers_button_new_120179(slot_layer_t * m);
void tab_layers_button_new_120254(slot_layer_t * m);
void tab_layers_combo_filter();
void tab_layers_remap_layer_pointers(ui_node_t_array_t * nodes,i32_imap_t * pointer_map);
i32_map_t * tab_layers_init_layer_map();
i32_imap_t * tab_layers_fill_layer_map(i32_map_t * map);
void tab_layers_set_drag_layer(slot_layer_t * layer,f32 off_x,f32 off_y);
void tab_layers_draw_layer_slot(slot_layer_t * l,i32 i,bool mini);
void tab_layers_draw_layer_slot_mini(slot_layer_t * l,i32 i);
void tab_layers_draw_layer_slot_full(slot_layer_t * l,i32 i);
void tab_layers_draw_layer_slot_full_122290();
ui_handle_t * tab_layers_combo_object(ui_t * ui,slot_layer_t * l,bool label);
void tab_layers_combo_object_122731(slot_layer_t * l);
ui_handle_t * tab_layers_combo_blending(ui_t * ui,slot_layer_t * l,bool label);
void tab_layers_layer_toggle_visible(slot_layer_t * l);
void tab_layers_draw_layer_highlight(slot_layer_t * l,bool mini);
void tab_layers_handle_layer_icon_state(slot_layer_t * l,i32 i,ui_state_t state,f32 uix,f32 uiy);
ui_state_t tab_layers_draw_layer_icon(slot_layer_t * l,i32 i,f32 uix,f32 uiy,bool mini);
bool tab_layers_can_merge_down(slot_layer_t * l);
void tab_layers_draw_layer_context_menu(slot_layer_t * l,bool mini);
void tab_layers_draw_layer_context_menu_123965(ui_t * ui);
void tab_layers_draw_layer_context_menu_124113(string_t * path);
void tab_layers_draw_layer_context_menu_124264();
void tab_layers_draw_layer_context_menu_124311();
void tab_layers_draw_layer_context_menu_124367();
void tab_layers_draw_layer_context_menu_124406();
void tab_layers_draw_layer_context_menu_124520();
void tab_layers_draw_layer_context_menu_124567();
void tab_layers_draw_layer_context_menu_124626();
void tab_layers_draw_layer_context_menu_124666();
void tab_layers_draw_layer_context_menu_124722();
void tab_layers_draw_layer_context_menu_125069();
void tab_layers_draw_layer_context_menu_125150();
void tab_layers_draw_layer_context_menu_125246();
void tab_layers_make_mask_preview_rgba32(slot_layer_t * l);
void tab_layers_make_mask_preview_rgba32_125694();
void tab_layers_delete_layer(slot_layer_t * l);
bool tab_layers_can_delete(slot_layer_t * l);
bool tab_layers_can_drop_new_layer(i32 position);
void tab_materials_draw(ui_handle_t * htab);
void tab_materials_draw_mini(ui_handle_t * htab);
void tab_materials_draw_full(ui_handle_t * htab);
void tab_materials_button_nodes();
void tab_materials_draw_slots(bool mini);
void tab_materials_draw_slots_127305(ui_t * ui);
void tab_materials_draw_slots_127405();
void tab_materials_button_new(string_t * text);
void tab_materials_button_new_128117();
void tab_materials_update_material();
void tab_materials_update_material_pointers(ui_node_t_array_t * nodes,i32 i);
void tab_materials_accept_swatch_drag(swatch_color_t * swatch);
void tab_materials_delete_material(slot_material_t * m);
void tab_meshes_draw(ui_handle_t * htab);
void tab_meshes_draw_128723(ui_t * ui);
void tab_meshes_draw_128819(ui_t * ui);
void tab_meshes_draw_128934(ui_t * ui);
void tab_meshes_draw_129080(ui_t * ui);
void tab_meshes_set_default_mesh(string_t * name);
void tab_particles_draw(ui_handle_t * htab);
void tab_plugins_draw(ui_handle_t * htab);
void plugin_uv_unwrap_button();
void tab_script_draw(ui_handle_t * htab);
void tab_script_draw_130085(string_t * path);
void tab_script_draw_130137(string_t * path);
ui_text_coloring_t * tab_script_get_text_coloring();
void tab_swatches_empty_set(gpu_texture_t * image);
gpu_texture_t * tab_swatches_empty_get();
void tab_swatches_draw(ui_handle_t * htab);
void tab_swatches_draw_130621(ui_t * ui);
void tab_swatches_draw_131168(ui_t * ui);
void tab_swatches_draw_131214();
void tab_swatches_draw_131229(swatch_color_t * color);
void tab_swatches_draw_131458(ui_t * ui);
void tab_swatches_accept_swatch_drag(swatch_color_t * swatch);
void tab_swatches_delete_swatch(swatch_color_t * swatch);
void tab_textures_draw(ui_handle_t * htab);
void tab_textures_draw_132107(string_t * path);
void tab_textures_draw_132798(ui_t * ui);
void tab_textures_draw_132824(string_t * path);
void tab_textures_draw_132837();
void tab_textures_draw_132900(gpu_texture_t * target);
void tab_textures_draw_133019();
void tab_textures_draw_133045();
i32 tab_textures_to_pow2(i32 i);
void tab_textures_update_texture_pointers(ui_node_t_array_t * nodes,i32 i);
void tab_textures_delete_texture(asset_t * asset);
void tab_textures_delete_texture_133656();
string_t * _tr(string_t * s);
string_t * tr(string_t * id,any_map_t * vars);
void translator_load_translations(string_t * new_locale);
void translator_load_translations_134357();
void translator_init_font(bool cjk,string_t * font_path,f32 font_scale);
void translator_init_font_134468();
void translator_extended_glyphs();
string_t_array_t * translator_get_supported_locales();
ui_handle_t_array_t * ui_base_init_hwnds();
ui_handle_t_array_t * ui_base_init_htabs();
tab_draw_t * _draw_callback_create(void(*f)(ui_handle_t *));
tab_draw_array_t_array_t * ui_base_init_hwnd_tabs();
void ui_base_init();
void ui_base_update();
void ui_base_update_135942();
void ui_base_update_137635(ui_t * ui);
void ui_base_update_138648(mesh_object_t * mo);
void ui_base_view_top();
void ui_base_operator_search();
void ui_base_operator_search_138831(ui_t * ui);
void ui_base_toggle_distract_free();
f32 ui_base_get_radius_increment();
bool ui_base_hit_rect(f32 mx,f32 my,i32 x,i32 y,i32 w,i32 h);
rect_t * ui_base_get_brush_stencil_rect();
void ui_base_update_ui();
void ui_base_update_ui_140380();
void ui_base_render();
void ui_base_draw_sidebar();
void ui_base_render_cursor();
void ui_base_show_material_nodes();
void ui_base_show_brush_nodes();
void ui_base_show_2d_view(view_2d_type_t type);
void ui_base_toggle_browser();
void ui_base_set_icon_scale();
void ui_base_on_border_hover(ui_handle_t * handle,i32 side);
void ui_base_on_text_hover();
void ui_base_on_deselect_text();
void ui_base_on_tab_drop(ui_handle_t * to,i32 to_position,ui_handle_t * from,i32 from_position);
void ui_base_tag_ui_redraw();
void ui_base_make_empty_envmap(i32 col);
void ui_base_set_viewport_col(i32 col);
void ui_box_init();
void ui_box_render();
void ui_box_show_message(string_t * title,string_t * text,bool copyable);
void ui_box_show_custom(void(*commands)(ui_t *),i32 mw,i32 mh,void(*on_hide)(void),bool draggable);
void ui_box_hide();
void ui_box_hide_internal();
void ui_box_tween_in();
void ui_box_tween_out();
void ui_box_tween_tick();
void ui_box_window_border(ui_t * ui);
void ui_files_show(string_t * filters,bool is_save,bool open_multiple,void(*files_done)(string_t *));
void ui_files_release_keys();
draw_cloud_icon_data_t * make_draw_cloud_icon_data(string_t * f,gpu_texture_t * image);
string_t * ui_files_file_browser(ui_t * ui,ui_handle_t * handle,bool drag_files,string_t * search,bool refresh,void(*context_menu)(string_t *));
void ui_files_file_browser_145055();
void ui_files_file_browser_145717(string_t * abs);
void ui_files_file_browser_145799(draw_cloud_icon_data_t * data);
void ui_files_make_icon(ui_files_make_icon_t * args);
void ui_files_go_up(ui_handle_t * handle);
void ui_header_init();
void ui_header_render_ui();
void ui_menu_render();
void ui_menu_render_147841(string_t * path);
void ui_menu_render_150094(string_t * url,buffer_t * buffer);
void ui_menu_render_150537(ui_t * ui);
void ui_menu_hide();
void ui_menu_draw(void(*commands)(ui_t *),i32 x,i32 y);
void ui_menu_fit_to_screen();
void ui_menu_separator(ui_t * ui);
bool ui_menu_button(string_t * text,string_t * label);
void ui_menu_align(ui_t * ui);
void ui_menu_start(ui_t * ui);
void ui_menu_end(ui_t * ui);
void ui_menubar_init();
void ui_menubar_render_ui();
void ui_menubar_render_ui_151356();
void ui_menubar_draw_tab_header();
void ui_menubar_show_menu(ui_t * ui,i32 category);
bool ui_menubar_icon_button(ui_t * ui,i32 i,i32 j);
void ui_viewnodes_init();
void ui_viewnodes_on_link_drag(i32 link_drag_id,bool is_new_link);
void ui_viewnodes_on_link_drag_152739();
void ui_viewnodes_on_socket_released(i32 socket_id);
void ui_viewnodes_on_socket_released_153038();
void ui_viewnodes_on_socket_released_153044(ui_t * ui);
void ui_viewnodes_on_socket_released_153164();
void ui_viewnodes_on_socket_released_153174(ui_t * ui);
void ui_viewnodes_on_canvas_released();
void ui_viewnodes_on_canvas_released_153904(ui_t * ui_menu);
void ui_viewnodes_on_canvas_released_153967();
void ui_viewnodes_on_canvas_released_154006();
void ui_viewnodes_on_canvas_released_154043();
void ui_viewnodes_on_canvas_released_154083();
void ui_viewnodes_on_canvas_released_154116();
ui_canvas_control_t * ui_viewnodes_on_canvas_control();
ui_canvas_control_t * ui_nodes_get_canvas_control(ui_t * ui,bool controls_down);
f32 ui_nodes_get_zoom_delta(ui_t * ui);
bool ui_nodes_is_tab_selected();
i32 ui_nodes_tab_index();
ui_node_canvas_t * ui_nodes_get_canvas(bool groups);
ui_node_canvas_t * ui_nodes_get_canvas_material();
ui_nodes_t * ui_nodes_get_nodes();
void ui_nodes_update();
void ui_nodes_canvas_changed();
void ui_nodes_node_search(i32 x,i32 y,void(*done)(void));
void ui_nodes_node_search_155517(ui_t * ui);
i32 ui_nodes_get_node_x();
i32 ui_nodes_get_node_y();
gpu_texture_t * ui_nodes_draw_grid(f32 zoom);
void ui_nodes_render();
void ui_nodes_render_157114(swatch_color_t * color);
void ui_nodes_render_158303();
bool ui_nodes_contains_node_group_recursive(node_group_t * group,string_t * group_name);
bool ui_nodes_can_place_group(string_t * group_name);
void ui_nodes_push_undo(ui_node_canvas_t * last_canvas);
void ui_nodes_accept_asset_drag(i32 index);
void ui_nodes_accept_layer_drag(i32 index);
void ui_nodes_accept_material_drag(i32 index);
void ui_nodes_accept_swatch_drag(swatch_color_t * swatch);
ui_node_t * ui_nodes_make_node(ui_node_t * n,ui_nodes_t * nodes,ui_node_canvas_t * canvas);
ui_node_t * ui_nodes_make_group_node(ui_node_canvas_t * group_canvas,ui_nodes_t * nodes,ui_node_canvas_t * canvas);
void ui_nodes_make_node_preview();
bool ui_nodes_has_group(ui_node_canvas_t * c);
void ui_nodes_traverse_group(ui_node_canvas_t_array_t * mgroups,ui_node_canvas_t * c);
ui_node_canvas_t * ui_nodes_get_group(ui_node_canvas_t_array_t * canvases,string_t * name);
void ui_status_init();
i32 ui_status_width();
void ui_status_render_ui();
void ui_status_draw_version_tab(ui_handle_t * htab);
void ui_toolbar_init();
void ui_toolbar_draw_tool(i32 i,ui_t * ui,gpu_texture_t * img,i32 icon_accent,string_t_array_t * keys);
void ui_toolbar_draw_tool_161114();
i32 ui_toolbar_w(bool screen_size_request);
i32 ui_toolbar_x();
void ui_toolbar_render_ui();
void ui_toolbar_tool_properties_menu();
void ui_toolbar_tool_properties_menu_162206(ui_t * ui);
void ui_toolbar_draw_highlight();
void ui_view2d_init();
void ui_view2d_render();
void ui_view2d_render_163534();
void ui_view2d_update();
void uniforms_ext_init();
i32 uniforms_ext_i32_link(object_t * object,material_data_t * mat,string_t * link);
f32 uniforms_ext_f32_link(object_t * object,material_data_t * mat,string_t * link);
vec2_t uniforms_ext_vec2_link(object_t * object,material_data_t * mat,string_t * link);
vec4_t uniforms_ext_vec3_link(object_t * object,material_data_t * mat,string_t * link);
f32 vec2d(f32 x);
vec4_t uniforms_ext_vec4_link(object_t * object,material_data_t * mat,string_t * link);
mat4_t uniforms_ext_mat4_link(object_t * object,material_data_t * mat,string_t * link);
gpu_texture_t * uniforms_ext_tex_link(object_t * object,material_data_t * mat,string_t * link);
f32_array_t * util_clone_f32_array(f32_array_t * f32a);
u32_array_t * util_clone_u32_array(u32_array_t * u32a);
u8_array_t * util_clone_u8_array(u8_array_t * u8a);
string_t_array_t * util_clone_string_array(string_t_array_t * a);
u8_array_t * util_clone_bool_array(u8_array_t * a);
ui_node_socket_t_array_t * util_clone_canvas_sockets(ui_node_socket_t_array_t * sockets);
ui_node_button_t_array_t * util_clone_canvas_buttons(ui_node_button_t_array_t * buttons);
ui_node_t * util_clone_canvas_node(ui_node_t * n);
ui_node_t_array_t * util_clone_canvas_nodes(ui_node_t_array_t * nodes);
ui_node_link_t_array_t * util_clone_canvas_links(ui_node_link_t_array_t * links);
ui_node_canvas_t * util_clone_canvas(ui_node_canvas_t * c);
vertex_element_t_array_t * util_clone_vertex_elements(vertex_element_t_array_t * elems);
shader_const_t_array_t * util_clone_shader_consts(shader_const_t_array_t * consts);
tex_unit_t_array_t * util_clone_tex_units(tex_unit_t_array_t * units);
shader_context_t_array_t * util_clone_shader_contexts(shader_context_t_array_t * contexts);
shader_data_t * util_clone_shader_data(shader_data_t * s);
bind_const_t_array_t * util_clone_bind_constants(bind_const_t_array_t * consts);
bind_tex_t_array_t * util_clone_bind_textures(bind_tex_t_array_t * texs);
material_context_t_array_t * util_clone_material_contexts(material_context_t_array_t * contexts);
material_data_t * util_clone_material_data(material_data_t * m);
track_t_array_t * util_clone_tracks(track_t_array_t * tracks);
anim_t * util_clone_anim(anim_t * a);
obj_t * util_clone_obj(obj_t * o);
swatch_color_t * util_clone_swatch_color(swatch_color_t * s);
buffer_t * util_encode_scene(scene_t * raw);
void util_encode_node_canvas(ui_node_canvas_t * c);
i32 util_encode_mesh_data_size(mesh_data_t_array_t * datas);
i32 util_encode_layer_data_size(layer_data_t_array_t * datas);
void util_encode_mesh_datas(mesh_data_t_array_t * datas);
buffer_t * util_encode_project(project_format_t * raw);
void util_mesh_merge(mesh_object_t_array_t * paint_objects);
void util_mesh_remove_merged();
void util_mesh_swap_axis(i32 a,i32 b);
void util_mesh_flip_normals();
void util_mesh_calc_normals(bool smooth);
void util_mesh_to_origin();
void util_mesh_apply_displacement(gpu_texture_t * texpaint_pack,f32 strength,f32 uv_scale);
void util_mesh_equirect_unwrap(raw_mesh_t * mesh);
bool util_mesh_pnpoly(f32 v0x,f32 v0y,f32 v1x,f32 v1y,f32 v2x,f32 v2y,f32 px,f32 py);
vec4_t util_mesh_calc_normal(vec4_t p0,vec4_t p1,vec4_t p2);
void util_mesh_decimate();
void util_particle_init();
void util_particle_init_physics();
void util_particle_init_mesh();
void util_render_make_material_preview();
void util_render_make_decal_preview();
void util_render_make_text_preview();
void util_render_make_font_preview();
void util_render_make_brush_preview();
void util_render_make_brush_preview_178016();
void util_render_make_node_preview(ui_node_canvas_t * canvas,ui_node_t * node,gpu_texture_t * image,ui_node_canvas_t * group,ui_node_t_array_t * parents);
void util_render_pick_pos_nor_tex();
mat4_t util_render_get_decal_mat();
void util_render_create_screen_aligned_full_data();
void util_uv_cache_uv_map();
void util_uv_cache_triangle_map();
void util_uv_cache_dilate_map();
void _util_uv_check(i32 cx,i32 cy,i32 w,i32 h,i32 r,buffer_t * view,i32_array_t * coords_x,i32_array_t * coords_y);
void util_uv_cache_uv_island_map();
void viewport_scale_to_bounds();
void viewport_reset();
void viewport_set_view(f32 x,f32 y,f32 z,f32 rx,f32 ry,f32 rz);
void viewport_orbit(f32 x,f32 y);
void viewport_orbit_opposite();
void viewport_zoom(f32 f);
void viewport_update_camera_type(i32 camera_type);
camera_data_t * camera_data_parse(string_t * name,string_t * id);
camera_data_t * camera_data_get_raw_by_name(camera_data_t_array_t * datas,string_t * name);
camera_object_t * camera_object_create(camera_data_t * data);
void camera_object_build_proj(camera_object_t * raw,f32 screen_aspect);
void camera_object_remove(camera_object_t * raw);
void camera_object_render_frame(camera_object_t * raw);
void camera_object_proj_jitter(camera_object_t * raw);
void camera_object_build_mat(camera_object_t * raw);
vec4_t camera_object_right(camera_object_t * raw);
vec4_t camera_object_up(camera_object_t * raw);
vec4_t camera_object_look(camera_object_t * raw);
vec4_t camera_object_right_world(camera_object_t * raw);
vec4_t camera_object_up_world(camera_object_t * raw);
vec4_t camera_object_look_world(camera_object_t * raw);
void camera_object_build_view_frustum(mat4_t vp,frustum_plane_t_array_t * frustum_planes);
bool camera_object_sphere_in_frustum(frustum_plane_t_array_t * frustum_planes,transform_t * t,f32 radius_scale,f32 offset_x,f32 offset_y,f32 offset_z);
frustum_plane_t * frustum_plane_create();
void frustum_plane_normalize(frustum_plane_t * raw);
f32 frustum_plane_dist_to_sphere(frustum_plane_t * raw,vec4_t sphere_center,f32 sphere_radius);
void frustum_plane_set_components(frustum_plane_t * raw,f32 x,f32 y,f32 z,f32 w);
void const_data_create_screen_aligned_data();
void const_data_create_skydome_data();
mesh_data_t * data_get_mesh(string_t * file,string_t * name);
camera_data_t * data_get_camera(string_t * file,string_t * name);
material_data_t * data_get_material(string_t * file,string_t * name);
world_data_t * data_get_world(string_t * file,string_t * name);
shader_data_t * data_get_shader(string_t * file,string_t * name);
scene_t * data_get_scene_raw(string_t * file);
buffer_t * data_get_blob(string_t * file);
gpu_texture_t * data_get_image(string_t * file);
video_t * data_get_video(string_t * file);
draw_font_t * data_get_font(string_t * file);
void data_delete_mesh(string_t * handle);
void data_delete_blob(string_t * handle);
void data_delete_image(string_t * handle);
void data_delete_video(string_t * handle);
void data_delete_font(string_t * handle);
void data_delete_all();
string_t * data_sep();
string_t * data_path();
bool data_is_abs(string_t * file);
bool data_is_up(string_t * file);
string_t * data_base_name(string_t * path);
string_t * data_resolve_path(string_t * file);
void input_reset();
void input_end_frame();
void _input_on_foreground();
void input_register();
void mouse_end_frame();
void mouse_reset();
i32 mouse_button_index(string_t * button);
bool mouse_down(string_t * button);
bool mouse_down_any();
bool mouse_started(string_t * button);
bool mouse_started_any();
bool mouse_released(string_t * button);
void mouse_lock();
void mouse_unlock();
void mouse_hide();
void mouse_show();
void mouse_down_listener(i32 index,i32 x,i32 y);
void mouse_up_listener(i32 index,i32 x,i32 y);
void mouse_move_listener(i32 x,i32 y,i32 movement_x,i32 movement_y);
void mouse_wheel_listener(i32 delta);
f32 mouse_view_x();
f32 mouse_view_y();
void pen_end_frame();
void pen_reset();
i32 pen_button_index(string_t * button);
bool pen_down(string_t * button);
bool pen_started(string_t * button);
bool pen_released(string_t * button);
void pen_down_listener(i32 x,i32 y,f32 pressure);
void pen_up_listener(i32 x,i32 y,f32 pressure);
void pen_move_listener(i32 x,i32 y,f32 pressure);
f32 pen_view_x();
f32 pen_view_y();
void keyboard_end_frame();
void keyboard_reset();
bool keyboard_down(string_t * key);
bool keyboard_started(string_t * key);
bool keyboard_started_any();
bool keyboard_released(string_t * key);
bool keyboard_repeat(string_t * key);
string_t * keyboard_key_code(key_code_t key);
void keyboard_down_listener(key_code_t code);
void keyboard_up_listener(key_code_t code);
void keyboard_press_listener(string_t * c);
void gamepad_end_frame();
gamepad_stick_t * gamepad_stick_create();
gamepad_t * gamepad_create();
void gamepad_reset();
string_t * gamepad_key_code(i32 button);
i32 gamepad_button_index(string_t * button);
f32 gamepad_down(i32 i,string_t * button);
bool gamepad_started(i32 i,string_t * button);
bool gamepad_released(i32 i,string_t * button);
void gamepad_axis_listener(i32 i,i32 axis,f32 value);
void gamepad_button_listener(i32 i,i32 button,f32 value);
gpu_vertex_structure_t * gpu_vertex_struct_create();
void gpu_vertex_struct_add(gpu_vertex_structure_t * raw,string_t * name,vertex_data_t data);
f32 ui_SCALE(ui_t * ui);
f32 ui_ELEMENT_OFFSET(ui_t * ui);
f32 ui_ELEMENT_W(ui_t * ui);
f32 ui_ELEMENT_H(ui_t * ui);
f32 ui_MENUBAR_H(ui_t * ui);
f32 ui_nodes_INPUT_Y(ui_node_canvas_t * canvas,ui_node_socket_t_array_t * sockets,i32 pos);
ui_state_t _ui_image(gpu_texture_t * image,i32 tint,f32 h,i32 sx,i32 sy,i32 sw,i32 sh);
bool ui_window(ui_handle_t * handle,i32 x,i32 y,i32 w,i32 h,bool drag);
void ui_end(bool last);
void _ui_set_scale(ui_t * ui,f32 factor);
void _ui_end_element(f32 element_size);
void _ui_end_input(ui_t * ui);
ui_handle_t * ui_handle(string_t * s);
ui_t * ui_create(ui_options_t * ops);
ui_theme_t * ui_theme_create();
void nodes_on_custom_button(i32 node_id,string_t * button_name);
ui_nodes_t * ui_nodes_create();
ui_node_socket_t * ui_get_socket(ui_node_t_array_t * nodes,i32 id);
void ui_set_font(ui_t * raw,draw_font_t * font);
u32 lz4_encode_bound(u32 size);
buffer_t * lz4_encode(buffer_t * b);
buffer_t * lz4_decode(buffer_t * b,u32 olen);
material_data_t * material_data_create(material_data_t * raw,string_t * file);
material_data_t * material_data_parse(string_t * file,string_t * name);
material_data_t * material_data_get_raw_by_name(material_data_t_array_t * datas,string_t * name);
material_context_t * material_data_get_context(material_data_t * raw,string_t * name);
material_context_t * material_context_create(material_context_t * raw);
mesh_data_t * mesh_data_parse(string_t * name,string_t * id);
mesh_data_t * mesh_data_get_raw_by_name(mesh_data_t_array_t * datas,string_t * name);
mesh_data_t * mesh_data_create(mesh_data_t * raw);
gpu_vertex_structure_t * mesh_data_get_vertex_struct(vertex_array_t_array_t * vertex_arrays);
vertex_data_t mesh_data_get_vertex_data(string_t * data);
void mesh_data_build_vertices(buffer_t * vertices,vertex_array_t_array_t * vertex_arrays,i32 offset,bool fake_uvs,i32 uvs_index);
i32 mesh_data_get_vertex_size(string_t * vertex_data);
vertex_array_t * mesh_data_get_vertex_array(mesh_data_t * raw,string_t * name);
gpu_buffer_t * mesh_data_get(mesh_data_t * raw,vertex_element_t_array_t * vs);
void mesh_data_build(mesh_data_t * raw);
vec4_t mesh_data_calculate_aabb(mesh_data_t * raw);
void mesh_data_delete(mesh_data_t * raw);
mesh_object_t * mesh_object_create(mesh_data_t * data,material_data_t_array_t * materials);
void mesh_object_set_data(mesh_object_t * raw,mesh_data_t * data);
void mesh_object_remove(mesh_object_t * raw);
void mesh_object_setup_animation(mesh_object_t * raw,scene_t_array_t * oactions);
bool mesh_object_set_culled(mesh_object_t * raw,bool b);
bool mesh_object_cull_material(mesh_object_t * raw,string_t * context);
bool mesh_object_cull_mesh(mesh_object_t * raw,string_t * context,camera_object_t * camera);
void mesh_object_get_contexts(mesh_object_t * raw,string_t * context,material_data_t_array_t * materials,material_context_t_array_t * material_contexts,shader_context_t_array_t * shader_contexts);
void mesh_object_render(mesh_object_t * raw,string_t * context,string_t_array_t * bind_params);
bool mesh_object_valid_context(mesh_object_t * raw,material_data_t_array_t * mats,string_t * context);
void mesh_object_compute_camera_dist(mesh_object_t * raw,f32 cam_x,f32 cam_y,f32 cam_z);
void mesh_object_compute_screen_size(mesh_object_t * raw,camera_object_t * camera);
object_t * object_create(bool is_empty);
void object_set_parent(object_t * raw,object_t * parent_object,bool parent_inv,bool keep_transform);
void object_remove_super(object_t * raw);
void object_remove(object_t * raw);
object_t * object_get_child(object_t * raw,string_t * name);
object_t_array_t * object_get_children(object_t * raw,bool recursive);
ray_t * raycast_get_ray(f32 input_x,f32 input_y,camera_object_t * camera);
vec4_t raycast_box_intersect(transform_t * transform,f32 input_x,f32 input_y,camera_object_t * camera);
transform_t * raycast_closest_box_intersect(transform_t_array_t * transforms,f32 input_x,f32 input_y,camera_object_t * camera);
plane_t * plane_create();
vec4_t raycast_plane_intersect(vec4_t normal,vec4_t a,f32 input_x,f32 input_y,camera_object_t * camera);
ray_t * ray_create(vec4_t origin,vec4_t dir);
vec4_t ray_at(ray_t * raw,f32 t);
f32 ray_dist_to_point(ray_t * raw,vec4_t point);
bool ray_intersects_sphere(ray_t * raw,vec4_t sphere_center,f32 sphere_radius);
bool ray_intersects_plane(ray_t * raw,plane_t * plane);
f32 ray_dist_to_plane(ray_t * raw,plane_t * plane);
vec4_t ray_intersect_plane(ray_t * raw,plane_t * plane);
vec4_t ray_intersect_box(ray_t * raw,vec4_t center,vec4_t dim);
vec4_t ray_intersect_triangle(ray_t * raw,vec4_t a,vec4_t b,vec4_t c,bool cull_backface);
f32 plane_dist_to_point(plane_t * raw,vec4_t point);
plane_t * plane_set(plane_t * raw,vec4_t normal,vec4_t point);
bool render_path_ready();
void render_path_render_frame();
void render_path_set_target(string_t * target,string_t_array_t * additional,string_t * depth_buffer,i32 flags,i32 color,f32 depth);
void render_path_end();
i32 _render_path_sort_dist(any_ptr a,any_ptr b);
void render_path_sort_meshes_dist(mesh_object_t_array_t * meshes);
i32 _render_path_sort_shader(any_ptr a,any_ptr b);
void render_path_sort_meshes_shader(mesh_object_t_array_t * meshes);
void render_path_draw_meshes(string_t * context);
void render_path_submit_draw(string_t * context);
void render_path_draw_skydome(string_t * handle);
void render_path_bind_target(string_t * target,string_t * uniform);
void render_path_draw_shader(string_t * handle);
void render_path_load_shader(string_t * handle);
void render_path_unload_shader(string_t * handle);
void render_path_unload();
void render_path_resize();
render_target_t * render_path_create_render_target(render_target_t * t);
gpu_texture_t * render_path_create_image(render_target_t * t);
tex_format_t render_path_get_tex_format(string_t * s);
render_target_t * render_target_create();
void render_target_unload(render_target_t * raw);
object_t * scene_create(scene_t * format);
void scene_remove();
object_t * scene_set_active(string_t * scene_name);
void scene_update_frame();
void scene_render_frame();
object_t * scene_add_object(object_t * parent);
object_t * scene_get_child(string_t * name);
mesh_object_t * scene_get_mesh(string_t * name);
camera_object_t * scene_get_camera(string_t * name);
object_t * scene_get_empty(string_t * name);
mesh_object_t * scene_add_mesh_object(mesh_data_t * data,material_data_t_array_t * materials,object_t * parent);
camera_object_t * scene_add_camera_object(camera_data_t * data,object_t * parent);
void scene_traverse_objects(scene_t * format,object_t * parent,obj_t_array_t * objects,obj_t * parent_object);
object_t * scene_add_scene(string_t * scene_name,object_t * parent);
i32 scene_get_objects_count(obj_t_array_t * objects);
object_t * _scene_spawn_object_tree(obj_t * obj,object_t * parent,obj_t * parent_object,bool spawn_children);
object_t * scene_spawn_object(string_t * name,object_t * parent,bool spawn_children);
obj_t * scene_get_raw_object_by_name(scene_t * format,string_t * name);
obj_t * scene_traverse_objs(obj_t_array_t * children,string_t * name);
object_t * scene_create_object(obj_t * o,scene_t * format,object_t * parent,obj_t * parent_object);
object_t * scene_create_mesh_object(obj_t * o,scene_t * format,object_t * parent,obj_t * parent_object,material_data_t_array_t * materials);
object_t * scene_return_mesh_object(string_t * object_file,string_t * data_ref,string_t * scene_name,any armature,material_data_t_array_t * materials,object_t * parent,obj_t * parent_object,obj_t * o);
object_t * scene_return_object(object_t * object,obj_t * o);
object_t * scene_return_object_loaded(object_t * object,obj_t * o,scene_t_array_t * oactions);
void scene_gen_transform(obj_t * object,transform_t * transform);
void scene_load_embedded_data(string_t_array_t * datas);
void scene_embed_data(string_t * file);
shader_data_t * shader_data_create(shader_data_t * raw);
string_t * shader_data_ext();
shader_data_t * shader_data_parse(string_t * file,string_t * name);
shader_data_t * shader_data_get_raw_by_name(shader_data_t_array_t * datas,string_t * name);
void shader_data_delete(shader_data_t * raw);
shader_context_t * shader_data_get_context(shader_data_t * raw,string_t * name);
shader_context_t * shader_context_create(shader_context_t * raw);
shader_context_t * shader_context_compile(shader_context_t * raw);
i32 shader_context_type_size(string_t * t);
i32 shader_context_type_pad(i32 offset,i32 size);
shader_context_t * shader_context_finish_compile(shader_context_t * raw);
vertex_data_t shader_context_parse_data(string_t * data);
void shader_context_parse_vertex_struct(shader_context_t * raw);
void shader_context_delete(shader_context_t * raw);
compare_mode_t shader_context_get_compare_mode(string_t * s);
cull_mode_t shader_context_get_cull_mode(string_t * s);
blend_factor_t shader_context_get_blend_fac(string_t * s);
tex_format_t shader_context_get_tex_format(string_t * s);
void shader_context_add_const(shader_context_t * raw,shader_const_t * c,i32 offset);
void shader_context_add_tex(shader_context_t * raw,tex_unit_t * tu,i32 i);
void sys_start(iron_window_options_t * ops);
sys_callback_t * _sys_callback_create(void(*f)(void));
void sys_notify_on_frames(void(*listener)(void));
void sys_notify_on_app_state(void(*on_foreground)(void),void(*on_resume)(void),void(*on_pause)(void),void(*on_background)(void),void(*on_shutdown)(void));
void sys_notify_on_drop_files(void(*drop_files_listener)(string_t *));
void sys_foreground();
void sys_resume();
void sys_pause();
void sys_background();
void sys_shutdown();
void sys_drop_files(string_t * file_path);
f32 sys_time();
void sys_render_callback();
void sys_drop_files_callback(string_t * file_path);
void sys_foreground_callback();
void sys_resume_callback();
void sys_pause_callback();
void sys_background_callback();
void sys_shutdown_callback();
void sys_keyboard_down_callback(i32 code);
void sys_keyboard_up_callback(i32 code);
void sys_keyboard_press_callback(i32 char_code);
void sys_mouse_down_callback(i32 button,i32 x,i32 y);
void sys_mouse_up_callback(i32 button,i32 x,i32 y);
void sys_mouse_move_callback(i32 x,i32 y,i32 mx,i32 my);
void sys_mouse_wheel_callback(i32 delta);
void sys_touch_down_callback(i32 index,i32 x,i32 y);
void sys_touch_up_callback(i32 index,i32 x,i32 y);
void sys_touch_move_callback(i32 index,i32 x,i32 y);
void sys_pen_down_callback(i32 x,i32 y,f32 pressure);
void sys_pen_up_callback(i32 x,i32 y,f32 pressure);
void sys_pen_move_callback(i32 x,i32 y,f32 pressure);
void sys_gamepad_axis_callback(i32 gamepad,i32 axis,f32 value);
void sys_gamepad_button_callback(i32 gamepad,i32 button,f32 value);
string_t * sys_title();
void sys_title_set(string_t * value);
i32 sys_display_primary_id();
i32 sys_display_width();
i32 sys_display_height();
i32 sys_display_frequency();
string_t * sys_buffer_to_string(buffer_t * b);
buffer_t * sys_string_to_buffer(string_t * str);
string_t * sys_shader_ext();
gpu_shader_t * sys_get_shader(string_t * name);
void video_unload(video_t * self);
i32 sys_w();
i32 sys_h();
i32 sys_x();
i32 sys_y();
void sys_init();
void sys_reset();
void _sys_run_callbacks(callback_t_array_t * cbs);
void sys_update();
f32 sys_delta();
f32 sys_real_delta();
void sys_render();
void sys_render_2d();
callback_t * _callback_create(void(*f)(any),any data);
void sys_notify_on_init(void(*f)(any),any data);
void sys_notify_on_update(void(*f)(any),any data);
void sys_notify_on_render(void(*f)(any),any data);
void sys_notify_on_render_2d(void(*f)(any),any data);
void sys_notify_on_reset(void(*f)(any),any data);
void sys_notify_on_next_frame(void(*f)(any),any data);
void sys_notify_on_end_frame(void(*f)(any),any data);
void _sys_remove_callback(callback_t_array_t * ar,void(*f)(any));
void sys_remove_init(void(*f)(any));
void sys_remove_update(void(*f)(any));
void sys_remove_render(void(*f)(any));
void sys_remove_render_2d(void(*f)(any));
void sys_remove_reset(void(*f)(any));
void sys_remove_end_frame(void(*f)(any));
tilesheet_t * tilesheet_create(string_t * scene_name,string_t * tilesheet_ref,string_t * tilesheet_action_ref);
void tilesheet_play(tilesheet_t * self,string_t * action_ref,void(*on_action_complete)(void));
void tilesheet_pause(tilesheet_t * self);
void tilesheet_resume(tilesheet_t * self);
void tilesheet_set_frame_offset(tilesheet_t * self,i32 frame);
i32 tilesheet_get_frame_offset(tilesheet_t * self);
void tilesheet_update(tilesheet_t * self);
void tilesheet_set_frame(tilesheet_t * self,i32 f);
transform_t * transform_create(object_t * object);
void transform_reset(transform_t * raw);
void transform_update(transform_t * raw);
void transform_build_matrix(transform_t * raw);
void transform_translate(transform_t * raw,f32 x,f32 y,f32 z);
void transform_set_matrix(transform_t * raw,mat4_t mat);
void transform_mult_matrix(transform_t * raw,mat4_t mat);
void transform_decompose(transform_t * raw);
void transform_rotate(transform_t * raw,vec4_t axis,f32 f);
void transform_move(transform_t * raw,vec4_t axis,f32 f);
void transform_set_rot(transform_t * raw,f32 x,f32 y,f32 z);
void transform_compute_radius(transform_t * raw);
void transform_compute_dim(transform_t * raw);
void transform_apply_parent_inv(transform_t * raw);
void transform_apply_parent(transform_t * raw);
vec4_t transform_look(transform_t * raw);
vec4_t transform_right(transform_t * raw);
vec4_t transform_up(transform_t * raw);
f32 transform_world_x(transform_t * raw);
f32 transform_world_y(transform_t * raw);
f32 transform_world_z(transform_t * raw);
void tween_on_reset();
void _tween_register();
tween_anim_t * tween_to(tween_anim_t * anim);
tween_anim_t * tween_timer(f32 delay,void(*done)(any),any data);
void tween_stop(tween_anim_t * anim);
void tween_reset();
void tween_update();
f32 _tween_ease_linear(f32 k);
f32 _tween_ease_expo_in(f32 k);
f32 _tween_ease_expo_out(f32 k);
f32 _tween_ease(ease_t ease,f32 k);
void uniforms_set_context_consts(shader_context_t * context,string_t_array_t * bind_params);
void uniforms_set_obj_consts(shader_context_t * context,object_t * object);
void uniforms_bind_render_target(render_target_t * rt,shader_context_t * context,string_t * sampler_id);
bool uniforms_set_context_const(i32 location,shader_const_t * c);
void uniforms_set_obj_const(object_t * obj,i32 loc,shader_const_t * c);
void uniforms_set_material_consts(shader_context_t * context,material_context_t * material_context);
material_data_t * current_material(object_t * object);
void uniforms_set_material_const(i32 location,shader_const_t * shader_const,bind_const_t * material_const);
world_data_t * world_data_parse(string_t * name,string_t * id);
world_data_t * world_data_get_raw_by_name(world_data_t_array_t * datas,string_t * name);
f32_array_t * world_data_get_empty_irradiance();
f32_array_t * world_data_set_irradiance(world_data_t * raw);
void world_data_load_envmap(world_data_t * raw);
boolean_node_t * boolean_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * boolean_node_get(boolean_node_t * self,i32 from);
void boolean_node_set(boolean_node_t * self,f32_array_t * value);
brush_output_node_t * brush_output_node_create(ui_node_t * raw,f32_array_t * args);
color_node_t * color_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * color_node_get(color_node_t * self,i32 from);
gpu_texture_t * color_node_get_as_image(color_node_t * self,i32 from);
void color_node_set(color_node_t * self,f32_array_t * value);
float_node_t * float_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * float_node_get(float_node_t * self,i32 from);
gpu_texture_t * float_node_get_as_image(float_node_t * self,i32 from);
void float_node_set(float_node_t * self,f32_array_t * value);
integer_node_t * integer_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * integer_node_get(integer_node_t * self,i32 from);
void integer_node_set(integer_node_t * self,f32_array_t * value);
math_node_t * math_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * math_node_get(math_node_t * self,i32 from);
null_node_t * null_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * null_node_get(null_node_t * self,i32 from);
random_node_t * random_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * random_node_get(random_node_t * self,i32 from);
i32 random_node_get_int();
void random_node_set_seed(i32 seed);
i32 random_node_get_seed();
f32 random_node_get_float();
separate_vector_node_t * separate_vector_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * separate_vector_node_get(separate_vector_node_t * self,i32 from);
string_node_t * string_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * string_node_get(string_node_t * self,i32 from);
void string_node_set(string_node_t * self,any value);
time_node_t * time_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * time_node_get(time_node_t * self,i32 from);
vector_math_node_t * vector_math_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * vector_math_node_get(vector_math_node_t * self,i32 from);
vector_node_t * vector_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * vector_node_get(vector_node_t * self,i32 from);
gpu_texture_t * vector_node_get_as_image(vector_node_t * self,i32 from);
void vector_node_set(vector_node_t * self,f32_array_t * value);
void base_ext_init();
void base_ext_render();
void base_ext_init_config(config_t * raw);
void base_ext_update();
void context_ext_init(context_t * c);
void context_ext_select_paint_object(mesh_object_t * o);
slot_layer_t * layers_ext_flatten(bool height_to_normal,slot_layer_t_array_t * layers);
void layers_ext_on_resized();
void layers_ext_on_resized_226461();
void make_bake_run(node_shader_context_t * con,node_shader_t * kong);
void make_bake_position_normal(node_shader_t * kong);
void make_bake_set_color_writes(node_shader_context_t * con_paint);
string_t * make_bake_axis_string(i32 i);
void make_blur_run(node_shader_t * kong);
void make_brush_run(node_shader_t * kong);
void make_clone_run(node_shader_t * kong);
void make_colorid_picker_run(node_shader_t * kong);
void make_discard_color_id(node_shader_t * kong);
void make_discard_face(node_shader_t * kong);
void make_discard_uv_island(node_shader_t * kong);
void make_discard_material_id(node_shader_t * kong);
bool make_material_get_mout();
void make_material_parse_mesh_material();
void make_material_parse_mesh_preview_material(material_data_t * md);
void make_material_parse_paint_material(bool bake_previews);
void make_material_bake_node_previews();
void make_material_traverse_nodes(ui_node_t_array_t * nodes,ui_node_canvas_t * group,ui_node_t_array_t * parents);
void make_material_bake_node_preview(ui_node_t * node,ui_node_canvas_t * group,ui_node_t_array_t * parents);
parse_node_preview_result_t * make_material_parse_node_preview_material(ui_node_t * node,ui_node_canvas_t * group,ui_node_t_array_t * parents);
void make_material_parse_brush();
string_t * make_material_blend_mode(node_shader_t * kong,i32 blending,string_t * cola,string_t * colb,string_t * opac);
string_t * make_material_blend_mode_mask(i32 blending,string_t * cola,string_t * colb,string_t * opac);
f32 make_material_get_displace_strength();
void make_material_delete_context(shader_context_t * c);
void make_material_delete_context_232067(shader_context_t * c);
node_shader_context_t * make_mesh_run(material_t * data,i32 layer_pass);
node_shader_context_t * make_mesh_preview_run(material_t * data,material_context_t * matcon);
node_shader_context_t * make_node_preview_run(material_t * data,material_context_t * matcon,ui_node_t * node,ui_node_canvas_t * group,ui_node_t_array_t * parents);
bool make_paint_is_raytraced_bake();
string_t_array_t * make_paint_color_attachments();
node_shader_context_t * make_paint_run(material_t * data,material_context_t * matcon);
void make_particle_mask(node_shader_t * kong);
void make_texcoord_run(node_shader_t * kong);
void nodes_brush_init();
void nodes_brush_list_init();
ui_node_t * nodes_brush_create_node(string_t * node_type);
void render_path_paint_init();
void render_path_paint_draw_fullscreen_triangle(string_t * context);
void render_path_paint_commands_paint(bool dilation);
void render_path_paint_use_live_layer(bool use);
void render_path_paint_commands_live_brush();
void render_path_paint_commands_cursor();
void render_path_paint_draw_cursor(f32 mx,f32 my,f32 radius,f32 tint_r,f32 tint_g,f32 tint_b);
void render_path_paint_commands_symmetry();
bool render_path_paint_paint_enabled();
void render_path_paint_live_brush_dirty();
void render_path_paint_begin();
void render_path_paint_end();
void _render_path_paint_final();
void _render_path_paint_deriv();
bool render_path_paint_is_rt_bake();
void render_path_paint_update_bake_layer(texture_bits_t bits);
void render_path_paint_draw();
void render_path_paint_set_plane_mesh();
void render_path_paint_restore_plane_mesh();
void render_path_paint_bind_layers();
void render_path_paint_unbind_layers();
void render_path_paint_dilate(bool base,bool nor_pack);
tab_draw_array_t_array_t * ui_base_ext_init_hwnd_tabs();
void ui_header_draw_tool_properties(ui_t * ui);
void ui_header_draw_tool_properties_246099(string_t * path);
void ui_header_draw_tool_properties_246236(slot_layer_t * m);
void ui_header_draw_tool_properties_246684(ui_t * ui);
void ui_header_draw_tool_properties_247075();
void ui_toolbar_ext_draw_tools(ui_t * ui,gpu_texture_t * img,i32 icon_accent,string_t_array_t * keys);
void brush_output_node_create_ext(brush_output_node_t * n);
void brush_output_node_parse_inputs(brush_output_node_t * self);
void brush_output_node_run(brush_output_node_t * self,i32 from);
void brush_output_paint(brush_output_node_t * self);
input_node_t * input_node_create(ui_node_t * raw,f32_array_t * args);
void input_node_update(float_node_t * self);
logic_node_value_t * input_node_get(input_node_t * self,i32 from);
tex_image_node_t * tex_image_node_create(ui_node_t * raw,f32_array_t * args);
logic_node_value_t * tex_image_node_get(tex_image_node_t * self,i32 from);
void _main();

bool args_use;
string_t * args_asset_path;
bool args_background;
bool args_export_textures;
string_t * args_export_textures_type;
string_t * args_export_textures_preset;
string_t * args_export_textures_path;
bool args_reimport_mesh;
bool args_export_mesh;
string_t * args_export_mesh_path;
bool args_export_material;
string_t * args_export_material_path;
bool base_ui_enabled;
bool base_is_dragging;
bool base_is_resizing;
asset_t * base_drag_asset;
swatch_color_t * base_drag_swatch;
string_t * base_drag_file;
gpu_texture_t * base_drag_file_icon;
i32 base_drag_tint;
i32 base_drag_size;
rect_t * base_drag_rect;
f32 base_drag_off_x;
f32 base_drag_off_y;
f32 base_drag_start;
f32 base_drop_x;
f32 base_drop_y;
draw_font_t * base_font;
ui_theme_t * base_theme;
gpu_texture_t * base_color_wheel;
gpu_texture_t * base_color_wheel_gradient;
ui_t * base_ui_box;
ui_t * base_ui_menu;
i32 base_default_element_w;
i32 base_default_element_h;
i32 base_default_font_size;
ui_handle_t * base_res_handle;
ui_handle_t * base_bits_handle;
string_t_array_t * base_drop_paths;
i32 base_appx;
i32 base_appy;
i32 base_last_window_width;
i32 base_last_window_height;
slot_material_t * base_drag_material;
slot_layer_t * base_drag_layer;
f32 base_default_fov;
i32 _base_material_count;
ui_handle_t * box_export_htab;
string_t_array_t * box_export_files;
ui_handle_t * box_export_mesh_handle;
ui_handle_t * box_export_hpreset;
export_preset_t * box_export_preset;
string_t_array_t * box_export_channels;
string_t_array_t * box_export_color_spaces;
bool _box_export_bake_material;
export_preset_texture_t * _box_export_t;
bool _box_export_apply_displacement;
bool _box_export_merge_vertices;
ui_handle_t * box_preferences_htab;
string_t_array_t * box_preferences_files_plugin;
string_t_array_t * box_preferences_files_keymap;
ui_handle_t * box_preferences_theme_handle;
ui_handle_t * box_preferences_preset_handle;
string_t_array_t * box_preferences_locales;
string_t_array_t * box_preferences_themes;
string_t * _box_preferences_f;
ui_handle_t * _box_preferences_h;
i32 _box_preferences_i;
ui_t * _box_preferences_ui;
ui_handle_t * box_projects_htab;
ui_handle_t * box_projects_hsearch;
any_map_t * box_projects_icon_map;
string_t * _box_projects_path;
string_t * _box_projects_icon_path;
i32 _box_projects_i;
vec4_box_t_array_t * camera_origins;
mat4_box_t_array_t * camera_views;
i32 camera_redraws;
vec4_t camera_dir;
f32 camera_ease;
bool camera_controls_down;
object_t * _compass_hitbox_x;
object_t * _compass_hitbox_y;
object_t * _compass_hitbox_z;
object_t * _compass_hovered;
object_t * _compass_hovered_last;
config_t * config_raw;
any_map_t * config_keymap;
bool config_loaded;
ui_align_t config_button_align;
string_t * config_default_button_spacing;
string_t * config_button_spacing;
string_t * console_message;
f32 console_message_timer;
i32 console_message_color;
string_t_array_t * console_last_traces;
string_t * console_progress_text;
context_t * context_raw;
f32 export_texture_gamma;
any_map_t * _file_download_map;
any_map_t * _file_download_bytes_map;
any_map_t * _file_cache_cloud_map;
string_t * file_cmd_mkdir;
string_t * file_cmd_copy;
any_map_t * file_cloud;
i32_map_t * file_cloud_sizes;
void(*_file_init_cloud_bytes_done)(void);
vec4_t gizmo_v;
vec4_t gizmo_v0;
quat_t gizmo_q;
quat_t gizmo_q0;
step_t_array_t * history_steps;
i32 history_undo_i;
i32 history_undos;
i32 history_redos;
bool history_push_undo;
slot_layer_t_array_t * history_undo_layers;
bool history_push_undo2;
scene_t * scene_raw_gc;
f32 _import_asset_drop_x;
f32 _import_asset_drop_y;
bool _import_asset_show_box;
bool _import_asset_hdr_as_envmap;
void(*_import_asset_done)(void);
string_t * _import_blend_material_path;
gpu_pipeline_t * import_envmap_pipeline;
i32 import_envmap_params_loc;
vec4_t import_envmap_params;
vec4_t import_envmap_n;
i32 import_envmap_radiance_loc;
gpu_texture_t * import_envmap_radiance;
gpu_texture_t_array_t * import_envmap_mips;
bool import_mesh_clear_layers;
any_array_t * import_mesh_meshes_to_unwrap;
gpu_texture_t * layers_temp_image;
gpu_texture_t * layers_expa;
gpu_texture_t * layers_expb;
gpu_texture_t * layers_expc;
f32 layers_default_base;
f32 layers_default_rough;
i32 layers_max_layers;
uv_type_t _layers_uv_type;
mat4_t _layers_decal_mat;
i32 _layers_position;
i32 _layers_base_color;
f32 _layers_occlusion;
f32 _layers_roughness;
f32 _layers_metallic;
i32 line_draw_color;
f32 line_draw_strength;
mat4_t line_draw_mat;
vec4_t line_draw_dim;
gpu_buffer_t * line_draw_vertex_buffer;
gpu_buffer_t * line_draw_index_buffer;
gpu_pipeline_t * line_draw_pipeline;
gpu_pipeline_t * line_draw_overlay_pipeline;
mat4_t line_draw_vp;
i32 line_draw_vp_loc;
i32 line_draw_color_loc;
buffer_t * line_draw_vb_data;
u32_array_t * line_draw_ib_data;
i32 line_draw_max_lines;
i32 line_draw_max_vertices;
i32 line_draw_max_indices;
i32 line_draw_lines;
vec4_t line_draw_wpos;
vec4_t line_draw_vx;
vec4_t line_draw_vy;
vec4_t line_draw_vz;
vec4_t line_draw_v1;
vec4_t line_draw_v2;
vec4_t line_draw_t;
vec4_t line_draw_mid_point;
vec4_t line_draw_mid_line;
vec4_t line_draw_corner1;
vec4_t line_draw_corner2;
vec4_t line_draw_corner3;
vec4_t line_draw_corner4;
vec4_t line_draw_camera_look;
gpu_buffer_t * _shape_draw_sphere_vb;
gpu_buffer_t * _shape_draw_sphere_ib;
string_t_array_t * nodes_material_categories;
ui_node_t_array_t * nodes_material_input;
ui_node_t_array_t * nodes_material_texture;
ui_node_t_array_t * nodes_material_color;
ui_node_t_array_t * nodes_material_vector;
ui_node_t_array_t * nodes_material_converter;
ui_node_t_array_t * nodes_material_group;
node_list_t_array_t * nodes_material_list;
ui_nodes_t * _nodes_material_nodes;
ui_node_t * _nodes_material_node;
ui_node_socket_t_array_t * _nodes_material_sockets;
any_map_t * operator_ops;
i32 _parser_exr_width;
i32 _parser_exr_stride;
u8_array_t * _parser_exr_out;
buffer_t * _parser_exr_src_view;
void(*_parser_exr_write_line)(i32);
any_map_t * parser_logic_custom_nodes;
ui_node_t_array_t * parser_logic_nodes;
ui_node_link_t_array_t * parser_logic_links;
string_t_array_t * parser_logic_parsed_nodes;
any_map_t * parser_logic_node_map;
node_shader_context_t * parser_material_con;
node_shader_t * parser_material_kong;
node_shader_t * parser_material_kong;
material_context_t * parser_material_matcon;
string_t_array_t * parser_material_parsed;
ui_node_t_array_t * parser_material_parents;
ui_node_canvas_t_array_t * parser_material_canvases;
ui_node_t_array_t * parser_material_nodes;
ui_node_link_t_array_t * parser_material_links;
bool parser_material_cotangent_frame_written;
string_t * parser_material_tex_coord;
f32 parser_material_eps;
any_map_t * parser_material_custom_nodes;
bool parser_material_parse_surface;
bool parser_material_parse_opacity;
bool parser_material_parse_height;
bool parser_material_parse_height_as_channel;
bool parser_material_parse_emission;
bool parser_material_parse_subsurface;
bool parser_material_parsing_basecolor;
bool parser_material_triplanar;
bool parser_material_sample_keep_aspect;
string_t * parser_material_sample_uv_scale;
bool parser_material_transform_color_space;
bool parser_material_blur_passthrough;
bool parser_material_warp_passthrough;
bool parser_material_bake_passthrough;
string_t * parser_material_bake_passthrough_strength;
string_t * parser_material_bake_passthrough_radius;
string_t * parser_material_bake_passthrough_offset;
ui_node_canvas_t * parser_material_start_group;
ui_node_t_array_t * parser_material_start_parents;
ui_node_t * parser_material_start_node;
bool parser_material_arm_export_tangents;
string_t * parser_material_out_normaltan;
any_map_t * parser_material_script_links;
any_map_t * parser_material_parsed_map;
any_map_t * parser_material_texture_map;
bool parser_material_is_frag;
string_t * path_sep;
string_t * path_pwd;
string_t_array_t * path_mesh_formats;
string_t_array_t * path_texture_formats;
any_map_t * path_mesh_importers;
any_map_t * path_texture_importers;
string_t_array_t * path_base_color_ext;
string_t_array_t * path_opacity_ext;
string_t_array_t * path_normal_map_ext;
string_t_array_t * path_occlusion_ext;
string_t_array_t * path_roughness_ext;
string_t_array_t * path_metallic_ext;
string_t_array_t * path_displacement_ext;
string_t * path_working_dir_cache;
any_imap_t * physics_body_object_map;
physics_world_t * physics_world_active;
gpu_pipeline_t * pipes_copy;
gpu_pipeline_t * pipes_copy8;
gpu_pipeline_t * pipes_copy64;
gpu_pipeline_t * pipes_copy128;
gpu_pipeline_t * pipes_copy_bgra;
gpu_pipeline_t * pipes_copy_rgb;
gpu_pipeline_t * pipes_copy_r;
gpu_pipeline_t * pipes_copy_g;
gpu_pipeline_t * pipes_copy_a;
i32 pipes_copy_a_tex;
gpu_pipeline_t * pipes_merge;
gpu_pipeline_t * pipes_merge_r;
gpu_pipeline_t * pipes_merge_g;
gpu_pipeline_t * pipes_merge_b;
gpu_pipeline_t * pipes_merge_mask;
gpu_pipeline_t * pipes_invert8;
gpu_pipeline_t * pipes_apply_mask;
gpu_pipeline_t * pipes_colorid_to_mask;
i32 pipes_tex0;
i32 pipes_tex1;
i32 pipes_texmask;
i32 pipes_texa;
i32 pipes_opac;
i32 pipes_blending;
i32 pipes_tex1w;
i32 pipes_tex0_mask;
i32 pipes_texa_mask;
i32 pipes_tex0_merge_mask;
i32 pipes_texa_merge_mask;
i32 pipes_tex_colorid;
i32 pipes_texpaint_colorid;
i32 pipes_opac_merge_mask;
i32 pipes_blending_merge_mask;
gpu_texture_t * pipes_temp_mask_image;
gpu_pipeline_t * pipes_inpaint_preview;
i32 pipes_tex0_inpaint_preview;
i32 pipes_texa_inpaint_preview;
gpu_pipeline_t * pipes_cursor;
i32 pipes_cursor_vp;
i32 pipes_cursor_inv_vp;
i32 pipes_cursor_mouse;
i32 pipes_cursor_tex_step;
i32 pipes_cursor_radius;
i32 pipes_cursor_camera_right;
i32 pipes_cursor_tint;
i32 pipes_cursor_gbufferd;
i32 pipes_offset;
any_map_t * plugin_map;
string_t * _plugin_name;
project_format_t * project_raw;
string_t * project_filepath;
asset_t_array_t * project_assets;
string_t_array_t * project_asset_names;
i32 project_asset_id;
string_t_array_t * project_mesh_assets;
node_group_t_array_t * project_material_groups;
mesh_object_t_array_t * project_paint_objects;
any_imap_t * project_asset_map;
string_t_array_t * project_mesh_list;
slot_material_t_array_t * project_materials;
slot_brush_t_array_t * project_brushes;
slot_layer_t_array_t * project_layers;
slot_font_t_array_t * project_fonts;
i32_array_t * project_atlas_objects;
string_t_array_t * project_atlas_names;
material_data_t * project_material_data;
ui_nodes_t * project_nodes;
ui_node_canvas_t * project_canvas;
buffer_t * project_default_canvas;
bool _project_save_and_quit;
bool _project_import_mesh_replace_existing;
void(*_project_import_mesh_done)(void);
string_t * _project_import_mesh_box_path;
bool _project_import_mesh_box_replace_existing;
bool _project_import_mesh_box_clear_layers;
void(*_project_import_mesh_box_done)(void);
raw_mesh_t * _project_unwrap_mesh_box_mesh;
void(*_project_unwrap_mesh_box_done)(raw_mesh_t *);
bool _project_unwrap_mesh_box_skip_ui;
bool _project_import_asset_hdr_as_envmap;
bool _project_import_swatches_replace_existing;
asset_t * _project_reimport_texture_asset;
scene_t * _project_scene_mesh_gc;
i32 _project_unwrap_by;
i32 render_path_base_taa_frame;
f32 render_path_base_super_sample;
f32 render_path_base_last_x;
f32 render_path_base_last_y;
render_target_t_array_t * render_path_base_bloom_mipmaps;
i32 render_path_base_bloom_current_mip;
f32 render_path_base_bloom_sample_scale;
i32 render_path_raytrace_frame;
bool render_path_raytrace_ready;
i32 render_path_raytrace_dirty;
f32 render_path_raytrace_uv_scale;
bool render_path_raytrace_first;
f32_array_t * render_path_raytrace_f32a;
mat4_t render_path_raytrace_help_mat;
mat4_t render_path_raytrace_transform;
gpu_buffer_t * render_path_raytrace_vb;
gpu_buffer_t * render_path_raytrace_ib;
gpu_texture_t * render_path_raytrace_last_envmap;
bool render_path_raytrace_is_bake;
string_t * render_path_raytrace_ext;
gpu_texture_t * render_path_raytrace_last_texpaint;
i32 render_path_raytrace_bake_rays_pix;
i32 render_path_raytrace_bake_rays_sec;
i32 render_path_raytrace_bake_current_sample;
f32 render_path_raytrace_bake_rays_timer;
i32 render_path_raytrace_bake_rays_counter;
gpu_texture_t * render_path_raytrace_bake_last_layer;
i32 render_path_raytrace_bake_last_bake;
any_map_t * resource_bundled;
buffer_t * slot_brush_default_canvas;
buffer_t * slot_material_default_canvas;
string_t * str_tex_checker;
string_t * str_tex_voronoi;
string_t * str_tex_noise;
string_t * str_tex_musgrave;
string_t * str_hue_sat;
string_t * str_wavelength_to_rgb;
string_t * str_tex_magic;
string_t * str_tex_brick;
string_t * str_tex_wave;
string_t * str_brightcontrast;
string_t * str_cotangent_frame;
string_t * str_transpose;
string_t * str_octahedron_wrap;
string_t * str_pack_float_int16;
string_t * str_create_basis;
string_t * str_sh_irradiance;
string_t * str_envmap_equirect;
string_t * str_envmap_sample;
string_t * str_get_pos_nor_from_depth;
string_t * str_get_smudge_tool_weight;
string_t * str_get_blur_tool_weight;
ui_handle_t * tab_browser_hpath;
ui_handle_t * tab_browser_hsearch;
bool tab_browser_known;
string_t * tab_browser_last_path;
string_t * _tab_browser_draw_file;
string_t * _tab_browser_draw_b;
i32 _tab_brushes_draw_i;
i32 _tab_fonts_draw_i;
i32 tab_layers_layer_name_edit;
ui_handle_t * tab_layers_layer_name_handle;
bool tab_layers_show_context_menu;
slot_layer_t * tab_layers_l;
bool tab_layers_mini;
i32 _tab_materials_draw_slots;
i32 _tab_meshes_draw_i;
ui_handle_t * tab_script_hscript;
ui_text_coloring_t * tab_script_text_coloring;
gpu_texture_t * _tab_swatches_empty;
i32 tab_swatches_drag_pos;
i32 _tab_swatches_draw_i;
gpu_texture_t * _tab_textures_draw_img;
string_t * _tab_textures_draw_path;
asset_t * _tab_textures_draw_asset;
i32 _tab_textures_draw_i;
bool _tab_textures_draw_is_packed;
any_map_t * translator_translations;
i32_map_t * translator_cjk_font_indices;
string_t * translator_last_locale;
string_t * _translator_load_translations_cjk_font_path;
string_t * _translator_load_translations_cjk_font_disk_path;
bool _translator_init_font_cjk;
string_t * _translator_init_font_font_path;
f32 _translator_init_font_font_scale;
bool ui_base_show;
ui_t * ui_base_ui;
i32 ui_base_border_started;
ui_handle_t * ui_base_border_handle;
string_t * ui_base_action_paint_remap;
i32 ui_base_operator_search_offset;
f32 ui_base_undo_tap_time;
f32 ui_base_redo_tap_time;
ui_handle_t_array_t * ui_base_hwnds;
ui_handle_t_array_t * ui_base_htabs;
tab_draw_array_t_array_t * ui_base_hwnd_tabs;
i32 ui_base_viewport_col;
i32 ui_base_default_sidebar_mini_w;
i32 ui_base_default_sidebar_full_w;
i32 ui_base_default_sidebar_w;
i32 ui_base_tabx;
ui_handle_t * ui_base_hminimized;
i32 ui_base_sidebar_mini_w;
bool _ui_base_operator_search_first;
bool ui_box_show;
bool ui_box_draggable;
ui_handle_t * ui_box_hwnd;
string_t * ui_box_title;
string_t * ui_box_text;
void(*ui_box_commands)(ui_t *);
bool ui_box_click_to_hide;
i32 ui_box_modalw;
i32 ui_box_modalh;
void(*ui_box_modal_on_hide)(void);
i32 ui_box_draws;
bool ui_box_copyable;
f32 ui_box_tween_alpha;
string_t * ui_files_default_path;
string_t * ui_files_filename;
string_t * ui_files_path;
string_t * ui_files_last_path;
string_t * ui_files_last_search;
string_t_array_t * ui_files_files;
any_map_t * ui_files_icon_map;
any_map_t * ui_files_icon_file_map;
i32 ui_files_selected;
bool ui_files_show_extensions;
bool ui_files_offline;
ui_handle_t * _ui_files_file_browser_handle;
string_t * _ui_files_file_browser_f;
i32 ui_header_default_h;
i32 ui_header_h;
ui_handle_t * ui_header_handle;
ui_handle_t * ui_header_worktab;
bool ui_menu_show;
i32 ui_menu_category;
i32 ui_menu_x;
i32 ui_menu_y;
i32 ui_menu_h;
i32 ui_menu_elements;
bool ui_menu_keep_open;
void(*ui_menu_commands)(ui_t *);
bool ui_menu_show_first;
bool ui_menu_hide_flag;
string_t * _ui_menu_render_msg;
i32 ui_menubar_default_w;
ui_handle_t * ui_menubar_workspace_handle;
ui_handle_t * ui_menubar_menu_handle;
i32 ui_menubar_w;
mat4_t _ui_menubar_saved_camera;
mesh_object_t * _ui_menubar_plane;
bool ui_nodes_show;
i32 ui_nodes_wx;
i32 ui_nodes_wy;
i32 ui_nodes_ww;
i32 ui_nodes_wh;
ui_t * ui_nodes_ui;
canvas_type_t ui_nodes_canvas_type;
bool ui_nodes_show_menu;
bool ui_nodes_show_menu_first;
bool ui_nodes_hide_menu;
i32 ui_nodes_menu_category;
f32 ui_nodes_popup_x;
f32 ui_nodes_popup_y;
i32 ui_nodes_node_search_x;
i32 ui_nodes_node_search_y;
bool ui_nodes_uichanged_last;
bool ui_nodes_recompile_mat;
bool ui_nodes_recompile_mat_final;
ui_node_t * ui_nodes_node_search_spawn;
i32 ui_nodes_node_search_offset;
ui_node_canvas_t * ui_nodes_last_canvas;
i32 ui_nodes_last_node_selected_id;
bool ui_nodes_release_link;
bool ui_nodes_is_node_menu_op;
gpu_texture_t * ui_nodes_grid;
bool ui_nodes_grid_redraw;
i32 ui_nodes_grid_cell_w;
i32 ui_nodes_grid_small_cell_w;
ui_handle_t * ui_nodes_hwnd;
node_group_t_array_t * ui_nodes_group_stack;
bool ui_nodes_controls_down;
slot_material_t_array_t * ui_nodes_tabs;
ui_handle_t * ui_nodes_htab;
ui_node_link_t * _ui_nodes_on_link_drag_link_drag;
ui_node_t * _ui_nodes_on_link_drag_node;
ui_node_socket_t * _ui_nodes_on_socket_released_socket;
ui_node_t * _ui_nodes_on_socket_released_node;
ui_handle_t * _ui_nodes_htype;
ui_handle_t * _ui_nodes_hname;
ui_handle_t * _ui_nodes_hmin;
ui_handle_t * _ui_nodes_hmax;
ui_handle_t * _ui_nodes_hval0;
ui_handle_t * _ui_nodes_hval1;
ui_handle_t * _ui_nodes_hval2;
ui_handle_t * _ui_nodes_hval3;
ui_node_t * _ui_nodes_on_canvas_released_selected;
bool _ui_nodes_node_search_first;
void(*_ui_nodes_node_search_done)(void);
void(*_ui_nodes_render_tmp)(i32);
i32 ui_status_default_status_h;
i32 ui_toolbar_default_w;
ui_handle_t * ui_toolbar_handle;
i32 ui_toolbar_last_tool;
string_t_array_t * ui_toolbar_tool_names;
i32 _ui_toolbar_i;
gpu_pipeline_t * ui_view2d_pipe;
i32 ui_view2d_channel_loc;
bool ui_view2d_text_input_hover;
bool ui_view2d_uvmap_show;
paint_tex_t ui_view2d_tex_type;
view_2d_layer_mode_t ui_view2d_layer_mode;
view_2d_type_t ui_view2d_type;
bool ui_view2d_show;
i32 ui_view2d_wx;
i32 ui_view2d_wy;
i32 ui_view2d_ww;
i32 ui_view2d_wh;
ui_t * ui_view2d_ui;
ui_handle_t * ui_view2d_hwnd;
f32 ui_view2d_pan_x;
f32 ui_view2d_pan_y;
f32 ui_view2d_pan_scale;
bool ui_view2d_tiled_show;
bool ui_view2d_controls_down;
gpu_texture_t * _ui_view2d_render_tex;
f32 _ui_view2d_render_x;
f32 _ui_view2d_render_y;
f32 _ui_view2d_render_tw;
f32 _ui_view2d_render_th;
gpu_texture_t * ui_view2d_grid;
bool ui_view2d_grid_redraw;
mat4_t uniforms_ext_ortho_p;
any_map_t * util_mesh_unwrappers;
i32 util_render_material_preview_size;
i32 util_render_decal_preview_size;
i32 util_render_layer_preview_size;
i32 util_render_font_preview_size;
gpu_buffer_t * util_render_screen_aligned_full_vb;
gpu_buffer_t * util_render_screen_aligned_full_ib;
gpu_texture_t * util_uv_uvmap;
bool util_uv_uvmap_cached;
gpu_texture_t * util_uv_trianglemap;
bool util_uv_trianglemap_cached;
gpu_texture_t * util_uv_dilatemap;
bool util_uv_dilatemap_cached;
gpu_texture_t * util_uv_uvislandmap;
bool util_uv_uvislandmap_cached;
buffer_t * util_uv_dilate_bytes;
gpu_pipeline_t * util_uv_pipe_dilate;
vec4_t _camera_object_v;
vec4_t _camera_object_sphere_center;
i32 camera_object_taa_frames;
gpu_buffer_t * const_data_screen_aligned_vb;
gpu_buffer_t * const_data_screen_aligned_ib;
gpu_buffer_t * const_data_skydome_vb;
gpu_buffer_t * const_data_skydome_ib;
any_map_t * data_cached_scene_raws;
any_map_t * data_cached_meshes;
any_map_t * data_cached_cameras;
any_map_t * data_cached_materials;
any_map_t * data_cached_worlds;
any_map_t * data_cached_shaders;
any_map_t * data_cached_blobs;
any_map_t * data_cached_images;
any_map_t * data_cached_videos;
any_map_t * data_cached_fonts;
i32 data_assets_loaded;
bool _input_occupied;
bool _input_registered;
string_t_array_t * _mouse_buttons;
u8_array_t * _mouse_buttons_down;
u8_array_t * _mouse_buttons_started;
u8_array_t * _mouse_buttons_released;
f32 mouse_x;
f32 mouse_y;
bool mouse_moved;
f32 mouse_movement_x;
f32 mouse_movement_y;
f32 mouse_wheel_delta;
bool mouse_locked;
bool mouse_hidden;
f32 mouse_last_x;
f32 mouse_last_y;
string_t_array_t * pen_buttons;
u8_array_t * pen_buttons_down;
u8_array_t * pen_buttons_started;
u8_array_t * pen_buttons_released;
f32 pen_x;
f32 pen_y;
bool pen_moved;
f32 pen_movement_x;
f32 pen_movement_y;
f32 pen_pressure;
bool pen_connected;
bool pen_in_use;
f32 pen_last_x;
f32 pen_last_y;
string_t_array_t * keyboard_keys;
i32_map_t * keyboard_keys_down;
i32_map_t * keyboard_keys_started;
i32_map_t * keyboard_keys_released;
string_t_array_t * keyboard_keys_frame;
bool keyboard_repeat_key;
f32 keyboard_repeat_time;
string_t_array_t * gamepad_buttons_ps;
string_t_array_t * gamepad_buttons_xbox;
string_t_array_t * gamepad_buttons;
gamepad_t_array_t * gamepad_raws;
any_map_t * ui_children;
any_map_t * ui_nodes_custom_buttons;
i32_array_t * _lz4_hash_table;
i32 _material_data_uid_counter;
gpu_pipeline_t * _mesh_object_last_pipeline;
material_context_t_array_t * _mesh_object_material_contexts;
shader_context_t_array_t * _mesh_object_shader_contexts;
i32 _object_uid_counter;
mat4_t _raycast_vp_inv;
mat4_t _raycast_p_inv;
mat4_t _raycast_v_inv;
void(*render_path_commands)(void);
any_map_t * render_path_render_targets;
i32 render_path_current_w;
i32 render_path_current_h;
f32 _render_path_frame_time;
i32 _render_path_frame;
render_target_t * _render_path_current_target;
gpu_texture_t * _render_path_current_image;
draw_order_t _render_path_draw_order;
bool _render_path_paused;
i32 _render_path_last_w;
i32 _render_path_last_h;
string_t_array_t * _render_path_bind_params;
bool _render_path_meshes_sorted;
f32 _render_path_last_frame_time;
i32 _render_path_loading;
any_map_t * _render_path_cached_shader_contexts;
camera_object_t * scene_camera;
world_data_t * scene_world;
mesh_object_t_array_t * scene_meshes;
camera_object_t_array_t * scene_cameras;
object_t_array_t * scene_empties;
any_map_t * scene_embedded;
bool _scene_ready;
i32 _scene_uid_counter;
i32 _scene_uid;
scene_t * _scene_raw;
object_t * _scene_root;
object_t * _scene_scene_parent;
i32 _scene_objects_traversed;
i32 _scene_objects_count;
sys_callback_t_array_t * _sys_render_listeners;
sys_callback_t_array_t * _sys_foreground_listeners;
sys_callback_t_array_t * _sys_resume_listeners;
sys_callback_t_array_t * _sys_pause_listeners;
sys_callback_t_array_t * _sys_background_listeners;
sys_callback_t_array_t * _sys_shutdown_listeners;
sys_string_callback_t_array_t * _sys_drop_files_listeners;
f32 _sys_start_time;
string_t * _sys_window_title;
any_map_t * _sys_shaders;
callback_t_array_t * _sys_on_resets;
callback_t_array_t * _sys_on_next_frames;
callback_t_array_t * _sys_on_end_frames;
callback_t_array_t * _sys_on_inits;
callback_t_array_t * _sys_on_updates;
callback_t_array_t * _sys_on_renders;
callback_t_array_t * _sys_on_renders_2d;
bool _sys_pause_updates;
i32 _sys_lastw;
i32 _sys_lasth;
void(*sys_on_resize)(void);
i32(*sys_on_w)(void);
i32(*sys_on_h)(void);
i32(*sys_on_x)(void);
i32(*sys_on_y)(void);
f32 _sys_time_last;
f32 _sys_time_real_delta;
i32 _sys_time_frequency;
tilesheet_data_t_array_t * tilesheet_datas;
tween_anim_t_array_t * _tween_anims;
bool _tween_registered;
mat4_t _uniforms_mat;
mat4_t _uniforms_mat2;
mat3_t _uniforms_mat3;
vec4_t _uniforms_vec;
vec4_t _uniforms_vec2;
quat_t _uniforms_quat;
gpu_texture_t *(*uniforms_tex_links)(object_t *,material_data_t *,string_t *);
mat4_t(*uniforms_mat4_links)(object_t *,material_data_t *,string_t *);
vec4_t(*uniforms_vec4_links)(object_t *,material_data_t *,string_t *);
vec4_t(*uniforms_vec3_links)(object_t *,material_data_t *,string_t *);
vec2_t(*uniforms_vec2_links)(object_t *,material_data_t *,string_t *);
f32(*uniforms_f32_links)(object_t *,material_data_t *,string_t *);
f32_array_t *(*uniforms_f32_array_links)(object_t *,material_data_t *,string_t *);
i32(*uniforms_i32_links)(object_t *,material_data_t *,string_t *);
f32 uniforms_pos_unpack;
f32 uniforms_tex_unpack;
f32_array_t * _world_data_empty_irr;
ui_node_t * float_node_def;
ui_node_t * math_node_def;
i32 random_node_a;
i32 random_node_b;
i32 random_node_c;
i32 random_node_d;
ui_node_t * random_node_def;
ui_node_t * separate_vector_node_def;
ui_node_t * time_node_def;
ui_node_t * vector_math_node_def;
ui_node_t * vector_node_def;
shader_context_t * make_material_default_scon;
material_context_t * make_material_default_mcon;
bool make_material_height_used;
bool make_material_emis_used;
bool make_material_subs_used;
i32 make_mesh_layer_pass_count;
f32 make_mesh_preview_opacity_discard_decal;
string_t * manifest_title;
string_t * manifest_version;
string_t * manifest_url;
string_t * manifest_url_android;
string_t * manifest_url_ios;
string_t_array_t * nodes_brush_categories;
ui_node_t_array_t * nodes_brush_category0;
node_list_t_array_t * nodes_brush_list;
any_map_t * nodes_brush_creates;
slot_layer_t * render_path_paint_live_layer;
i32 render_path_paint_live_layer_drawn;
bool render_path_paint_live_layer_locked;
bool render_path_paint_dilated;
bool render_path_paint_push_undo_last;
mesh_object_t * render_path_paint_painto;
mesh_object_t * render_path_paint_planeo;
u8_array_t * render_path_paint_visibles;
bool render_path_paint_merged_object_visible;
f32 render_path_paint_saved_fov;
bool render_path_paint_baking;
render_target_t * _render_path_paint_texpaint;
render_target_t * _render_path_paint_texpaint_nor;
render_target_t * _render_path_paint_texpaint_pack;
render_target_t * _render_path_paint_texpaint_undo;
render_target_t * _render_path_paint_texpaint_nor_undo;
render_target_t * _render_path_paint_texpaint_pack_undo;
f32 render_path_paint_last_x;
f32 render_path_paint_last_y;
bake_type_t _render_path_paint_bake_type;
ui_handle_t * _ui_header_draw_tool_properties_h;
vec4_t input_node_coords;
f32 input_node_start_x;
f32 input_node_start_y;
bool input_node_lock_begin;
bool input_node_lock_x;
bool input_node_lock_y;
f32 input_node_lock_start_x;
f32 input_node_lock_start_y;
bool input_node_registered;
ui_node_t * input_node_def;
ui_node_t * tex_image_node_def;

void _kickstart() {
	args_use=false;
	args_asset_path="";
	args_background=false;
	args_export_textures=false;
	args_export_textures_type="";
	args_export_textures_preset="";
	args_export_textures_path="";
	args_reimport_mesh=false;
	args_export_mesh=false;
	args_export_mesh_path="";
	args_export_material=false;
	args_export_material_path="";
	base_ui_enabled=true;
	base_is_dragging=false;
	base_is_resizing=false;
	base_drag_asset=null;
	base_drag_swatch=null;
	base_drag_file=null;
	base_drag_file_icon=null;
	base_drag_tint=0xffffffff;
	base_drag_size=-1;
	base_drag_rect=null;
	base_drag_off_x=0.0;
	base_drag_off_y=0.0;
	base_drag_start=0.0;
	base_drop_x=0.0;
	base_drop_y=0.0;
	base_font=null;
	base_default_element_w=100;
	base_default_element_h=28;
	base_default_font_size=13;
	gc_unroot(base_res_handle);base_res_handle=ui_handle_create();gc_root(base_res_handle);
	gc_unroot(base_bits_handle);base_bits_handle=ui_handle_create();gc_root(base_bits_handle);
	gc_unroot(base_drop_paths);base_drop_paths=any_array_create_from_raw((any[]){},0);gc_root(base_drop_paths);
	base_appx=0;
	base_appy=0;
	base_last_window_width=0;
	base_last_window_height=0;
	base_drag_material=null;
	base_drag_layer=null;
	base_default_fov=0.69;
	gc_unroot(box_export_htab);box_export_htab=ui_handle_create();gc_root(box_export_htab);
	box_export_files=null;
	gc_unroot(box_export_mesh_handle);box_export_mesh_handle=ui_handle_create();gc_root(box_export_mesh_handle);
	gc_unroot(box_export_hpreset);box_export_hpreset=ui_handle_create();gc_root(box_export_hpreset);
	box_export_preset=null;
	gc_unroot(box_export_channels);box_export_channels=any_array_create_from_raw((any[]){"base_r","base_g","base_b","height","metal","nor_r","nor_g","nor_g_directx","nor_b","occ","opac","rough","smooth","emis","subs","0.0","1.0",},17);gc_root(box_export_channels);
	gc_unroot(box_export_color_spaces);box_export_color_spaces=any_array_create_from_raw((any[]){"linear","srgb",},2);gc_root(box_export_color_spaces);
	gc_unroot(box_preferences_htab);box_preferences_htab=ui_handle_create();gc_root(box_preferences_htab);
	box_preferences_files_plugin=null;
	box_preferences_files_keymap=null;
	box_preferences_locales=null;
	box_preferences_themes=null;
	gc_unroot(box_projects_htab);box_projects_htab=ui_handle_create();gc_root(box_projects_htab);
	gc_unroot(box_projects_hsearch);box_projects_hsearch=ui_handle_create();gc_root(box_projects_hsearch);
	box_projects_icon_map=null;
	camera_redraws=0;
	camera_dir=vec4_create(0.0,0.0,0.0,1.0);
	camera_ease=1.0;
	camera_controls_down=false;
	_compass_hovered=null;
	_compass_hovered_last=null;
	config_raw=null;
	config_loaded=false;
	config_button_align=ui_align_t_LEFT;
	config_default_button_spacing="       ";
	gc_unroot(config_button_spacing);config_button_spacing=config_default_button_spacing;gc_root(config_button_spacing);
	console_message="";
	console_message_timer=0.0;
	console_message_color=0x00000000;
	gc_unroot(console_last_traces);console_last_traces=any_array_create_from_raw((any[]){"",},1);gc_root(console_last_traces);
	console_progress_text=null;
	export_texture_gamma=1.0/2.2;
	gc_unroot(_file_download_map);_file_download_map=any_map_create();gc_root(_file_download_map);
	gc_unroot(_file_download_bytes_map);_file_download_bytes_map=any_map_create();gc_root(_file_download_bytes_map);
	gc_unroot(_file_cache_cloud_map);_file_cache_cloud_map=any_map_create();gc_root(_file_cache_cloud_map);
	file_cmd_mkdir="mkdir";
	file_cmd_copy="copy";
	file_cloud=null;
	file_cloud_sizes=null;
	gizmo_v=vec4_create(0.0,0.0,0.0,1.0);
	gizmo_v0=vec4_create(0.0,0.0,0.0,1.0);
	gizmo_q=quat_create(0.0,0.0,0.0,1.0);
	gizmo_q0=quat_create(0.0,0.0,0.0,1.0);
	history_undo_i=0;
	history_undos=0;
	history_redos=0;
	history_push_undo=false;
	history_undo_layers=null;
	history_push_undo2=false;
	import_envmap_pipeline=null;
	import_envmap_params=vec4_create(0.0,0.0,0.0,1.0);
	import_envmap_n=vec4_create(0.0,0.0,0.0,1.0);
	import_envmap_radiance=null;
	import_envmap_mips=null;
	import_mesh_clear_layers=true;
	import_mesh_meshes_to_unwrap=null;
	layers_temp_image=null;
	layers_expa=null;
	layers_expb=null;
	layers_expc=null;
	layers_default_base=0.5;
	layers_default_rough=0.4;
	layers_max_layers=255;
	line_draw_color=0xffff0000;
	line_draw_strength=0.005;
	line_draw_mat=mat4_nan();
	line_draw_dim=vec4_nan();
	line_draw_pipeline=null;
	line_draw_overlay_pipeline=null;
	line_draw_max_lines=300;
	line_draw_max_vertices=line_draw_max_lines*4;
	line_draw_max_indices=line_draw_max_lines*6;
	line_draw_lines=0;
	line_draw_vx=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_vy=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_vz=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_v1=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_v2=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_t=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_mid_point=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_mid_line=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_corner1=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_corner2=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_corner3=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_corner4=vec4_create(0.0,0.0,0.0,1.0);
	line_draw_camera_look=vec4_create(0.0,0.0,0.0,1.0);
	_shape_draw_sphere_vb=null;
	_shape_draw_sphere_ib=null;
	gc_unroot(nodes_material_categories);nodes_material_categories=any_array_create_from_raw((any[]){_tr("Input"),_tr("Texture"),_tr("Color"),_tr("Vector"),_tr("Converter"),_tr("Group"),},6);gc_root(nodes_material_categories);
	gc_unroot(nodes_material_input);nodes_material_input=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Attribute"),.type="ATTRIBUTE",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("Name"),.type="STRING",.output=-1,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Camera Data"),.type="CAMERA",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("View Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("View Z Depth"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("View Distance"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Fresnel"),.type="FRESNEL",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("IOR"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.45),.min=0.0,.max=3.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Geometry"),.type="NEW_GEOMETRY",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Position"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Tangent"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("True Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Incoming"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Parametric"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Backfacing"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Pointiness"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Random Per Island"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},9),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Layer"),.type="LAYER",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Base Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Opacity"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Occlusion"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Roughness"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Metallic"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Emission"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Height"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Subsurface"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},9),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("Layer"),.type="ENUM",.output=-1,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(""),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Layer Mask"),.type="LAYER_MASK",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("Layer"),.type="ENUM",.output=-1,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(""),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Layer Weight"),.type="LAYER_WEIGHT",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Blend"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fresnel"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Facing"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Material"),.type="MATERIAL",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Base Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Opacity"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Occlusion"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Roughness"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Metallic"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Emission"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Height"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Subsurface"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},9),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("Material"),.type="ENUM",.output=-1,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(""),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Object Info"),.type="OBJECT_INFO",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Location"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Object Index"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Material Index"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Random"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},5),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Picker"),.type="PICKER",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Base Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Opacity"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Occlusion"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Roughness"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Metallic"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Emission"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Height"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Subsurface"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},9),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("RGB"),.type="RGB",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.5,0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("default_value"),.type="RGBA",.output=0,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Script"),.type="SCRIPT_CPU",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=" ",.type="STRING",.output=-1,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Shader"),.type="SHADER_GPU",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=" ",.type="STRING",.output=-1,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Tangent"),.type="TANGENT",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Tangent"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Texture Coordinate"),.type="TEX_COORD",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Generated"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("UV"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Object"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Camera"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Window"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Reflection"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},7),.buttons=any_array_create_from_raw((any[]){},0)}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("UV Map"),.type="UVMAP",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("UV"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Value"),.type="VALUE",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("default_value"),.type="VALUE",.output=0,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=10.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Vertex Color"),.type="VERTEX_COLOR",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Alpha"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Wireframe"),.type="WIREFRAME",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Size"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.01),.min=0.0,.max=0.1,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("Pixel Size"),.type="BOOL",.output=0,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),},19);gc_root(nodes_material_input);
	gc_unroot(nodes_material_texture);nodes_material_texture=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Brick Texture"),.type="TEX_BRICK",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color 1"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyz(0.8,0.8,0.8),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color 2"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyz(0.2,0.2,0.2),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Mortar"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(5.0),.min=0.0,.max=10.0,.precision=100,.display=0}),},5),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Checker Texture"),.type="TEX_CHECKER",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color 1"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyz(0.8,0.8,0.8),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color 2"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyz(0.2,0.2,0.2),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(5.0),.min=0.0,.max=10.0,.precision=100,.display=0}),},4),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Curvature Bake"),.type="BAKE_CURVATURE",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Strength"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=2.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Radius"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=2.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Offset"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=-2.0,.max=2.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Gradient Texture"),.type="TEX_GRADIENT",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("gradient_type"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(string_join(string_join(string_join(string_join(_tr("Linear"),"\n"),_tr("Diagonal")),"\n"),_tr("Radial")),"\n"),_tr("Spherical"))),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Image Texture"),.type="TEX_IMAGE",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Alpha"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("File"),.type="ENUM",.output=-1,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(""),.min=0.0,.max=1.0,.precision=100,.height=0}),GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("Color Space"),.type="ENUM",.output=-1,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(string_join(string_join(string_join(string_join(_tr("Auto"),"\n"),_tr("Linear")),"\n"),_tr("sRGB")),"\n"),_tr("DirectX Normal Map"))),.min=0.0,.max=1.0,.precision=100,.height=0}),},2),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Text Texture"),.type="TEX_TEXT",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Alpha"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name="text",.type="STRING",.output=-1,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Magic Texture"),.type="TEX_MAGIC",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(5.0),.min=0.0,.max=10.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Musgrave Texture"),.type="TEX_MUSGRAVE",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(5.0),.min=0.0,.max=10.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Height"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Noise Texture"),.type="TEX_NOISE",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(5.0),.min=0.0,.max=10.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Voronoi Texture"),.type="TEX_VORONOI",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(5.0),.min=0.0,.max=10.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("coloring"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(_tr("Intensity"),"\n"),_tr("Cells"))),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Wave Texture"),.type="TEX_WAVE",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(5.0),.min=0.0,.max=10.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),},11);gc_root(nodes_material_texture);
	gc_unroot(nodes_material_color);nodes_material_color=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Blur"),.type="BLUR",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Strength"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Brightness/Contrast"),.type="BRIGHTCONTRAST",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Bright"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Contrast"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Gamma"),.type="GAMMA",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Gamma"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Hue/Saturation/Value"),.type="HUE_SAT",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Hue"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Saturation"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},5),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Invert"),.type="INVERT",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Mix Color"),.type="MIX_RGB",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color 1"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.5,0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color 2"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.5,0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("blend_type"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(_tr("Mix"),"\n"),_tr("Darken")),"\n"),_tr("Multiply")),"\n"),_tr("Burn")),"\n"),_tr("Lighten")),"\n"),_tr("Screen")),"\n"),_tr("Dodge")),"\n"),_tr("Add")),"\n"),_tr("Overlay")),"\n"),_tr("Soft Light")),"\n"),_tr("Linear Light")),"\n"),_tr("Difference")),"\n"),_tr("Subtract")),"\n"),_tr("Divide")),"\n"),_tr("Hue")),"\n"),_tr("Saturation")),"\n"),_tr("Color")),"\n"),_tr("Value"))),.min=0.0,.max=1.0,.precision=100,.height=0}),GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("use_clamp"),.type="BOOL",.output=0,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},2),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Quantize"),.type="QUANTIZE",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Strength"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.1),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Replace Color"),.type="REPLACECOL",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0)}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Old Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0)}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("New Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0)}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Radius"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.1),.min=0.0,.max=1.74,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fuzziness"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},5),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0)}),},1),.buttons=any_array_create_from_raw((any[]){},0)}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Warp"),.type="DIRECT_WARP",.x=0,.y=0,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Angle"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=360.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Mask"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),},9);gc_root(nodes_material_color);
	gc_unroot(nodes_material_vector);nodes_material_vector=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Bump"),.type="BUMP",.x=0,.y=0,.color=0xff522c99,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Strength"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Distance"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Height"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},4),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Mapping"),.type="MAPPING",.x=0,.y=0,.color=0xff522c99,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Location"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=1}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Rotation"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=360.0,.precision=100,.display=1}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Scale"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(1.0,1.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=1}),},4),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Mix Normal Map"),.type="MIX_NORMAL_MAP",.x=0,.y=0,.color=0xff522c99,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map 1"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map 2"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("blend_type"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(string_join(string_join(_tr("Partial Derivative"),"\n"),_tr("Whiteout")),"\n"),_tr("Reoriented"))),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Normal"),.type="NORMAL",.x=0,.y=0,.color=0xff522c99,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Dot"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("Vector"),.type="VECTOR",.output=0,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Normal Map"),.type="NORMAL_MAP",.x=0,.y=0,.color=0xff522c99,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Strength"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=2.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Normal Map"),.type="VECTOR",.color=-10238109,.default_value=f32_array_create_xyz(0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Vector Curves"),.type="CURVE_VEC",.x=0,.y=0,.color=0xff522c99,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name="nodes_material_vector_curves_button",.type="CUSTOM",.output=0,.default_value=f32_array_create(96+3),.data=null,.min=0.0,.max=1.0,.precision=100,.height=8.5}),},1),.width=0}),},6);gc_root(nodes_material_vector);
	gc_unroot(nodes_material_converter);nodes_material_converter=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Clamp"),.type="CLAMP",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Min"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Max"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("operation"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(_tr("Min Max"),"\n"),_tr("Range"))),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Color Ramp"),.type="VALTORGB",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fac"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Alpha"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name="nodes_material_color_ramp_button",.type="CUSTOM",.output=0,.default_value=f32_array_create_xyzwv(1.0,1.0,1.0,1.0,0.0),.data=u8_array_create(1),.min=0.0,.max=1.0,.precision=100,.height=4.5}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Color Mask"),.type="COLMASK",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Mask Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Radius"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.1),.min=0.0,.max=1.74,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Fuzziness"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},4),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Mask"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Combine HSV"),.type="COMBHSV",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("H"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("S"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("V"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Combine RGB"),.type="COMBRGB",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("R"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("G"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("B"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Combine XYZ"),.type="COMBXYZ",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("X"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Y"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Z"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Map Range"),.type="MAPRANGE",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("From Min"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("From Max"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("To Min"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("To Max"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},5),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("use_clamp"),.type="BOOL",.output=0,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Math"),.type="MATH",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("operation"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(_tr("Add"),"\n"),_tr("Subtract")),"\n"),_tr("Multiply")),"\n"),_tr("Divide")),"\n"),_tr("Power")),"\n"),_tr("Logarithm")),"\n"),_tr("Square Root")),"\n"),_tr("Inverse Square Root")),"\n"),_tr("Absolute")),"\n"),_tr("Exponent")),"\n"),_tr("Minimum")),"\n"),_tr("Maximum")),"\n"),_tr("Less Than")),"\n"),_tr("Greater Than")),"\n"),_tr("Sign")),"\n"),_tr("Round")),"\n"),_tr("Floor")),"\n"),_tr("Ceil")),"\n"),_tr("Truncate")),"\n"),_tr("Fraction")),"\n"),_tr("Modulo")),"\n"),_tr("Snap")),"\n"),_tr("Ping-Pong")),"\n"),_tr("Sine")),"\n"),_tr("Cosine")),"\n"),_tr("Tangent")),"\n"),_tr("Arcsine")),"\n"),_tr("Arccosine")),"\n"),_tr("Arctangent")),"\n"),_tr("Arctan2")),"\n"),_tr("Hyperbolic Sine")),"\n"),_tr("Hyperbolic Cosine")),"\n"),_tr("Hyperbolic Tangent")),"\n"),_tr("To Radians")),"\n"),_tr("To Degrees"))),.min=0.0,.max=1.0,.precision=100,.height=0}),GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("use_clamp"),.type="BOOL",.output=0,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},2),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("RGB to BW"),.type="RGBTOBW",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Val"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Separate HSV"),.type="SEPHSV",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.5,0.5,0.5,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("H"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("S"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("V"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Separate RGB"),.type="SEPRGB",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="RGBA",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.8,0.8,0.8,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("R"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("G"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("B"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Separate XYZ"),.type="SEPXYZ",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("X"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Y"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Z"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.buttons=any_array_create_from_raw((any[]){},0),.width=0}),GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Vector Math"),.type="VECT_MATH",.x=0,.y=0,.color=0xff62676d,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("operation"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(_tr("Add"),"\n"),_tr("Subtract")),"\n"),_tr("Multiply")),"\n"),_tr("Divide")),"\n"),_tr("Average")),"\n"),_tr("Cross Product")),"\n"),_tr("Project")),"\n"),_tr("Reflect")),"\n"),_tr("Dot Product")),"\n"),_tr("Distance")),"\n"),_tr("Length")),"\n"),_tr("Scale")),"\n"),_tr("Normalize")),"\n"),_tr("Absolute")),"\n"),_tr("Minimum")),"\n"),_tr("Maximum")),"\n"),_tr("Floor")),"\n"),_tr("Ceil")),"\n"),_tr("Fraction")),"\n"),_tr("Modulo")),"\n"),_tr("Snap")),"\n"),_tr("Sine")),"\n"),_tr("Cosine")),"\n"),_tr("Tangent"))),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0}),},13);gc_root(nodes_material_converter);
	gc_unroot(nodes_material_group);nodes_material_group=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("New Group"),.type="GROUP",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){},0),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name="nodes_material_new_group_button",.type="CUSTOM",.output=-1,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=1}),},1),.width=0}),},1);gc_root(nodes_material_group);
	gc_unroot(nodes_material_list);nodes_material_list=any_array_create_from_raw((any[]){nodes_material_input,nodes_material_texture,nodes_material_color,nodes_material_vector,nodes_material_converter,nodes_material_group,},6);gc_root(nodes_material_list);
	gc_unroot(operator_ops);operator_ops=any_map_create();gc_root(operator_ops);
	gc_unroot(parser_logic_custom_nodes);parser_logic_custom_nodes=any_map_create();gc_root(parser_logic_custom_nodes);
	parser_logic_parsed_nodes=null;
	parser_material_tex_coord="tex_coord";
	parser_material_eps=0.000001;
	gc_unroot(parser_material_custom_nodes);parser_material_custom_nodes=any_map_create();gc_root(parser_material_custom_nodes);
	parser_material_parse_surface=true;
	parser_material_parse_opacity=true;
	parser_material_parse_height=false;
	parser_material_parse_height_as_channel=false;
	parser_material_parse_emission=false;
	parser_material_parse_subsurface=false;
	parser_material_parsing_basecolor=false;
	parser_material_triplanar=false;
	parser_material_sample_keep_aspect=false;
	parser_material_sample_uv_scale="1.0";
	parser_material_transform_color_space=true;
	parser_material_blur_passthrough=false;
	parser_material_warp_passthrough=false;
	parser_material_bake_passthrough=false;
	parser_material_bake_passthrough_strength="0.0";
	parser_material_bake_passthrough_radius="0.0";
	parser_material_bake_passthrough_offset="0.0";
	parser_material_start_group=null;
	parser_material_start_parents=null;
	parser_material_start_node=null;
	parser_material_arm_export_tangents=true;
	parser_material_script_links=null;
	gc_unroot(parser_material_parsed_map);parser_material_parsed_map=any_map_create();gc_root(parser_material_parsed_map);
	gc_unroot(parser_material_texture_map);parser_material_texture_map=any_map_create();gc_root(parser_material_texture_map);
	parser_material_is_frag=true;
	path_sep="\\";
	path_pwd="cd";
	gc_unroot(path_mesh_formats);path_mesh_formats=any_array_create_from_raw((any[]){"obj","blend",},2);gc_root(path_mesh_formats);
	gc_unroot(path_texture_formats);path_texture_formats=any_array_create_from_raw((any[]){"jpg","jpeg","png","tga","bmp","psd","gif","hdr","k",},9);gc_root(path_texture_formats);
	gc_unroot(path_mesh_importers);path_mesh_importers=any_map_create();gc_root(path_mesh_importers);
	gc_unroot(path_texture_importers);path_texture_importers=any_map_create();gc_root(path_texture_importers);
	gc_unroot(path_base_color_ext);path_base_color_ext=any_array_create_from_raw((any[]){"albedo","alb","basecol","basecolor","diffuse","diff","base","bc","d","color","col",},11);gc_root(path_base_color_ext);
	gc_unroot(path_opacity_ext);path_opacity_ext=any_array_create_from_raw((any[]){"opac","opacity","alpha",},3);gc_root(path_opacity_ext);
	gc_unroot(path_normal_map_ext);path_normal_map_ext=any_array_create_from_raw((any[]){"normal","nor","n","nrm","normalgl",},5);gc_root(path_normal_map_ext);
	gc_unroot(path_occlusion_ext);path_occlusion_ext=any_array_create_from_raw((any[]){"ao","occlusion","ambientOcclusion","o","occ",},5);gc_root(path_occlusion_ext);
	gc_unroot(path_roughness_ext);path_roughness_ext=any_array_create_from_raw((any[]){"roughness","rough","r","rgh",},4);gc_root(path_roughness_ext);
	gc_unroot(path_metallic_ext);path_metallic_ext=any_array_create_from_raw((any[]){"metallic","metal","metalness","m","met",},5);gc_root(path_metallic_ext);
	gc_unroot(path_displacement_ext);path_displacement_ext=any_array_create_from_raw((any[]){"displacement","height","h","disp",},4);gc_root(path_displacement_ext);
	path_working_dir_cache=null;
	gc_unroot(physics_body_object_map);physics_body_object_map=any_imap_create();gc_root(physics_body_object_map);
	pipes_copy_rgb=null;
	pipes_merge=null;
	pipes_merge_r=null;
	pipes_merge_g=null;
	pipes_merge_b=null;
	pipes_temp_mask_image=null;
	gc_unroot(plugin_map);plugin_map=any_map_create();gc_root(plugin_map);
	gc_unroot(project_raw);project_raw=GC_ALLOC_INIT(project_format_t, {0});gc_root(project_raw);
	project_filepath="";
	gc_unroot(project_assets);project_assets=any_array_create_from_raw((any[]){},0);gc_root(project_assets);
	gc_unroot(project_asset_names);project_asset_names=any_array_create_from_raw((any[]){},0);gc_root(project_asset_names);
	project_asset_id=0;
	gc_unroot(project_mesh_assets);project_mesh_assets=any_array_create_from_raw((any[]){},0);gc_root(project_mesh_assets);
	gc_unroot(project_material_groups);project_material_groups=any_array_create_from_raw((any[]){},0);gc_root(project_material_groups);
	project_paint_objects=null;
	gc_unroot(project_asset_map);project_asset_map=any_imap_create();gc_root(project_asset_map);
	project_mesh_list=null;
	project_materials=null;
	project_brushes=null;
	project_layers=null;
	project_fonts=null;
	project_atlas_objects=null;
	project_atlas_names=null;
	project_material_data=null;
	project_default_canvas=null;
	_project_unwrap_by=0;
	render_path_base_taa_frame=0;
	render_path_base_super_sample=1.0;
	render_path_base_last_x=-1.0;
	render_path_base_last_y=-1.0;
	render_path_base_bloom_current_mip=0;
	render_path_raytrace_frame=0;
	render_path_raytrace_ready=false;
	render_path_raytrace_dirty=0;
	render_path_raytrace_uv_scale=1.0;
	render_path_raytrace_first=true;
	gc_unroot(render_path_raytrace_f32a);render_path_raytrace_f32a=f32_array_create(24);gc_root(render_path_raytrace_f32a);
	render_path_raytrace_help_mat=mat4_identity();
	render_path_raytrace_last_envmap=null;
	render_path_raytrace_is_bake=false;
	render_path_raytrace_ext=".cso";
	render_path_raytrace_last_texpaint=null;
	render_path_raytrace_bake_rays_pix=0;
	render_path_raytrace_bake_rays_sec=0;
	render_path_raytrace_bake_current_sample=0;
	render_path_raytrace_bake_rays_timer=0.0;
	render_path_raytrace_bake_rays_counter=0;
	render_path_raytrace_bake_last_layer=null;
	render_path_raytrace_bake_last_bake=0;
	gc_unroot(resource_bundled);resource_bundled=any_map_create();gc_root(resource_bundled);
	slot_brush_default_canvas=null;
	slot_material_default_canvas=null;
	str_tex_checker="\
fun tex_checker(co: float3, col1: float3, col2: float3, scale: float): float3 { \
	/* Prevent precision issues on unit coordinates */ \
	var p: float3 = (co + 0.000001 * 0.999999) * scale; \
	var xi: float = abs(floor(p.x)); \
	var yi: float = abs(floor(p.y)); \
	var zi: float = abs(floor(p.z)); \
	/* var check: bool = (xi % 2.0 == yi % 2.0) == zi % 2.0;*/ \
	var checka: int = 0; \
	var checkb: int = 0; \
	if (xi % 2.0 == yi % 2.0) { checka = 1; } \
	if (zi % 2.0 != 0.0) { checkb = 1; } \
	if (checka == checkb) { return col1; } return col2; \
} \
fun tex_checker_f(co: float3, scale: float): float { \
	var p: float3 = (co + 0.000001 * 0.999999) * scale; \
	var xi: float = abs(floor(p.x)); \
	var yi: float = abs(floor(p.y)); \
	var zi: float = abs(floor(p.z)); \
	/*return float((xi % 2.0 == yi % 2.0) == zi % 2.0);*/ \
	var checka: int = 0; \
	var checkb: int = 0; \
	if (xi % 2.0 == yi % 2.0) { checka = 1; } \
	if (zi % 2.0 != 0.0) { checkb = 1; } \
	if (checka == checkb) { return 1.0; } return 0.0; \
	\
} \
";
	str_tex_voronoi="\
fun tex_voronoi(x: float3): float4 { \
	var p: float3 = floor3(x); \
	var f: float3 = frac3(x); \
	var id: float = 0.0; \
	var res: float = 100.0; \
	for (var k: int = 0; k <= 2; k += 1) \
	for (var j: int = 0; j <= 2; j += 1) \
	for (var i: int = 0; i <= 2; i += 1) { \
		var b: float3 = float3(float(i - 1), float(j - 1), float(k - 1)); \
		var pb: float3 = p + b; \
		var snoise_sample: float3 = sample(snoise256, sampler_linear, (pb.xy + float2(3.0, 1.0) * pb.z + 0.5) / 256.0).xyz; \
		var r: float3 = b - f + snoise_sample; \
		var d: float = dot(r, r); \
		if (d < res) { \
			id = dot(p + b, float3(1.0, 57.0, 113.0)); \
			res = d; \
		} \
	} \
	/*var col: float3 = 0.5 + 0.5 * cos(id * 0.35 + float3(0.0, 1.0, 2.0));*/ \
	var col: float3; \
	col.x = 0.5 + 0.5 * cos(id * 0.35 + 0.0); \
	col.y = 0.5 + 0.5 * cos(id * 0.35 + 1.0); \
	col.z = 0.5 + 0.5 * cos(id * 0.35 + 2.0); \
	return float4(col, sqrt(res)); \
} \
";
	str_tex_noise="\
fun hash(n: float): float { return frac(sin(n) * 10000.0); } \
fun tex_noise_f(x: float3): float { \
    var step: float3 = float3(110.0, 241.0, 171.0); \
    var i: float3 = floor3(x); \
    var f: float3 = frac3(x); \
    var n: float = dot(i, step); \
    var u: float3 = f * f * (3.0 - 2.0 * f); \
    return lerp(lerp(lerp(hash(n + dot(step, float3(0.0, 0.0, 0.0))), hash(n + dot(step, float3(1.0, 0.0, 0.0))), u.x), \
                     lerp(hash(n + dot(step, float3(0.0, 1.0, 0.0))), hash(n + dot(step, float3(1.0, 1.0, 0.0))), u.x), u.y), \
                lerp(lerp(hash(n + dot(step, float3(0.0, 0.0, 1.0))), hash(n + dot(step, float3(1.0, 0.0, 1.0))), u.x), \
                     lerp(hash(n + dot(step, float3(0.0, 1.0, 1.0))), hash(n + dot(step, float3(1.0, 1.0, 1.0))), u.x), u.y), u.z); \
} \
fun tex_noise(p: float3): float { \
	p = p * 1.25; \
	var f: float = 0.5 * tex_noise_f(p); p = p * 2.01; \
	f += 0.25 * tex_noise_f(p); p = p * 2.02; \
	f += 0.125 * tex_noise_f(p); p = p * 2.03; \
	f += 0.0625 * tex_noise_f(p); \
	return 1.0 - f; \
} \
";
	str_tex_musgrave="\
fun random3(c: float3): float3 { \
	var j: float = 4096.0 * sin(dot(c, float3(17.0, 59.4, 15.0))); \
	var r: float3; \
	r.z = frac(512.0 * j); \
	j *= 0.125; \
	r.x = frac(512.0 * j); \
	j *= 0.125; \
	r.y = frac(512.0 * j); \
	return r - 0.5; \
} \
fun tex_musgrave_f(p: float3): float { \
	var F3: float = 0.3333333; \
	var G3: float = 0.1666667; \
	var s: float3 = floor3(p + dot(p, float3(F3, F3, F3))); \
	var x: float3 = p - s + dot(s, float3(G3, G3, G3)); \
	var e: float3 = step3(float3(0.0, 0.0, 0.0), x - x.yzx); \
	var i1: float3 = e * (1.0 - e.zxy); \
	var i2: float3 = 1.0 - e.zxy * (1.0 - e); \
	var x1: float3 = x - i1 + G3; \
	var x2: float3 = x - i2 + 2.0 * G3; \
	var x3: float3 = x - 1.0 + 3.0 * G3; \
	var w: float4; \
	var d: float4; \
	w.x = dot(x, x); \
	w.y = dot(x1, x1); \
	w.z = dot(x2, x2); \
	w.w = dot(x3, x3); \
	w = max4(float4(0.6, 0.6, 0.6, 0.6) - w, float4(0.0, 0.0, 0.0, 0.0)); \
	d.x = dot(random3(s), x); \
	d.y = dot(random3(s + i1), x1); \
	d.z = dot(random3(s + i2), x2); \
	d.w = dot(random3(s + 1.0), x3); \
	w *= w; \
	w *= w; \
	d *= w; \
	return clamp(dot(d, float4(52.0, 52.0, 52.0, 52.0)), 0.0, 1.0); \
} \
";
	str_hue_sat="\
fun hsv_to_rgb(c: float3): float3 { \
	var K: float4 = float4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0); \
	var p: float3 = abs3(frac3(c.xxx + K.xyz) * 6.0 - K.www); \
	return lerp3(K.xxx, clamp3(p - K.xxx, float3(0.0, 0.0, 0.0), float3(1.0, 1.0, 1.0)), c.y) * c.z; \
} \
fun rgb_to_hsv(c: float3): float3 { \
	var K: float4 = float4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0); \
	var p: float4 = lerp4(float4(c.bg, K.wz), float4(c.gb, K.xy), step(c.b, c.g)); \
	var q: float4 = lerp4(float4(p.xyw, c.r), float4(c.r, p.yzx), step(p.x, c.r)); \
	var d: float = q.x - min(q.w, q.y); \
	var e: float = 0.0000000001; \
	return float3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x); \
} \
fun hue_sat(col: float3, shift: float4): float3 { \
	var hsv: float3 = rgb_to_hsv(col); \
	hsv.x += shift.x; \
	hsv.y *= shift.y; \
	hsv.z *= shift.z; \
	return lerp3(hsv_to_rgb(hsv), col, shift.w); \
} \
";
	str_wavelength_to_rgb="\
fun wavelength_to_rgb(t: float): float3 { \
	var r: float3 = t * 2.1 - float3(1.8, 1.14, 0.3); \
	return 1.0 - r * r; \
} \
";
	str_tex_magic="\
fun tex_magic(p: float3): float3 { \
	var a: float = 1.0 - (sin(p.x) + sin(p.y)); \
	var b: float = 1.0 - sin(p.x - p.y); \
	var c: float = 1.0 - sin(p.x + p.y); \
	return float3(a, b, c); \
} \
fun tex_magic_f(p: float3): float { \
	var c: float3 = tex_magic(p); \
	return (c.x + c.y + c.z) / 3.0; \
} \
";
	str_tex_brick="\
fun tex_brick_noise(n: int): float { \
	var nn: int; \
	n = (n >> 13) ^ n; \
	/*nn = (n * (n * n * 60493 + 19990303) + 1376312589) & 0x7fffffff;*/ \
	nn = (n * (n * n * 60493 + 19990303) + 1376312589) & 2147483647; \
	return 0.5 * float(nn) / 1073741824.0; \
} \
fun tex_brick(p: float3, c1: float3, c2: float3, c3: float3): float3 { \
	var brick_size: float3 = float3(0.9, 0.49, 0.49); \
	var mortar_size: float3 = float3(0.05, 0.1, 0.1); \
	p /= brick_size / 2.0; \
	if (frac(p.y * 0.5) > 0.5) { p.x += 0.5; } \
	var col: float = floor(p.x / (brick_size.x + (mortar_size.x * 2.0))); \
	var row: float = p.y; \
	p = frac3(p); \
	var b: float3 = step3(p, 1.0 - mortar_size); \
	/*var tint: float = min(max(tex_brick_noise((int(col) << 16) + (int(row) & 0xffff)), 0.0), 1.0);*/ \
	var tint: float = min(max(tex_brick_noise((int(col) << 16) + (int(row) & 65535)), 0.0), 1.0); \
	return lerp3(c3, lerp3(c1, c2, tint), b.x * b.y * b.z); \
} \
fun tex_brick_f(p: float3): float { \
	p /= float3(0.9, 0.49, 0.49) / 2.0; \
	if (frac(p.y * 0.5) > 0.5) { p.x += 0.5; } \
	p = frac3(p); \
	var b: float3 = step3(p, float3(0.95, 0.9, 0.9)); \
	return lerp(1.0, 0.0, b.x * b.y * b.z); \
} \
";
	str_tex_wave="\
fun tex_wave_f(p: float3): float { \
	return 1.0 - sin((p.x + p.y) * 10.0); \
} \
";
	str_brightcontrast="\
fun brightcontrast(col: float3, bright: float, contr: float): float3 { \
	var a: float = 1.0 + contr; \
	var b: float = bright - contr * 0.5; \
	return max3(a * col + b, float3(0.0, 0.0, 0.0)); \
} \
";
	str_cotangent_frame="\
fun cotangent_frame(n: float3, p: float3, tex_coord: float2): float3x3 { \
	var duv1: float2 = ddx2(tex_coord); \
	var duv2: float2 = ddy2(tex_coord); \
	var dp1: float3 = ddx3(p); \
	var dp2: float3 = ddy3(p); \
	var dp2perp: float3 = cross(dp2, n); \
	var dp1perp: float3 = cross(n, dp1); \
	var t: float3 = dp2perp * duv1.x + dp1perp * duv2.x; \
	var b: float3 = dp2perp * duv1.y + dp1perp * duv2.y; \
	var invmax: float = rsqrt(max(dot(t, t), dot(b, b))); \
	return float3x3(t * invmax, b * invmax, n); \
} \
";
	str_transpose="\
fun _transpose(m: float3x3): float3x3 { return float3x3(m[0][0], m[1][0], m[2][0], m[0][1], m[1][1], m[2][1], m[0][2], m[1][2], m[2][2]); }\
";
	str_octahedron_wrap="\
fun octahedron_wrap(v: float2): float2 { \
	var a: float2; \
	if (v.x >= 0.0) { a.x = 1.0; } else { a.x = -1.0; } \
	if (v.y >= 0.0) { a.y = 1.0; } else { a.y = -1.0; } \
	var r: float2; \
	r.x = abs(v.y); \
	r.y = abs(v.x); \
	r.x = 1.0 - r.x; \
	r.y = 1.0 - r.y; \
	return r * a; \
} \
";
	str_pack_float_int16="\
fun pack_f32_i16(f: float, i: uint): float { \
	return 0.062504762 * f + 0.062519999 * float(i); \
} \
";
	str_create_basis="\
fun create_basis(normal: float3, out tangent: float3, out binormal: float3) { \
	tangent = normalize(camera_right - normal * dot(camera_right, normal)); \
	binormal = cross(tangent, normal); \
} \
";
	str_sh_irradiance="\
fun sh_irradiance(nor: float3): float3 { \
	var c1: float = 0.429043; \
	var c2: float = 0.511664; \
	var c3: float = 0.743125; \
	var c4: float = 0.886227; \
	var c5: float = 0.247708; \
	var cl00: float3 = float3(constants.shirr0.x, constants.shirr0.y, constants.shirr0.z); \
	var cl1m1: float3 = float3(constants.shirr0.w, constants.shirr1.x, constants.shirr1.y); \
	var cl10: float3 = float3(constants.shirr1.z, constants.shirr1.w, constants.shirr2.x); \
	var cl11: float3 = float3(constants.shirr2.y, constants.shirr2.z, constants.shirr2.w); \
	var cl2m2: float3 = float3(constants.shirr3.x, constants.shirr3.y, constants.shirr3.z); \
	var cl2m1: float3 = float3(constants.shirr3.w, constants.shirr4.x, constants.shirr4.y); \
	var cl20: float3 = float3(constants.shirr4.z, constants.shirr4.w, constants.shirr5.x); \
	var cl21: float3 = float3(constants.shirr5.y, constants.shirr5.z, constants.shirr5.w); \
	var cl22: float3 = float3(constants.shirr6.x, constants.shirr6.y, constants.shirr6.z); \
	return ( \
		cl22 * c1 * (nor.y * nor.y - (-nor.z) * (-nor.z)) + \
		cl20 * c3 * nor.x * nor.x + \
		cl00 * c4 - \
		cl20 * c5 + \
		cl2m2 * 2.0 * c1 * nor.y * (-nor.z) + \
		cl21  * 2.0 * c1 * nor.y * nor.x + \
		cl2m1 * 2.0 * c1 * (-nor.z) * nor.x + \
		cl11  * 2.0 * c2 * nor.y + \
		cl1m1 * 2.0 * c2 * (-nor.z) + \
		cl10  * 2.0 * c2 * nor.x \
	); \
} \
";
	str_envmap_equirect="\
fun envmap_equirect(normal: float3, angle: float): float2 { \
	var PI: float = 3.1415926535; \
	var PI2: float = PI * 2.0; \
	var phi: float = acos(normal.z); \
	var theta: float = atan2(-normal.y, normal.x) + PI + angle; \
	return float2(theta / PI2, phi / PI); \
} \
";
	str_envmap_sample="\
fun envmap_sample(lod: float, coord: float2): float3 { \
	if (lod == 0.0) { \
		return sample_lod(senvmap_radiance, sampler_linear, coord, 0.0).rgb; \
	} \
	if (lod == 1.0) { \
		return sample_lod(senvmap_radiance0, sampler_linear, coord, 0.0).rgb; \
	} \
	if (lod == 2.0) { \
		return sample_lod(senvmap_radiance1, sampler_linear, coord, 0.0).rgb; \
	} \
	if (lod == 3.0) { \
		return sample_lod(senvmap_radiance2, sampler_linear, coord, 0.0).rgb; \
	} \
	if (lod == 4.0) { \
		return sample_lod(senvmap_radiance3, sampler_linear, coord, 0.0).rgb; \
	} \
	return sample_lod(senvmap_radiance4, sampler_linear, coord, 0.0).rgb; \
} \
";
	str_get_pos_nor_from_depth="\
fun get_pos_from_depth(uv: float2, invVP: flaot4x4): float3 { \
	var depth: float = sample_lod(gbufferD, sampler_linear, float2(uv.x, 1.0 - uv.y), 0.0).r; \
	var wpos: float4 = float4(uv * 2.0 - 1.0, depth * 2.0 - 1.0, 1.0); \
	wpos = invVP * wpos; \
	return wpos.xyz / wpos.w; \
} \
fun get_nor_from_depth(p0: float3, uv: float2, invVP: flaot4x4, tex_step: float2): float3 { \
	var p1: float3 = get_pos_from_depth(uv + float2(tex_step.x * 4.0, 0.0), invVP); \
	var p2: float3 = get_pos_from_depth(uv + float2(0.0, tex_step.y * 4.0), invVP); \
	return normalize(cross(p2 - p0, p1 - p0)); \
} \
";
	str_get_smudge_tool_weight="\
fun get_smudge_tool_weight(i: int): float { \
	if (i == 0) { return 1.0 / 28.0; } \
	if (i == 1) { return 2.0 / 28.0; } \
	if (i == 2) { return 3.0 / 28.0; } \
	if (i == 3) { return 4.0 / 28.0; } \
	if (i == 4) { return 5.0 / 28.0; } \
	if (i == 5) { return 6.0 / 28.0; } \
	return 7.0 / 28.0; \
} \
";
	str_get_blur_tool_weight="\
fun get_blur_tool_weight(i: int): float { \
	if (i == 0) { return 0.034619 / 2.0; } \
	if (i == 1) { return 0.044859 / 2.0; } \
	if (i == 2) { return 0.055857 / 2.0; } \
	if (i == 3) { return 0.066833 / 2.0; } \
	if (i == 4) { return 0.076841 / 2.0; } \
	if (i == 5) { return 0.084894 / 2.0; } \
	if (i == 6) { return 0.090126 / 2.0; } \
	if (i == 7) { return 0.09194 / 2.0; } \
	if (i == 8) { return 0.090126 / 2.0; } \
	if (i == 9) { return 0.084894 / 2.0; } \
	if (i == 10) { return 0.076841 / 2.0; } \
	if (i == 11) { return 0.066833 / 2.0; } \
	if (i == 12) { return 0.055857 / 2.0; } \
	if (i == 13) { return 0.044859 / 2.0; } \
	return 0.034619 / 2.0; \
} \
";
	gc_unroot(tab_browser_hpath);tab_browser_hpath=ui_handle_create();gc_root(tab_browser_hpath);
	gc_unroot(tab_browser_hsearch);tab_browser_hsearch=ui_handle_create();gc_root(tab_browser_hsearch);
	tab_browser_known=false;
	tab_browser_last_path="";
	tab_layers_layer_name_edit=-1;
	gc_unroot(tab_layers_layer_name_handle);tab_layers_layer_name_handle=ui_handle_create();gc_root(tab_layers_layer_name_handle);
	tab_layers_show_context_menu=false;
	gc_unroot(tab_script_hscript);tab_script_hscript=ui_handle_create();gc_root(tab_script_hscript);
	tab_script_text_coloring=null;
	tab_swatches_drag_pos=-1;
	gc_unroot(translator_translations);translator_translations=any_map_create();gc_root(translator_translations);
	translator_cjk_font_indices=null;
	translator_last_locale="en";
	ui_base_show=true;
	ui_base_border_started=0;
	ui_base_border_handle=null;
	ui_base_action_paint_remap="";
	ui_base_operator_search_offset=0;
	ui_base_undo_tap_time=0.0;
	ui_base_redo_tap_time=0.0;
	gc_unroot(ui_base_hwnds);ui_base_hwnds=ui_base_init_hwnds();gc_root(ui_base_hwnds);
	gc_unroot(ui_base_htabs);ui_base_htabs=ui_base_init_htabs();gc_root(ui_base_htabs);
	gc_unroot(ui_base_hwnd_tabs);ui_base_hwnd_tabs=ui_base_init_hwnd_tabs();gc_root(ui_base_hwnd_tabs);
	ui_base_default_sidebar_mini_w=56;
	ui_base_default_sidebar_full_w=280;
	ui_base_default_sidebar_w=ui_base_default_sidebar_full_w;
	ui_base_tabx=0;
	gc_unroot(ui_base_hminimized);ui_base_hminimized=ui_handle_create();gc_root(ui_base_hminimized);
	ui_base_sidebar_mini_w=ui_base_default_sidebar_mini_w;
	ui_box_show=false;
	ui_box_draggable=true;
	gc_unroot(ui_box_hwnd);ui_box_hwnd=ui_handle_create();gc_root(ui_box_hwnd);
	ui_box_title="";
	ui_box_text="";
	ui_box_commands=null;
	ui_box_click_to_hide=true;
	ui_box_modalw=400;
	ui_box_modalh=170;
	ui_box_modal_on_hide=null;
	ui_box_draws=0;
	ui_box_copyable=false;
	ui_box_tween_alpha=0.0;
	ui_files_default_path="C:\\Users";
	gc_unroot(ui_files_path);ui_files_path=ui_files_default_path;gc_root(ui_files_path);
	ui_files_last_path="";
	ui_files_last_search="";
	ui_files_files=null;
	ui_files_icon_map=null;
	ui_files_icon_file_map=null;
	ui_files_selected=-1;
	ui_files_show_extensions=false;
	ui_files_offline=false;
	ui_header_default_h=28;
	ui_header_h=ui_header_default_h;
	gc_unroot(ui_header_handle);ui_header_handle=ui_handle_create();gc_root(ui_header_handle);
	gc_unroot(ui_header_worktab);ui_header_worktab=ui_handle_create();gc_root(ui_header_worktab);
	ui_menu_show=false;
	ui_menu_category=0;
	ui_menu_x=0;
	ui_menu_y=0;
	ui_menu_h=0;
	ui_menu_elements=0;
	ui_menu_keep_open=false;
	ui_menu_commands=null;
	ui_menu_show_first=true;
	ui_menu_hide_flag=false;
	ui_menubar_default_w=330;
	gc_unroot(ui_menubar_workspace_handle);ui_menubar_workspace_handle=ui_handle_create();gc_root(ui_menubar_workspace_handle);
	gc_unroot(ui_menubar_menu_handle);ui_menubar_menu_handle=ui_handle_create();gc_root(ui_menubar_menu_handle);
	ui_menubar_w=ui_menubar_default_w;
	_ui_menubar_saved_camera=mat4_nan();
	_ui_menubar_plane=null;
	ui_nodes_show=false;
	ui_nodes_canvas_type=canvas_type_t_MATERIAL;
	ui_nodes_show_menu=false;
	ui_nodes_show_menu_first=true;
	ui_nodes_hide_menu=false;
	ui_nodes_menu_category=0;
	ui_nodes_popup_x=0.0;
	ui_nodes_popup_y=0.0;
	ui_nodes_uichanged_last=false;
	ui_nodes_recompile_mat=false;
	ui_nodes_recompile_mat_final=false;
	ui_nodes_node_search_spawn=null;
	ui_nodes_node_search_offset=0;
	ui_nodes_last_canvas=null;
	ui_nodes_last_node_selected_id=-1;
	ui_nodes_release_link=false;
	ui_nodes_is_node_menu_op=false;
	ui_nodes_grid=null;
	ui_nodes_grid_redraw=true;
	ui_nodes_grid_cell_w=200;
	ui_nodes_grid_small_cell_w=40;
	gc_unroot(ui_nodes_hwnd);ui_nodes_hwnd=ui_handle_create();gc_root(ui_nodes_hwnd);
	gc_unroot(ui_nodes_group_stack);ui_nodes_group_stack=any_array_create_from_raw((any[]){},0);gc_root(ui_nodes_group_stack);
	ui_nodes_controls_down=false;
	ui_nodes_tabs=null;
	gc_unroot(ui_nodes_htab);ui_nodes_htab=ui_handle_create();gc_root(ui_nodes_htab);
	gc_unroot(_ui_nodes_htype);_ui_nodes_htype=ui_handle_create();gc_root(_ui_nodes_htype);
	gc_unroot(_ui_nodes_hname);_ui_nodes_hname=ui_handle_create();gc_root(_ui_nodes_hname);
	gc_unroot(_ui_nodes_hmin);_ui_nodes_hmin=ui_handle_create();gc_root(_ui_nodes_hmin);
	gc_unroot(_ui_nodes_hmax);_ui_nodes_hmax=ui_handle_create();gc_root(_ui_nodes_hmax);
	gc_unroot(_ui_nodes_hval0);_ui_nodes_hval0=ui_handle_create();gc_root(_ui_nodes_hval0);
	gc_unroot(_ui_nodes_hval1);_ui_nodes_hval1=ui_handle_create();gc_root(_ui_nodes_hval1);
	gc_unroot(_ui_nodes_hval2);_ui_nodes_hval2=ui_handle_create();gc_root(_ui_nodes_hval2);
	gc_unroot(_ui_nodes_hval3);_ui_nodes_hval3=ui_handle_create();gc_root(_ui_nodes_hval3);
	ui_status_default_status_h=33;
	ui_toolbar_default_w=36;
	gc_unroot(ui_toolbar_handle);ui_toolbar_handle=ui_handle_create();gc_root(ui_toolbar_handle);
	ui_toolbar_last_tool=0;
	gc_unroot(ui_toolbar_tool_names);ui_toolbar_tool_names=any_array_create_from_raw((any[]){_tr("Brush"),_tr("Eraser"),_tr("Fill"),_tr("Decal"),_tr("Text"),_tr("Clone"),_tr("Blur"),_tr("Smudge"),_tr("Particle"),_tr("ColorID"),_tr("Picker"),_tr("Bake"),_tr("Gizmo"),_tr("Material"),},14);gc_root(ui_toolbar_tool_names);
	ui_view2d_text_input_hover=false;
	ui_view2d_uvmap_show=false;
	ui_view2d_tex_type=paint_tex_t_BASE;
	ui_view2d_layer_mode=view_2d_layer_mode_t_SELECTED;
	ui_view2d_type=view_2d_type_t_LAYER;
	ui_view2d_show=false;
	gc_unroot(ui_view2d_hwnd);ui_view2d_hwnd=ui_handle_create();gc_root(ui_view2d_hwnd);
	ui_view2d_pan_x=0.0;
	ui_view2d_pan_y=0.0;
	ui_view2d_pan_scale=1.0;
	ui_view2d_tiled_show=false;
	ui_view2d_controls_down=false;
	ui_view2d_grid=null;
	ui_view2d_grid_redraw=true;
	uniforms_ext_ortho_p=mat4_ortho(-0.5,0.5,-0.5,0.5,-0.5,0.5);
	gc_unroot(util_mesh_unwrappers);util_mesh_unwrappers=any_map_create();gc_root(util_mesh_unwrappers);
	util_render_material_preview_size=256;
	util_render_decal_preview_size=512;
	util_render_layer_preview_size=200;
	util_render_font_preview_size=200;
	util_render_screen_aligned_full_vb=null;
	util_render_screen_aligned_full_ib=null;
	util_uv_uvmap=null;
	util_uv_uvmap_cached=false;
	util_uv_trianglemap=null;
	util_uv_trianglemap_cached=false;
	util_uv_dilatemap=null;
	util_uv_dilatemap_cached=false;
	util_uv_uvislandmap=null;
	util_uv_uvislandmap_cached=false;
	util_uv_dilate_bytes=null;
	util_uv_pipe_dilate=null;
	_camera_object_v=vec4_create(0.0,0.0,0.0,1.0);
	_camera_object_sphere_center=vec4_create(0.0,0.0,0.0,1.0);
	camera_object_taa_frames=1;
	const_data_screen_aligned_vb=null;
	const_data_screen_aligned_ib=null;
	const_data_skydome_vb=null;
	const_data_skydome_ib=null;
	gc_unroot(data_cached_scene_raws);data_cached_scene_raws=any_map_create();gc_root(data_cached_scene_raws);
	gc_unroot(data_cached_meshes);data_cached_meshes=any_map_create();gc_root(data_cached_meshes);
	gc_unroot(data_cached_cameras);data_cached_cameras=any_map_create();gc_root(data_cached_cameras);
	gc_unroot(data_cached_materials);data_cached_materials=any_map_create();gc_root(data_cached_materials);
	gc_unroot(data_cached_worlds);data_cached_worlds=any_map_create();gc_root(data_cached_worlds);
	gc_unroot(data_cached_shaders);data_cached_shaders=any_map_create();gc_root(data_cached_shaders);
	gc_unroot(data_cached_blobs);data_cached_blobs=any_map_create();gc_root(data_cached_blobs);
	gc_unroot(data_cached_images);data_cached_images=any_map_create();gc_root(data_cached_images);
	gc_unroot(data_cached_videos);data_cached_videos=any_map_create();gc_root(data_cached_videos);
	gc_unroot(data_cached_fonts);data_cached_fonts=any_map_create();gc_root(data_cached_fonts);
	data_assets_loaded=0;
	_input_occupied=false;
	_input_registered=false;
	gc_unroot(_mouse_buttons);_mouse_buttons=any_array_create_from_raw((any[]){"left","right","middle","side1","side2",},5);gc_root(_mouse_buttons);
	gc_unroot(_mouse_buttons_down);_mouse_buttons_down=u8_array_create_from_raw((u8[]){false,false,false,false,false,},5);gc_root(_mouse_buttons_down);
	gc_unroot(_mouse_buttons_started);_mouse_buttons_started=u8_array_create_from_raw((u8[]){false,false,false,false,false,},5);gc_root(_mouse_buttons_started);
	gc_unroot(_mouse_buttons_released);_mouse_buttons_released=u8_array_create_from_raw((u8[]){false,false,false,false,false,},5);gc_root(_mouse_buttons_released);
	mouse_x=0.0;
	mouse_y=0.0;
	mouse_moved=false;
	mouse_movement_x=0.0;
	mouse_movement_y=0.0;
	mouse_wheel_delta=0.0;
	mouse_locked=false;
	mouse_hidden=false;
	mouse_last_x=-1.0;
	mouse_last_y=-1.0;
	gc_unroot(pen_buttons);pen_buttons=any_array_create_from_raw((any[]){"tip",},1);gc_root(pen_buttons);
	gc_unroot(pen_buttons_down);pen_buttons_down=u8_array_create_from_raw((u8[]){false,},1);gc_root(pen_buttons_down);
	gc_unroot(pen_buttons_started);pen_buttons_started=u8_array_create_from_raw((u8[]){false,},1);gc_root(pen_buttons_started);
	gc_unroot(pen_buttons_released);pen_buttons_released=u8_array_create_from_raw((u8[]){false,},1);gc_root(pen_buttons_released);
	pen_x=0.0;
	pen_y=0.0;
	pen_moved=false;
	pen_movement_x=0.0;
	pen_movement_y=0.0;
	pen_pressure=0.0;
	pen_connected=false;
	pen_in_use=false;
	pen_last_x=-1.0;
	pen_last_y=-1.0;
	gc_unroot(keyboard_keys);keyboard_keys=any_array_create_from_raw((any[]){"a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","0","1","2","3","4","5","6","7","8","9","space","backspace","tab","enter","shift","control","alt","win","escape","delete","up","down","left","right","back",",",".",":",";","<","=",">","?","!","\"","#","$","%","&","_","(",")","*","|","{","}","[","]","~","`","/","\\","@","+","-","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12",},93);gc_root(keyboard_keys);
	gc_unroot(keyboard_keys_down);keyboard_keys_down=i32_map_create();gc_root(keyboard_keys_down);
	gc_unroot(keyboard_keys_started);keyboard_keys_started=i32_map_create();gc_root(keyboard_keys_started);
	gc_unroot(keyboard_keys_released);keyboard_keys_released=i32_map_create();gc_root(keyboard_keys_released);
	gc_unroot(keyboard_keys_frame);keyboard_keys_frame=any_array_create_from_raw((any[]){},0);gc_root(keyboard_keys_frame);
	keyboard_repeat_key=false;
	keyboard_repeat_time=0.0;
	gc_unroot(gamepad_buttons_ps);gamepad_buttons_ps=any_array_create_from_raw((any[]){"cross","circle","square","triangle","l1","r1","l2","r2","share","options","l3","r3","up","down","left","right","home","touchpad",},18);gc_root(gamepad_buttons_ps);
	gc_unroot(gamepad_buttons_xbox);gamepad_buttons_xbox=any_array_create_from_raw((any[]){"a","b","x","y","l1","r1","l2","r2","share","options","l3","r3","up","down","left","right","home","touchpad",},18);gc_root(gamepad_buttons_xbox);
	gc_unroot(gamepad_buttons);gamepad_buttons=gamepad_buttons_ps;gc_root(gamepad_buttons);
	gc_unroot(ui_children);ui_children=any_map_create();gc_root(ui_children);
	gc_unroot(ui_nodes_custom_buttons);ui_nodes_custom_buttons=any_map_create();gc_root(ui_nodes_custom_buttons);
	_lz4_hash_table=null;
	_material_data_uid_counter=0;
	_mesh_object_last_pipeline=null;
	gc_unroot(_mesh_object_material_contexts);_mesh_object_material_contexts=any_array_create_from_raw((any[]){},0);gc_root(_mesh_object_material_contexts);
	gc_unroot(_mesh_object_shader_contexts);_mesh_object_shader_contexts=any_array_create_from_raw((any[]){},0);gc_root(_mesh_object_shader_contexts);
	_object_uid_counter=0;
	_raycast_vp_inv=mat4_identity();
	_raycast_p_inv=mat4_identity();
	_raycast_v_inv=mat4_identity();
	render_path_commands=null;
	gc_unroot(render_path_render_targets);render_path_render_targets=any_map_create();gc_root(render_path_render_targets);
	_render_path_frame_time=0.0;
	_render_path_frame=0;
	_render_path_current_target=null;
	_render_path_current_image=null;
	_render_path_draw_order=draw_order_t_DIST;
	_render_path_paused=false;
	_render_path_last_w=0;
	_render_path_last_h=0;
	_render_path_last_frame_time=0.0;
	_render_path_loading=0;
	gc_unroot(_render_path_cached_shader_contexts);_render_path_cached_shader_contexts=any_map_create();gc_root(_render_path_cached_shader_contexts);
	_scene_uid_counter=0;
	gc_unroot(_sys_render_listeners);_sys_render_listeners=any_array_create_from_raw((any[]){},0);gc_root(_sys_render_listeners);
	gc_unroot(_sys_foreground_listeners);_sys_foreground_listeners=any_array_create_from_raw((any[]){},0);gc_root(_sys_foreground_listeners);
	gc_unroot(_sys_resume_listeners);_sys_resume_listeners=any_array_create_from_raw((any[]){},0);gc_root(_sys_resume_listeners);
	gc_unroot(_sys_pause_listeners);_sys_pause_listeners=any_array_create_from_raw((any[]){},0);gc_root(_sys_pause_listeners);
	gc_unroot(_sys_background_listeners);_sys_background_listeners=any_array_create_from_raw((any[]){},0);gc_root(_sys_background_listeners);
	gc_unroot(_sys_shutdown_listeners);_sys_shutdown_listeners=any_array_create_from_raw((any[]){},0);gc_root(_sys_shutdown_listeners);
	gc_unroot(_sys_drop_files_listeners);_sys_drop_files_listeners=any_array_create_from_raw((any[]){},0);gc_root(_sys_drop_files_listeners);
	gc_unroot(_sys_shaders);_sys_shaders=any_map_create();gc_root(_sys_shaders);
	gc_unroot(_sys_on_resets);_sys_on_resets=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_resets);
	gc_unroot(_sys_on_next_frames);_sys_on_next_frames=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_next_frames);
	gc_unroot(_sys_on_end_frames);_sys_on_end_frames=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_end_frames);
	gc_unroot(_sys_on_inits);_sys_on_inits=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_inits);
	gc_unroot(_sys_on_updates);_sys_on_updates=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_updates);
	gc_unroot(_sys_on_renders);_sys_on_renders=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_renders);
	gc_unroot(_sys_on_renders_2d);_sys_on_renders_2d=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_renders_2d);
	_sys_pause_updates=false;
	_sys_lastw=-1;
	_sys_lasth=-1;
	sys_on_resize=null;
	sys_on_w=null;
	sys_on_h=null;
	sys_on_x=null;
	sys_on_y=null;
	_sys_time_last=0.0;
	_sys_time_real_delta=0.0;
	_sys_time_frequency=-1;
	gc_unroot(_tween_anims);_tween_anims=any_array_create_from_raw((any[]){},0);gc_root(_tween_anims);
	_tween_registered=false;
	_uniforms_mat=mat4_identity();
	_uniforms_mat2=mat4_identity();
	_uniforms_mat3=mat3_identity();
	_uniforms_vec=vec4_create(0.0,0.0,0.0,1.0);
	_uniforms_vec2=vec4_create(0.0,0.0,0.0,1.0);
	_uniforms_quat=quat_create(0.0,0.0,0.0,1.0);
	uniforms_tex_links=null;
	uniforms_mat4_links=null;
	uniforms_vec4_links=null;
	uniforms_vec3_links=null;
	uniforms_vec2_links=null;
	uniforms_f32_links=null;
	uniforms_f32_array_links=null;
	uniforms_i32_links=null;
	uniforms_pos_unpack=1.0;
	uniforms_tex_unpack=1.0;
	_world_data_empty_irr=null;
	gc_unroot(float_node_def);float_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Value"),.type="float_node",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=10.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0});gc_root(float_node_def);
	gc_unroot(math_node_def);math_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Math"),.type="math_node",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("operation"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string("Add\nSubtract\nMultiply\nDivide\nPower\nLogarithm\nSquare Root\nInverse Square Root\nAbsolute\nExponent\nMinimum\nMaximum\nLess Than\nGreater Than\nSign\nRound\nFloor\nCeil\nTruncate\nFraction\nModulo\nSnap\nPing-Pong\nSine\nCosine\nTangent\nArcsine\nArccosine\nArctangent\nArctan2\nHyperbolic Sine\nHyperbolic Cosine\nHyperbolic Tangent\nTo Radians\nTo Degrees"),.min=0.0,.max=1.0,.precision=100,.height=0}),GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("use_clamp"),.type="BOOL",.output=0,.default_value=f32_array_create_x(0),.data=null,.min=0.0,.max=1.0,.precision=100,.height=0}),},2),.width=0});gc_root(math_node_def);
	random_node_d=-1;
	gc_unroot(random_node_def);random_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Random"),.type="random_node",.x=0,.y=0,.color=0xffb34f5a,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Min"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Max"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.5),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0});gc_root(random_node_def);
	gc_unroot(separate_vector_node_def);separate_vector_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Separate Vector"),.type="separate_vector_node",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("X"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Y"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Z"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.buttons=any_array_create_from_raw((any[]){},0),.width=0});gc_root(separate_vector_node_def);
	gc_unroot(time_node_def);time_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Time"),.type="time_node",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Time"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Delta"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Brush"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.buttons=any_array_create_from_raw((any[]){},0),.width=0});gc_root(time_node_def);
	gc_unroot(vector_math_node_def);vector_math_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Vector Math"),.type="vector_math_node",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Value"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("operation"),.type="ENUM",.output=0,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string("Add\nSubtract\nMultiply\nDivide\nAverage\nCross Product\nProject\nReflect\nDot Product\nDistance\nLength\nScale\nNormalize\nAbsolute\nMinimum\nMaximum\nFloor\nCeil\nFraction\nModulo\nSnap\nSine\nCosine\nTangent"),.min=0.0,.max=1.0,.precision=100,.height=0}),},1),.width=0});gc_root(vector_math_node_def);
	gc_unroot(vector_node_def);vector_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Vector"),.type="vector_node",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("X"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Y"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Z"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},3),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0});gc_root(vector_node_def);
	make_material_default_scon=null;
	make_material_default_mcon=null;
	make_material_height_used=false;
	make_material_emis_used=false;
	make_material_subs_used=false;
	make_mesh_layer_pass_count=1;
	make_mesh_preview_opacity_discard_decal=0.05;
	manifest_title="ArmorPaint";
	manifest_version="1.0 alpha";
	manifest_url="https://armorpaint.org";
	manifest_url_android="https://play.google.com/store/apps/details?id=org.armorpaint";
	manifest_url_ios="https://apps.apple.com/app/armorpaint/id1533967534";
	gc_unroot(nodes_brush_categories);nodes_brush_categories=any_array_create_from_raw((any[]){_tr("Nodes"),},1);gc_root(nodes_brush_categories);
	render_path_paint_live_layer=null;
	render_path_paint_live_layer_drawn=0;
	render_path_paint_live_layer_locked=false;
	render_path_paint_dilated=true;
	render_path_paint_painto=null;
	render_path_paint_planeo=null;
	render_path_paint_visibles=null;
	render_path_paint_merged_object_visible=false;
	render_path_paint_saved_fov=0.0;
	render_path_paint_baking=false;
	render_path_paint_last_x=-1.0;
	render_path_paint_last_y=-1.0;
	input_node_coords=vec4_create(0.0,0.0,0.0,1.0);
	input_node_start_x=0.0;
	input_node_start_y=0.0;
	input_node_lock_begin=false;
	input_node_lock_x=false;
	input_node_lock_y=false;
	input_node_lock_start_x=0.0;
	input_node_lock_start_y=0.0;
	input_node_registered=false;
	gc_unroot(input_node_def);input_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Input"),.type="input_node",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Lazy Radius"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Lazy Step"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Position"),.type="VECTOR",.color=0xff63c763,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.buttons=any_array_create_from_raw((any[]){},0),.width=0});gc_root(input_node_def);
	gc_unroot(tex_image_node_def);tex_image_node_def=GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Image Texture"),.type="TEX_IMAGE",.x=0,.y=0,.color=0xff4982a0,.inputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Vector"),.type="VECTOR",.color=0xff6363c7,.default_value=f32_array_create_xyz(0.0,0.0,0.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},1),.outputs=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Color"),.type="VALUE",.color=0xffc7c729,.default_value=f32_array_create_xyzw(0.0,0.0,0.0,1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),GC_ALLOC_INIT(ui_node_socket_t, {.id=0,.node_id=0,.name=_tr("Alpha"),.type="VALUE",.color=0xffa1a1a1,.default_value=f32_array_create_x(1.0),.min=0.0,.max=1.0,.precision=100,.display=0}),},2),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("file"),.type="ENUM",.output=-1,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string(""),.min=0.0,.max=1.0,.precision=100,.height=0}),GC_ALLOC_INIT(ui_node_button_t, {.name=_tr("color_space"),.type="ENUM",.output=-1,.default_value=f32_array_create_x(0),.data=u8_array_create_from_string("linear\nsrgb"),.min=0.0,.max=1.0,.precision=100,.height=0}),},2),.width=0});gc_root(tex_image_node_def);
	_main();
	#ifndef NO_IRON_START
	iron_start();
	#endif
}

void args_parse(){
	if(iron_get_arg_count()>1){
		args_use=true;
		i32 i=0;
		while(i<iron_get_arg_count()){
			string_t * current_arg=iron_get_arg(i);
			if(path_is_project(current_arg)){
				gc_unroot(project_filepath);project_filepath=string_copy(current_arg);gc_root(project_filepath);
			}
			else if(string_equals(current_arg,"--b")||string_equals(current_arg,"--background")){
				args_background=true;
			}
			else if(path_is_texture(current_arg)){
				gc_unroot(args_asset_path);args_asset_path=string_copy(current_arg);gc_root(args_asset_path);
			}
			else if(string_equals(current_arg,"--export-textures")&&(i+3)<=iron_get_arg_count()){
				args_export_textures=true;
				++i;
				gc_unroot(args_export_textures_type);args_export_textures_type=string_copy(iron_get_arg(i));gc_root(args_export_textures_type);
				++i;
				gc_unroot(args_export_textures_preset);args_export_textures_preset=string_copy(iron_get_arg(i));gc_root(args_export_textures_preset);
				++i;
				gc_unroot(args_export_textures_path);args_export_textures_path=string_copy(iron_get_arg(i));gc_root(args_export_textures_path);
			}
			else if(string_equals(current_arg,"--reload-mesh")){
				args_reimport_mesh=true;
			}
			else if(string_equals(current_arg,"--export-mesh")&&(i+1)<=iron_get_arg_count()){
				args_export_mesh=true;
				++i;
				gc_unroot(args_export_mesh_path);args_export_mesh_path=string_copy(iron_get_arg(i));gc_root(args_export_mesh_path);
			}
			else if(path_is_mesh(current_arg)||(i>1&&!starts_with(current_arg,"-")&&path_is_folder(current_arg))){
				gc_unroot(args_asset_path);args_asset_path=string_copy(current_arg);gc_root(args_asset_path);
			}
			else if(string_equals(current_arg,"--export-material")&&(i+1)<=iron_get_arg_count()){
				args_export_material=true;
				++i;
				gc_unroot(args_export_material_path);args_export_material_path=string_copy(iron_get_arg(i));gc_root(args_export_material_path);
			}
			++i;
		}
	}
}

void args_run(){
	if(args_use){
		sys_notify_on_init(&args_run_352		,null);
	}
}

void args_run_659(){
export_texture_run(args_export_textures_path,false);
}

void args_run_352(){
if(!string_equals(project_filepath,"")){
			import_arm_run_project(project_filepath);
		}
		else if(!string_equals(args_asset_path,"")){
			import_asset_run(args_asset_path,-1,-1,false,true,null);
			if(path_is_texture(args_asset_path)){
				ui_base_show_2d_view(view_2d_type_t_ASSET);
			}
		}
		else if(args_reimport_mesh){
			project_reimport_mesh();
		}
		if(args_export_textures){
			if(string_equals(args_export_textures_type,"png")||string_equals(args_export_textures_type,"jpg")||string_equals(args_export_textures_type,"exr16")||string_equals(args_export_textures_type,"exr32")){
				if(path_is_folder(args_export_textures_path)){
					if(string_equals(args_export_textures_type,"png")){
						base_bits_handle->position=texture_bits_t_BITS8;
						context_raw->format_type=texture_ldr_format_t_PNG;
					}
					else if(string_equals(args_export_textures_type,"jpg")){
						base_bits_handle->position=texture_bits_t_BITS8;
						context_raw->format_type=texture_ldr_format_t_JPG;
					}
					else if(string_equals(args_export_textures_type,"exr16")){
						base_bits_handle->position=texture_bits_t_BITS16;
					}
					else if(string_equals(args_export_textures_type,"exr32")){
						base_bits_handle->position=texture_bits_t_BITS32;
					}
					context_raw->layers_export=export_mode_t_VISIBLE;
					gc_unroot(box_export_files);box_export_files=file_read_directory(string_join(string_join(path_data(),path_sep),"export_presets"));gc_root(box_export_files);
					for(i32 i=0;i<box_export_files->length;++i){
						string_t * s=box_export_files->buffer[i];
						box_export_files->buffer[i]=substring(s,0,string_length(s)-5);
					}
					string_t * file=string_join(string_join("export_presets/",box_export_files->buffer[0]),".json");
					for(i32 i=0;i<box_export_files->length;++i){
						string_t * f=box_export_files->buffer[i];
						if(string_equals(f,args_export_textures_preset)){
							file=string_join(string_join("export_presets/",box_export_files->buffer[array_index_of(box_export_files,f)]),".json");
						}
					}
					buffer_t * blob=data_get_blob(file);
					gc_unroot(box_export_preset);box_export_preset=json_parse(sys_buffer_to_string(blob));gc_root(box_export_preset);
					data_delete_blob(string_join("export_presets/",file));
					sys_notify_on_init(&args_run_659					,null);
				}
				else {
					iron_log(tr("Invalid export directory",null));
				}
			}
			else {
				iron_log(tr("Invalid texture type",null));
			}
		}
		else if(args_export_mesh){
			if(path_is_folder(args_export_mesh_path)){
				string_t * f=ui_files_filename;
				if(string_equals(f,"")){
					f=string_copy(tr("untitled",null));
				}
				export_mesh_run(string_join(string_join(args_export_mesh_path,path_sep),f),null,false,true);
			}
			else {
				iron_log(tr("Invalid export directory",null));
			}
		}
		else if(args_export_material){
			context_raw->write_icon_on_export=true;
			export_arm_run_material(args_export_material_path);
		}
		if(args_background){
			iron_stop();
		}
}

void base_init(){
	base_last_window_width=iron_window_width();
	base_last_window_height=iron_window_height();
	sys_notify_on_drop_files(&base_init_1048	);
	sys_notify_on_app_state(&base_init_1074	,&base_init_1092,&base_init_1098,&base_init_1104	,&base_init_1120);
	iron_set_save_and_quit_callback(base_save_and_quit_callback);
	draw_font_t * font=data_get_font("font.ttf");
	gpu_texture_t * image_color_wheel=data_get_image("color_wheel.k");
	gpu_texture_t * image_color_wheel_gradient=data_get_image("color_wheel_gradient.k");
	gc_unroot(base_font);base_font=font;gc_root(base_font);
	config_load_theme(config_raw->theme,false);
	base_default_element_w=base_theme->ELEMENT_W;
	base_default_element_h=base_theme->ELEMENT_H;
	base_default_font_size=base_theme->FONT_SIZE;
	translator_load_translations(config_raw->locale);
	gc_unroot(ui_files_filename);ui_files_filename=string_copy(tr("untitled",null));gc_root(ui_files_filename);
	if(string_equals(config_raw->locale,"en")){
		draw_font_13(base_font);
	}
	else {
		draw_font_init(base_font);
	}
	gc_unroot(base_color_wheel);base_color_wheel=image_color_wheel;gc_root(base_color_wheel);
	gc_unroot(base_color_wheel_gradient);base_color_wheel_gradient=image_color_wheel_gradient;gc_root(base_color_wheel_gradient);
	gc_unroot(ui_nodes_enum_texts);ui_nodes_enum_texts=base_enum_texts;gc_root(ui_nodes_enum_texts);
	ui_options_t * ops=GC_ALLOC_INIT(ui_options_t, {.theme=base_theme,.font=font,.scale_factor=config_raw->window_scale,.color_wheel=base_color_wheel,.black_white_gradient=base_color_wheel_gradient});
	gc_unroot(base_ui_box);base_ui_box=ui_create(ops);gc_root(base_ui_box);
	gc_unroot(base_ui_menu);base_ui_menu=ui_create(ops);gc_root(base_ui_menu);
	if(config_raw->plugins!=null){
		for(i32 i=0;i<config_raw->plugins->length;++i){
			string_t * plugin=config_raw->plugins->buffer[i];
			plugin_start(plugin);
		}
	}
	args_parse();
	camera_init();
	ui_base_init();
	ui_viewnodes_init();
	ui_view2d_init();
	base_ext_init();
	sys_notify_on_update(base_update,null);
	sys_notify_on_render_2d(ui_view2d_render,null);
	sys_notify_on_update(ui_view2d_update,null);
	sys_notify_on_render_2d(ui_base_render_cursor,null);
	sys_notify_on_update(ui_nodes_update,null);
	sys_notify_on_render_2d(ui_nodes_render,null);
	sys_notify_on_update(ui_base_update,null);
	sys_notify_on_render_2d(ui_base_render,null);
	sys_notify_on_update(camera_update,null);
	sys_notify_on_render_2d(base_render,null);
	base_appx=ui_toolbar_w(true);
	base_appy=0;
	if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
		base_appy=ui_header_h*2;
	}
	camera_object_t * cam=scene_camera;
	cam->data->fov=math_floor(cam->data->fov*100)/(float)100;
	camera_object_build_proj(cam,-1.0);
	args_run();
	bool has_projects=config_raw->recent_projects->length>0;
	if(config_raw->splash_screen&&has_projects){
		box_projects_show();
	}
}

void base_init_1120(){
}

void base_init_1104(){
keyboard_up_listener(key_code_t_ALT);
	keyboard_up_listener(key_code_t_WIN);
}

void base_init_1098(){
}

void base_init_1092(){
}

void base_init_1074(){
context_raw->foreground_event=true;
	context_raw->last_paint_x=-1;
	context_raw->last_paint_y=-1;
}

void base_init_1048(string_t * drop_path){
drop_path=string_copy(trim_end(drop_path));
	any_array_push(base_drop_paths,drop_path);
}

void base_save_and_quit_callback(bool save){
	base_save_window_rect();
	if(save){
		project_save(true);
	}
	else {
		iron_stop();
	}
}

i32 base_w(){
	if(context_raw->material_preview){
		return util_render_material_preview_size;
	}
	if(context_raw->decal_preview){
		return util_render_decal_preview_size;
	}
	i32 res=0;
	if(config_raw->layout==null){
		i32 sidebarw=ui_base_default_sidebar_w;
		res=iron_window_width()-sidebarw-ui_toolbar_default_w;
	}
	else if(ui_nodes_show||ui_view2d_show){
		res=iron_window_width()-config_raw->layout->buffer[layout_size_t_SIDEBAR_W]-config_raw->layout->buffer[layout_size_t_NODES_W]-ui_toolbar_w(true);
	}
	else if(ui_base_show){
		res=iron_window_width()-config_raw->layout->buffer[layout_size_t_SIDEBAR_W]-ui_toolbar_w(true);
	}
	else {
		res=iron_window_width();
	}
	if(context_raw->view_index>-1){
		res=math_floor(res/(float)2);
	}
	if(context_raw->paint2d_view){
		res=ui_view2d_ww;
	}
	return res>0?res:1;
}

i32 base_h(){
	if(context_raw->material_preview){
		return util_render_material_preview_size;
	}
	if(context_raw->decal_preview){
		return util_render_decal_preview_size;
	}
	i32 res=iron_window_height();
	if(config_raw->layout==null){
		res-=ui_header_default_h*2+ui_status_default_status_h;
	}
	else if(ui_base_show&&res>0){
		i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
		res-=math_floor(ui_header_default_h*2*config_raw->window_scale)+statush;
		if(config_raw->layout->buffer[layout_size_t_HEADER]==0){
			res+=ui_header_h*2;
		}
	}
	return res>0?res:1;
}

i32 base_x(){
	return context_raw->view_index==1?base_appx+base_w():base_appx;
}

i32 base_y(){
	return base_appy;
}

void base_on_resize(){
	if(iron_window_width()==0||iron_window_height()==0){
		return ;
	}
	f32 ratio_w=iron_window_width()/(float)base_last_window_width;
	base_last_window_width=iron_window_width();
	f32 ratio_h=iron_window_height()/(float)base_last_window_height;
	base_last_window_height=iron_window_height();
	config_raw->layout->buffer[layout_size_t_NODES_W]=math_floor(config_raw->layout->buffer[layout_size_t_NODES_W]*ratio_w);
	config_raw->layout->buffer[layout_size_t_SIDEBAR_H0]=math_floor(config_raw->layout->buffer[layout_size_t_SIDEBAR_H0]*ratio_h);
	config_raw->layout->buffer[layout_size_t_SIDEBAR_H1]=iron_window_height()-config_raw->layout->buffer[layout_size_t_SIDEBAR_H0];
	base_resize();
	base_save_window_rect();
}

void base_save_window_rect(){
	config_raw->window_w=iron_window_width();
	config_raw->window_h=iron_window_height();
	config_raw->window_x=iron_window_x();
	config_raw->window_y=iron_window_y();
	config_save();
}

void base_resize(){
	if(iron_window_width()==0||iron_window_height()==0){
		return ;
	}
	camera_object_t * cam=scene_camera;
	if(cam->data->ortho!=null){
		cam->data->ortho->buffer[2]=-2*(sys_h()/(float)sys_w());
		cam->data->ortho->buffer[3]=2*(sys_h()/(float)sys_w());
	}
	camera_object_build_proj(cam,-1.0);
	if(context_raw->camera_type==camera_type_t_ORTHOGRAPHIC){
		viewport_update_camera_type(context_raw->camera_type);
	}
	context_raw->ddirty=2;
	if(ui_base_show){
		base_appx=ui_toolbar_w(true);
		base_appy=0;
		if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
			base_appy=ui_header_h*2;
		}
	}
	else {
		base_appx=0;
		base_appy=0;
	}
	ui_nodes_grid_redraw=true;
	ui_view2d_grid_redraw=true;
	base_redraw_ui();
}

void base_redraw_ui(){
	ui_header_handle->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
	ui_menubar_menu_handle->redraws=2;
	ui_menubar_workspace_handle->redraws=2;
	ui_nodes_hwnd->redraws=2;
	ui_box_hwnd->redraws=2;
	ui_view2d_hwnd->redraws=2;
	if(context_raw->ddirty<0){
		context_raw->ddirty=0;
	}
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	ui_toolbar_handle->redraws=2;
	if(context_raw->split_view){
		context_raw->ddirty=1;
	}
}

void base_update(){
	if(mouse_movement_x!=0||mouse_movement_y!=0){
		iron_set_mouse_cursor(0);
	}
	bool has_drag=base_drag_asset!=null||base_drag_material!=null||base_drag_layer!=null||base_drag_file!=null||base_drag_swatch!=null;
	if(config_raw->touch_ui){
		if(base_drag_start<0.2){
			if(has_drag&&mouse_down("left")){
				base_drag_start+=sys_real_delta();
			}
			else {
				base_drag_start=0;
			}
			has_drag=false;
		}
		if(mouse_released("left")){
			base_drag_start=0;
		}
		bool moved=math_abs(mouse_movement_x)>1&&math_abs(mouse_movement_y)>1;
		if((mouse_released("left")||moved)&&!has_drag){
			gc_unroot(base_drag_asset);base_drag_asset=null;
			gc_unroot(base_drag_swatch);base_drag_swatch=null;
			gc_unroot(base_drag_file);base_drag_file=null;
			gc_unroot(base_drag_file_icon);base_drag_file_icon=null;
			base_is_dragging=false;
			gc_unroot(base_drag_material);base_drag_material=null;
			gc_unroot(base_drag_layer);base_drag_layer=null;
		}
		ui_touch_scroll=!base_is_dragging;
	}
	if(has_drag&&(mouse_movement_x!=0||mouse_movement_y!=0)){
		base_is_dragging=true;
	}
	if(mouse_released("left")&&has_drag){
		if(base_drag_asset!=null){
			if(context_in_nodes()){
				ui_nodes_accept_asset_drag(array_index_of(project_assets,base_drag_asset));
			}
			else if(context_in_viewport()){
				if(ends_with(to_lower_case(base_drag_asset->file),".hdr")){
					gpu_texture_t * image=project_get_image(base_drag_asset);
					import_envmap_run(base_drag_asset->file,image);
				}
			}
			else if(context_in_layers()||context_in_2d_view(view_2d_type_t_LAYER)){
				layers_create_image_mask(base_drag_asset);
			}
			gc_unroot(base_drag_asset);base_drag_asset=null;
		}
		else if(base_drag_swatch!=null){
			if(context_in_nodes()){
				ui_nodes_accept_swatch_drag(base_drag_swatch);
			}
			else if(context_in_swatches()){
				tab_swatches_accept_swatch_drag(base_drag_swatch);
			}
			else if(context_in_materials()){
				tab_materials_accept_swatch_drag(base_drag_swatch);
			}
			else if(context_in_viewport()){
				i32 color=base_drag_swatch->base;
				color=color_set_ab(color,base_drag_swatch->opacity*255);
				layers_create_color_layer(color,base_drag_swatch->occlusion,base_drag_swatch->roughness,base_drag_swatch->metallic,-1);
			}
			else if(context_in_layers()&&tab_layers_can_drop_new_layer(context_raw->drag_dest)){
				i32 color=base_drag_swatch->base;
				color=color_set_ab(color,base_drag_swatch->opacity*255);
				layers_create_color_layer(color,base_drag_swatch->occlusion,base_drag_swatch->roughness,base_drag_swatch->metallic,context_raw->drag_dest);
			}
			gc_unroot(base_drag_swatch);base_drag_swatch=null;
		}
		else if(base_drag_file!=null){
			if(!context_in_browser()){
				base_drop_x=mouse_x;
				base_drop_y=mouse_y;
				_base_material_count=project_materials->length;
				import_asset_run(base_drag_file,base_drop_x,base_drop_y,true,true,&base_update_2629				);
			}
			gc_unroot(base_drag_file);base_drag_file=null;
			gc_unroot(base_drag_file_icon);base_drag_file_icon=null;
		}
		else if(base_drag_material!=null){
			base_material_dropped();
		}
		else if(base_drag_layer!=null){
			if(context_in_nodes()){
				ui_nodes_accept_layer_drag(array_index_of(project_layers,base_drag_layer));
			}
			else if(context_in_layers()&&base_is_dragging){
				slot_layer_move(base_drag_layer,context_raw->drag_dest);
				make_material_parse_mesh_material();
			}
			gc_unroot(base_drag_layer);base_drag_layer=null;
		}
		iron_set_mouse_cursor(0);
		base_is_dragging=false;
	}
	if(context_raw->color_picker_callback!=null&&(mouse_released("left")||mouse_released("right"))){
		context_raw->color_picker_callback=null;
		context_select_tool(context_raw->color_picker_previous_tool);
	}
	base_handle_drop_paths();
	bool is_picker=context_is_picker();
	bool decal=context_is_decal();
	ui_always_redraw_window=ui_menu_show||ui_box_show||base_is_dragging||is_picker||decal||ui_view2d_show||!config_raw->brush_3d||context_raw->frame<3;
	if(ui_always_redraw_window&&context_raw->ddirty<0){
		context_raw->ddirty=0;
	}
	base_ext_update();
	compass_update();
}

void base_update_2629(){
if(project_materials->length>_base_material_count){
					gc_unroot(base_drag_material);base_drag_material=context_raw->material;gc_root(base_drag_material);
					base_material_dropped();
				}
}

void base_material_dropped(){
	if(context_in_viewport()){
		uv_type_t uv_type=keyboard_down("control")?uv_type_t_PROJECT:uv_type_t_UVMAP;
		mat4_t decal_mat=uv_type==uv_type_t_PROJECT?util_render_get_decal_mat():mat4_nan();
		layers_create_fill_layer(uv_type,decal_mat,-1);
	}
	if(context_in_layers()&&tab_layers_can_drop_new_layer(context_raw->drag_dest)){
		uv_type_t uv_type=keyboard_down("control")?uv_type_t_PROJECT:uv_type_t_UVMAP;
		mat4_t decal_mat=uv_type==uv_type_t_PROJECT?util_render_get_decal_mat():mat4_nan();
		layers_create_fill_layer(uv_type,decal_mat,context_raw->drag_dest);
	}
	else if(context_in_nodes()){
		ui_nodes_accept_material_drag(array_index_of(project_materials,base_drag_material));
	}
	gc_unroot(base_drag_material);base_drag_material=null;
}

void base_handle_drop_paths(){
	if(base_drop_paths->length>0){
		bool wait=false;
		if(!wait){
			base_drop_x=mouse_x;
			base_drop_y=mouse_y;
			string_t * drop_path=array_shift(base_drop_paths);
			import_asset_run(drop_path,base_drop_x,base_drop_y,true,true,null);
		}
	}
}

rect_t * base_get_drag_background(){
	gpu_texture_t * icons=resource_get("icons.k");
	if(base_drag_layer!=null&&!slot_layer_is_group(base_drag_layer)&&base_drag_layer->fill_layer==null){
		return resource_tile50(icons,4,1);
	}
	return null;
}

gpu_texture_t * base_get_drag_image(){
	base_drag_tint=0xffffffff;
	base_drag_size=-1;
	gc_unroot(base_drag_rect);base_drag_rect=null;
	if(base_drag_asset!=null){
		return project_get_image(base_drag_asset);
	}
	if(base_drag_swatch!=null){
		base_drag_tint=base_drag_swatch->base;
		base_drag_size=26;
		return tab_swatches_empty_get();
	}
	if(base_drag_file!=null){
		if(base_drag_file_icon!=null){
			return base_drag_file_icon;
		}
		gpu_texture_t * icons=resource_get("icons.k");
		gc_unroot(base_drag_rect);base_drag_rect=string_index_of(base_drag_file,".")>0?resource_tile50(icons,3,1):resource_tile50(icons,2,1);gc_root(base_drag_rect);
		base_drag_tint=ui_base_ui->ops->theme->HIGHLIGHT_COL;
		return icons;
	}
	if(base_drag_material!=null){
		return base_drag_material->image_icon;
	}
	if(base_drag_layer!=null&&slot_layer_is_group(base_drag_layer)){
		gpu_texture_t * icons=resource_get("icons.k");
		rect_t * folder_closed=resource_tile50(icons,2,1);
		rect_t * folder_open=resource_tile50(icons,8,1);
		gc_unroot(base_drag_rect);base_drag_rect=base_drag_layer->show_panel?folder_open:folder_closed;gc_root(base_drag_rect);
		base_drag_tint=ui_base_ui->ops->theme->LABEL_COL-0x00202020;
		return icons;
	}
	if(base_drag_layer!=null&&slot_layer_is_mask(base_drag_layer)&&base_drag_layer->fill_layer==null){
		tab_layers_make_mask_preview_rgba32(base_drag_layer);
		return context_raw->mask_preview_rgba32;
	}
	if(base_drag_layer!=null){
		return base_drag_layer->fill_layer!=null?base_drag_layer->fill_layer->image_icon:base_drag_layer->texpaint_preview;
	}
	return null;
}

void base_render(){
	if(iron_window_width()==0||iron_window_height()==0){
		return ;
	}
	base_ext_render();
	if(context_raw->frame==2){
		make_material_parse_mesh_material();
		make_material_parse_paint_material(true);
		context_raw->ddirty=0;
		if(config_raw->workspace!=0){
			ui_header_worktab->position=config_raw->workspace;
			ui_menubar_workspace_handle->redraws=2;
			ui_header_worktab->changed=true;
		}
		context_raw->camera_controls=config_raw->camera_controls;
	}
	else if(context_raw->frame==3){
		context_raw->ddirty=3;
	}
	context_raw->frame++;
	if(base_is_dragging){
		iron_set_mouse_cursor(1);
		gpu_texture_t * img=base_get_drag_image();
		f32 scale_factor=ui_SCALE(ui_base_ui);
		f32 size=(base_drag_size==-1?50:base_drag_size)*scale_factor;
		f32 ratio=size/(float)img->width;
		f32 h=img->height*ratio;
		i32 inv=0;
		draw_begin(null,false,0);
		draw_set_color(base_drag_tint);
		rect_t * bg_rect=base_get_drag_background();
		if(bg_rect!=null){
			draw_scaled_sub_image(resource_get("icons.k"),bg_rect->x,bg_rect->y,bg_rect->w,bg_rect->h,mouse_x+base_drag_off_x,mouse_y+base_drag_off_y+inv,size,h-inv*2);
		}
		base_drag_rect==null?draw_scaled_image(img,mouse_x+base_drag_off_x,mouse_y+base_drag_off_y+inv,size,h-inv*2):draw_scaled_sub_image(img,base_drag_rect->x,base_drag_rect->y,base_drag_rect->w,base_drag_rect->h,mouse_x+base_drag_off_x,mouse_y+base_drag_off_y+inv,size,h-inv*2);
		draw_set_color(0xffffffff);
		draw_end();
	}
	bool using_menu=ui_menu_show&&mouse_y>ui_header_h;
	base_ui_enabled=!ui_box_show&&!using_menu&&!base_is_combo_selected();
	if(ui_box_show){
		ui_box_render();
	}
	if(ui_menu_show){
		ui_menu_render();
	}
	context_raw->last_paint_vec_x=context_raw->paint_vec.x;
	context_raw->last_paint_vec_y=context_raw->paint_vec.y;
}

string_t_array_t * base_enum_texts(string_t * node_type){
	if(string_equals(node_type,"TEX_IMAGE")){
		if(project_asset_names->length>0){
			return project_asset_names;
		}
		else {
			string_t_array_t * empty=any_array_create_from_raw((any[]){"",},1);
			return empty;
		}
	}
	if(string_equals(node_type,"LAYER")||string_equals(node_type,"LAYER_MASK")){
		string_t_array_t * layer_names=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			any_array_push(layer_names,l->name);
		}
		return layer_names;
	}
	if(string_equals(node_type,"MATERIAL")){
		string_t_array_t * material_names=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<project_materials->length;++i){
			slot_material_t * m=project_materials->buffer[i];
			any_array_push(material_names,m->canvas->name);
		}
		return material_names;
	}
	if(string_equals(node_type,"image_texture_node")){
		if(project_asset_names->length>0){
			return project_asset_names;
		}
		else {
			string_t_array_t * empty=any_array_create_from_raw((any[]){"",},1);
			return empty;
		}
	}
	return null;
}

i32 base_get_asset_index(string_t * file_name){
	i32 i=char_ptr_array_index_of(project_asset_names,file_name);
	return i>=0?i:0;
}

void base_toggle_fullscreen(){
	if(iron_window_get_mode()==window_mode_t_WINDOWED){
		config_raw->window_w=iron_window_width();
		config_raw->window_h=iron_window_height();
		config_raw->window_x=iron_window_x();
		config_raw->window_y=iron_window_y();
		iron_set_window_mode(window_mode_t_FULLSCREEN);
	}
	else {
		iron_set_window_mode(window_mode_t_WINDOWED);
		iron_window_resize(config_raw->window_w,config_raw->window_h);
		iron_window_move(config_raw->window_x,config_raw->window_y);
	}
}

bool base_is_scrolling(){
	for(i32 i=0;i<base_get_uis()->length;++i){
		ui_t * ui=base_get_uis()->buffer[i];
		if(ui->is_scrolling){
			return true;
		}
	}
	return false;
}

bool base_is_combo_selected(){
	for(i32 i=0;i<base_get_uis()->length;++i){
		ui_t * ui=base_get_uis()->buffer[i];
		if(ui->combo_selected_handle!=null){
			return true;
		}
	}
	return false;
}

ui_t_array_t * base_get_uis(){
	ui_t_array_t * uis=any_array_create_from_raw((any[]){base_ui_box,base_ui_menu,ui_base_ui,ui_nodes_ui,ui_view2d_ui,},5);
	return uis;
}

bool base_is_decal_layer(){
	bool is_painting=context_raw->tool!=workspace_tool_t_MATERIAL&&context_raw->tool!=workspace_tool_t_BAKE;
	return is_painting&&context_raw->layer->fill_layer!=null&&context_raw->layer->uv_type==uv_type_t_PROJECT;
}

void base_redraw_status(){
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
}

void base_redraw_console(){
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_base_ui!=null&&statush>ui_status_default_status_h*ui_SCALE(ui_base_ui)){
		ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
	}
}

void base_init_undo_layers(){
	if(history_undo_layers==null){
		gc_unroot(history_undo_layers);history_undo_layers=any_array_create_from_raw((any[]){},0);gc_root(history_undo_layers);
		for(i32 i=0;i<config_raw->undo_steps;++i){
			i32 len=history_undo_layers->length;
			string_t * ext=string_join("_undo",i32_to_string(len));
			slot_layer_t * l=slot_layer_create(ext,layer_slot_type_t_LAYER,null);
			any_array_push(history_undo_layers,l);
		}
	}
}

void base_init_layout(){
	config_t * raw=config_raw;
	bool show2d=(ui_nodes_show||ui_view2d_show)&&raw->layout!=null;
	i32_array_t * new_layout=i32_array_create_from_raw((i32[]){},0);
	i32_array_push(new_layout,math_floor(ui_base_default_sidebar_w*raw->window_scale));
	i32_array_push(new_layout,math_floor(iron_window_height()/(float)2));
	i32_array_push(new_layout,math_floor(iron_window_height()/(float)2));
	i32_array_push(new_layout,show2d?math_floor((sys_w()+raw->layout->buffer[layout_size_t_NODES_W])*0.515):math_floor(sys_w()*0.515));
	i32_array_push(new_layout,math_floor(sys_h()/(float)2));
	i32_array_push(new_layout,math_floor(ui_status_default_status_h*raw->window_scale));
	i32_array_push(new_layout,1);
	raw->layout_tabs=i32_array_create_from_raw((i32[]){0,0,0,},3);
	raw->layout=new_layout;
}

void base_init_config(){
	config_t * raw=config_raw;
	raw->recent_projects=any_array_create_from_raw((any[]){},0);
	raw->bookmarks=any_array_create_from_raw((any[]){},0);
	raw->plugins=any_array_create_from_raw((any[]){},0);
	raw->keymap="default.json";
	raw->theme="default.json";
	raw->server="https://armorpaint.fra1.digitaloceanspaces.com";
	raw->undo_steps=4;
	raw->pressure_radius=true;
	raw->pressure_sensitivity=1.0;
	raw->camera_zoom_speed=1.0;
	raw->camera_pan_speed=1.0;
	raw->camera_rotation_speed=1.0;
	raw->zoom_direction=zoom_direction_t_VERTICAL;
	raw->displace_strength=0.0;
	raw->wrap_mouse=false;
	raw->workspace=space_type_t_SPACE3D;
	raw->camera_controls=camera_controls_t_ORBIT;
	raw->layer_res=texture_res_t_RES2048;
	raw->touch_ui=false;
	raw->splash_screen=false;
	raw->node_preview=true;
	raw->pressure_hardness=true;
	raw->pressure_angle=false;
	raw->pressure_opacity=false;
	raw->material_live=true;
	raw->brush_3d=true;
	raw->brush_depth_reject=true;
	raw->brush_angle_reject=true;
	raw->brush_live=false;
	raw->show_asset_names=false;
	raw->dilate=dilate_type_t_INSTANT;
	raw->dilate_radius=2;
	raw->gpu_inference=true;
	raw->blender="";
	raw->atlas_res=0;
	raw->pathtrace_mode=pathtrace_mode_t_FAST;
	raw->grid_snap=false;
	base_ext_init_config(raw);
}

void box_export_show_textures(){
	ui_box_show_custom(&box_export_show_textures_4694	,540,310,null,true);
}

void box_export_show_textures_4694(ui_t * ui){
if(box_export_files==null){
		box_export_fetch_presets();
		box_export_hpreset->position=char_ptr_array_index_of(box_export_files,"generic");
	}
	if(box_export_preset==null){
		box_export_parse_preset();
		box_export_hpreset->children=null;
	}
	box_export_tab_export_textures(ui,tr("Export Textures",null),false);
	box_export_tab_presets(ui);
	box_export_tab_atlases(ui);
}

void box_export_show_bake_material(){
	ui_box_show_custom(&box_export_show_bake_material_4773	,540,310,null,true);
}

void box_export_show_bake_material_4773(ui_t * ui){
if(box_export_files==null){
		box_export_fetch_presets();
		box_export_hpreset->position=char_ptr_array_index_of(box_export_files,"generic");
	}
	if(box_export_preset==null){
		box_export_parse_preset();
		box_export_hpreset->children=null;
	}
	box_export_tab_export_textures(ui,tr("Bake to Textures",null),true);
	box_export_tab_presets(ui);
}

void box_export_tab_export_textures(ui_t * ui,string_t * title,bool bake_material){
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(box_export_htab,title,tab_vertical,-1)){
		ui_row2();
		string_t_array_t * base_res_combo=any_array_create_from_raw((any[]){"128","256","512","1K","2K","4K","8K","16K",},8);
		ui_combo(base_res_handle,base_res_combo,tr("Resolution",null),true,ui_align_t_LEFT,true);
		if(base_res_handle->changed){
			layers_on_resized();
		}
		string_t_array_t * base_bits_combo=any_array_create_from_raw((any[]){"8bit","16bit","32bit",},3);
		ui_combo(base_bits_handle,base_bits_combo,tr("Color",null),true,ui_align_t_LEFT,true);
		if(base_bits_handle->changed){
			sys_notify_on_init(layers_set_bits,null);
		}
		ui_row2();
		if(base_bits_handle->position==texture_bits_t_BITS8){
			ui_handle_t * h=ui_handle("box_export.ts:109");
			if(h->init){
				h->position=context_raw->format_type;
			}
			string_t_array_t * format_combo=any_array_create_from_raw((any[]){"png","jpg",},2);
			context_raw->format_type=ui_combo(h,format_combo,tr("Format",null),true,ui_align_t_LEFT,true);
		}
		else {
			ui_handle_t * h=ui_handle("box_export.ts:117");
			if(h->init){
				h->position=context_raw->format_type;
			}
			string_t_array_t * format_combo=any_array_create_from_raw((any[]){"exr",},1);
			context_raw->format_type=ui_combo(h,format_combo,tr("Format",null),true,ui_align_t_LEFT,true);
		}
		ui->enabled=context_raw->format_type==texture_ldr_format_t_JPG&&base_bits_handle->position==texture_bits_t_BITS8;
		ui_handle_t * h_quality=ui_handle("box_export.ts:128");
		if(h_quality->init){
			h_quality->value=context_raw->format_quality;
		}
		context_raw->format_quality=ui_slider(h_quality,tr("Quality",null),0.0,100.0,true,1,true,ui_align_t_RIGHT,true);
		ui->enabled=true;
		ui_row2();
		ui->enabled=!bake_material;
		ui_handle_t * layers_export_handle=ui_handle("box_export.ts:139");
		layers_export_handle->position=context_raw->layers_export;
		string_t_array_t * layers_export_combo=any_array_create_from_raw((any[]){tr("Visible",null),tr("Selected",null),tr("Per Object",null),tr("Per Udim Tile",null),},4);
		context_raw->layers_export=ui_combo(layers_export_handle,layers_export_combo,tr("Layers",null),true,ui_align_t_LEFT,true);
		ui->enabled=true;
		ui_combo(box_export_hpreset,box_export_files,tr("Preset",null),true,ui_align_t_LEFT,true);
		if(box_export_hpreset->changed){
			gc_unroot(box_export_preset);box_export_preset=null;
		}
		ui_handle_t * layers_destination_handle=ui_handle("box_export.ts:151");
		layers_destination_handle->position=context_raw->layers_destination;
		string_t_array_t * layers_destination_combo=any_array_create_from_raw((any[]){tr("Disk",null),tr("Packed",null),},2);
		context_raw->layers_destination=ui_combo(layers_destination_handle,layers_destination_combo,tr("Destination",null),true,ui_align_t_LEFT,true);
		_ui_end_element(-1.0);
		ui_row2();
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_box_hide();
			if(context_raw->layers_destination==export_destination_t_PACKED){
				_box_export_bake_material=bake_material;
				context_raw->texture_export_path="/";
				sys_notify_on_init(&box_export_tab_export_textures_5338				,null);
			}
			else {
				string_t * filters=base_bits_handle->position!=texture_bits_t_BITS8?"exr":context_raw->format_type==texture_ldr_format_t_PNG?"png":"jpg";
				_box_export_bake_material=bake_material;
				ui_files_show(filters,true,false,&box_export_tab_export_textures_5386				);
			}
		}
		if(ui->is_hovered){
			string_t * key=any_map_get(config_keymap,"file_export_textures");
			string_t * tip=string_join(string_join(string_join(tr("Export texture files",null)," ("),key),")");
			ui_tooltip(tip);
		}
	}
}

void box_export_tab_export_textures_5399(){
export_texture_run(context_raw->texture_export_path,_box_export_bake_material);
}

void box_export_tab_export_textures_5386(string_t * path){
context_raw->texture_export_path=string_copy(path);
				sys_notify_on_init(&box_export_tab_export_textures_5399				,null);
}

void box_export_tab_export_textures_5338(){
export_texture_run(context_raw->texture_export_path,_box_export_bake_material);
}

void box_export_tab_presets(ui_t * ui){
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(box_export_htab,tr("Presets",null),tab_vertical,-1)){
		f32_array_t * row=f32_array_create_from_raw((f32[]){3/(float)5,1/(float)5,1/(float)5,},3);
		ui_row(row);
		ui_combo(box_export_hpreset,box_export_files,tr("Preset",null),false,ui_align_t_LEFT,true);
		if(box_export_hpreset->changed){
			gc_unroot(box_export_preset);box_export_preset=null;
		}
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
			ui_box_show_custom(&box_export_tab_presets_5550			,400,200,null,true);
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_files_show("json",false,false,&box_export_tab_presets_5693			);
		}
		if(box_export_preset==null){
			box_export_parse_preset();
			box_export_hpreset->children=null;
		}
		ui_separator(10,false);
		ui_row6();
		ui_text(tr("Texture",null),ui_align_t_LEFT,0x00000000);
		ui_text(tr("R",null),ui_align_t_LEFT,0x00000000);
		ui_text(tr("G",null),ui_align_t_LEFT,0x00000000);
		ui_text(tr("B",null),ui_align_t_LEFT,0x00000000);
		ui_text(tr("A",null),ui_align_t_LEFT,0x00000000);
		ui_text(tr("Color Space",null),ui_align_t_LEFT,0x00000000);
		ui->changed=false;
		for(i32 i=0;i<box_export_preset->textures->length;++i){
			export_preset_texture_t * t=box_export_preset->textures->buffer[i];
			ui_row6();
			ui_handle_t * htex=ui_nest(box_export_hpreset,i);
			htex->text=string_copy(t->name);
			t->name=string_copy(ui_text_input(htex,"",ui_align_t_LEFT,true,false));
			if(ui->is_hovered&&ui->input_released_r){
				gc_unroot(_box_export_t);_box_export_t=t;gc_root(_box_export_t);
				ui_menu_draw(&box_export_tab_presets_5960				,-1,-1);
			}
			ui_handle_t * hr=ui_nest(htex,0);
			hr->position=char_ptr_array_index_of(box_export_channels,t->channels->buffer[0]);
			ui_handle_t * hg=ui_nest(htex,1);
			hg->position=char_ptr_array_index_of(box_export_channels,t->channels->buffer[1]);
			ui_handle_t * hb=ui_nest(htex,2);
			hb->position=char_ptr_array_index_of(box_export_channels,t->channels->buffer[2]);
			ui_handle_t * ha=ui_nest(htex,3);
			ha->position=char_ptr_array_index_of(box_export_channels,t->channels->buffer[3]);
			ui_combo(hr,box_export_channels,tr("R",null),false,ui_align_t_LEFT,true);
			if(hr->changed){
				t->channels->buffer[0]=box_export_channels->buffer[hr->position];
			}
			ui_combo(hg,box_export_channels,tr("G",null),false,ui_align_t_LEFT,true);
			if(hg->changed){
				t->channels->buffer[1]=box_export_channels->buffer[hg->position];
			}
			ui_combo(hb,box_export_channels,tr("B",null),false,ui_align_t_LEFT,true);
			if(hb->changed){
				t->channels->buffer[2]=box_export_channels->buffer[hb->position];
			}
			ui_combo(ha,box_export_channels,tr("A",null),false,ui_align_t_LEFT,true);
			if(ha->changed){
				t->channels->buffer[3]=box_export_channels->buffer[ha->position];
			}
			ui_handle_t * hspace=ui_nest(htex,4);
			hspace->position=char_ptr_array_index_of(box_export_color_spaces,t->color_space);
			ui_combo(hspace,box_export_color_spaces,tr("Color Space",null),false,ui_align_t_LEFT,true);
			if(hspace->changed){
				t->color_space=string_copy(box_export_color_spaces->buffer[hspace->position]);
			}
		}
		if(ui->changed){
			box_export_save_preset();
		}
		row=f32_array_create_from_raw((f32[]){1/(float)8,},1);
		ui_row(row);
		if(ui_button(tr("Add",null),ui_align_t_CENTER,"")){
			export_preset_texture_t * tex=GC_ALLOC_INIT(export_preset_texture_t, {.name="base",.channels=any_array_create_from_raw((any[]){"base_r","base_g","base_b","1.0",},4),.color_space="linear"});
			any_array_push(box_export_preset->textures,tex);
			box_export_hpreset->children=null;
			box_export_save_preset();
		}
	}
}

void box_export_tab_presets_5960(ui_t * ui){
if(ui_menu_button(tr("Delete",null),"")){
					array_remove(box_export_preset->textures,_box_export_t);
					box_export_save_preset();
				}
}

void box_export_tab_presets_5693(string_t * path){
path=string_copy(to_lower_case(path));
			if(ends_with(path,".json")){
				string_t * filename=substring(path,string_last_index_of(path,path_sep)+1,string_length(path));
				string_t * dst_path=string_join(string_join(string_join(string_join(path_data(),path_sep),"export_presets"),path_sep),filename);
				file_copy(path,dst_path);
				box_export_fetch_presets();
				gc_unroot(box_export_preset);box_export_preset=null;
				box_export_hpreset->position=char_ptr_array_index_of(box_export_files,substring(filename,0,string_length(filename)-5));
				console_info(string_join(string_join(tr("Preset imported:",null)," "),filename));
			}
			else {
				console_error(strings_unknown_asset_format());
			}
}

void box_export_tab_presets_5550(ui_t * ui){
bool tab_vertical=config_raw->touch_ui;
			if(ui_tab(ui_handle("box_export.ts:209"),tr("New Preset",null),tab_vertical,-1)){
				ui_row2();
				ui_handle_t * h_preset=ui_handle("box_export.ts:211");
				if(h_preset->init){
					h_preset->text="new_preset";
				}
				string_t * preset_name=ui_text_input(h_preset,tr("Name",null),ui_align_t_LEFT,true,false);
				if(ui_button(tr("OK",null),ui_align_t_CENTER,"")||ui->is_return_down){
					box_export_new_preset(preset_name);
					box_export_fetch_presets();
					gc_unroot(box_export_preset);box_export_preset=null;
					box_export_hpreset->position=char_ptr_array_index_of(box_export_files,preset_name);
					ui_box_hide();
					box_export_htab->position=1;
					box_export_show_textures();
				}
			}
}

void box_export_tab_atlases(ui_t * ui){
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(box_export_htab,tr("Atlases",null),tab_vertical,-1)){
		if(project_atlas_objects==null||project_atlas_objects->length!=project_paint_objects->length){
			gc_unroot(project_atlas_objects);project_atlas_objects=i32_array_create_from_raw((i32[]){},0);gc_root(project_atlas_objects);
			gc_unroot(project_atlas_names);project_atlas_names=any_array_create_from_raw((any[]){},0);gc_root(project_atlas_names);
			for(i32 i=0;i<project_paint_objects->length;++i){
				i32_array_push(project_atlas_objects,0);
				i32 i1=i+1;
				any_array_push(project_atlas_names,string_join(string_join(tr("Atlas",null)," "),i32_to_string(i1)));
			}
		}
		for(i32 i=0;i<project_paint_objects->length;++i){
			ui_row2();
			ui_text(project_paint_objects->buffer[i]->base->name,ui_align_t_LEFT,0x00000000);
			ui_handle_t * hatlas=ui_nest(ui_handle("box_export.ts:347"),i);
			hatlas->position=project_atlas_objects->buffer[i];
			project_atlas_objects->buffer[i]=ui_combo(hatlas,project_atlas_names,tr("Atlas",null),false,ui_align_t_LEFT,true);
		}
	}
}

void box_export_show_mesh(){
	box_export_mesh_handle->position=context_raw->export_mesh_index;
	ui_box_show_custom(&box_export_show_mesh_6509	,400,240,null,true);
}

void box_export_show_mesh_6509(ui_t * ui){
ui_handle_t * htab=ui_handle("box_export.ts:357");
	box_export_tab_export_mesh(ui,htab);
}

void box_export_tab_export_mesh(ui_t * ui,ui_handle_t * htab){
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(htab,tr("Export Mesh",null),tab_vertical,-1)){
		ui_row2();
		ui_handle_t * h_export_mesh_format=ui_handle("box_export.ts:368");
		if(h_export_mesh_format->init){
			h_export_mesh_format->position=context_raw->export_mesh_format;
		}
		string_t_array_t * export_mesh_format_combo=any_array_create_from_raw((any[]){"obj","arm",},2);
		context_raw->export_mesh_format=ui_combo(h_export_mesh_format,export_mesh_format_combo,tr("Format",null),true,ui_align_t_LEFT,true);
		string_t_array_t * ar=any_array_create_from_raw((any[]){tr("All",null),},1);
		for(i32 i=0;i<project_paint_objects->length;++i){
			mesh_object_t * p=project_paint_objects->buffer[i];
			any_array_push(ar,p->base->name);
		}
		ui_combo(box_export_mesh_handle,ar,tr("Meshes",null),true,ui_align_t_LEFT,true);
		bool apply_displacement=ui_check(ui_handle("box_export.ts:382"),tr("Apply Displacement",null),"");
		ui_handle_t * hmerge=ui_handle("box_export.ts:384");
		if(hmerge->init){
			hmerge->selected=true;
		}
		bool merge_vertices=ui_check(hmerge,tr("Merge Shared Vertices",null),"");
		i32 tris=0;
		i32 pos=box_export_mesh_handle->position;
		mesh_object_t_array_t * paint_objects;
		if(pos==0){
			paint_objects=project_paint_objects;
		}
		else {
			mesh_object_t * po=project_paint_objects->buffer[pos-1];
			paint_objects=any_array_create_from_raw((any[]){po,},1);
		}
		for(i32 i=0;i<paint_objects->length;++i){
			mesh_object_t * po=paint_objects->buffer[i];
			for(i32 i=0;i<po->data->index_arrays->length;++i){
				index_array_t * inda=po->data->index_arrays->buffer[i];
				tris+=math_floor(inda->values->length/(float)3);
			}
		}
		ui_text(string_join(string_join(i32_to_string(tris)," "),tr("triangles",null)),ui_align_t_LEFT,0x00000000);
		ui_row2();
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_box_hide();
			_box_export_apply_displacement=apply_displacement;
			_box_export_merge_vertices=merge_vertices;
			ui_files_show(context_raw->export_mesh_format==mesh_format_t_OBJ?"obj":"arm",true,false,&box_export_tab_export_mesh_6929			);
		}
	}
}

void box_export_tab_export_mesh_6929(string_t * path){
string_t * f=ui_files_filename;
			if(string_equals(f,"")){
				f=string_copy(tr("untitled",null));
			}
			mesh_object_t_array_t * paint_objects;
			if(box_export_mesh_handle->position==0){
				paint_objects=null;
			}
			else {
				mesh_object_t * po=project_paint_objects->buffer[box_export_mesh_handle->position-1];
				paint_objects=any_array_create_from_raw((any[]){po,},1);
			}
			export_mesh_run(string_join(string_join(path,path_sep),f),paint_objects,_box_export_apply_displacement,_box_export_merge_vertices);
}

void box_export_show_material(){
	ui_box_show_custom(&box_export_show_material_7026	,400,200,null,true);
}

void box_export_show_material_7191(string_t * path){
export_arm_run_material(path);
}

void box_export_show_material_7160(string_t * path){
string_t * f=ui_files_filename;
			if(string_equals(f,"")){
				f=string_copy(tr("untitled",null));
			}
			sys_notify_on_init(&box_export_show_material_7191			,string_join(string_join(path,path_sep),f));
}

void box_export_show_material_7026(ui_t * ui){
ui_handle_t * htab=ui_handle("box_export.ts:447");
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(htab,tr("Export Material",null),tab_vertical,-1)){
		ui_handle_t * h1=ui_handle("box_export.ts:450");
		ui_handle_t * h2=ui_handle("box_export.ts:451");
		h1->selected=context_raw->pack_assets_on_export;
		h2->selected=context_raw->write_icon_on_export;
		context_raw->pack_assets_on_export=ui_check(h1,tr("Pack Assets",null),"");
		context_raw->write_icon_on_export=ui_check(h2,tr("Export Icon",null),"");
		ui_row2();
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_box_hide();
			ui_files_show("arm",true,false,&box_export_show_material_7160			);
		}
	}
}

void box_export_show_brush(){
	ui_box_show_custom(&box_export_show_brush_7228	,400,200,null,true);
}

void box_export_show_brush_7391(string_t * path){
export_arm_run_brush(path);
}

void box_export_show_brush_7362(string_t * path){
string_t * f=ui_files_filename;
			if(string_equals(f,""))f=string_copy(tr("untitled",null));
			sys_notify_on_init(&box_export_show_brush_7391			,string_join(string_join(path,path_sep),f));
}

void box_export_show_brush_7228(ui_t * ui){
ui_handle_t * htab=ui_handle("box_export.ts:478");
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(htab,tr("Export Brush",null),tab_vertical,-1)){
		ui_handle_t * h1=ui_handle("box_export.ts:481");
		ui_handle_t * h2=ui_handle("box_export.ts:482");
		h1->selected=context_raw->pack_assets_on_export;
		h2->selected=context_raw->write_icon_on_export;
		context_raw->pack_assets_on_export=ui_check(h1,tr("Pack Assets",null),"");
		context_raw->write_icon_on_export=ui_check(h2,tr("Export Icon",null),"");
		ui_row2();
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_box_hide();
			ui_files_show("arm",true,false,&box_export_show_brush_7362			);
		}
	}
}

void box_export_fetch_presets(){
	gc_unroot(box_export_files);box_export_files=file_read_directory(string_join(string_join(path_data(),path_sep),"export_presets"));gc_root(box_export_files);
	for(i32 i=0;i<box_export_files->length;++i){
		string_t * s=box_export_files->buffer[i];
		box_export_files->buffer[i]=substring(s,0,string_length(s)-5);
	}
}

void box_export_parse_preset(){
	string_t * file=string_join(string_join("export_presets/",box_export_files->buffer[box_export_hpreset->position]),".json");
	buffer_t * blob=data_get_blob(file);
	gc_unroot(box_export_preset);box_export_preset=json_parse(sys_buffer_to_string(blob));gc_root(box_export_preset);
	data_delete_blob(file);
}

void box_export_new_preset(string_t * name){
	string_t * template="{\
\"textures\": [\
	{ \"name\": \"base\", \"channels\": [\"base_r\", \"base_g\", \"base_b\", \"1.0\"], \"color_space\": \"linear\" }\
]\
}\
";
	if(!ends_with(name,".json")){
		name=string_join(name,".json");
	}
	string_t * path=string_join(string_join(string_join(string_join(path_data(),path_sep),"export_presets"),path_sep),name);
	iron_file_save_bytes(path,sys_string_to_buffer(template),0);
}

void box_export_save_preset(){
	string_t * name=box_export_files->buffer[box_export_hpreset->position];
	if(string_equals(name,"generic")){
		return ;
	}
	string_t * path=string_join(string_join(string_join(string_join(string_join(path_data(),path_sep),"export_presets"),path_sep),name),".json");
	iron_file_save_bytes(path,sys_string_to_buffer(box_export_preset_to_json(box_export_preset)),0);
}

string_t * box_export_preset_to_json(export_preset_t * p){
	json_encode_begin();
	json_encode_begin_array("textures");
	for(i32 i=0;i<p->textures->length;++i){
		json_encode_begin_object();
		json_encode_string("name",p->textures->buffer[i]->name);
		json_encode_string_array("channels",p->textures->buffer[i]->channels);
		json_encode_string("color_space",p->textures->buffer[i]->color_space);
		json_encode_end_object();
	}
	json_encode_end_array();
	return json_encode_end();
}

void box_preferences_show(){
	ui_box_show_custom(&box_preferences_show_7818	,620,config_raw->touch_ui?480:420,&box_preferences_show_12323	,true);
}

void box_preferences_show_12323(){
config_save();
}

void box_preferences_show_12202(string_t * dest){
if(!ends_with(ui_files_filename,".js")){
						gc_unroot(ui_files_filename);ui_files_filename=string_join(ui_files_filename,".js");gc_root(ui_files_filename);
					}
					string_t * path=string_join(string_join(string_join(string_join(path_data(),path_sep),"plugins"),path_sep),_box_preferences_f);
					file_copy(path,string_join(string_join(dest,path_sep),ui_files_filename));
}

void box_preferences_show_12096(ui_t * ui){
string_t * path=string_join(string_join(string_join(string_join(path_data(),path_sep),"plugins"),path_sep),_box_preferences_f);
				if(ui_menu_button(tr("Edit in Text Editor",null),"")){
					file_start(path);
				}
				if(ui_menu_button(tr("Edit in Script Tab",null),"")){
					buffer_t * blob=data_get_blob(string_join("plugins/",_box_preferences_f));
					tab_script_hscript->text=string_copy(sys_buffer_to_string(blob));
					data_delete_blob(string_join("plugins/",_box_preferences_f));
					console_info(tr("Script opened",null));
				}
				if(ui_menu_button(tr("Export",null),"")){
					ui_files_show("js",true,false,&box_preferences_show_12202					);
				}
				if(ui_menu_button(tr("Delete",null),"")){
					if(char_ptr_array_index_of(config_raw->plugins,_box_preferences_f)>=0){
						char_ptr_array_remove(config_raw->plugins,_box_preferences_f);
						plugin_stop(_box_preferences_f);
					}
					char_ptr_array_remove(box_preferences_files_plugin,_box_preferences_f);
					file_delete(path);
				}
}

void box_preferences_show_11900(string_t * path){
import_plugin_run(path);
}

void box_preferences_show_11732(ui_t * ui){
if(ui_tab(ui_handle("box_preferences.ts:757"),tr("New Plugin",null),false,-1)){
				ui_row2();
				ui_handle_t * h=ui_handle("box_preferences.ts:759");
				if(h->init){
					h->text="new_plugin";
				}
				string_t * plugin_name=ui_text_input(h,tr("Name",null),ui_align_t_LEFT,true,false);
				if(ui_button(tr("OK",null),ui_align_t_CENTER,"")||ui->is_return_down){
					string_t * template="let plugin = plugin_create();\
let h1 = ui_handle_create();\
plugin_notify_on_ui(plugin, function() {\
	if (ui_panel(h1, \"New Plugin\")) {\
		if (ui_button(\"Button\")) {\
			console_info(\"Hello\");\
		}\
	}\
});\
";
					if(!ends_with(plugin_name,".js")){
						plugin_name=string_join(plugin_name,".js");
					}
					string_t * path=string_join(string_join(string_join(string_join(path_data(),path_sep),"plugins"),path_sep),plugin_name);
					iron_file_save_bytes(path,sys_string_to_buffer(template),0);
					gc_unroot(box_preferences_files_plugin);box_preferences_files_plugin=null;
					ui_box_hide();
					box_preferences_htab->position=6;
					box_preferences_show();
				}
			}
}

void box_preferences_show_11493(string_t * dest){
if(!ends_with(ui_files_filename,".json")){
				gc_unroot(ui_files_filename);ui_files_filename=string_join(ui_files_filename,".json");gc_root(ui_files_filename);
			}
			string_t * path=string_join(string_join(string_join(string_join(path_data(),path_sep),"keymap_presets"),path_sep),config_raw->keymap);
			file_copy(path,string_join(string_join(dest,path_sep),ui_files_filename));
}

void box_preferences_show_11458(string_t * path){
import_keymap_run(path);
}

void box_preferences_show_11275(ui_t * ui){
if(ui_tab(ui_handle("box_preferences.ts:691"),tr("New Keymap",null),false,-1)){
				ui_row2();
				ui_handle_t * h=ui_handle("box_preferences.ts:693");
				if(h->init){
					h->text="new_keymap";
				}
				string_t * keymap_name=ui_text_input(h,tr("Name",null),ui_align_t_LEFT,true,false);
				if(ui_button(tr("OK",null),ui_align_t_CENTER,"")||ui->is_return_down){
					string_t * template=keymap_to_json(keymap_get_default());
					if(!ends_with(keymap_name,".json")){
						keymap_name=string_join(keymap_name,".json");
					}
					string_t * path=string_join(string_join(string_join(string_join(path_data(),path_sep),"keymap_presets"),path_sep),keymap_name);
					iron_file_save_bytes(path,sys_string_to_buffer(template),0);
					box_preferences_fetch_keymaps();
					config_raw->keymap=string_copy(keymap_name);
					box_preferences_preset_handle->position=box_preferences_get_preset_index();
					ui_box_hide();
					box_preferences_htab->position=5;
					box_preferences_show();
				}
			}
}

void box_preferences_show_9234(ui_t * ui){
ui->changed=false;
					i32 color=ui_color_wheel(_box_preferences_h,false,-1,11*ui->ops->theme->ELEMENT_H*ui_SCALE(ui),true,null,null);
					u32_ptr u32_theme=base_theme;
					DEREFERENCE(u32_theme+_box_preferences_i)=color;
					if(ui->changed){
						ui_menu_keep_open=true;
					}
}

void box_preferences_show_9042(string_t * path){
path=string_join(path,path_sep);
			path=string_join(path,ui_files_filename);
			if(!ends_with(path,".json")){
				path=string_join(path,".json");
			}
			iron_file_save_bytes(path,sys_string_to_buffer(box_preferences_theme_to_json(base_theme)),0);
}

void box_preferences_show_9007(string_t * path){
import_theme_run(path);
}

void box_preferences_show_8826(ui_t * ui){
if(ui_tab(ui_handle("box_preferences.ts:203"),tr("New Theme",null),false,-1)){
				ui_row2();
				ui_handle_t * h=ui_handle("box_preferences.ts:205");
				if(h->init){
					h->text="new_theme";
				}
				string_t * theme_name=ui_text_input(h,tr("Name",null),ui_align_t_LEFT,true,false);
				if(ui_button(tr("OK",null),ui_align_t_CENTER,"")||ui->is_return_down){
					string_t * template=box_preferences_theme_to_json(base_theme);
					if(!ends_with(theme_name,".json")){
						theme_name=string_join(theme_name,".json");
					}
					string_t * path=string_join(string_join(string_join(string_join(path_data(),path_sep),"themes"),path_sep),theme_name);
					iron_file_save_bytes(path,sys_string_to_buffer(template),0);
					box_preferences_fetch_themes();
					config_raw->theme=string_copy(theme_name);
					box_preferences_theme_handle->position=box_preferences_get_theme_index();
					ui_box_hide();
					box_preferences_htab->position=1;
					box_preferences_show();
				}
			}
}

void box_preferences_show_8695(ui_t * ui){
if(ui_menu_button(tr("Confirm",null),"")){
				base_init_layout();
				config_save();
			}
}

void box_preferences_show_8638(config_t * raw){
_box_preferences_ui->ops->theme->ELEMENT_H=base_default_element_h;
				config_import_from(raw);
				box_preferences_set_scale();
				make_material_parse_mesh_material();
				make_material_parse_paint_material(true);
}

void box_preferences_show_8606(string_t * path){
buffer_t * b=data_get_blob(path);
				config_t * raw=json_parse(sys_buffer_to_string(b));
				sys_notify_on_init(&box_preferences_show_8638				,raw);
}

void box_preferences_show_8497(ui_t * ui){
ui->ops->theme->ELEMENT_H=base_default_element_h;
				config_restore();
				box_preferences_set_scale();
				if(config_raw->plugins!=null){
					for(i32 i=0;i<config_raw->plugins->length;++i){
						string_t * f=config_raw->plugins->buffer[i];
						plugin_stop(f);
					}
				}
				gc_unroot(box_preferences_files_plugin);box_preferences_files_plugin=null;
				gc_unroot(box_preferences_files_keymap);box_preferences_files_keymap=null;
				make_material_parse_mesh_material();
				make_material_parse_paint_material(true);
				ui_base_set_viewport_col(ui->ops->theme->VIEWPORT_COL);
}

void box_preferences_show_8477(ui_t * ui){
if(ui_menu_button(tr("Confirm",null),"")){
				sys_notify_on_init(&box_preferences_show_8497				,ui);
			}
			if(ui_menu_button(tr("Import...",null),"")){
				gc_unroot(_box_preferences_ui);_box_preferences_ui=ui;gc_root(_box_preferences_ui);
				ui_files_show("json",false,false,&box_preferences_show_8606				);
			}
}

void box_preferences_show_7818(ui_t * ui){
if(ui_tab(box_preferences_htab,tr("Interface",null),true,-1)){
		if(box_preferences_locales==null){
			gc_unroot(box_preferences_locales);box_preferences_locales=translator_get_supported_locales();gc_root(box_preferences_locales);
		}
		ui_handle_t * locale_handle=ui_handle("box_preferences.ts:21");
		if(locale_handle->init){
			locale_handle->position=char_ptr_array_index_of(box_preferences_locales,config_raw->locale);
		}
		ui_combo(locale_handle,box_preferences_locales,tr("Language",null),true,ui_align_t_LEFT,true);
		if(locale_handle->changed){
			string_t * locale_code=box_preferences_locales->buffer[locale_handle->position];
			config_raw->locale=string_copy(locale_code);
			translator_load_translations(locale_code);
			ui_base_tag_ui_redraw();
		}
		ui_handle_t * hscale=ui_handle("box_preferences.ts:33");
		if(hscale->init){
			hscale->value=config_raw->window_scale;
		}
		ui_slider(hscale,tr("UI Scale",null),1.0,4.0,true,10,true,ui_align_t_RIGHT,true);
		if(context_raw->hscale_was_changed&&!ui->input_down){
			context_raw->hscale_was_changed=false;
			if(hscale->value==0.0){
				hscale->value=1.0;
			}
			config_raw->window_scale=hscale->value;
			box_preferences_set_scale();
		}
		if(hscale->changed){
			context_raw->hscale_was_changed=true;
		}
		ui_handle_t * hspeed=ui_handle("box_preferences.ts:50");
		if(hspeed->init){
			hspeed->value=config_raw->camera_zoom_speed;
		}
		config_raw->camera_zoom_speed=ui_slider(hspeed,tr("Camera Zoom Speed",null),0.1,4.0,true,100.0,true,ui_align_t_RIGHT,true);
		hspeed=ui_handle("box_preferences.ts:56");
		if(hspeed->init){
			hspeed->value=config_raw->camera_rotation_speed;
		}
		config_raw->camera_rotation_speed=ui_slider(hspeed,tr("Camera Rotation Speed",null),0.1,4.0,true,100.0,true,ui_align_t_RIGHT,true);
		hspeed=ui_handle("box_preferences.ts:62");
		if(hspeed->init){
			hspeed->value=config_raw->camera_pan_speed;
		}
		config_raw->camera_pan_speed=ui_slider(hspeed,tr("Camera Pan Speed",null),0.1,4.0,true,100.0,true,ui_align_t_RIGHT,true);
		ui_handle_t * zoom_direction_handle=ui_handle("box_preferences.ts:68");
		if(zoom_direction_handle->init){
			zoom_direction_handle->position=config_raw->zoom_direction;
		}
		string_t_array_t * zoom_direction_combo=any_array_create_from_raw((any[]){tr("Vertical",null),tr("Vertical Inverted",null),tr("Horizontal",null),tr("Horizontal Inverted",null),tr("Vertical and Horizontal",null),tr("Vertical and Horizontal Inverted",null),},6);
		ui_combo(zoom_direction_handle,zoom_direction_combo,tr("Direction to Zoom",null),true,ui_align_t_LEFT,true);
		if(zoom_direction_handle->changed){
			config_raw->zoom_direction=zoom_direction_handle->position;
		}
		ui_handle_t * h_wrap_mouse=ui_handle("box_preferences.ts:78");
		if(h_wrap_mouse->init){
			h_wrap_mouse->selected=config_raw->wrap_mouse;
		}
		config_raw->wrap_mouse=ui_check(h_wrap_mouse,tr("Wrap Mouse",null),"");
		if(ui->is_hovered){
			ui_tooltip(tr("Wrap mouse around view boundaries during camera control",null));
		}
		ui_handle_t * h_node_preview=ui_handle("box_preferences.ts:87");
		if(h_node_preview->init){
			h_node_preview->selected=config_raw->node_preview;
		}
		config_raw->node_preview=ui_check(h_node_preview,tr("Show Node Preview",null),"");
		ui->changed=false;
		ui_handle_t * h_show_asset_names=ui_handle("box_preferences.ts:94");
		if(h_show_asset_names->init){
			h_show_asset_names->selected=config_raw->show_asset_names;
		}
		config_raw->show_asset_names=ui_check(h_show_asset_names,tr("Show Asset Names",null),"");
		if(ui->changed){
			ui_base_tag_ui_redraw();
		}
		ui->changed=false;
		ui_handle_t * h_touch_ui=ui_handle("box_preferences.ts:105");
		if(h_touch_ui->init){
			h_touch_ui->selected=config_raw->touch_ui;
		}
		config_raw->touch_ui=ui_check(h_touch_ui,tr("Touch UI",null),"");
		if(ui->changed){
			ui_touch_scroll=config_raw->touch_ui;
			ui_touch_hold=config_raw->touch_ui;
			ui_touch_tooltip=config_raw->touch_ui;
			config_load_theme(config_raw->theme,true);
			box_preferences_set_scale();
			ui_base_tag_ui_redraw();
		}
		ui_handle_t * h_splash_screen=ui_handle("box_preferences.ts:120");
		if(h_splash_screen->init){
			h_splash_screen->selected=config_raw->splash_screen;
		}
		config_raw->splash_screen=ui_check(h_splash_screen,tr("Splash Screen",null),"");
		ui_handle_t * h_grid_snap=ui_handle("box_preferences.ts:126");
		if(h_grid_snap->init){
			h_grid_snap->selected=config_raw->grid_snap;
		}
		config_raw->grid_snap=ui_check(h_grid_snap,tr("Grid Snap",null),"");
		ui_nodes_grid_snap=config_raw->grid_snap;
		_ui_end_element(-1.0);
		ui_row2();
		if(ui_button(tr("Restore",null),ui_align_t_CENTER,"")&&!ui_menu_show){
			ui_menu_draw(&box_preferences_show_8477			,-1,-1);
		}
		if(ui_button(tr("Reset Layout",null),ui_align_t_CENTER,"")&&!ui_menu_show){
			ui_menu_draw(&box_preferences_show_8695			,-1,-1);
		}
	}
	if(ui_tab(box_preferences_htab,tr("Theme",null),true,-1)){
		if(box_preferences_themes==null){
			box_preferences_fetch_themes();
		}
		gc_unroot(box_preferences_theme_handle);box_preferences_theme_handle=ui_handle("box_preferences.ts:187");gc_root(box_preferences_theme_handle);
		if(box_preferences_theme_handle->init){
			box_preferences_theme_handle->position=box_preferences_get_theme_index();
		}
		ui_begin_sticky();
		ui_row4();
		ui_combo(box_preferences_theme_handle,box_preferences_themes,tr("Theme",null),false,ui_align_t_LEFT,true);
		if(box_preferences_theme_handle->changed){
			config_raw->theme=string_join(box_preferences_themes->buffer[box_preferences_theme_handle->position],".json");
			config_load_theme(config_raw->theme,true);
		}
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
			ui_box_show_custom(&box_preferences_show_8826			,400,200,null,true);
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_files_show("json",false,false,&box_preferences_show_9007			);
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_files_show("json",true,false,&box_preferences_show_9042			);
		}
		ui_end_sticky();
		ui_handle_t * hlist=ui_handle("box_preferences.ts:248");
		u32_ptr u32_theme=base_theme;
		for(i32 i=0;i<ui_theme_keys_count;++i){
			string_t * key=ARRAY_ACCESS(ui_theme_keys,i);
			ui_handle_t * h=ui_nest(hlist,i);
			u32 val=DEREFERENCE(u32_theme+i);
			bool is_hex=ends_with(key,"_COL");
			if(is_hex){
				f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)8,7/(float)8,},2);
				ui_row(row);
				ui_text("",0,val);
				if(ui->is_hovered&&ui->input_released){
					h->color=val;
					gc_unroot(_box_preferences_h);_box_preferences_h=h;gc_root(_box_preferences_h);
					_box_preferences_i=i;
					ui_menu_draw(&box_preferences_show_9234					,-1,-1);
				}
				if(string_equals(key,"VIEWPORT_COL")&&ui_base_viewport_col!=val){
					ui_base_set_viewport_col(val);
				}
			}
			ui->changed=false;
			if(string_equals(key,"FILL_WINDOW_BG")||string_equals(key,"FILL_BUTTON_BG")||string_equals(key,"FULL_TABS")||string_equals(key,"ROUND_CORNERS")||string_equals(key,"SHADOWS")){
				h->selected=val>0;
				bool b=ui_check(h,key,"");
				DEREFERENCE(u32_theme+i)=b;
			}
			else if(string_equals(key,"LINK_STYLE")){
				string_t_array_t * styles=any_array_create_from_raw((any[]){tr("Straight",null),tr("Curved",null),},2);
				h->position=val;
				i32 pos=ui_combo(h,styles,key,true,ui_align_t_LEFT,true);
				DEREFERENCE(u32_theme+i)=pos;
			}
			else {
				h->text=is_hex?i32_to_string_hex(val):i32_to_string(val);
				ui_text_input(h,key,ui_align_t_LEFT,true,false);
				if(is_hex){
					DEREFERENCE(u32_theme+i)=parse_int_hex(h->text);
				}
				else {
					DEREFERENCE(u32_theme+i)=parse_int(h->text);
				}
			}
			if(ui->changed){
				for(i32 i=0;i<base_get_uis()->length;++i){
					ui_t * ui=base_get_uis()->buffer[i];
					ui->elements_baked=false;
				}
			}
		}
	}
	if(ui_tab(box_preferences_htab,tr("Usage",null),true,-1)){
		context_raw->undo_handle=ui_handle("box_preferences.ts:318");
		if(context_raw->undo_handle->init){
			context_raw->undo_handle->value=config_raw->undo_steps;
		}
		config_raw->undo_steps=math_floor(ui_slider(context_raw->undo_handle,tr("Undo Steps",null),1,64,false,1,true,ui_align_t_RIGHT,true));
		if(config_raw->undo_steps<1){
			config_raw->undo_steps=math_floor(context_raw->undo_handle->value=1);
		}
		if(context_raw->undo_handle->changed){
			gpu_texture_t * current=_draw_current;
			draw_end();
			if(history_undo_layers!=null){
				while(history_undo_layers->length<config_raw->undo_steps){
					i32 len=history_undo_layers->length;
					slot_layer_t * l=slot_layer_create(string_join("_undo",i32_to_string(len)),layer_slot_type_t_LAYER,null);
					any_array_push(history_undo_layers,l);
				}
				while(history_undo_layers->length>config_raw->undo_steps){
					slot_layer_t * l=array_pop(history_undo_layers);
					slot_layer_unload(l);
				}
			}
			history_reset();
			draw_begin(current,false,0);
		}
		ui_handle_t * h_dilate_radius=ui_handle("box_preferences.ts:347");
		if(h_dilate_radius->init){
			h_dilate_radius->value=config_raw->dilate_radius;
		}
		config_raw->dilate_radius=math_floor(ui_slider(h_dilate_radius,tr("Dilate Radius",null),0.0,16.0,true,1,true,ui_align_t_RIGHT,true));
		if(ui->is_hovered){
			ui_tooltip(tr("Dilate painted textures to prevent seams",null));
		}
		ui_handle_t * dilate_handle=ui_handle("box_preferences.ts:356");
		if(dilate_handle->init){
			dilate_handle->position=config_raw->dilate;
		}
		string_t_array_t * dilate_combo=any_array_create_from_raw((any[]){tr("Instant",null),tr("Delayed",null),},2);
		ui_combo(dilate_handle,dilate_combo,tr("Dilate",null),true,ui_align_t_LEFT,true);
		if(dilate_handle->changed){
			config_raw->dilate=dilate_handle->position;
		}
		ui_handle_t * camera_controls_handle=ui_handle("box_preferences.ts:379");
		if(camera_controls_handle->init){
			camera_controls_handle->position=config_raw->camera_controls;
		}
		string_t_array_t * camera_controls_combo=any_array_create_from_raw((any[]){tr("Orbit",null),tr("Rotate",null),tr("Fly",null),},3);
		ui_combo(camera_controls_handle,camera_controls_combo,tr("Default Camera Controls",null),true,ui_align_t_LEFT,true);
		if(camera_controls_handle->changed){
			config_raw->camera_controls=camera_controls_handle->position;
		}
		ui_handle_t * layer_res_handle=ui_handle("box_preferences.ts:389");
		if(layer_res_handle->init){
			layer_res_handle->position=config_raw->layer_res;
		}
		string_t_array_t * res_combo=any_array_create_from_raw((any[]){"128","256","512","1K","2K","4K","8K","16K",},8);
		ui_combo(layer_res_handle,res_combo,tr("Default Layer Resolution",null),true,ui_align_t_LEFT,true);
		if(layer_res_handle->changed){
			config_raw->layer_res=layer_res_handle->position;
		}
		ui_handle_t * server_handle=ui_handle("box_preferences.ts:419");
		if(server_handle->init){
			server_handle->text=string_copy(config_raw->server);
		}
		config_raw->server=string_copy(ui_text_input(server_handle,tr("Cloud Server",null),ui_align_t_LEFT,true,false));
		ui_handle_t * material_live_handle=ui_handle("box_preferences.ts:426");
		if(material_live_handle->init){
			material_live_handle->selected=config_raw->material_live;
		}
		config_raw->material_live=ui_check(material_live_handle,tr("Live Material Preview",null),"");
		if(ui->is_hovered){
			ui_tooltip(tr("Instantly update material preview on node change",null));
		}
		ui_handle_t * brush_live_handle=ui_handle("box_preferences.ts:435");
		if(brush_live_handle->init){
			brush_live_handle->selected=config_raw->brush_live;
		}
		config_raw->brush_live=ui_check(brush_live_handle,tr("Live Brush Preview",null),"");
		if(ui->is_hovered){
			ui_tooltip(tr("Draw live brush preview in viewport",null));
		}
		if(brush_live_handle->changed){
			context_raw->ddirty=2;
		}
		ui_handle_t * brush_3d_handle=ui_handle("box_preferences.ts:447");
		if(brush_3d_handle->init){
			brush_3d_handle->selected=config_raw->brush_3d;
		}
		config_raw->brush_3d=ui_check(brush_3d_handle,tr("3D Cursor",null),"");
		if(brush_3d_handle->changed){
			make_material_parse_paint_material(true);
		}
		ui->enabled=config_raw->brush_3d;
		ui_handle_t * brush_depth_reject_handle=ui_handle("box_preferences.ts:457");
		if(brush_depth_reject_handle->init){
			brush_depth_reject_handle->selected=config_raw->brush_depth_reject;
		}
		config_raw->brush_depth_reject=ui_check(brush_depth_reject_handle,tr("Depth Reject",null),"");
		if(brush_depth_reject_handle->changed){
			make_material_parse_paint_material(true);
		}
		ui_row2();
		ui_handle_t * brush_angle_reject_handle=ui_handle("box_preferences.ts:468");
		if(brush_angle_reject_handle->init){
			brush_angle_reject_handle->selected=config_raw->brush_angle_reject;
		}
		config_raw->brush_angle_reject=ui_check(brush_angle_reject_handle,tr("Angle Reject",null),"");
		if(brush_angle_reject_handle->changed){
			make_material_parse_paint_material(true);
		}
		if(!config_raw->brush_angle_reject)ui->enabled=false;
		ui_handle_t * angle_dot_handle=ui_handle("box_preferences.ts:478");
		if(angle_dot_handle->init){
			angle_dot_handle->value=context_raw->brush_angle_reject_dot;
		}
		context_raw->brush_angle_reject_dot=ui_slider(angle_dot_handle,tr("Angle",null),0.0,1.0,true,100.0,true,ui_align_t_RIGHT,true);
		if(angle_dot_handle->changed){
			make_material_parse_paint_material(true);
		}
		ui->enabled=true;
	}
	string_t * pen_name;
	pen_name=string_copy(tr("Pen",null));
	if(ui_tab(box_preferences_htab,pen_name,true,-1)){
		ui_text(tr("Pressure controls",null),ui_align_t_LEFT,0x00000000);
		ui_handle_t * h_pressure_radius=ui_handle("box_preferences.ts:510");
		if(h_pressure_radius->init){
			h_pressure_radius->selected=config_raw->pressure_radius;
		}
		config_raw->pressure_radius=ui_check(h_pressure_radius,tr("Brush Radius",null),"");
		ui_handle_t * h_pressure_sensitivity=ui_handle("box_preferences.ts:516");
		if(h_pressure_sensitivity->init){
			h_pressure_sensitivity->value=config_raw->pressure_sensitivity;
		}
		config_raw->pressure_sensitivity=ui_slider(h_pressure_sensitivity,tr("Sensitivity",null),0.0,10.0,true,100.0,true,ui_align_t_RIGHT,true);
		ui_handle_t * h_pressure_hardness=ui_handle("box_preferences.ts:523");
		if(h_pressure_hardness->init){
			h_pressure_hardness->selected=config_raw->pressure_hardness;
		}
		config_raw->pressure_hardness=ui_check(h_pressure_hardness,tr("Brush Hardness",null),"");
		ui_handle_t * h_pressure_opacity=ui_handle("box_preferences.ts:529");
		if(h_pressure_opacity->init){
			h_pressure_opacity->selected=config_raw->pressure_opacity;
		}
		config_raw->pressure_opacity=ui_check(h_pressure_opacity,tr("Brush Opacity",null),"");
		ui_handle_t * h_pressure_angle=ui_handle("box_preferences.ts:535");
		if(h_pressure_angle->init){
			h_pressure_angle->selected=config_raw->pressure_angle;
		}
		config_raw->pressure_angle=ui_check(h_pressure_angle,tr("Brush Angle",null),"");
		_ui_end_element(-1.0);
		f32_array_t * row=f32_array_create_from_raw((f32[]){0.5,},1);
		ui_row(row);
		if(ui_button(tr("Help",null),ui_align_t_CENTER,"")){
			string_t * url="https://github.com/armory3d/";
			string_t * name=to_lower_case(manifest_title);
			url=string_join(url,name);
			url=string_join(url,"_docs#pen");
			file_load_url(url);
		}
	}
	context_raw->hssao=ui_handle("box_preferences.ts:554");
	if(context_raw->hssao->init){
		context_raw->hssao->selected=config_raw->rp_ssao;
	}
	context_raw->hbloom=ui_handle("box_preferences.ts:559");
	if(context_raw->hbloom->init){
		context_raw->hbloom->selected=config_raw->rp_bloom;
	}
	context_raw->hsupersample=ui_handle("box_preferences.ts:564");
	if(context_raw->hsupersample->init){
		context_raw->hsupersample->position=config_get_super_sample_quality(config_raw->rp_supersample);
	}
	context_raw->hvxao=ui_handle("box_preferences.ts:569");
	if(context_raw->hvxao->init){
		context_raw->hvxao->selected=config_raw->rp_gi;
	}
	if(ui_tab(box_preferences_htab,tr("Viewport",null),true,-1)){
		ui_handle_t * mode_handle=ui_handle("box_preferences.ts:576");
		if(mode_handle->init){
			mode_handle->position=config_raw->workspace;
		}
		string_t_array_t * mode_combo=any_array_create_from_raw((any[]){tr("Lit",null),tr("Path Traced",null),},2);
		ui_combo(mode_handle,mode_combo,tr("Default Mode",null),true,ui_align_t_LEFT,true);
		if(mode_handle->changed){
			config_raw->viewport_mode=mode_handle->position;
		}
		ui_handle_t * hpathtrace_mode=ui_handle("box_preferences.ts:586");
		if(hpathtrace_mode->init){
			hpathtrace_mode->position=config_raw->pathtrace_mode;
		}
		string_t_array_t * pathtrace_mode_combo=any_array_create_from_raw((any[]){tr("Fast",null),tr("Quality",null),},2);
		config_raw->pathtrace_mode=ui_combo(hpathtrace_mode,pathtrace_mode_combo,tr("Path Tracer",null),true,ui_align_t_LEFT,true);
		if(hpathtrace_mode->changed){
			render_path_raytrace_ready=false;
			render_path_raytrace_first=true;
			context_raw->ddirty=2;
		}
		ui_handle_t * hrender_mode=ui_handle("box_preferences.ts:598");
		if(hrender_mode->init){
			hrender_mode->position=context_raw->render_mode;
		}
		string_t_array_t * render_mode_combo=any_array_create_from_raw((any[]){tr("Desktop",null),tr("Mobile",null),},2);
		context_raw->render_mode=ui_combo(hrender_mode,render_mode_combo,tr("Renderer",null),true,ui_align_t_LEFT,true);
		if(hrender_mode->changed){
			context_set_render_path();
		}
		string_t_array_t * supersample_combo=any_array_create_from_raw((any[]){"0.25x","0.5x","1.0x","1.5x","2.0x","4.0x",},6);
		ui_combo(context_raw->hsupersample,supersample_combo,tr("Super Sample",null),true,ui_align_t_LEFT,true);
		if(context_raw->hsupersample->changed){
			config_apply();
		}
		if(context_raw->render_mode==render_mode_t_DEFERRED){
			ui_check(context_raw->hssao,tr("SSAO",null),"");
			if(context_raw->hssao->changed){
				config_apply();
			}
			ui_check(context_raw->hbloom,tr("Bloom",null),"");
			if(context_raw->hbloom->changed){
				config_apply();
			}
		}
		ui_handle_t * h=ui_handle("box_preferences.ts:625");
		if(h->init){
			h->value=config_raw->rp_vignette;
		}
		config_raw->rp_vignette=ui_slider(h,tr("Vignette",null),0.0,1.0,true,100.0,true,ui_align_t_RIGHT,true);
		if(h->changed){
			context_raw->ddirty=2;
		}
		h=ui_handle("box_preferences.ts:634");
		if(h->init){
			h->value=config_raw->rp_grain;
		}
		config_raw->rp_grain=ui_slider(h,tr("Noise Grain",null),0.0,1.0,true,100.0,true,ui_align_t_RIGHT,true);
		if(h->changed){
			context_raw->ddirty=2;
		}
		camera_object_t * cam=scene_camera;
		camera_data_t * cam_raw=cam->data;
		ui_handle_t * near_handle=ui_handle("box_preferences.ts:649");
		ui_handle_t * far_handle=ui_handle("box_preferences.ts:650");
		near_handle->value=math_floor(cam_raw->near_plane*1000)/(float)1000;
		far_handle->value=math_floor(cam_raw->far_plane*100)/(float)100;
		cam_raw->near_plane=ui_slider(near_handle,tr("Clip Start",null),0.001,1.0,true,100.0,true,ui_align_t_RIGHT,true);
		cam_raw->far_plane=ui_slider(far_handle,tr("Clip End",null),50.0,100.0,true,100.0,true,ui_align_t_RIGHT,true);
		if(near_handle->changed||far_handle->changed){
			camera_object_build_proj(cam,-1.0);
		}
		ui_handle_t * disp_handle=ui_handle("box_preferences.ts:659");
		if(disp_handle->init){
			disp_handle->value=config_raw->displace_strength;
		}
		config_raw->displace_strength=ui_slider(disp_handle,tr("Displacement Strength",null),0.0,10.0,true,100.0,true,ui_align_t_RIGHT,true);
		if(disp_handle->changed){
			context_raw->ddirty=2;
			make_material_parse_mesh_material();
		}
	}
	if(ui_tab(box_preferences_htab,tr("Keymap",null),true,-1)){
		if(box_preferences_files_keymap==null){
			box_preferences_fetch_keymaps();
		}
		ui_begin_sticky();
		ui_row4();
		gc_unroot(box_preferences_preset_handle);box_preferences_preset_handle=ui_handle("box_preferences.ts:678");gc_root(box_preferences_preset_handle);
		if(box_preferences_preset_handle->init){
			box_preferences_preset_handle->position=box_preferences_get_preset_index();
		}
		ui_combo(box_preferences_preset_handle,box_preferences_files_keymap,tr("Preset",null),false,ui_align_t_LEFT,true);
		if(box_preferences_preset_handle->changed){
			config_raw->keymap=string_join(box_preferences_files_keymap->buffer[box_preferences_preset_handle->position],".json");
			config_apply();
			keymap_load();
		}
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
			ui_box_show_custom(&box_preferences_show_11275			,400,200,null,true);
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_files_show("json",false,false,&box_preferences_show_11458			);
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_files_show("json",true,false,&box_preferences_show_11493			);
		}
		ui_end_sticky();
		ui_separator(8,false);
		i32 index=0;
		ui->changed=false;
		string_t_array_t * keys=map_keys(config_keymap);
		array_sort(keys,null);
		for(i32 i=0;i<keys->length;++i){
			string_t * key=keys->buffer[i];
			ui_handle_t * h=ui_nest(ui_handle("box_preferences.ts:741"),index++);
			h->text=string_copy(any_map_get(config_keymap,key));
			string_t * text=ui_text_input(h,key,ui_align_t_LEFT,true,false);
			any_map_set(config_keymap,key,text);
		}
		if(ui->changed){
			config_apply();
			keymap_save();
		}
	}
	if(ui_tab(box_preferences_htab,tr("Plugins",null),true,-1)){
		ui_begin_sticky();
		f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,},2);
		ui_row(row);
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
			ui_box_show_custom(&box_preferences_show_11732			,400,200,null,true);
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_files_show("js,zip",false,false,&box_preferences_show_11900			);
		}
		ui_end_sticky();
		if(box_preferences_files_plugin==null){
			box_preferences_fetch_plugins();
		}
		if(config_raw->plugins==null){
			config_raw->plugins=any_array_create_from_raw((any[]){},0);
		}
		ui_handle_t * h=ui_handle("box_preferences.ts:803");
		if(h->init){
			h->selected=false;
		}
		for(i32 i=0;i<box_preferences_files_plugin->length;++i){
			string_t * f=box_preferences_files_plugin->buffer[i];
			bool is_js=ends_with(f,".js");
			if(!is_js){
				continue;
			}
			bool enabled=char_ptr_array_index_of(config_raw->plugins,f)>=0;
			h->selected=enabled;
			string_t * tag=is_js?string_split(f,".")->buffer[0]:f;
			ui_check(h,tag,"");
			if(h->changed&&h->selected!=enabled){
				h->selected?config_enable_plugin(f):config_disable_plugin(f);
				base_redraw_ui();
			}
			if(ui->is_hovered&&ui->input_released_r){
				gc_unroot(_box_preferences_f);_box_preferences_f=string_copy(f);gc_root(_box_preferences_f);
				ui_menu_draw(&box_preferences_show_12096				,-1,-1);
			}
		}
	}
}

void box_preferences_fetch_themes(){
	gc_unroot(box_preferences_themes);box_preferences_themes=file_read_directory(string_join(string_join(path_data(),path_sep),"themes"));gc_root(box_preferences_themes);
	for(i32 i=0;i<box_preferences_themes->length;++i){
		string_t * s=box_preferences_themes->buffer[i];
		box_preferences_themes->buffer[i]=substring(box_preferences_themes->buffer[i],0,string_length(s)-5);
	}
	array_insert(box_preferences_themes,0,"default");
}

void box_preferences_fetch_keymaps(){
	gc_unroot(box_preferences_files_keymap);box_preferences_files_keymap=file_read_directory(string_join(string_join(path_data(),path_sep),"keymap_presets"));gc_root(box_preferences_files_keymap);
	for(i32 i=0;i<box_preferences_files_keymap->length;++i){
		string_t * s=box_preferences_files_keymap->buffer[i];
		box_preferences_files_keymap->buffer[i]=substring(box_preferences_files_keymap->buffer[i],0,string_length(s)-5);
	}
	array_insert(box_preferences_files_keymap,0,"default");
}

void box_preferences_fetch_plugins(){
	gc_unroot(box_preferences_files_plugin);box_preferences_files_plugin=file_read_directory(string_join(string_join(path_data(),path_sep),"plugins"));gc_root(box_preferences_files_plugin);
}

i32 box_preferences_get_theme_index(){
	return char_ptr_array_index_of(box_preferences_themes,substring(config_raw->theme,0,string_length(config_raw->theme)-5));
}

i32 box_preferences_get_preset_index(){
	return char_ptr_array_index_of(box_preferences_files_keymap,substring(config_raw->keymap,0,string_length(config_raw->keymap)-5));
}

void box_preferences_set_scale(){
	f32 scale=config_raw->window_scale;
	_ui_set_scale(ui_base_ui,scale);
	ui_header_h=math_floor(ui_header_default_h*scale);
	config_raw->layout->buffer[layout_size_t_STATUS_H]=math_floor(ui_status_default_status_h*scale);
	ui_menubar_w=math_floor(ui_menubar_default_w*scale);
	ui_base_set_icon_scale();
	_ui_set_scale(ui_nodes_ui,scale);
	_ui_set_scale(ui_view2d_ui,scale);
	_ui_set_scale(base_ui_box,scale);
	_ui_set_scale(base_ui_menu,scale);
	base_resize();
	config_raw->layout->buffer[layout_size_t_SIDEBAR_W]=math_floor(ui_base_default_sidebar_w*scale);
}

string_t * box_preferences_theme_to_json(ui_theme_t * theme){
	json_encode_begin();
	u32_ptr u32_theme=theme;
	for(i32 i=0;i<ui_theme_keys_count;++i){
		string_t * key=ARRAY_ACCESS(ui_theme_keys,i);
		u32 val=DEREFERENCE(u32_theme+i);
		json_encode_i32(key,val);
	}
	return json_encode_end();
}

void box_projects_show(){
	if(box_projects_icon_map!=null){
		string_t_array_t * keys=map_keys(box_projects_icon_map);
		for(i32 i=0;i<keys->length;++i){
			string_t * handle=keys->buffer[i];
			data_delete_image(handle);
		}
		gc_unroot(box_projects_icon_map);box_projects_icon_map=null;
	}
	bool draggable;
	draggable=true;
	ui_box_show_custom(&box_projects_show_12842	,600,400,null,draggable);
}

void box_projects_show_12842(ui_t * ui){
box_projects_recent_tab(ui);
}

void box_projects_tab(ui_t * ui){
	if(ui_tab(box_projects_htab,tr("Projects",null),true,-1)){
		ui_begin_sticky();
		box_projects_draw_badge(ui);
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
			project_new(true);
			viewport_scale_to_bounds();
			ui_box_hide();
			i32 i=0;
			i32 j=0;
			string_t * title=tr("untitled",null)+i;
			while(j<config_raw->recent_projects->length){
				string_t * base=config_raw->recent_projects->buffer[j];
				base=string_copy(substring(base,string_last_index_of(base,path_sep)+1,string_last_index_of(base,".")));
				j++;
				if(string_equals(title,base)){
					i++;
					title=tr("untitled",null)+i;
					j=0;
				}
			}
			sys_title_set(title);
		}
		ui_end_sticky();
		ui_separator(3,false);
		i32 slotw=math_floor(150*ui_SCALE(ui));
		i32 num=math_floor(iron_window_width()/(float)slotw);
		if(num==0){
			return ;
		}
		string_t_array_t * recent_projects=config_raw->recent_projects;
		bool show_asset_names=true;
		for(i32 row=0;row<math_ceil(recent_projects->length/(float)num);++row){
			i32 mult=show_asset_names?2:1;
			f32_array_t * ar=f32_array_create_from_raw((f32[]){},0);
			for(i32 i=0;i<num*mult;++i){
				f32_array_push(ar,1/(float)num);
			}
			ui_row(ar);
			ui->_x+=2;
			f32 off=show_asset_names?ui_ELEMENT_OFFSET(ui)*16.0:6;
			if(row>0){
				ui->_y+=off;
			}
			for(i32 j=0;j<num;++j){
				i32 imgw=math_floor(128*ui_SCALE(ui));
				i32 i=j+row*num;
				if(i>=recent_projects->length){
					_ui_end_element(imgw);
					if(show_asset_names){
						_ui_end_element(0);
					}
					continue;
				}
				string_t * path=recent_projects->buffer[i];
				string_t * icon_path=string_join(substring(path,0,string_length(path)-4),"_icon.png");
				if(box_projects_icon_map==null){
					gc_unroot(box_projects_icon_map);box_projects_icon_map=any_map_create();gc_root(box_projects_icon_map);
				}
				gpu_texture_t * icon=any_map_get(box_projects_icon_map,icon_path);
				if(icon==null){
					gpu_texture_t * image=data_get_image(icon_path);
					icon=image;
					any_map_set(box_projects_icon_map,icon_path,icon);
				}
				i32 uix=ui->_x;
				if(icon!=null){
					ui_fill(0,0,128,128,ui->ops->theme->SEPARATOR_COL);
					i32 state=_ui_image(icon,0xffffffff,128*ui_SCALE(ui),0,0,0,0);
					if(state==ui_state_t_RELEASED){
						i32 _uix=ui->_x;
						ui->_x=uix;
						ui_fill(0,0,128,128,0x66000000);
						ui->_x=_uix;
						sys_notify_on_init(&box_projects_tab_13429						,path);
					}
					string_t * name=substring(path,string_last_index_of(path,path_sep)+1,string_last_index_of(path,"."));
					if(ui->is_hovered&&ui->input_released_r){
						gc_unroot(_box_projects_path);_box_projects_path=string_copy(path);gc_root(_box_projects_path);
						gc_unroot(_box_projects_icon_path);_box_projects_icon_path=string_copy(icon_path);gc_root(_box_projects_icon_path);
						_box_projects_i=i;
						ui_menu_draw(&box_projects_tab_13498						,-1,-1);
					}
					if(show_asset_names){
						ui->_x=uix-(150-128)/(float)2;
						ui->_y+=slotw*0.9;
						ui_text(name,ui_align_t_CENTER,0x00000000);
						if(ui->is_hovered){
							ui_tooltip(name);
						}
						ui->_y-=slotw*0.9;
						if(i==recent_projects->length-1){
							ui->_y+=j==num-1?imgw:imgw+ui_ELEMENT_H(ui)+ui_ELEMENT_OFFSET(ui);
						}
					}
				}
				else {
					_ui_end_element(0);
					if(show_asset_names){
						_ui_end_element(0);
					}
					ui->_x=uix;
				}
			}
			ui->_y+=150;
		}
	}
}

void box_projects_tab_13518(){
file_delete(_box_projects_path);
							file_delete(_box_projects_icon_path);
							string_t * data_path=substring(_box_projects_path,0,string_length(_box_projects_path)-4);
							file_delete(data_path);
							string_t_array_t * recent_projects=config_raw->recent_projects;
							array_splice(recent_projects,_box_projects_i,1);
}

void box_projects_tab_13498(ui_t * ui){
if(ui_menu_button(tr("Delete",null),"")){
							sys_notify_on_init(&box_projects_tab_13518							,null);
						}
}

void box_projects_tab_13429(string_t * path){
ui_box_hide();
						import_arm_run_project(path);
}

void box_projects_recent_tab(ui_t * ui){
	if(ui_tab(box_projects_htab,tr("Recent",null),true,-1)){
		box_projects_draw_badge(ui);
		ui->enabled=config_raw->recent_projects->length>0;
		box_projects_hsearch->text=string_copy(ui_text_input(box_projects_hsearch,tr("Search",null),ui_align_t_LEFT,true,true));
		ui->enabled=true;
		for(i32 i=0;i<config_raw->recent_projects->length;++i){
			string_t * path=config_raw->recent_projects->buffer[i];
			path=string_copy(string_replace_all(path,"/","\\"));
			string_t * file=substring(path,string_last_index_of(path,path_sep)+1,string_length(path));
			if(string_index_of(to_lower_case(file),to_lower_case(box_projects_hsearch->text))<0){
				continue;
			}
			if(ui_button(file,ui_align_t_LEFT,"")&&file_exists(path)){
				gpu_texture_t * current=_draw_current;
				bool in_use=gpu_in_use;
				if(in_use)draw_end();
				import_arm_run_project(path);
				if(in_use)draw_begin(current,false,0);
				ui_box_hide();
			}
			if(ui->is_hovered){
				ui_tooltip(path);
			}
		}
		ui->enabled=config_raw->recent_projects->length>0;
		if(ui_button(tr("Clear",null),ui_align_t_LEFT,"")){
			config_raw->recent_projects=any_array_create_from_raw((any[]){},0);
			config_save();
		}
		ui->enabled=true;
		_ui_end_element(-1.0);
		if(ui_button(tr("New Project...",null),ui_align_t_LEFT,"")){
			project_new_box();
		}
		if(ui_button(tr("Open...",null),ui_align_t_LEFT,"")){
			project_open();
		}
	}
}

void box_projects_draw_badge(ui_t * ui){
	gpu_texture_t * img=data_get_image("badge.k");
	_ui_image(img,0xffffffff,-1.0,0,0,0,0);
	_ui_end_element(-1.0);
}

void box_projects_get_started_tab(ui_t * ui){
	if(ui_tab(box_projects_htab,tr("Get Started",null),true,-1)){
		if(ui_button(tr("Manual",null),ui_align_t_CENTER,"")){
			file_load_url(string_join(manifest_url,"/manual"));
		}
		if(ui_button(tr("How To",null),ui_align_t_CENTER,"")){
			file_load_url(string_join(manifest_url,"/howto"));
		}
		if(ui_button(tr("What's New",null),ui_align_t_CENTER,"")){
			file_load_url(string_join(manifest_url,"/notes"));
		}
	}
}

void box_projects_align_to_fullscreen(){
	ui_box_modalw=math_floor(iron_window_width()/(float)ui_SCALE(base_ui_box));
	ui_box_modalh=math_floor(iron_window_height()/(float)ui_SCALE(base_ui_box));
	i32 appw=iron_window_width();
	i32 apph=iron_window_height();
	i32 mw=appw;
	i32 mh=apph;
	ui_box_hwnd->drag_x=math_floor(-appw/(float)2+mw/(float)2);
	ui_box_hwnd->drag_y=math_floor(-apph/(float)2+mh/(float)2);
}

void camera_init(){
	camera_reset(-1);
}

void camera_update(){
	camera_object_t * camera=scene_camera;
	if(mouse_view_x()<0||mouse_view_x()>sys_w()||mouse_view_y()<0||mouse_view_y()>sys_h()){
		if(config_raw->wrap_mouse&&camera_controls_down){
			if(mouse_view_x()<0){
				mouse_x=mouse_last_x=sys_x()+sys_w();
				iron_mouse_set_position(math_floor(mouse_x),math_floor(mouse_y));
			}
			else if(mouse_view_x()>sys_w()){
				mouse_x=mouse_last_x=sys_x();
				iron_mouse_set_position(math_floor(mouse_x),math_floor(mouse_y));
			}
			else if(mouse_view_y()<0){
				mouse_y=mouse_last_y=sys_y()+sys_h();
				iron_mouse_set_position(math_floor(mouse_x),math_floor(mouse_y));
			}
			else if(mouse_view_y()>sys_h()){
				mouse_y=mouse_last_y=sys_y();
				iron_mouse_set_position(math_floor(mouse_x),math_floor(mouse_y));
			}
		}
		else {
			return ;
		}
	}
	bool modif_key=keyboard_down("alt")||keyboard_down("shift")||keyboard_down("control");
	bool modif=modif_key||string_equals(any_map_get(config_keymap,"action_rotate"),"middle");
	bool default_keymap=string_equals(config_raw->keymap,"default.json");
	if(operator_shortcut(any_map_get(config_keymap,"action_rotate"),shortcut_type_t_STARTED)||operator_shortcut(any_map_get(config_keymap,"action_zoom"),shortcut_type_t_STARTED)||operator_shortcut(any_map_get(config_keymap,"action_pan"),shortcut_type_t_STARTED)||operator_shortcut(any_map_get(config_keymap,"rotate_envmap"),shortcut_type_t_STARTED)||(mouse_started("right")&&!modif)||(mouse_started("middle")&&!modif)||(mouse_wheel_delta!=0&&!modif_key)){
		camera_controls_down=true;
	}
	else if(!operator_shortcut(any_map_get(config_keymap,"action_rotate"),shortcut_type_t_DOWN)&&!operator_shortcut(any_map_get(config_keymap,"action_zoom"),shortcut_type_t_DOWN)&&!operator_shortcut(any_map_get(config_keymap,"action_pan"),shortcut_type_t_DOWN)&&!operator_shortcut(any_map_get(config_keymap,"rotate_envmap"),shortcut_type_t_DOWN)&&!(mouse_down("right")&&!modif)&&!(mouse_down("middle")&&!modif)&&(mouse_wheel_delta==0&&!modif_key)){
		camera_controls_down=false;
	}
	if(_input_occupied||!base_ui_enabled||base_is_dragging||base_is_scrolling()||base_is_combo_selected()||!camera_controls_down){
		return ;
	}
	camera_controls_t controls=context_raw->camera_controls;
	if(controls==camera_controls_t_ORBIT&&(operator_shortcut(any_map_get(config_keymap,"action_rotate"),shortcut_type_t_DOWN)||(mouse_down("right")&&!modif&&default_keymap))){
		camera_redraws=2;
		f32 dist=camera_distance();
		transform_move(camera->base->transform,camera_object_look_world(camera),dist);
		transform_rotate(camera->base->transform,vec4_z_axis(),-mouse_movement_x/(float)100*config_raw->camera_rotation_speed);
		transform_rotate(camera->base->transform,camera_object_right_world(camera),-mouse_movement_y/(float)100*config_raw->camera_rotation_speed);
		vec4_t up_world=camera_object_up_world(camera);
		if(up_world.z<0){
			transform_rotate(camera->base->transform,camera_object_right_world(camera),mouse_movement_y/(float)100*config_raw->camera_rotation_speed);
		}
		transform_move(camera->base->transform,camera_object_look_world(camera),-dist);
	}
	else if(controls==camera_controls_t_ROTATE&&(operator_shortcut(any_map_get(config_keymap,"action_rotate"),shortcut_type_t_DOWN)||(mouse_down("right")&&!modif&&default_keymap))){
		camera_redraws=2;
		transform_t * t=context_main_object()->base->transform;
		vec4_t up=transform_up(t);
		transform_rotate(t,up,mouse_movement_x/(float)100*config_raw->camera_rotation_speed);
		vec4_t right=camera_object_right_world(camera);
		transform_rotate(t,right,mouse_movement_y/(float)100*config_raw->camera_rotation_speed);
		transform_build_matrix(t);
		vec4_t tup=transform_up(t);
		if(tup.z<0){
			transform_rotate(t,right,-mouse_movement_y/(float)100*config_raw->camera_rotation_speed);
		}
	}
	if(controls==camera_controls_t_ROTATE||controls==camera_controls_t_ORBIT){
		camera_pan_action(modif,default_keymap);
		if(operator_shortcut(any_map_get(config_keymap,"action_zoom"),shortcut_type_t_DOWN)){
			camera_redraws=2;
			f32 f=camera_get_zoom_delta()/(float)150;
			f*=camera_get_zoom_speed();
			transform_move(camera->base->transform,camera_object_look(camera),f);
		}
		if(mouse_wheel_delta!=0&&!modif_key){
			camera_redraws=2;
			f32 f=mouse_wheel_delta*(-0.1);
			f*=camera_get_zoom_speed();
			transform_move(camera->base->transform,camera_object_look(camera),f);
		}
	}
	else if(controls==camera_controls_t_FLY&&mouse_down("right")){
		bool move_forward=keyboard_down("w")||keyboard_down("up")||mouse_wheel_delta<0;
		bool move_backward=keyboard_down("s")||keyboard_down("down")||mouse_wheel_delta>0;
		bool strafe_left=keyboard_down("a")||keyboard_down("left");
		bool strafe_right=keyboard_down("d")||keyboard_down("right");
		bool strafe_up=keyboard_down("e");
		bool strafe_down=keyboard_down("q");
		f32 fast=keyboard_down("shift")?2.0:(keyboard_down("alt")?0.5:1.0);
		if(mouse_wheel_delta!=0){
			fast*=math_abs(mouse_wheel_delta)*4.0;
		}
		if(move_forward||move_backward||strafe_right||strafe_left||strafe_up||strafe_down){
			camera_ease+=sys_delta()*15;
			if(camera_ease>1.0){
				camera_ease=1.0;
			}
			camera_dir=vec4_create(0,0,0,1.0);
			vec4_t look=camera_object_look(camera);
			vec4_t right=camera_object_right(camera);
			if(move_forward){
				camera_dir=vec4_fadd(camera_dir,look.x,look.y,look.z,0.0);
			}
			if(move_backward){
				camera_dir=vec4_fadd(camera_dir,-look.x,-look.y,-look.z,0.0);
			}
			if(strafe_right){
				camera_dir=vec4_fadd(camera_dir,right.x,right.y,right.z,0.0);
			}
			if(strafe_left){
				camera_dir=vec4_fadd(camera_dir,-right.x,-right.y,-right.z,0.0);
			}
			if(strafe_up){
				camera_dir=vec4_fadd(camera_dir,0,0,1,0.0);
			}
			if(strafe_down){
				camera_dir=vec4_fadd(camera_dir,0,0,-1,0.0);
			}
		}
		else {
			camera_ease-=sys_delta()*20.0*camera_ease;
			if(camera_ease<0.0){
				camera_ease=0.0;
			}
		}
		f32 d=sys_delta()*fast*camera_ease*2.0*((move_forward||move_backward)?config_raw->camera_zoom_speed:config_raw->camera_pan_speed);
		if(d>0.0){
			transform_move(camera->base->transform,camera_dir,d);
			if(context_raw->camera_type==camera_type_t_ORTHOGRAPHIC){
				viewport_update_camera_type(context_raw->camera_type);
			}
		}
		camera_redraws=2;
		transform_rotate(camera->base->transform,vec4_z_axis(),-mouse_movement_x/(float)200*config_raw->camera_rotation_speed);
		transform_rotate(camera->base->transform,camera_object_right(camera),-mouse_movement_y/(float)200*config_raw->camera_rotation_speed);
	}
	if(operator_shortcut(any_map_get(config_keymap,"rotate_envmap"),shortcut_type_t_DOWN)){
		camera_redraws=2;
		context_raw->envmap_angle-=mouse_movement_x/(float)100;
	}
	if(camera_redraws>0){
		camera_redraws--;
		context_raw->ddirty=2;
		if(context_raw->camera_type==camera_type_t_ORTHOGRAPHIC){
			viewport_update_camera_type(context_raw->camera_type);
		}
	}
}

f32 camera_distance(){
	camera_object_t * camera=scene_camera;
	return vec4_dist(camera_origins->buffer[camera_index()]->v,camera->base->transform->loc);
}

i32 camera_index(){
	return context_raw->view_index_last>0?1:0;
}

f32 camera_get_zoom_speed(){
	i32 sign=config_raw->zoom_direction==zoom_direction_t_VERTICAL_INVERTED||config_raw->zoom_direction==zoom_direction_t_HORIZONTAL_INVERTED||config_raw->zoom_direction==zoom_direction_t_VERTICAL_HORIZONTAL_INVERTED?-1:1;
	camera_object_t * camera=scene_camera;
	f32 fov_adjust=camera->data->fov;
	return (config_raw->camera_zoom_speed*sign)/(float)fov_adjust;
}

void camera_reset(i32 view_index){
	camera_object_t * camera=scene_camera;
	if(view_index==-1){
		vec4_box_t * v0=GC_ALLOC_INIT(vec4_box_t, {.v=vec4_create(0,0,0,1)});
		vec4_box_t * v1=GC_ALLOC_INIT(vec4_box_t, {.v=vec4_create(0,0,0,1)});
		gc_unroot(camera_origins);camera_origins=any_array_create_from_raw((any[]){v0,v1,},2);gc_root(camera_origins);
		mat4_box_t * m0=GC_ALLOC_INIT(mat4_box_t, {.v=mat4_clone(camera->base->transform->local)});
		mat4_box_t * m1=GC_ALLOC_INIT(mat4_box_t, {.v=mat4_clone(camera->base->transform->local)});
		gc_unroot(camera_views);camera_views=any_array_create_from_raw((any[]){m0,m1,},2);gc_root(camera_views);
	}
	else {
		camera_origins->buffer[view_index]->v=vec4_create(0,0,0,1.0);
		camera_views->buffer[view_index]->v=mat4_clone(camera->base->transform->local);
	}
}

void camera_pan_action(bool modif,bool default_keymap){
	camera_object_t * camera=scene_camera;
	if(operator_shortcut(any_map_get(config_keymap,"action_pan"),shortcut_type_t_DOWN)||(mouse_down("middle")&&!modif&&default_keymap)){
		camera_redraws=2;
		vec4_t look=vec4_mult(transform_look(camera->base->transform),mouse_movement_y/(float)150*config_raw->camera_pan_speed);
		vec4_t right=vec4_mult(transform_right(camera->base->transform),-mouse_movement_x/(float)150*config_raw->camera_pan_speed);
		camera->base->transform->loc=vec4_add(camera->base->transform->loc,look);
		camera->base->transform->loc=vec4_add(camera->base->transform->loc,right);
		camera_origins->buffer[camera_index()]->v=vec4_add(camera_origins->buffer[camera_index()]->v,look);
		camera_origins->buffer[camera_index()]->v=vec4_add(camera_origins->buffer[camera_index()]->v,right);
		camera_object_build_mat(camera);
	}
}

f32 camera_get_zoom_delta(){
	return config_raw->zoom_direction==zoom_direction_t_VERTICAL?-mouse_movement_y:config_raw->zoom_direction==zoom_direction_t_VERTICAL_INVERTED?-mouse_movement_y:config_raw->zoom_direction==zoom_direction_t_HORIZONTAL?mouse_movement_x:config_raw->zoom_direction==zoom_direction_t_HORIZONTAL_INVERTED?mouse_movement_x:-(mouse_movement_y-mouse_movement_x);
}

void compass_render(){
	if(!context_raw->show_compass){
		return ;
	}
	camera_object_t * cam=scene_camera;
	mesh_object_t * compass=scene_get_child(".Compass")->ext;
	bool _visible=compass->base->visible;
	object_t * _parent=compass->base->parent;
	quat_t crot=cam->base->transform->rot;
	f32 ratio=sys_w()/(float)sys_h();
	mat4_t _P=cam->p;
	cam->p=mat4_ortho(-8*ratio,8*ratio,-8,8,-2,2);
	compass->base->visible=true;
	compass->base->parent=cam->base;
	compass->base->transform->loc=vec4_create(7.4*ratio,7.0,-1,1.0);
	compass->base->transform->rot=quat_create(-crot.x,-crot.y,-crot.z,crot.w);
	compass->base->transform->scale=vec4_create(0.4,0.4,0.4,1.0);
	transform_build_matrix(compass->base->transform);
	compass->frustum_culling=false;
	mesh_object_render(compass,"overlay",null);
	if(_compass_hovered!=null){
		line_draw_color=_compass_hovered==_compass_hitbox_x?0xffff0000:_compass_hovered==_compass_hitbox_y?0xff00ff00:0xff0000ff;
		line_draw_strength=0.1;
		shape_draw_sphere(_compass_hovered->transform->world);
	}
	cam->p=_P;
	compass->base->visible=_visible;
	compass->base->parent=_parent;
}

void compass_init_hitbox(){
	if(_compass_hitbox_x!=null){
		return ;
	}
	gc_unroot(_compass_hitbox_x);_compass_hitbox_x=object_create(true);gc_root(_compass_hitbox_x);
	gc_unroot(_compass_hitbox_y);_compass_hitbox_y=object_create(true);gc_root(_compass_hitbox_y);
	gc_unroot(_compass_hitbox_z);_compass_hitbox_z=object_create(true);gc_root(_compass_hitbox_z);
	_compass_hitbox_x->transform->scale=vec4_create(0.15,0.15,0.15,1.0);
	_compass_hitbox_y->transform->scale=vec4_create(0.15,0.15,0.15,1.0);
	_compass_hitbox_z->transform->scale=vec4_create(0.15,0.15,0.15,1.0);
	_compass_hitbox_x->transform->loc=vec4_create(1.5,0,0,1.0);
	_compass_hitbox_y->transform->loc=vec4_create(0,1.5,0,1.0);
	_compass_hitbox_z->transform->loc=vec4_create(0,0,1.5,1.0);
	object_t * compass=scene_get_child(".Compass");
	object_set_parent(_compass_hitbox_x,compass,false,false);
	object_set_parent(_compass_hitbox_y,compass,false,false);
	object_set_parent(_compass_hitbox_z,compass,false,false);
}

bool _compass_compare_quat(quat_t a,quat_t b){
	return a.x==b.x&&a.y==b.y&&a.z==b.z&&a.w==b.w;
}

void compass_update(){
	if(!context_raw->show_compass){
		return ;
	}
	if(_compass_hovered_last!=_compass_hovered){
		gc_unroot(_compass_hovered_last);_compass_hovered_last=_compass_hovered;gc_root(_compass_hovered_last);
		context_raw->ddirty=2;
	}
	gc_unroot(_compass_hovered);_compass_hovered=null;
	f32 x=mouse_view_x()/(float)sys_w();
	f32 y=mouse_view_y()/(float)sys_h();
	bool hover=x>0.9&&x<1.0&&y<0.14&&y>0.0;
	if(hover){
		compass_init_hitbox();
		f32 ratio=sys_w()/(float)sys_h();
		mat4_t _P=scene_camera->p;
		scene_camera->p=mat4_ortho(-8*ratio,8*ratio,-8,8,-2,2);
		transform_build_matrix(_compass_hitbox_x->transform);
		transform_build_matrix(_compass_hitbox_y->transform);
		transform_build_matrix(_compass_hitbox_z->transform);
		transform_t_array_t * ts=any_array_create_from_raw((any[]){_compass_hitbox_x->transform,_compass_hitbox_y->transform,_compass_hitbox_z->transform,},3);
		transform_t * t=raycast_closest_box_intersect(ts,mouse_view_x(),mouse_view_y(),scene_camera);
		if(t!=null){
			quat_t cq=scene_camera->base->transform->rot;
			if(t==_compass_hitbox_x->transform){
				if(mouse_started("left")){
					_compass_compare_quat(quat_from_euler(math_pi()/(float)2,0,math_pi()/(float)2),cq)?viewport_set_view(-1,0,0,math_pi()/(float)2,0,-math_pi()/(float)2):viewport_set_view(1,0,0,math_pi()/(float)2,0,math_pi()/(float)2);
				}
				gc_unroot(_compass_hovered);_compass_hovered=_compass_hitbox_x;gc_root(_compass_hovered);
			}
			else if(t==_compass_hitbox_y->transform){
				if(mouse_started("left")){
					_compass_compare_quat(quat_from_euler(math_pi()/(float)2,0,math_pi()),cq)?viewport_set_view(0,-1,0,math_pi()/(float)2,0,0):viewport_set_view(0,1,0,math_pi()/(float)2,0,math_pi());
				}
				gc_unroot(_compass_hovered);_compass_hovered=_compass_hitbox_y;gc_root(_compass_hovered);
			}
			else {
				if(mouse_started("left")){
					_compass_compare_quat(quat_from_euler(0,0,0),cq)?viewport_set_view(0,0,-1,math_pi(),0,math_pi()):viewport_set_view(0,0,1,0,0,0);
				}
				gc_unroot(_compass_hovered);_compass_hovered=_compass_hitbox_z;gc_root(_compass_hovered);
			}
		}
		scene_camera->p=_P;
	}
}

void config_load(){
	string_t * path="";
	if(path_is_protected()){
		path=string_join(path,iron_internal_save_path());
	}
	path=string_join(path,"config.json");
	buffer_t * blob=data_get_blob(path);
	if(blob!=null){
		config_loaded=true;
		gc_unroot(config_raw);config_raw=json_parse(sys_buffer_to_string(blob));gc_root(config_raw);
	}
}

void config_save(){
	string_t * path="";
	if(path_is_protected()){
		path=string_join(path,iron_internal_save_path());
	}
	else {
		path=string_join(path,path_data());
		path=string_join(path,path_sep);
	}
	path=string_join(path,"config.json");
	json_encode_begin();
	json_encode_string("locale",config_raw->locale);
	json_encode_i32("window_mode",config_raw->window_mode);
	json_encode_i32("window_w",config_raw->window_w);
	json_encode_i32("window_h",config_raw->window_h);
	json_encode_i32("window_x",config_raw->window_x);
	json_encode_i32("window_y",config_raw->window_y);
	json_encode_bool("window_resizable",config_raw->window_resizable);
	json_encode_bool("window_maximizable",config_raw->window_maximizable);
	json_encode_bool("window_minimizable",config_raw->window_minimizable);
	json_encode_bool("window_vsync",config_raw->window_vsync);
	json_encode_i32("window_frequency",config_raw->window_frequency);
	json_encode_f32("window_scale",config_raw->window_scale);
	json_encode_f32("rp_supersample",config_raw->rp_supersample);
	json_encode_bool("rp_ssao",config_raw->rp_ssao);
	json_encode_bool("rp_bloom",config_raw->rp_bloom);
	json_encode_bool("rp_gi",config_raw->rp_gi);
	json_encode_f32("rp_vignette",config_raw->rp_vignette);
	json_encode_f32("rp_grain",config_raw->rp_grain);
	json_encode_string("version",config_raw->version);
	json_encode_string("sha",config_raw->sha);
	json_encode_string_array("recent_projects",config_raw->recent_projects);
	json_encode_string_array("bookmarks",config_raw->bookmarks);
	json_encode_string_array("plugins",config_raw->plugins);
	json_encode_string("keymap",config_raw->keymap);
	json_encode_string("theme",config_raw->theme);
	json_encode_i32("undo_steps",config_raw->undo_steps);
	json_encode_f32("camera_pan_speed",config_raw->camera_pan_speed);
	json_encode_f32("camera_zoom_speed",config_raw->camera_zoom_speed);
	json_encode_f32("camera_rotation_speed",config_raw->camera_rotation_speed);
	json_encode_i32("zoom_direction",config_raw->zoom_direction);
	json_encode_bool("wrap_mouse",config_raw->wrap_mouse);
	json_encode_bool("show_asset_names",config_raw->show_asset_names);
	json_encode_bool("touch_ui",config_raw->touch_ui);
	json_encode_bool("splash_screen",config_raw->splash_screen);
	json_encode_i32_array("layout",config_raw->layout);
	json_encode_i32_array("layout_tabs",config_raw->layout_tabs);
	json_encode_i32("workspace",config_raw->workspace);
	json_encode_i32("camera_controls",config_raw->camera_controls);
	json_encode_string("server",config_raw->server);
	json_encode_i32("viewport_mode",config_raw->viewport_mode);
	json_encode_i32("pathtrace_mode",config_raw->pathtrace_mode);
	json_encode_bool("pressure_radius",config_raw->pressure_radius);
	json_encode_f32("pressure_sensitivity",config_raw->pressure_sensitivity);
	json_encode_f32("displace_strength",config_raw->displace_strength);
	json_encode_i32("layer_res",config_raw->layer_res);
	json_encode_bool("brush_live",config_raw->brush_live);
	json_encode_bool("brush_3d",config_raw->brush_3d);
	json_encode_bool("node_preview",config_raw->node_preview);
	json_encode_bool("pressure_hardness",config_raw->pressure_hardness);
	json_encode_bool("pressure_angle",config_raw->pressure_angle);
	json_encode_bool("pressure_opacity",config_raw->pressure_opacity);
	json_encode_bool("material_live",config_raw->material_live);
	json_encode_bool("brush_depth_reject",config_raw->brush_depth_reject);
	json_encode_bool("brush_angle_reject",config_raw->brush_angle_reject);
	json_encode_i32("dilate",config_raw->dilate);
	json_encode_i32("dilate_radius",config_raw->dilate_radius);
	json_encode_bool("gpu_inference",config_raw->gpu_inference);
	json_encode_string("blender",config_raw->blender);
	json_encode_i32("atlas_res",config_raw->atlas_res);
	json_encode_bool("grid_snap",config_raw->grid_snap);
	string_t * config_json=json_encode_end();
	buffer_t * buffer=sys_string_to_buffer(config_json);
	iron_file_save_bytes(path,buffer,0);
}

void config_init(){
	if(!config_loaded||config_raw==null){
		gc_unroot(config_raw);config_raw=GC_ALLOC_INIT(config_t, {0});gc_root(config_raw);
		config_raw->locale="system";
		config_raw->window_mode=0;
		config_raw->window_resizable=true;
		config_raw->window_minimizable=true;
		config_raw->window_maximizable=true;
		config_raw->window_w=1600;
		config_raw->window_h=900;
		config_raw->window_x=-1;
		config_raw->window_y=-1;
		config_raw->window_scale=1.0;
		if(sys_display_width()>=2560&&sys_display_height()>=1600){
			config_raw->window_scale=2.0;
		}
		config_raw->window_vsync=true;
		config_raw->window_frequency=sys_display_frequency();
		config_raw->rp_bloom=false;
		config_raw->rp_gi=false;
		config_raw->rp_vignette=0.2;
		config_raw->rp_grain=0.09;
		config_raw->rp_ssao=true;
		config_raw->rp_supersample=1.0;
		config_raw->version=string_copy(manifest_version);
		config_raw->sha=string_copy(config_get_sha());
		base_init_config();
	}
	else {
		if(!string_equals(config_raw->sha,config_get_sha())){
			config_loaded=false;
			config_init();
			return ;
		}
	}
	ui_touch_scroll=config_raw->touch_ui;
	ui_touch_hold=config_raw->touch_ui;
	ui_touch_tooltip=config_raw->touch_ui;
	base_res_handle->position=config_raw->layer_res;
	keymap_load();
}

string_t * config_get_sha(){
	buffer_t * blob=data_get_blob("version.json");
	if(blob==null){
		return "undefined";
	}
	version_t * v=json_parse(sys_buffer_to_string(blob));
	return v->sha;
}

string_t * config_get_date(){
	buffer_t * blob=data_get_blob("version.json");
	if(blob==null){
		return "undefined";
	}
	version_t * v=json_parse(sys_buffer_to_string(blob));
	return v->date;
}

iron_window_options_t * config_get_options(){
	window_mode_t window_mode=config_raw->window_mode==0?window_mode_t_WINDOWED:window_mode_t_FULLSCREEN;
	window_features_t features=window_features_t_NONE;
	if(config_raw->window_resizable){
		features|=window_features_t_RESIZABLE;
	}
	if(config_raw->window_maximizable){
		features|=window_features_t_MAXIMIZABLE;
	}
	if(config_raw->window_minimizable){
		features|=window_features_t_MINIMIZABLE;
	}
	string_t * title=string_join("untitled - ",manifest_title);
	iron_window_options_t * ops=GC_ALLOC_INIT(iron_window_options_t, {.title=title,.width=config_raw->window_w,.height=config_raw->window_h,.x=config_raw->window_x,.y=config_raw->window_y,.mode=window_mode,.features=features,.vsync=config_raw->window_vsync,.frequency=config_raw->window_frequency});
	return ops;
}

void config_restore(){
	gc_unroot(ui_children);ui_children=any_map_create();gc_root(ui_children);
	config_loaded=false;
	i32_array_t * _layout=config_raw->layout;
	config_init();
	config_raw->layout=_layout;
	base_init_layout();
	translator_load_translations(config_raw->locale);
	config_apply();
	config_load_theme(config_raw->theme,true);
}

void config_import_from(config_t * from){
	string_t * _sha=config_raw->sha;
	string_t * _version=config_raw->version;
	gc_unroot(config_raw);config_raw=from;gc_root(config_raw);
	config_raw->sha=string_copy(_sha);
	config_raw->version=string_copy(_version);
	gc_unroot(ui_children);ui_children=any_map_create();gc_root(ui_children);
	keymap_load();
	base_init_layout();
	translator_load_translations(config_raw->locale);
	config_apply();
	config_load_theme(config_raw->theme,true);
}

void config_apply(){
	config_raw->rp_ssao=context_raw->hssao->selected;
	config_raw->rp_bloom=context_raw->hbloom->selected;
	config_raw->rp_gi=context_raw->hvxao->selected;
	config_raw->rp_supersample=config_get_super_sample_size(context_raw->hsupersample->position);
	config_save();
	context_raw->ddirty=2;
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	render_path_base_apply_config();
	if(in_use)draw_begin(current,false,0);
}

i32 config_get_super_sample_quality(f32 f){
	return f==0.25?0:f==0.5?1:f==1.0?2:f==1.5?3:f==2.0?4:5;
}

f32 config_get_super_sample_size(i32 i){
	return i==0?0.25:i==1?0.5:i==2?1.0:i==3?1.5:i==4?2.0:4.0;
}

i32 config_texture_res_size(i32 pos){
	return pos==texture_res_t_RES128?128:pos==texture_res_t_RES256?256:pos==texture_res_t_RES512?512:pos==texture_res_t_RES1024?1024:pos==texture_res_t_RES2048?2048:pos==texture_res_t_RES4096?4096:pos==texture_res_t_RES8192?8192:pos==texture_res_t_RES16384?16384:0;
}

i32 config_get_texture_res(){
	i32 res=base_res_handle->position;
	return config_texture_res_size(res);
}

i32 config_get_layer_res(){
	i32 res=config_raw->layer_res;
	return config_texture_res_size(res);
}

i32 config_get_atlas_res(){
	i32 res=config_raw->atlas_res;
	return config_texture_res_size(res);
}

i32 config_get_texture_res_x(){
	return context_raw->project_aspect_ratio==2?math_floor(config_get_texture_res()/(float)2):config_get_texture_res();
}

i32 config_get_texture_res_y(){
	return context_raw->project_aspect_ratio==1?math_floor(config_get_texture_res()/(float)2):config_get_texture_res();
}

i32 config_get_texture_res_pos(i32 i){
	return i==128?texture_res_t_RES128:i==256?texture_res_t_RES256:i==512?texture_res_t_RES512:i==1024?texture_res_t_RES1024:i==2048?texture_res_t_RES2048:i==4096?texture_res_t_RES4096:i==8192?texture_res_t_RES8192:i==16384?texture_res_t_RES16384:0;
}

void config_load_theme(string_t * theme,bool tag_redraw){
	gc_unroot(base_theme);base_theme=ui_theme_create();gc_root(base_theme);
	if(!string_equals(theme,"default.json")){
		buffer_t * b=data_get_blob(string_join("themes/",theme));
		ui_theme_t * parsed=json_parse(sys_buffer_to_string(b));
		gc_unroot(base_theme);base_theme=parsed;gc_root(base_theme);
	}
	base_theme->FILL_WINDOW_BG=true;
	if(tag_redraw){
		for(i32 i=0;i<base_get_uis()->length;++i){
			ui_t * ui=base_get_uis()->buffer[i];
			ui->ops->theme=base_theme;
		}
		ui_base_tag_ui_redraw();
	}
	if(config_raw->touch_ui){
		base_theme->FULL_TABS=true;
		base_theme->ELEMENT_H=24+6;
		base_theme->BUTTON_H=22+6;
		base_theme->FONT_SIZE=13+2;
		base_theme->ARROW_SIZE=5+2;
		base_theme->CHECK_SIZE=15+4;
		base_theme->CHECK_SELECT_SIZE=8+2;
		config_button_align=ui_align_t_LEFT;
		gc_unroot(config_button_spacing);config_button_spacing="";gc_root(config_button_spacing);
	}
	else {
		base_theme->FULL_TABS=false;
		config_button_align=ui_align_t_LEFT;
		gc_unroot(config_button_spacing);config_button_spacing=string_copy(config_default_button_spacing);gc_root(config_button_spacing);
	}
}

void config_enable_plugin(string_t * f){
	any_array_push(config_raw->plugins,f);
	plugin_start(f);
}

void config_disable_plugin(string_t * f){
	char_ptr_array_remove(config_raw->plugins,f);
	plugin_stop(f);
}

void console_draw_toast(string_t * s){
	draw_begin(null,false,0);
	draw_set_color(0x55000000);
	draw_filled_rect(0,0,iron_window_width(),iron_window_height());
	f32 scale=ui_SCALE(base_get_uis()->buffer[0]);
	f32 x=iron_window_width()/(float)2;
	f32 y=iron_window_height()-200*scale;
	draw_filled_rect(x-200*scale,y,400*scale,80*scale);
	draw_set_font(base_font,math_floor(22*scale));
	draw_set_color(0xffffffff);
	draw_string(s,x-draw_string_width(draw_font,draw_font_size,s)/(float)2,y+40*scale-draw_font_height(draw_font,draw_font_size)/(float)2);
	draw_end();
}

void _console_toast_render(string_t * s){
	console_draw_toast(s);
	gpu_present();
	sys_remove_render_2d(_console_toast_render);
}

void console_toast(string_t * s){
	sys_notify_on_render_2d(_console_toast_render,s);
	console_trace(s);
	gpu_present();
}

void console_draw_progress(){
	console_draw_toast(console_progress_text);
}

void console_progress(string_t * s){
	if(s==null){
		sys_remove_render_2d(console_draw_progress);
	}
	else if(console_progress_text==null){
		sys_notify_on_render_2d(console_draw_progress,null);
	}
	if(s!=null){
		console_trace(s);
	}
	gc_unroot(console_progress_text);console_progress_text=string_copy(s);gc_root(console_progress_text);
	ui_end_input();
	draw_end();
	sys_render();
	draw_begin(null,false,0);
	gpu_present();
}

void console_info(string_t * s){
	console_message_timer=5.0;
	gc_unroot(console_message);console_message=string_copy(s);gc_root(console_message);
	console_message_color=0x00000000;
	base_redraw_status();
	console_trace(s);
}

void console_error(string_t * s){
	console_message_timer=8.0;
	gc_unroot(console_message);console_message=string_copy(s);gc_root(console_message);
	console_message_color=0xffaa0000;
	base_redraw_status();
	console_trace(s);
}

void console_log(string_t * s){
	console_trace(s);
}

void console_trace(string_t * s){
	iron_log(s);
	base_redraw_console();
	array_insert(console_last_traces,0,s);
	if(console_last_traces->length>100){
		array_pop(console_last_traces);
	}
}

context_t * context_create(){
	context_t * c=GC_ALLOC_INIT(context_t, {0});
	c->merged_object_is_atlas=false;
	c->ddirty=0;
	c->pdirty=0;
	c->rdirty=0;
	c->brush_blend_dirty=true;
	c->node_preview_socket=0;
	c->split_view=false;
	c->view_index=-1;
	c->view_index_last=-1;
	c->picked_color=make_swatch(0xffffffff);
	c->envmap_loaded=false;
	c->show_envmap=false;
	c->show_envmap_handle=ui_handle_create();
	c->show_envmap_blur=false;
	c->show_envmap_blur_handle=ui_handle_create();
	c->envmap_angle=0.0;
	c->light_angle=0.0;
	c->cull_backfaces=true;
	c->texture_filter=true;
	c->format_type=texture_ldr_format_t_PNG;
	c->format_quality=100.0;
	c->layers_destination=export_destination_t_DISK;
	c->split_by=split_type_t_OBJECT;
	c->parse_transform=true;
	c->parse_vcols=false;
	c->select_time=0.0;
	c->viewport_mode=config_raw->viewport_mode==0?viewport_mode_t_LIT:viewport_mode_t_PATH_TRACE;
	c->render_mode=render_mode_t_DEFERRED;
	c->hscale_was_changed=false;
	c->export_mesh_format=mesh_format_t_OBJ;
	c->export_mesh_index=0;
	c->pack_assets_on_export=true;
	c->paint_vec=vec4_create(0.0,0.0,0.0,1.0);
	c->last_paint_x=-1.0;
	c->last_paint_y=-1.0;
	c->foreground_event=false;
	c->painted=0;
	c->brush_time=0.0;
	c->clone_start_x=-1.0;
	c->clone_start_y=-1.0;
	c->clone_delta_x=0.0;
	c->clone_delta_y=0.0;
	c->show_compass=true;
	c->project_type=project_model_t_ROUNDED_CUBE;
	c->project_aspect_ratio=0;
	c->last_paint_vec_x=-1.0;
	c->last_paint_vec_y=-1.0;
	c->prev_paint_vec_x=-1.0;
	c->prev_paint_vec_y=-1.0;
	c->frame=0;
	c->paint2d_view=false;
	c->lock_started_x=-1.0;
	c->lock_started_y=-1.0;
	c->brush_locked=false;
	c->brush_can_lock=false;
	c->brush_can_unlock=false;
	c->camera_type=camera_type_t_PERSPECTIVE;
	c->cam_handle=ui_handle_create();
	c->vxao_ext=1.0;
	c->vxao_offset=1.5;
	c->vxao_aperture=1.2;
	c->texture_export_path="";
	c->last_status_position=0;
	c->camera_controls=camera_controls_t_ORBIT;
	c->pen_painting_only=false;
	c->layer_preview_dirty=true;
	c->layers_preview_dirty=false;
	c->node_preview_dirty=false;
	c->node_preview_name="";
	c->colorid_picked=false;
	c->material_preview=false;
	c->saved_camera=mat4_identity();
	c->materialid_picked=0;
	c->uvx_picked=0.0;
	c->uvy_picked=0.0;
	c->picker_select_material=true;
	c->picker_mask_handle=ui_handle_create();
	c->pick_pos_nor_tex=false;
	c->posx_picked=0.0;
	c->posy_picked=0.0;
	c->posz_picked=0.0;
	c->norx_picked=0.0;
	c->nory_picked=0.0;
	c->norz_picked=0.0;
	c->draw_wireframe=false;
	c->wireframe_handle=ui_handle_create();
	c->draw_texels=false;
	c->texels_handle=ui_handle_create();
	c->colorid_handle=ui_handle_create();
	c->layers_export=export_mode_t_VISIBLE;
	c->decal_preview=false;
	c->decal_x=0.0;
	c->decal_y=0.0;
	c->write_icon_on_export=false;
	c->particle_hit_x=0.0;
	c->particle_hit_y=0.0;
	c->particle_hit_z=0.0;
	c->last_particle_hit_x=0.0;
	c->last_particle_hit_y=0.0;
	c->last_particle_hit_z=0.0;
	c->layer_filter=0;
	c->gizmo_started=false;
	c->gizmo_offset=0.0;
	c->gizmo_drag=0.0;
	c->gizmo_drag_last=0.0;
	c->translate_x=false;
	c->translate_y=false;
	c->translate_z=false;
	c->scale_x=false;
	c->scale_y=false;
	c->scale_z=false;
	c->rotate_x=false;
	c->rotate_y=false;
	c->rotate_z=false;
	c->brush_nodes_radius=1.0;
	c->brush_nodes_opacity=1.0;
	c->brush_mask_image_is_alpha=false;
	c->brush_stencil_image_is_alpha=false;
	c->brush_stencil_x=0.02;
	c->brush_stencil_y=0.02;
	c->brush_stencil_scale=0.9;
	c->brush_stencil_scaling=false;
	c->brush_stencil_angle=0.0;
	c->brush_stencil_rotating=false;
	c->brush_nodes_scale=1.0;
	c->brush_nodes_angle=0.0;
	c->brush_nodes_hardness=1.0;
	c->brush_directional=false;
	c->brush_radius_handle=ui_handle_create();
	c->brush_scale_x=1.0;
	c->brush_decal_mask_radius=0.5;
	c->brush_decal_mask_radius_handle=ui_handle_create();
	c->brush_decal_mask_radius_handle->value=0.5;
	c->brush_scale_x_handle=ui_handle_create();
	c->brush_scale_x_handle->value=1.0;
	c->brush_blending=blend_type_t_MIX;
	c->brush_opacity=1.0;
	c->brush_opacity_handle=ui_handle_create();
	c->brush_opacity_handle->value=1.0;
	c->brush_scale=1.0;
	c->brush_angle=0.0;
	c->brush_angle_handle=ui_handle_create();
	c->brush_angle_handle->value=0.0;
	c->brush_lazy_radius=0.0;
	c->brush_lazy_step=0.0;
	c->brush_lazy_x=0.0;
	c->brush_lazy_y=0.0;
	c->brush_paint=uv_type_t_UVMAP;
	c->brush_angle_reject_dot=0.5;
	c->bake_type=bake_type_t_AO;
	c->bake_axis=bake_axis_t_XYZ;
	c->bake_up_axis=bake_up_axis_t_Z;
	c->bake_samples=128;
	c->bake_ao_strength=1.0;
	c->bake_ao_radius=1.0;
	c->bake_ao_offset=1.0;
	c->bake_curv_strength=1.0;
	c->bake_curv_radius=1.0;
	c->bake_curv_offset=0.0;
	c->bake_curv_smooth=1;
	c->bake_high_poly=0;
	c->xray=false;
	c->sym_x=false;
	c->sym_y=false;
	c->sym_z=false;
	c->fill_type_handle=ui_handle_create();
	c->paint2d=false;
	c->last_htab0_pos=0;
	c->maximized_sidebar_width=0;
	c->drag_dest=0;
	return c;
}

void context_init(){
	gc_unroot(context_raw);context_raw=context_create();gc_root(context_raw);
	context_ext_init(context_raw);
}

bool context_use_deferred(){
	return context_raw->render_mode!=render_mode_t_FORWARD&&(context_raw->viewport_mode==viewport_mode_t_LIT||context_raw->viewport_mode==viewport_mode_t_PATH_TRACE)&&context_raw->tool!=workspace_tool_t_COLORID;
}

void context_select_material(i32 i){
	if(project_materials->length<=i){
		return ;
	}
	context_set_material(project_materials->buffer[i]);
}

void context_set_material(slot_material_t * m){
	if(array_index_of(project_materials,m)==-1){
		return ;
	}
	context_raw->material=m;
	make_material_parse_paint_material(true);
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	ui_header_handle->redraws=2;
	ui_nodes_hwnd->redraws=2;
	gc_unroot(ui_nodes_group_stack);ui_nodes_group_stack=any_array_create_from_raw((any[]){},0);gc_root(ui_nodes_group_stack);
	bool decal=context_is_decal();
	if(decal){
		sys_notify_on_next_frame(util_render_make_decal_preview,null);
	}
}

void context_select_brush(i32 i){
	if(project_brushes->length<=i){
		return ;
	}
	context_set_brush(project_brushes->buffer[i]);
}

void context_set_brush(slot_brush_t * b){
	if(array_index_of(project_brushes,b)==-1){
		return ;
	}
	context_raw->brush=b;
	make_material_parse_brush();
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	ui_nodes_hwnd->redraws=2;
}

void context_select_font(i32 i){
	if(project_fonts->length<=i){
		return ;
	}
	context_set_font(project_fonts->buffer[i]);
}

void context_set_font(slot_font_t * f){
	if(array_index_of(project_fonts,f)==-1){
		return ;
	}
	context_raw->font=f;
	util_render_make_text_preview();
	util_render_make_decal_preview();
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
	ui_view2d_hwnd->redraws=2;
}

void context_select_layer(i32 i){
	if(project_layers->length<=i){
		return ;
	}
	context_set_layer(project_layers->buffer[i]);
}

void context_set_layer(slot_layer_t * l){
	if(l==context_raw->layer){
		return ;
	}
	context_raw->layer=l;
	ui_header_handle->redraws=2;
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	layers_set_object_mask();
	make_material_parse_mesh_material();
	make_material_parse_paint_material(true);
	if(in_use)draw_begin(current,false,0);
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	ui_view2d_hwnd->redraws=2;
}

void context_select_tool(i32 i){
	context_raw->tool=i;
	make_material_parse_paint_material(true);
	make_material_parse_mesh_material();
	context_raw->ddirty=3;
	viewport_mode_t _viewport_mode=context_raw->viewport_mode;
	context_raw->viewport_mode=viewport_mode_t_MINUS_ONE;
	context_set_viewport_mode(_viewport_mode);
	context_init_tool();
	ui_header_handle->redraws=2;
	ui_toolbar_handle->redraws=2;
}

void context_init_tool(){
	bool decal=context_is_decal();
	if(decal){
		if(context_raw->tool==workspace_tool_t_TEXT){
			util_render_make_text_preview();
		}
		util_render_make_decal_preview();
	}
	else if(context_raw->tool==workspace_tool_t_PARTICLE){
		util_particle_init();
	}
	else if(context_raw->tool==workspace_tool_t_BAKE){
		if(context_raw->viewport_mode==viewport_mode_t_PATH_TRACE){
			context_raw->viewport_mode=viewport_mode_t_LIT;
		}
	}
	else if(context_raw->tool==workspace_tool_t_MATERIAL){
		layers_update_fill_layers();
		context_main_object()->skip_context=null;
	}
}

void context_select_paint_object(mesh_object_t * o){
	context_ext_select_paint_object(o);
}

mesh_object_t * context_main_object(){
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * po=project_paint_objects->buffer[i];
		if(po->base->children->length>0){
			return po;
		}
	}
	return project_paint_objects->buffer[0];
}

bool context_layer_filter_used(){
	return context_raw->layer_filter>0&&context_raw->layer_filter<=project_paint_objects->length;
}

bool context_object_mask_used(){
	return slot_layer_get_object_mask(context_raw->layer)>0&&slot_layer_get_object_mask(context_raw->layer)<=project_paint_objects->length;
}

bool context_in_viewport(){
	return context_raw->paint_vec.x<1&&context_raw->paint_vec.x>0&&context_raw->paint_vec.y<1&&context_raw->paint_vec.y>0;
}

bool context_in_paint_area(){
	i32 right=sys_w();
	if(ui_view2d_show){
		right+=ui_view2d_ww;
	}
	return mouse_view_x()>0&&mouse_view_x()<right&&mouse_view_y()>0&&mouse_view_y()<sys_h();
}

bool context_in_layers(){
	string_t * tab=ui_hovered_tab_name();
	return string_equals(tab,tr("Layers",null));
}

bool context_in_materials(){
	string_t * tab=ui_hovered_tab_name();
	return string_equals(tab,tr("Materials",null));
}

bool context_in_2d_view(view_2d_type_t type){
	return ui_view2d_show&&ui_view2d_type==type&&mouse_x>ui_view2d_wx&&mouse_x<ui_view2d_wx+ui_view2d_ww&&mouse_y>ui_view2d_wy&&mouse_y<ui_view2d_wy+ui_view2d_wh;
}

bool context_in_nodes(){
	return ui_nodes_show&&mouse_x>ui_nodes_wx&&mouse_x<ui_nodes_wx+ui_nodes_ww&&mouse_y>ui_nodes_wy&&mouse_y<ui_nodes_wy+ui_nodes_wh;
}

bool context_in_swatches(){
	string_t * tab=ui_hovered_tab_name();
	return string_equals(tab,tr("Swatches",null));
}

bool context_in_browser(){
	string_t * tab=ui_hovered_tab_name();
	return string_equals(tab,tr("Browser",null));
}

bool context_is_picker(){
	return context_raw->tool==workspace_tool_t_PICKER||context_raw->tool==workspace_tool_t_MATERIAL;
}

bool context_is_decal(){
	return context_raw->tool==workspace_tool_t_DECAL||context_raw->tool==workspace_tool_t_TEXT;
}

bool context_is_decal_mask(){
	return context_is_decal()&&operator_shortcut(any_map_get(config_keymap,"decal_mask"),shortcut_type_t_DOWN);
}

bool context_is_decal_mask_paint(){
	return context_is_decal()&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN);
}

bool context_is_floating_toolbar(){
	return config_raw->layout->buffer[layout_size_t_HEADER]==0;
}

area_type_t context_get_area_type(){
	if(context_in_viewport()){
		return area_type_t_VIEWPORT;
	}
	if(context_in_nodes()){
		return area_type_t_NODES;
	}
	if(context_in_browser()){
		return area_type_t_BROWSER;
	}
	if(context_in_2d_view(view_2d_type_t_LAYER)){
		return area_type_t_VIEW2D;
	}
	if(context_in_layers()){
		return area_type_t_LAYERS;
	}
	if(context_in_materials()){
		return area_type_t_MATERIALS;
	}
	return area_type_t_MINUS_ONE;
}

void context_set_viewport_mode(viewport_mode_t mode){
	if(mode==context_raw->viewport_mode){
		return ;
	}
	context_raw->viewport_mode=mode;
	if(context_use_deferred()){
		gc_unroot(render_path_commands);render_path_commands=render_path_deferred_commands;gc_root(render_path_commands);
	}
	else {
		gc_unroot(render_path_commands);render_path_commands=render_path_forward_commands;gc_root(render_path_commands);
	}
	i32 _workspace=ui_header_worktab->position;
	ui_header_worktab->position=0;
	make_material_parse_mesh_material();
	ui_header_worktab->position=_workspace;
}

void context_load_envmap(){
	if(!context_raw->envmap_loaded){
		context_raw->envmap_loaded=true;
		map_delete(data_cached_images,"World_radiance.k");
	}
	world_data_load_envmap(scene_world);
	if(context_raw->saved_envmap==null){
		context_raw->saved_envmap=scene_world->_->envmap;
	}
}

void context_update_envmap(){
	if(context_raw->show_envmap){
		scene_world->_->envmap=context_raw->show_envmap_blur?scene_world->_->radiance_mipmaps->buffer[0]:context_raw->saved_envmap;
	}
	else {
		scene_world->_->envmap=context_raw->empty_envmap;
	}
}

void context_set_viewport_shader(any viewport_shader){
	context_raw->viewport_shader=viewport_shader;
	context_set_render_path();
}

void context_set_render_path(){
	if(context_raw->render_mode==render_mode_t_FORWARD||context_raw->viewport_shader!=null){
		gc_unroot(render_path_commands);render_path_commands=render_path_forward_commands;gc_root(render_path_commands);
	}
	else {
		gc_unroot(render_path_commands);render_path_commands=render_path_deferred_commands;gc_root(render_path_commands);
	}
	sys_notify_on_init(make_material_parse_mesh_material,null);
}

bool context_enable_import_plugin(string_t * file){
	if(box_preferences_files_plugin==null){
		box_preferences_fetch_plugins();
	}
	string_t * ext=substring(file,string_last_index_of(file,".")+1,string_length(file));
	for(i32 i=0;i<box_preferences_files_plugin->length;++i){
		string_t * f=box_preferences_files_plugin->buffer[i];
		if(starts_with(f,"import_")&&string_index_of(f,ext)>=0){
			config_enable_plugin(f);
			console_info(string_join(string_join(f," "),tr("plugin enabled",null)));
			return true;
		}
	}
	return false;
}

void context_set_swatch(swatch_color_t * s){
	context_raw->swatch=s;
}

void export_arm_run_mesh(string_t * path,mesh_object_t_array_t * paint_objects){
	mesh_data_t_array_t * mesh_datas=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<paint_objects->length;++i){
		mesh_object_t * p=paint_objects->buffer[i];
		any_array_push(mesh_datas,p->data);
	}
	scene_t * raw=GC_ALLOC_INIT(scene_t, {.mesh_datas=mesh_datas});
	buffer_t * b=util_encode_scene(raw);
	if(!ends_with(path,".arm")){
		path=string_join(path,".arm");
	}
	iron_file_save_bytes(path,b,b->length+1);
}

void export_arm_run_project(){
	ui_node_canvas_t_array_t * mnodes=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		ui_node_canvas_t * c=util_clone_canvas(m->canvas);
		for(i32 i=0;i<c->nodes->length;++i){
			ui_node_t * n=c->nodes->buffer[i];
			export_arm_export_node(n,null);
		}
		any_array_push(mnodes,c);
	}
	ui_node_canvas_t_array_t * bnodes=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project_brushes->length;++i){
		slot_brush_t * b=project_brushes->buffer[i];
		any_array_push(bnodes,b->canvas);
	}
	ui_node_canvas_t_array_t * mgroups=null;
	if(project_material_groups->length>0){
		mgroups=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<project_material_groups->length;++i){
			node_group_t * g=project_material_groups->buffer[i];
			ui_node_canvas_t * c=util_clone_canvas(g->canvas);
			for(i32 i=0;i<c->nodes->length;++i){
				ui_node_t * n=c->nodes->buffer[i];
				export_arm_export_node(n,null);
			}
			any_array_push(mgroups,c);
		}
	}
	mesh_data_t_array_t * md=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		any_array_push(md,p->data);
	}
	string_t_array_t * texture_files=export_arm_assets_to_files(project_filepath,project_assets);
	string_t_array_t * font_files=export_arm_fonts_to_files(project_filepath,project_fonts);
	string_t_array_t * mesh_files=export_arm_meshes_to_files(project_filepath);
	i32 bits_pos=base_bits_handle->position;
	i32 bpp=bits_pos==texture_bits_t_BITS8?8:bits_pos==texture_bits_t_BITS16?16:32;
	layer_data_t_array_t * ld=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		layer_data_t * d=GC_ALLOC_INIT(layer_data_t, {.name=l->name,.res=l->texpaint!=null?l->texpaint->width:project_layers->buffer[0]->texpaint->width,.bpp=bpp,.texpaint=l->texpaint!=null?lz4_encode(gpu_get_texture_pixels(l->texpaint)):null,.uv_scale=l->scale,.uv_rot=l->angle,.uv_type=l->uv_type,.decal_mat=l->uv_type==uv_type_t_PROJECT?mat4_to_f32_array(l->decal_mat):null,.opacity_mask=l->mask_opacity,.fill_layer=l->fill_layer!=null?array_index_of(project_materials,l->fill_layer):-1,.object_mask=l->object_mask,.blending=l->blending,.parent=l->parent!=null?array_index_of(project_layers,l->parent):-1,.visible=l->visible,.texpaint_nor=l->texpaint_nor!=null?lz4_encode(gpu_get_texture_pixels(l->texpaint_nor)):null,.texpaint_pack=l->texpaint_pack!=null?lz4_encode(gpu_get_texture_pixels(l->texpaint_pack)):null,.paint_base=l->paint_base,.paint_opac=l->paint_opac,.paint_occ=l->paint_occ,.paint_rough=l->paint_rough,.paint_met=l->paint_met,.paint_nor=l->paint_nor,.paint_nor_blend=l->paint_nor_blend,.paint_height=l->paint_height,.paint_height_blend=l->paint_height_blend,.paint_emis=l->paint_emis,.paint_subs=l->paint_subs});
		any_array_push(ld,d);
	}
	packed_asset_t_array_t * packed_assets=(project_raw->packed_assets==null||project_raw->packed_assets->length==0)?null:project_raw->packed_assets;
	bool same_drive=project_raw->envmap!=null?char_at(project_filepath,0)==char_at(project_raw->envmap,0):true;
	project_raw->version=string_copy(manifest_version);
	project_raw->material_groups=mgroups;
	project_raw->assets=texture_files;
	project_raw->packed_assets=packed_assets;
	project_raw->swatches=project_raw->swatches;
	project_raw->envmap=project_raw->envmap!=null?(same_drive?path_to_relative(project_filepath,project_raw->envmap):project_raw->envmap):null;
	project_raw->envmap_strength=scene_world->strength;
	project_raw->camera_world=mat4_to_f32_array(scene_camera->base->transform->local);
	project_raw->camera_origin=export_arm_vec3f32(camera_origins->buffer[0]->v);
	project_raw->camera_fov=scene_camera->data->fov;
	if(project_raw->mesh_datas==null){
		project_raw->mesh_datas=md;
	}
	else {
		project_raw->mesh_datas->length=0;
		for(i32 i=0;i<md->length;++i){
			any_array_push(project_raw->mesh_datas,md->buffer[i]);
		}
	}
	project_raw->material_nodes=mnodes;
	project_raw->brush_nodes=bnodes;
	project_raw->layer_datas=ld;
	project_raw->font_assets=font_files;
	project_raw->mesh_assets=mesh_files;
	project_raw->atlas_objects=project_atlas_objects;
	project_raw->atlas_names=project_atlas_names;
	project_raw->is_bgra=false;
	bool is_packed=ends_with(project_filepath,"_packed_.arm");
	if(is_packed){
		export_arm_pack_assets(project_raw,project_assets);
	}
	buffer_t * buffer=util_encode_project(project_raw);
	iron_file_save_bytes(project_filepath,buffer,buffer->length+1);
	string_t * recent_path=project_filepath;
	recent_path=string_copy(string_replace_all(recent_path,"\\","/"));
	string_t_array_t * recent=config_raw->recent_projects;
	char_ptr_array_remove(recent,recent_path);
	array_insert(recent,0,recent_path);
	config_save();
	console_info(tr("Project saved",null));
}

string_t * export_arm_texture_node_name(){
	return "TEX_IMAGE";
}

void export_arm_export_node(ui_node_t * n,asset_t_array_t * assets){
	if(string_equals(n->type,export_arm_texture_node_name())){
		i32 index=n->buttons->buffer[0]->default_value->buffer[0];
		n->buttons->buffer[0]->data=u8_array_create_from_string(base_enum_texts(n->type)->buffer[index]);
		if(assets!=null){
			asset_t * asset=project_assets->buffer[index];
			if(array_index_of(assets,asset)==-1){
				any_array_push(assets,asset);
			}
		}
	}
}

void export_arm_run_material(string_t * path){
	if(!ends_with(path,".arm")){
		path=string_join(path,".arm");
	}
	ui_node_canvas_t_array_t * mnodes=any_array_create_from_raw((any[]){},0);
	ui_node_canvas_t_array_t * mgroups=null;
	slot_material_t * m=context_raw->material;
	ui_node_canvas_t * c=util_clone_canvas(m->canvas);
	asset_t_array_t * assets=any_array_create_from_raw((any[]){},0);
	if(ui_nodes_has_group(c)){
		mgroups=any_array_create_from_raw((any[]){},0);
		ui_nodes_traverse_group(mgroups,c);
		for(i32 i=0;i<mgroups->length;++i){
			ui_node_canvas_t * gc=mgroups->buffer[i];
			for(i32 i=0;i<gc->nodes->length;++i){
				ui_node_t * n=gc->nodes->buffer[i];
				export_arm_export_node(n,assets);
			}
		}
	}
	for(i32 i=0;i<c->nodes->length;++i){
		ui_node_t * n=c->nodes->buffer[i];
		export_arm_export_node(n,assets);
	}
	any_array_push(mnodes,c);
	string_t_array_t * texture_files=export_arm_assets_to_files(path,assets);
	bool is_cloud=ends_with(path,"_cloud_.arm");
	if(is_cloud){
		path=string_copy(string_replace_all(path,"_cloud_",""));
	}
	packed_asset_t_array_t * packed_assets=null;
	if(!context_raw->pack_assets_on_export){
		packed_assets=export_arm_get_packed_assets(path,texture_files);
	}
	buffer_t_array_t * micons=null;
	if(!is_cloud){
		buffer_t * buf=lz4_encode(gpu_get_texture_pixels(m->image));
		micons=any_array_create_from_raw((any[]){buf,},1);
	}
	project_format_t * raw=GC_ALLOC_INIT(project_format_t, {.version=manifest_version,.material_nodes=mnodes,.material_groups=mgroups,.material_icons=micons,.assets=texture_files,.packed_assets=packed_assets});
	if(context_raw->write_icon_on_export){
		iron_write_png(string_join(substring(path,0,string_length(path)-4),"_icon.png"),gpu_get_texture_pixels(m->image),m->image->width,m->image->height,0);
		if(is_cloud){
			iron_write_jpg(string_join(substring(path,0,string_length(path)-4),"_icon.jpg"),gpu_get_texture_pixels(m->image),m->image->width,m->image->height,0,50);
		}
	}
	if(context_raw->pack_assets_on_export){
		export_arm_pack_assets(raw,assets);
	}
	buffer_t * buffer=util_encode_project(raw);
	iron_file_save_bytes(path,buffer,buffer->length+1);
}

buffer_t * export_arm_bgra_swap(buffer_t * buffer){
	for(i32 i=0;i<math_floor((buffer->length)/(float)4);++i){
		i32 r=buffer->buffer[i*4];
		buffer->buffer[i*4]=buffer->buffer[i*4+2];
		buffer->buffer[i*4+2]=r;
	}
	return buffer;
}

void export_arm_run_brush(string_t * path){
	if(!ends_with(path,".arm")){
		path=string_join(path,".arm");
	}
	ui_node_canvas_t_array_t * bnodes=any_array_create_from_raw((any[]){},0);
	slot_brush_t * b=context_raw->brush;
	ui_node_canvas_t * c=util_clone_canvas(b->canvas);
	asset_t_array_t * assets=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<c->nodes->length;++i){
		ui_node_t * n=c->nodes->buffer[i];
		export_arm_export_node(n,assets);
	}
	any_array_push(bnodes,c);
	string_t_array_t * texture_files=export_arm_assets_to_files(path,assets);
	bool is_cloud=ends_with(path,"_cloud_.arm");
	if(is_cloud){
		path=string_copy(string_replace_all(path,"_cloud_",""));
	}
	packed_asset_t_array_t * packed_assets=null;
	if(!context_raw->pack_assets_on_export){
		packed_assets=export_arm_get_packed_assets(path,texture_files);
	}
	buffer_t_array_t * bicons=null;
	if(!is_cloud){
		buffer_t * buf=lz4_encode(gpu_get_texture_pixels(b->image));
		bicons=any_array_create_from_raw((any[]){buf,},1);
	}
	project_format_t * raw=GC_ALLOC_INIT(project_format_t, {.version=manifest_version,.brush_nodes=bnodes,.brush_icons=bicons,.assets=texture_files,.packed_assets=packed_assets});
	if(context_raw->write_icon_on_export){
		iron_write_png(string_join(substring(path,0,string_length(path)-4),"_icon.png"),gpu_get_texture_pixels(b->image),b->image->width,b->image->height,0);
	}
	if(context_raw->pack_assets_on_export){
		export_arm_pack_assets(raw,assets);
	}
	buffer_t * buffer=util_encode_project(raw);
	iron_file_save_bytes(path,buffer,buffer->length+1);
}

string_t_array_t * export_arm_assets_to_files(string_t * project_path,asset_t_array_t * assets){
	string_t_array_t * texture_files=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<assets->length;++i){
		asset_t * a=assets->buffer[i];
		bool same_drive=char_at(project_path,0)==char_at(a->file,0);
		if(same_drive){
			any_array_push(texture_files,path_to_relative(project_path,a->file));
		}
		else {
			any_array_push(texture_files,a->file);
		}
	}
	return texture_files;
}

string_t_array_t * export_arm_meshes_to_files(string_t * project_path){
	string_t_array_t * mesh_files=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project_mesh_assets->length;++i){
		string_t * file=project_mesh_assets->buffer[i];
		bool same_drive=char_at(project_path,0)==char_at(file,0);
		if(same_drive){
			any_array_push(mesh_files,path_to_relative(project_path,file));
		}
		else {
			any_array_push(mesh_files,file);
		}
	}
	return mesh_files;
}

string_t_array_t * export_arm_fonts_to_files(string_t * project_path,slot_font_t_array_t * fonts){
	string_t_array_t * font_files=any_array_create_from_raw((any[]){},0);
	for(i32 i=1;i<fonts->length;++i){
		slot_font_t * f=fonts->buffer[i];
		bool same_drive=char_at(project_path,0)==char_at(f->file,0);
		if(same_drive){
			any_array_push(font_files,path_to_relative(project_path,f->file));
		}
		else {
			any_array_push(font_files,f->file);
		}
	}
	return font_files;
}

packed_asset_t_array_t * export_arm_get_packed_assets(string_t * project_path,string_t_array_t * texture_files){
	packed_asset_t_array_t * packed_assets=null;
	if(project_raw->packed_assets!=null){
		for(i32 i=0;i<project_raw->packed_assets->length;++i){
			packed_asset_t * pa=project_raw->packed_assets->buffer[i];
			bool same_drive=char_at(project_path,0)==char_at(pa->name,0);
			pa->name=same_drive?path_to_relative(project_path,pa->name):pa->name;
			for(i32 i=0;i<texture_files->length;++i){
				string_t * tf=texture_files->buffer[i];
				if(string_equals(pa->name,tf)){
					if(packed_assets==null){
						packed_assets=any_array_create_from_raw((any[]){},0);
					}
					any_array_push(packed_assets,pa);
					break;
				}
			}
		}
	}
	return packed_assets;
}

void export_arm_pack_assets(project_format_t * raw,asset_t_array_t * assets){
	if(raw->packed_assets==null){
		raw->packed_assets=any_array_create_from_raw((any[]){},0);
	}
	gpu_texture_t_array_t * temp_images=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<assets->length;++i){
		if(!project_packed_asset_exists(raw->packed_assets,assets->buffer[i]->file)){
			gpu_texture_t * image=project_get_image(assets->buffer[i]);
			gpu_texture_t * temp=gpu_create_render_target(image->width,image->height,tex_format_t_RGBA32);
			draw_begin(temp,false,0);
			draw_image(image,0,0);
			draw_end();
			any_array_push(temp_images,temp);
			packed_asset_t * pa=GC_ALLOC_INIT(packed_asset_t, {.name=assets->buffer[i]->file,.bytes=ends_with(assets->buffer[i]->file,".jpg")?iron_encode_jpg(gpu_get_texture_pixels(temp),temp->width,temp->height,0,80):iron_encode_png(gpu_get_texture_pixels(temp),temp->width,temp->height,0)});
			any_array_push(raw->packed_assets,pa);
		}
	}
	for(i32 i=0;i<temp_images->length;++i){
		gpu_texture_t * image=temp_images->buffer[i];
		iron_delete_texture(image);
	}
}

void export_arm_run_swatches(string_t * path){
	if(!ends_with(path,".arm")){
		path=string_join(path,".arm");
	}
	project_format_t * raw=GC_ALLOC_INIT(project_format_t, {.version=manifest_version,.swatches=project_raw->swatches});
	buffer_t * buffer=util_encode_project(raw);
	iron_file_save_bytes(path,buffer,buffer->length+1);
}

f32_array_t * export_arm_vec3f32(vec4_t v){
	f32_array_t * res=f32_array_create(3);
	res->buffer[0]=v.x;
	res->buffer[1]=v.y;
	res->buffer[2]=v.z;
	return res;
}

void export_mesh_run(string_t * path,mesh_object_t_array_t * paint_objects,bool apply_disp,bool merge_vertices){
	if(paint_objects==null){
		paint_objects=project_paint_objects;
	}
	if(context_raw->export_mesh_format==mesh_format_t_OBJ){
		merge_vertices?export_obj_run(path,paint_objects,apply_disp):export_obj_run_fast(path,paint_objects);
	}
	else {
		export_arm_run_mesh(path,paint_objects);
	}
}

void export_obj_write_string(u8_array_t * out,string_t * str){
	for(i32 i=0;i<string_length(str);++i){
		u8_array_push(out,char_code_at(str,i));
	}
}

void export_obj_run(string_t * path,mesh_object_t_array_t * paint_objects,bool apply_disp){
	u8_array_t * o=u8_array_create_from_raw((u8[]){},0);
	export_obj_write_string(o,"# armorpaint.org\n");
	i32 poff=0;
	i32 noff=0;
	i32 toff=0;
	for(i32 i=0;i<paint_objects->length;++i){
		mesh_object_t * p=paint_objects->buffer[i];
		mesh_data_t * mesh=p->data;
		f32 inv=1/(float)32767;
		f32 sc=p->data->scale_pos*inv;
		i16_array_t * posa=mesh->vertex_arrays->buffer[0]->values;
		i16_array_t * nora=mesh->vertex_arrays->buffer[1]->values;
		i16_array_t * texa=mesh->vertex_arrays->buffer[2]->values;
		i32 len=math_floor(posa->length/(float)4);
		i16_array_t * posa2=i16_array_create(len*3);
		i16_array_t * nora2=i16_array_create(len*3);
		i16_array_t * texa2=i16_array_create(len*2);
		i32_array_t * posmap=i32_array_create(len);
		i32_array_t * normap=i32_array_create(len);
		i32_array_t * texmap=i32_array_create(len);
		i32 pi=0;
		i32 ni=0;
		i32 ti=0;
		for(i32 i=0;i<len;++i){
			bool found=false;
			for(i32 j=0;j<pi;++j){
				if(posa2->buffer[j*3]==posa->buffer[i*4]&&posa2->buffer[j*3+1]==posa->buffer[i*4+1]&&posa2->buffer[j*3+2]==posa->buffer[i*4+2]){
					posmap->buffer[i]=j;
					found=true;
					break;
				}
			}
			if(!found){
				posmap->buffer[i]=pi;
				posa2->buffer[pi*3]=posa->buffer[i*4];
				posa2->buffer[pi*3+1]=posa->buffer[i*4+1];
				posa2->buffer[pi*3+2]=posa->buffer[i*4+2];
				pi++;
			}
			found=false;
			for(i32 j=0;j<ni;++j){
				if(nora2->buffer[j*3]==nora->buffer[i*2]&&nora2->buffer[j*3+1]==nora->buffer[i*2+1]&&nora2->buffer[j*3+2]==posa->buffer[i*4+3]){
					normap->buffer[i]=j;
					found=true;
					break;
				}
			}
			if(!found){
				normap->buffer[i]=ni;
				nora2->buffer[ni*3]=nora->buffer[i*2];
				nora2->buffer[ni*3+1]=nora->buffer[i*2+1];
				nora2->buffer[ni*3+2]=posa->buffer[i*4+3];
				ni++;
			}
			found=false;
			for(i32 j=0;j<ti;++j){
				if(texa2->buffer[j*2]==texa->buffer[i*2]&&texa2->buffer[j*2+1]==texa->buffer[i*2+1]){
					texmap->buffer[i]=j;
					found=true;
					break;
				}
			}
			if(!found){
				texmap->buffer[i]=ti;
				texa2->buffer[ti*2]=texa->buffer[i*2];
				texa2->buffer[ti*2+1]=texa->buffer[i*2+1];
				ti++;
			}
		}
		if(apply_disp){
		}
		export_obj_write_string(o,string_join(string_join("o ",p->base->name),"\n"));
		for(i32 i=0;i<pi;++i){
			export_obj_write_string(o,"v ");
			f32 f=posa2->buffer[i*3]*sc;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=posa2->buffer[i*3+2]*sc;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=-posa2->buffer[i*3+1]*sc;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o,"\n");
		}
		for(i32 i=0;i<ni;++i){
			export_obj_write_string(o,"vn ");
			f32 f=nora2->buffer[i*3]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=nora2->buffer[i*3+2]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=-nora2->buffer[i*3+1]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o,"\n");
		}
		for(i32 i=0;i<ti;++i){
			export_obj_write_string(o,"vt ");
			f32 f=texa2->buffer[i*2]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=1.0-texa2->buffer[i*2+1]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o,"\n");
		}
		u32_array_t * inda=mesh->index_arrays->buffer[0]->values;
		for(i32 i=0;i<math_floor(inda->length/(float)3);++i){
			i32 pi1=posmap->buffer[inda->buffer[i*3]]+1+poff;
			i32 pi2=posmap->buffer[inda->buffer[i*3+1]]+1+poff;
			i32 pi3=posmap->buffer[inda->buffer[i*3+2]]+1+poff;
			i32 ni1=normap->buffer[inda->buffer[i*3]]+1+noff;
			i32 ni2=normap->buffer[inda->buffer[i*3+1]]+1+noff;
			i32 ni3=normap->buffer[inda->buffer[i*3+2]]+1+noff;
			i32 ti1=texmap->buffer[inda->buffer[i*3]]+1+toff;
			i32 ti2=texmap->buffer[inda->buffer[i*3+1]]+1+toff;
			i32 ti3=texmap->buffer[inda->buffer[i*3+2]]+1+toff;
			export_obj_write_string(o,"f ");
			export_obj_write_string(o,string_join(i32_to_string(pi1),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ti1),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ni1),""));
			export_obj_write_string(o," ");
			export_obj_write_string(o,string_join(i32_to_string(pi2),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ti2),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ni2),""));
			export_obj_write_string(o," ");
			export_obj_write_string(o,string_join(i32_to_string(pi3),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ti3),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ni3),""));
			export_obj_write_string(o,"\n");
		}
		poff+=pi;
		noff+=ni;
		toff+=ti;
	}
	if(!ends_with(path,".obj")){
		path=string_join(path,".obj");
	}
	iron_file_save_bytes(path,o,0);
}

void export_obj_run_fast(string_t * path,mesh_object_t_array_t * paint_objects){
	u8_array_t * o=u8_array_create_from_raw((u8[]){},0);
	export_obj_write_string(o,"# armorpaint.org\n");
	i32 poff=0;
	i32 noff=0;
	i32 toff=0;
	for(i32 i=0;i<paint_objects->length;++i){
		mesh_object_t * p=paint_objects->buffer[i];
		mesh_data_t * mesh=p->data;
		f32 inv=1/(float)32767;
		f32 sc=p->data->scale_pos*inv;
		i16_array_t * posa=mesh->vertex_arrays->buffer[0]->values;
		i16_array_t * nora=mesh->vertex_arrays->buffer[1]->values;
		i16_array_t * texa=mesh->vertex_arrays->buffer[2]->values;
		i32 pi=posa->length/(float)4;
		i32 ni=pi;
		i32 ti=pi;
		export_obj_write_string(o,string_join(string_join("o ",p->base->name),"\n"));
		for(i32 i=0;i<pi;++i){
			export_obj_write_string(o,"v ");
			f32 f=posa->buffer[i*4]*sc;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=posa->buffer[i*4+2]*sc;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=-posa->buffer[i*4+1]*sc;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o,"\n");
		}
		for(i32 i=0;i<ni;++i){
			export_obj_write_string(o,"vn ");
			f32 f=nora->buffer[i*2]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=posa->buffer[i*4+3]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=-nora->buffer[i*2+1]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o,"\n");
		}
		for(i32 i=0;i<ti;++i){
			export_obj_write_string(o,"vt ");
			f32 f=texa->buffer[i*2]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o," ");
			f=1.0-texa->buffer[i*2+1]*inv;
			export_obj_write_string(o,string_join(f32_to_string(f),""));
			export_obj_write_string(o,"\n");
		}
		u32_array_t * inda=mesh->index_arrays->buffer[0]->values;
		for(i32 i=0;i<math_floor(inda->length/(float)3);++i){
			i32 pi1=inda->buffer[i*3]+1+poff;
			i32 pi2=inda->buffer[i*3+1]+1+poff;
			i32 pi3=inda->buffer[i*3+2]+1+poff;
			i32 ni1=inda->buffer[i*3]+1+noff;
			i32 ni2=inda->buffer[i*3+1]+1+noff;
			i32 ni3=inda->buffer[i*3+2]+1+noff;
			i32 ti1=inda->buffer[i*3]+1+toff;
			i32 ti2=inda->buffer[i*3+1]+1+toff;
			i32 ti3=inda->buffer[i*3+2]+1+toff;
			export_obj_write_string(o,"f ");
			export_obj_write_string(o,string_join(i32_to_string(pi1),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ti1),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ni1),""));
			export_obj_write_string(o," ");
			export_obj_write_string(o,string_join(i32_to_string(pi2),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ti2),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ni2),""));
			export_obj_write_string(o," ");
			export_obj_write_string(o,string_join(i32_to_string(pi3),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ti3),""));
			export_obj_write_string(o,"/");
			export_obj_write_string(o,string_join(i32_to_string(ni3),""));
			export_obj_write_string(o,"\n");
		}
		poff+=pi;
		noff+=ni;
		toff+=ti;
	}
	if(!ends_with(path,".obj")){
		path=string_join(path,".obj");
	}
	iron_file_save_bytes(path,o,0);
}

void export_texture_run(string_t * path,bool bake_material){
	if(bake_material){
		export_texture_run_bake_material(path);
	}
	else if(context_raw->layers_export==export_mode_t_PER_UDIM_TILE){
		string_t_array_t * udim_tiles=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			if(slot_layer_get_object_mask(l)>0){
				string_t * name=project_paint_objects->buffer[slot_layer_get_object_mask(l)-1]->base->name;
				if(string_equals(substring(name,string_length(name)-5,2),".1")){
					any_array_push(udim_tiles,substring(name,string_length(name)-5,string_length(name)));
				}
			}
		}
		if(udim_tiles->length>0){
			for(i32 i=0;i<udim_tiles->length;++i){
				string_t * udim_tile=udim_tiles->buffer[i];
				export_texture_run_layers(path,project_layers,udim_tile,false);
			}
		}
		else {
			export_texture_run_layers(path,project_layers,"",false);
		}
	}
	else if(context_raw->layers_export==export_mode_t_PER_OBJECT){
		string_t_array_t * object_names=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			if(slot_layer_get_object_mask(l)>0){
				string_t * name=project_paint_objects->buffer[slot_layer_get_object_mask(l)-1]->base->name;
				if(char_ptr_array_index_of(object_names,name)==-1){
					any_array_push(object_names,name);
				}
			}
		}
		if(object_names->length>0){
			for(i32 i=0;i<object_names->length;++i){
				string_t * name=object_names->buffer[i];
				export_texture_run_layers(path,project_layers,name,false);
			}
		}
		else {
			export_texture_run_layers(path,project_layers,"",false);
		}
	}
	else {
		bool atlas_export=false;
		if(project_atlas_objects!=null){
			for(i32 i=1;i<project_atlas_objects->length;++i){
				if(project_atlas_objects->buffer[i-1]!=project_atlas_objects->buffer[i]){
					atlas_export=true;
					break;
				}
			}
		}
		if(atlas_export){
			for(i32 atlas_index=0;atlas_index<project_atlas_objects->length;++atlas_index){
				slot_layer_t_array_t * layers=any_array_create_from_raw((any[]){},0);
				for(i32 object_index=0;object_index<project_atlas_objects->length;++object_index){
					if(project_atlas_objects->buffer[object_index]==atlas_index){
						for(i32 i=0;i<project_layers->length;++i){
							slot_layer_t * l=project_layers->buffer[i];
							if(slot_layer_get_object_mask(l)==0||slot_layer_get_object_mask(l)-1==object_index){
								any_array_push(layers,l);
							}
						}
					}
				}
				if(layers->length>0){
					export_texture_run_layers(path,layers,project_atlas_names->buffer[atlas_index],false);
				}
			}
		}
		else {
			slot_layer_t_array_t * layers;
			if(context_raw->layers_export==export_mode_t_SELECTED){
				if(slot_layer_is_group(context_raw->layer)){
					layers=slot_layer_get_children(context_raw->layer);
				}
				else {
					layers=any_array_create_from_raw((any[]){context_raw->layer,},1);
				}
			}
			else {
				layers=project_layers;
			}
			export_texture_run_layers(path,layers,"",false);
		}
	}
	console_info(tr("Textures exported",null));
	gc_unroot(ui_files_last_path);ui_files_last_path="";gc_root(ui_files_last_path);
}

void export_texture_run_bake_material(string_t * path){
	if(render_path_paint_live_layer==null){
		gc_unroot(render_path_paint_live_layer);render_path_paint_live_layer=slot_layer_create("_live",layer_slot_type_t_LAYER,null);gc_root(render_path_paint_live_layer);
	}
	workspace_tool_t _tool=context_raw->tool;
	context_raw->tool=workspace_tool_t_FILL;
	make_material_parse_paint_material(true);
	mesh_object_t * _paint_object=context_raw->paint_object;
	mesh_object_t * planeo=scene_get_child(".Plane")->ext;
	planeo->base->visible=true;
	context_raw->paint_object=planeo;
	context_raw->pdirty=1;
	u8_array_t * _visibles=u8_array_create_from_raw((u8[]){},0);
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		u8_array_push(_visibles,p->base->visible);
		p->base->visible=false;
	}
	render_path_paint_use_live_layer(true);
	render_path_paint_commands_paint(false);
	render_path_paint_use_live_layer(false);
	context_raw->tool=_tool;
	make_material_parse_paint_material(true);
	context_raw->pdirty=0;
	planeo->base->visible=false;
	context_raw->paint_object=_paint_object;
	for(i32 i=0;i<project_paint_objects->length;++i){
		project_paint_objects->buffer[i]->base->visible=_visibles->buffer[i];
	}
	slot_layer_t_array_t * layers=any_array_create_from_raw((any[]){render_path_paint_live_layer,},1);
	export_texture_run_layers(path,layers,"",true);
}

void export_texture_run_layers(string_t * path,slot_layer_t_array_t * layers,string_t * object_name,bool bake_material){
	i32 texture_size_x=config_get_texture_res_x();
	i32 texture_size_y=config_get_texture_res_y();
	string_t * f=ui_files_filename;
	if(string_equals(f,"")){
		f=string_copy(tr("untitled",null));
	}
	texture_ldr_format_t format_type=context_raw->format_type;
	i32 bits=base_bits_handle->position==texture_bits_t_BITS8?8:16;
	string_t * ext=bits==16?".exr":format_type==texture_ldr_format_t_PNG?".png":".jpg";
	if(ends_with(f,ext)){
		f=string_copy(substring(f,0,string_length(f)-4));
	}
	bool is_udim=context_raw->layers_export==export_mode_t_PER_UDIM_TILE;
	if(is_udim){
		ext=string_join(object_name,ext);
	}
	layers_make_temp_img();
	layers_make_export_img();
	render_target_t * rt=any_map_get(render_path_render_targets,"empty_white");
	gpu_texture_t * empty=rt->_image;
	bool export_selected=context_raw->layers_export==export_mode_t_SELECTED;
	if(export_selected&&slot_layer_get_object_mask(layers->buffer[0])>0){
		f=string_join(f,string_join("_",project_paint_objects->buffer[slot_layer_get_object_mask(layers->buffer[0])-1]->base->name));
	}
	if(!is_udim&&!export_selected&&!string_equals(object_name,"")){
		f=string_join(f,string_join("_",object_name));
	}
	_gpu_begin(layers_expa,null,null,clear_flag_t_COLOR,color_from_floats(0.0,0.0,0.0,0.0),0.0);
	gpu_end();
	_gpu_begin(layers_expb,null,null,clear_flag_t_COLOR,color_from_floats(0.5,0.5,1.0,0.0),0.0);
	gpu_end();
	_gpu_begin(layers_expc,null,null,clear_flag_t_COLOR,color_from_floats(1.0,0.0,0.0,0.0),0.0);
	gpu_end();
	for(i32 i=0;i<layers->length;++i){
		slot_layer_t * l1=layers->buffer[i];
		if(!export_selected&&!slot_layer_is_visible(l1)){
			continue;
		}
		if(!slot_layer_is_layer(l1)){
			continue;
		}
		if(!string_equals(object_name,"")&&slot_layer_get_object_mask(l1)>0){
			if(is_udim&&!ends_with(project_paint_objects->buffer[slot_layer_get_object_mask(l1)-1]->base->name,object_name)){
				continue;
			}
			bool per_object=context_raw->layers_export==export_mode_t_PER_OBJECT;
			if(per_object&&!string_equals(project_paint_objects->buffer[slot_layer_get_object_mask(l1)-1]->base->name,object_name)){
				continue;
			}
		}
		gpu_texture_t * mask=empty;
		slot_layer_t_array_t * l1masks=slot_layer_get_masks(l1,true);
		if(l1masks!=null&&!bake_material){
			if(l1masks->length>1){
				layers_make_temp_mask_img();
				draw_begin(pipes_temp_mask_image,true,0x00000000);
				draw_end();
				slot_layer_t * l1=GC_ALLOC_INIT(slot_layer_t, {.texpaint=pipes_temp_mask_image});
				for(i32 i=0;i<l1masks->length;++i){
					layers_merge_layer(l1,l1masks->buffer[i],false);
				}
				mask=pipes_temp_mask_image;
			}
			else {
				mask=l1masks->buffer[0]->texpaint;
			}
		}
		if(l1->paint_base){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(layers_expa,0,0);
			draw_set_pipeline(null);
			draw_end();
			_gpu_begin(layers_expa,null,null,clear_flag_t_NONE,0,0.0);
			gpu_set_pipeline(pipes_merge);
			gpu_set_texture(pipes_tex0,l1->texpaint);
			gpu_set_texture(pipes_tex1,empty);
			gpu_set_texture(pipes_texmask,mask);
			gpu_set_texture(pipes_texa,layers_temp_image);
			gpu_set_float(pipes_opac,slot_layer_get_opacity(l1));
			gpu_set_float(pipes_tex1w,empty->width);
			gpu_set_int(pipes_blending,layers->length>1?l1->blending:0);
			gpu_set_vertex_buffer(const_data_screen_aligned_vb);
			gpu_set_index_buffer(const_data_screen_aligned_ib);
			gpu_draw();
			gpu_end();
		}
		if(l1->paint_nor){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(layers_expb,0,0);
			draw_set_pipeline(null);
			draw_end();
			_gpu_begin(layers_expb,null,null,clear_flag_t_NONE,0,0.0);
			gpu_set_pipeline(pipes_merge);
			gpu_set_texture(pipes_tex0,l1->texpaint);
			gpu_set_texture(pipes_tex1,l1->texpaint_nor);
			gpu_set_texture(pipes_texmask,mask);
			gpu_set_texture(pipes_texa,layers_temp_image);
			gpu_set_float(pipes_opac,slot_layer_get_opacity(l1));
			gpu_set_float(pipes_tex1w,l1->texpaint_nor->width);
			gpu_set_int(pipes_blending,l1->paint_nor_blend?102:101);
			gpu_set_vertex_buffer(const_data_screen_aligned_vb);
			gpu_set_index_buffer(const_data_screen_aligned_ib);
			gpu_draw();
			gpu_end();
		}
		if(l1->paint_occ||l1->paint_rough||l1->paint_met||l1->paint_height){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(layers_expc,0,0);
			draw_set_pipeline(null);
			draw_end();
			if(l1->paint_occ&&l1->paint_rough&&l1->paint_met&&l1->paint_height){
				layers_commands_merge_pack(pipes_merge,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,l1->paint_height_blend?103:101);
			}
			else {
				if(l1->paint_occ)layers_commands_merge_pack(pipes_merge_r,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
				if(l1->paint_rough)layers_commands_merge_pack(pipes_merge_g,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
				if(l1->paint_met)layers_commands_merge_pack(pipes_merge_b,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
			}
		}
	}
	gpu_texture_t * texpaint=layers_expa;
	gpu_texture_t * texpaint_nor=layers_expb;
	gpu_texture_t * texpaint_pack=layers_expc;
	buffer_t * pixpaint=null;
	buffer_t * pixpaint_nor=null;
	buffer_t * pixpaint_pack=null;
	export_preset_t * preset=box_export_preset;
	buffer_t * pix=null;
	for(i32 i=0;i<preset->textures->length;++i){
		export_preset_texture_t * t=preset->textures->buffer[i];
		for(i32 i=0;i<t->channels->length;++i){
			string_t * c=t->channels->buffer[i];
			if((string_equals(c,"base_r")||string_equals(c,"base_g")||string_equals(c,"base_b")||string_equals(c,"opac"))&&pixpaint==null){
				pixpaint=gpu_get_texture_pixels(texpaint);
			}
			else if((string_equals(c,"nor_r")||string_equals(c,"nor_g")||string_equals(c,"nor_g_directx")||string_equals(c,"nor_b")||string_equals(c,"emis")||string_equals(c,"subs"))&&pixpaint_nor==null){
				pixpaint_nor=gpu_get_texture_pixels(texpaint_nor);
			}
			else if((string_equals(c,"occ")||string_equals(c,"rough")||string_equals(c,"metal")||string_equals(c,"height")||string_equals(c,"smooth"))&&pixpaint_pack==null){
				pixpaint_pack=gpu_get_texture_pixels(texpaint_pack);
			}
		}
	}
	for(i32 i=0;i<preset->textures->length;++i){
		export_preset_texture_t * t=preset->textures->buffer[i];
		string_t_array_t * c=t->channels;
		string_t * tex_name=!string_equals(t->name,"")?string_join("_",t->name):"";
		bool single_channel=c->buffer[0]==c->buffer[1]&&c->buffer[1]==c->buffer[2]&&string_equals(c->buffer[3],"1.0");
		if(string_equals(c->buffer[0],"base_r")&&string_equals(c->buffer[1],"base_g")&&string_equals(c->buffer[2],"base_b")&&string_equals(c->buffer[3],"1.0")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint,1,0);
		}
		else if(string_equals(c->buffer[0],"nor_r")&&string_equals(c->buffer[1],"nor_g")&&string_equals(c->buffer[2],"nor_b")&&string_equals(c->buffer[3],"1.0")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint_nor,1,0);
		}
		else if(string_equals(c->buffer[0],"occ")&&string_equals(c->buffer[1],"rough")&&string_equals(c->buffer[2],"metal")&&string_equals(c->buffer[3],"1.0")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint_pack,1,0);
		}
		else if(single_channel&&string_equals(c->buffer[0],"occ")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint_pack,2,0);
		}
		else if(single_channel&&string_equals(c->buffer[0],"rough")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint_pack,2,1);
		}
		else if(single_channel&&string_equals(c->buffer[0],"metal")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint_pack,2,2);
		}
		else if(single_channel&&string_equals(c->buffer[0],"height")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint_pack,2,3);
		}
		else if(single_channel&&string_equals(c->buffer[0],"opac")&&string_equals(t->color_space,"linear")){
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pixpaint,2,3);
		}
		else {
			if(pix==null){
				pix=buffer_create(texture_size_x*texture_size_y*4*math_floor(bits/(float)8));
			}
			for(i32 i=0;i<4;++i){
				string_t * c=t->channels->buffer[i];
				if(string_equals(c,"base_r")){
					export_texture_copy_channel(pixpaint,0,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"base_g")){
					export_texture_copy_channel(pixpaint,1,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"base_b")){
					export_texture_copy_channel(pixpaint,2,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"height")){
					export_texture_copy_channel(pixpaint_pack,3,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"metal")){
					export_texture_copy_channel(pixpaint_pack,2,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"nor_r")){
					export_texture_copy_channel(pixpaint_nor,0,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"nor_g")){
					export_texture_copy_channel(pixpaint_nor,1,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"nor_g_directx")){
					export_texture_copy_channel_inv(pixpaint_nor,1,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"nor_b")){
					export_texture_copy_channel(pixpaint_nor,2,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"occ")){
					export_texture_copy_channel(pixpaint_pack,0,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"opac")){
					export_texture_copy_channel(pixpaint,3,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"rough")){
					export_texture_copy_channel(pixpaint_pack,1,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"smooth")){
					export_texture_copy_channel_inv(pixpaint_pack,1,pix,i,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"emis")){
					export_texture_extract_channel(pixpaint_nor,3,pix,i,3,1,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"subs")){
					export_texture_extract_channel(pixpaint_nor,3,pix,i,3,2,string_equals(t->color_space,"linear"));
				}
				else if(string_equals(c,"0.0")){
					export_texture_set_channel(0,pix,i,true);
				}
				else if(string_equals(c,"1.0")){
					export_texture_set_channel(255,pix,i,true);
				}
			}
			export_texture_write_texture(string_join(string_join(string_join(string_join(path,path_sep),f),tex_name),ext),pix,3,0);
		}
	}
}

void export_texture_write_texture(string_t * file,buffer_t * pixels,i32 type,i32 off){
	i32 res_x=config_get_texture_res_x();
	i32 res_y=config_get_texture_res_y();
	i32 bits_handle=base_bits_handle->position;
	i32 bits=bits_handle==texture_bits_t_BITS8?8:bits_handle==texture_bits_t_BITS16?16:32;
	i32 format=0;
	if(type==1){
		format=2;
	}
	if(type==2&&off==0){
		format=3;
	}
	if(type==2&&off==1){
		format=4;
	}
	if(type==2&&off==2){
		format=5;
	}
	if(type==2&&off==3){
		format=6;
	}
	if(context_raw->layers_destination==export_destination_t_PACKED){
		gpu_texture_t * image=gpu_create_texture_from_bytes(pixels,res_x,res_y,tex_format_t_RGBA32);
		any_map_set(data_cached_images,file,image);
		string_t_array_t * ar=string_split(file,path_sep);
		string_t * name=ar->buffer[ar->length-1];
		asset_t * asset=GC_ALLOC_INIT(asset_t, {.name=name,.file=file,.id=project_asset_id++});
		any_array_push(project_assets,asset);
		if(project_raw->assets==null){
			project_raw->assets=any_array_create_from_raw((any[]){},0);
		}
		any_array_push(project_raw->assets,asset->file);
		any_array_push(project_asset_names,asset->name);
		any_imap_set(project_asset_map,asset->id,image);
		asset_t_array_t * assets=any_array_create_from_raw((any[]){asset,},1);
		export_arm_pack_assets(project_raw,assets);
		return ;
	}
	if(bits==8&&context_raw->format_type==texture_ldr_format_t_PNG){
		iron_write_png(file,pixels,res_x,res_y,format);
	}
	else if(bits==8&&context_raw->format_type==texture_ldr_format_t_JPG){
		iron_write_jpg(file,pixels,res_x,res_y,format,math_floor(context_raw->format_quality));
	}
	else {
		buffer_t * b=parser_exr_run(res_x,res_y,pixels,bits,type,off);
		iron_file_save_bytes(file,b,b->length);
	}
}

void export_texture_copy_channel(buffer_t * from,i32 from_channel,buffer_t * to,i32 to_channel,bool linear){
	for(i32 i=0;i<math_floor((to->length)/(float)4);++i){
		buffer_set_u8(to,i*4+to_channel,buffer_get_u8(from,i*4+from_channel));
	}
	if(!linear){
		export_texture_to_srgb(to,to_channel);
	}
}

void export_texture_copy_channel_inv(buffer_t * from,i32 from_channel,buffer_t * to,i32 to_channel,bool linear){
	for(i32 i=0;i<math_floor((to->length)/(float)4);++i){
		buffer_set_u8(to,i*4+to_channel,255-buffer_get_u8(from,i*4+from_channel));
	}
	if(!linear){
		export_texture_to_srgb(to,to_channel);
	}
}

void export_texture_extract_channel(buffer_t * from,i32 from_channel,buffer_t * to,i32 to_channel,i32 step,i32 mask,bool linear){
	for(i32 i=0;i<math_floor((to->length)/(float)4);++i){
		buffer_set_u8(to,i*4+to_channel,buffer_get_u8(from,i*4+from_channel)%step==mask?255:0);
	}
	if(!linear){
		export_texture_to_srgb(to,to_channel);
	}
}

void export_texture_set_channel(i32 value,buffer_t * to,i32 to_channel,bool linear){
	for(i32 i=0;i<math_floor((to->length)/(float)4);++i){
		buffer_set_u8(to,i*4+to_channel,value);
	}
	if(!linear){
		export_texture_to_srgb(to,to_channel);
	}
}

void export_texture_to_srgb(buffer_t * to,i32 to_channel){
	for(i32 i=0;i<math_floor((to->length)/(float)4);++i){
		buffer_set_u8(to,i*4+to_channel,math_floor(math_pow(buffer_get_u8(to,i*4+to_channel)/(float)255,export_texture_gamma)*255));
	}
}

string_t_array_t * file_read_directory(string_t * path){
	if(starts_with(path,"cloud")){
		string_t_array_t * files=file_cloud!=null?any_map_get(file_cloud,string_replace_all(path,"\\","/")):null;
		if(files!=null){
			return files;
		}
		else {
			string_t_array_t * empty=any_array_create_from_raw((any[]){},0);
			return empty;
		}
	}
	string_t_array_t * files=string_split(iron_read_directory(path),"\n");
	array_sort(files,null);
	i32 num=files->length;
	for(i32 i=0;i<num;++i){
		string_t * f=files->buffer[i];
		if(string_index_of(f,".")>-1){
			array_splice(files,i,1);
			any_array_push(files,f);
			i--;
			num--;
		}
	}
	return files;
}

void file_create_directory(string_t * path){
	iron_sys_command(string_join(string_join(string_join(file_cmd_mkdir," \""),path),"\""));
}

void file_copy(string_t * src_path,string_t * dst_path){
	iron_sys_command(string_join(string_join(string_join(string_join(string_join(file_cmd_copy," \""),src_path),"\" \""),dst_path),"\""));
}

void file_start(string_t * path){
	iron_sys_command(string_join(string_join("start \"\" \"",path),"\""));
}

void file_load_url(string_t * url){
	iron_load_url(url);
}

void file_delete(string_t * path){
	iron_delete_file(path);
}

bool file_exists(string_t * path){
	return iron_file_exists(path);
}

void file_download(string_t * url,string_t * dst_path,void(*done)(string_t *),i32 size){
	file_download_data_t * fdd=GC_ALLOC_INIT(file_download_data_t, {.dst_path=dst_path,.done=done});
	any_map_set(_file_download_map,url,fdd);
	_iron_http_request(url,size,&file_download_32479	);
}

void file_download_32479(string_t * url,buffer_t * ab){
file_download_data_t * fdd=any_map_get(_file_download_map,url);
	if(ab!=null){
		iron_file_save_bytes(fdd->dst_path,ab,0);
	}
	fdd->done(url);
}

void file_download_bytes(string_t * url,void(*done)(string_t *,buffer_t *)){
	string_t * save;
	if(path_is_protected()){
		save=string_copy(iron_internal_save_path());
	}
	else {
		save=string_join(path_data(),path_sep);
	}
	save=string_join(save,"download.bin");
	file_download_bytes_data_t * fdbd=GC_ALLOC_INIT(file_download_bytes_data_t, {.url=url,.save=save,.done=done});
	any_map_set(_file_download_bytes_map,url,fdbd);
	file_download(url,save,&file_download_bytes_32618	,0);
}

void file_download_bytes_32618(string_t * url){
file_download_bytes_data_t * fdbd=any_map_get(_file_download_bytes_map,url);
	buffer_t * buffer=iron_load_blob(fdbd->save);
	fdbd->done(fdbd->url,buffer);
}

void file_cache_cloud(string_t * path,void(*done)(string_t *)){
	string_t * path2=path;
	string_t * dest;
	if(path_is_protected()){
		dest=string_copy(iron_internal_save_path());
	}
	else {
		dest=string_join(iron_get_files_location(),path_sep);
	}
	dest=string_join(dest,path2);
	if(file_exists(dest)){
		string_t * p;
		if(path_is_protected()){
			p=string_copy(iron_internal_save_path());
		}
		else {
			p=string_join(path_working_dir(),path_sep);
		}
		p=string_join(p,path);
		done(p);
		return ;
	}
	string_t * file_dir=substring(dest,0,string_last_index_of(dest,path_sep));
	if(string_equals(file_read_directory(file_dir)->buffer[0],"")){
		file_create_directory(file_dir);
	}
	path=string_copy(string_replace_all(path,"\\","/"));
	string_t * url=string_join(string_join(config_raw->server,"/"),path);
	file_cache_cloud_data_t * fccd=GC_ALLOC_INIT(file_cache_cloud_data_t, {.dest=dest,.path=path,.done=done});
	any_map_set(_file_cache_cloud_map,url,fccd);
	file_download(url,dest,&file_cache_cloud_32861	,i32_map_get(file_cloud_sizes,path));
}

void file_cache_cloud_32861(string_t * url){
file_cache_cloud_data_t * fccd=any_map_get(_file_cache_cloud_map,url);
	if(!file_exists(fccd->dest)){
		console_error(strings_check_internet_connection());
		fccd->done(null);
		return ;
	}
	string_t * p;
	if(path_is_protected()){
		p=string_copy(iron_internal_save_path());
	}
	else {
		p=string_join(path_working_dir(),path_sep);
	}
	p=string_join(p,fccd->path);
	fccd->done(p);
}

void file_init_cloud_bytes(void(*done)(void),string_t * append){
	gc_unroot(_file_init_cloud_bytes_done);_file_init_cloud_bytes_done=done;gc_root(_file_init_cloud_bytes_done);
	file_download_bytes(string_join(string_join(config_raw->server,"/?list-type=2"),append),&file_init_cloud_bytes_32983	);
}

void file_init_cloud_bytes_32983(string_t * url,buffer_t * buffer){
if(buffer==null){
		string_t_array_t * empty=any_array_create_from_raw((any[]){},0);
		any_map_set(file_cloud,"cloud",empty);
		console_error(strings_check_internet_connection());
		return ;
	}
	string_t_array_t * files=any_array_create_from_raw((any[]){},0);
	i32_array_t * sizes=i32_array_create_from_raw((i32[]){},0);
	string_t * str=sys_buffer_to_string(buffer);
	i32 pos_start=0;
	i32 pos_end=0;
	while(true){
		pos_start=string_index_of_pos(str,"<Key>",pos_start);
		if(pos_start==-1){
			break;
		}
		pos_start+=5;
		pos_end=string_index_of_pos(str,"</Key>",pos_start);
		any_array_push(files,substring(str,pos_start,pos_end));
		pos_start=string_index_of_pos(str,"<Size>",pos_end);
		pos_start+=6;
		pos_end=string_index_of_pos(str,"</Size>",pos_start);
		i32_array_push(sizes,parse_int(substring(str,pos_start,pos_end)));
	}
	for(i32 i=0;i<files->length;++i){
		string_t * file=files->buffer[i];
		if(path_is_folder(file)){
			string_t_array_t * empty=any_array_create_from_raw((any[]){},0);
			any_map_set(file_cloud,substring(file,0,string_length(file)-1),empty);
		}
	}
	for(i32 i=0;i<files->length;++i){
		string_t * file=files->buffer[i];
		bool nested=string_index_of(file,"/")!=string_last_index_of(file,"/");
		if(nested){
			i32 delim=path_is_folder(file)?string_last_index_of(substring(file,0,string_length(file)-1),"/"):string_last_index_of(file,"/");
			string_t * parent=substring(file,0,delim);
			string_t * child=path_is_folder(file)?substring(file,delim+1,string_length(file)-1):substring(file,delim+1,string_length(file));
			any_array_push(any_map_get(file_cloud,parent),child);
			if(!path_is_folder(file)){
				i32_map_set(file_cloud_sizes,file,sizes->buffer[i]);
			}
		}
	}
	bool is_truncated=string_index_of(str,"<IsTruncated>true")>-1;
	if(is_truncated){
		i32 pos_start=string_index_of(str,"<NextContinuationToken>");
		pos_start+=23;
		i32 pos_end=string_index_of_pos(str,"</NextContinuationToken>",pos_start);
		file_init_cloud_bytes(_file_init_cloud_bytes_done,string_join("&start-after=",substring(str,pos_start,pos_end)));
	}
	else {
		_file_init_cloud_bytes_done();
	}
}

void file_init_cloud(void(*done)(void)){
	gc_unroot(file_cloud);file_cloud=any_map_create();gc_root(file_cloud);
	gc_unroot(file_cloud_sizes);file_cloud_sizes=i32_map_create();gc_root(file_cloud_sizes);
	file_init_cloud_bytes(done,"");
}

raw_mesh_t * geom_make_plane(f32 size_x,f32 size_y,i32 verts_x,i32 verts_y,f32 uv_scale){
	raw_mesh_t * mesh=GC_ALLOC_INIT(raw_mesh_t, {0});
	mesh->scale_pos=1.0;
	mesh->scale_tex=uv_scale;
	mesh->name="";
	mesh->has_next=false;
	f32 half_x=size_x/(float)2;
	f32 half_y=size_y/(float)2;
	mesh->scale_pos=math_max(size_x,size_y);
	f32 inv=(1/(float)mesh->scale_pos)*32767;
	mesh->posa=i16_array_create(verts_x*verts_y*4);
	mesh->nora=i16_array_create(verts_x*verts_y*2);
	mesh->texa=i16_array_create(verts_x*verts_y*2);
	mesh->inda=u32_array_create((verts_x-1)*(verts_y-1)*6);
	f32 step_x=size_x/(float)(verts_x-1);
	f32 step_y=size_y/(float)(verts_y-1);
	for(i32 i=0;i<verts_x*verts_y;++i){
		f32 x=(i%verts_x)*step_x-half_x;
		f32 y=math_floor(i/(float)verts_x)*step_y-half_y;
		mesh->posa->buffer[i*4]=math_floor(x*inv);
		mesh->posa->buffer[i*4+1]=math_floor(y*inv);
		mesh->posa->buffer[i*4+2]=0;
		mesh->nora->buffer[i*2]=0;
		mesh->nora->buffer[i*2+1]=0;
		mesh->posa->buffer[i*4+3]=32767;
		x=(i%verts_x)/(float)(verts_x-1);
		y=1.0-math_floor(i/(float)verts_x)/(float)(verts_y-1);
		mesh->texa->buffer[i*2]=math_floor(x*32767);
		mesh->texa->buffer[i*2+1]=math_floor(y*32767);
	}
	for(i32 i=0;i<(verts_x-1)*(verts_y-1);++i){
		f32 x=i%(verts_x-1);
		f32 y=math_floor(i/(float)(verts_y-1));
		mesh->inda->buffer[i*6]=y*verts_x+x;
		mesh->inda->buffer[i*6+1]=y*verts_x+x+1;
		mesh->inda->buffer[i*6+2]=(y+1)*verts_x+x;
		mesh->inda->buffer[i*6+3]=y*verts_x+x+1;
		mesh->inda->buffer[i*6+4]=(y+1)*verts_x+x+1;
		mesh->inda->buffer[i*6+5]=(y+1)*verts_x+x;
	}
	return mesh;
}

raw_mesh_t * geom_make_uv_sphere(f32 radius,i32 width_segments,i32 height_segments,bool stretch_uv,f32 uv_scale){
	raw_mesh_t * mesh=GC_ALLOC_INIT(raw_mesh_t, {0});
	mesh->scale_pos=1.0;
	mesh->scale_tex=1.0;
	mesh->name="";
	mesh->has_next=false;
	mesh->scale_pos=radius;
	mesh->scale_tex=uv_scale;
	f32 inv=(1/(float)mesh->scale_pos)*32767;
	f32 pi2=math_pi()*2;
	i32 width_verts=width_segments+1;
	i32 height_verts=height_segments+1;
	mesh->posa=i16_array_create(width_verts*height_verts*4);
	mesh->nora=i16_array_create(width_verts*height_verts*2);
	mesh->texa=i16_array_create(width_verts*height_verts*2);
	mesh->inda=u32_array_create(width_segments*height_segments*6-width_segments*6);
	vec4_t nor=vec4_create(0.0,0.0,0.0,1.0);
	i32 pos=0;
	for(i32 y=0;y<height_verts;++y){
		f32 v=y/(float)height_segments;
		f32 v_flip=1.0-v;
		if(!stretch_uv){
			v_flip/=2;
		}
		f32 u_off=y==0?0.5/(float)width_segments:y==height_segments?-0.5/(float)width_segments:0.0;
		for(i32 x=0;x<width_verts;++x){
			f32 u=x/(float)width_segments;
			f32 u_pi2=u*pi2;
			f32 v_pi=v*math_pi();
			f32 v_pi_sin=math_sin(v_pi);
			f32 vx=-radius*math_cos(u_pi2)*v_pi_sin;
			f32 vy=radius*math_sin(u_pi2)*v_pi_sin;
			f32 vz=-radius*math_cos(v_pi);
			i32 i4=pos*4;
			i32 i2=pos*2;
			mesh->posa->buffer[i4]=math_floor(vx*inv);
			mesh->posa->buffer[i4+1]=math_floor(vy*inv);
			mesh->posa->buffer[i4+2]=math_floor(vz*inv);
			nor=vec4_create(vx,vy,vz,1.0);
			nor=vec4_norm(nor);
			mesh->posa->buffer[i4+3]=math_floor(nor.z*32767);
			mesh->nora->buffer[i2]=math_floor(nor.x*32767);
			mesh->nora->buffer[i2+1]=math_floor(nor.y*32767);
			i32 tx=(math_floor((u+u_off)*32767)-1);
			i32 ty=(math_floor(v_flip*32767)-1);
			mesh->texa->buffer[i2]=tx%32767;
			mesh->texa->buffer[i2+1]=ty%32767;
			pos++;
		}
	}
	pos=0;
	i32 height_segments1=height_segments-1;
	for(i32 y=0;y<height_segments;++y){
		for(i32 x=0;x<width_segments;++x){
			i32 x1=x+1;
			i32 y1=y+1;
			f32 a=y*width_verts+x1;
			f32 b=y*width_verts+x;
			f32 c=y1*width_verts+x;
			f32 d=y1*width_verts+x1;
			if(y>0){
				mesh->inda->buffer[pos++]=a;
				mesh->inda->buffer[pos++]=b;
				mesh->inda->buffer[pos++]=d;
			}
			if(y<height_segments1){
				mesh->inda->buffer[pos++]=b;
				mesh->inda->buffer[pos++]=c;
				mesh->inda->buffer[pos++]=d;
			}
		}
	}
	return mesh;
}

void gizmo_update(){
	bool is_object=context_raw->tool==workspace_tool_t_GIZMO;
	bool is_decal=base_is_decal_layer();
	object_t * gizmo=context_raw->gizmo;
	bool hide=operator_shortcut(any_map_get(config_keymap,"stencil_hide"),shortcut_type_t_DOWN);
	gizmo->visible=(is_object||is_decal)&&!hide;
	if(!gizmo->visible){
		return ;
	}
	object_t * paint_object=context_raw->paint_object->base;
	if(is_object){
		gizmo->transform->loc=vec4_clone(paint_object->transform->loc);
	}
	else if(is_decal){
		gizmo->transform->loc=vec4_create(context_raw->layer->decal_mat.m30,context_raw->layer->decal_mat.m31,context_raw->layer->decal_mat.m32,1.0);
	}
	camera_object_t * cam=scene_camera;
	f32 fov=cam->data->fov;
	f32 dist=vec4_dist(cam->base->transform->loc,gizmo->transform->loc)/(float)8*fov;
	gizmo->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_translate_x->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_translate_y->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_translate_z->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_scale_x->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_scale_y->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_scale_z->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_rotate_x->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_rotate_y->transform->scale=vec4_create(dist,dist,dist,1.0);
	context_raw->gizmo_rotate_z->transform->scale=vec4_create(dist,dist,dist,1.0);
	transform_build_matrix(gizmo->transform);
	if(is_object){
		if(context_raw->translate_x||context_raw->translate_y||context_raw->translate_z||context_raw->scale_x||context_raw->scale_y||context_raw->scale_z||context_raw->rotate_x||context_raw->rotate_y||context_raw->rotate_z){
			if(context_raw->translate_x){
				paint_object->transform->loc.x=context_raw->gizmo_drag;
			}
			else if(context_raw->translate_y){
				paint_object->transform->loc.y=context_raw->gizmo_drag;
			}
			else if(context_raw->translate_z){
				paint_object->transform->loc.z=context_raw->gizmo_drag;
			}
			else if(context_raw->scale_x){
				paint_object->transform->scale.x+=context_raw->gizmo_drag-context_raw->gizmo_drag_last;
			}
			else if(context_raw->scale_y){
				paint_object->transform->scale.y+=context_raw->gizmo_drag-context_raw->gizmo_drag_last;
			}
			else if(context_raw->scale_z){
				paint_object->transform->scale.z+=context_raw->gizmo_drag-context_raw->gizmo_drag_last;
			}
			else if(context_raw->rotate_x){
				gizmo_q0=quat_from_axis_angle(vec4_x_axis(),context_raw->gizmo_drag-context_raw->gizmo_drag_last);
				paint_object->transform->rot=quat_mult(paint_object->transform->rot,gizmo_q0);
			}
			else if(context_raw->rotate_y){
				gizmo_q0=quat_from_axis_angle(vec4_y_axis(),context_raw->gizmo_drag-context_raw->gizmo_drag_last);
				paint_object->transform->rot=quat_mult(paint_object->transform->rot,gizmo_q0);
			}
			else if(context_raw->rotate_z){
				gizmo_q0=quat_from_axis_angle(vec4_z_axis(),context_raw->gizmo_drag-context_raw->gizmo_drag_last);
				paint_object->transform->rot=quat_mult(paint_object->transform->rot,gizmo_q0);
			}
			context_raw->gizmo_drag_last=context_raw->gizmo_drag;
			transform_build_matrix(paint_object->transform);
			physics_body_t * pb=any_imap_get(physics_body_object_map,paint_object->uid);
			if(pb!=null){
				physics_body_sync_transform(pb);
			}
		}
	}
	else if(is_decal){
		if(context_raw->translate_x||context_raw->translate_y||context_raw->translate_z||context_raw->scale_x||context_raw->scale_y||context_raw->scale_z||context_raw->rotate_x||context_raw->rotate_y||context_raw->rotate_z){
			if(context_raw->translate_x){
				context_raw->layer->decal_mat.m30=context_raw->gizmo_drag;
			}
			else if(context_raw->translate_y){
				context_raw->layer->decal_mat.m31=context_raw->gizmo_drag;
			}
			else if(context_raw->translate_z){
				context_raw->layer->decal_mat.m32=context_raw->gizmo_drag;
			}
			else if(context_raw->scale_x){
				mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
				gizmo_v=dec->loc;
				gizmo_q=dec->rot;
				gizmo_v0=dec->scl;
				gizmo_v0.x+=context_raw->gizmo_drag-context_raw->gizmo_drag_last;
				context_raw->layer->decal_mat=mat4_compose(gizmo_v,gizmo_q,gizmo_v0);
			}
			else if(context_raw->scale_y){
				mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
				gizmo_v=dec->loc;
				gizmo_q=dec->rot;
				gizmo_v0=dec->scl;
				gizmo_v0.y+=context_raw->gizmo_drag-context_raw->gizmo_drag_last;
				context_raw->layer->decal_mat=mat4_compose(gizmo_v,gizmo_q,gizmo_v0);
			}
			else if(context_raw->scale_z){
				mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
				gizmo_v=dec->loc;
				gizmo_q=dec->rot;
				gizmo_v0=dec->scl;
				gizmo_v0.z+=context_raw->gizmo_drag-context_raw->gizmo_drag_last;
				context_raw->layer->decal_mat=mat4_compose(gizmo_v,gizmo_q,gizmo_v0);
			}
			else if(context_raw->rotate_x){
				mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
				gizmo_v=dec->loc;
				gizmo_q=dec->rot;
				gizmo_v0=dec->scl;
				gizmo_q0=quat_from_axis_angle(vec4_x_axis(),-context_raw->gizmo_drag+context_raw->gizmo_drag_last);
				gizmo_q=quat_mult(gizmo_q0,gizmo_q);
				context_raw->layer->decal_mat=mat4_compose(gizmo_v,gizmo_q,gizmo_v0);
			}
			else if(context_raw->rotate_y){
				mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
				gizmo_v=dec->loc;
				gizmo_q=dec->rot;
				gizmo_v0=dec->scl;
				gizmo_q0=quat_from_axis_angle(vec4_y_axis(),-context_raw->gizmo_drag+context_raw->gizmo_drag_last);
				gizmo_q=quat_mult(gizmo_q0,gizmo_q);
				context_raw->layer->decal_mat=mat4_compose(gizmo_v,gizmo_q,gizmo_v0);
			}
			else if(context_raw->rotate_z){
				mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
				gizmo_v=dec->loc;
				gizmo_q=dec->rot;
				gizmo_v0=dec->scl;
				gizmo_q0=quat_from_axis_angle(vec4_z_axis(),context_raw->gizmo_drag-context_raw->gizmo_drag_last);
				gizmo_q=quat_mult(gizmo_q0,gizmo_q);
				context_raw->layer->decal_mat=mat4_compose(gizmo_v,gizmo_q,gizmo_v0);
			}
			context_raw->gizmo_drag_last=context_raw->gizmo_drag;
			if(context_raw->material!=context_raw->layer->fill_layer){
				context_set_material(context_raw->layer->fill_layer);
			}
			layers_update_fill_layer(context_raw->gizmo_started);
		}
	}
	context_raw->gizmo_started=false;
	if(mouse_started("left")&&!string_equals(paint_object->name,"Scene")){
		transform_t_array_t * trs=any_array_create_from_raw((any[]){context_raw->gizmo_translate_x->transform,context_raw->gizmo_translate_y->transform,context_raw->gizmo_translate_z->transform,context_raw->gizmo_scale_x->transform,context_raw->gizmo_scale_y->transform,context_raw->gizmo_scale_z->transform,},6);
		transform_t * hit=raycast_closest_box_intersect(trs,mouse_view_x(),mouse_view_y(),scene_camera);
		if(hit!=null){
			if(hit->object==context_raw->gizmo_translate_x){
				context_raw->translate_x=true;
			}
			else if(hit->object==context_raw->gizmo_translate_y){
				context_raw->translate_y=true;
			}
			else if(hit->object==context_raw->gizmo_translate_z){
				context_raw->translate_z=true;
			}
			else if(hit->object==context_raw->gizmo_scale_x){
				context_raw->scale_x=true;
			}
			else if(hit->object==context_raw->gizmo_scale_y){
				context_raw->scale_y=true;
			}
			else if(hit->object==context_raw->gizmo_scale_z){
				context_raw->scale_z=true;
			}
			if(context_raw->translate_x||context_raw->translate_y||context_raw->translate_z||context_raw->scale_x||context_raw->scale_y||context_raw->scale_z){
				context_raw->gizmo_offset=0.0;
				context_raw->gizmo_started=true;
			}
		}
		else {
			transform_t_array_t * trs=any_array_create_from_raw((any[]){context_raw->gizmo_rotate_x->transform,context_raw->gizmo_rotate_y->transform,context_raw->gizmo_rotate_z->transform,},3);
			transform_t * hit=raycast_closest_box_intersect(trs,mouse_view_x(),mouse_view_y(),scene_camera);
			if(hit!=null){
				if(hit->object==context_raw->gizmo_rotate_x){
					context_raw->rotate_x=true;
				}
				else if(hit->object==context_raw->gizmo_rotate_y){
					context_raw->rotate_y=true;
				}
				else if(hit->object==context_raw->gizmo_rotate_z){
					context_raw->rotate_z=true;
				}
				if(context_raw->rotate_x||context_raw->rotate_y||context_raw->rotate_z){
					context_raw->gizmo_offset=0.0;
					context_raw->gizmo_started=true;
				}
			}
		}
	}
	else if(mouse_released("left")){
		context_raw->translate_x=context_raw->translate_y=context_raw->translate_z=false;
		context_raw->scale_x=context_raw->scale_y=context_raw->scale_z=false;
		context_raw->rotate_x=context_raw->rotate_y=context_raw->rotate_z=false;
	}
	if(context_raw->translate_x||context_raw->translate_y||context_raw->translate_z||context_raw->scale_x||context_raw->scale_y||context_raw->scale_z||context_raw->rotate_x||context_raw->rotate_y||context_raw->rotate_z){
		context_raw->rdirty=2;
		if(is_object){
			transform_t * t=paint_object->transform;
			gizmo_v=vec4_create(transform_world_x(t),transform_world_y(t),transform_world_z(t),1.0);
		}
		else if(is_decal){
			gizmo_v=vec4_create(context_raw->layer->decal_mat.m30,context_raw->layer->decal_mat.m31,context_raw->layer->decal_mat.m32,1.0);
		}
		if(context_raw->translate_x||context_raw->scale_x){
			vec4_t hit=raycast_plane_intersect(vec4_y_axis(),gizmo_v,mouse_view_x(),mouse_view_y(),scene_camera);
			if(!vec4_isnan(hit)){
				if(context_raw->gizmo_started){
					context_raw->gizmo_offset=hit.x-gizmo_v.x;
				}
				context_raw->gizmo_drag=hit.x-context_raw->gizmo_offset;
			}
		}
		else if(context_raw->translate_y||context_raw->scale_y){
			vec4_t hit=raycast_plane_intersect(vec4_x_axis(),gizmo_v,mouse_view_x(),mouse_view_y(),scene_camera);
			if(!vec4_isnan(hit)){
				if(context_raw->gizmo_started){
					context_raw->gizmo_offset=hit.y-gizmo_v.y;
				}
				context_raw->gizmo_drag=hit.y-context_raw->gizmo_offset;
			}
		}
		else if(context_raw->translate_z||context_raw->scale_z){
			vec4_t hit=raycast_plane_intersect(vec4_x_axis(),gizmo_v,mouse_view_x(),mouse_view_y(),scene_camera);
			if(!vec4_isnan(hit)){
				if(context_raw->gizmo_started){
					context_raw->gizmo_offset=hit.z-gizmo_v.z;
				}
				context_raw->gizmo_drag=hit.z-context_raw->gizmo_offset;
			}
		}
		else if(context_raw->rotate_x){
			vec4_t hit=raycast_plane_intersect(vec4_x_axis(),gizmo_v,mouse_view_x(),mouse_view_y(),scene_camera);
			if(!vec4_isnan(hit)){
				if(context_raw->gizmo_started){
					mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
					gizmo_v=dec->loc;
					gizmo_q=dec->rot;
					gizmo_v0=dec->scl;
					context_raw->gizmo_offset=math_atan2(hit.y-gizmo_v.y,hit.z-gizmo_v.z);
				}
				context_raw->gizmo_drag=math_atan2(hit.y-gizmo_v.y,hit.z-gizmo_v.z)-context_raw->gizmo_offset;
			}
		}
		else if(context_raw->rotate_y){
			vec4_t hit=raycast_plane_intersect(vec4_y_axis(),gizmo_v,mouse_view_x(),mouse_view_y(),scene_camera);
			if(!vec4_isnan(hit)){
				if(context_raw->gizmo_started){
					mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
					gizmo_v=dec->loc;
					gizmo_q=dec->rot;
					gizmo_v0=dec->scl;
					context_raw->gizmo_offset=math_atan2(hit.z-gizmo_v.z,hit.x-gizmo_v.x);
				}
				context_raw->gizmo_drag=math_atan2(hit.z-gizmo_v.z,hit.x-gizmo_v.x)-context_raw->gizmo_offset;
			}
		}
		else if(context_raw->rotate_z){
			vec4_t hit=raycast_plane_intersect(vec4_z_axis(),gizmo_v,mouse_view_x(),mouse_view_y(),scene_camera);
			if(!vec4_isnan(hit)){
				if(context_raw->gizmo_started){
					mat4_decomposed_t * dec=mat4_decompose(context_raw->layer->decal_mat);
					gizmo_v=dec->loc;
					gizmo_q=dec->rot;
					gizmo_v0=dec->scl;
					context_raw->gizmo_offset=math_atan2(hit.y-gizmo_v.y,hit.x-gizmo_v.x);
				}
				context_raw->gizmo_drag=math_atan2(hit.y-gizmo_v.y,hit.x-gizmo_v.x)-context_raw->gizmo_offset;
			}
		}
		if(context_raw->gizmo_started){
			context_raw->gizmo_drag_last=context_raw->gizmo_drag;
		}
	}
	_input_occupied=(context_raw->translate_x||context_raw->translate_y||context_raw->translate_z||context_raw->scale_x||context_raw->scale_y||context_raw->scale_z||context_raw->rotate_x||context_raw->rotate_y||context_raw->rotate_z)&&mouse_view_x()<base_w();
}

void history_undo(){
	if(history_undos>0){
		i32 active=history_steps->length-1-history_redos;
		step_t * step=history_steps->buffer[active];
		if(string_equals(step->name,tr("Edit Nodes",null))){
			history_swap_canvas(step);
		}
		else if(string_equals(step->name,tr("New Layer",null))||string_equals(step->name,tr("New Black Mask",null))||string_equals(step->name,tr("New White Mask",null))||string_equals(step->name,tr("New Fill Mask",null))){
			context_raw->layer=project_layers->buffer[step->layer];
			slot_layer_delete(context_raw->layer);
			context_raw->layer=project_layers->buffer[step->layer>0?step->layer-1:0];
		}
		else if(string_equals(step->name,tr("New Group",null))){
			context_raw->layer=project_layers->buffer[step->layer];
			project_layers->buffer[step->layer-1]->parent=null;
			slot_layer_delete(context_raw->layer);
			context_raw->layer=project_layers->buffer[step->layer>0?step->layer-1:0];
		}
		else if(string_equals(step->name,tr("Delete Layer",null))){
			slot_layer_t * parent=step->layer_parent>0?project_layers->buffer[step->layer_parent-1]:null;
			slot_layer_t * l=slot_layer_create("",step->layer_type,parent);
			array_insert(project_layers,step->layer,l);
			context_set_layer(l);
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(l,lay);
			l->mask_opacity=step->layer_opacity;
			l->blending=step->layer_blending;
			l->object_mask=step->layer_object;
			make_material_parse_mesh_material();
			if(step->layer_type==layer_slot_type_t_GROUP){
				sys_notify_on_next_frame(&history_undo_36933				,null);
			}
		}
		else if(string_equals(step->name,tr("Clear Layer",null))){
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer_preview_dirty=true;
		}
		else if(string_equals(step->name,tr("Duplicate Layer",null))){
			slot_layer_t_array_t * children=slot_layer_get_recursive_children(project_layers->buffer[step->layer]);
			i32 position=step->layer+1;
			if(children!=null){
				position+=children->length;
			}
			context_raw->layer=project_layers->buffer[position];
			slot_layer_delete(context_raw->layer);
		}
		else if(string_equals(step->name,tr("Order Layers",null))){
			slot_layer_t * target=project_layers->buffer[step->prev_order];
			project_layers->buffer[step->prev_order]=project_layers->buffer[step->layer];
			project_layers->buffer[step->layer]=target;
		}
		else if(string_equals(step->name,tr("Merge Layers",null))){
			context_raw->layer=project_layers->buffer[step->layer];
			slot_layer_delete(context_raw->layer);
			slot_layer_t * parent=step->layer_parent>0?project_layers->buffer[step->layer_parent-2]:null;
			slot_layer_t * l=slot_layer_create("",step->layer_type,parent);
			array_insert(project_layers,step->layer,l);
			context_set_layer(l);
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(context_raw->layer,lay);
			l=slot_layer_create("",step->layer_type,parent);
			array_insert(project_layers,step->layer+1,l);
			context_set_layer(l);
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer->mask_opacity=step->layer_opacity;
			context_raw->layer->blending=step->layer_blending;
			context_raw->layer->object_mask=step->layer_object;
			context_raw->layers_preview_dirty=true;
			make_material_parse_mesh_material();
		}
		else if(string_equals(step->name,tr("Apply Mask",null))){
			i32 mask_pos=step->layer;
			slot_layer_t * current_layer=null;
			if(slot_layer_is_mask(project_layers->buffer[mask_pos])){
				current_layer=project_layers->buffer[mask_pos]->parent;
			}
			else if(slot_layer_is_layer(project_layers->buffer[mask_pos])||slot_layer_is_group(project_layers->buffer[mask_pos])){
				current_layer=project_layers->buffer[mask_pos];
			}
			slot_layer_t_array_t * layers_to_restore;
			if(slot_layer_is_group(current_layer)){
				layers_to_restore=slot_layer_get_children(current_layer);
			}
			else {
				layers_to_restore=any_array_create_from_raw((any[]){current_layer,},1);
			}
			array_reverse(layers_to_restore);
			for(i32 i=0;i<layers_to_restore->length;++i){
				slot_layer_t * layer=layers_to_restore->buffer[i];
				context_raw->layer=layer;
				history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
				slot_layer_t * old_layer=history_undo_layers->buffer[history_undo_i];
				slot_layer_swap(context_raw->layer,old_layer);
			}
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * mask=history_undo_layers->buffer[history_undo_i];
			layers_new_mask(false,current_layer,mask_pos);
			slot_layer_swap(context_raw->layer,mask);
			context_raw->layers_preview_dirty=true;
			context_set_layer(context_raw->layer);
		}
		else if(string_equals(step->name,tr("Invert Mask",null))){
			sys_notify_on_init(&history_undo_37551			,step);
		}
		else if(string_equals(step->name,"Apply Filter")){
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			context_set_layer(project_layers->buffer[step->layer]);
			slot_layer_swap(context_raw->layer,lay);
			layers_new_mask(false,context_raw->layer,-1);
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer_preview_dirty=true;
		}
		else if(string_equals(step->name,tr("To Fill Layer",null))||string_equals(step->name,tr("To Fill Mask",null))){
			slot_layer_to_paint_layer(context_raw->layer);
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(context_raw->layer,lay);
		}
		else if(string_equals(step->name,tr("To Paint Layer",null))||string_equals(step->name,tr("To Paint Mask",null))){
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer->fill_layer=project_materials->buffer[step->material];
		}
		else if(string_equals(step->name,tr("Layer Opacity",null))){
			context_set_layer(project_layers->buffer[step->layer]);
			f32 t=context_raw->layer->mask_opacity;
			context_raw->layer->mask_opacity=step->layer_opacity;
			step->layer_opacity=t;
			make_material_parse_mesh_material();
		}
		else if(string_equals(step->name,tr("Layer Blending",null))){
			context_set_layer(project_layers->buffer[step->layer]);
			blend_type_t t=context_raw->layer->blending;
			context_raw->layer->blending=step->layer_blending;
			step->layer_blending=t;
			make_material_parse_mesh_material();
		}
		else if(string_equals(step->name,tr("Delete Node Group",null))){
			node_group_t * ng=GC_ALLOC_INIT(node_group_t, {.canvas=null,.nodes=ui_nodes_create()});
			array_insert(project_material_groups,step->canvas_group,ng);
			history_swap_canvas(step);
		}
		else if(string_equals(step->name,tr("New Material",null))){
			context_raw->material=project_materials->buffer[step->material];
			step->canvas=context_raw->material->canvas;
			slot_material_delete(context_raw->material);
		}
		else if(string_equals(step->name,tr("Delete Material",null))){
			context_raw->material=slot_material_create(project_materials->buffer[0]->data,null);
			array_insert(project_materials,step->material,context_raw->material);
			context_raw->material->canvas=step->canvas;
			ui_nodes_canvas_changed();
			ui_nodes_hwnd->redraws=2;
		}
		else if(string_equals(step->name,tr("Duplicate Material",null))){
			context_raw->material=project_materials->buffer[step->material];
			step->canvas=context_raw->material->canvas;
			slot_material_delete(context_raw->material);
		}
		else {
			history_undo_i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			context_select_paint_object(project_paint_objects->buffer[step->object]);
			context_set_layer(project_layers->buffer[step->layer]);
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer_preview_dirty=true;
		}
		history_undos--;
		history_redos++;
		context_raw->ddirty=2;
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
		if(ui_view2d_show){
			ui_view2d_hwnd->redraws=2;
		}
		if(config_raw->touch_ui){
			ui_menubar_menu_handle->redraws=2;
		}
	}
}

void history_undo_37551(step_t * step){
context_raw->layer=project_layers->buffer[step->layer];
			slot_layer_invert_mask(context_raw->layer);
}

void history_undo_36933(){
i32 active=history_steps->length-1-history_redos;
				i32 n=1;
				while(history_steps->buffer[active-n]->layer_type==layer_slot_type_t_MASK){
					history_undo();
					++n;
				}
				history_undo();
}

void history_redo(){
	if(history_redos>0){
		i32 active=history_steps->length-history_redos;
		step_t * step=history_steps->buffer[active];
		if(string_equals(step->name,tr("Edit Nodes",null))){
			history_swap_canvas(step);
		}
		else if(string_equals(step->name,tr("New Layer",null))||string_equals(step->name,tr("New Black Mask",null))||string_equals(step->name,tr("New White Mask",null))||string_equals(step->name,tr("New Fill Mask",null))){
			slot_layer_t * parent=step->layer_parent>0?project_layers->buffer[step->layer_parent-1]:null;
			slot_layer_t * l=slot_layer_create("",step->layer_type,parent);
			array_insert(project_layers,step->layer,l);
			if(string_equals(step->name,tr("New Black Mask",null))){
				sys_notify_on_next_frame(&history_redo_38215				,l);
			}
			else if(string_equals(step->name,tr("New White Mask",null))){
				sys_notify_on_next_frame(&history_redo_38248				,l);
			}
			else if(string_equals(step->name,tr("New Fill Mask",null))){
				context_raw->material=project_materials->buffer[step->material];
				sys_notify_on_next_frame(&history_redo_38288				,l);
			}
			context_raw->layer_preview_dirty=true;
			context_set_layer(l);
		}
		else if(string_equals(step->name,tr("New Group",null))){
			slot_layer_t * l=project_layers->buffer[step->layer-1];
			slot_layer_t * group=layers_new_group();
			array_remove(project_layers,group);
			array_insert(project_layers,step->layer,group);
			l->parent=group;
			context_set_layer(group);
		}
		else if(string_equals(step->name,tr("Delete Layer",null))){
			context_raw->layer=project_layers->buffer[step->layer];
			history_swap_active();
			slot_layer_delete(context_raw->layer);
			if(step->layer_type==layer_slot_type_t_LAYER&&history_steps->length>=active+2&&(history_steps->buffer[active+1]->layer_type==layer_slot_type_t_GROUP||history_steps->buffer[active+1]->layer_type==layer_slot_type_t_MASK)){
				sys_notify_on_next_frame(&history_redo_38439				,null);
			}
		}
		else if(string_equals(step->name,tr("Clear Layer",null))){
			context_raw->layer=project_layers->buffer[step->layer];
			history_swap_active();
			slot_layer_clear(context_raw->layer,0x00000000,null,1.0,layers_default_rough,0.0);
			context_raw->layer_preview_dirty=true;
		}
		else if(string_equals(step->name,tr("Duplicate Layer",null))){
			context_raw->layer=project_layers->buffer[step->layer];
			sys_notify_on_next_frame(&history_redo_38553			,null);
		}
		else if(string_equals(step->name,tr("Order Layers",null))){
			slot_layer_t * target=project_layers->buffer[step->prev_order];
			project_layers->buffer[step->prev_order]=project_layers->buffer[step->layer];
			project_layers->buffer[step->layer]=target;
		}
		else if(string_equals(step->name,tr("Merge Layers",null))){
			context_raw->layer=project_layers->buffer[step->layer+1];
			sys_notify_on_init(history_redo_merge_layers,null);
			sys_notify_on_init(layers_merge_down,null);
		}
		else if(string_equals(step->name,tr("Apply Mask",null))){
			context_raw->layer=project_layers->buffer[step->layer];
			if(slot_layer_is_group_mask(context_raw->layer)){
				slot_layer_t * group=context_raw->layer->parent;
				slot_layer_t_array_t * layers=slot_layer_get_children(group);
				array_insert(layers,0,context_raw->layer);
				history_copy_merging_layers2(layers);
			}
			else {
				slot_layer_t_array_t * layers=any_array_create_from_raw((any[]){context_raw->layer,context_raw->layer->parent,},2);
				history_copy_merging_layers2(layers);
			}
			sys_notify_on_next_frame(&history_redo_38719			,null);
		}
		else if(string_equals(step->name,tr("Invert Mask",null))){
			sys_notify_on_init(&history_redo_38754			,step);
		}
		else if(string_equals(step->name,tr("Apply Filter",null))){
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			context_set_layer(project_layers->buffer[step->layer]);
			slot_layer_swap(context_raw->layer,lay);
			layers_new_mask(false,lay,-1);
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer_preview_dirty=true;
			history_undo_i=(history_undo_i+1)%config_raw->undo_steps;
		}
		else if(string_equals(step->name,tr("To Fill Layer",null))||string_equals(step->name,tr("To Fill Mask",null))){
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer->fill_layer=project_materials->buffer[step->material];
			history_undo_i=(history_undo_i+1)%config_raw->undo_steps;
		}
		else if(string_equals(step->name,tr("To Paint Layer",null))||string_equals(step->name,tr("To Paint Mask",null))){
			slot_layer_to_paint_layer(context_raw->layer);
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			slot_layer_swap(context_raw->layer,lay);
			history_undo_i=(history_undo_i+1)%config_raw->undo_steps;
		}
		else if(string_equals(step->name,tr("Layer Opacity",null))){
			context_set_layer(project_layers->buffer[step->layer]);
			f32 t=context_raw->layer->mask_opacity;
			context_raw->layer->mask_opacity=step->layer_opacity;
			step->layer_opacity=t;
			make_material_parse_mesh_material();
		}
		else if(string_equals(step->name,tr("Layer Blending",null))){
			context_set_layer(project_layers->buffer[step->layer]);
			blend_type_t t=context_raw->layer->blending;
			context_raw->layer->blending=step->layer_blending;
			step->layer_blending=t;
			make_material_parse_mesh_material();
		}
		else if(string_equals(step->name,tr("Delete Node Group",null))){
			history_swap_canvas(step);
			array_remove(project_material_groups,project_material_groups->buffer[step->canvas_group]);
		}
		else if(string_equals(step->name,tr("New Material",null))){
			context_raw->material=slot_material_create(project_materials->buffer[0]->data,null);
			array_insert(project_materials,step->material,context_raw->material);
			context_raw->material->canvas=step->canvas;
			ui_nodes_canvas_changed();
			ui_nodes_hwnd->redraws=2;
		}
		else if(string_equals(step->name,tr("Delete Material",null))){
			context_raw->material=project_materials->buffer[step->material];
			step->canvas=context_raw->material->canvas;
			slot_material_delete(context_raw->material);
		}
		else if(string_equals(step->name,tr("Duplicate Material",null))){
			context_raw->material=slot_material_create(project_materials->buffer[0]->data,null);
			array_insert(project_materials,step->material,context_raw->material);
			context_raw->material->canvas=step->canvas;
			ui_nodes_canvas_changed();
			ui_nodes_hwnd->redraws=2;
		}
		else {
			slot_layer_t * lay=history_undo_layers->buffer[history_undo_i];
			context_select_paint_object(project_paint_objects->buffer[step->object]);
			context_set_layer(project_layers->buffer[step->layer]);
			slot_layer_swap(context_raw->layer,lay);
			context_raw->layer_preview_dirty=true;
			history_undo_i=(history_undo_i+1)%config_raw->undo_steps;
		}
		history_undos++;
		history_redos--;
		context_raw->ddirty=2;
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
		if(ui_view2d_show){
			ui_view2d_hwnd->redraws=2;
		}
		if(config_raw->touch_ui){
			ui_menubar_menu_handle->redraws=2;
		}
	}
}

void history_redo_38754(step_t * step){
context_raw->layer=project_layers->buffer[step->layer];
			slot_layer_invert_mask(context_raw->layer);
}

void history_redo_38719(){
slot_layer_apply_mask(context_raw->layer);
			context_set_layer(context_raw->layer);
			context_raw->layers_preview_dirty=true;
}

void history_redo_38553(){
layers_duplicate_layer(context_raw->layer);
}

void history_redo_38439(){
i32 active=history_steps->length-history_redos;
				i32 n=1;
				while(history_steps->buffer[active+n]->layer_type==layer_slot_type_t_MASK){
					++n;
				}
				for(i32 i=0;i<n;++i){
					history_redo();
				}
}

void history_redo_38288(slot_layer_t * l){
slot_layer_to_fill_layer(l);
}

void history_redo_38248(slot_layer_t * l){
slot_layer_clear(l,0xffffffff,null,1.0,layers_default_rough,0.0);
}

void history_redo_38215(slot_layer_t * l){
slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
}

void history_reset(){
	gc_unroot(history_steps);history_steps=any_array_create_from_raw((any[]){GC_ALLOC_INIT(step_t, {.name=tr("New",null),.layer=0,.layer_type=layer_slot_type_t_LAYER,.layer_parent=-1,.object=0,.material=0,.brush=0}),},1);gc_root(history_steps);
	history_undos=0;
	history_redos=0;
	history_undo_i=0;
}

void history_edit_nodes(ui_node_canvas_t * canvas,i32 canvas_type,i32 canvas_group){
	step_t * step=history_push(tr("Edit Nodes",null));
	step->canvas_group=canvas_group;
	step->canvas_type=canvas_type;
	step->canvas=util_clone_canvas(canvas);
}

void history_paint(){
	bool is_mask=slot_layer_is_mask(context_raw->layer);
	history_copy_to_undo(context_raw->layer->id,history_undo_i,is_mask);
	history_push_undo=false;
	history_push(tr(ui_toolbar_tool_names->buffer[context_raw->tool],null));
}

void history_new_layer(){
	history_push(tr("New Layer",null));
}

void history_new_black_mask(){
	history_push(tr("New Black Mask",null));
}

void history_new_white_mask(){
	history_push(tr("New White Mask",null));
}

void history_new_fill_mask(){
	history_push(tr("New Fill Mask",null));
}

void history_new_group(){
	history_push(tr("New Group",null));
}

void history_duplicate_layer(){
	history_push(tr("Duplicate Layer",null));
}

void history_delete_layer(){
	history_swap_active();
	history_push(tr("Delete Layer",null));
}

void history_clear_layer(){
	history_swap_active();
	history_push(tr("Clear Layer",null));
}

void history_order_layers(i32 prev_order){
	step_t * step=history_push(tr("Order Layers",null));
	step->prev_order=prev_order;
}

void history_merge_layers(){
	history_copy_merging_layers();
	step_t * step=history_push(tr("Merge Layers",null));
	step->layer-=1;
	if(slot_layer_has_masks(context_raw->layer,true)){
		step->layer-=slot_layer_get_masks(context_raw->layer,true)->length;
	}
	array_shift(history_steps);
	history_undos--;
}

void history_apply_mask(){
	if(slot_layer_is_group_mask(context_raw->layer)){
		slot_layer_t * group=context_raw->layer->parent;
		slot_layer_t_array_t * layers=slot_layer_get_children(group);
		array_insert(layers,0,context_raw->layer);
		history_copy_merging_layers2(layers);
	}
	else {
		slot_layer_t_array_t * layers=any_array_create_from_raw((any[]){context_raw->layer,context_raw->layer->parent,},2);
		history_copy_merging_layers2(layers);
	}
	history_push(tr("Apply Mask",null));
}

void history_invert_mask(){
	history_push(tr("Invert Mask",null));
}

void history_apply_filter(){
	history_copy_to_undo(context_raw->layer->id,history_undo_i,true);
	history_push(tr("Apply Filter",null));
}

void history_to_fill_layer(){
	history_copy_to_undo(context_raw->layer->id,history_undo_i,false);
	history_push(tr("To Fill Layer",null));
}

void history_to_fill_mask(){
	history_copy_to_undo(context_raw->layer->id,history_undo_i,true);
	history_push(tr("To Fill Mask",null));
}

void history_to_paint_layer(){
	history_copy_to_undo(context_raw->layer->id,history_undo_i,false);
	history_push(tr("To Paint Layer",null));
}

void history_to_paint_mask(){
	history_copy_to_undo(context_raw->layer->id,history_undo_i,true);
	history_push(tr("To Paint Mask",null));
}

void history_layer_opacity(){
	history_push(tr("Layer Opacity",null));
}

void history_layer_blending(){
	history_push(tr("Layer Blending",null));
}

void history_new_material(){
	step_t * step=history_push(tr("New Material",null));
	step->canvas_type=0;
	step->canvas=util_clone_canvas(context_raw->material->canvas);
}

void history_delete_material(){
	step_t * step=history_push(tr("Delete Material",null));
	step->canvas_type=0;
	step->canvas=util_clone_canvas(context_raw->material->canvas);
}

void history_duplicate_material(){
	step_t * step=history_push(tr("Duplicate Material",null));
	step->canvas_type=0;
	step->canvas=util_clone_canvas(context_raw->material->canvas);
}

void history_delete_material_group(node_group_t * group){
	step_t * step=history_push(tr("Delete Node Group",null));
	step->canvas_type=canvas_type_t_MATERIAL;
	step->canvas_group=array_index_of(project_material_groups,group);
	step->canvas=util_clone_canvas(group->canvas);
}

step_t * history_push(string_t * name){
	string_t * filename=string_equals(project_filepath,"")?ui_files_filename:substring(project_filepath,string_last_index_of(project_filepath,path_sep)+1,string_length(project_filepath)-4);
	sys_title_set(string_join(string_join(filename,"* - "),manifest_title));
	if(config_raw->touch_ui){
		ui_menubar_menu_handle->redraws=2;
	}
	if(history_undos<config_raw->undo_steps){
		history_undos++;
	}
	if(history_redos>0){
		for(i32 i=0;i<history_redos;++i){
			array_pop(history_steps);
		}
		history_redos=0;
	}
	i32 opos=array_index_of(project_paint_objects,context_raw->paint_object);
	i32 lpos=array_index_of(project_layers,context_raw->layer);
	i32 mpos=array_index_of(project_materials,context_raw->material);
	i32 bpos=array_index_of(project_brushes,context_raw->brush);
	step_t * step=GC_ALLOC_INIT(step_t, {.name=name,.layer=lpos,.layer_type=slot_layer_is_mask(context_raw->layer)?layer_slot_type_t_MASK:slot_layer_is_group(context_raw->layer)?layer_slot_type_t_GROUP:layer_slot_type_t_LAYER,.layer_parent=context_raw->layer->parent==null?-1:array_index_of(project_layers,context_raw->layer->parent),.object=opos,.material=mpos,.brush=bpos,.layer_opacity=context_raw->layer->mask_opacity,.layer_object=context_raw->layer->object_mask,.layer_blending=context_raw->layer->blending});
	any_array_push(history_steps,step);
	while(history_steps->length>config_raw->undo_steps+1){
		array_shift(history_steps);
	}
	return history_steps->buffer[history_steps->length-1];
}

void history_redo_merge_layers(){
	history_copy_merging_layers();
}

void history_copy_merging_layers(){
	slot_layer_t * lay=context_raw->layer;
	history_copy_to_undo(lay->id,history_undo_i,slot_layer_is_mask(context_raw->layer));
	i32 below=array_index_of(project_layers,lay)-1;
	lay=project_layers->buffer[below];
	history_copy_to_undo(lay->id,history_undo_i,slot_layer_is_mask(context_raw->layer));
}

void history_copy_merging_layers2(slot_layer_t_array_t * layers){
	for(i32 i=0;i<layers->length;++i){
		slot_layer_t * layer=layers->buffer[i];
		history_copy_to_undo(layer->id,history_undo_i,slot_layer_is_mask(layer));
	}
}

void history_swap_active(){
	slot_layer_t * undo_layer=history_undo_layers->buffer[history_undo_i];
	slot_layer_swap(undo_layer,context_raw->layer);
	history_undo_i=(history_undo_i+1)%config_raw->undo_steps;
}

void history_copy_to_undo(i32 from_id,i32 to_id,bool is_mask){
	if(is_mask){
		render_path_set_target(string_join("texpaint_undo",i32_to_string(to_id)),null,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target(string_join("texpaint",i32_to_string(from_id)),"tex");
		render_path_draw_shader("shader_datas/copy_pass/copy_pass");
	}
	else {
		string_t_array_t * additional=any_array_create_from_raw((any[]){string_join("texpaint_nor_undo",i32_to_string(to_id)),string_join("texpaint_pack_undo",i32_to_string(to_id)),},2);
		render_path_set_target(string_join("texpaint_undo",i32_to_string(to_id)),additional,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target(string_join("texpaint",i32_to_string(from_id)),"tex0");
		render_path_bind_target(string_join("texpaint_nor",i32_to_string(from_id)),"tex1");
		render_path_bind_target(string_join("texpaint_pack",i32_to_string(from_id)),"tex2");
		tex_format_t format=base_bits_handle->position==texture_bits_t_BITS8?tex_format_t_RGBA32:base_bits_handle->position==texture_bits_t_BITS16?tex_format_t_RGBA64:tex_format_t_RGBA128;
		string_t * pipe=format==tex_format_t_RGBA32?"copy_mrt3_pass":format==tex_format_t_RGBA64?"copy_mrt3RGBA64_pass":"copy_mrt3RGBA128_pass";
		render_path_draw_shader(string_join("shader_datas/copy_mrt3_pass/",pipe));
	}
	history_undo_i=(history_undo_i+1)%config_raw->undo_steps;
}

ui_node_canvas_t * history_get_canvas(step_t * step){
	if(step->canvas_group==-1){
		return project_materials->buffer[step->material]->canvas;
	}
	else {
		return project_material_groups->buffer[step->canvas_group]->canvas;
	}
}

void history_set_canvas(step_t * step,ui_node_canvas_t * canvas){
	if(step->canvas_group==-1){
		project_materials->buffer[step->material]->canvas=canvas;
	}
	else {
		project_material_groups->buffer[step->canvas_group]->canvas=canvas;
	}
}

void history_swap_canvas(step_t * step){
	if(step->canvas_type==0){
		ui_node_canvas_t * _canvas=history_get_canvas(step);
		history_set_canvas(step,step->canvas);
		step->canvas=_canvas;
		context_raw->material=project_materials->buffer[step->material];
	}
	else {
		ui_node_canvas_t * _canvas=project_brushes->buffer[step->brush]->canvas;
		project_brushes->buffer[step->brush]->canvas=step->canvas;
		step->canvas=_canvas;
		context_raw->brush=project_brushes->buffer[step->brush];
	}
	ui_nodes_canvas_changed();
	ui_nodes_hwnd->redraws=2;
}

void import_arm_run_project(string_t * path){
	buffer_t * b=data_get_blob(path);
	project_format_t * project;
	bool import_as_mesh=false;
	if(import_arm_is_legacy(b)){
		project=import_arm_from_legacy(b);
	}
	else if(!import_arm_has_version(b)){
		import_as_mesh=true;
		gc_unroot(scene_raw_gc);scene_raw_gc=armpack_decode(b);gc_root(scene_raw_gc);
		project=GC_ALLOC_INIT(project_format_t, {.mesh_datas=scene_raw_gc->mesh_datas});
	}
	else {
		project=armpack_decode(b);
	}
	if(project->version!=null&&project->layer_datas==null){
		if(project->material_nodes!=null){
			import_arm_run_material_from_project(project,path);
		}
		else if(project->brush_nodes!=null){
			import_arm_run_brush_from_project(project,path);
		}
		else if(project->swatches!=null){
			import_arm_run_swatches_from_project(project,path,false);
		}
		return ;
	}
	context_raw->layers_preview_dirty=true;
	context_raw->layer_filter=0;
	project_new(import_as_mesh);
	gc_unroot(project_filepath);project_filepath=string_copy(path);gc_root(project_filepath);
	gc_unroot(ui_files_filename);ui_files_filename=string_copy(substring(path,string_last_index_of(path,path_sep)+1,string_last_index_of(path,".")));gc_root(ui_files_filename);
	sys_title_set(string_join(string_join(ui_files_filename," - "),manifest_title));
	if(import_as_mesh){
		import_arm_run_mesh(project);
		return ;
	}
	string_t * recent_path=path;
	recent_path=string_copy(string_replace_all(recent_path,"\\","/"));
	string_t_array_t * recent=config_raw->recent_projects;
	char_ptr_array_remove(recent,recent_path);
	array_insert(recent,0,recent_path);
	config_save();
	gc_unroot(project_raw);project_raw=project;gc_root(project_raw);
	layer_data_t * l0=project->layer_datas->buffer[0];
	base_res_handle->position=config_get_texture_res_pos(l0->res);
	texture_bits_t bits_pos=l0->bpp==8?texture_bits_t_BITS8:l0->bpp==16?texture_bits_t_BITS16:texture_bits_t_BITS32;
	base_bits_handle->position=bits_pos;
	i32 bytes_per_pixel=math_floor(l0->bpp/(float)8);
	tex_format_t format=l0->bpp==8?tex_format_t_RGBA32:l0->bpp==16?tex_format_t_RGBA64:tex_format_t_RGBA128;
	string_t * base=path_base_dir(path);
	if(project_raw->envmap!=null){
		project_raw->envmap=data_is_abs(project_raw->envmap)?project_raw->envmap:string_join(base,project_raw->envmap);
	}
	scene_world->strength=project_raw->envmap_strength;
	if(project_raw->camera_world!=null){
		scene_camera->base->transform->local=mat4_from_f32_array(project_raw->camera_world,0);
		transform_decompose(scene_camera->base->transform);
		scene_camera->data->fov=project_raw->camera_fov;
		camera_object_build_proj(scene_camera,-1.0);
		f32_array_t * origin=project_raw->camera_origin;
		camera_origins->buffer[0]->v=vec4_create(origin->buffer[0],origin->buffer[1],origin->buffer[2],1.0);
	}
	for(i32 i=0;i<project->assets->length;++i){
		string_t * file=project->assets->buffer[i];
		file=string_copy(string_replace_all(file,"/","\\"));
		string_t * abs=data_is_abs(file)?file:string_join(base,file);
		if(project->packed_assets!=null){
			abs=string_copy(path_normalize(abs));
			import_arm_unpack_asset(project,abs,file);
		}
		if(any_map_get(data_cached_images,abs)==null&&!file_exists(abs)){
			import_arm_make_pink(abs);
		}
		bool hdr_as_envmap=ends_with(abs,".hdr")&&string_equals(project_raw->envmap,abs);
		import_texture_run(abs,hdr_as_envmap);
	}
	if(project->font_assets!=null){
		for(i32 i=0;i<project->font_assets->length;++i){
			string_t * file=project->font_assets->buffer[i];
			file=string_copy(string_replace_all(file,"/","\\"));
			string_t * abs=data_is_abs(file)?file:string_join(base,file);
			if(file_exists(abs)){
				import_font_run(abs);
			}
		}
	}
	mesh_data_t * md=mesh_data_create(project->mesh_datas->buffer[0]);
	mesh_object_set_data(context_raw->paint_object,md);
	context_raw->paint_object->base->transform->scale=vec4_create(1,1,1,1.0);
	transform_build_matrix(context_raw->paint_object->base->transform);
	context_raw->paint_object->base->name=md->name;
	gc_unroot(project_paint_objects);project_paint_objects=any_array_create_from_raw((any[]){context_raw->paint_object,},1);gc_root(project_paint_objects);
	for(i32 i=1;i<project->mesh_datas->length;++i){
		mesh_data_t * raw=project->mesh_datas->buffer[i];
		mesh_data_t * md=mesh_data_create(raw);
		mesh_object_t * object=scene_add_mesh_object(md,context_raw->paint_object->materials,context_raw->paint_object->base);
		object->base->name=md->name;
		object->skip_context="paint";
		any_array_push(project_paint_objects,object);
	}
	if(project->mesh_assets!=null&&project->mesh_assets->length>0){
		string_t * file=project->mesh_assets->buffer[0];
		string_t * abs=data_is_abs(file)?file:string_join(base,file);
		gc_unroot(project_mesh_assets);project_mesh_assets=any_array_create_from_raw((any[]){abs,},1);gc_root(project_mesh_assets);
	}
	if(project->atlas_objects!=null){
		gc_unroot(project_atlas_objects);project_atlas_objects=project->atlas_objects;gc_root(project_atlas_objects);
	}
	if(project->atlas_names!=null){
		gc_unroot(project_atlas_names);project_atlas_names=project->atlas_names;gc_root(project_atlas_names);
	}
	if(context_raw->merged_object==null){
		util_mesh_merge(null);
	}
	context_select_paint_object(context_main_object());
	viewport_scale_to_bounds();
	context_raw->paint_object->skip_context="paint";
	context_raw->merged_object->base->visible=true;
	gpu_texture_t * tex=project_layers->buffer[0]->texpaint;
	if(tex->width!=config_get_texture_res_x()||tex->height!=config_get_texture_res_y()){
		if(history_undo_layers!=null){
			for(i32 i=0;i<history_undo_layers->length;++i){
				slot_layer_t * l=history_undo_layers->buffer[i];
				slot_layer_resize_and_set_bits(l);
			}
		}
		any_map_t * rts=render_path_render_targets;
		render_target_t * blend0=any_map_get(rts,"texpaint_blend0");
		gpu_texture_t * _texpaint_blend0=blend0->_image;
		iron_delete_texture(_texpaint_blend0);
		blend0->width=config_get_texture_res_x();
		blend0->height=config_get_texture_res_y();
		blend0->_image=gpu_create_render_target(config_get_texture_res_x(),config_get_texture_res_y(),tex_format_t_R8);
		render_target_t * blend1=any_map_get(rts,"texpaint_blend1");
		gpu_texture_t * _texpaint_blend1=blend1->_image;
		iron_delete_texture(_texpaint_blend1);
		blend1->width=config_get_texture_res_x();
		blend1->height=config_get_texture_res_y();
		blend1->_image=gpu_create_render_target(config_get_texture_res_x(),config_get_texture_res_y(),tex_format_t_R8);
		context_raw->brush_blend_dirty=true;
	}
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		slot_layer_unload(l);
	}
	gc_unroot(project_layers);project_layers=any_array_create_from_raw((any[]){},0);gc_root(project_layers);
	for(i32 i=0;i<project->layer_datas->length;++i){
		layer_data_t * ld=project->layer_datas->buffer[i];
		bool is_group=ld->texpaint==null;
		bool is_mask=ld->texpaint!=null&&ld->texpaint_nor==null;
		slot_layer_t * l=slot_layer_create("",is_group?layer_slot_type_t_GROUP:is_mask?layer_slot_type_t_MASK:layer_slot_type_t_LAYER,null);
		if(ld->name!=null){
			l->name=string_copy(ld->name);
		}
		l->visible=ld->visible;
		any_array_push(project_layers,l);
		if(!is_group){
			gpu_texture_t * _texpaint=null;
			gpu_texture_t * _texpaint_nor=null;
			gpu_texture_t * _texpaint_pack=null;
			if(is_mask){
				_texpaint=gpu_create_texture_from_bytes(lz4_decode(ld->texpaint,ld->res*ld->res*4),ld->res,ld->res,tex_format_t_RGBA32);
				draw_begin(l->texpaint,false,0);
				draw_set_pipeline(project->is_bgra?pipes_copy_bgra:pipes_copy);
				draw_image(_texpaint,0,0);
				draw_set_pipeline(null);
				draw_end();
			}
			else {
				_texpaint=gpu_create_texture_from_bytes(lz4_decode(ld->texpaint,ld->res*ld->res*4*bytes_per_pixel),ld->res,ld->res,format);
				draw_begin(l->texpaint,false,0);
				draw_set_pipeline(project->is_bgra?pipes_copy_bgra:pipes_copy);
				draw_image(_texpaint,0,0);
				draw_set_pipeline(null);
				draw_end();
				_texpaint_nor=gpu_create_texture_from_bytes(lz4_decode(ld->texpaint_nor,ld->res*ld->res*4*bytes_per_pixel),ld->res,ld->res,format);
				draw_begin(l->texpaint_nor,false,0);
				draw_set_pipeline(project->is_bgra?pipes_copy_bgra:pipes_copy);
				draw_image(_texpaint_nor,0,0);
				draw_set_pipeline(null);
				draw_end();
				_texpaint_pack=gpu_create_texture_from_bytes(lz4_decode(ld->texpaint_pack,ld->res*ld->res*4*bytes_per_pixel),ld->res,ld->res,format);
				draw_begin(l->texpaint_pack,false,0);
				draw_set_pipeline(project->is_bgra?pipes_copy_bgra:pipes_copy);
				draw_image(_texpaint_pack,0,0);
				draw_set_pipeline(null);
				draw_end();
			}
			l->scale=ld->uv_scale;
			l->angle=ld->uv_rot;
			l->uv_type=ld->uv_type;
			if(ld->decal_mat!=null){
				l->decal_mat=mat4_from_f32_array(ld->decal_mat,0);
			}
			l->mask_opacity=ld->opacity_mask;
			l->object_mask=ld->object_mask;
			l->blending=ld->blending;
			l->paint_base=ld->paint_base;
			l->paint_opac=ld->paint_opac;
			l->paint_occ=ld->paint_occ;
			l->paint_rough=ld->paint_rough;
			l->paint_met=ld->paint_met;
			l->paint_nor=ld->paint_nor;
			l->paint_nor_blend=ld->paint_nor_blend;
			l->paint_height=ld->paint_height;
			l->paint_height_blend=ld->paint_height_blend;
			l->paint_emis=ld->paint_emis;
			l->paint_subs=ld->paint_subs;
			iron_delete_texture(_texpaint);
			if(_texpaint_nor!=null){
				iron_delete_texture(_texpaint_nor);
			}
			if(_texpaint_pack!=null){
				iron_delete_texture(_texpaint_pack);
			}
		}
	}
	for(i32 i=0;i<project->layer_datas->length;++i){
		layer_data_t * ld=project->layer_datas->buffer[i];
		if(ld->parent>=0){
			project_layers->buffer[i]->parent=project_layers->buffer[ld->parent];
		}
	}
	context_set_layer(project_layers->buffer[0]);
	material_data_t * m0=data_get_material("Scene","Material");
	gc_unroot(project_materials);project_materials=any_array_create_from_raw((any[]){},0);gc_root(project_materials);
	for(i32 i=0;i<project->material_nodes->length;++i){
		ui_node_canvas_t * n=project->material_nodes->buffer[i];
		import_arm_init_nodes(n->nodes);
		context_raw->material=slot_material_create(m0,n);
		any_array_push(project_materials,context_raw->material);
	}
	ui_nodes_hwnd->redraws=2;
	gc_unroot(ui_nodes_group_stack);ui_nodes_group_stack=any_array_create_from_raw((any[]){},0);gc_root(ui_nodes_group_stack);
	gc_unroot(project_material_groups);project_material_groups=any_array_create_from_raw((any[]){},0);gc_root(project_material_groups);
	if(project->material_groups!=null){
		for(i32 i=0;i<project->material_groups->length;++i){
			ui_node_canvas_t * g=project->material_groups->buffer[i];
			node_group_t * ng=GC_ALLOC_INIT(node_group_t, {.canvas=g,.nodes=ui_nodes_create()});
			any_array_push(project_material_groups,ng);
		}
	}
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		context_raw->material=m;
		make_material_parse_paint_material(true);
		util_render_make_material_preview();
	}
	gc_unroot(project_brushes);project_brushes=any_array_create_from_raw((any[]){},0);gc_root(project_brushes);
	for(i32 i=0;i<project->brush_nodes->length;++i){
		ui_node_canvas_t * n=project->brush_nodes->buffer[i];
		import_arm_init_nodes(n->nodes);
		context_raw->brush=slot_brush_create(n);
		any_array_push(project_brushes,context_raw->brush);
		make_material_parse_brush();
		util_render_make_brush_preview();
	}
	for(i32 i=0;i<project->layer_datas->length;++i){
		layer_data_t * ld=project->layer_datas->buffer[i];
		slot_layer_t * l=project_layers->buffer[i];
		bool is_group=ld->texpaint==null;
		if(!is_group){
			l->fill_layer=ld->fill_layer>-1?project_materials->buffer[ld->fill_layer]:null;
		}
	}
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	context_raw->ddirty=4;
	data_delete_blob(path);
}

void import_arm_run_mesh(project_format_t * raw){
	gc_unroot(project_paint_objects);project_paint_objects=any_array_create_from_raw((any[]){},0);gc_root(project_paint_objects);
	for(i32 i=0;i<raw->mesh_datas->length;++i){
		mesh_data_t * md=mesh_data_create(raw->mesh_datas->buffer[i]);
		mesh_object_t * object=null;
		if(i==0){
			mesh_object_set_data(context_raw->paint_object,md);
			object=context_raw->paint_object;
		}
		else {
			object=scene_add_mesh_object(md,context_raw->paint_object->materials,context_raw->paint_object->base);
			object->base->name=md->name;
			object->skip_context="paint";
			md->_->handle=md->name;
			any_map_set(data_cached_meshes,md->_->handle,md);
		}
		object->base->transform->scale=vec4_create(1,1,1,1.0);
		transform_build_matrix(object->base->transform);
		object->base->name=md->name;
		any_array_push(project_paint_objects,object);
		util_mesh_merge(null);
		viewport_scale_to_bounds();
	}
	sys_notify_on_init(layers_init,null);
	history_reset();
}

void import_arm_run_material(string_t * path){
	buffer_t * b=data_get_blob(path);
	project_format_t * project;
	if(import_arm_is_legacy(b)){
		project=import_arm_from_legacy(b);
	}
	else {
		project=armpack_decode(b);
	}
	if(project->version==null){
		data_delete_blob(path);
		return ;
	}
	import_arm_run_material_from_project(project,path);
}

void import_arm_run_material_from_project(project_format_t * project,string_t * path){
	string_t * base=path_base_dir(path);
	for(i32 i=0;i<project->assets->length;++i){
		string_t * file=project->assets->buffer[i];
		file=string_copy(string_replace_all(file,"/","\\"));
		string_t * abs=data_is_abs(file)?file:string_join(base,file);
		if(project->packed_assets!=null){
			abs=string_copy(path_normalize(abs));
			import_arm_unpack_asset(project,abs,file);
		}
		if(any_map_get(data_cached_images,abs)==null&&!file_exists(abs)){
			import_arm_make_pink(abs);
		}
		import_texture_run(abs,true);
	}
	material_data_t * m0=data_get_material("Scene","Material");
	slot_material_t_array_t * imported=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project->material_nodes->length;++i){
		ui_node_canvas_t * c=util_clone_canvas(project->material_nodes->buffer[i]);
		import_arm_init_nodes(c->nodes);
		context_raw->material=slot_material_create(m0,c);
		any_array_push(project_materials,context_raw->material);
		any_array_push(imported,context_raw->material);
		history_new_material();
	}
	if(project->material_groups!=null){
		for(i32 i=0;i<project->material_groups->length;++i){
			project->material_groups->buffer[i]=util_clone_canvas(project->material_groups->buffer[i]);
		}
		for(i32 i=0;i<project->material_groups->length;++i){
			ui_node_canvas_t * c=project->material_groups->buffer[i];
			while(import_arm_group_exists(c)){
				import_arm_rename_group(c->name,imported,project->material_groups);
			}
			import_arm_init_nodes(c->nodes);
			node_group_t * ng=GC_ALLOC_INIT(node_group_t, {.canvas=c,.nodes=ui_nodes_create()});
			any_array_push(project_material_groups,ng);
		}
	}
	sys_notify_on_init(&import_arm_run_material_from_project_43216	,imported);
	gc_unroot(ui_nodes_group_stack);ui_nodes_group_stack=any_array_create_from_raw((any[]){},0);gc_root(ui_nodes_group_stack);
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	data_delete_blob(path);
}

void import_arm_run_material_from_project_43216(slot_material_t_array_t * imported){
for(i32 i=0;i<imported->length;++i){
		slot_material_t * m=imported->buffer[i];
		context_set_material(m);
		make_material_parse_paint_material(true);
		util_render_make_material_preview();
	}
}

bool import_arm_group_exists(ui_node_canvas_t * c){
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * g=project_material_groups->buffer[i];
		string_t * cname=g->canvas->name;
		if(string_equals(cname,c->name)){
			return true;
		}
	}
	return false;
}

void import_arm_rename_group(string_t * name,slot_material_t_array_t * materials,ui_node_canvas_t_array_t * groups){
	for(i32 i=0;i<materials->length;++i){
		slot_material_t * m=materials->buffer[i];
		for(i32 i=0;i<m->canvas->nodes->length;++i){
			ui_node_t * n=m->canvas->nodes->buffer[i];
			if(string_equals(n->type,"GROUP")&&string_equals(n->name,name)){
				n->name=string_join(n->name,".1");
			}
		}
	}
	for(i32 i=0;i<groups->length;++i){
		ui_node_canvas_t * c=groups->buffer[i];
		if(string_equals(c->name,name)){
			c->name=string_join(c->name,".1");
		}
		for(i32 i=0;i<c->nodes->length;++i){
			ui_node_t * n=c->nodes->buffer[i];
			if(string_equals(n->type,"GROUP")&&string_equals(n->name,name)){
				n->name=string_join(n->name,".1");
			}
		}
	}
}

void import_arm_run_brush(string_t * path){
	buffer_t * b=data_get_blob(path);
	project_format_t * project=armpack_decode(b);
	if(project->version==null){
		data_delete_blob(path);
		return ;
	}
	import_arm_run_brush_from_project(project,path);
}

void import_arm_run_brush_from_project(project_format_t * project,string_t * path){
	string_t * base=path_base_dir(path);
	for(i32 i=0;i<project->assets->length;++i){
		string_t * file=project->assets->buffer[i];
		file=string_copy(string_replace_all(file,"/","\\"));
		string_t * abs=data_is_abs(file)?file:string_join(base,file);
		if(project->packed_assets!=null){
			abs=string_copy(path_normalize(abs));
			import_arm_unpack_asset(project,abs,file);
		}
		if(any_map_get(data_cached_images,abs)==null&&!file_exists(abs)){
			import_arm_make_pink(abs);
		}
		import_texture_run(abs,true);
	}
	slot_brush_t_array_t * imported=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project->brush_nodes->length;++i){
		ui_node_canvas_t * c=util_clone_canvas(project->brush_nodes->buffer[i]);
		import_arm_init_nodes(c->nodes);
		context_raw->brush=slot_brush_create(c);
		any_array_push(project_brushes,context_raw->brush);
		any_array_push(imported,context_raw->brush);
	}
	sys_notify_on_init(&import_arm_run_brush_from_project_43769	,imported);
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	data_delete_blob(path);
}

void import_arm_run_brush_from_project_43769(slot_brush_t_array_t * imported){
for(i32 i=0;i<imported->length;++i){
		slot_brush_t * b=imported->buffer[i];
		context_set_brush(b);
		make_material_parse_brush();
		util_render_make_brush_preview();
	}
}

void import_arm_run_swatches(string_t * path,bool replace_existing){
	buffer_t * b=data_get_blob(path);
	project_format_t * project=armpack_decode(b);
	if(project->version==null){
		data_delete_blob(path);
		return ;
	}
	import_arm_run_swatches_from_project(project,path,replace_existing);
}

void import_arm_run_swatches_from_project(project_format_t * project,string_t * path,bool replace_existing){
	if(replace_existing){
		project_raw->swatches=any_array_create_from_raw((any[]){},0);
		if(project->swatches==null){
			any_array_push(project_raw->swatches,make_swatch(0xffffffff));
		}
	}
	if(project->swatches!=null){
		for(i32 i=0;i<project->swatches->length;++i){
			swatch_color_t * s=util_clone_swatch_color(project->swatches->buffer[i]);
			any_array_push(project_raw->swatches,s);
		}
	}
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
	data_delete_blob(path);
}

void import_arm_make_pink(string_t * abs){
	console_error(string_join(string_join(strings_could_not_locate_texture()," "),abs));
	u8_array_t * b=u8_array_create(4);
	b->buffer[0]=255;
	b->buffer[1]=0;
	b->buffer[2]=255;
	b->buffer[3]=255;
	gpu_texture_t * pink=gpu_create_texture_from_bytes(b,1,1,tex_format_t_RGBA32);
	any_map_set(data_cached_images,abs,pink);
}

string_t * import_arm_texture_node_name(){
	return "TEX_IMAGE";
}

void import_arm_init_nodes(ui_node_t_array_t * nodes){
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * node=nodes->buffer[i];
		if(string_equals(node->type,import_arm_texture_node_name())){
			node->buttons->buffer[0]->default_value=f32_array_create_x(base_get_asset_index(u8_array_to_string(node->buttons->buffer[0]->data)));
			node->buttons->buffer[0]->data=u8_array_create_from_string("");
		}
	}
}

void import_arm_unpack_asset(project_format_t * project,string_t * abs,string_t * file){
	if(project_raw->packed_assets==null){
		project_raw->packed_assets=any_array_create_from_raw((any[]){},0);
	}
	for(i32 i=0;i<project->packed_assets->length;++i){
		packed_asset_t * pa=project->packed_assets->buffer[i];
		pa->name=string_copy(string_replace_all(pa->name,"/","\\"));
		pa->name=string_copy(path_normalize(pa->name));
		if(string_equals(pa->name,file)){
			pa->name=string_copy(abs);
		}
		if(string_equals(pa->name,abs)){
			if(!project_packed_asset_exists(project_raw->packed_assets,pa->name)){
				any_array_push(project_raw->packed_assets,pa);
			}
			gpu_texture_t * image=gpu_create_texture_from_encoded_bytes(pa->bytes,ends_with(pa->name,".jpg")?".jpg":".png");
			any_map_set(data_cached_images,abs,image);
			break;
		}
	}
}

ui_node_socket_t_array_t * _import_arm_get_node_socket_array(any_map_t * old,string_t * key){
	ui_node_socket_t_array_t * sockets=any_array_create_from_raw((any[]){},0);
	any_array_t * ias=any_map_get(old,key);
	for(i32 i=0;i<ias->length;++i){
		any_map_t * old=ias->buffer[i];
		ui_node_socket_t * s=GC_ALLOC_INIT(ui_node_socket_t, {0});
		s->id=armpack_map_get_i32(old,"id");
		s->node_id=armpack_map_get_i32(old,"node_id");
		s->name=string_copy(any_map_get(old,"name"));
		s->type=string_copy(any_map_get(old,"type"));
		s->color=armpack_map_get_i32(old,"color");
		if(string_equals(s->type,"VALUE")){
			f32 x=armpack_map_get_f32(old,"default_value");
			s->default_value=f32_array_create_x(x);
		}
		else {
			any_map_t * dv=any_map_get(old,"default_value");
			f32 x=armpack_map_get_f32(dv,"0");
			f32 y=armpack_map_get_f32(dv,"1");
			f32 z=armpack_map_get_f32(dv,"2");
			if(string_equals(s->type,"VECTOR")){
				s->default_value=f32_array_create_xyz(x,y,z);
			}
			else {
				f32 w=armpack_map_get_f32(dv,"3");
				s->default_value=f32_array_create_xyzw(x,y,z,w);
			}
		}
		s->min=armpack_map_get_f32(old,"min");
		s->max=armpack_map_get_f32(old,"max");
		if(s->max==0.0){
			s->max=1.0;
		}
		s->precision=armpack_map_get_f32(old,"precision");
		if(s->precision==0.0){
			s->precision=100.0;
		}
		s->display=armpack_map_get_i32(old,"display");
		any_array_push(sockets,s);
	}
	return sockets;
}

ui_node_canvas_t_array_t * _import_arm_get_node_canvas_array(any_map_t * map,string_t * key){
	any_array_t * cas=any_map_get(map,key);
	if(cas==null){
		return null;
	}
	ui_node_canvas_t_array_t * ar=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<cas->length;++i){
		any_map_t * old=cas->buffer[i];
		ui_node_canvas_t * c=GC_ALLOC_INIT(ui_node_canvas_t, {0});
		c->name=string_copy(any_map_get(old,"name"));
		c->nodes=any_array_create_from_raw((any[]){},0);
		any_array_t * nas=any_map_get(old,"nodes");
		for(i32 i=0;i<nas->length;++i){
			any_map_t * old=nas->buffer[i];
			ui_node_t * n=GC_ALLOC_INIT(ui_node_t, {0});
			n->id=armpack_map_get_i32(old,"id");
			n->name=string_copy(any_map_get(old,"name"));
			n->type=string_copy(any_map_get(old,"type"));
			n->x=armpack_map_get_f32(old,"x");
			n->y=armpack_map_get_f32(old,"y");
			n->color=armpack_map_get_i32(old,"color");
			n->inputs=_import_arm_get_node_socket_array(old,"inputs");
			n->outputs=_import_arm_get_node_socket_array(old,"outputs");
			n->buttons=any_array_create_from_raw((any[]){},0);
			any_array_t * bas=any_map_get(old,"buttons");
			for(i32 i=0;i<bas->length;++i){
				any_map_t * old=bas->buffer[i];
				ui_node_button_t * b=GC_ALLOC_INIT(ui_node_button_t, {0});
				b->name=string_copy(any_map_get(old,"name"));
				b->type=string_copy(any_map_get(old,"type"));
				b->output=armpack_map_get_i32(old,"output");
				if(string_equals(b->type,"ENUM")){
					f32 x=armpack_map_get_i32(old,"default_value");
					b->default_value=f32_array_create_x(x);
					if(string_equals(b->name,"File")){
						string_t * data_string=any_map_get(old,"data");
						b->data=sys_string_to_buffer(data_string);
					}
					else {
						string_t_array_t * data_strings=any_map_get(old,"data");
						string_t * joined=string_array_join(data_strings,"\n");
						b->data=sys_string_to_buffer(joined);
					}
				}
				else if(string_equals(b->type,"BOOL")){
					f32 x=armpack_map_get_i32(old,"default_value");
					b->default_value=f32_array_create_x(x);
				}
				else if(string_equals(b->type,"CUSTOM")){
					if(string_equals(b->name,"arm.shader.NodesMaterial.newGroupButton")){
						b->name="nodes_material_new_group_button";
					}
					else if(string_equals(b->name,"arm.shader.NodesMaterial.groupOutputButton")){
						b->name="nodes_material_group_output_button";
					}
					else if(string_equals(b->name,"arm.shader.NodesMaterial.groupInputButton")){
						b->name="nodes_material_group_input_button";
					}
					else if(string_equals(b->name,"arm.shader.NodesMaterial.vectorCurvesButton")){
						b->name="nodes_material_vector_curves_button";
					}
					else if(string_equals(b->name,"arm.shader.NodesMaterial.colorRampButton")){
						b->name="nodes_material_color_ramp_button";
					}
				}
				b->min=armpack_map_get_f32(old,"min");
				b->max=armpack_map_get_f32(old,"max");
				b->precision=armpack_map_get_f32(old,"precision");
				b->height=armpack_map_get_f32(old,"height");
				any_array_push(n->buttons,b);
			}
			n->width=armpack_map_get_f32(old,"width");
			any_array_push(c->nodes,n);
		}
		c->links=any_array_create_from_raw((any[]){},0);
		any_array_t * las=any_map_get(old,"links");
		for(i32 i=0;i<las->length;++i){
			any_map_t * old=las->buffer[i];
			ui_node_link_t * l=GC_ALLOC_INIT(ui_node_link_t, {0});
			l->id=armpack_map_get_i32(old,"id");
			l->from_id=armpack_map_get_i32(old,"from_id");
			l->from_socket=armpack_map_get_i32(old,"from_socket");
			l->to_id=armpack_map_get_i32(old,"to_id");
			l->to_socket=armpack_map_get_i32(old,"to_socket");
			any_array_push(c->links,l);
		}
		any_array_push(ar,c);
	}
	return ar;
}

bool import_arm_has_version(buffer_t * b){
	bool has_version=b->buffer[10]==118;
	return has_version;
}

bool import_arm_is_legacy(buffer_t * b){
	bool has_version=b->buffer[10]==118;
	bool has_zero=b->buffer[22]==48;
	bool has_dot=b->buffer[23]==46;
	bool has_eight=b->buffer[24]==56;
	bool has_nine=b->buffer[24]==57;
	if(has_version&&has_zero&&has_dot&&(has_eight||has_nine)){
		return true;
	}
	return false;
}

project_format_t * import_arm_from_legacy(buffer_t * b){
	any_map_t * old=armpack_decode_to_map(b);
	project_format_t * project=GC_ALLOC_INIT(project_format_t, {0});
	project->version="1.0 alpha";
	project->assets=any_map_get(old,"assets");
	if(project->assets==null){
		project->assets=any_array_create_from_raw((any[]){},0);
	}
	project->is_bgra=armpack_map_get_i32(old,"is_bgra")>0;
	any_array_t * pas=any_map_get(old,"packed_assets");
	if(pas!=null){
		project->packed_assets=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<pas->length;++i){
			any_map_t * old=pas->buffer[i];
			packed_asset_t * pa=GC_ALLOC_INIT(packed_asset_t, {0});
			pa->name=string_copy(any_map_get(old,"name"));
			pa->bytes=any_map_get(old,"bytes");
			any_array_push(project->packed_assets,pa);
		}
	}
	project->brush_nodes=_import_arm_get_node_canvas_array(old,"brush_nodes");
	project->brush_icons=any_map_get(old,"brush_icons");
	project->material_nodes=_import_arm_get_node_canvas_array(old,"material_nodes");
	project->material_groups=_import_arm_get_node_canvas_array(old,"material_groups");
	project->material_icons=any_map_get(old,"material_icons");
	return project;
}

void import_asset_run(string_t * path,f32 drop_x,f32 drop_y,bool show_box,bool hdr_as_envmap,void(*done)(void)){
	if(starts_with(path,"cloud")){
		_import_asset_drop_x=drop_x;
		_import_asset_drop_y=drop_y;
		_import_asset_show_box=show_box;
		_import_asset_hdr_as_envmap=hdr_as_envmap;
		gc_unroot(_import_asset_done);_import_asset_done=done;gc_root(_import_asset_done);
		file_cache_cloud(path,&import_asset_run_45777		);
		return ;
	}
	if(path_is_mesh(path)){
		show_box?project_import_mesh_box(path,true,true,null):import_mesh_run(path,true,true);
		if(drop_x>0){
			ui_box_click_to_hide=false;
		}
	}
	else if(path_is_texture(path)){
		import_texture_run(path,hdr_as_envmap);
		i32 x0=ui_nodes_wx;
		i32 x1=ui_nodes_wx+ui_nodes_ww;
		if(ui_nodes_show&&drop_x>x0&&drop_x<x1){
			i32 asset_index=0;
			for(i32 i=0;i<project_assets->length;++i){
				if(string_equals(project_assets->buffer[i]->file,path)){
					asset_index=i;
					break;
				}
			}
			ui_nodes_accept_asset_drag(asset_index);
			ui_nodes_get_nodes()->nodes_drag=false;
			ui_nodes_hwnd->redraws=2;
		}
		if(context_raw->tool==workspace_tool_t_COLORID&&project_asset_names->length==1){
			ui_header_handle->redraws=2;
			context_raw->ddirty=2;
		}
	}
	else if(path_is_project(path)){
		import_arm_run_project(path);
	}
	else if(path_is_plugin(path)){
		import_plugin_run(path);
	}
	else if(path_is_gimp_color_palette(path)){
	}
	else if(path_is_font(path)){
		import_font_run(path);
	}
	else if(path_is_folder(path)){
		import_folder_run(path);
	}
	else {
		if(context_enable_import_plugin(path)){
			import_asset_run(path,drop_x,drop_y,show_box,true,null);
		}
		else {
			console_error(strings_unknown_asset_format());
		}
	}
	if(done!=null){
		done();
	}
}

void import_asset_run_45777(string_t * abs){
if(abs==null){
			return ;
		}
		import_asset_run(abs,_import_asset_drop_x,_import_asset_drop_y,_import_asset_show_box,_import_asset_hdr_as_envmap,_import_asset_done);
}

void import_blend_material_run(string_t * path){
	gc_unroot(_import_blend_material_path);_import_blend_material_path=string_copy(path);gc_root(_import_blend_material_path);
	ui_box_show_custom(&import_blend_material_run_46108	,400,200,null,true);
}

void import_blend_material_run_46108(ui_t * ui){
if(ui_tab(ui_handle("import_blend_material.ts:8"),tr("Import Material",null),false,-1)){
		import_blend_mesh_ui();
		ui_row2();
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")||ui->is_return_down){
			ui_box_hide();
			if(config_raw->blender==null||string_equals(config_raw->blender,"")){
				console_error(tr("Blender executable path not set",null));
				return ;
			}
			_import_blend_material();
		}
	}
}

void _import_blend_material(){
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	console_toast(tr("Baking material",null));
	if(in_use)draw_begin(current,false,0);
	sys_notify_on_init(&_import_blend_material_46250	,null);
}

void _import_blend_material_46250(){
string_t * save;
	if(path_is_protected()){
		save=string_copy(iron_internal_save_path());
	}
	else {
		save=string_copy(path_data());
	}
	save=string_join(save,"blender");
	file_create_directory(save);
	string_t * py=string_join(string_join(string_join(string_join(string_join(string_join("\
import bpy;\n\
bpy.context.scene.render.engine = 'CYCLES'\n\
bpy.context.scene.cycles.samples = 4\n\
bpy.ops.mesh.primitive_plane_add()\n\
plane = bpy.context.selected_objects[0]\n\
img = bpy.data.images.new('bake', 2048, 2048)\n\
img.file_format = 'JPEG'\n\
for mat in bpy.data.materials:\n\
    if mat.name == 'Dots Stroke':\n\
        continue\n\
    plane.data.materials.append(mat)\n\
    node = mat.node_tree.nodes.new(type='ShaderNodeTexImage')\n\
    node.image = img\n\
    mat.node_tree.nodes.active = node\n\
    bpy.ops.object.bake(type='DIFFUSE')\n\
    img.filepath_raw = '",save),"/blender_base.jpg'\n\
    img.save()\n\
    bpy.ops.object.bake(type='ROUGHNESS')\n\
    img.filepath_raw = '"),save),"/blender_rough.jpg'\n\
    img.save()\n\
    bpy.ops.object.bake(type='NORMAL')\n\
    img.filepath_raw = '"),save),"/blender_nor.jpg'\n\
    img.save()\n\
    break\n\
");
	iron_sys_command(string_join(string_join(string_join(string_join(string_join(string_join("\"",config_raw->blender),"\" \""),_import_blend_material_path),"\" -b --python-expr \""),py),"\""));
	import_folder_run(save);
}

void import_blend_mesh_ui(){
	if(config_raw->blender==null){
		config_raw->blender="";
	}
	ui_text(tr("Blender Executable",null),ui_align_t_LEFT,0x00000000);
	f32_array_t * ar=f32_array_create_from_raw((f32[]){7/(float)8,1/(float)8,},2);
	ui_row(ar);
	ui_handle_t * h=ui_handle("import_blend_mesh.ts:11");
	h->text=string_copy(config_raw->blender);
	config_raw->blender=string_copy(ui_text_input(h,"",ui_align_t_LEFT,true,false));
	if(ui_button("...",ui_align_t_CENTER,"")){
		ui_files_show("",false,false,&import_blend_mesh_ui_46420		);
	}
}

void import_blend_mesh_ui_46420(string_t * path){
path=string_copy(string_replace_all(path,"\\","/"));
		config_raw->blender=string_copy(path);
		config_save();
}

void import_blend_mesh_run(string_t * path,bool replace_existing){
	if(config_raw->blender==null||string_equals(config_raw->blender,"")){
		console_error(tr("Blender executable path not set",null));
		return ;
	}
	string_t * save="tmp.obj";
	if(path_is_protected()){
		save=string_join(iron_internal_save_path(),save);
	}
	path=string_copy(string_replace_all(path,"\\","\\\\"));
	save=string_copy(string_replace_all(save,"\\","\\\\"));
	string_t * py=string_join(string_join("\
import bpy;\
bpy.ops.wm.obj_export(filepath='",save),"',export_triangulated_mesh=True,export_materials=False,check_existing=False)");
	string_t * bl=string_replace_all(config_raw->blender," ","\\ ");
	iron_sys_command(string_join(string_join(string_join(string_join(string_join(bl," \""),path),"\" -b --python-expr \""),py),"\""));
	import_obj_run(save,replace_existing);
}

void import_envmap_run(string_t * path,gpu_texture_t * image){
	if(import_envmap_pipeline==null){
		gc_unroot(import_envmap_pipeline);import_envmap_pipeline=gpu_create_pipeline();gc_root(import_envmap_pipeline);
		import_envmap_pipeline->vertex_shader=sys_get_shader("prefilter_envmap.vert");
		import_envmap_pipeline->fragment_shader=sys_get_shader("prefilter_envmap.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		import_envmap_pipeline->input_layout=vs;
		import_envmap_pipeline->color_attachment_count=1;
		ARRAY_ACCESS(import_envmap_pipeline->color_attachment,0)=tex_format_t_RGBA128;
		gpu_pipeline_compile(import_envmap_pipeline);
		import_envmap_params_loc=0;
		import_envmap_radiance_loc=0;
		gc_unroot(import_envmap_radiance);import_envmap_radiance=gpu_create_render_target(1024,512,tex_format_t_RGBA128);gc_root(import_envmap_radiance);
		gc_unroot(import_envmap_mips);import_envmap_mips=any_array_create_from_raw((any[]){},0);gc_root(import_envmap_mips);
		i32 w=512;
		for(i32 i=0;i<5;++i){
			any_array_push(import_envmap_mips,gpu_create_render_target(w,w>1?math_floor(w/(float)2):1,tex_format_t_RGBA128));
			w=math_floor(w/(float)2);
		}
	}
	draw_begin(import_envmap_radiance,false,0);
	draw_set_pipeline(pipes_copy128);
	draw_scaled_image(image,0,0,1024,512);
	draw_set_pipeline(null);
	draw_end();
	for(i32 i=0;i<import_envmap_mips->length;++i){
		import_envmap_get_radiance_mip(import_envmap_mips->buffer[i],i,import_envmap_radiance);
	}
	buffer_t * radiance_pixels=gpu_get_texture_pixels(import_envmap_radiance);
	scene_world->_->irradiance=import_envmap_get_spherical_harmonics(radiance_pixels,import_envmap_radiance->width,import_envmap_radiance->height);
	scene_world->strength=1.0;
	scene_world->radiance_mipmaps=import_envmap_mips->length-2;
	scene_world->_->envmap=image;
	scene_world->envmap=string_copy(path);
	scene_world->_->radiance=import_envmap_radiance;
	scene_world->_->radiance_mipmaps=import_envmap_mips;
	context_raw->saved_envmap=image;
	if(context_raw->show_envmap_blur){
		scene_world->_->envmap=scene_world->_->radiance_mipmaps->buffer[0];
	}
	context_raw->ddirty=2;
	project_raw->envmap=string_copy(path);
}

void import_envmap_get_radiance_mip(gpu_texture_t * mip,i32 level,gpu_texture_t * radiance){
	_gpu_begin(mip,null,null,clear_flag_t_NONE,0,0.0);
	gpu_set_vertex_buffer(const_data_screen_aligned_vb);
	gpu_set_index_buffer(const_data_screen_aligned_ib);
	gpu_set_pipeline(import_envmap_pipeline);
	import_envmap_params.x=0.1+level/(float)8;
	import_envmap_params.y=1024*16;
	gpu_set_float4(import_envmap_params_loc,import_envmap_params.x,import_envmap_params.y,import_envmap_params.z,import_envmap_params.w);
	gpu_set_texture(import_envmap_radiance_loc,radiance);
	gpu_draw();
	gpu_end();
}

vec4_t import_envmap_reverse_equirect(f32 x,f32 y){
	f32 theta=x*math_pi()*2-math_pi();
	f32 phi=y*math_pi();
	import_envmap_n=vec4_create(-math_cos(phi),math_sin(phi)*math_cos(theta),-(math_sin(phi)*math_sin(theta)),1.0);
	return import_envmap_n;
}

f32_array_t * import_envmap_get_spherical_harmonics(buffer_t * source,i32 source_width,i32 source_height){
	f32_array_t * sh=f32_array_create(9*3+1);
	f32 accum=0.0;
	f32 weight=1.0;
	f32 weight1=weight*4/(float)17;
	f32 weight2=weight*8/(float)17;
	f32 weight3=weight*15/(float)17;
	f32 weight4=weight*5/(float)68;
	f32 weight5=weight*15/(float)68;
	for(i32 x=0;x<source_width;++x){
		for(i32 y=0;y<source_height;++y){
			import_envmap_n=import_envmap_reverse_equirect(x/(float)source_width,y/(float)source_height);
			for(i32 i=0;i<3;++i){
				f32 value=buffer_get_f32(source,((x+y*source_width)*16+i*4));
				value=math_pow(value,1.0/(float)2.2);
				sh->buffer[0+i]+=value*weight1;
				sh->buffer[3+i]+=value*weight2*import_envmap_n.x;
				sh->buffer[6+i]+=value*weight2*import_envmap_n.y;
				sh->buffer[9+i]+=value*weight2*import_envmap_n.z;
				sh->buffer[12+i]+=value*weight3*import_envmap_n.x*import_envmap_n.z;
				sh->buffer[15+i]+=value*weight3*import_envmap_n.z*import_envmap_n.y;
				sh->buffer[18+i]+=value*weight3*import_envmap_n.y*import_envmap_n.x;
				sh->buffer[21+i]+=value*weight4*(3.0*import_envmap_n.z*import_envmap_n.z-1.0);
				sh->buffer[24+i]+=value*weight5*(import_envmap_n.x*import_envmap_n.x-import_envmap_n.y*import_envmap_n.y);
				accum+=weight;
			}
		}
	}
	for(i32 i=0;i<sh->length;++i){
		sh->buffer[i]/=accum/(float)16;
	}
	return sh;
}

void import_folder_run(string_t * path){
	string_t_array_t * files=file_read_directory(path);
	string_t * mapbase="";
	string_t * mapopac="";
	string_t * mapnor="";
	string_t * mapocc="";
	string_t * maprough="";
	string_t * mapmet="";
	string_t * mapheight="";
	bool found_texture=false;
	for(i32 i=0;i<files->length;++i){
		string_t * f=files->buffer[i];
		if(!path_is_texture(f)){
			continue;
		}
		string_t * base=to_lower_case(substring(f,0,string_last_index_of(f,".")));
		bool valid=false;
		if(string_equals(mapbase,"")&&path_is_base_color_tex(base)){
			mapbase=string_copy(f);
			valid=true;
		}
		if(string_equals(mapopac,"")&&path_is_opacity_tex(base)){
			mapopac=string_copy(f);
			valid=true;
		}
		if(string_equals(mapnor,"")&&path_is_normal_map_tex(base)){
			mapnor=string_copy(f);
			valid=true;
		}
		if(string_equals(mapocc,"")&&path_is_occlusion_tex(base)){
			mapocc=string_copy(f);
			valid=true;
		}
		if(string_equals(maprough,"")&&path_is_roughness_tex(base)){
			maprough=string_copy(f);
			valid=true;
		}
		if(string_equals(mapmet,"")&&path_is_metallic_tex(base)){
			mapmet=string_copy(f);
			valid=true;
		}
		if(string_equals(mapheight,"")&&path_is_displacement_tex(base)){
			mapheight=string_copy(f);
			valid=true;
		}
		if(valid){
			import_texture_run(string_join(string_join(path,path_sep),f),false);
			found_texture=true;
		}
	}
	if(!found_texture){
		console_info(tr("Folder does not contain textures",null));
		return ;
	}
	context_raw->material=slot_material_create(project_materials->buffer[0]->data,null);
	any_array_push(project_materials,context_raw->material);
	ui_nodes_t * nodes=context_raw->material->nodes;
	ui_node_canvas_t * canvas=context_raw->material->canvas;
	string_t_array_t * dirs=string_split(path,path_sep);
	canvas->name=string_copy(dirs->buffer[dirs->length-1]);
	ui_node_t * nout=null;
	for(i32 i=0;i<canvas->nodes->length;++i){
		ui_node_t * n=canvas->nodes->buffer[i];
		if(string_equals(n->type,"OUTPUT_MATERIAL_PBR")){
			nout=n;
			break;
		}
	}
	for(i32 i=0;i<canvas->nodes->length;++i){
		ui_node_t * n=canvas->nodes->buffer[i];
		if(string_equals(n->name,"RGB")){
			ui_remove_node(n,canvas);
			break;
		}
	}
	i32 pos=0;
	i32 start_y=100;
	i32 node_h=164;
	if(!string_equals(mapbase,"")){
		import_folder_place_image_node(nodes,canvas,mapbase,start_y+node_h*pos,nout->id,0);
		pos++;
	}
	if(!string_equals(mapopac,"")){
		import_folder_place_image_node(nodes,canvas,mapopac,start_y+node_h*pos,nout->id,1);
		pos++;
	}
	if(!string_equals(mapocc,"")){
		import_folder_place_image_node(nodes,canvas,mapocc,start_y+node_h*pos,nout->id,2);
		pos++;
	}
	if(!string_equals(maprough,"")){
		import_folder_place_image_node(nodes,canvas,maprough,start_y+node_h*pos,nout->id,3);
		pos++;
	}
	if(!string_equals(mapmet,"")){
		import_folder_place_image_node(nodes,canvas,mapmet,start_y+node_h*pos,nout->id,4);
		pos++;
	}
	if(!string_equals(mapnor,"")){
		import_folder_place_image_node(nodes,canvas,mapnor,start_y+node_h*pos,nout->id,5);
		pos++;
	}
	if(!string_equals(mapheight,"")){
		import_folder_place_image_node(nodes,canvas,mapheight,start_y+node_h*pos,nout->id,7);
		pos++;
	}
	make_material_parse_paint_material(true);
	util_render_make_material_preview();
	ui_base_hwnds->buffer[1]->redraws=2;
	history_new_material();
}

void import_folder_place_image_node(ui_nodes_t * nodes,ui_node_canvas_t * canvas,string_t * asset,i32 ny,i32 to_id,i32 to_socket){
	ui_node_t * n=nodes_material_create_node("TEX_IMAGE",null);
	n->buttons->buffer[0]->default_value=f32_array_create_x(base_get_asset_index(asset));
	n->x=72;
	n->y=ny;
	ui_node_link_t * l=GC_ALLOC_INIT(ui_node_link_t, {.id=ui_next_link_id(canvas->links),.from_id=n->id,.from_socket=0,.to_id=to_id,.to_socket=to_socket});
	any_array_push(canvas->links,l);
}

void import_font_run(string_t * path){
	for(i32 i=0;i<project_fonts->length;++i){
		slot_font_t * f=project_fonts->buffer[i];
		if(string_equals(f->file,path)){
			console_info(strings_asset_already_imported());
			return ;
		}
	}
	draw_font_t * font=data_get_font(path);
	draw_font_init(font);
	i32 count=draw_font_count(font);
	slot_font_t_array_t * font_slots=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<count;++i){
		string_t_array_t * ar=string_split(path,path_sep);
		string_t * name=ar->buffer[ar->length-1];
		draw_font_t * f=GC_ALLOC_INIT(draw_font_t, {.buf=font->buf,.index=font->index});
		draw_font_init(f);
		if(!draw_set_font(f,util_render_font_preview_size)){
			console_error(tr("Error: Failed to read font data",null));
			continue;
		}
		slot_font_t * font_slot=slot_font_create(name,f,path);
		any_array_push(font_slots,font_slot);
	}
	sys_notify_on_init(&import_font_run_48472	,font_slots);
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
}

void import_font_run_48472(slot_font_t_array_t * font_slots){
for(i32 i=0;i<font_slots->length;++i){
		slot_font_t * f=font_slots->buffer[i];
		context_raw->font=f;
		any_array_push(project_fonts,f);
		util_render_make_font_preview();
	}
}

void import_keymap_run(string_t * path){
	if(!path_is_json(path)){
		console_error(strings_unknown_asset_format());
		return ;
	}
	string_t * filename=substring(path,string_last_index_of(path,path_sep)+1,string_length(path));
	string_t * dst_path=string_join(string_join(string_join(string_join(path_data(),path_sep),"keymap_presets"),path_sep),filename);
	file_copy(path,dst_path);
	box_preferences_fetch_keymaps();
	box_preferences_preset_handle->position=box_preferences_get_preset_index();
	console_info(string_join(string_join(tr("Keymap imported:",null)," "),filename));
}

void import_mesh_run(string_t * path,bool _clear_layers,bool replace_existing){
	if(!path_is_mesh(path)){
		if(!context_enable_import_plugin(path)){
			console_error(strings_unknown_asset_format());
			return ;
		}
	}
	import_mesh_clear_layers=_clear_layers;
	context_raw->layer_filter=0;
	gc_unroot(import_mesh_meshes_to_unwrap);import_mesh_meshes_to_unwrap=null;
	string_t * p=to_lower_case(path);
	if(ends_with(p,".obj")){
		import_obj_run(path,replace_existing);
	}
	else if(ends_with(p,".blend")){
		import_blend_mesh_run(path,replace_existing);
	}
	else {
		string_t * ext=substring(path,string_last_index_of(path,".")+1,string_length(path));
		any importer=any_map_get(path_mesh_importers,ext);
		raw_mesh_t * mesh=js_pcall_str(importer,path);
		if(string_equals(mesh->name,"")){
			mesh->name=string_copy(path_base_name(path));
		}
		replace_existing?import_mesh_make_mesh(mesh):import_mesh_add_mesh(mesh);
		bool has_next=mesh->has_next;
		while(has_next){
			raw_mesh_t * mesh=js_pcall_str(importer,path);
			if(string_equals(mesh->name,"")){
				mesh->name=string_copy(path_base_name(path));
			}
			has_next=mesh->has_next;
			import_mesh_add_mesh(mesh);
		}
	}
	gc_unroot(project_mesh_assets);project_mesh_assets=any_array_create_from_raw((any[]){path,},1);gc_root(project_mesh_assets);
}

void import_mesh_finish_import(){
	if(context_raw->merged_object!=null){
		mesh_data_delete(context_raw->merged_object->data);
		mesh_object_remove(context_raw->merged_object);
		context_raw->merged_object=null;
	}
	context_select_paint_object(context_main_object());
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		p->base->visible=true;
	}
	if(project_paint_objects->length>1){
		array_sort(project_paint_objects,&import_mesh_finish_import_48963		);
		if(context_raw->merged_object==null){
			util_mesh_merge(null);
		}
		context_raw->paint_object->skip_context="paint";
		context_raw->merged_object->base->visible=true;
	}
	viewport_scale_to_bounds();
	if(string_equals(context_raw->paint_object->base->name,"")){
		context_raw->paint_object->base->name="Object";
	}
	make_material_parse_paint_material(true);
	make_material_parse_mesh_material();
	ui_view2d_hwnd->redraws=2;
	render_path_raytrace_ready=false;
	context_raw->paint_body=null;
}

i32 import_mesh_finish_import_48963(any_ptr pa,any_ptr pb){
mesh_object_t * a=DEREFERENCE(pa);
		mesh_object_t * b=DEREFERENCE(pb);
		return strcmp(a->base->name,b->base->name);
}

void _import_mesh_make_mesh(raw_mesh_t * mesh){
	mesh_data_t * raw=import_mesh_raw_mesh(mesh);
	mesh_data_t * md=mesh_data_create(raw);
	context_raw->paint_object=context_main_object();
	context_select_paint_object(context_main_object());
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		if(p==context_raw->paint_object){
			continue;
		}
		data_delete_mesh(p->data->_->handle);
		mesh_object_remove(p);
	}
	string_t * handle=context_raw->paint_object->data->_->handle;
	if(!string_equals(handle,"SceneSphere")&&!string_equals(handle,"ScenePlane")){
		sys_notify_on_init(&_import_mesh_make_mesh_49173		,context_raw->paint_object->data);
	}
	mesh_object_set_data(context_raw->paint_object,md);
	context_raw->paint_object->base->name=mesh->name;
	gc_unroot(project_paint_objects);project_paint_objects=any_array_create_from_raw((any[]){context_raw->paint_object,},1);gc_root(project_paint_objects);
	md->_->handle=string_copy(raw->name);
	any_map_set(data_cached_meshes,md->_->handle,md);
	context_raw->ddirty=4;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	util_uv_uvmap_cached=false;
	util_uv_trianglemap_cached=false;
	util_uv_dilatemap_cached=false;
	if(import_mesh_clear_layers){
		while(project_layers->length>0){
			slot_layer_t * l=array_pop(project_layers);
			slot_layer_unload(l);
		}
		layers_new_layer(false,-1);
		sys_notify_on_init(layers_init,null);
		history_reset();
	}
	if(import_mesh_meshes_to_unwrap!=null){
		sys_notify_on_next_frame(import_mesh_finish_import,null);
	}
	else {
		sys_notify_on_init(import_mesh_finish_import,null);
	}
}

void _import_mesh_make_mesh_49173(mesh_data_t * md){
mesh_data_delete(md);
}

void import_mesh_first_unwrap_done(raw_mesh_t * mesh){
	_import_mesh_make_mesh(mesh);
	for(i32 i=0;i<import_mesh_meshes_to_unwrap->length;++i){
		raw_mesh_t * mesh=import_mesh_meshes_to_unwrap->buffer[i];
		project_unwrap_mesh_box(mesh,_import_mesh_add_mesh,true);
	}
}

void import_mesh_make_mesh(raw_mesh_t * mesh){
	if(mesh==null||mesh->posa==null||mesh->nora==null||mesh->inda==null||mesh->posa->length==0){
		console_error(strings_failed_to_read_mesh_data());
		return ;
	}
	if(mesh->texa==null){
		if(import_mesh_meshes_to_unwrap==null){
			gc_unroot(import_mesh_meshes_to_unwrap);import_mesh_meshes_to_unwrap=any_array_create_from_raw((any[]){},0);gc_root(import_mesh_meshes_to_unwrap);
		}
		project_unwrap_mesh_box(mesh,import_mesh_first_unwrap_done,false);
	}
	else {
		_import_mesh_make_mesh(mesh);
	}
}

bool _import_mesh_is_unique_name(string_t * s){
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		if(string_equals(p->base->name,s)){
			return false;
		}
	}
	return true;
}

string_t * _import_mesh_number_ext(i32 i){
	if(i<10){
		return string_join(".00",i32_to_string(i));
	}
	if(i<100){
		return string_join(".0",i32_to_string(i));
	}
	return string_join(".",i32_to_string(i));
}

void _import_mesh_add_mesh(raw_mesh_t * mesh){
	mesh_data_t * raw=import_mesh_raw_mesh(mesh);
	mesh_data_t * md=mesh_data_create(raw);
	mesh_object_t * object=scene_add_mesh_object(md,context_raw->paint_object->materials,context_raw->paint_object->base);
	object->base->name=mesh->name;
	object->skip_context="paint";
	string_t * oname=object->base->name;
	string_t * ext="";
	i32 i=0;
	while(!_import_mesh_is_unique_name(string_join(oname,ext))){
		ext=string_copy(_import_mesh_number_ext(++i));
	}
	object->base->name=string_join(object->base->name,ext);
	raw->name=string_join(raw->name,ext);
	any_array_push(project_paint_objects,object);
	md->_->handle=string_copy(raw->name);
	any_map_set(data_cached_meshes,md->_->handle,md);
	context_raw->ddirty=4;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	util_uv_uvmap_cached=false;
	util_uv_trianglemap_cached=false;
	util_uv_dilatemap_cached=false;
}

void import_mesh_add_mesh(raw_mesh_t * mesh){
	if(mesh->texa==null){
		if(import_mesh_meshes_to_unwrap!=null){
			any_array_push(import_mesh_meshes_to_unwrap,mesh);
		}
		else {
			project_unwrap_mesh_box(mesh,_import_mesh_add_mesh,false);
		}
	}
	else {
		_import_mesh_add_mesh(mesh);
	}
}

mesh_data_t * import_mesh_raw_mesh(raw_mesh_t * mesh){
	mesh_data_t * raw=GC_ALLOC_INIT(mesh_data_t, {.name=mesh->name,.vertex_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_array_t, {.values=mesh->posa,.attrib="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_array_t, {.values=mesh->nora,.attrib="nor",.data="short2norm"}),GC_ALLOC_INIT(vertex_array_t, {.values=mesh->texa,.attrib="tex",.data="short2norm"}),},3),.index_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(index_array_t, {.values=mesh->inda,.material=0}),},1),.scale_pos=mesh->scale_pos,.scale_tex=mesh->scale_tex});
	if(mesh->cola!=null){
		vertex_array_t * va=GC_ALLOC_INIT(vertex_array_t, {.values=mesh->cola,.attrib="col",.data="short4norm"});
		any_array_push(raw->vertex_arrays,va);
	}
	return raw;
}

void import_obj_run(string_t * path,bool replace_existing){
	split_type_t i=context_raw->split_by;
	bool is_udim=i==split_type_t_UDIM;
	i32 split_code=(i==split_type_t_OBJECT||is_udim)?char_code_at("o",0):i==split_type_t_GROUP?char_code_at("g",0):char_code_at("u",0);
	buffer_t * b=data_get_blob(path);
	if(is_udim){
		raw_mesh_t * part=obj_parse(b,split_code,0,is_udim);
		string_t * name=part->name;
		for(i32 i=0;i<part->udims->length;++i){
			u32_array_t * a=part->udims->buffer[i];
			if(a->length==0){
				continue;
			}
			i32 u=i%part->udims_u;
			i32 v=math_floor(i/(float)part->udims_u);
			i32 id=(1000+v*10+u+1);
			part->name=string_join(string_join(name,"."),i32_to_string(id));
			part->inda=a;
			if(i==0){
				if(replace_existing){
					import_mesh_make_mesh(part);
				}
				else {
					import_mesh_add_mesh(part);
				}
			}
			else {
				import_mesh_add_mesh(part);
			}
		}
	}
	else {
		raw_mesh_t_array_t * parts=any_array_create_from_raw((any[]){},0);
		raw_mesh_t * part=obj_parse(b,split_code,0,false);
		any_array_push(parts,part);
		while(part->has_next){
			part=obj_parse(b,split_code,part->pos,false);
			if(part->inda->length==0){
				continue;
			}
			any_array_push(parts,part);
		}
		if(context_raw->split_by==split_type_t_MATERIAL){
			i16_array_t * posa0;
			i16_array_t * posa1;
			i16_array_t * nora0;
			i16_array_t * nora1;
			i16_array_t * texa0;
			i16_array_t * texa1;
			u32_array_t * inda0;
			u32_array_t * inda1;
			for(i32 i=0;i<parts->length;++i){
				i32 j=i+1;
				while(j<parts->length){
					string_t * iname=parts->buffer[i]->name;
					string_t * jname=parts->buffer[j]->name;
					if(string_equals(iname,jname)){
						posa0=parts->buffer[i]->posa;
						posa1=parts->buffer[j]->posa;
						nora0=parts->buffer[i]->nora;
						nora1=parts->buffer[j]->nora;
						texa0=parts->buffer[i]->texa!=null?parts->buffer[i]->texa:null;
						texa1=parts->buffer[j]->texa!=null?parts->buffer[j]->texa:null;
						inda0=parts->buffer[i]->inda;
						inda1=parts->buffer[j]->inda;
						i32 voff=math_floor(posa0->length/(float)4);
						f32_array_t * posa32=f32_array_create(math_floor(posa0->length/(float)4)*3+math_floor(posa1->length/(float)4)*3);
						for(i32 k=0;k<math_floor(posa0->length/(float)4);++k){
							posa32->buffer[k*3]=posa0->buffer[k*4]/(float)32767*parts->buffer[i]->scale_pos;
							posa32->buffer[k*3+1]=posa0->buffer[k*4+1]/(float)32767*parts->buffer[i]->scale_pos;
							posa32->buffer[k*3+2]=posa0->buffer[k*4+2]/(float)32767*parts->buffer[i]->scale_pos;
						}
						for(i32 k=0;k<math_floor(posa1->length/(float)4);++k){
							posa32->buffer[voff*3+k*3]=posa1->buffer[k*4]/(float)32767*parts->buffer[j]->scale_pos;
							posa32->buffer[voff*3+k*3+1]=posa1->buffer[k*4+1]/(float)32767*parts->buffer[j]->scale_pos;
							posa32->buffer[voff*3+k*3+2]=posa1->buffer[k*4+2]/(float)32767*parts->buffer[j]->scale_pos;
						}
						f32 scale_pos=0.0;
						for(i32 k=0;k<posa32->length;++k){
							f32 f=math_abs(posa32->buffer[k]);
							if(scale_pos<f){
								scale_pos=f;
							}
						}
						f32 inv=32767*(1/(float)scale_pos);
						i16_array_t * posa=i16_array_create(posa0->length+posa1->length);
						for(i32 k=0;k<math_floor(posa->length/(float)4);++k){
							posa->buffer[k*4]=math_floor(posa32->buffer[k*3]*inv);
							posa->buffer[k*4+1]=math_floor(posa32->buffer[k*3+1]*inv);
							posa->buffer[k*4+2]=math_floor(posa32->buffer[k*3+2]*inv);
						}
						for(i32 k=0;k<math_floor(posa0->length/(float)4);++k){
							posa->buffer[k*4+3]=posa0->buffer[k*4+3];
						}
						for(i32 k=0;k<math_floor(posa1->length/(float)4);++k){
							posa->buffer[posa0->length+k*4+3]=posa1->buffer[k*4+3];
						}
						i16_array_t * nora=i16_array_create(nora0->length+nora1->length);
						i16_array_t * texa=(texa0!=null&&texa1!=null)?i16_array_create(texa0->length+texa1->length):null;
						u32_array_t * inda=u32_array_create(inda0->length+inda1->length);
						for(i32 k=0;k<nora0->length;++k){
							nora->buffer[k]=nora0->buffer[k];
						}
						for(i32 k=0;k<nora1->length;++k){
							nora->buffer[k+nora0->length]=nora1->buffer[k];
						}
						if(texa!=null){
							for(i32 k=0;k<texa0->length;++k){
								texa->buffer[k]=texa0->buffer[k];
							}
							for(i32 k=0;k<texa1->length;++k){
								texa->buffer[k+texa0->length]=texa1->buffer[k];
							}
						}
						for(i32 k=0;k<inda0->length;++k){
							inda->buffer[k]=inda0->buffer[k];
						}
						for(i32 k=0;k<inda1->length;++k){
							inda->buffer[k+inda0->length]=inda1->buffer[k]+voff;
						}
						parts->buffer[i]->posa=posa;
						parts->buffer[i]->nora=nora;
						parts->buffer[i]->texa=texa;
						parts->buffer[i]->inda=inda;
						parts->buffer[i]->scale_pos=scale_pos;
						array_splice(parts,j,1);
					}
					else {
						j++;
					}
				}
			}
		}
		replace_existing?import_mesh_make_mesh(parts->buffer[0]):import_mesh_add_mesh(parts->buffer[0]);
		for(i32 i=1;i<parts->length;++i){
			import_mesh_add_mesh(parts->buffer[i]);
		}
	}
	data_delete_blob(path);
}

void import_plugin_run(string_t * path){
	if(!path_is_plugin(path)){
		console_error(strings_unknown_asset_format());
		return ;
	}
	string_t * filename=substring(path,string_last_index_of(path,path_sep)+1,string_length(path));
	string_t * dst_path=string_join(string_join(string_join(string_join(path_data(),path_sep),"plugins"),path_sep),filename);
	file_copy(path,dst_path);
	gc_unroot(box_preferences_files_plugin);box_preferences_files_plugin=null;
	console_info(string_join(string_join(tr("Plugin imported:",null)," "),filename));
}

void import_texture_run(string_t * path,bool hdr_as_envmap){
	if(!path_is_texture(path)){
		if(!context_enable_import_plugin(path)){
			console_error(strings_unknown_asset_format());
			return ;
		}
	}
	for(i32 i=0;i<project_assets->length;++i){
		asset_t * a=project_assets->buffer[i];
		if(string_equals(a->file,path)){
			if(hdr_as_envmap&&ends_with(to_lower_case(path),".hdr")){
				gpu_texture_t * image=data_get_image(path);
				import_texture_data_t * itd=GC_ALLOC_INIT(import_texture_data_t, {.path=path,.image=image});
				sys_notify_on_next_frame(&import_texture_run_51398				,itd);
			}
			console_info(strings_asset_already_imported());
			return ;
		}
	}
	string_t * ext=substring(path,string_last_index_of(path,".")+1,string_length(path));
	any importer=any_map_get(path_texture_importers,ext);
	bool cached=any_map_get(data_cached_images,path)!=null;
	gpu_texture_t * image;
	if(importer==null||cached){
		image=import_texture_default_importer(path);
	}
	else {
		image=js_pcall_str(importer,path);
	}
	any_map_set(data_cached_images,path,image);
	string_t_array_t * ar=string_split(path,path_sep);
	string_t * name=ar->buffer[ar->length-1];
	asset_t * asset=GC_ALLOC_INIT(asset_t, {.name=name,.file=path,.id=project_asset_id++});
	any_array_push(project_assets,asset);
	if(context_raw->texture==null){
		context_raw->texture=asset;
	}
	any_array_push(project_asset_names,name);
	any_imap_set(project_asset_map,asset->id,image);
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
	console_info(string_join(string_join(tr("Texture imported:",null)," "),name));
	if(hdr_as_envmap&&ends_with(to_lower_case(path),".hdr")){
		import_texture_data_t * itd=GC_ALLOC_INIT(import_texture_data_t, {.path=path,.image=image});
		sys_notify_on_next_frame(&import_texture_run_51651		,itd);
	}
}

void import_texture_run_51651(import_texture_data_t * itd){
import_envmap_run(itd->path,itd->image);
}

void import_texture_run_51398(import_texture_data_t * itd){
import_envmap_run(itd->path,itd->image);
}

gpu_texture_t * import_texture_default_importer(string_t * path){
	return data_get_image(path);
}

void import_theme_run(string_t * path){
	if(!path_is_json(path)){
		console_error(strings_unknown_asset_format());
		return ;
	}
	string_t * filename=substring(path,string_last_index_of(path,path_sep)+1,string_length(path));
	string_t * dst_path=string_join(string_join(string_join(string_join(path_data(),path_sep),"themes"),path_sep),filename);
	file_copy(path,dst_path);
	box_preferences_fetch_themes();
	config_raw->theme=string_copy(filename);
	box_preferences_theme_handle->position=box_preferences_get_theme_index();
	config_load_theme(config_raw->theme,true);
	console_info(string_join(string_join(tr("Theme imported:",null)," "),filename));
}

void keymap_load(){
	gc_unroot(config_keymap);config_keymap=keymap_get_default();gc_root(config_keymap);
	if(!string_equals(config_raw->keymap,"default.json")){
		buffer_t * blob=data_get_blob(string_join("keymap_presets/",config_raw->keymap));
		any_map_t * new_keymap=json_parse_to_map(sys_buffer_to_string(blob));
		string_t_array_t * keys=map_keys(new_keymap);
		for(i32 i=0;i<keys->length;++i){
			string_t * key=keys->buffer[i];
			any_map_set(config_keymap,key,any_map_get(new_keymap,key));
		}
	}
}

void keymap_save(){
	if(string_equals(config_raw->keymap,"default.json")){
		return ;
	}
	string_t * path=string_join(string_join(data_path(),"keymap_presets/"),config_raw->keymap);
	buffer_t * buffer=sys_string_to_buffer(keymap_to_json(config_keymap));
	iron_file_save_bytes(path,buffer,0);
}

string_t * keymap_to_json(any_map_t * keymap){
	json_encode_begin();
	json_encode_map(keymap);
	return json_encode_end();
}

any_map_t * keymap_get_default(){
	any_map_t * keymap=any_map_create();
	any_map_set(keymap,"action_paint","left");
	any_map_set(keymap,"action_rotate","alt+left");
	any_map_set(keymap,"action_pan","alt+middle");
	any_map_set(keymap,"action_zoom","alt+right");
	any_map_set(keymap,"rotate_envmap","ctrl+middle");
	any_map_set(keymap,"set_clone_source","alt");
	any_map_set(keymap,"stencil_transform","ctrl");
	any_map_set(keymap,"stencil_hide","z");
	any_map_set(keymap,"brush_radius","f");
	any_map_set(keymap,"brush_radius_decrease","[");
	any_map_set(keymap,"brush_radius_increase","]");
	any_map_set(keymap,"brush_ruler","shift");
	any_map_set(keymap,"file_new","ctrl+n");
	any_map_set(keymap,"file_open","ctrl+o");
	any_map_set(keymap,"file_open_recent","ctrl+shift+o");
	any_map_set(keymap,"file_save","ctrl+s");
	any_map_set(keymap,"file_save_as","ctrl+shift+s");
	any_map_set(keymap,"file_reimport_mesh","ctrl+r");
	any_map_set(keymap,"file_reimport_textures","ctrl+shift+r");
	any_map_set(keymap,"file_import_assets","ctrl+i");
	any_map_set(keymap,"file_export_textures","ctrl+e");
	any_map_set(keymap,"file_export_textures_as","ctrl+shift+e");
	any_map_set(keymap,"edit_undo","ctrl+z");
	any_map_set(keymap,"edit_redo","ctrl+shift+z");
	any_map_set(keymap,"edit_prefs","ctrl+k");
	any_map_set(keymap,"view_reset","0");
	any_map_set(keymap,"view_front","1");
	any_map_set(keymap,"view_back","ctrl+1");
	any_map_set(keymap,"view_right","3");
	any_map_set(keymap,"view_left","ctrl+3");
	any_map_set(keymap,"view_top","7");
	any_map_set(keymap,"view_bottom","ctrl+7");
	any_map_set(keymap,"view_camera_type","5");
	any_map_set(keymap,"view_orbit_left","4");
	any_map_set(keymap,"view_orbit_right","6");
	any_map_set(keymap,"view_orbit_up","8");
	any_map_set(keymap,"view_orbit_down","2");
	any_map_set(keymap,"view_orbit_opposite","9");
	any_map_set(keymap,"view_zoom_in","");
	any_map_set(keymap,"view_zoom_out","");
	any_map_set(keymap,"view_distract_free","f11");
	any_map_set(keymap,"viewport_mode","ctrl+m");
	any_map_set(keymap,"toggle_node_editor","tab");
	any_map_set(keymap,"toggle_2d_view","shift+tab");
	any_map_set(keymap,"toggle_browser","`");
	any_map_set(keymap,"node_search","space");
	any_map_set(keymap,"operator_search","space");
	any_map_set(keymap,"decal_mask","ctrl");
	any_map_set(keymap,"select_material","shift+number");
	any_map_set(keymap,"select_layer","alt+number");
	any_map_set(keymap,"brush_opacity","shift+f");
	any_map_set(keymap,"brush_angle","alt+f");
	any_map_set(keymap,"tool_brush","b");
	any_map_set(keymap,"tool_eraser","e");
	any_map_set(keymap,"tool_fill","g");
	any_map_set(keymap,"tool_decal","d");
	any_map_set(keymap,"tool_text","t");
	any_map_set(keymap,"tool_clone","l");
	any_map_set(keymap,"tool_blur","u");
	any_map_set(keymap,"tool_smudge","m");
	any_map_set(keymap,"tool_particle","p");
	any_map_set(keymap,"tool_colorid","c");
	any_map_set(keymap,"tool_picker","v");
	any_map_set(keymap,"tool_bake","k");
	any_map_set(keymap,"tool_gizmo","");
	any_map_set(keymap,"tool_material","");
	any_map_set(keymap,"swap_brush_eraser","");
	return keymap;
}

void layers_init(){
	slot_layer_clear(project_layers->buffer[0],color_from_floats(layers_default_base,layers_default_base,layers_default_base,1.0),null,1.0,layers_default_rough,0.0);
}

void layers_resize(){
	config_t * conf=config_raw;
	if(base_res_handle->position>=math_floor(texture_res_t_RES16384)){
		conf->undo_steps=1;
		if(context_raw->undo_handle!=null){
			context_raw->undo_handle->value=conf->undo_steps;
		}
		while(history_undo_layers->length>conf->undo_steps){
			slot_layer_t * l=array_pop(history_undo_layers);
			sys_notify_on_next_frame(&layers_resize_52777			,l);
		}
	}
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		slot_layer_resize_and_set_bits(l);
	}
	for(i32 i=0;i<history_undo_layers->length;++i){
		slot_layer_t * l=history_undo_layers->buffer[i];
		slot_layer_resize_and_set_bits(l);
	}
	any_map_t * rts=render_path_render_targets;
	render_target_t * blend0=any_map_get(rts,"texpaint_blend0");
	gpu_texture_t * _texpaint_blend0=blend0->_image;
	iron_delete_texture(_texpaint_blend0);
	blend0->width=config_get_texture_res_x();
	blend0->height=config_get_texture_res_y();
	blend0->_image=gpu_create_render_target(config_get_texture_res_x(),config_get_texture_res_y(),tex_format_t_R8);
	render_target_t * blend1=any_map_get(rts,"texpaint_blend1");
	gpu_texture_t * _texpaint_blend1=blend1->_image;
	iron_delete_texture(_texpaint_blend1);
	blend1->width=config_get_texture_res_x();
	blend1->height=config_get_texture_res_y();
	blend1->_image=gpu_create_render_target(config_get_texture_res_x(),config_get_texture_res_y(),tex_format_t_R8);
	context_raw->brush_blend_dirty=true;
	render_target_t * blur=any_map_get(rts,"texpaint_blur");
	if(blur!=null){
		gpu_texture_t * _texpaint_blur=blur->_image;
		iron_delete_texture(_texpaint_blur);
		f32 size_x=math_floor(config_get_texture_res_x()*0.95);
		f32 size_y=math_floor(config_get_texture_res_y()*0.95);
		blur->width=size_x;
		blur->height=size_y;
		blur->_image=gpu_create_render_target(size_x,size_y,tex_format_t_RGBA32);
	}
	if(render_path_paint_live_layer!=null){
		slot_layer_resize_and_set_bits(render_path_paint_live_layer);
	}
	render_path_raytrace_ready=false;
	context_raw->ddirty=2;
}

void layers_resize_52777(slot_layer_t * l){
slot_layer_unload(l);
}

void layers_set_bits(){
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		slot_layer_resize_and_set_bits(l);
	}
	for(i32 i=0;i<history_undo_layers->length;++i){
		slot_layer_t * l=history_undo_layers->buffer[i];
		slot_layer_resize_and_set_bits(l);
	}
}

void layers_make_temp_img(){
	slot_layer_t * l=project_layers->buffer[0];
	if(layers_temp_image!=null&&(layers_temp_image->width!=l->texpaint->width||layers_temp_image->height!=l->texpaint->height||layers_temp_image->format!=l->texpaint->format)){
		render_target_t * _temptex0=any_map_get(render_path_render_targets,"temptex0");
		render_target_unload(_temptex0);
		map_delete(render_path_render_targets,"temptex0");
		gc_unroot(layers_temp_image);layers_temp_image=null;
	}
	if(layers_temp_image==null){
		string_t * format=base_bits_handle->position==texture_bits_t_BITS8?"RGBA32":base_bits_handle->position==texture_bits_t_BITS16?"RGBA64":"RGBA128";
		render_target_t * t=render_target_create();
		t->name="temptex0";
		t->width=l->texpaint->width;
		t->height=l->texpaint->height;
		t->format=string_copy(format);
		render_target_t * rt=render_path_create_render_target(t);
		gc_unroot(layers_temp_image);layers_temp_image=rt->_image;gc_root(layers_temp_image);
	}
}

void layers_make_temp_mask_img(){
	if(pipes_temp_mask_image!=null&&(pipes_temp_mask_image->width!=config_get_texture_res_x()||pipes_temp_mask_image->height!=config_get_texture_res_y())){
		gpu_texture_t * _temp_mask_image=pipes_temp_mask_image;
		iron_delete_texture(_temp_mask_image);
		gc_unroot(pipes_temp_mask_image);pipes_temp_mask_image=null;
	}
	if(pipes_temp_mask_image==null){
		gc_unroot(pipes_temp_mask_image);pipes_temp_mask_image=gpu_create_render_target(config_get_texture_res_x(),config_get_texture_res_y(),tex_format_t_R8);gc_root(pipes_temp_mask_image);
	}
}

void layers_make_export_img(){
	slot_layer_t * l=project_layers->buffer[0];
	if(layers_expa!=null&&(layers_expa->width!=l->texpaint->width||layers_expa->height!=l->texpaint->height||layers_expa->format!=l->texpaint->format)){
		gpu_texture_t * _expa=layers_expa;
		gpu_texture_t * _expb=layers_expb;
		gpu_texture_t * _expc=layers_expc;
		iron_delete_texture(_expa);
		iron_delete_texture(_expb);
		iron_delete_texture(_expc);
		gc_unroot(layers_expa);layers_expa=null;
		gc_unroot(layers_expb);layers_expb=null;
		gc_unroot(layers_expc);layers_expc=null;
		map_delete(render_path_render_targets,"expa");
		map_delete(render_path_render_targets,"expb");
		map_delete(render_path_render_targets,"expc");
	}
	if(layers_expa==null){
		string_t * format=base_bits_handle->position==texture_bits_t_BITS8?"RGBA32":base_bits_handle->position==texture_bits_t_BITS16?"RGBA64":"RGBA128";
			{
			render_target_t * t=render_target_create();
			t->name="expa";
			t->width=l->texpaint->width;
			t->height=l->texpaint->height;
			t->format=string_copy(format);
			render_target_t * rt=render_path_create_render_target(t);
			gc_unroot(layers_expa);layers_expa=rt->_image;gc_root(layers_expa);
		}
			{
			render_target_t * t=render_target_create();
			t->name="expb";
			t->width=l->texpaint->width;
			t->height=l->texpaint->height;
			t->format=string_copy(format);
			render_target_t * rt=render_path_create_render_target(t);
			gc_unroot(layers_expb);layers_expb=rt->_image;gc_root(layers_expb);
		}
			{
			render_target_t * t=render_target_create();
			t->name="expc";
			t->width=l->texpaint->width;
			t->height=l->texpaint->height;
			t->format=string_copy(format);
			render_target_t * rt=render_path_create_render_target(t);
			gc_unroot(layers_expc);layers_expc=rt->_image;gc_root(layers_expc);
		}
	}
}

void layers_apply_mask(slot_layer_t * l,slot_layer_t * m){
	if(!slot_layer_is_layer(l)||!slot_layer_is_mask(m)){
		return ;
	}
	layers_make_temp_img();
	draw_begin(layers_temp_image,false,0);
	draw_set_pipeline(pipes_copy);
	draw_image(l->texpaint,0,0);
	draw_set_pipeline(null);
	draw_end();
	_gpu_begin(l->texpaint,null,null,clear_flag_t_NONE,0,0.0);
	gpu_set_pipeline(pipes_apply_mask);
	gpu_set_texture(pipes_tex0_mask,layers_temp_image);
	gpu_set_texture(pipes_texa_mask,m->texpaint);
	gpu_set_vertex_buffer(const_data_screen_aligned_vb);
	gpu_set_index_buffer(const_data_screen_aligned_ib);
	gpu_draw();
	gpu_end();
}

void layers_commands_merge_pack(gpu_pipeline_t * pipe,gpu_texture_t * i0,gpu_texture_t * i1,gpu_texture_t * i1pack,f32 i1mask_opacity,gpu_texture_t * i1texmask,i32 i1blending){
	_gpu_begin(i0,null,null,clear_flag_t_NONE,0,0.0);
	gpu_set_pipeline(pipe);
	gpu_set_texture(pipes_tex0,i1);
	gpu_set_texture(pipes_tex1,i1pack);
	gpu_set_texture(pipes_texmask,i1texmask);
	gpu_set_texture(pipes_texa,layers_temp_image);
	gpu_set_float(pipes_opac,i1mask_opacity);
	gpu_set_float(pipes_tex1w,i1pack->width);
	gpu_set_int(pipes_blending,i1blending);
	gpu_set_vertex_buffer(const_data_screen_aligned_vb);
	gpu_set_index_buffer(const_data_screen_aligned_ib);
	gpu_draw();
	gpu_end();
}

bool layers_is_fill_material(){
	if(context_raw->tool==workspace_tool_t_MATERIAL){
		return true;
	}
	slot_material_t * m=context_raw->material;
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(l->fill_layer==m){
			return true;
		}
	}
	return false;
}

void layers_update_fill_layers(){
	slot_layer_t * _layer=context_raw->layer;
	workspace_tool_t _tool=context_raw->tool;
	i32 _fill_type=context_raw->fill_type_handle->position;
	gpu_texture_t * current=null;
	if(context_raw->tool==workspace_tool_t_MATERIAL){
		if(render_path_paint_live_layer==null){
			gc_unroot(render_path_paint_live_layer);render_path_paint_live_layer=slot_layer_create("_live",layer_slot_type_t_LAYER,null);gc_root(render_path_paint_live_layer);
		}
		current=_draw_current;
		if(current!=null)draw_end();
		context_raw->tool=workspace_tool_t_FILL;
		context_raw->fill_type_handle->position=fill_type_t_OBJECT;
		make_material_parse_paint_material(false);
		context_raw->pdirty=1;
		render_path_paint_use_live_layer(true);
		render_path_paint_commands_paint(false);
		render_path_paint_dilate(true,true);
		render_path_paint_use_live_layer(false);
		context_raw->tool=_tool;
		context_raw->fill_type_handle->position=_fill_type;
		context_raw->pdirty=0;
		context_raw->rdirty=2;
		if(current!=null)draw_begin(current,false,0);
		return ;
	}
	bool has_fill_layer=false;
	bool has_fill_mask=false;
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(slot_layer_is_layer(l)&&l->fill_layer==context_raw->material){
			has_fill_layer=true;
		}
	}
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(slot_layer_is_mask(l)&&l->fill_layer==context_raw->material){
			has_fill_mask=true;
		}
	}
	if(has_fill_layer||has_fill_mask){
		current=_draw_current;
		if(current!=null){
			draw_end();
		}
		context_raw->pdirty=1;
		context_raw->tool=workspace_tool_t_FILL;
		context_raw->fill_type_handle->position=fill_type_t_OBJECT;
		if(has_fill_layer){
			bool first=true;
			for(i32 i=0;i<project_layers->length;++i){
				slot_layer_t * l=project_layers->buffer[i];
				if(slot_layer_is_layer(l)&&l->fill_layer==context_raw->material){
					context_raw->layer=l;
					if(first){
						first=false;
						make_material_parse_paint_material(false);
					}
					layers_set_object_mask();
					slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
					render_path_paint_commands_paint(false);
					render_path_paint_dilate(true,true);
				}
			}
		}
		if(has_fill_mask){
			bool first=true;
			for(i32 i=0;i<project_layers->length;++i){
				slot_layer_t * l=project_layers->buffer[i];
				if(slot_layer_is_mask(l)&&l->fill_layer==context_raw->material){
					context_raw->layer=l;
					if(first){
						first=false;
						make_material_parse_paint_material(false);
					}
					layers_set_object_mask();
					slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
					render_path_paint_commands_paint(false);
					render_path_paint_dilate(true,true);
				}
			}
		}
		context_raw->pdirty=0;
		context_raw->ddirty=2;
		context_raw->rdirty=2;
		context_raw->layers_preview_dirty=true;
		if(current!=null)draw_begin(current,false,0);
		context_raw->layer=_layer;
		layers_set_object_mask();
		context_raw->tool=_tool;
		context_raw->fill_type_handle->position=_fill_type;
		make_material_parse_paint_material(false);
	}
}

void layers_update_fill_layer(bool parse_paint){
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	workspace_tool_t _tool=context_raw->tool;
	i32 _fill_type=context_raw->fill_type_handle->position;
	context_raw->tool=workspace_tool_t_FILL;
	context_raw->fill_type_handle->position=fill_type_t_OBJECT;
	context_raw->pdirty=1;
	slot_layer_clear(context_raw->layer,0x00000000,null,1.0,layers_default_rough,0.0);
	if(parse_paint){
		make_material_parse_paint_material(false);
	}
	render_path_paint_commands_paint(false);
	render_path_paint_dilate(true,true);
	context_raw->rdirty=2;
	context_raw->tool=_tool;
	context_raw->fill_type_handle->position=_fill_type;
	if(in_use)draw_begin(current,false,0);
}

void layers_set_object_mask(){
	string_t_array_t * ar=any_array_create_from_raw((any[]){tr("None",null),},1);
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		any_array_push(ar,p->base->name);
	}
	i32 mask=context_object_mask_used()?slot_layer_get_object_mask(context_raw->layer):0;
	if(context_layer_filter_used()){
		mask=context_raw->layer_filter;
	}
	if(mask>0){
		if(context_raw->merged_object!=null){
			context_raw->merged_object->base->visible=false;
		}
		mesh_object_t * o=project_paint_objects->buffer[0];
		for(i32 i=0;i<project_paint_objects->length;++i){
			mesh_object_t * p=project_paint_objects->buffer[i];
			string_t * mask_name=ar->buffer[mask];
			if(string_equals(p->base->name,mask_name)){
				o=p;
				break;
			}
		}
		context_select_paint_object(o);
	}
	else {
		bool is_atlas=slot_layer_get_object_mask(context_raw->layer)>0&&slot_layer_get_object_mask(context_raw->layer)<=project_paint_objects->length;
		if(context_raw->merged_object==null||is_atlas||context_raw->merged_object_is_atlas){
			mesh_object_t_array_t * visibles=is_atlas?project_get_atlas_objects(slot_layer_get_object_mask(context_raw->layer)):null;
			util_mesh_merge(visibles);
		}
		context_select_paint_object(context_main_object());
		context_raw->paint_object->skip_context="paint";
		context_raw->merged_object->base->visible=true;
	}
	util_uv_dilatemap_cached=false;
}

slot_layer_t * layers_new_layer(bool clear,i32 position){
	if(project_layers->length>layers_max_layers){
		return null;
	}
	slot_layer_t * l=slot_layer_create("",layer_slot_type_t_LAYER,null);
	l->object_mask=context_raw->layer_filter;
	if(position==-1){
		if(slot_layer_is_mask(context_raw->layer))context_set_layer(context_raw->layer->parent);
		array_insert(project_layers,array_index_of(project_layers,context_raw->layer)+1,l);
	}
	else {
		array_insert(project_layers,position,l);
	}
	context_set_layer(l);
	i32 li=array_index_of(project_layers,context_raw->layer);
	if(li>0){
		slot_layer_t * below=project_layers->buffer[li-1];
		if(slot_layer_is_layer(below)){
			context_raw->layer->parent=below->parent;
		}
	}
	if(clear){
		sys_notify_on_init(&layers_new_layer_54899		,l);
	}
	context_raw->layer_preview_dirty=true;
	return l;
}

void layers_new_layer_54899(slot_layer_t * l){
slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
}

slot_layer_t * layers_new_mask(bool clear,slot_layer_t * parent,i32 position){
	if(project_layers->length>layers_max_layers){
		return null;
	}
	slot_layer_t * l=slot_layer_create("",layer_slot_type_t_MASK,parent);
	if(position==-1){
		position=array_index_of(project_layers,parent);
	}
	array_insert(project_layers,position,l);
	context_set_layer(l);
	if(clear){
		sys_notify_on_init(&layers_new_mask_55010		,l);
	}
	context_raw->layer_preview_dirty=true;
	return l;
}

void layers_new_mask_55010(slot_layer_t * l){
slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
}

slot_layer_t * layers_new_group(){
	if(project_layers->length>layers_max_layers){
		return null;
	}
	slot_layer_t * l=slot_layer_create("",layer_slot_type_t_GROUP,null);
	any_array_push(project_layers,l);
	context_set_layer(l);
	return l;
}

void layers_create_fill_layer(uv_type_t uv_type,mat4_t decal_mat,i32 position){
	_layers_uv_type=uv_type;
	_layers_decal_mat=decal_mat;
	_layers_position=position;
	sys_notify_on_init(&layers_create_fill_layer_55118	,null);
}

void layers_create_fill_layer_55118(){
slot_layer_t * l=layers_new_layer(false,_layers_position);
	history_new_layer();
	l->uv_type=_layers_uv_type;
	if(!mat4_isnan(_layers_decal_mat)){
		l->decal_mat=_layers_decal_mat;
	}
	l->object_mask=context_raw->layer_filter;
	history_to_fill_layer();
	slot_layer_to_fill_layer(l);
}

void layers_create_image_mask(asset_t * asset){
	slot_layer_t * l=context_raw->layer;
	if(slot_layer_is_mask(l)||slot_layer_is_group(l)){
		return ;
	}
	history_new_layer();
	slot_layer_t * m=layers_new_mask(false,l,-1);
	slot_layer_clear(m,0x00000000,project_get_image(asset),1.0,layers_default_rough,0.0);
	context_raw->layer_preview_dirty=true;
}

void layers_create_color_layer(i32 base_color,f32 occlusion,f32 roughness,f32 metallic,i32 position){
	_layers_base_color=base_color;
	_layers_occlusion=occlusion;
	_layers_roughness=roughness;
	_layers_metallic=metallic;
	_layers_position=position;
	sys_notify_on_init(&layers_create_color_layer_55291	,null);
}

void layers_create_color_layer_55291(){
slot_layer_t * l=layers_new_layer(false,_layers_position);
	history_new_layer();
	l->uv_type=uv_type_t_UVMAP;
	l->object_mask=context_raw->layer_filter;
	slot_layer_clear(l,_layers_base_color,null,_layers_occlusion,_layers_roughness,_layers_metallic);
}

void layers_duplicate_layer(slot_layer_t * l){
	if(!slot_layer_is_group(l)){
		slot_layer_t * new_layer=slot_layer_duplicate(l);
		context_set_layer(new_layer);
		slot_layer_t_array_t * masks=slot_layer_get_masks(l,false);
		if(masks!=null){
			for(i32 i=0;i<masks->length;++i){
				slot_layer_t * m=masks->buffer[i];
				m=slot_layer_duplicate(m);
				m->parent=new_layer;
				array_remove(project_layers,m);
				array_insert(project_layers,array_index_of(project_layers,new_layer),m);
			}
		}
		context_set_layer(new_layer);
	}
	else {
		slot_layer_t * new_group=layers_new_group();
		array_remove(project_layers,new_group);
		array_insert(project_layers,array_index_of(project_layers,l)+1,new_group);
		for(i32 i=0;i<slot_layer_get_children(l)->length;++i){
			slot_layer_t * c=slot_layer_get_children(l)->buffer[i];
			slot_layer_t_array_t * masks=slot_layer_get_masks(c,false);
			slot_layer_t * new_layer=slot_layer_duplicate(c);
			new_layer->parent=new_group;
			array_remove(project_layers,new_layer);
			array_insert(project_layers,array_index_of(project_layers,new_group),new_layer);
			if(masks!=null){
				for(i32 i=0;i<masks->length;++i){
					slot_layer_t * m=masks->buffer[i];
					slot_layer_t * new_mask=slot_layer_duplicate(m);
					new_mask->parent=new_layer;
					array_remove(project_layers,new_mask);
					array_insert(project_layers,array_index_of(project_layers,new_layer),new_mask);
				}
			}
		}
		slot_layer_t_array_t * group_masks=slot_layer_get_masks(l,true);
		if(group_masks!=null){
			for(i32 i=0;i<group_masks->length;++i){
				slot_layer_t * m=group_masks->buffer[i];
				slot_layer_t * new_mask=slot_layer_duplicate(m);
				new_mask->parent=new_group;
				array_remove(project_layers,new_mask);
				array_insert(project_layers,array_index_of(project_layers,new_group),new_mask);
			}
		}
		context_set_layer(new_group);
	}
}

void layers_apply_masks(slot_layer_t * l){
	slot_layer_t_array_t * masks=slot_layer_get_masks(l,true);
	if(masks!=null){
		for(i32 i=0;i<masks->length-1;++i){
			layers_merge_layer(masks->buffer[i+1],masks->buffer[i],false);
			slot_layer_delete(masks->buffer[i]);
		}
		slot_layer_apply_mask(masks->buffer[masks->length-1]);
		context_raw->layer_preview_dirty=true;
	}
}

void layers_merge_down(){
	slot_layer_t * l1=context_raw->layer;
	if(slot_layer_is_group(l1)){
		l1=layers_merge_group(l1);
	}
	else if(slot_layer_has_masks(l1,true)){
		layers_apply_masks(l1);
		context_set_layer(l1);
	}
	slot_layer_t * l0=project_layers->buffer[array_index_of(project_layers,l1)-1];
	if(slot_layer_is_group(l0)){
		l0=layers_merge_group(l0);
	}
	else if(slot_layer_has_masks(l0,true)){
		layers_apply_masks(l0);
		context_set_layer(l0);
	}
	layers_merge_layer(l0,l1,false);
	slot_layer_delete(l1);
	context_set_layer(l0);
	context_raw->layer_preview_dirty=true;
}

slot_layer_t * layers_merge_group(slot_layer_t * l){
	if(!slot_layer_is_group(l)){
		return null;
	}
	slot_layer_t_array_t * children=slot_layer_get_children(l);
	if(children->length==1&&slot_layer_has_masks(children->buffer[0],false)){
		layers_apply_masks(children->buffer[0]);
	}
	for(i32 i=0;i<children->length-1;++i){
		context_set_layer(children->buffer[children->length-1-i]);
		history_merge_layers();
		layers_merge_down();
	}
	slot_layer_t_array_t * masks=slot_layer_get_masks(l,true);
	if(masks!=null){
		for(i32 i=0;i<masks->length-1;++i){
			layers_merge_layer(masks->buffer[i+1],masks->buffer[i],false);
			slot_layer_delete(masks->buffer[i]);
		}
		layers_apply_mask(children->buffer[0],masks->buffer[masks->length-1]);
	}
	children->buffer[0]->parent=null;
	children->buffer[0]->name=l->name;
	if(children->buffer[0]->fill_layer!=null){
		slot_layer_to_paint_layer(children->buffer[0]);
	}
	slot_layer_delete(l);
	return children->buffer[0];
}

void layers_merge_layer(slot_layer_t * l0,slot_layer_t * l1,bool use_mask){
	if(!l1->visible||slot_layer_is_group(l1)){
		return ;
	}
	layers_make_temp_img();
	draw_begin(layers_temp_image,false,0);
	draw_set_pipeline(pipes_copy);
	draw_image(l0->texpaint,0,0);
	draw_set_pipeline(null);
	draw_end();
	render_target_t * empty_rt=any_map_get(render_path_render_targets,"empty_white");
	gpu_texture_t * empty=empty_rt->_image;
	gpu_texture_t * mask=empty;
	slot_layer_t_array_t * l1masks=use_mask?slot_layer_get_masks(l1,true):null;
	if(l1masks!=null){
		mask=l1masks->buffer[0]->texpaint;
	}
	if(slot_layer_is_mask(l1)){
		_gpu_begin(l0->texpaint,null,null,clear_flag_t_NONE,0,0.0);
		gpu_set_pipeline(pipes_merge_mask);
		gpu_set_texture(pipes_tex0_merge_mask,l1->texpaint);
		gpu_set_texture(pipes_texa_merge_mask,layers_temp_image);
		gpu_set_float(pipes_opac_merge_mask,slot_layer_get_opacity(l1));
		gpu_set_int(pipes_blending_merge_mask,l1->blending);
		gpu_set_vertex_buffer(const_data_screen_aligned_vb);
		gpu_set_index_buffer(const_data_screen_aligned_ib);
		gpu_draw();
		gpu_end();
	}
	if(slot_layer_is_layer(l1)){
		if(l1->paint_base){
			_gpu_begin(l0->texpaint,null,null,clear_flag_t_NONE,0,0.0);
			gpu_set_pipeline(pipes_merge);
			gpu_set_texture(pipes_tex0,l1->texpaint);
			gpu_set_texture(pipes_tex1,empty);
			gpu_set_texture(pipes_texmask,mask);
			gpu_set_texture(pipes_texa,layers_temp_image);
			gpu_set_float(pipes_opac,slot_layer_get_opacity(l1));
			gpu_set_float(pipes_tex1w,empty->width);
			gpu_set_int(pipes_blending,l1->blending);
			gpu_set_vertex_buffer(const_data_screen_aligned_vb);
			gpu_set_index_buffer(const_data_screen_aligned_ib);
			gpu_draw();
			gpu_end();
		}
		if(l0->texpaint_nor!=null){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(l0->texpaint_nor,0,0);
			draw_set_pipeline(null);
			draw_end();
			if(l1->paint_nor){
				_gpu_begin(l0->texpaint_nor,null,null,clear_flag_t_NONE,0,0.0);
				gpu_set_pipeline(pipes_merge);
				gpu_set_texture(pipes_tex0,l1->texpaint);
				gpu_set_texture(pipes_tex1,l1->texpaint_nor);
				gpu_set_texture(pipes_texmask,mask);
				gpu_set_texture(pipes_texa,layers_temp_image);
				gpu_set_float(pipes_opac,slot_layer_get_opacity(l1));
				gpu_set_float(pipes_tex1w,l1->texpaint_nor->width);
				gpu_set_int(pipes_blending,l1->paint_nor_blend?102:101);
				gpu_set_vertex_buffer(const_data_screen_aligned_vb);
				gpu_set_index_buffer(const_data_screen_aligned_ib);
				gpu_draw();
				gpu_end();
			}
		}
		if(l0->texpaint_pack!=null){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(l0->texpaint_pack,0,0);
			draw_set_pipeline(null);
			draw_end();
			if(l1->paint_occ||l1->paint_rough||l1->paint_met||l1->paint_height){
				if(l1->paint_occ&&l1->paint_rough&&l1->paint_met&&l1->paint_height){
					layers_commands_merge_pack(pipes_merge,l0->texpaint_pack,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,l1->paint_height_blend?103:101);
				}
				else {
					if(l1->paint_occ){
						layers_commands_merge_pack(pipes_merge_r,l0->texpaint_pack,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
					}
					if(l1->paint_rough){
						layers_commands_merge_pack(pipes_merge_g,l0->texpaint_pack,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
					}
					if(l1->paint_met){
						layers_commands_merge_pack(pipes_merge_b,l0->texpaint_pack,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
					}
				}
			}
		}
	}
}

slot_layer_t * layers_flatten(bool height_to_normal,slot_layer_t_array_t * layers){
	return layers_ext_flatten(height_to_normal,layers);
}

void layers_on_resized(){
	layers_ext_on_resized();
}

void line_draw_init(){
	if(line_draw_pipeline==null){
		gpu_vertex_structure_t * structure=gpu_vertex_struct_create();
		gpu_vertex_struct_add(structure,"pos",vertex_data_t_F32_3X);
		gc_unroot(line_draw_pipeline);line_draw_pipeline=gpu_create_pipeline();gc_root(line_draw_pipeline);
		line_draw_pipeline->input_layout=structure;
		line_draw_pipeline->fragment_shader=sys_get_shader("line.frag");
		line_draw_pipeline->vertex_shader=sys_get_shader("line.vert");
		line_draw_pipeline->depth_write=true;
		line_draw_pipeline->depth_mode=compare_mode_t_LESS;
		line_draw_pipeline->cull_mode=cull_mode_t_NONE;
		line_draw_pipeline->color_attachment_count=2;
		ARRAY_ACCESS(line_draw_pipeline->color_attachment,0)=tex_format_t_RGBA64;
		ARRAY_ACCESS(line_draw_pipeline->color_attachment,1)=tex_format_t_RGBA64;
		line_draw_pipeline->depth_attachment_bits=32;
		gpu_pipeline_compile(line_draw_pipeline);
		pipes_offset=0;
		line_draw_vp_loc=pipes_get_constant_location("mat4");
		line_draw_color_loc=pipes_get_constant_location("vec3");
		line_draw_vp=mat4_identity();
		gc_unroot(line_draw_vertex_buffer);line_draw_vertex_buffer=gpu_create_vertex_buffer(line_draw_max_vertices,structure);gc_root(line_draw_vertex_buffer);
		gc_unroot(line_draw_index_buffer);line_draw_index_buffer=gpu_create_index_buffer(line_draw_max_indices);gc_root(line_draw_index_buffer);
	}
	if(line_draw_overlay_pipeline==null){
		gpu_vertex_structure_t * structure=gpu_vertex_struct_create();
		gpu_vertex_struct_add(structure,"pos",vertex_data_t_F32_3X);
		gc_unroot(line_draw_overlay_pipeline);line_draw_overlay_pipeline=gpu_create_pipeline();gc_root(line_draw_overlay_pipeline);
		line_draw_overlay_pipeline->input_layout=structure;
		line_draw_overlay_pipeline->fragment_shader=sys_get_shader("line_overlay.frag");
		line_draw_overlay_pipeline->vertex_shader=sys_get_shader("line_overlay.vert");
		line_draw_overlay_pipeline->depth_write=false;
		line_draw_overlay_pipeline->depth_mode=compare_mode_t_ALWAYS;
		line_draw_overlay_pipeline->cull_mode=cull_mode_t_NONE;
		line_draw_overlay_pipeline->color_attachment_count=1;
		ARRAY_ACCESS(line_draw_overlay_pipeline->color_attachment,0)=tex_format_t_RGBA64;
		gpu_pipeline_compile(line_draw_overlay_pipeline);
	}
}

void line_draw_render(mat4_t matrix){
	line_draw_mat=matrix;
	line_draw_dim=mat4_get_scale(matrix);
	line_draw_begin();
	line_draw_bounds(line_draw_mat,line_draw_dim);
	line_draw_end();
}

void line_draw_bounds(mat4_t mat,vec4_t dim){
	line_draw_wpos=mat4_get_loc(mat);
	f32 dx=dim.x/(float)2;
	f32 dy=dim.y/(float)2;
	f32 dz=dim.z/(float)2;
	vec4_t up=mat4_up(mat);
	vec4_t look=mat4_look(mat);
	vec4_t right=mat4_right(mat);
	up=vec4_norm(up);
	look=vec4_norm(look);
	right=vec4_norm(right);
	line_draw_vx=vec4_clone(right);
	line_draw_vx=vec4_mult(line_draw_vx,dx);
	line_draw_vy=vec4_clone(look);
	line_draw_vy=vec4_mult(line_draw_vy,dy);
	line_draw_vz=vec4_clone(up);
	line_draw_vz=vec4_mult(line_draw_vz,dz);
	line_draw_lineb(-1,-1,-1,1,-1,-1);
	line_draw_lineb(-1,1,-1,1,1,-1);
	line_draw_lineb(-1,-1,1,1,-1,1);
	line_draw_lineb(-1,1,1,1,1,1);
	line_draw_lineb(-1,-1,-1,-1,1,-1);
	line_draw_lineb(-1,-1,1,-1,1,1);
	line_draw_lineb(1,-1,-1,1,1,-1);
	line_draw_lineb(1,-1,1,1,1,1);
	line_draw_lineb(-1,-1,-1,-1,-1,1);
	line_draw_lineb(-1,1,-1,-1,1,1);
	line_draw_lineb(1,-1,-1,1,-1,1);
	line_draw_lineb(1,1,-1,1,1,1);
}

void line_draw_lineb(i32 a,i32 b,i32 c,i32 d,i32 e,i32 f){
	line_draw_v1=vec4_clone(line_draw_wpos);
	line_draw_t=vec4_clone(line_draw_vx);
	line_draw_t=vec4_mult(line_draw_t,a);
	line_draw_v1=vec4_add(line_draw_v1,line_draw_t);
	line_draw_t=vec4_clone(line_draw_vy);
	line_draw_t=vec4_mult(line_draw_t,b);
	line_draw_v1=vec4_add(line_draw_v1,line_draw_t);
	line_draw_t=vec4_clone(line_draw_vz);
	line_draw_t=vec4_mult(line_draw_t,c);
	line_draw_v1=vec4_add(line_draw_v1,line_draw_t);
	line_draw_v2=vec4_clone(line_draw_wpos);
	line_draw_t=vec4_clone(line_draw_vx);
	line_draw_t=vec4_mult(line_draw_t,d);
	line_draw_v2=vec4_add(line_draw_v2,line_draw_t);
	line_draw_t=vec4_clone(line_draw_vy);
	line_draw_t=vec4_mult(line_draw_t,e);
	line_draw_v2=vec4_add(line_draw_v2,line_draw_t);
	line_draw_t=vec4_clone(line_draw_vz);
	line_draw_t=vec4_mult(line_draw_t,f);
	line_draw_v2=vec4_add(line_draw_v2,line_draw_t);
	line_draw_line(line_draw_v1.x,line_draw_v1.y,line_draw_v1.z,line_draw_v2.x,line_draw_v2.y,line_draw_v2.z);
}

void line_draw_line(f32 x1,f32 y1,f32 z1,f32 x2,f32 y2,f32 z2){
	if(line_draw_lines>=line_draw_max_lines){
		line_draw_end();
		line_draw_begin();
	}
	line_draw_mid_point=vec4_create(x1+x2,y1+y2,z1+z2,1.0);
	line_draw_mid_point=vec4_mult(line_draw_mid_point,0.5);
	line_draw_mid_line=vec4_create(x1,y1,z1,1.0);
	line_draw_mid_line=vec4_sub(line_draw_mid_line,line_draw_mid_point);
	camera_object_t * camera=scene_camera;
	line_draw_camera_look=mat4_get_loc(camera->base->transform->world);
	line_draw_camera_look=vec4_sub(line_draw_camera_look,line_draw_mid_point);
	vec4_t line_width=vec4_cross(line_draw_camera_look,line_draw_mid_line);
	line_width=vec4_norm(line_width);
	line_width=vec4_mult(line_width,line_draw_strength);
	line_draw_corner1=vec4_create(x1,y1,z1,1.0);
	line_draw_corner1=vec4_add(line_draw_corner1,line_width);
	line_draw_corner2=vec4_create(x1,y1,z1,1.0);
	line_draw_corner2=vec4_sub(line_draw_corner2,line_width);
	line_draw_corner3=vec4_create(x2,y2,z2,1.0);
	line_draw_corner3=vec4_sub(line_draw_corner3,line_width);
	line_draw_corner4=vec4_create(x2,y2,z2,1.0);
	line_draw_corner4=vec4_add(line_draw_corner4,line_width);
	i32 i=line_draw_lines*12;
	buffer_set_f32(line_draw_vb_data,(i+0)*4,line_draw_corner1.x);
	buffer_set_f32(line_draw_vb_data,(i+1)*4,line_draw_corner1.y);
	buffer_set_f32(line_draw_vb_data,(i+2)*4,line_draw_corner1.z);
	i+=3;
	buffer_set_f32(line_draw_vb_data,(i+0)*4,line_draw_corner2.x);
	buffer_set_f32(line_draw_vb_data,(i+1)*4,line_draw_corner2.y);
	buffer_set_f32(line_draw_vb_data,(i+2)*4,line_draw_corner2.z);
	i+=3;
	buffer_set_f32(line_draw_vb_data,(i+0)*4,line_draw_corner3.x);
	buffer_set_f32(line_draw_vb_data,(i+1)*4,line_draw_corner3.y);
	buffer_set_f32(line_draw_vb_data,(i+2)*4,line_draw_corner3.z);
	i+=3;
	buffer_set_f32(line_draw_vb_data,(i+0)*4,line_draw_corner4.x);
	buffer_set_f32(line_draw_vb_data,(i+1)*4,line_draw_corner4.y);
	buffer_set_f32(line_draw_vb_data,(i+2)*4,line_draw_corner4.z);
	i=line_draw_lines*6;
	line_draw_ib_data->buffer[i]=line_draw_lines*4;
	line_draw_ib_data->buffer[i+1]=line_draw_lines*4+1;
	line_draw_ib_data->buffer[i+2]=line_draw_lines*4+2;
	line_draw_ib_data->buffer[i+3]=line_draw_lines*4+2;
	line_draw_ib_data->buffer[i+4]=line_draw_lines*4+3;
	line_draw_ib_data->buffer[i+5]=line_draw_lines*4;
	line_draw_lines++;
}

void line_draw_begin(){
	line_draw_init();
	line_draw_lines=0;
	gc_unroot(line_draw_vb_data);line_draw_vb_data=gpu_lock_vertex_buffer(line_draw_vertex_buffer);gc_root(line_draw_vb_data);
	gc_unroot(line_draw_ib_data);line_draw_ib_data=gpu_lock_index_buffer(line_draw_index_buffer);gc_root(line_draw_ib_data);
	for(i32 i=0;i<line_draw_max_indices;++i){
		line_draw_ib_data->buffer[i]=0;
	}
}

void line_draw_end(){
	gpu_vertex_buffer_unlock(line_draw_vertex_buffer);
	gpu_index_buffer_unlock(line_draw_index_buffer);
	gpu_set_vertex_buffer(line_draw_vertex_buffer);
	gpu_set_index_buffer(line_draw_index_buffer);
	gpu_set_pipeline(line_draw_pipeline);
	camera_object_t * camera=scene_camera;
	line_draw_vp=mat4_clone(camera->v);
	line_draw_vp=mat4_mult_mat(line_draw_vp,camera->p);
	gpu_set_matrix4(line_draw_vp_loc,line_draw_vp);
	gpu_set_float3(line_draw_color_loc,color_get_rb(line_draw_color)/(float)255,color_get_gb(line_draw_color)/(float)255,color_get_bb(line_draw_color)/(float)255);
	gpu_draw();
}

void shape_draw_sphere(mat4_t mat){
	line_draw_init();
	if(_shape_draw_sphere_vb==null){
		mesh_object_t * sphere=scene_get_child(".Sphere")->ext;
		mesh_data_t * md=sphere->data;
		i16_array_t * posa=md->vertex_arrays->buffer[0]->values;
		gpu_vertex_structure_t * structure=gpu_vertex_struct_create();
		gpu_vertex_struct_add(structure,"pos",vertex_data_t_F32_3X);
		gc_unroot(_shape_draw_sphere_vb);_shape_draw_sphere_vb=gpu_create_vertex_buffer(posa->length,structure);gc_root(_shape_draw_sphere_vb);
		buffer_t * data=gpu_lock_vertex_buffer(_shape_draw_sphere_vb);
		for(i32 i=0;i<posa->length/(float)4;++i){
			buffer_set_f32(data,(i*3+0)*4,posa->buffer[i*4+0]/(float)32767);
			buffer_set_f32(data,(i*3+1)*4,posa->buffer[i*4+1]/(float)32767);
			buffer_set_f32(data,(i*3+2)*4,posa->buffer[i*4+2]/(float)32767);
		}
		gpu_vertex_buffer_unlock(_shape_draw_sphere_vb);
		gc_unroot(_shape_draw_sphere_ib);_shape_draw_sphere_ib=md->_->index_buffers->buffer[0];gc_root(_shape_draw_sphere_ib);
	}
	gpu_set_vertex_buffer(_shape_draw_sphere_vb);
	gpu_set_index_buffer(_shape_draw_sphere_ib);
	gpu_set_pipeline(line_draw_overlay_pipeline);
	camera_object_t * camera=scene_camera;
	line_draw_vp=mat4_clone(mat);
	f32 f=line_draw_strength*50;
	line_draw_vp=mat4_scale(line_draw_vp,vec4_create(f,f,f,1.0));
	line_draw_vp=mat4_mult_mat(line_draw_vp,camera->v);
	line_draw_vp=mat4_mult_mat(line_draw_vp,camera->p);
	gpu_set_matrix4(line_draw_vp_loc,line_draw_vp);
	gpu_set_float3(line_draw_color_loc,color_get_rb(line_draw_color)/(float)255,color_get_gb(line_draw_color)/(float)255,color_get_bb(line_draw_color)/(float)255);
	gpu_draw();
}

logic_node_t * logic_node_create(logic_node_ext_t * ext){
	logic_node_t * n=GC_ALLOC_INIT(logic_node_t, {0});
	n->inputs=any_array_create_from_raw((any[]){},0);
	n->outputs=any_array_create_from_raw((any[]){},0);
	n->ext=ext;
	return n;
}

void logic_node_add_input(logic_node_t * self,logic_node_ext_t * node,i32 from){
	any_array_push(self->inputs,logic_node_input_create(node,from));
}

void logic_node_add_outputs(logic_node_t * self,logic_node_t_array_t * nodes){
	any_array_push(self->outputs,nodes);
}

any logic_node_get(logic_node_t * self,i32 from){
	if(self->get!=null){
		return self->get(self->ext,from);
	}
	return null;
}

gpu_texture_t * logic_node_get_as_image(logic_node_t * self,i32 from){
	if(self->get_as_image!=null){
		return self->get_as_image(self->ext,from);
	}
	return null;
}

gpu_texture_t * logic_node_get_cached_image(logic_node_t * self){
	if(self->get_cached_image!=null){
		return self->get_cached_image(self->ext);
	}
	return null;
}

void logic_node_set(logic_node_t * self,any value){
	if(self->set!=null){
		self->set(self->ext,value);
	}
}

logic_node_input_t * logic_node_input_create(logic_node_ext_t * node,i32 from){
	logic_node_input_t * inp=GC_ALLOC_INIT(logic_node_input_t, {0});
	inp->node=node;
	inp->from=from;
	return inp;
}

logic_node_value_t * logic_node_input_get(logic_node_input_t * self){
	return logic_node_get(self->node->base,self->from);
}

gpu_texture_t * logic_node_input_get_as_image(logic_node_input_t * self){
	return logic_node_get_as_image(self->node->base,self->from);
}

void logic_node_input_set(logic_node_input_t * self,f32_array_t * value){
	logic_node_set(self->node->base,value);
}

void nodes_material_init(){
	any_map_set(ui_nodes_custom_buttons,"nodes_material_vector_curves_button",nodes_material_vector_curves_button);
	any_map_set(ui_nodes_custom_buttons,"nodes_material_color_ramp_button",nodes_material_color_ramp_button);
	any_map_set(ui_nodes_custom_buttons,"nodes_material_new_group_button",nodes_material_new_group_button);
	any_map_set(ui_nodes_custom_buttons,"nodes_material_group_input_button",nodes_material_group_input_button);
	any_map_set(ui_nodes_custom_buttons,"nodes_material_group_output_button",nodes_material_group_output_button);
}

void nodes_material_vector_curves_button(i32 node_id){
	ui_t * ui=ui_nodes_ui;
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	ui_node_t * node=ui_get_node(ui_nodes_get_canvas(true)->nodes,node_id);
	ui_node_button_t * but=node->buttons->buffer[0];
	ui_handle_t * nhandle=ui_nest(ui_handle("nodes_material.ts:3992"),node->id);
	ui_row3();
	ui_radio(ui_nest(ui_nest(nhandle,0),1),0,"X","");
	ui_radio(ui_nest(ui_nest(nhandle,0),1),1,"Y","");
	ui_radio(ui_nest(ui_nest(nhandle,0),1),2,"Z","");
	i32 axis=ui_nest(ui_nest(nhandle,0),1)->position;
	f32_array_t * val=but->default_value;
	ui->_y+=UI_LINE_H()*5;
	i32 num=val->buffer[96+axis];
	if(num==0){
		val->buffer[96+0]=1;
		val->buffer[96+1]=1;
		val->buffer[96+2]=1;
	}
	f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)5,1/(float)5,3/(float)5,},3);
	ui_row(row);
	if(ui_button("+",ui_align_t_CENTER,"")){
		val->buffer[axis*32+num*2+0]=0.0;
		val->buffer[axis*32+num*2+1]=0.0;
		num++;
		val->buffer[96+axis]=num;
	}
	if(ui_button("-",ui_align_t_CENTER,"")){
		if(num>1){
			num--;
			val->buffer[96+axis]=num;
		}
	}
	ui_handle_t * ihandle=ui_nest(ui_nest(ui_nest(nhandle,0),2),axis);
	if(ihandle->init){
		ihandle->position=0;
	}
	i32 i=math_floor(ui_slider(ihandle,"Index",0,num-1,false,1,true,ui_align_t_LEFT,true));
	if(i>=num||i<0){
		ihandle->value=i=num-1;
	}
	ui_row2();
	ui_nest(ui_nest(nhandle,0),3)->value=val->buffer[axis*32+i*2+0];
	ui_nest(ui_nest(nhandle,0),4)->value=val->buffer[axis*32+i*2+1];
	ui_handle_t * h1=ui_nest(ui_nest(nhandle,0),3);
	if(h1->init){
		h1->value=0.0;
	}
	ui_handle_t * h2=ui_nest(ui_nest(nhandle,0),4);
	if(h2->init){
		h2->value=0.0;
	}
	val->buffer[axis*32+i*2+0]=ui_slider(h1,"X",-1,1,true,100,true,ui_align_t_LEFT,true);
	val->buffer[axis*32+i*2+1]=ui_slider(h2,"Y",-1,1,true,100,true,ui_align_t_LEFT,true);
}

void nodes_material_color_ramp_button(i32 node_id){
	ui_t * ui=ui_nodes_ui;
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	ui_node_t * node=ui_get_node(ui_nodes_get_canvas(true)->nodes,node_id);
	ui_node_button_t * but=node->buttons->buffer[0];
	ui_handle_t * nhandle=ui_nest(ui_handle("nodes_material.ts:4060"),node->id);
	f32 nx=ui->_x;
	f32 ny=ui->_y;
	f32_array_t * vals=but->default_value;
	f32 sw=ui->_w/(float)UI_NODES_SCALE();
	for(i32 i=0;i<vals->length/(float)5;++i){
		f32 pos=vals->buffer[i*5+4];
		i32 col=color_from_floats(vals->buffer[i*5+0],vals->buffer[i*5+1],vals->buffer[i*5+2],1.0);
		ui_fill(pos*sw,0,(1.0-pos)*sw,UI_LINE_H()-2*UI_NODES_SCALE(),col);
	}
	ui->_y+=UI_LINE_H();
	ui_handle_t * ihandle=ui_nest(ui_nest(nhandle,0),2);
	f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,2/(float)4,},3);
	ui_row(row);
	if(ui_button("+",ui_align_t_CENTER,"")){
		f32_array_push(vals,vals->buffer[vals->length-5]);
		f32_array_push(vals,vals->buffer[vals->length-5]);
		f32_array_push(vals,vals->buffer[vals->length-5]);
		f32_array_push(vals,vals->buffer[vals->length-5]);
		f32_array_push(vals,1.0);
		ihandle->value+=1;
	}
	if(ui_button("-",ui_align_t_CENTER,"")&&vals->length>5){
		array_pop(vals);
		array_pop(vals);
		array_pop(vals);
		array_pop(vals);
		array_pop(vals);
		ihandle->value-=1;
	}
	ui_handle_t * h=ui_nest(ui_nest(nhandle,0),1);
	if(h->init){
		h->position=but->data->buffer[0];
	}
	string_t_array_t * interpolate_combo=any_array_create_from_raw((any[]){tr("Linear",null),tr("Constant",null),},2);
	but->data->buffer[0]=ui_combo(h,interpolate_combo,tr("Interpolate",null),false,ui_align_t_LEFT,true);
	ui_row2();
	i32 i=math_floor(ui_slider(ihandle,"Index",0,(vals->length/(float)5)-1,false,1,true,ui_align_t_LEFT,true));
	if(i>=(vals->length*5)||i<0){
		ihandle->value=i=(vals->length/(float)5)-1;
	}
	ui_nest(ui_nest(nhandle,0),3)->value=vals->buffer[i*5+4];
	vals->buffer[i*5+4]=ui_slider(ui_nest(ui_nest(nhandle,0),3),"Pos",0,1,true,100,true,ui_align_t_LEFT,true);
	if(vals->buffer[i*5+4]>1.0){
		vals->buffer[i*5+4]=1.0;
	}
	else if(vals->buffer[i*5+4]<0.0){
		vals->buffer[i*5+4]=0.0;
	}
	ui_handle_t * chandle=ui_nest(ui_nest(nhandle,0),4);
	chandle->color=color_from_floats(vals->buffer[i*5+0],vals->buffer[i*5+1],vals->buffer[i*5+2],1.0);
	if(ui_text("",ui_align_t_RIGHT,chandle->color)==ui_state_t_STARTED){
		f32 rx=nx+ui->_w-ui_p(37);
		f32 ry=ny-ui_p(5);
		nodes->_input_started=ui->input_started=false;
		ui_nodes_rgba_popup(chandle,vals->buffer+i*5,math_floor(rx),math_floor(ry+ui_ELEMENT_H(ui)));
	}
	vals->buffer[i*5+0]=color_get_rb(chandle->color)/(float)255;
	vals->buffer[i*5+1]=color_get_gb(chandle->color)/(float)255;
	vals->buffer[i*5+2]=color_get_bb(chandle->color)/(float)255;
}

void nodes_material_new_group_button(i32 node_id){
	ui_t * ui=ui_nodes_ui;
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	ui_node_t * node=ui_get_node(ui_nodes_get_canvas(true)->nodes,node_id);
	if(string_equals(node->name,"New Group")){
		for(i32 i=1;i<999;++i){
			node->name=string_join(string_join(tr("Group",null)," "),i32_to_string(i));
			bool found=false;
			for(i32 i=0;i<project_material_groups->length;++i){
				node_group_t * g=project_material_groups->buffer[i];
				string_t * cname=g->canvas->name;
				if(string_equals(cname,node->name)){
					found=true;
					break;
				}
			}
			if(!found){
				break;
			}
		}
		ui_node_canvas_t * canvas=GC_ALLOC_INIT(ui_node_canvas_t, {.name=node->name,.nodes=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_t, {.id=0,.name=_tr("Group Input"),.type="GROUP_INPUT",.x=50,.y=200,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){},0),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name="nodes_material_group_input_button",.type="CUSTOM",.height=1}),},1)}),GC_ALLOC_INIT(ui_node_t, {.id=1,.name=_tr("Group Output"),.type="GROUP_OUTPUT",.x=450,.y=200,.color=0xff448c6d,.inputs=any_array_create_from_raw((any[]){},0),.outputs=any_array_create_from_raw((any[]){},0),.buttons=any_array_create_from_raw((any[]){GC_ALLOC_INIT(ui_node_button_t, {.name="nodes_material_group_output_button",.type="CUSTOM",.height=1}),},1)}),},2),.links=any_array_create_from_raw((any[]){},0)});
		node_group_t * ng=GC_ALLOC_INIT(node_group_t, {.canvas=canvas,.nodes=ui_nodes_create()});
		any_array_push(project_material_groups,ng);
	}
	node_group_t * group=null;
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * g=project_material_groups->buffer[i];
		string_t * cname=g->canvas->name;
		if(string_equals(cname,node->name)){
			group=g;
			break;
		}
	}
	if(ui_button(tr("Nodes",null),ui_align_t_CENTER,"")){
		any_array_push(ui_nodes_group_stack,group);
	}
}

void nodes_material_group_input_button(i32 node_id){
	ui_t * ui=ui_nodes_ui;
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	ui_node_t * node=ui_get_node(ui_nodes_get_canvas(true)->nodes,node_id);
	nodes_material_add_socket_button(ui,nodes,node,node->outputs);
}

void nodes_material_group_output_button(i32 node_id){
	ui_t * ui=ui_nodes_ui;
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	ui_node_t * node=ui_get_node(ui_nodes_get_canvas(true)->nodes,node_id);
	nodes_material_add_socket_button(ui,nodes,node,node->inputs);
}

void nodes_material_add_socket_button(ui_t * ui,ui_nodes_t * nodes,ui_node_t * node,ui_node_socket_t_array_t * sockets){
	if(ui_button(tr("Add",null),ui_align_t_CENTER,"")){
		gc_unroot(_nodes_material_nodes);_nodes_material_nodes=nodes;gc_root(_nodes_material_nodes);
		gc_unroot(_nodes_material_node);_nodes_material_node=node;gc_root(_nodes_material_node);
		gc_unroot(_nodes_material_sockets);_nodes_material_sockets=sockets;gc_root(_nodes_material_sockets);
		ui_menu_draw(&nodes_material_add_socket_button_77026		,-1,-1);
	}
}

void nodes_material_add_socket_button_77026(ui_t * ui){
ui_nodes_t * nodes=_nodes_material_nodes;
		ui_node_t * node=_nodes_material_node;
		ui_node_socket_t_array_t * sockets=_nodes_material_sockets;
		node_group_t_array_t * group_stack=ui_nodes_group_stack;
		ui_node_canvas_t * c=group_stack->buffer[group_stack->length-1]->canvas;
		if(ui_menu_button(tr("RGBA",null),"")){
			any_array_push(sockets,nodes_material_create_socket(nodes,node,null,"RGBA",c,0.0,1.0,null));
			nodes_material_sync_sockets(node);
		}
		if(ui_menu_button(tr("Vector",null),"")){
			any_array_push(sockets,nodes_material_create_socket(nodes,node,null,"VECTOR",c,0.0,1.0,null));
			nodes_material_sync_sockets(node);
		}
		if(ui_menu_button(tr("Value",null),"")){
			any_array_push(sockets,nodes_material_create_socket(nodes,node,null,"VALUE",c,0.0,1.0,null));
			nodes_material_sync_sockets(node);
		}
}

void nodes_material_sync_sockets(ui_node_t * node){
	node_group_t_array_t * group_stack=ui_nodes_group_stack;
	ui_node_canvas_t * c=group_stack->buffer[group_stack->length-1]->canvas;
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		nodes_material_sync_group_sockets(m->canvas,c->name,node);
	}
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * g=project_material_groups->buffer[i];
		nodes_material_sync_group_sockets(g->canvas,c->name,node);
	}
}

void nodes_material_sync_group_sockets(ui_node_canvas_t * canvas,string_t * group_name,ui_node_t * node){
	for(i32 i=0;i<canvas->nodes->length;++i){
		ui_node_t * n=canvas->nodes->buffer[i];
		if(string_equals(n->type,"GROUP")&&string_equals(n->name,group_name)){
			bool is_inputs=string_equals(node->name,"Group Input");
			ui_node_socket_t_array_t * old_sockets=is_inputs?n->inputs:n->outputs;
			ui_node_socket_t_array_t * sockets=util_clone_canvas_sockets(is_inputs?node->outputs:node->inputs);
			if(is_inputs){
				n->inputs=sockets;
			}
			else {
				n->outputs=sockets;
			}
			for(i32 i=0;i<sockets->length;++i){
				ui_node_socket_t * s=sockets->buffer[i];
				s->node_id=n->id;
			}
			i32 num_sockets=sockets->length<old_sockets->length?sockets->length:old_sockets->length;
			for(i32 i=0;i<num_sockets;++i){
				if(sockets->buffer[i]->type==old_sockets->buffer[i]->type){
					sockets->buffer[i]->default_value=old_sockets->buffer[i]->default_value;
				}
			}
		}
	}
}

i32 nodes_material_get_socket_color(string_t * type){
	return string_equals(type,"RGBA")?0xffc7c729:string_equals(type,"VECTOR")?0xff6363c7:0xffa1a1a1;
}

f32_array_t * nodes_material_get_socket_default_value(string_t * type){
	return string_equals(type,"RGBA")?f32_array_create_xyzw(0.8,0.8,0.8,1.0):string_equals(type,"VECTOR")?f32_array_create_xyz(0.0,0.0,0.0):f32_array_create_x(0.0);
}

string_t * nodes_material_get_socket_name(string_t * type){
	return string_equals(type,"RGBA")?_tr("Color"):string_equals(type,"VECTOR")?_tr("Vector"):_tr("Value");
}

ui_node_socket_t * nodes_material_create_socket(ui_nodes_t * nodes,ui_node_t * node,string_t * name,string_t * type,ui_node_canvas_t * canvas,f32 min,f32 max,any default_value){
	ui_node_socket_t * soc=GC_ALLOC_INIT(ui_node_socket_t, {.id=ui_get_socket_id(canvas->nodes),.node_id=node->id,.name=name==null?nodes_material_get_socket_name(type):name,.type=type,.color=nodes_material_get_socket_color(type),.default_value=default_value==null?nodes_material_get_socket_default_value(type):default_value,.min=min,.max=max});
	return soc;
}

ui_node_t * nodes_material_get_node_t(string_t * node_type){
	for(i32 i=0;i<nodes_material_list->length;++i){
		ui_node_t_array_t * c=nodes_material_list->buffer[i];
		for(i32 i=0;i<c->length;++i){
			ui_node_t * n=c->buffer[i];
			if(string_equals(n->type,node_type)){
				return n;
			}
		}
	}
	return null;
}

ui_node_t * nodes_material_create_node(string_t * node_type,node_group_t * group){
	ui_node_t * n=nodes_material_get_node_t(node_type);
	if(n==null){
		return null;
	}
	ui_node_canvas_t * canvas=group!=null?group->canvas:context_raw->material->canvas;
	ui_nodes_t * nodes=group!=null?group->nodes:context_raw->material->nodes;
	ui_node_t * node=ui_nodes_make_node(n,nodes,canvas);
	any_array_push(canvas->nodes,node);
	return node;
}

node_shader_t * node_shader_create(node_shader_context_t * context){
	node_shader_t * raw=GC_ALLOC_INIT(node_shader_t, {0});
	raw->context=context;
	raw->ins=any_array_create_from_raw((any[]){},0);
	raw->outs=any_array_create_from_raw((any[]){},0);
	raw->frag_out="float4";
	raw->consts=any_array_create_from_raw((any[]){},0);
	raw->textures=any_array_create_from_raw((any[]){},0);
	raw->functions=any_map_create();
	raw->vert="";
	raw->vert_end="";
	raw->vert_normal="";
	raw->vert_attribs="";
	raw->vert_write_normal=0;
	raw->frag="";
	raw->frag_end="";
	raw->frag_normal="";
	raw->frag_attribs="";
	raw->frag_write_normal=0;
	return raw;
}

void node_shader_add_in(node_shader_t * raw,string_t * s){
	any_array_push(raw->ins,s);
}

void node_shader_add_out(node_shader_t * raw,string_t * s){
	any_array_push(raw->outs,s);
}

void node_shader_add_constant(node_shader_t * raw,string_t * s,string_t * link){
	if(char_ptr_array_index_of(raw->consts,s)==-1){
		string_t_array_t * ar=string_split(s,": ");
		string_t * uname=ar->buffer[0];
		string_t * utype=ar->buffer[1];
		if(string_equals(utype,"float2"))utype="vec2";
		if(string_equals(utype,"float3"))utype="vec3";
		if(string_equals(utype,"float4"))utype="vec4";
		if(string_equals(utype,"float3x3"))utype="mat3";
		if(string_equals(utype,"float4x4"))utype="mat4";
		any_array_push(raw->consts,s);
		node_shader_context_add_constant(raw->context,utype,uname,link);
	}
}

void node_shader_add_texture(node_shader_t * raw,string_t * s,string_t * link){
	if(char_ptr_array_index_of(raw->textures,s)==-1){
		string_t_array_t * ar=string_split(s,": ");
		string_t * uname=ar->buffer[0];
		string_t * utype=ar->buffer[1];
		any_array_push(raw->textures,s);
		node_shader_context_add_texture_unit(raw->context,utype,uname,link);
	}
}

void node_shader_add_function(node_shader_t * raw,string_t * s){
	string_t * fname=string_split(s,"(")->buffer[0];
	if(any_map_get(raw->functions,fname)!=null){
		return ;
	}
	any_map_set(raw->functions,fname,s);
}

void node_shader_write_vert(node_shader_t * raw,string_t * s){
	if(raw->vert_write_normal>0){
		raw->vert_normal=string_join(raw->vert_normal,string_join(s,"\n"));
	}
	else {
		raw->vert=string_join(raw->vert,string_join(s,"\n"));
	}
}

void node_shader_write_end_vert(node_shader_t * raw,string_t * s){
	raw->vert_end=string_join(raw->vert_end,string_join(s,"\n"));
}

void node_shader_write_attrib_vert(node_shader_t * raw,string_t * s){
	raw->vert_attribs=string_join(raw->vert_attribs,string_join(s,"\n"));
}

void node_shader_write_frag(node_shader_t * raw,string_t * s){
	if(raw->frag_write_normal>0){
		raw->frag_normal=string_join(raw->frag_normal,string_join(s,"\n"));
	}
	else {
		raw->frag=string_join(raw->frag,string_join(s,"\n"));
	}
}

void node_shader_write_attrib_frag(node_shader_t * raw,string_t * s){
	raw->frag_attribs=string_join(raw->frag_attribs,string_join(s,"\n"));
}

string_t * node_shader_data_size(node_shader_t * raw,string_t * data){
	if(string_equals(data,"float1")){
		return "1";
	}
	else if(string_equals(data,"float2")||string_equals(data,"short2norm")){
		return "2";
	}
	else if(string_equals(data,"float3")){
		return "3";
	}
	else {
		return "4";
	}
}

void node_shader_vstruct_to_vsin(node_shader_t * raw){
	vertex_element_t_array_t * vs=raw->context->data->vertex_elements;
	for(i32 i=0;i<vs->length;++i){
		vertex_element_t * e=vs->buffer[i];
		node_shader_add_in(raw,string_join(string_join(string_join(string_join("",e->name),": "),"float"),node_shader_data_size(raw,e->data)));
	}
}

string_t * node_shader_get(node_shader_t * raw){
	node_shader_vstruct_to_vsin(raw);
	string_t * s="";
	s=string_join(s,"struct vert_in {\n");
	for(i32 i=0;i<raw->ins->length;++i){
		string_t * a=raw->ins->buffer[i];
		s=string_join(s,string_join(string_join("\t",a),";\n"));
	}
	s=string_join(s,"}\n\n");
	s=string_join(s,"struct vert_out {\n");
	s=string_join(s,"\tpos: float4;\n");
	for(i32 i=0;i<raw->outs->length;++i){
		string_t * a=raw->outs->buffer[i];
		s=string_join(s,string_join(string_join("\t",a),";\n"));
	}
	if(raw->consts->length==0){
		s=string_join(s,"\tempty: float4;\n");
	}
	s=string_join(s,"}\n\n");
	s=string_join(s,"#[set(everything)]\n");
	s=string_join(s,"const constants: {\n");
	for(i32 i=0;i<raw->consts->length;++i){
		string_t * a=raw->consts->buffer[i];
		s=string_join(s,string_join(string_join("\t",a),";\n"));
	}
	if(raw->consts->length==0){
		s=string_join(s,"\tempty: float4;\n");
	}
	s=string_join(s,"};\n\n");
	if(raw->textures->length>0){
		s=string_join(s,"#[set(everything)]\n");
		s=string_join(s,"const sampler_linear: sampler;\n\n");
	}
	for(i32 i=0;i<raw->textures->length;++i){
		string_t * a=raw->textures->buffer[i];
		s=string_join(s,"#[set(everything)]\n");
		s=string_join(s,string_join(string_join("const ",a),": tex2d;\n"));
	}
	string_t_array_t * keys=map_keys(raw->functions);
	for(i32 i=0;i<keys->length;++i){
		string_t * f=any_map_get(raw->functions,keys->buffer[i]);
		s=string_join(s,string_join(f,"\n"));
	}
	s=string_join(s,"\n");
	s=string_join(s,"fun kong_vert(input: vert_in): vert_out {\n");
	s=string_join(s,"\tvar output: vert_out;\n\n");
	s=string_join(s,raw->vert_attribs);
	s=string_join(s,raw->vert_normal);
	s=string_join(s,raw->vert);
	s=string_join(s,raw->vert_end);
	s=string_join(s,"\toutput.pos.z = (output.pos.z + output.pos.w) * 0.5;\n");
	if(raw->consts->length==0){
		s=string_join(s,"\toutput.empty = constants.empty;\n");
	}
	s=string_join(s,"\n\treturn output;\n");
	s=string_join(s,"}\n\n");
	s=string_join(s,string_join(string_join("fun kong_frag(input: vert_out): ",raw->frag_out)," {\n"));
	s=string_join(s,string_join(string_join("\tvar output: ",raw->frag_out),";\n\n"));
	s=string_join(s,raw->frag_attribs);
	s=string_join(s,raw->frag_normal);
	s=string_join(s,raw->frag);
	s=string_join(s,raw->frag_end);
	s=string_join(s,"\n\treturn output;\n");
	s=string_join(s,"}\n\n");
	s=string_join(s,"#[pipe]\n");
	s=string_join(s,"struct pipe {\n");
	s=string_join(s,"\tvertex = kong_vert;\n");
	s=string_join(s,"\tfragment = kong_frag;\n");
	s=string_join(s,"}\n");
	return s;
}

node_shader_context_t * node_shader_context_create(material_t * material,shader_context_t * props){
	node_shader_context_t * raw=GC_ALLOC_INIT(node_shader_context_t, {0});
	raw->material=material;
	vertex_element_t_array_t * vertex_elements_default=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_element_t, {.name="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="nor",.data="short2norm"}),},2);
	raw->data=GC_ALLOC_INIT(shader_context_t, {.name=props->name,.depth_write=props->depth_write,.compare_mode=props->compare_mode,.cull_mode=props->cull_mode,.blend_source=props->blend_source,.blend_destination=props->blend_destination,.alpha_blend_source=props->alpha_blend_source,.alpha_blend_destination=props->alpha_blend_destination,.fragment_shader="",.vertex_shader="",.vertex_elements=props->vertex_elements!=null?props->vertex_elements:vertex_elements_default,.color_attachments=props->color_attachments,.depth_attachment=props->depth_attachment});
	shader_context_t * rw=raw->data;
	rw->_=GC_ALLOC_INIT(shader_context_runtime_t, {0});
	if(props->color_writes_red!=null){
		raw->data->color_writes_red=props->color_writes_red;
	}
	if(props->color_writes_green!=null){
		raw->data->color_writes_green=props->color_writes_green;
	}
	if(props->color_writes_blue!=null){
		raw->data->color_writes_blue=props->color_writes_blue;
	}
	if(props->color_writes_alpha!=null){
		raw->data->color_writes_alpha=props->color_writes_alpha;
	}
	raw->data->texture_units=any_array_create_from_raw((any[]){},0);
	raw->data->constants=i32_array_create_from_raw((i32[]){},0);
	return raw;
}

void node_shader_context_add_elem(node_shader_context_t * raw,string_t * name,string_t * data_type){
	for(i32 i=0;i<raw->data->vertex_elements->length;++i){
		vertex_element_t * e=raw->data->vertex_elements->buffer[i];
		if(string_equals(e->name,name)){
			return ;
		}
	}
	vertex_element_t * elem=GC_ALLOC_INIT(vertex_element_t, {.name=name,.data=data_type});
	any_array_push(raw->data->vertex_elements,elem);
}

bool node_shader_context_is_elem(node_shader_context_t * raw,string_t * name){
	for(i32 i=0;i<raw->data->vertex_elements->length;++i){
		vertex_element_t * elem=raw->data->vertex_elements->buffer[i];
		if(string_equals(elem->name,name)){
			return true;
		}
	}
	return false;
}

vertex_element_t * node_shader_context_get_elem(node_shader_context_t * raw,string_t * name){
	for(i32 i=0;i<raw->data->vertex_elements->length;++i){
		vertex_element_t * elem=raw->data->vertex_elements->buffer[i];
		if(string_equals(elem->name,name)){
			return elem;
		}
	}
	return null;
}

void node_shader_context_add_constant(node_shader_context_t * raw,string_t * ctype,string_t * name,string_t * link){
	for(i32 i=0;i<raw->data->constants->length;++i){
		shader_const_t * c=raw->data->constants->buffer[i];
		if(string_equals(c->name,name)){
			return ;
		}
	}
	shader_const_t * c=GC_ALLOC_INIT(shader_const_t, {.name=name,.type=ctype});
	if(link!=null){
		c->link=string_copy(link);
	}
	shader_const_t_array_t * consts=raw->data->constants;
	any_array_push(consts,c);
}

void node_shader_context_add_texture_unit(node_shader_context_t * raw,string_t * ctype,string_t * name,string_t * link){
	for(i32 i=0;i<raw->data->texture_units->length;++i){
		tex_unit_t * c=raw->data->texture_units->buffer[i];
		if(string_equals(c->name,name)){
			return ;
		}
	}
	tex_unit_t * c=GC_ALLOC_INIT(tex_unit_t, {.name=name,.link=link});
	any_array_push(raw->data->texture_units,c);
}

node_shader_t * node_shader_context_make_kong(node_shader_context_t * raw){
	raw->data->vertex_shader=string_join(string_join(string_join(raw->material->name,"_"),raw->data->name),".vert");
	raw->data->fragment_shader=string_join(string_join(string_join(raw->material->name,"_"),raw->data->name),".frag");
	raw->kong=node_shader_create(raw);
	return raw->kong;
}

void operator_register(string_t * name,void(*call)(void)){
	any_map_set(operator_ops,name,call);
}

void operator_run(string_t * name){
	if(any_map_get(operator_ops,name)!=null){
		void(*cb)(void)=any_map_get(operator_ops,name);
		cb();
	}
}

void operator_update(){
	if(mouse_started_any()||keyboard_started_any()){
		string_t_array_t * keys=map_keys(config_keymap);
		for(i32 i=0;i<keys->length;++i){
			string_t * op=keys->buffer[i];
			if(operator_shortcut(any_map_get(config_keymap,op),shortcut_type_t_STARTED)){
				operator_run(op);
			}
		}
	}
}

bool operator_shortcut(string_t * s,shortcut_type_t type){
	if(string_equals(s,"")){
		return false;
	}
	bool shift=string_index_of(s,"shift")>=0;
	bool ctrl=string_index_of(s,"ctrl")>=0;
	bool alt=string_index_of(s,"alt")>=0;
	bool flag=shift==keyboard_down("shift")&&ctrl==keyboard_down("control")&&alt==keyboard_down("alt");
	if(string_index_of(s,"+")>0){
		s=string_copy(substring(s,string_last_index_of(s,"+")+1,string_length(s)));
		if(string_equals(s,"number")){
			return flag;
		}
	}
	else if(shift||ctrl||alt){
		return flag;
	}
	bool key=false;
	if(string_equals(s,"left")||string_equals(s,"right")||string_equals(s,"middle")){
		if(type==shortcut_type_t_DOWN){
			key=mouse_down(s);
		}
		else {
			key=mouse_started(s);
		}
	}
	else if(type==shortcut_type_t_REPEAT){
		key=keyboard_repeat(s);
	}
	else if(type==shortcut_type_t_DOWN){
		key=keyboard_down(s);
	}
	else if(type==shortcut_type_t_RELEASED){
		key=keyboard_released(s);
	}
	else {
		key=keyboard_started(s);
	}
	return flag&&key;
}

void parser_exr_write_string(u8_array_t * out,string_t * str){
	for(i32 i=0;i<string_length(str);++i){
		u8_array_push(out,char_code_at(str,i));
	}
}

void parser_exr_write_line16(i32 byte_pos){
	for(i32 x=0;x<_parser_exr_width;++x){
		u8_array_push(_parser_exr_out,buffer_get_u8(_parser_exr_src_view,byte_pos));
		u8_array_push(_parser_exr_out,buffer_get_u8(_parser_exr_src_view,byte_pos+1));
		byte_pos+=_parser_exr_stride;
	}
}

void parser_exr_write_line32(i32 byte_pos){
	for(i32 x=0;x<_parser_exr_width;++x){
		u8_array_push(_parser_exr_out,buffer_get_u8(_parser_exr_src_view,byte_pos));
		u8_array_push(_parser_exr_out,buffer_get_u8(_parser_exr_src_view,byte_pos+1));
		u8_array_push(_parser_exr_out,buffer_get_u8(_parser_exr_src_view,byte_pos+2));
		u8_array_push(_parser_exr_out,buffer_get_u8(_parser_exr_src_view,byte_pos+3));
		byte_pos+=_parser_exr_stride;
	}
}

void parser_exr_write_bgr(i32 off,i32 pos,i32 byte_size){
	_parser_exr_write_line(pos+byte_size*2);
	_parser_exr_write_line(pos+byte_size);
	_parser_exr_write_line(pos);
}

void parser_exr_write_single(i32 off,i32 pos,i32 byte_size){
	_parser_exr_write_line(pos+off*byte_size);
	_parser_exr_write_line(pos+off*byte_size);
	_parser_exr_write_line(pos+off*byte_size);
}

buffer_t * parser_exr_run(i32 width,i32 height,buffer_t * src,i32 bits,i32 type,i32 off){
	u8_array_t * out=u8_array_create_from_raw((u8[]){},0);
	u8_array_push(out,0x76);
	u8_array_push(out,0x2f);
	u8_array_push(out,0x31);
	u8_array_push(out,0x01);
	u8_array_push(out,2);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	parser_exr_write_string(out,"channels");
	u8_array_push(out,0);
	parser_exr_write_string(out,"chlist");
	u8_array_push(out,0);
	u8_array_push(out,55);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	i32 attrib=bits==16?1:2;
	u8_array_push(out,char_code_at("B",0));
	u8_array_push(out,0);
	u8_array_push(out,attrib);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,char_code_at("G",0));
	u8_array_push(out,0);
	u8_array_push(out,attrib);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,char_code_at("R",0));
	u8_array_push(out,0);
	u8_array_push(out,attrib);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	parser_exr_write_string(out,"compression");
	u8_array_push(out,0);
	parser_exr_write_string(out,"compression");
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	parser_exr_write_string(out,"dataWindow");
	u8_array_push(out,0);
	parser_exr_write_string(out,"box2i");
	u8_array_push(out,0);
	u8_array_push(out,16);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	i32 ww=width-1;
	i32 hh=height-1;
	u8_array_push(out,ww&0xff);
	u8_array_push(out,(ww>>8)&0xff);
	u8_array_push(out,(ww>>16)&0xff);
	u8_array_push(out,(ww>>24)&0xff);
	u8_array_push(out,hh&0xff);
	u8_array_push(out,(hh>>8)&0xff);
	u8_array_push(out,(hh>>16)&0xff);
	u8_array_push(out,(hh>>24)&0xff);
	parser_exr_write_string(out,"displayWindow");
	u8_array_push(out,0);
	parser_exr_write_string(out,"box2i");
	u8_array_push(out,0);
	u8_array_push(out,16);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,ww&0xff);
	u8_array_push(out,(ww>>8)&0xff);
	u8_array_push(out,(ww>>16)&0xff);
	u8_array_push(out,(ww>>24)&0xff);
	u8_array_push(out,hh&0xff);
	u8_array_push(out,(hh>>8)&0xff);
	u8_array_push(out,(hh>>16)&0xff);
	u8_array_push(out,(hh>>24)&0xff);
	parser_exr_write_string(out,"lineOrder");
	u8_array_push(out,0);
	parser_exr_write_string(out,"lineOrder");
	u8_array_push(out,0);
	u8_array_push(out,1);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	parser_exr_write_string(out,"pixelAspectRatio");
	u8_array_push(out,0);
	parser_exr_write_string(out,"float");
	u8_array_push(out,0);
	u8_array_push(out,4);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0x80);
	u8_array_push(out,0x3f);
	parser_exr_write_string(out,"screenWindowCenter");
	u8_array_push(out,0);
	parser_exr_write_string(out,"v2f");
	u8_array_push(out,0);
	u8_array_push(out,8);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	parser_exr_write_string(out,"screenWindowWidth");
	u8_array_push(out,0);
	parser_exr_write_string(out,"float");
	u8_array_push(out,0);
	u8_array_push(out,4);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0);
	u8_array_push(out,0x80);
	u8_array_push(out,0x3f);
	u8_array_push(out,0);
	i32 channels=4;
	i32 byte_size=bits==16?2:4;
	i32 k_header_size=out->length;
	i32 k_scanline_table_size=8*height;
	i32 pixel_row_size=width*3*byte_size;
	i32 full_row_size=pixel_row_size+8;
	i32 ofs=k_header_size+k_scanline_table_size;
	for(i32 y=0;y<height;++y){
		u8_array_push(out,ofs&0xff);
		u8_array_push(out,(ofs>>8)&0xff);
		u8_array_push(out,(ofs>>16)&0xff);
		u8_array_push(out,(ofs>>24)&0xff);
		u8_array_push(out,0);
		u8_array_push(out,0);
		u8_array_push(out,0);
		u8_array_push(out,0);
		ofs+=full_row_size;
	}
	i32 stride=channels*byte_size;
	i32 pos=0;
	_parser_exr_width=width;
	_parser_exr_stride=stride;
	gc_unroot(_parser_exr_out);_parser_exr_out=out;gc_root(_parser_exr_out);
	gc_unroot(_parser_exr_src_view);_parser_exr_src_view=src;gc_root(_parser_exr_src_view);
	gc_unroot(_parser_exr_write_line);_parser_exr_write_line=bits==16?parser_exr_write_line16:parser_exr_write_line32;gc_root(_parser_exr_write_line);
	void(*write_data)(i32,i32,i32)=type==1?parser_exr_write_bgr:parser_exr_write_single;
	for(i32 y=0;y<height;++y){
		u8_array_push(out,y&0xff);
		u8_array_push(out,(y>>8)&0xff);
		u8_array_push(out,(y>>16)&0xff);
		u8_array_push(out,(y>>24)&0xff);
		u8_array_push(out,pixel_row_size&0xff);
		u8_array_push(out,(pixel_row_size>>8)&0xff);
		u8_array_push(out,(pixel_row_size>>16)&0xff);
		u8_array_push(out,(pixel_row_size>>24)&0xff);
		write_data(off,pos,byte_size);
		pos+=width*stride;
	}
	return out;
}

logic_node_ext_t * parser_logic_get_logic_node(ui_node_t * node){
	return any_map_get(parser_logic_node_map,parser_logic_node_name(node));
}

ui_node_t * parser_logic_get_node(i32 id){
	for(i32 i=0;i<parser_logic_nodes->length;++i){
		ui_node_t * n=parser_logic_nodes->buffer[i];
		if(n->id==id){
			return n;
		}
	}
	return null;
}

ui_node_link_t * parser_logic_get_link(i32 id){
	for(i32 i=0;i<parser_logic_links->length;++i){
		ui_node_link_t * l=parser_logic_links->buffer[i];
		if(l->id==id){
			return l;
		}
	}
	return null;
}

ui_node_link_t * parser_logic_get_input_link(ui_node_socket_t * inp){
	for(i32 i=0;i<parser_logic_links->length;++i){
		ui_node_link_t * l=parser_logic_links->buffer[i];
		if(l->to_id==inp->node_id){
			ui_node_t * node=parser_logic_get_node(inp->node_id);
			if(node->inputs->length<=l->to_socket){
				return null;
			}
			if(node->inputs->buffer[l->to_socket]==inp){
				return l;
			}
		}
	}
	return null;
}

ui_node_link_t_array_t * parser_logic_get_output_links(ui_node_socket_t * out){
	ui_node_link_t_array_t * res=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<parser_logic_links->length;++i){
		ui_node_link_t * l=parser_logic_links->buffer[i];
		if(l->from_id==out->node_id){
			ui_node_t * node=parser_logic_get_node(out->node_id);
			if(node->outputs->length<=l->from_socket){
				continue;
			}
			if(node->outputs->buffer[l->from_socket]==out){
				any_array_push(res,l);
			}
		}
	}
	return res;
}

string_t * parser_logic_safe_src(string_t * s){
	return string_replace_all(s," ","");
}

string_t * parser_logic_node_name(ui_node_t * node){
	string_t * safe=parser_logic_safe_src(node->name);
	i32 nid=node->id;
	string_t * s=string_join(safe,i32_to_string(nid));
	return s;
}

void parser_logic_parse(ui_node_canvas_t * canvas){
	gc_unroot(parser_logic_nodes);parser_logic_nodes=canvas->nodes;gc_root(parser_logic_nodes);
	gc_unroot(parser_logic_links);parser_logic_links=canvas->links;gc_root(parser_logic_links);
	gc_unroot(parser_logic_parsed_nodes);parser_logic_parsed_nodes=any_array_create_from_raw((any[]){},0);gc_root(parser_logic_parsed_nodes);
	gc_unroot(parser_logic_node_map);parser_logic_node_map=any_map_create();gc_root(parser_logic_node_map);
	ui_node_t_array_t * root_nodes=parser_logic_get_root_nodes(canvas);
	for(i32 i=0;i<root_nodes->length;++i){
		ui_node_t * node=root_nodes->buffer[i];
		parser_logic_build_node(node);
	}
}

string_t * parser_logic_build_node(ui_node_t * node){
	string_t * name=parser_logic_node_name(node);
	if(char_ptr_array_index_of(parser_logic_parsed_nodes,name)!=-1){
		return name;
	}
	any_array_push(parser_logic_parsed_nodes,name);
	logic_node_ext_t * v=parser_logic_create_node_instance(node->type,node,null);
	any_map_set(parser_logic_node_map,name,v);
	logic_node_ext_t * inp_node=null;
	i32 inp_from=0;
	for(i32 i=0;i<node->inputs->length;++i){
		ui_node_socket_t * inp=node->inputs->buffer[i];
		ui_node_link_t * l=parser_logic_get_input_link(inp);
		if(l!=null){
			ui_node_t * n=parser_logic_get_node(l->from_id);
			string_t * s=parser_logic_build_node(n);
			inp_node=any_map_get(parser_logic_node_map,s);
			inp_from=l->from_socket;
		}
		else {
			inp_node=parser_logic_build_default_node(inp);
			inp_from=0;
		}
		logic_node_add_input(v->base,inp_node,inp_from);
	}
	for(i32 i=0;i<node->outputs->length;++i){
		ui_node_socket_t * out=node->outputs->buffer[i];
		logic_node_t_array_t * out_nodes=any_array_create_from_raw((any[]){},0);
		ui_node_link_t_array_t * ls=parser_logic_get_output_links(out);
		if(ls!=null&&ls->length>0){
			for(i32 i=0;i<ls->length;++i){
				ui_node_link_t * l=ls->buffer[i];
				ui_node_t * n=parser_logic_get_node(l->to_id);
				string_t * out_name=parser_logic_build_node(n);
				any_array_push(out_nodes,any_map_get(parser_logic_node_map,out_name));
			}
		}
		else {
			any_array_push(out_nodes,parser_logic_build_default_node(out));
		}
		logic_node_add_outputs(v->base,out_nodes);
	}
	return name;
}

ui_node_t_array_t * parser_logic_get_root_nodes(ui_node_canvas_t * node_group){
	ui_node_t_array_t * roots=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<node_group->nodes->length;++i){
		ui_node_t * node=node_group->nodes->buffer[i];
		bool linked=false;
		for(i32 i=0;i<node->outputs->length;++i){
			ui_node_socket_t * out=node->outputs->buffer[i];
			ui_node_link_t_array_t * ls=parser_logic_get_output_links(out);
			if(ls!=null&&ls->length>0){
				linked=true;
				break;
			}
		}
		if(!linked){
			any_array_push(roots,node);
		}
	}
	return roots;
}

logic_node_ext_t * parser_logic_build_default_node(ui_node_socket_t * inp){
	logic_node_ext_t * v=null;
	if(string_equals(inp->type,"VECTOR")){
		if(inp->default_value==null){
			inp->default_value=f32_array_create_xyz(0,0,0);
		}
		v=parser_logic_create_node_instance("vector_node",null,inp->default_value);
	}
	else if(string_equals(inp->type,"RGBA")){
		if(inp->default_value==null){
			inp->default_value=f32_array_create_xyzw(0,0,0,0);
		}
		v=parser_logic_create_node_instance("color_node",null,inp->default_value);
	}
	else if(string_equals(inp->type,"RGB")){
		if(inp->default_value==null){
			inp->default_value=f32_array_create_xyzw(0,0,0,0);
		}
		v=parser_logic_create_node_instance("color_node",null,inp->default_value);
	}
	else if(string_equals(inp->type,"VALUE")){
		v=parser_logic_create_node_instance("float_node",null,inp->default_value);
	}
	else if(string_equals(inp->type,"INT")){
		v=parser_logic_create_node_instance("integer_node",null,inp->default_value);
	}
	else if(string_equals(inp->type,"BOOLEAN")){
		v=parser_logic_create_node_instance("boolean_node",null,inp->default_value);
	}
	else if(string_equals(inp->type,"STRING")){
		v=parser_logic_create_node_instance("string_node",null,inp->default_value);
	}
	else {
		v=parser_logic_create_node_instance("null_node",null,null);
	}
	return v;
}

logic_node_ext_t * parser_logic_create_node_instance(string_t * node_type,ui_node_t * raw,f32_array_t * args){
	if(any_map_get(parser_logic_custom_nodes,node_type)!=null){
		logic_node_t * node=logic_node_create(null);
		node->get=any_map_get(parser_logic_custom_nodes,node_type);
		node->ext=GC_ALLOC_INIT(logic_node_ext_t, {.base=node});
		return node->ext;
	}
	if(nodes_brush_creates==null){
		nodes_brush_init();
	}
	logic_node_ext_t *(*create)(ui_node_t *,f32_array_t *)=any_map_get(nodes_brush_creates,node_type);
	return create(raw,args);
}

ui_node_t * parser_material_get_node(i32 id){
	for(i32 i=0;i<parser_material_nodes->length;++i){
		ui_node_t * n=parser_material_nodes->buffer[i];
		if(n->id==id){
			return n;
		}
	}
	return null;
}

ui_node_link_t * parser_material_get_link(i32 id){
	for(i32 i=0;i<parser_material_links->length;++i){
		ui_node_link_t * l=parser_material_links->buffer[i];
		if(l->id==id){
			return l;
		}
	}
	return null;
}

ui_node_link_t * parser_material_get_input_link(ui_node_socket_t * inp){
	for(i32 i=0;i<parser_material_links->length;++i){
		ui_node_link_t * l=parser_material_links->buffer[i];
		if(l->to_id==inp->node_id){
			ui_node_t * node=parser_material_get_node(inp->node_id);
			if(node->inputs->length<=l->to_socket){
				return null;
			}
			if(node->inputs->buffer[l->to_socket]==inp){
				return l;
			}
		}
	}
	return null;
}

ui_node_link_t_array_t * parser_material_get_output_links(ui_node_socket_t * out){
	ui_node_link_t_array_t * ls=null;
	for(i32 i=0;i<parser_material_links->length;++i){
		ui_node_link_t * l=parser_material_links->buffer[i];
		if(l->from_id==out->node_id){
			ui_node_t * node=parser_material_get_node(out->node_id);
			if(node->outputs->length<=l->from_socket){
				continue;
			}
			if(node->outputs->buffer[l->from_socket]==out){
				if(ls==null){
					ls=any_array_create_from_raw((any[]){},0);
				}
				any_array_push(ls,l);
			}
		}
	}
	return ls;
}

void parser_material_init(){
	gc_unroot(parser_material_parsed);parser_material_parsed=any_array_create_from_raw((any[]){},0);gc_root(parser_material_parsed);
	gc_unroot(parser_material_parents);parser_material_parents=any_array_create_from_raw((any[]){},0);gc_root(parser_material_parents);
	parser_material_cotangent_frame_written=false;
	gc_unroot(parser_material_out_normaltan);parser_material_out_normaltan="float3(0.5, 0.5, 1.0)";gc_root(parser_material_out_normaltan);
	gc_unroot(parser_material_script_links);parser_material_script_links=null;
	parser_material_parsing_basecolor=false;
}

shader_out_t * parser_material_parse(ui_node_canvas_t * canvas,node_shader_context_t * _con,node_shader_t * _kong,material_context_t * _matcon){
	parser_material_init();
	gc_unroot(parser_material_canvases);parser_material_canvases=any_array_create_from_raw((any[]){canvas,},1);gc_root(parser_material_canvases);
	gc_unroot(parser_material_nodes);parser_material_nodes=canvas->nodes;gc_root(parser_material_nodes);
	gc_unroot(parser_material_links);parser_material_links=canvas->links;gc_root(parser_material_links);
	gc_unroot(parser_material_con);parser_material_con=_con;gc_root(parser_material_con);
	gc_unroot(parser_material_kong);parser_material_kong=_kong;gc_root(parser_material_kong);
	gc_unroot(parser_material_matcon);parser_material_matcon=_matcon;gc_root(parser_material_matcon);
	if(parser_material_start_group!=null){
		parser_material_push_group(parser_material_start_group);
		gc_unroot(parser_material_parents);parser_material_parents=parser_material_start_parents;gc_root(parser_material_parents);
	}
	if(parser_material_start_node!=null){
		ui_node_link_t * link=GC_ALLOC_INIT(ui_node_link_t, {.id=99999,.from_id=parser_material_start_node->id,.from_socket=0,.to_id=-1,.to_socket=-1});
		parser_material_write_result(link);
		shader_out_t * sout=GC_ALLOC_INIT(shader_out_t, {.out_basecol="float3(0.0, 0.0, 0.0)",.out_roughness="0.0",.out_metallic="0.0",.out_occlusion="1.0",.out_opacity="1.0",.out_height="0.0",.out_emission="0.0",.out_subsurface="0.0"});
		return sout;
	}
	ui_node_t * output_node=parser_material_node_by_type(parser_material_nodes,"OUTPUT_MATERIAL");
	if(output_node!=null){
		return parser_material_parse_output(output_node);
	}
	output_node=parser_material_node_by_type(parser_material_nodes,"OUTPUT_MATERIAL_PBR");
	if(output_node!=null){
		return parser_material_parse_output_pbr(output_node);
	}
	return null;
}

void parser_material_finalize(node_shader_context_t * con){
	node_shader_t * kong=con->kong;
	if(kong->frag_dotnv){
		kong->frag_vvec=true;
		kong->frag_n=true;
	}
	if(kong->frag_vvec){
		kong->frag_wposition=true;
	}
	if(kong->frag_bposition){
		if(parser_material_triplanar){
			node_shader_write_attrib_frag(kong,"var bposition: float3 = float3(\
				tex_coord1.x * tex_coord_blend.y + tex_coord2.x * tex_coord_blend.z,\
				tex_coord.x * tex_coord_blend.x + tex_coord2.y * tex_coord_blend.z,\
				tex_coord.y * tex_coord_blend.x + tex_coord1.y * tex_coord_blend.y);");
		}
		else if(kong->frag_ndcpos){
			node_shader_add_out(kong,"_bposition: float3");
			node_shader_write_vert(kong,"output._bposition = (ndc.xyz / ndc.w);");
			node_shader_write_attrib_frag(kong,"var bposition: float3 = input._bposition;");
		}
		else {
			node_shader_add_out(kong,"_bposition: float3");
			node_shader_add_constant(kong,"dim: float3","_dim");
			node_shader_add_constant(kong,"hdim: float3","_half_dim");
			node_shader_write_attrib_vert(kong,"output._bposition = (input.pos.xyz + constants.hdim) / constants.dim;");
			node_shader_write_attrib_frag(kong,"var bposition: float3 = input._bposition;");
		}
	}
	if(kong->frag_wposition){
		node_shader_add_constant(kong,"W: float4x4","_world_matrix");
		node_shader_add_out(kong,"wposition: float3");
		node_shader_write_attrib_vert(kong,"output.wposition = (constants.W * float4(input.pos.xyz, 1.0)).xyz;");
	}
	if(kong->frag_vposition){
		node_shader_add_constant(kong,"WV: float4x4","_world_view_matrix");
		node_shader_add_out(kong,"vposition: float3");
		node_shader_write_attrib_vert(kong,"output.vposition = (constants.WV * float4(input.pos.xyz, 1.0)).xyz;");
	}
	if(kong->frag_mposition){
		node_shader_add_out(kong,"mposition: float3");
		if(kong->frag_ndcpos){
			node_shader_write_vert(kong,"output.mposition = (ndc.xyz / ndc.w);");
		}
		else {
			node_shader_write_attrib_vert(kong,"output.mposition = input.pos.xyz;");
		}
	}
	if(kong->frag_wtangent){
		node_shader_add_out(kong,"wtangent: float3");
		node_shader_write_attrib_vert(kong,"output.wtangent = float3(0.0, 0.0, 0.0);");
	}
	if(kong->frag_vvec_cam){
		node_shader_add_constant(kong,"WV: float4x4","_world_view_matrix");
		node_shader_add_out(kong,"eye_dir_cam: float3");
		node_shader_write_attrib_vert(kong,"output.eye_dir_cam = (constants.WV * float4(input.pos.xyz, 1.0)).xyz;");
		node_shader_write_attrib_vert(kong,"output.eye_dir_cam.z *= -1.0;");
		node_shader_write_attrib_frag(kong,"var vvec_cam: float3 = normalize(input.eye_dir_cam);");
	}
	if(kong->frag_vvec){
		node_shader_add_constant(kong,"eye: float3","_camera_pos");
		node_shader_add_out(kong,"eye_dir: float3");
		node_shader_write_attrib_vert(kong,"output.eye_dir = constants.eye - output.wposition;");
		node_shader_write_attrib_frag(kong,"var vvec: float3 = normalize(input.eye_dir);");
	}
	if(kong->frag_n){
		node_shader_add_constant(kong,"N: float3x3","_normal_matrix");
		node_shader_add_out(kong,"wnormal: float3");
		node_shader_write_attrib_vert(kong,"output.wnormal = constants.N * float3(input.nor.xy, input.pos.w);");
		node_shader_write_attrib_frag(kong,"var n: float3 = normalize(input.wnormal);");
	}
	else if(kong->vert_n){
		node_shader_add_constant(kong,"N: float3x3","_normal_matrix");
		node_shader_write_attrib_vert(kong,"var wnormal: float3 = normalize(constants.N * float3(input.nor.xy, input.pos.w));");
	}
	if(kong->frag_nattr){
		node_shader_add_out(kong,"nattr: float3");
		node_shader_write_attrib_vert(kong,"output.nattr = float3(input.nor.xy, input.pos.w);");
	}
	if(kong->frag_dotnv){
		node_shader_write_attrib_frag(kong,"var dotnv: float = max(dot(n, vvec), 0.0);");
	}
	if(kong->frag_wvpposition){
		node_shader_add_out(kong,"wvpposition: float4");
		node_shader_write_end_vert(kong,"output.wvpposition = output.pos;");
	}
	if(node_shader_context_is_elem(con,"col")){
		node_shader_add_out(kong,"vcolor: float3");
		node_shader_write_attrib_vert(kong,"output.vcolor = input.col.rgb;");
	}
}

shader_out_t * parser_material_parse_output(ui_node_t * node){
	if(parser_material_parse_surface||parser_material_parse_opacity){
		return parser_material_parse_shader_input(node->inputs->buffer[0]);
	}
	return null;
}

shader_out_t * parser_material_parse_output_pbr(ui_node_t * node){
	if(parser_material_parse_surface||parser_material_parse_opacity){
		return parser_material_parse_shader(node,null);
	}
	return null;
}

ui_node_canvas_t * parser_material_get_group(string_t * name){
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * g=project_material_groups->buffer[i];
		if(string_equals(g->canvas->name,name)){
			return g->canvas;
		}
	}
	return null;
}

void parser_material_push_group(ui_node_canvas_t * g){
	any_array_push(parser_material_canvases,g);
	gc_unroot(parser_material_nodes);parser_material_nodes=g->nodes;gc_root(parser_material_nodes);
	gc_unroot(parser_material_links);parser_material_links=g->links;gc_root(parser_material_links);
}

void parser_material_pop_group(){
	array_pop(parser_material_canvases);
	ui_node_canvas_t * g=parser_material_canvases->buffer[parser_material_canvases->length-1];
	gc_unroot(parser_material_nodes);parser_material_nodes=g->nodes;gc_root(parser_material_nodes);
	gc_unroot(parser_material_links);parser_material_links=g->links;gc_root(parser_material_links);
}

string_t * parser_material_parse_group(ui_node_t * node,ui_node_socket_t * socket){
	any_array_push(parser_material_parents,node);
	parser_material_push_group(parser_material_get_group(node->name));
	ui_node_t * output_node=parser_material_node_by_type(parser_material_nodes,"GROUP_OUTPUT");
	if(output_node==null){
		return null;
	}
	i32 index=parser_material_socket_index(node,socket);
	ui_node_socket_t * inp=output_node->inputs->buffer[index];
	string_t * out_group=parser_material_parse_input(inp);
	array_pop(parser_material_parents);
	parser_material_pop_group();
	return out_group;
}

string_t * parser_material_parse_group_input(ui_node_t * node,ui_node_socket_t * socket){
	ui_node_t * parent=array_pop(parser_material_parents);
	parser_material_pop_group();
	i32 index=parser_material_socket_index(node,socket);
	ui_node_socket_t * inp=parent->inputs->buffer[index];
	string_t * res=parser_material_parse_input(inp);
	any_array_push(parser_material_parents,parent);
	parser_material_push_group(parser_material_get_group(parent->name));
	return res;
}

string_t * parser_material_parse_input(ui_node_socket_t * inp){
	if(string_equals(inp->type,"RGB")){
		return parser_material_parse_vector_input(inp);
	}
	else if(string_equals(inp->type,"RGBA")){
		return parser_material_parse_vector_input(inp);
	}
	else if(string_equals(inp->type,"VECTOR")){
		return parser_material_parse_vector_input(inp);
	}
	else if(string_equals(inp->type,"VALUE")){
		return parser_material_parse_value_input(inp,false);
	}
	return null;
}

shader_out_t * parser_material_parse_shader_input(ui_node_socket_t * inp){
	ui_node_link_t * l=parser_material_get_input_link(inp);
	ui_node_t * from_node=l!=null?parser_material_get_node(l->from_id):null;
	if(from_node!=null){
		if(string_equals(from_node->type,"REROUTE")){
			return parser_material_parse_shader_input(from_node->inputs->buffer[0]);
		}
		return parser_material_parse_shader(from_node,from_node->outputs->buffer[l->from_socket]);
	}
	else {
		shader_out_t * sout=GC_ALLOC_INIT(shader_out_t, {.out_basecol="float3(0.8, 0.8, 0.8)",.out_roughness="0.0",.out_metallic="0.0",.out_occlusion="1.0",.out_opacity="1.0",.out_height="0.0",.out_emission="0.0",.out_subsurface="0.0"});
		return sout;
	}
}

shader_out_t * parser_material_parse_shader(ui_node_t * node,ui_node_socket_t * socket){
	shader_out_t * sout=GC_ALLOC_INIT(shader_out_t, {.out_basecol="float3(0.8, 0.8, 0.8)",.out_roughness="0.0",.out_metallic="0.0",.out_occlusion="1.0",.out_opacity="1.0",.out_height="0.0",.out_emission="0.0",.out_subsurface="0.0"});
	if(string_equals(node->type,"OUTPUT_MATERIAL_PBR")){
		if(parser_material_parse_surface){
			parse_normal_map_color_input(node->inputs->buffer[5]);
			parser_material_parsing_basecolor=true;
			sout->out_basecol=string_copy(parser_material_parse_vector_input(node->inputs->buffer[0]));
			parser_material_parsing_basecolor=false;
			sout->out_occlusion=string_copy(parser_material_parse_value_input(node->inputs->buffer[2],false));
			sout->out_roughness=string_copy(parser_material_parse_value_input(node->inputs->buffer[3],false));
			sout->out_metallic=string_copy(parser_material_parse_value_input(node->inputs->buffer[4],false));
			if(parser_material_parse_emission){
				sout->out_emission=string_copy(parser_material_parse_value_input(node->inputs->buffer[6],false));
			}
			if(parser_material_parse_subsurface){
				sout->out_subsurface=string_copy(parser_material_parse_value_input(node->inputs->buffer[8],false));
			}
		}
		if(parser_material_parse_opacity){
			sout->out_opacity=string_copy(parser_material_parse_value_input(node->inputs->buffer[1],false));
		}
		if(node->inputs->length>7&&parser_material_parse_height){
			if(!parser_material_parse_height_as_channel){
				parser_material_is_frag=false;
			}
			sout->out_height=string_copy(parser_material_parse_value_input(node->inputs->buffer[7],false));
			if(!parser_material_parse_height_as_channel){
				parser_material_is_frag=true;
			}
		}
	}
	return sout;
}

void parser_material_write(node_shader_t * raw,string_t * s){
	if(parser_material_is_frag){
		node_shader_write_frag(raw,s);
	}
	else {
		node_shader_write_vert(raw,s);
	}
}

string_t * parser_material_parse_vector_input(ui_node_socket_t * inp){
	ui_node_link_t * l=parser_material_get_input_link(inp);
	ui_node_t * from_node=l!=null?parser_material_get_node(l->from_id):null;
	if(from_node!=null){
		if(string_equals(from_node->type,"REROUTE")){
			return parser_material_parse_vector_input(from_node->inputs->buffer[0]);
		}
		string_t * res_var=parser_material_write_result(l);
		string_t * st=from_node->outputs->buffer[l->from_socket]->type;
		if(string_equals(st,"RGB")||string_equals(st,"RGBA")||string_equals(st,"VECTOR")){
			return res_var;
		}
		else {
			return parser_material_to_vec3(res_var);
		}
	}
	else {
		if(string_equals(inp->type,"VALUE")){
			return parser_material_vec3(f32_array_create_xyz(0.0,0.0,0.0));
		}
		else {
			return parser_material_vec3(inp->default_value);
		}
	}
}

void _parser_material_cache_tex_text_node(string_t * file,string_t * text){
	if(any_map_get(data_cached_images,file)==null){
		sys_notify_on_init(&_parser_material_cache_tex_text_node_85788		,text);
	}
}

void _parser_material_cache_tex_text_node_85788(string_t * text){
string_t * _text_tool_text=context_raw->text_tool_text;
		gpu_texture_t * _text_tool_image=context_raw->text_tool_image;
		context_raw->text_tool_text=string_copy(text);
		context_raw->text_tool_image=null;
		util_render_make_text_preview();
		string_t * file=string_join("tex_text_",text);
		any_map_set(data_cached_images,file,context_raw->text_tool_image);
		context_raw->text_tool_text=string_copy(_text_tool_text);
		context_raw->text_tool_image=_text_tool_image;
}

string_t * parser_material_parse_vector(ui_node_t * node,ui_node_socket_t * socket){
	if(string_equals(node->type,"GROUP")){
		return parser_material_parse_group(node,socket);
	}
	else if(string_equals(node->type,"GROUP_INPUT")){
		return parser_material_parse_group_input(node,socket);
	}
	else if(string_equals(node->type,"ATTRIBUTE")){
		if(socket==node->outputs->buffer[0]){
			if(parser_material_kong->context->allow_vcols){
				node_shader_context_add_elem(parser_material_kong->context,"col","short4norm");
				return "input.vcolor";
			}
			else {
				return ("float3(0.0, 0.0, 0.0)");
			}
		}
		else {
			node_shader_context_add_elem(parser_material_kong->context,"tex","short2norm");
			return "float3(tex_coord.x, tex_coord.y, 0.0)";
		}
	}
	else if(string_equals(node->type,"VERTEX_COLOR")){
		if(parser_material_kong->context->allow_vcols){
			node_shader_context_add_elem(parser_material_kong->context,"col","short4norm");
			return "input.vcolor";
		}
		else {
			return ("float3(0.0, 0.0, 0.0)");
		}
	}
	else if(string_equals(node->type,"RGB")){
		return parser_material_vec3(socket->default_value);
	}
	else if(string_equals(node->type,"TEX_BRICK")){
		node_shader_add_function(parser_material_kong,str_tex_brick);
		string_t * co=parser_material_get_coord(node);
		string_t * col1=parser_material_parse_vector_input(node->inputs->buffer[1]);
		string_t * col2=parser_material_parse_vector_input(node->inputs->buffer[2]);
		string_t * col3=parser_material_parse_vector_input(node->inputs->buffer[3]);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[4],false);
		string_t * res=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("tex_brick(",co)," * "),scale),", "),col1),", "),col2),", "),col3),")");
		return res;
	}
	else if(string_equals(node->type,"TEX_CHECKER")){
		node_shader_add_function(parser_material_kong,str_tex_checker);
		string_t * co=parser_material_get_coord(node);
		string_t * col1=parser_material_parse_vector_input(node->inputs->buffer[1]);
		string_t * col2=parser_material_parse_vector_input(node->inputs->buffer[2]);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[3],false);
		string_t * res=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("tex_checker(",co),", "),col1),", "),col2),", "),scale),")");
		return res;
	}
	else if(string_equals(node->type,"TEX_GRADIENT")){
		string_t * co=parser_material_get_coord(node);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * grad=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		grad=string_copy(string_replace_all(grad," ","_"));
		string_t * f=parser_material_get_gradient(grad,co);
		string_t * res=parser_material_to_vec3(string_join(string_join("clamp(",f),", 0.0, 1.0)"));
		return res;
	}
	else if(string_equals(node->type,"TEX_IMAGE")){
		if(char_ptr_array_index_of(parser_material_parsed,parser_material_res_var_name(node,node->outputs->buffer[1]))>=0){
			string_t * varname=parser_material_store_var_name(node);
			return string_join(varname,".rgb");
		}
		string_t * tex_name=parser_material_node_name(node,null);
		bind_tex_t * tex=parser_material_make_texture(node,tex_name);
		if(tex!=null){
			i32 color_space=node->buttons->buffer[1]->default_value->buffer[0];
			string_t * texstore=parser_material_texture_store(node,tex,tex_name,color_space);
			return string_join(texstore,".rgb");
		}
		else {
			string_t * tex_store=parser_material_store_var_name(node);
			parser_material_write(parser_material_kong,string_join(string_join("var ",tex_store),": float4 = float4(1.0, 0.0, 1.0, 1.0);"));
			return string_join(tex_store,".rgb");
		}
	}
	else if(string_equals(node->type,"TEX_TEXT")){
		string_t * tex_name=parser_material_node_name(node,null);
		buffer_t * text_buffer=node->buttons->buffer[0]->default_value;
		string_t * text=sys_buffer_to_string(text_buffer);
		string_t * file=string_join("tex_text_",text);
		_parser_material_cache_tex_text_node(file,text);
		bind_tex_t * tex=parser_material_make_bind_tex(tex_name,file);
		string_t * texstore=parser_material_texture_store(node,tex,tex_name,color_space_t_AUTO);
		return string_join(texstore,".rrr");
	}
	else if(string_equals(node->type,"TEX_MAGIC")){
		node_shader_add_function(parser_material_kong,str_tex_magic);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * res=string_join(string_join(string_join(string_join("tex_magic(",co)," * "),scale)," * 4.0)");
		return res;
	}
	else if(string_equals(node->type,"TEX_NOISE")){
		node_shader_add_function(parser_material_kong,str_tex_noise);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * res=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("float3(tex_noise(",co)," * "),scale),"), tex_noise("),co)," * "),scale)," + 0.33), tex_noise("),co)," * "),scale)," + 0.66))");
		return res;
	}
	else if(string_equals(node->type,"TEX_VORONOI")){
		node_shader_add_function(parser_material_kong,str_tex_voronoi);
		node_shader_add_texture(parser_material_kong,"snoise256","$noise256.k");
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * coloring=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		coloring=string_copy(string_replace_all(coloring," ","_"));
		string_t * res="";
		if(string_equals(coloring,"INTENSITY")){
			string_t * voronoi=string_join(string_join(string_join(string_join("tex_voronoi(",co)," * "),scale),").a");
			res=string_copy(parser_material_to_vec3(voronoi));
		}
		else {
			res=string_join(string_join(string_join(string_join("tex_voronoi(",co)," * "),scale),").rgb");
		}
		return res;
	}
	else if(string_equals(node->type,"TEX_WAVE")){
		node_shader_add_function(parser_material_kong,str_tex_wave);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * res=parser_material_to_vec3(string_join(string_join(string_join(string_join("tex_wave_f(",co)," * "),scale),")"));
		return res;
	}
	else if(string_equals(node->type,"BRIGHTCONTRAST")){
		string_t * out_col=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * bright=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * contr=parser_material_parse_value_input(node->inputs->buffer[2],false);
		node_shader_add_function(parser_material_kong,str_brightcontrast);
		return string_join(string_join(string_join(string_join(string_join(string_join("brightcontrast(",out_col),", "),bright),", "),contr),")");
	}
	else if(string_equals(node->type,"GAMMA")){
		string_t * out_col=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * gamma=parser_material_parse_value_input(node->inputs->buffer[1],false);
		return string_join(string_join(string_join(string_join("pow3(",out_col),", "),parser_material_to_vec3(gamma)),")");
	}
	else if(string_equals(node->type,"DIRECT_WARP")){
		if(parser_material_warp_passthrough){
			return parser_material_parse_vector_input(node->inputs->buffer[0]);
		}
		string_t * angle=parser_material_parse_value_input(node->inputs->buffer[1],true);
		string_t * mask=parser_material_parse_value_input(node->inputs->buffer[2],true);
		string_t * tex_name=string_join("texwarp_",parser_material_node_name(node,null));
		node_shader_add_texture(parser_material_kong,string_join("",tex_name),string_join("_",tex_name));
		string_t * store=parser_material_store_var_name(node);
		f32 pi=math_pi();
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("var ",store),"_rad: float = "),angle)," * ("),f32_to_string(pi))," / 180.0);"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_x: float = cos("),store),"_rad);"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_y: float = sin("),store),"_rad);"));
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("sample(",tex_name),", sampler_linear, tex_coord + float2("),store),"_x, "),store),"_y) * "),mask),").rgb");
	}
	else if(string_equals(node->type,"BLUR")){
		if(parser_material_blur_passthrough){
			return parser_material_parse_vector_input(node->inputs->buffer[0]);
		}
		string_t * strength=parser_material_parse_value_input(node->inputs->buffer[1],false);
		if(string_equals(strength,"0.0")){
			return "float3(0.0, 0.0, 0.0)";
		}
		string_t * steps=string_join(string_join("(",strength)," * 10.0 + 1.0)");
		string_t * tex_name=string_join("texblur_",parser_material_node_name(node,null));
		node_shader_add_texture(parser_material_kong,string_join("",tex_name),string_join("_",tex_name));
		node_shader_add_constant(parser_material_kong,string_join(string_join("",tex_name),"_size: float2"),string_join(string_join("_size(_",tex_name),")"));
		string_t * store=parser_material_store_var_name(node);
		parser_material_write(parser_material_kong,string_join(string_join("var ",store),"_res: float3 = float3(0.0, 0.0, 0.0);"));
		parser_material_write(parser_material_kong,string_join(string_join("for (var i: int = 0; i <= int(",steps)," * 2.0); i += 1) {"));
		parser_material_write(parser_material_kong,string_join(string_join("for (var j: int = 0; j <= int(",steps)," * 2.0); j += 1) {"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(store,"_res += sample("),tex_name),", sampler_linear, tex_coord + float2(float(i) - "),steps),", float(j) - "),steps),") / constants."),tex_name),"_size).rgb;"));
		parser_material_write(parser_material_kong,"}");
		parser_material_write(parser_material_kong,"}");
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join(string_join(store,"_res = "),store),"_res / ("),steps)," * 2.0 + 1.0) * ("),steps)," * 2.0 + 1.0);"));
		return string_join(store,"_res");
	}
	else if(string_equals(node->type,"HUE_SAT")){
		node_shader_add_function(parser_material_kong,str_hue_sat);
		string_t * hue=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * sat=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * val=parser_material_parse_value_input(node->inputs->buffer[2],false);
		string_t * fac=parser_material_parse_value_input(node->inputs->buffer[3],false);
		string_t * col=parser_material_parse_vector_input(node->inputs->buffer[4]);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("hue_sat(",col),", float4("),hue)," - 0.5, "),sat),", "),val),", 1.0 - "),fac),"))");
	}
	else if(string_equals(node->type,"INVERT")){
		string_t * fac=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * out_col=parser_material_parse_vector_input(node->inputs->buffer[1]);
		return string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",out_col),", float3(1.0, 1.0, 1.0) - ("),out_col),"), "),fac),")");
	}
	else if(string_equals(node->type,"MIX_RGB")){
		string_t * fac=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * fac_var=string_join(parser_material_node_name(node,null),"_fac");
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",fac_var),": float = "),fac),";"));
		string_t * col1=parser_material_parse_vector_input(node->inputs->buffer[1]);
		string_t * col2=parser_material_parse_vector_input(node->inputs->buffer[2]);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * blend=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		blend=string_copy(string_replace_all(blend," ","_"));
		bool use_clamp=node->buttons->buffer[1]->default_value->buffer[0]>0;
		string_t * out_col="";
		if(string_equals(blend,"MIX")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", "),col2),", "),fac_var),")");
		}
		else if(string_equals(blend,"DARKEN")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join("min3(",col1),", "),col2)," * "),fac_var),")");
		}
		else if(string_equals(blend,"MULTIPLY")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", "),col1)," * "),col2),", "),fac_var),")");
		}
		else if(string_equals(blend,"BURN")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", float3(1.0, 1.0, 1.0) - (float3(1.0, 1.0, 1.0) - "),col1),") / "),col2),", "),fac_var),")");
		}
		else if(string_equals(blend,"LIGHTEN")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join("max3(",col1),", "),col2)," * "),fac_var),")");
		}
		else if(string_equals(blend,"SCREEN")){
			string_t * v3=parser_material_to_vec3(string_join("1.0 - ",fac_var));
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(float3(1.0, 1.0, 1.0) - (",v3)," + "),fac_var)," * (float3(1.0, 1.0, 1.0) - "),col2),")) * (float3(1.0, 1.0, 1.0) - "),col1),"))");
		}
		else if(string_equals(blend,"DODGE")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", "),col1)," / (float3(1.0, 1.0, 1.0) - "),col2),"), "),fac_var),")");
		}
		else if(string_equals(blend,"ADD")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", "),col1)," + "),col2),", "),fac_var),")");
		}
		else if(string_equals(blend,"OVERLAY")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", float3( \
				"),col1),".r < 0.5 ? 2.0 * "),col1),".r * "),col2),".r : 1.0 - 2.0 * (1.0 - "),col1),".r) * (1.0 - "),col2),".r), \
				"),col1),".g < 0.5 ? 2.0 * "),col1),".g * "),col2),".g : 1.0 - 2.0 * (1.0 - "),col1),".g) * (1.0 - "),col2),".g), \
				"),col1),".b < 0.5 ? 2.0 * "),col1),".b * "),col2),".b : 1.0 - 2.0 * (1.0 - "),col1),".b) * (1.0 - "),col2),".b) \
			), "),fac_var),")");
		}
		else if(string_equals(blend,"SOFT_LIGHT")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("((1.0 - ",fac_var),") * "),col1)," + "),fac_var)," * ((float3(1.0, 1.0, 1.0) - "),col1),") * "),col2)," * "),col1)," + "),col1)," * (float3(1.0, 1.0, 1.0) - (float3(1.0, 1.0, 1.0) - "),col2),") * (float3(1.0, 1.0, 1.0) - "),col1),"))))");
		}
		else if(string_equals(blend,"LINEAR_LIGHT")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join("(",col1)," + "),fac_var)," * (float3(2.0, 2.0, 2.0) * ("),col2)," - float3(0.5, 0.5, 0.5))))");
		}
		else if(string_equals(blend,"DIFFERENCE")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", abs3("),col1)," - "),col2),"), "),fac_var),")");
		}
		else if(string_equals(blend,"SUBTRACT")){
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", "),col1)," - "),col2),", "),fac_var),")");
		}
		else if(string_equals(blend,"DIVIDE")){
			f32 eps=0.000001;
			col2=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("max3(",col2),", float3("),f32_to_string(eps)),", "),f32_to_string(eps)),", "),f32_to_string(eps)),"))");
			string_t * v3=parser_material_to_vec3(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(1.0 - ",fac_var),") * "),col1)," + "),fac_var)," * "),col1)," / "),col2));
			out_col=string_join(string_join("(",v3),")");
		}
		else if(string_equals(blend,"HUE")){
			node_shader_add_function(parser_material_kong,str_hue_sat);
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", hsv_to_rgb(float3(rgb_to_hsv("),col2),").r, rgb_to_hsv("),col1),").g, rgb_to_hsv("),col1),").b)), "),fac_var),")");
		}
		else if(string_equals(blend,"SATURATION")){
			node_shader_add_function(parser_material_kong,str_hue_sat);
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", hsv_to_rgb(float3(rgb_to_hsv("),col1),").r, rgb_to_hsv("),col2),").g, rgb_to_hsv("),col1),").b)), "),fac_var),")");
		}
		else if(string_equals(blend,"COLOR")){
			node_shader_add_function(parser_material_kong,str_hue_sat);
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", hsv_to_rgb(float3(rgb_to_hsv("),col2),").r, rgb_to_hsv("),col2),").g, rgb_to_hsv("),col1),").b)), "),fac_var),")");
		}
		else if(string_equals(blend,"VALUE")){
			node_shader_add_function(parser_material_kong,str_hue_sat);
			out_col=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",col1),", hsv_to_rgb(float3(rgb_to_hsv("),col1),").r, rgb_to_hsv("),col1),").g, rgb_to_hsv("),col2),").b)), "),fac_var),")");
		}
		if(use_clamp){
			return string_join(string_join("clamp3(",out_col),", float3(0.0, 0.0, 0.0), float3(1.0, 1.0, 1.0))");
		}
		else {
			return out_col;
		}
	}
	else if(string_equals(node->type,"QUANTIZE")){
		string_t * strength=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * col=parser_material_parse_vector_input(node->inputs->buffer[1]);
		return string_join(string_join(string_join(string_join(string_join(string_join("(floor3(100.0 * ",strength)," * "),col),") / (100.0 * "),strength),"))");
	}
	else if(string_equals(node->type,"REPLACECOL")){
		string_t * input_color=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * old_color=parser_material_parse_vector_input(node->inputs->buffer[1]);
		string_t * new_color=parser_material_parse_vector_input(node->inputs->buffer[2]);
		string_t * radius=parser_material_parse_value_input(node->inputs->buffer[3],false);
		string_t * fuzziness=parser_material_parse_value_input(node->inputs->buffer[4],false);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",new_color),", "),input_color),", clamp((distance("),old_color),", "),input_color),") - "),radius),") / max("),fuzziness),", "),f32_to_string(parser_material_eps)),"), 0.0, 1.0))");
	}
	else if(string_equals(node->type,"VALTORGB")){
		string_t * fac=parser_material_parse_value_input(node->inputs->buffer[0],false);
		i32 data0=node->buttons->buffer[0]->data->buffer[0];
		string_t * interp=data0==0?"LINEAR":"CONSTANT";
		f32_array_t * elems=node->buttons->buffer[0]->default_value;
		i32 len=elems->length/(float)5;
		if(len==1){
			return parser_material_vec3(elems);
		}
		string_t * cols_var=string_join(parser_material_node_name(node,null),"_cols");
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",cols_var),": float3["),i32_to_string(len)),"];"));
		for(i32 i=0;i<len;++i){
			f32_array_t * tmp=f32_array_create_from_raw((f32[]){},0);
			f32_array_push(tmp,elems->buffer[i*5]);
			f32_array_push(tmp,elems->buffer[i*5+1]);
			f32_array_push(tmp,elems->buffer[i*5+2]);
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(cols_var,"["),i32_to_string(i)),"] = "),parser_material_vec3(tmp)),";"));
		}
		string_t * fac_var=string_join(parser_material_node_name(node,null),"_fac");
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",fac_var),": float = "),fac),";"));
		string_t * index="0";
		for(i32 i=1;i<len;++i){
			f32 e=elems->buffer[i*5+4];
			index=string_join(index,string_join(string_join(string_join(string_join(" + (",fac_var)," > "),f32_to_string(e))," ? 1 : 0)"));
		}
		string_t * index_var=string_join(parser_material_node_name(node,null),"_i");
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",index_var),": int = "),index),";"));
		if(string_equals(interp,"CONSTANT")){
			return string_join(string_join(string_join(cols_var,"["),index_var),"]");
		}
		else {
			string_t * facs_var=string_join(parser_material_node_name(node,null),"_facs");
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",facs_var),": float["),i32_to_string(len)),"];"));
			for(i32 i=0;i<len;++i){
				f32 e=elems->buffer[i*5+4];
				parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(facs_var,"["),i32_to_string(i)),"] = "),f32_to_string(e)),";"));
			}
			return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cols_var),"["),index_var),"], "),cols_var),"["),index_var)," + 1], ("),fac_var)," - "),facs_var),"["),index_var),"]) * (1.0 / ("),facs_var),"["),index_var)," + 1] - "),facs_var),"["),index_var),"]) ))");
		}
	}
	else if(string_equals(node->type,"CURVE_VEC")){
		string_t * fac=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * vec=parser_material_parse_vector_input(node->inputs->buffer[1]);
		f32_array_t * curves=node->buttons->buffer[0]->default_value;
		if(curves->buffer[96]==0.0){
			curves->buffer[96]=1.0;
			curves->buffer[97]=1.0;
			curves->buffer[98]=1.0;
		}
		string_t * name=parser_material_node_name(node,null);
		string_t * vc0=parser_material_vector_curve(string_join(name,"0"),string_join(vec,".x"),curves->buffer+32*0,curves->buffer[96]);
		string_t * vc1=parser_material_vector_curve(string_join(name,"1"),string_join(vec,".y"),curves->buffer+32*1,curves->buffer[97]);
		string_t * vc2=parser_material_vector_curve(string_join(name,"2"),string_join(vec,".z"),curves->buffer+32*2,curves->buffer[98]);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(float3(",vc0),", "),vc1),", "),vc2),") * "),fac),")");
	}
	else if(string_equals(node->type,"COMBHSV")){
		node_shader_add_function(parser_material_kong,str_hue_sat);
		string_t * h=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * s=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * v=parser_material_parse_value_input(node->inputs->buffer[2],false);
		return string_join(string_join(string_join(string_join(string_join(string_join("hsv_to_rgb(float3(",h),", "),s),", "),v),"))");
	}
	else if(string_equals(node->type,"COMBRGB")){
		string_t * r=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * g=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * b=parser_material_parse_value_input(node->inputs->buffer[2],false);
		return string_join(string_join(string_join(string_join(string_join(string_join("float3(",r),", "),g),", "),b),")");
	}
	else if(string_equals(node->type,"WAVELENGTH")){
		node_shader_add_function(parser_material_kong,str_wavelength_to_rgb);
		string_t * wl=parser_material_parse_value_input(node->inputs->buffer[0],false);
		node_shader_add_function(parser_material_kong,str_wavelength_to_rgb);
		return string_join(string_join("wavelength_to_rgb((",wl)," - 450.0) / 150.0)");
	}
	else if(string_equals(node->type,"CAMERA")){
		parser_material_kong->frag_vvec_cam=true;
		return "vvec_cam";
	}
	else if(string_equals(node->type,"LAYER")){
		any l=node->buttons->buffer[0]->default_value;
		if(socket==node->outputs->buffer[0]){
			node_shader_add_texture(parser_material_kong,string_join("texpaint",l),string_join("_texpaint",l));
			return string_join(string_join("sample(texpaint",l),", sampler_linear, tex_coord).rgb");
		}
		else if(socket==node->outputs->buffer[5]){
			node_shader_add_texture(parser_material_kong,string_join("texpaint_nor",l),string_join("_texpaint_nor",l));
			return string_join(string_join("sample(texpaint_nor",l),", sampler_linear, tex_coord).rgb");
		}
	}
	else if(string_equals(node->type,"MATERIAL")){
		string_t * result="float3(0.0, 0.0, 0.0)";
		i32 mi=node->buttons->buffer[0]->default_value->buffer[0];
		if(mi>=project_materials->length){
			return result;
		}
		slot_material_t * m=project_materials->buffer[mi];
		ui_node_t_array_t * _nodes=parser_material_nodes;
		ui_node_link_t_array_t * _links=parser_material_links;
		gc_unroot(parser_material_nodes);parser_material_nodes=m->canvas->nodes;gc_root(parser_material_nodes);
		gc_unroot(parser_material_links);parser_material_links=m->canvas->links;gc_root(parser_material_links);
		any_array_push(parser_material_parents,node);
		ui_node_t * output_node=parser_material_node_by_type(parser_material_nodes,"OUTPUT_MATERIAL_PBR");
		if(socket==node->outputs->buffer[0]){
			result=string_copy(parser_material_parse_vector_input(output_node->inputs->buffer[0]));
		}
		else if(socket==node->outputs->buffer[5]){
			result=string_copy(parser_material_parse_vector_input(output_node->inputs->buffer[5]));
		}
		gc_unroot(parser_material_nodes);parser_material_nodes=_nodes;gc_root(parser_material_nodes);
		gc_unroot(parser_material_links);parser_material_links=_links;gc_root(parser_material_links);
		array_pop(parser_material_parents);
		return result;
	}
	else if(string_equals(node->type,"PICKER")){
		if(socket==node->outputs->buffer[0]){
			node_shader_add_constant(parser_material_kong,"picker_base: float3","_picker_base");
			return "constants.picker_base";
		}
		else if(socket==node->outputs->buffer[5]){
			node_shader_add_constant(parser_material_kong,"picker_normal: float3","_picker_normal");
			return "constants.picker_normal";
		}
	}
	else if(string_equals(node->type,"NEW_GEOMETRY")){
		if(socket==node->outputs->buffer[0]){
			parser_material_kong->frag_wposition=true;
			return "input.wposition";
		}
		else if(socket==node->outputs->buffer[1]){
			parser_material_kong->frag_n=true;
			return "n";
		}
		else if(socket==node->outputs->buffer[2]){
			parser_material_kong->frag_wtangent=true;
			return "input.wtangent";
		}
		else if(socket==node->outputs->buffer[3]){
			parser_material_kong->frag_n=true;
			return "n";
		}
		else if(socket==node->outputs->buffer[4]){
			parser_material_kong->frag_vvec=true;
			return "vvec";
		}
		else if(socket==node->outputs->buffer[5]){
			parser_material_kong->frag_mposition=true;
			return "input.mposition";
		}
	}
	else if(string_equals(node->type,"OBJECT_INFO")){
		if(socket==node->outputs->buffer[0]){
			parser_material_kong->frag_wposition=true;
			return "input.wposition";
		}
		else if(socket==node->outputs->buffer[1]){
			return "float3(0.0, 0.0, 0.0)";
		}
	}
	else if(string_equals(node->type,"TANGENT")){
		parser_material_kong->frag_wtangent=true;
		return "input.wtangent";
	}
	else if(string_equals(node->type,"TEX_COORD")){
		if(socket==node->outputs->buffer[0]){
			parser_material_kong->frag_bposition=true;
			return "bposition";
		}
		else if(socket==node->outputs->buffer[1]){
			parser_material_kong->frag_n=true;
			return "n";
		}
		else if(socket==node->outputs->buffer[2]){
			node_shader_context_add_elem(parser_material_kong->context,"tex","short2norm");
			return "float3(tex_coord.x, tex_coord.y, 0.0)";
		}
		else if(socket==node->outputs->buffer[3]){
			parser_material_kong->frag_mposition=true;
			return "input.mposition";
		}
		else if(socket==node->outputs->buffer[4]){
			parser_material_kong->frag_vposition=true;
			return "input.vposition";
		}
		else if(socket==node->outputs->buffer[5]){
			parser_material_kong->frag_wvpposition=true;
			return "input.wvpposition.xyz";
		}
		else if(socket==node->outputs->buffer[6]){
			return "float3(0.0, 0.0, 0.0)";
		}
	}
	else if(string_equals(node->type,"UVMAP")){
		node_shader_context_add_elem(parser_material_kong->context,"tex","short2norm");
		return "float3(tex_coord.x, tex_coord.y, 0.0)";
	}
	else if(string_equals(node->type,"BUMP")){
		string_t * strength=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * height=parser_material_parse_value_input(node->inputs->buffer[2],false);
		string_t * nor=parser_material_parse_vector_input(node->inputs->buffer[3]);
		string_t * sample_bump_res=string_join(parser_material_store_var_name(node),"_bump");
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("var ",sample_bump_res),"_x: float = ddx(float("),height),")) * ("),strength),") * 16.0;"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("var ",sample_bump_res),"_y: float = ddy(float("),height),")) * ("),strength),") * 16.0;"));
		return string_join(string_join(string_join(string_join(string_join(string_join("(normalize(float3(",sample_bump_res),"_x, "),sample_bump_res),"_y, 1.0) + "),nor),") * float3(0.5, 0.5, 0.5) + float3(0.5, 0.5, 0.5))");
	}
	else if(string_equals(node->type,"MAPPING")){
		string_t * out=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * node_translation=parser_material_parse_vector_input(node->inputs->buffer[1]);
		string_t * node_rotation=parser_material_parse_vector_input(node->inputs->buffer[2]);
		string_t * node_scale=parser_material_parse_vector_input(node->inputs->buffer[3]);
		if(!string_equals(node_scale,"float3(1, 1, 1)")){
			out=string_join(string_join(string_join(string_join("(",out)," * "),node_scale),")");
		}
		if(!string_equals(node_rotation,"float3(0, 0, 0)")){
			string_t * a=string_join(node_rotation,".z * (3.1415926535 / 180)");
			out=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("float3(",out),".x * cos("),a),") - "),out),".y * sin("),a),"), "),out),".x * sin("),a),") + "),out),".y * cos("),a),"), 0.0)");
		}
		if(!string_equals(node_translation,"float3(0, 0, 0)")){
			out=string_join(string_join(string_join(string_join("(",out)," + "),node_translation),")");
		}
		return out;
	}
	else if(string_equals(node->type,"NORMAL")){
		if(socket==node->outputs->buffer[0]){
			return parser_material_vec3(node->outputs->buffer[0]->default_value);
		}
		else if(socket==node->outputs->buffer[1]){
			string_t * nor=parser_material_parse_vector_input(node->inputs->buffer[0]);
			string_t * norout=parser_material_vec3(node->outputs->buffer[0]->default_value);
			return parser_material_to_vec3(string_join(string_join(string_join(string_join("dot(",norout),", "),nor),")"));
		}
	}
	else if(string_equals(node->type,"NORMAL_MAP")){
		string_t * strength=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * norm=parser_material_parse_vector_input(node->inputs->buffer[1]);
		string_t * store=parser_material_store_var_name(node);
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_texn: float3 = "),norm)," * 2.0 - 1.0;"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("",store),"_texn.xy = "),strength)," * "),store),"_texn.xy;"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("",store),"_texn = normalize("),store),"_texn);"));
		return string_join(string_join("(0.5 * ",store),"_texn + 0.5)");
	}
	else if(string_equals(node->type,"MIX_NORMAL_MAP")){
		string_t * nm1=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * nm2=parser_material_parse_vector_input(node->inputs->buffer[1]);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * blend=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		blend=string_copy(string_replace_all(blend," ","_"));
		string_t * store=parser_material_store_var_name(node);
		if(string_equals(blend,"PARTIAL_DERIVATIVE")){
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_n1: float3 = "),nm1)," * 2.0 - 1.0;"));
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_n2: float3 = "),nm2)," * 2.0 - 1.0;"));
			return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("0.5 * normalize(float3(",store),"_n1.xy * "),store),"_n2.z + "),store),"_n2.xy * "),store),"_n1.z, "),store),"_n1.z * "),store),"_n2.z)) + 0.5");
		}
		else if(string_equals(blend,"WHITEOUT")){
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_n1: float3 = "),nm1)," * 2.0 - 1.0;"));
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_n2: float3 = "),nm2)," * 2.0 - 1.0;"));
			return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("0.5 * normalize(float3(",store),"_n1.xy + "),store),"_n2.xy, "),store),"_n1.z * "),store),"_n2.z)) + 0.5");
		}
		else if(string_equals(blend,"REORIENTED")){
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_n1: float3 = "),nm1)," * 2.0 - float3(1.0, 1.0, 0.0);"));
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_n2: float3 = "),nm2)," * float3(-2.0, -2.0, 2.0) - float3(-1.0, -1.0, 1.0);"));
			return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("0.5 * normalize(",store),"_n1 * dot("),store),"_n1, "),store),"_n2) - "),store),"_n2 * "),store),"_n1.z) + 0.5");
		}
	}
	else if(string_equals(node->type,"VECT_TRANSFORM")){
	}
	else if(string_equals(node->type,"COMBXYZ")){
		string_t * x=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * y=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * z=parser_material_parse_value_input(node->inputs->buffer[2],false);
		return string_join(string_join(string_join(string_join(string_join(string_join("float3(",x),", "),y),", "),z),")");
	}
	else if(string_equals(node->type,"VECT_MATH")){
		string_t * vec1=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * vec2=parser_material_parse_vector_input(node->inputs->buffer[1]);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * op=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		op=string_copy(string_replace_all(op," ","_"));
		if(string_equals(op,"ADD")){
			return string_join(string_join(string_join(string_join("(",vec1)," + "),vec2),")");
		}
		else if(string_equals(op,"SUBTRACT")){
			return string_join(string_join(string_join(string_join("(",vec1)," - "),vec2),")");
		}
		else if(string_equals(op,"AVERAGE")){
			return string_join(string_join(string_join(string_join("((",vec1)," + "),vec2),") / 2.0)");
		}
		else if(string_equals(op,"DOT_PRODUCT")){
			return parser_material_to_vec3(string_join(string_join(string_join(string_join("dot(",vec1),", "),vec2),")"));
		}
		else if(string_equals(op,"LENGTH")){
			return parser_material_to_vec3(string_join(string_join("length(",vec1),")"));
		}
		else if(string_equals(op,"DISTANCE")){
			return parser_material_to_vec3(string_join(string_join(string_join(string_join("distance(",vec1),", "),vec2),")"));
		}
		else if(string_equals(op,"CROSS_PRODUCT")){
			return string_join(string_join(string_join(string_join("cross(",vec1),", "),vec2),")");
		}
		else if(string_equals(op,"NORMALIZE")){
			return string_join(string_join("normalize(",vec1),")");
		}
		else if(string_equals(op,"MULTIPLY")){
			return string_join(string_join(string_join(string_join("(",vec1)," * "),vec2),")");
		}
		else if(string_equals(op,"DIVIDE")){
			return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("float3(",vec1),".x / ("),vec2),".x == 0 ? 0.000001 : "),vec2),".x), "),vec1),".y / ("),vec2),".y == 0 ? 0.000001 : "),vec2),".y), "),vec1),".z / ("),vec2),".z == 0 ? 0.000001 : "),vec2),".z))");
		}
		else if(string_equals(op,"PROJECT")){
			return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(dot(",vec1),", "),vec2),") / dot("),vec2),", "),vec2),") * "),vec2),")");
		}
		else if(string_equals(op,"REFLECT")){
			return string_join(string_join(string_join(string_join("reflect(",vec1),", normalize("),vec2),"))");
		}
		else if(string_equals(op,"SCALE")){
			return string_join(string_join(string_join(string_join("(",vec2),".x * "),vec1),")");
		}
		else if(string_equals(op,"ABSOLUTE")){
			return string_join(string_join("abs3(",vec1),")");
		}
		else if(string_equals(op,"MINIMUM")){
			return string_join(string_join(string_join(string_join("min3(",vec1),", "),vec2),")");
		}
		else if(string_equals(op,"MAXIMUM")){
			return string_join(string_join(string_join(string_join("max3(",vec1),", "),vec2),")");
		}
		else if(string_equals(op,"FLOOR")){
			return string_join(string_join("floor3(",vec1),")");
		}
		else if(string_equals(op,"CEIL")){
			return string_join(string_join("ceil3(",vec1),")");
		}
		else if(string_equals(op,"FRACTION")){
			return string_join(string_join("frac3(",vec1),")");
		}
		else if(string_equals(op,"MODULO")){
			return string_join(string_join(string_join(string_join("(",vec1)," % "),vec2),")");
		}
		else if(string_equals(op,"SNAP")){
			return string_join(string_join(string_join(string_join(string_join(string_join("(floor3(",vec1)," / "),vec2),") * "),vec2),")");
		}
		else if(string_equals(op,"SINE")){
			return string_join(string_join("sin(",vec1),")");
		}
		else if(string_equals(op,"COSINE")){
			return string_join(string_join("cos(",vec1),")");
		}
		else if(string_equals(op,"TANGENT")){
			return string_join(string_join("tan(",vec1),")");
		}
	}
	else if(string_equals(node->type,"Displacement")){
		string_t * height=parser_material_parse_value_input(node->inputs->buffer[0],false);
		return parser_material_to_vec3(height);
	}
	else if(any_map_get(parser_material_custom_nodes,node->type)!=null){
		any cb=any_map_get(parser_material_custom_nodes,node->type);
		return js_call_ptr_str(cb,node,socket->name);
	}
	return "float3(0.0, 0.0, 0.0)";
}

void parse_normal_map_color_input(ui_node_socket_t * inp){
	parser_material_kong->frag_write_normal++;
	gc_unroot(parser_material_out_normaltan);parser_material_out_normaltan=string_copy(parser_material_parse_vector_input(inp));gc_root(parser_material_out_normaltan);
	bool _parser_material_is_frag=parser_material_is_frag;
	parser_material_is_frag=true;
	if(!parser_material_arm_export_tangents){
		parser_material_write(parser_material_kong,string_join(string_join("var texn: float3 = (",parser_material_out_normaltan),") * 2.0 - 1.0;"));
		parser_material_write(parser_material_kong,"texn.y = -texn.y;");
		if(!parser_material_cotangent_frame_written){
			parser_material_cotangent_frame_written=true;
			node_shader_add_function(parser_material_kong,str_cotangent_frame);
		}
		parser_material_kong->frag_n=true;
		parser_material_write(parser_material_kong,"var TBN: float3x3 = cotangent_frame(n, vvec, tex_coord);");
		parser_material_write(parser_material_kong,"n = TBN * normalize(texn);");
	}
	parser_material_is_frag=_parser_material_is_frag;
	parser_material_kong->frag_write_normal--;
}

string_t * parser_material_parse_value_input(ui_node_socket_t * inp,bool vector_as_grayscale){
	ui_node_link_t * l=parser_material_get_input_link(inp);
	ui_node_t * from_node=l!=null?parser_material_get_node(l->from_id):null;
	if(from_node!=null){
		if(string_equals(from_node->type,"REROUTE")){
			return parser_material_parse_value_input(from_node->inputs->buffer[0],false);
		}
		string_t * res_var=parser_material_write_result(l);
		string_t * st=from_node->outputs->buffer[l->from_socket]->type;
		if(string_equals(st,"RGB")||string_equals(st,"RGBA")||string_equals(st,"VECTOR")){
			if(vector_as_grayscale){
				return string_join(string_join("dot(",res_var),".rbg, float3(0.299, 0.587, 0.114))");
			}
			else {
				return string_join(res_var,".x");
			}
		}
		else {
			return res_var;
		}
	}
	else {
		return parser_material_vec1(inp->default_value->buffer[0]);
	}
}

string_t * parser_material_parse_value(ui_node_t * node,ui_node_socket_t * socket){
	if(string_equals(node->type,"GROUP")){
		return parser_material_parse_group(node,socket);
	}
	else if(string_equals(node->type,"GROUP_INPUT")){
		return parser_material_parse_group_input(node,socket);
	}
	else if(string_equals(node->type,"ATTRIBUTE")){
		node_shader_add_constant(parser_material_kong,"time: float","_time");
		return "constants.time";
	}
	else if(string_equals(node->type,"VERTEX_COLOR")){
		return "1.0";
	}
	else if(string_equals(node->type,"WIREFRAME")){
		node_shader_add_texture(parser_material_kong,"texuvmap","_texuvmap");
		return "sample_lod(texuvmap, sampler_linear, tex_coord, 0.0).r";
	}
	else if(string_equals(node->type,"CAMERA")){
		if(socket==node->outputs->buffer[1]){
			node_shader_add_constant(parser_material_kong,"camera_proj: float2","_camera_plane_proj");
			parser_material_kong->frag_wvpposition=true;
			return "(constants.camera_proj.y / ((input.wvpposition.z / input.wvpposition.w) - constants.camera_proj.x))";
		}
		else {
			node_shader_add_constant(parser_material_kong,"eye: float3","_camera_pos");
			parser_material_kong->frag_wposition=true;
			return "distance(constants.eye, input.wposition)";
		}
	}
	else if(string_equals(node->type,"LAYER")){
		any l=node->buttons->buffer[0]->default_value;
		if(socket==node->outputs->buffer[1]){
			node_shader_add_texture(parser_material_kong,string_join("texpaint",l),string_join("_texpaint",l));
			return string_join(string_join("sample(texpaint",l),", sampler_linear, tex_coord).a");
		}
		else if(socket==node->outputs->buffer[2]){
			node_shader_add_texture(parser_material_kong,string_join("texpaint_pack",l),string_join("_texpaint_pack",l));
			return string_join(string_join("sample(texpaint_pack",l),", sampler_linear, tex_coord).r");
		}
		else if(socket==node->outputs->buffer[3]){
			node_shader_add_texture(parser_material_kong,string_join("texpaint_pack",l),string_join("_texpaint_pack",l));
			return string_join(string_join("sample(texpaint_pack",l),", sampler_linear, tex_coord).g");
		}
		else if(socket==node->outputs->buffer[4]){
			node_shader_add_texture(parser_material_kong,string_join("texpaint_pack",l),string_join("_texpaint_pack",l));
			return string_join(string_join("sample(texpaint_pack",l),", sampler_linear, tex_coord).b");
		}
		else if(socket==node->outputs->buffer[7]){
			node_shader_add_texture(parser_material_kong,string_join("texpaint_pack",l),string_join("_texpaint_pack",l));
			return string_join(string_join("sample(texpaint_pack",l),", sampler_linear, tex_coord).a");
		}
	}
	else if(string_equals(node->type,"LAYER_MASK")){
		if(socket==node->outputs->buffer[0]){
			any l=node->buttons->buffer[0]->default_value;
			node_shader_add_texture(parser_material_kong,string_join("texpaint",l),string_join("_texpaint",l));
			return string_join(string_join("sample(texpaint",l),", sampler_linear, tex_coord).r");
		}
	}
	else if(string_equals(node->type,"MATERIAL")){
		string_t * result="0.0";
		i32 mi=node->buttons->buffer[0]->default_value->buffer[0];
		if(mi>=project_materials->length)return result;
		slot_material_t * m=project_materials->buffer[mi];
		ui_node_t_array_t * _nodes=parser_material_nodes;
		ui_node_link_t_array_t * _links=parser_material_links;
		gc_unroot(parser_material_nodes);parser_material_nodes=m->canvas->nodes;gc_root(parser_material_nodes);
		gc_unroot(parser_material_links);parser_material_links=m->canvas->links;gc_root(parser_material_links);
		any_array_push(parser_material_parents,node);
		ui_node_t * output_node=parser_material_node_by_type(parser_material_nodes,"OUTPUT_MATERIAL_PBR");
		if(socket==node->outputs->buffer[1]){
			result=string_copy(parser_material_parse_value_input(output_node->inputs->buffer[1],false));
		}
		else if(socket==node->outputs->buffer[2]){
			result=string_copy(parser_material_parse_value_input(output_node->inputs->buffer[2],false));
		}
		else if(socket==node->outputs->buffer[3]){
			result=string_copy(parser_material_parse_value_input(output_node->inputs->buffer[3],false));
		}
		else if(socket==node->outputs->buffer[4]){
			result=string_copy(parser_material_parse_value_input(output_node->inputs->buffer[4],false));
		}
		else if(socket==node->outputs->buffer[7]){
			result=string_copy(parser_material_parse_value_input(output_node->inputs->buffer[7],false));
		}
		gc_unroot(parser_material_nodes);parser_material_nodes=_nodes;gc_root(parser_material_nodes);
		gc_unroot(parser_material_links);parser_material_links=_links;gc_root(parser_material_links);
		array_pop(parser_material_parents);
		return result;
	}
	else if(string_equals(node->type,"PICKER")){
		if(socket==node->outputs->buffer[1]){
			node_shader_add_constant(parser_material_kong,"picker_opacity: float","_picker_opacity");
			return "constants.picker_opacity";
		}
		else if(socket==node->outputs->buffer[2]){
			node_shader_add_constant(parser_material_kong,"picker_occlusion: float","_picker_occlusion");
			return "constants.picker_occlusion";
		}
		else if(socket==node->outputs->buffer[3]){
			node_shader_add_constant(parser_material_kong,"picker_roughness: float","_picker_roughness");
			return "constants.picker_roughness";
		}
		else if(socket==node->outputs->buffer[4]){
			node_shader_add_constant(parser_material_kong,"picker_metallic: float","_picker_metallic");
			return "constants.picker_metallic";
		}
		else if(socket==node->outputs->buffer[7]){
			node_shader_add_constant(parser_material_kong,"picker_height: float","_picker_height");
			return "constants.picker_height";
		}
	}
	else if(string_equals(node->type,"FRESNEL")){
		string_t * ior=parser_material_parse_value_input(node->inputs->buffer[0],false);
		parser_material_kong->frag_dotnv=true;
		return string_join(string_join("pow(1.0 - dotnv, 7.25 / ",ior),")");
	}
	else if(string_equals(node->type,"NEW_GEOMETRY")){
		if(socket==node->outputs->buffer[6]){
			return "0.0";
		}
		else if(socket==node->outputs->buffer[7]){
			f32 strength=1.0;
			f32 radius=1.0;
			f32 offset=0.0;
			string_t * store=parser_material_store_var_name(node);
			parser_material_kong->frag_n=true;
			parser_material_write(parser_material_kong,string_join(string_join("var ",store),"_dx: float3 = ddx3(n);"));
			parser_material_write(parser_material_kong,string_join(string_join("var ",store),"_dy: float3 = ddy3(n);"));
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("var ",store),"_curvature: float = max(dot("),store),"_dx, "),store),"_dx), dot("),store),"_dy, "),store),"_dy));"));
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(store,"_curvature = clamp(pow("),store),"_curvature, (1.0 / "),f32_to_string(radius)),") * 0.25) * "),f32_to_string(strength))," * 2.0 + "),f32_to_string(offset))," / 10.0, 0.0, 1.0);"));
			return string_join(store,"_curvature");
		}
		else if(socket==node->outputs->buffer[8]){
			return "0.0";
		}
	}
	else if(string_equals(node->type,"HAIR_INFO")){
		return "0.5";
	}
	else if(string_equals(node->type,"LAYER_WEIGHT")){
		string_t * blend=parser_material_parse_value_input(node->inputs->buffer[0],false);
		if(socket==node->outputs->buffer[0]){
			parser_material_kong->frag_dotnv=true;
			return string_join(string_join("clamp(pow(1.0 - dotnv, (1.0 - ",blend),") * 10.0), 0.0, 1.0)");
		}
		else if(socket==node->outputs->buffer[1]){
			parser_material_kong->frag_dotnv=true;
			return string_join(string_join("((1.0 - dotnv) * ",blend),")");
		}
	}
	else if(string_equals(node->type,"OBJECT_INFO")){
		if(socket==node->outputs->buffer[1]){
			node_shader_add_constant(parser_material_kong,"object_info_index: float","_object_info_index");
			return "constants.object_info_index";
		}
		else if(socket==node->outputs->buffer[2]){
			node_shader_add_constant(parser_material_kong,"object_info_material_index: float","_object_info_material_index");
			return "constants.object_info_material_index";
		}
		else if(socket==node->outputs->buffer[3]){
			node_shader_add_constant(parser_material_kong,"object_info_random: float","_object_info_random");
			return "constants.object_info_random";
		}
	}
	else if(string_equals(node->type,"VALUE")){
		return parser_material_vec1(node->outputs->buffer[0]->default_value->buffer[0]);
	}
	else if(string_equals(node->type,"TEX_BRICK")){
		node_shader_add_function(parser_material_kong,str_tex_brick);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[4],false);
		string_t * res=string_join(string_join(string_join(string_join("tex_brick_f(",co)," * "),scale),")");
		return res;
	}
	else if(string_equals(node->type,"TEX_CHECKER")){
		node_shader_add_function(parser_material_kong,str_tex_checker);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[3],false);
		string_t * res=string_join(string_join(string_join(string_join("tex_checker_f(",co),", "),scale),")");
		return res;
	}
	else if(string_equals(node->type,"TEX_GRADIENT")){
		string_t * co=parser_material_get_coord(node);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * grad=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		grad=string_copy(string_replace_all(grad," ","_"));
		string_t * f=parser_material_get_gradient(grad,co);
		string_t * res=string_join(string_join("(clamp(",f),", 0.0, 1.0))");
		return res;
	}
	else if(string_equals(node->type,"TEX_IMAGE")){
		if(char_ptr_array_index_of(parser_material_parsed,parser_material_res_var_name(node,node->outputs->buffer[0]))>=0){
			string_t * varname=parser_material_store_var_name(node);
			return string_join(varname,".a");
		}
		string_t * tex_name=parser_material_node_name(node,null);
		bind_tex_t * tex=parser_material_make_texture(node,tex_name);
		if(tex!=null){
			i32 color_space=node->buttons->buffer[1]->default_value->buffer[0];
			string_t * texstore=parser_material_texture_store(node,tex,tex_name,color_space);
			return string_join(texstore,".a");
		}
	}
	else if(string_equals(node->type,"TEX_TEXT")){
		string_t * tex_name=parser_material_node_name(node,null);
		buffer_t * text_buffer=node->buttons->buffer[0]->default_value;
		string_t * text=sys_buffer_to_string(text_buffer);
		string_t * file=string_join("tex_text_",text);
		_parser_material_cache_tex_text_node(file,text);
		bind_tex_t * tex=parser_material_make_bind_tex(tex_name,file);
		string_t * texstore=parser_material_texture_store(node,tex,tex_name,color_space_t_AUTO);
		return string_join(texstore,".r");
	}
	else if(string_equals(node->type,"TEX_MAGIC")){
		node_shader_add_function(parser_material_kong,str_tex_magic);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * res=string_join(string_join(string_join(string_join("tex_magic_f(",co)," * "),scale)," * 4.0)");
		return res;
	}
	else if(string_equals(node->type,"TEX_MUSGRAVE")){
		node_shader_add_function(parser_material_kong,str_tex_musgrave);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * res=string_join(string_join(string_join(string_join("tex_musgrave_f(",co)," * "),scale)," * 0.5)");
		return res;
	}
	else if(string_equals(node->type,"TEX_NOISE")){
		node_shader_add_function(parser_material_kong,str_tex_noise);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * res=string_join(string_join(string_join(string_join("tex_noise(",co)," * "),scale),")");
		return res;
	}
	else if(string_equals(node->type,"TEX_VORONOI")){
		node_shader_add_function(parser_material_kong,str_tex_voronoi);
		node_shader_add_texture(parser_material_kong,"snoise256","$noise256.k");
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * coloring=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		coloring=string_copy(string_replace_all(coloring," ","_"));
		string_t * res="";
		if(string_equals(coloring,"INTENSITY")){
			res=string_join(string_join(string_join(string_join("tex_voronoi(",co)," * "),scale),").a");
		}
		else {
			res=string_join(string_join(string_join(string_join("tex_voronoi(",co)," * "),scale),").r");
		}
		return res;
	}
	else if(string_equals(node->type,"TEX_WAVE")){
		node_shader_add_function(parser_material_kong,str_tex_wave);
		string_t * co=parser_material_get_coord(node);
		string_t * scale=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * res=string_join(string_join(string_join(string_join("tex_wave_f(",co)," * "),scale),")");
		return res;
	}
	else if(string_equals(node->type,"BAKE_CURVATURE")){
		if(parser_material_bake_passthrough){
			gc_unroot(parser_material_bake_passthrough_strength);parser_material_bake_passthrough_strength=string_copy(parser_material_parse_value_input(node->inputs->buffer[0],false));gc_root(parser_material_bake_passthrough_strength);
			gc_unroot(parser_material_bake_passthrough_radius);parser_material_bake_passthrough_radius=string_copy(parser_material_parse_value_input(node->inputs->buffer[1],false));gc_root(parser_material_bake_passthrough_radius);
			gc_unroot(parser_material_bake_passthrough_offset);parser_material_bake_passthrough_offset=string_copy(parser_material_parse_value_input(node->inputs->buffer[2],false));gc_root(parser_material_bake_passthrough_offset);
			return "0.0";
		}
		string_t * tex_name=string_join("texbake_",parser_material_node_name(node,null));
		node_shader_add_texture(parser_material_kong,string_join("",tex_name),string_join("_",tex_name));
		string_t * store=parser_material_store_var_name(node);
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",store),"_res: float = sample("),tex_name),", sampler_linear, tex_coord).r;"));
		return string_join(store,"_res");
	}
	else if(string_equals(node->type,"NORMAL")){
		string_t * nor=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * norout=parser_material_vec3(node->outputs->buffer[0]->default_value);
		return string_join(string_join(string_join(string_join("dot(",norout),", "),nor),")");
	}
	else if(string_equals(node->type,"COLMASK")){
		string_t * input_color=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * mask_color=parser_material_parse_vector_input(node->inputs->buffer[1]);
		string_t * radius=parser_material_parse_value_input(node->inputs->buffer[2],false);
		string_t * fuzziness=parser_material_parse_value_input(node->inputs->buffer[3],false);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("clamp(1.0 - (distance(",input_color),", "),mask_color),") - "),radius),") / max("),fuzziness),", "),f32_to_string(parser_material_eps)),"), 0.0, 1.0)");
	}
	else if(string_equals(node->type,"MATH")){
		string_t * val1=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * val2=parser_material_parse_value_input(node->inputs->buffer[1],false);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * op=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		op=string_copy(string_replace_all(op," ","_"));
		bool use_clamp=node->buttons->buffer[1]->default_value->buffer[0]>0;
		string_t * out_val="";
		if(string_equals(op,"ADD")){
			out_val=string_join(string_join(string_join(string_join("(",val1)," + "),val2),")");
		}
		else if(string_equals(op,"SUBTRACT")){
			out_val=string_join(string_join(string_join(string_join("(",val1)," - "),val2),")");
		}
		else if(string_equals(op,"MULTIPLY")){
			out_val=string_join(string_join(string_join(string_join("(",val1)," * "),val2),")");
		}
		else if(string_equals(op,"DIVIDE")){
			val2=string_join(string_join(string_join(string_join(string_join(string_join("(",val2)," == 0.0 ? "),f32_to_string(parser_material_eps))," : "),val2),")");
			out_val=string_join(string_join(string_join(string_join("(",val1)," / "),val2),")");
		}
		else if(string_equals(op,"POWER")){
			out_val=string_join(string_join(string_join(string_join("pow(",val1),", "),val2),")");
		}
		else if(string_equals(op,"LOGARITHM")){
			out_val=string_join(string_join("log(",val1),")");
		}
		else if(string_equals(op,"SQUARE_ROOT")){
			out_val=string_join(string_join("sqrt(",val1),")");
		}
		else if(string_equals(op,"INVERSE_SQUARE_ROOT")){
			out_val=string_join(string_join("rsqrt(",val1),")");
		}
		else if(string_equals(op,"EXPONENT")){
			out_val=string_join(string_join("exp(",val1),")");
		}
		else if(string_equals(op,"ABSOLUTE")){
			out_val=string_join(string_join("abs(",val1),")");
		}
		else if(string_equals(op,"MINIMUM")){
			out_val=string_join(string_join(string_join(string_join("min(",val1),", "),val2),")");
		}
		else if(string_equals(op,"MAXIMUM")){
			out_val=string_join(string_join(string_join(string_join("max(",val1),", "),val2),")");
		}
		else if(string_equals(op,"LESS_THAN")){
			out_val=string_join(string_join(string_join(string_join("float(",val1)," < "),val2),")");
		}
		else if(string_equals(op,"GREATER_THAN")){
			out_val=string_join(string_join(string_join(string_join("float(",val1)," > "),val2),")");
		}
		else if(string_equals(op,"SIGN")){
			out_val=string_join(string_join("sign(",val1),")");
		}
		else if(string_equals(op,"ROUND")){
			out_val=string_join(string_join("floor(",val1)," + 0.5)");
		}
		else if(string_equals(op,"FLOOR")){
			out_val=string_join(string_join("floor(",val1),")");
		}
		else if(string_equals(op,"CEIL")){
			out_val=string_join(string_join("ceil(",val1),")");
		}
		else if(string_equals(op,"SNAP")){
			out_val=string_join(string_join(string_join(string_join(string_join(string_join("(floor(",val1)," / "),val2),") * "),val2),")");
		}
		else if(string_equals(op,"TRUNCATE")){
			out_val=string_join(string_join("trunc(",val1),")");
		}
		else if(string_equals(op,"FRACTION")){
			out_val=string_join(string_join("frac(",val1),")");
		}
		else if(string_equals(op,"MODULO")){
			out_val=string_join(string_join(string_join(string_join("(",val1)," % "),val2),")");
		}
		else if(string_equals(op,"PING-PONG")){
			out_val=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("((",val2)," != 0.0) ? abs(frac(("),val1)," - "),val2),") / ("),val2)," * 2.0)) * "),val2)," * 2.0 - "),val2),") : 0.0)");
		}
		else if(string_equals(op,"SINE")){
			out_val=string_join(string_join("sin(",val1),")");
		}
		else if(string_equals(op,"COSINE")){
			out_val=string_join(string_join("cos(",val1),")");
		}
		else if(string_equals(op,"TANGENT")){
			out_val=string_join(string_join("tan(",val1),")");
		}
		else if(string_equals(op,"ARCSINE")){
			out_val=string_join(string_join("asin(",val1),")");
		}
		else if(string_equals(op,"ARCCOSINE")){
			out_val=string_join(string_join("acos(",val1),")");
		}
		else if(string_equals(op,"ARCTANGENT")){
			out_val=string_join(string_join("atan(",val1),")");
		}
		else if(string_equals(op,"ARCTAN2")){
			out_val=string_join(string_join(string_join(string_join("atan2(",val1),", "),val2),")");
		}
		else if(string_equals(op,"HYPERBOLIC_SINE")){
			out_val=string_join(string_join("sinh(",val1),")");
		}
		else if(string_equals(op,"HYPERBOLIC_COSINE")){
			out_val=string_join(string_join("cosh(",val1),")");
		}
		else if(string_equals(op,"HYPERBOLIC_TANGENT")){
			out_val=string_join(string_join("tanh(",val1),")");
		}
		else if(string_equals(op,"TO_RADIANS")){
			out_val=string_join(string_join("radians(",val1),")");
		}
		else if(string_equals(op,"TO_DEGREES")){
			out_val=string_join(string_join("degrees(",val1),")");
		}
		if(use_clamp){
			return string_join(string_join("clamp(",out_val),", 0.0, 1.0)");
		}
		else {
			return out_val;
		}
	}
	else if(string_equals(node->type,"SCRIPT_CPU")){
		if(parser_material_script_links==null){
			gc_unroot(parser_material_script_links);parser_material_script_links=any_map_create();gc_root(parser_material_script_links);
		}
		buffer_t * script=node->buttons->buffer[0]->default_value;
		string_t * str=sys_buffer_to_string(script);
		string_t * link=parser_material_node_name(node,null);
		any_map_set(parser_material_script_links,link,str);
		node_shader_add_constant(parser_material_kong,string_join(string_join("",link),": float"),string_join("_",link));
		return string_join("constants.",link);
	}
	else if(string_equals(node->type,"SHADER_GPU")){
		buffer_t * shader=node->buttons->buffer[0]->default_value;
		string_t * str=sys_buffer_to_string(shader);
		return string_equals(str,"")?"0.0":str;
	}
	else if(string_equals(node->type,"RGBTOBW")){
		string_t * col=parser_material_parse_vector_input(node->inputs->buffer[0]);
		return string_join(string_join(string_join(string_join(string_join(string_join("(((",col),".r * 0.3 + "),col),".g * 0.59 + "),col),".b * 0.11) / 3.0) * 2.5)");
	}
	else if(string_equals(node->type,"SEPHSV")){
		node_shader_add_function(parser_material_kong,str_hue_sat);
		string_t * col=parser_material_parse_vector_input(node->inputs->buffer[0]);
		if(socket==node->outputs->buffer[0]){
			return string_join(string_join("rgb_to_hsv(",col),").r");
		}
		else if(socket==node->outputs->buffer[1]){
			return string_join(string_join("rgb_to_hsv(",col),").g");
		}
		else if(socket==node->outputs->buffer[2]){
			return string_join(string_join("rgb_to_hsv(",col),").b");
		}
	}
	else if(string_equals(node->type,"SEPRGB")){
		string_t * col=parser_material_parse_vector_input(node->inputs->buffer[0]);
		if(socket==node->outputs->buffer[0]){
			return string_join(col,".r");
		}
		else if(socket==node->outputs->buffer[1]){
			return string_join(col,".g");
		}
		else if(socket==node->outputs->buffer[2]){
			return string_join(col,".b");
		}
	}
	else if(string_equals(node->type,"SEPXYZ")){
		string_t * vec=parser_material_parse_vector_input(node->inputs->buffer[0]);
		if(socket==node->outputs->buffer[0]){
			return string_join(vec,".x");
		}
		else if(socket==node->outputs->buffer[1]){
			return string_join(vec,".y");
		}
		else if(socket==node->outputs->buffer[2]){
			return string_join(vec,".z");
		}
	}
	else if(string_equals(node->type,"VECT_MATH")){
		string_t * vec1=parser_material_parse_vector_input(node->inputs->buffer[0]);
		string_t * vec2=parser_material_parse_vector_input(node->inputs->buffer[1]);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * op=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		op=string_copy(string_replace_all(op," ","_"));
		if(string_equals(op,"DOT_PRODUCT")){
			return string_join(string_join(string_join(string_join("dot(",vec1),", "),vec2),")");
		}
		else if(string_equals(op,"LENGTH")){
			return string_join(string_join("length(",vec1),")");
		}
		else if(string_equals(op,"DISTANCE")){
			return string_join(string_join(string_join(string_join("distance(",vec1),", "),vec2),")");
		}
		else {
			return "0.0";
		}
	}
	else if(string_equals(node->type,"CLAMP")){
		string_t * val=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * min=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * max=parser_material_parse_value_input(node->inputs->buffer[2],false);
		ui_node_button_t * but=node->buttons->buffer[0];
		string_t * op=to_upper_case(u8_array_string_at(but->data,but->default_value->buffer[0]));
		op=string_copy(string_replace_all(op," ","_"));
		if(string_equals(op,"MIN_MAX")){
			return string_join(string_join(string_join(string_join(string_join(string_join("(clamp(",val),", "),min),", "),max),"))");
		}
		else if(string_equals(op,"RANGE")){
			return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(clamp(",val),", min("),min),", "),max),"), max("),min),", "),max),")))");
		}
	}
	else if(string_equals(node->type,"MAPRANGE")){
		string_t * val=parser_material_parse_value_input(node->inputs->buffer[0],false);
		string_t * fmin=parser_material_parse_value_input(node->inputs->buffer[1],false);
		string_t * fmax=parser_material_parse_value_input(node->inputs->buffer[2],false);
		string_t * tmin=parser_material_parse_value_input(node->inputs->buffer[3],false);
		string_t * tmax=parser_material_parse_value_input(node->inputs->buffer[4],false);
		bool use_clamp=node->buttons->buffer[0]->default_value->buffer[0]>0;
		string_t * a=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("((",tmin)," - "),tmax),") / ("),fmin)," - "),fmax),"))");
		string_t * out_val=string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(",a)," * "),val)," + "),tmin)," - "),a)," * "),fmin),")");
		if(use_clamp){
			return string_join(string_join(string_join(string_join(string_join(string_join("(clamp(",out_val),", "),tmin),", "),tmax),"))");
		}
		else {
			return out_val;
		}
	}
	else if(any_map_get(parser_material_custom_nodes,node->type)!=null){
		any cb=any_map_get(parser_material_custom_nodes,node->type);
		return js_call_ptr_str(cb,node,socket->name);
	}
	return "0.0";
}

string_t * parser_material_get_coord(ui_node_t * node){
	if(parser_material_get_input_link(node->inputs->buffer[0])!=null){
		return parser_material_parse_vector_input(node->inputs->buffer[0]);
	}
	else {
		parser_material_kong->frag_bposition=true;
		return "bposition";
	}
}

string_t * parser_material_get_gradient(string_t * grad,string_t * co){
	if(string_equals(grad,"LINEAR")){
		return string_join(co,".x");
	}
	else if(string_equals(grad,"QUADRATIC")){
		return "0.0";
	}
	else if(string_equals(grad,"EASING")){
		return "0.0";
	}
	else if(string_equals(grad,"DIAGONAL")){
		return string_join(string_join(string_join(string_join("(",co),".x + "),co),".y) * 0.5");
	}
	else if(string_equals(grad,"RADIAL")){
		return string_join(string_join(string_join(string_join("atan2(",co),".x, "),co),".y) / (3.141592 * 2.0) + 0.5");
	}
	else if(string_equals(grad,"QUADRATIC_SPHERE")){
		return "0.0";
	}
	else {
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("max(1.0 - sqrt(",co),".x * "),co),".x + "),co),".y * "),co),".y + "),co),".z * "),co),".z), 0.0)");
	}
}

string_t * parser_material_vector_curve(string_t * name,string_t * fac,f32_ptr points,i32 num){
	string_t * ys_var=string_join(name,"_ys");
	parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",ys_var),": float["),i32_to_string(num)),"];"));
	for(i32 i=0;i<num;++i){
		f32 p=ARRAY_ACCESS(points,i*2+1);
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(ys_var,"["),i32_to_string(i)),"] = "),f32_to_string(p)),";"));
	}
	string_t * fac_var=string_join(name,"_fac");
	parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",fac_var),": float = "),fac),";"));
	string_t * index="0";
	for(i32 i=1;i<num;++i){
		f32 p=ARRAY_ACCESS(points,i*2+0);
		index=string_join(index,string_join(string_join(string_join(string_join(" + (",fac_var)," > "),f32_to_string(p))," ? 1 : 0)"));
	}
	string_t * index_var=string_join(name,"_i");
	parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",index_var),": int = "),index),";"));
	string_t * facs_var=string_join(name,"_xs");
	parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",facs_var),": float["),i32_to_string(num)),"];"));
	for(i32 i=0;i<num;++i){
		f32 p=ARRAY_ACCESS(points,i*2+0);
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("",facs_var),"["),i32_to_string(i)),"] = "),f32_to_string(p)),";"));
	}
	return "0.0";
}

string_t * parser_material_res_var_name(ui_node_t * node,ui_node_socket_t * socket){
	return string_join(string_join(string_join(parser_material_node_name(node,null),"_"),parser_material_safesrc(socket->name)),"_res");
}

string_t * parser_material_write_result(ui_node_link_t * l){
	ui_node_t * from_node=parser_material_get_node(l->from_id);
	ui_node_socket_t * from_socket=from_node->outputs->buffer[l->from_socket];
	string_t * res_var=parser_material_res_var_name(from_node,from_socket);
	string_t * st=from_socket->type;
	if(char_ptr_array_index_of(parser_material_parsed,res_var)<0){
		any_array_push(parser_material_parsed,res_var);
		if(string_equals(st,"RGB")||string_equals(st,"RGBA")||string_equals(st,"VECTOR")){
			string_t * res=parser_material_parse_vector(from_node,from_socket);
			if(res==null){
				return null;
			}
			any_map_set(parser_material_parsed_map,res_var,res);
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",res_var),": float3 = "),res),";"));
		}
		else if(string_equals(st,"VALUE")){
			string_t * res=parser_material_parse_value(from_node,from_socket);
			if(res==null){
				return null;
			}
			any_map_set(parser_material_parsed_map,res_var,res);
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",res_var),": float = "),res),";"));
		}
	}
	return res_var;
}

string_t * parser_material_store_var_name(ui_node_t * node){
	return string_join(parser_material_node_name(node,null),"_store");
}

string_t * parser_material_texture_store(ui_node_t * node,bind_tex_t * tex,string_t * tex_name,i32 color_space){
	any_array_push(parser_material_matcon->bind_textures,tex);
	node_shader_context_add_elem(parser_material_kong->context,"tex","short2norm");
	node_shader_add_texture(parser_material_kong,string_join("",tex_name),null);
	string_t * uv_name="";
	if(parser_material_get_input_link(node->inputs->buffer[0])!=null){
		uv_name=string_copy(parser_material_parse_vector_input(node->inputs->buffer[0]));
	}
	else {
		uv_name=string_copy(parser_material_tex_coord);
	}
	string_t * tex_store=parser_material_store_var_name(node);
	if(parser_material_sample_keep_aspect){
		node_shader_add_constant(parser_material_kong,string_join(tex_name,"_size: float2"),string_join(string_join("_size(",tex_name),")"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join("var ",tex_store),"_size: float2 = constants."),tex_name),"_size;"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("var ",tex_store),"_ax: float = "),tex_store),"_size.x / "),tex_store),"_size.y;"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("var ",tex_store),"_ay: float = "),tex_store),"_size.y / "),tex_store),"_size.x;"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("var ",tex_store),"_uv: float2 = (("),uv_name),".xy / float("),parser_material_sample_uv_scale),") - float2(0.5, 0.5)) * float2(max("),tex_store),"_ay, 1.0), max("),tex_store),"_ax, 1.0))) + float2(0.5, 0.5);"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("if (",tex_store),"_uv.x < 0.0 || "),tex_store),"_uv.y < 0.0 || "),tex_store),"_uv.x > 1.0 || "),tex_store),"_uv.y > 1.0) { discard; }"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(tex_store,"_uv = "),tex_store),"_uv * float("),parser_material_sample_uv_scale),");"));
		uv_name=string_join(tex_store,"_uv");
	}
	if(parser_material_triplanar){
		parser_material_write(parser_material_kong,string_join(string_join("var ",tex_store),": float4 = float4(0.0, 0.0, 0.0, 0.0);"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("if (tex_coord_blend.x > 0) {",tex_store)," += sample("),tex_name),", sampler_linear, "),uv_name),".xy) * tex_coord_blend.x; }"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("if (tex_coord_blend.y > 0) {",tex_store)," += sample("),tex_name),", sampler_linear, "),uv_name),"1.xy) * tex_coord_blend.y; }"));
		parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("if (tex_coord_blend.z > 0) {",tex_store)," += sample("),tex_name),", sampler_linear, "),uv_name),"2.xy) * tex_coord_blend.z; }"));
	}
	else {
		if(parser_material_is_frag){
			any_map_set(parser_material_texture_map,tex_store,string_join(string_join(string_join(string_join("sample(",tex_name),", sampler_linear, "),uv_name),".xy)"));
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("var ",tex_store),": float4 = sample("),tex_name),", sampler_linear, "),uv_name),".xy);"));
		}
		else {
			any_map_set(parser_material_texture_map,tex_store,string_join(string_join(string_join(string_join("sample_lod(",tex_name),", sampler_linear, "),uv_name),".xy, 0.0)"));
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(string_join("var ",tex_store),": float4 = sample_lod("),tex_name),", sampler_linear, "),uv_name),".xy, 0.0);"));
		}
		if(!ends_with(tex->file,".jpg")){
			parser_material_write(parser_material_kong,string_join(string_join(string_join(string_join(string_join(tex_store,".rgb = "),tex_store),".rgb * "),tex_store),".a;"));
		}
	}
	if(parser_material_transform_color_space){
		if(color_space==color_space_t_LINEAR&&parser_material_parsing_basecolor){
			parser_material_write(parser_material_kong,string_join(string_join(string_join(tex_store,".rgb = pow3("),tex_store),".rgb, float3(2.2, 2.2, 2.2));"));
		}
		else if(color_space==color_space_t_SRGB&&!parser_material_parsing_basecolor){
			parser_material_write(parser_material_kong,string_join(string_join(string_join(tex_store,".rgb = pow3("),tex_store),".rgb, float3(1.0 / 2.2, 1.0 / 2.2, 1.0 / 2.2));"));
		}
		else if(color_space==color_space_t_DIRECTX_NORMAL_MAP){
			parser_material_write(parser_material_kong,string_join(string_join(string_join(tex_store,".y = 1.0 - "),tex_store),".y;"));
		}
	}
	return tex_store;
}

string_t * parser_material_vec1(f32 v){
	return f32_to_string_with_zeros(v);
}

string_t * parser_material_vec3(f32_array_t * v){
	string_t * v0=f32_to_string_with_zeros(v->buffer[0]);
	string_t * v1=f32_to_string_with_zeros(v->buffer[1]);
	string_t * v2=f32_to_string_with_zeros(v->buffer[2]);
	return string_join(string_join(string_join(string_join(string_join(string_join("float3(",v0),", "),v1),", "),v2),")");
}

string_t * parser_material_to_vec3(string_t * s){
	return string_join(string_join(string_join(string_join(string_join(string_join("float3(",s),", "),s),", "),s),")");
}

ui_node_t * parser_material_node_by_type(ui_node_t_array_t * nodes,string_t * ntype){
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * n=nodes->buffer[i];
		if(string_equals(n->type,ntype)){
			return n;
		}
	}
	return null;
}

i32 parser_material_socket_index(ui_node_t * node,ui_node_socket_t * socket){
	for(i32 i=0;i<node->outputs->length;++i){
		if(node->outputs->buffer[i]==socket){
			return i;
		}
	}
	return -1;
}

string_t * parser_material_node_name(ui_node_t * node,ui_node_t_array_t * _parents){
	if(_parents==null){
		_parents=parser_material_parents;
	}
	string_t * s=node->name;
	for(i32 i=0;i<_parents->length;++i){
		ui_node_t * p=_parents->buffer[i];
		s=string_join(string_join(string_join(p->name,i32_to_string(p->id)),"_"),s);
	}
	s=string_copy(parser_material_safesrc(s));
	i32 nid=node->id;
	s=string_join(s,i32_to_string(nid));
	return s;
}

string_t * parser_material_safesrc(string_t * s){
	for(i32 i=0;i<string_length(s);++i){
		i32 code=char_code_at(s,i);
		bool letter=(code>=65&&code<=90)||(code>=97&&code<=122);
		bool digit=code>=48&&code<=57;
		if(!letter&&!digit){
			s=string_copy(string_replace_all(s,char_at(s,i),"_"));
		}
		if(i==0&&digit){
			s=string_join("_",s);
		}
	}
	return s;
}

string_t * parser_material_enum_data(string_t * s){
	for(i32 i=0;i<project_assets->length;++i){
		asset_t * a=project_assets->buffer[i];
		if(string_equals(a->name,s)){
			return a->file;
		}
	}
	return "";
}

bind_tex_t * parser_material_make_bind_tex(string_t * tex_name,string_t * file){
	bind_tex_t * tex=GC_ALLOC_INIT(bind_tex_t, {.name=tex_name,.file=file});
	return tex;
}

bind_tex_t * parser_material_make_texture(ui_node_t * image_node,string_t * tex_name){
	i32 i=image_node->buttons->buffer[0]->default_value->buffer[0];
	string_t * filepath=parser_material_enum_data(base_enum_texts(image_node->type)->buffer[i]);
	if(string_equals(filepath,"")||string_index_of(filepath,".")==-1){
		return null;
	}
	return parser_material_make_bind_tex(tex_name,filepath);
}

bool parser_material_is_pow(i32 num){
	return ((num&(num-1))==0)&&num!=0;
}

string_t * parser_material_asset_path(string_t * s){
	return s;
}

string_t * parser_material_extract_filename(string_t * s){
	string_t_array_t * ar=string_split(s,".");
	return string_join(string_join(ar->buffer[ar->length-2],"."),ar->buffer[ar->length-1]);
}

string_t * parser_material_safestr(string_t * s){
	return s;
}

string_t * u8_array_string_at(u8_array_t * a,i32 i){
	string_t * s=u8_array_to_string(a);
	string_t_array_t * ss=string_split(s,"\n");
	return ss->buffer[i];
}

string_t * path_data(){
	return string_join(string_join(iron_get_files_location(),path_sep),data_path());
}

string_t * path_to_relative(string_t * from,string_t * to){
	string_t_array_t * a=string_split(from,path_sep);
	string_t_array_t * b=string_split(to,path_sep);
	while(a->buffer[0]==b->buffer[0]){
		array_shift(a);
		array_shift(b);
		if(a->length==0||b->length==0){
			break;
		}
	}
	string_t * p="";
	for(i32 i=0;i<a->length;++i){
		p=string_join(p,string_join("..",path_sep));
	}
	p=string_join(p,string_array_join(b,path_sep));
	return p;
}

string_t * path_normalize(string_t * path){
	if(ends_with(path,path_sep)){
		path=string_copy(substring(path,0,string_length(path)-1));
	}
	string_t_array_t * ar=string_split(path,path_sep);
	i32 i=0;
	while(i<ar->length){
		if(i>0&&string_equals(ar->buffer[i],"..")&&!string_equals(ar->buffer[i-1],"..")){
			array_splice(ar,i-1,2);
			i--;
		}
		else {
			i++;
		}
	}
	return string_array_join(ar,path_sep);
}

string_t * path_base_dir(string_t * path){
	return substring(path,0,string_last_index_of(path,path_sep)+1);
}

string_t * path_base_name(string_t * path){
	return substring(path,string_last_index_of(path,path_sep)+1,string_last_index_of(path,"."));
}

string_t * path_working_dir(){
	if(path_working_dir_cache==null){
		string_t * cmd=path_pwd;
		string_t * save;
		if(path_is_protected()){
			save=string_copy(iron_internal_save_path());
		}
		else {
			save=string_join(path_data(),path_sep);
		}
		save=string_join(save,"working_dir.txt");
		iron_sys_command(string_join(string_join(string_join(cmd," > \""),save),"\""));
		gc_unroot(path_working_dir_cache);path_working_dir_cache=string_copy(sys_buffer_to_string(iron_load_blob(save)));gc_root(path_working_dir_cache);
		gc_unroot(path_working_dir_cache);path_working_dir_cache=string_copy(trim_end(path_working_dir_cache));gc_root(path_working_dir_cache);
	}
	return path_working_dir_cache;
}

bool path_is_mesh(string_t * path){
	string_t * p=to_lower_case(path);
	for(i32 i=0;i<path_mesh_formats->length;++i){
		string_t * s=path_mesh_formats->buffer[i];
		if(ends_with(p,string_join(".",s))){
			return true;
		}
	}
	return false;
}

bool path_is_texture(string_t * path){
	string_t * p=to_lower_case(path);
	for(i32 i=0;i<path_texture_formats->length;++i){
		string_t * s=path_texture_formats->buffer[i];
		if(ends_with(p,string_join(".",s))){
			return true;
		}
	}
	return false;
}

bool path_is_font(string_t * path){
	string_t * p=to_lower_case(path);
	return ends_with(p,".ttf")||ends_with(p,".ttc")||ends_with(p,".otf");
}

bool path_is_project(string_t * path){
	string_t * p=to_lower_case(path);
	return ends_with(p,".arm");
}

bool path_is_plugin(string_t * path){
	string_t * p=to_lower_case(path);
	return ends_with(p,".js");
}

bool path_is_json(string_t * path){
	string_t * p=to_lower_case(path);
	return ends_with(p,".json");
}

bool path_is_text(string_t * path){
	string_t * p=to_lower_case(path);
	return ends_with(p,".txt");
}

bool path_is_gimp_color_palette(string_t * path){
	string_t * p=to_lower_case(path);
	return ends_with(p,".gpl");
}

bool path_is_known(string_t * path){
	return path_is_mesh(path)||path_is_texture(path)||path_is_font(path)||path_is_project(path)||path_is_plugin(path)||path_is_text(path)||path_is_gimp_color_palette(path);
}

bool path_check_ext(string_t * p,string_t_array_t * exts){
	p=string_copy(string_replace_all(p,"-","_"));
	for(i32 i=0;i<exts->length;++i){
		string_t * ext=exts->buffer[i];
		if(ends_with(p,string_join("_",ext))||(string_index_of(p,string_join(string_join("_",ext),"_"))>=0&&!ends_with(p,"_preview")&&!ends_with(p,"_icon"))){
			return true;
		}
	}
	return false;
}

bool path_is_base_color_tex(string_t * p){
	return path_check_ext(p,path_base_color_ext);
}

bool path_is_opacity_tex(string_t * p){
	return path_check_ext(p,path_opacity_ext);
}

bool path_is_normal_map_tex(string_t * p){
	return path_check_ext(p,path_normal_map_ext);
}

bool path_is_occlusion_tex(string_t * p){
	return path_check_ext(p,path_occlusion_ext);
}

bool path_is_roughness_tex(string_t * p){
	return path_check_ext(p,path_roughness_ext);
}

bool path_is_metallic_tex(string_t * p){
	return path_check_ext(p,path_metallic_ext);
}

bool path_is_displacement_tex(string_t * p){
	return path_check_ext(p,path_displacement_ext);
}

bool path_is_folder(string_t * p){
	string_t * last=array_pop(string_split(string_replace_all(p,"\\","/"),"/"));
	return string_index_of(last,".")==-1;
}

bool path_is_protected(){
	return string_index_of(iron_get_files_location(),"Program Files")>=0;
}

physics_body_t * physics_body_create(){
	physics_body_t * body=GC_ALLOC_INIT(physics_body_t, {0});
	return body;
}

void physics_body_init(physics_body_t * body,object_t * obj){
	any_imap_set(physics_body_object_map,obj->uid,body);
	body->obj=obj;
	transform_compute_dim(obj->transform);
	body->dimx=obj->transform->dim.x;
	body->dimy=obj->transform->dim.y;
	body->dimz=obj->transform->dim.z;
	f32 scale_pos=1.0;
	i16_array_t * posa=null;
	u32_array_t * inda=null;
	if(body->shape==physics_shape_t_MESH||body->shape==physics_shape_t_HULL||body->shape==physics_shape_t_TERRAIN){
		mesh_object_t * mo=obj->ext;
		mesh_data_t * data=mo->data;
		vec4_t scale=obj->transform->scale;
		i16_array_t * positions=mesh_data_get_vertex_array(data,"pos")->values;
		u32_array_t_array_t * indices=data->_->indices;
		u32_array_t * indices0=indices->buffer[0];
		scale_pos=scale.x*data->scale_pos;
		posa=positions;
		inda=indices0;
	}
	vec4_t loc=obj->transform->loc;
	body->_body=asim_body_create(body->shape,body->mass,body->dimx,body->dimy,body->dimz,loc.x,loc.y,loc.z,posa,inda,scale_pos);
}

void physics_body_remove(i32 uid){
	physics_body_t * body=any_imap_get(physics_body_object_map,uid);
	if(body==null){
		return ;
	}
	imap_delete(physics_body_object_map,uid);
	asim_body_remove(body->_body);
}

void physics_body_apply_impulse(physics_body_t * body,vec4_t dir){
	asim_body_apply_impulse(body->_body,dir.x,dir.y,dir.z);
}

void physics_body_sync_transform(physics_body_t * body){
	transform_t * transform=body->obj->transform;
	asim_body_sync_transform(body->_body,transform->loc,transform->rot);
}

void physics_body_update(physics_body_t * body){
	if(body->shape==physics_shape_t_MESH){
		return ;
	}
	transform_t * transform=body->obj->transform;
	asim_body_get_pos(body->_body,ADDRESS(transform->loc));
	asim_body_get_rot(body->_body,ADDRESS(transform->rot));
	transform_build_matrix(transform);
}

physics_world_t * physics_world_create(){
	asim_world_create();
	physics_world_t * world=GC_ALLOC_INIT(physics_world_t, {0});
	gc_unroot(physics_world_active);physics_world_active=world;gc_root(physics_world_active);
	return world;
}

void physics_world_update(physics_world_t * world){
	asim_world_update();
	i32_array_t * keys=imap_keys(physics_body_object_map);
	for(i32 i=0;i<keys->length;++i){
		physics_body_t * body=any_imap_get(physics_body_object_map,keys->buffer[i]);
		physics_body_update(body);
	}
}

physics_pair_t_array_t * physics_world_get_contact_pairs(physics_world_t * world,physics_body_t * body){
	physics_pair_t_array_t * pairs=any_array_create_from_raw((any[]){},0);
	physics_pair_t * p=asim_world_get_contact();
	any_array_push(pairs,p);
	return pairs;
}

void physics_world_destroy(){
	if(physics_world_active!=null){
		asim_world_destroy();
	}
}

gpu_pipeline_t * _pipes_make_merge(bool red,bool green,bool blue,bool alpha){
	gpu_pipeline_t * pipe=gpu_create_pipeline();
	pipe->vertex_shader=sys_get_shader("layer_merge.vert");
	pipe->fragment_shader=sys_get_shader("layer_merge.frag");
	gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
	gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
	pipe->input_layout=vs;
	ARRAY_ACCESS(pipe->color_write_mask_red,0)=red;
	ARRAY_ACCESS(pipe->color_write_mask_green,0)=green;
	ARRAY_ACCESS(pipe->color_write_mask_blue,0)=blue;
	ARRAY_ACCESS(pipe->color_write_mask_alpha,0)=alpha;
	gpu_pipeline_compile(pipe);
	return pipe;
}

void pipes_init(){
	gc_unroot(pipes_merge);pipes_merge=_pipes_make_merge(true,true,true,true);gc_root(pipes_merge);
	gc_unroot(pipes_merge_r);pipes_merge_r=_pipes_make_merge(true,false,false,false);gc_root(pipes_merge_r);
	gc_unroot(pipes_merge_g);pipes_merge_g=_pipes_make_merge(false,true,false,false);gc_root(pipes_merge_g);
	gc_unroot(pipes_merge_b);pipes_merge_b=_pipes_make_merge(false,false,true,false);gc_root(pipes_merge_b);
	pipes_tex0=0;
	pipes_tex1=1;
	pipes_texmask=2;
	pipes_texa=3;
	pipes_offset=0;
	pipes_opac=pipes_get_constant_location("float");
	pipes_blending=pipes_get_constant_location("int");
	pipes_tex1w=pipes_get_constant_location("float");
		{
		gc_unroot(pipes_copy);pipes_copy=gpu_create_pipeline();gc_root(pipes_copy);
		pipes_copy->vertex_shader=sys_get_shader("layer_copy.vert");
		pipes_copy->fragment_shader=sys_get_shader("layer_copy.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_copy->input_layout=vs;
		gpu_pipeline_compile(pipes_copy);
	}
		{
		gc_unroot(pipes_copy_bgra);pipes_copy_bgra=gpu_create_pipeline();gc_root(pipes_copy_bgra);
		pipes_copy_bgra->vertex_shader=sys_get_shader("layer_copy_bgra.vert");
		pipes_copy_bgra->fragment_shader=sys_get_shader("layer_copy_bgra.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_copy_bgra->input_layout=vs;
		gpu_pipeline_compile(pipes_copy_bgra);
	}
		{
		gc_unroot(pipes_copy8);pipes_copy8=gpu_create_pipeline();gc_root(pipes_copy8);
		pipes_copy8->vertex_shader=sys_get_shader("layer_copy.vert");
		pipes_copy8->fragment_shader=sys_get_shader("layer_copy.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_copy8->input_layout=vs;
		pipes_copy8->color_attachment_count=1;
		ARRAY_ACCESS(pipes_copy8->color_attachment,0)=tex_format_t_R8;
		gpu_pipeline_compile(pipes_copy8);
	}
		{
		gc_unroot(pipes_copy64);pipes_copy64=gpu_create_pipeline();gc_root(pipes_copy64);
		pipes_copy64->vertex_shader=sys_get_shader("layer_copy.vert");
		pipes_copy64->fragment_shader=sys_get_shader("layer_copy.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_copy64->input_layout=vs;
		pipes_copy64->color_attachment_count=1;
		ARRAY_ACCESS(pipes_copy64->color_attachment,0)=tex_format_t_RGBA64;
		gpu_pipeline_compile(pipes_copy64);
	}
		{
		gc_unroot(pipes_copy128);pipes_copy128=gpu_create_pipeline();gc_root(pipes_copy128);
		pipes_copy128->vertex_shader=sys_get_shader("layer_copy.vert");
		pipes_copy128->fragment_shader=sys_get_shader("layer_copy.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_copy128->input_layout=vs;
		pipes_copy128->color_attachment_count=1;
		ARRAY_ACCESS(pipes_copy128->color_attachment,0)=tex_format_t_RGBA128;
		gpu_pipeline_compile(pipes_copy128);
	}
		{
		gc_unroot(pipes_invert8);pipes_invert8=gpu_create_pipeline();gc_root(pipes_invert8);
		pipes_invert8->vertex_shader=sys_get_shader("layer_invert.vert");
		pipes_invert8->fragment_shader=sys_get_shader("layer_invert.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_invert8->input_layout=vs;
		pipes_invert8->color_attachment_count=1;
		ARRAY_ACCESS(pipes_invert8->color_attachment,0)=tex_format_t_R8;
		gpu_pipeline_compile(pipes_invert8);
	}
		{
		gc_unroot(pipes_apply_mask);pipes_apply_mask=gpu_create_pipeline();gc_root(pipes_apply_mask);
		pipes_apply_mask->vertex_shader=sys_get_shader("mask_apply.vert");
		pipes_apply_mask->fragment_shader=sys_get_shader("mask_apply.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_apply_mask->input_layout=vs;
		gpu_pipeline_compile(pipes_apply_mask);
		pipes_tex0_mask=0;
		pipes_texa_mask=1;
	}
		{
		gc_unroot(pipes_merge_mask);pipes_merge_mask=gpu_create_pipeline();gc_root(pipes_merge_mask);
		pipes_merge_mask->vertex_shader=sys_get_shader("mask_merge.vert");
		pipes_merge_mask->fragment_shader=sys_get_shader("mask_merge.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_merge_mask->input_layout=vs;
		gpu_pipeline_compile(pipes_merge_mask);
		pipes_tex0_merge_mask=0;
		pipes_texa_merge_mask=1;
		pipes_offset=0;
		pipes_opac_merge_mask=pipes_get_constant_location("float");
		pipes_blending_merge_mask=pipes_get_constant_location("int");
	}
		{
		gc_unroot(pipes_colorid_to_mask);pipes_colorid_to_mask=gpu_create_pipeline();gc_root(pipes_colorid_to_mask);
		pipes_colorid_to_mask->vertex_shader=sys_get_shader("mask_colorid.vert");
		pipes_colorid_to_mask->fragment_shader=sys_get_shader("mask_colorid.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_colorid_to_mask->input_layout=vs;
		gpu_pipeline_compile(pipes_colorid_to_mask);
		pipes_texpaint_colorid=0;
		pipes_tex_colorid=1;
	}
		{
		gc_unroot(pipes_copy_rgb);pipes_copy_rgb=gpu_create_pipeline();gc_root(pipes_copy_rgb);
		pipes_copy_rgb->vertex_shader=sys_get_shader("layer_copy.vert");
		pipes_copy_rgb->fragment_shader=sys_get_shader("layer_copy.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
		pipes_copy_rgb->input_layout=vs;
		ARRAY_ACCESS(pipes_copy_rgb->color_write_mask_alpha,0)=false;
		gpu_pipeline_compile(pipes_copy_rgb);
	}
		{
		gc_unroot(pipes_cursor);pipes_cursor=gpu_create_pipeline();gc_root(pipes_cursor);
		pipes_cursor->vertex_shader=sys_get_shader("cursor.vert");
		pipes_cursor->fragment_shader=sys_get_shader("cursor.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_I16_4X_NORM);
		gpu_vertex_struct_add(vs,"nor",vertex_data_t_I16_2X_NORM);
		gpu_vertex_struct_add(vs,"tex",vertex_data_t_I16_2X_NORM);
		gpu_vertex_struct_add(vs,"col",vertex_data_t_I16_4X_NORM);
		pipes_cursor->input_layout=vs;
		pipes_cursor->blend_source=blend_factor_t_SOURCE_ALPHA;
		pipes_cursor->blend_destination=blend_factor_t_INV_SOURCE_ALPHA;
		pipes_cursor->depth_write=false;
		pipes_cursor->depth_mode=compare_mode_t_ALWAYS;
		gpu_pipeline_compile(pipes_cursor);
		pipes_offset=0;
		pipes_cursor_vp=pipes_get_constant_location("mat4");
		pipes_cursor_inv_vp=pipes_get_constant_location("mat4");
		pipes_cursor_mouse=pipes_get_constant_location("vec2");
		pipes_cursor_tex_step=pipes_get_constant_location("vec2");
		pipes_cursor_radius=pipes_get_constant_location("float");
		pipes_cursor_camera_right=pipes_get_constant_location("vec3");
		pipes_cursor_tint=pipes_get_constant_location("vec3");
		pipes_cursor_gbufferd=0;
	}
}

i32 pipes_get_constant_location(string_t * type){
	i32 size=shader_context_type_size(type);
	pipes_offset+=shader_context_type_pad(pipes_offset,size);
	i32 loc=pipes_offset;
	pipes_offset+=size;
	return loc;
}

plugin_t * plugin_create(){
	plugin_t * p=GC_ALLOC_INIT(plugin_t, {0});
	p->name=string_copy(_plugin_name);
	any_map_set(plugin_map,p->name,p);
	return p;
}

void plugin_start(string_t * plugin){
	buffer_t * blob=data_get_blob(string_join("plugins/",plugin));
	gc_unroot(_plugin_name);_plugin_name=string_copy(plugin);gc_root(_plugin_name);
	js_eval(string_join(string_join("(1, eval)(`",sys_buffer_to_string(blob)),"`)"));
	data_delete_blob(string_join("plugins/",plugin));
}

void plugin_stop(string_t * plugin){
	plugin_t * p=any_map_get(plugin_map,plugin);
	if(p->on_delete!=null){
		js_call(p->on_delete);
	}
	map_delete(plugin_map,plugin);
}

void plugin_notify_on_ui(plugin_t * plugin,any f){
	plugin->on_ui=f;
}

void plugin_notify_on_update(plugin_t * plugin,any f){
	plugin->on_update=f;
}

void plugin_notify_on_delete(plugin_t * plugin,any f){
	plugin->on_delete=f;
}

void project_open(){
	ui_files_show("arm",false,false,&project_open_101206	);
}

void project_open_101206(string_t * path){
if(!ends_with(path,".arm")){
		console_error(strings_arm_file_expected());
		return ;
	}
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	import_arm_run_project(path);
	if(in_use)draw_begin(current,false,0);
}

void project_save(bool save_and_quit){
	if(string_equals(project_filepath,"")){
		project_save_as(save_and_quit);
		return ;
	}
	string_t * filename=substring(project_filepath,string_last_index_of(project_filepath,path_sep)+1,string_length(project_filepath)-4);
	sys_title_set(string_join(string_join(filename," - "),manifest_title));
	_project_save_and_quit=save_and_quit;
	sys_notify_on_init(&project_save_101337	,null);
}

void project_save_101337(){
export_arm_run_project();
	if(_project_save_and_quit){
		iron_stop();
	}
}

void project_save_as(bool save_and_quit){
	_project_save_and_quit=save_and_quit;
	ui_files_show("arm",true,false,&project_save_as_101381	);
}

void project_save_as_101381(string_t * path){
string_t * f=ui_files_filename;
	if(string_equals(f,"")){
		f=string_copy(tr("untitled",null));
	}
	gc_unroot(project_filepath);project_filepath=string_join(string_join(path,path_sep),f);gc_root(project_filepath);
	if(!ends_with(project_filepath,".arm")){
		gc_unroot(project_filepath);project_filepath=string_join(project_filepath,".arm");gc_root(project_filepath);
	}
	project_save(_project_save_and_quit);
}

void project_new_box(){
	ui_box_show_custom(&project_new_box_101450	,400,200,null,true);
}

void project_new_box_101450(ui_t * ui){
if(ui_tab(ui_handle("project.ts:104"),tr("New Project",null),false,-1)){
		if(project_mesh_list==null){
			gc_unroot(project_mesh_list);project_mesh_list=file_read_directory(string_join(string_join(path_data(),path_sep),"meshes"));gc_root(project_mesh_list);
			for(i32 i=0;i<project_mesh_list->length;++i){
				string_t * s=project_mesh_list->buffer[i];
				project_mesh_list->buffer[i]=substring(project_mesh_list->buffer[i],0,string_length(s)-4);
			}
			array_insert(project_mesh_list,0,"plane");
			array_insert(project_mesh_list,0,"sphere");
			array_insert(project_mesh_list,0,"rounded_cube");
		}
		ui_row2();
		ui_handle_t * h_project_type=ui_handle("project.ts:117");
		if(h_project_type->init){
			h_project_type->position=context_raw->project_type;
		}
		context_raw->project_type=ui_combo(h_project_type,project_mesh_list,tr("Template",null),true,ui_align_t_LEFT,true);
		ui_handle_t * h_project_aspect_ratio=ui_handle("project.ts:123");
		if(h_project_aspect_ratio->init){
			h_project_aspect_ratio->position=context_raw->project_aspect_ratio;
		}
		string_t_array_t * project_aspect_ratio_combo=any_array_create_from_raw((any[]){"1:1","2:1","1:2",},3);
		context_raw->project_aspect_ratio=ui_combo(h_project_aspect_ratio,project_aspect_ratio_combo,tr("Aspect Ratio",null),true,ui_align_t_LEFT,true);
		_ui_end_element(-1.0);
		ui_row2();
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("OK",null),ui_align_t_CENTER,"")||ui->is_return_down){
			project_new(true);
			viewport_scale_to_bounds();
			ui_box_hide();
		}
	}
}

void project_new(bool reset_layers){
	sys_title_set(manifest_title);
	gc_unroot(project_filepath);project_filepath="";gc_root(project_filepath);
	if(context_raw->merged_object!=null){
		mesh_object_remove(context_raw->merged_object);
		data_delete_mesh(context_raw->merged_object->data->_->handle);
		context_raw->merged_object=null;
	}
	context_raw->layer_preview_dirty=true;
	context_raw->layer_filter=0;
	context_raw->texture=null;
	gc_unroot(project_mesh_assets);project_mesh_assets=any_array_create_from_raw((any[]){},0);gc_root(project_mesh_assets);
	viewport_reset();
	context_raw->paint_object=context_main_object();
	context_select_paint_object(context_main_object());
	for(i32 i=1;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		if(p==context_raw->paint_object){
			continue;
		}
		data_delete_mesh(p->data->_->handle);
		mesh_object_remove(p);
	}
	mesh_object_t_array_t * meshes=scene_meshes;
	i32 len=meshes->length;
	for(i32 i=0;i<len;++i){
		mesh_object_t * m=meshes->buffer[len-i-1];
		if(array_index_of(context_raw->project_objects,m)==-1&&!string_equals(m->base->name,".ParticleEmitter")&&!string_equals(m->base->name,".Particle")){
			data_delete_mesh(m->data->_->handle);
			mesh_object_remove(m);
		}
	}
	string_t * handle=context_raw->paint_object->data->_->handle;
	if(!string_equals(handle,"SceneSphere")&&!string_equals(handle,"ScenePlane")){
		data_delete_mesh(handle);
	}
	if(context_raw->project_type!=project_model_t_ROUNDED_CUBE){
		mesh_data_t * raw=null;
		if(context_raw->project_type==project_model_t_SPHERE||context_raw->project_type==project_model_t_TESSELLATED_PLANE){
			raw_mesh_t * mesh=context_raw->project_type==project_model_t_SPHERE?geom_make_uv_sphere(1,512,256,true,1.0):geom_make_plane(1,1,512,512,1.0);
			mesh->name="Tessellated";
			raw=import_mesh_raw_mesh(mesh);
		}
		else {
			buffer_t * b=data_get_blob(string_join(string_join("meshes/",project_mesh_list->buffer[context_raw->project_type]),".arm"));
			gc_unroot(_project_scene_mesh_gc);_project_scene_mesh_gc=armpack_decode(b);gc_root(_project_scene_mesh_gc);
			raw=_project_scene_mesh_gc->mesh_datas->buffer[0];
		}
		mesh_data_t * md=mesh_data_create(raw);
		any_map_set(data_cached_meshes,"SceneTessellated",md);
		if(context_raw->project_type==project_model_t_TESSELLATED_PLANE){
			viewport_set_view(0,0,0.75,0,0,0);
		}
	}
	string_t * n=context_raw->project_type==project_model_t_ROUNDED_CUBE?".Cube":"Tessellated";
	mesh_data_t * md=data_get_mesh("Scene",n);
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	context_raw->picker_mask_handle->position=picker_mask_t_NONE;
	mesh_object_set_data(context_raw->paint_object,md);
	context_raw->paint_object->base->transform->scale=vec4_create(1,1,1,1.0);
	transform_build_matrix(context_raw->paint_object->base->transform);
	context_raw->paint_object->base->name=n;
	gc_unroot(project_paint_objects);project_paint_objects=any_array_create_from_raw((any[]){context_raw->paint_object,},1);gc_root(project_paint_objects);
	while(project_materials->length>0){
		slot_material_unload(array_pop(project_materials));
	}
	material_data_t * m=data_get_material("Scene","Material");
	any_array_push(project_materials,slot_material_create(m,null));
	context_raw->material=project_materials->buffer[0];
	ui_nodes_hwnd->redraws=2;
	gc_unroot(ui_nodes_group_stack);ui_nodes_group_stack=any_array_create_from_raw((any[]){},0);gc_root(ui_nodes_group_stack);
	gc_unroot(project_material_groups);project_material_groups=any_array_create_from_raw((any[]){},0);gc_root(project_material_groups);
	gc_unroot(project_brushes);project_brushes=any_array_create_from_raw((any[]){slot_brush_create(null),},1);gc_root(project_brushes);
	context_raw->brush=project_brushes->buffer[0];
	gc_unroot(project_fonts);project_fonts=any_array_create_from_raw((any[]){slot_font_create("default.ttf",base_font,""),},1);gc_root(project_fonts);
	context_raw->font=project_fonts->buffer[0];
	project_set_default_swatches();
	context_raw->swatch=project_raw->swatches->buffer[0];
	context_raw->picked_color=make_swatch(0xffffffff);
	context_raw->color_picker_callback=null;
	history_reset();
	make_material_parse_paint_material(true);
	make_material_parse_brush();
	util_render_make_material_preview();
	for(i32 i=0;i<project_assets->length;++i){
		asset_t * a=project_assets->buffer[i];
		data_delete_image(a->file);
	}
	gc_unroot(project_assets);project_assets=any_array_create_from_raw((any[]){},0);gc_root(project_assets);
	gc_unroot(project_asset_names);project_asset_names=any_array_create_from_raw((any[]){},0);gc_root(project_asset_names);
	gc_unroot(project_asset_map);project_asset_map=any_imap_create();gc_root(project_asset_map);
	project_asset_id=0;
	project_raw->packed_assets=any_array_create_from_raw((any[]){},0);
	context_raw->ddirty=4;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	if(reset_layers){
		bool aspect_ratio_changed=project_layers->buffer[0]->texpaint->width!=config_get_texture_res_x()||project_layers->buffer[0]->texpaint->height!=config_get_texture_res_y();
		while(project_layers->length>0){
			slot_layer_unload(array_pop(project_layers));
		}
		slot_layer_t * layer=slot_layer_create("",layer_slot_type_t_LAYER,null);
		any_array_push(project_layers,layer);
		context_set_layer(layer);
		if(aspect_ratio_changed){
			sys_notify_on_init(layers_resize,null);
		}
		sys_notify_on_init(layers_init,null);
	}
	if(in_use)draw_begin(current,false,0);
	context_raw->saved_envmap=null;
	context_raw->envmap_loaded=false;
	scene_world->_->envmap=context_raw->empty_envmap;
	scene_world->envmap="World_radiance.k";
	context_raw->show_envmap_handle->selected=context_raw->show_envmap=false;
	scene_world->_->radiance=context_raw->default_radiance;
	scene_world->_->radiance_mipmaps=context_raw->default_radiance_mipmaps;
	scene_world->_->irradiance=context_raw->default_irradiance;
	scene_world->strength=4.0;
	context_init_tool();
	render_path_raytrace_ready=false;
}

void project_import_material(){
	ui_files_show("arm,blend",false,true,&project_import_material_102523	);
}

void project_import_material_102523(string_t * path){
ends_with(path,".blend")?import_blend_material_run(path):import_arm_run_material(path);
}

ui_node_link_t * project_create_node_link(ui_node_link_t_array_t * links,i32 from_id,i32 from_socket,i32 to_id,i32 to_socket){
	ui_node_link_t * link=GC_ALLOC_INIT(ui_node_link_t, {.id=ui_next_link_id(links),.from_id=from_id,.from_socket=from_socket,.to_id=to_id,.to_socket=to_socket});
	return link;
}

void project_import_brush(){
	string_t * formats=string_array_join(path_texture_formats,",");
	ui_files_show(string_join("arm,",formats),false,true,&project_import_brush_102640	);
}

void project_import_brush_102640(string_t * path){
if(path_is_texture(path)){
		import_asset_run(path,-1.0,-1.0,true,true,null);
		i32 asset_index=0;
		for(i32 i=0;i<project_assets->length;++i){
			if(string_equals(project_assets->buffer[i]->file,path)){
				asset_index=i;
				break;
			}
		}
		context_raw->brush=slot_brush_create(null);
		any_array_push(project_brushes,context_raw->brush);
		ui_node_t * n=nodes_brush_create_node("TEX_IMAGE");
		n->x=83;
		n->y=340;
		n->buttons->buffer[0]->default_value=f32_array_create_x(asset_index);
		ui_node_link_t_array_t * links=context_raw->brush->canvas->links;
		ui_node_link_t * link=project_create_node_link(links,n->id,0,0,4);
		any_array_push(links,link);
		make_material_parse_brush();
		ui_nodes_hwnd->redraws=2;
		sys_notify_on_init(util_render_make_brush_preview,null);
	}
	else {
		import_arm_run_brush(path);
	}
}

void project_import_mesh(bool replace_existing,void(*done)(void)){
	_project_import_mesh_replace_existing=replace_existing;
	gc_unroot(_project_import_mesh_done);_project_import_mesh_done=done;gc_root(_project_import_mesh_done);
	string_t * formats=string_array_join(path_mesh_formats,",");
	if(string_index_of(formats,"fbx")==-1){
		formats=string_join(formats,",fbx");
	}
	ui_files_show(formats,false,false,&project_import_mesh_102868	);
}

void project_import_mesh_102868(string_t * path){
project_import_mesh_box(path,_project_import_mesh_replace_existing,true,_project_import_mesh_done);
}

void project_append_mesh(){
	project_import_mesh(false,import_mesh_finish_import);
}

void project_import_mesh_box(string_t * path,bool replace_existing,bool clear_layers,void(*done)(void)){
	gc_unroot(_project_import_mesh_box_path);_project_import_mesh_box_path=string_copy(path);gc_root(_project_import_mesh_box_path);
	_project_import_mesh_box_replace_existing=replace_existing;
	_project_import_mesh_box_clear_layers=clear_layers;
	gc_unroot(_project_import_mesh_box_done);_project_import_mesh_box_done=done;gc_root(_project_import_mesh_box_done);
	ui_box_show_custom(&project_import_mesh_box_102950	,400,200,null,true);
	ui_box_click_to_hide=false;
}

void project_import_mesh_box_102950(ui_t * ui){
string_t * path=_project_import_mesh_box_path;
	bool replace_existing=_project_import_mesh_box_replace_existing;
	bool clear_layers=_project_import_mesh_box_clear_layers;
	void(*done)(void)=_project_import_mesh_box_done;
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(ui_handle("project.ts:433"),tr("Import Mesh",null),tab_vertical,-1)){
		if(ends_with(to_lower_case(path),".obj")){
			string_t_array_t * split_by_combo=any_array_create_from_raw((any[]){tr("Object",null),tr("Group",null),tr("Material",null),tr("UDIM Tile",null),},4);
			context_raw->split_by=ui_combo(ui_handle("project.ts:437"),split_by_combo,tr("Split By",null),true,ui_align_t_LEFT,true);
			if(ui->is_hovered){
				ui_tooltip(tr("Split .obj mesh into objects",null));
			}
		}
		if(ends_with(to_lower_case(path),".fbx")){
			ui_handle_t * h=ui_handle("project.ts:445");
			h->selected=context_raw->parse_vcols;
			context_raw->parse_vcols=ui_check(h,tr("Parse Vertex Colors",null),"");
			if(ui->is_hovered){
				ui_tooltip(tr("Import vertex color data",null));
			}
		}
		if(ends_with(to_lower_case(path),".blend")){
			import_blend_mesh_ui();
		}
		f32_array_t * row=f32_array_create_from_raw((f32[]){0.45,0.45,0.1,},3);
		ui_row(row);
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")||ui->is_return_down){
			ui_box_hide();
			import_mesh_run(path,clear_layers,replace_existing);
			if(done!=null){
				done();
			}
		}
		if(ui_button(tr("?",null),ui_align_t_CENTER,"")){
			file_load_url("https://github.com/armory3d/armorpaint_web/blob/main/manual.md#faq");
		}
	}
}

void project_reimport_mesh(){
	if(project_mesh_assets!=null&&project_mesh_assets->length>0&&file_exists(project_mesh_assets->buffer[0])){
		project_import_mesh_box(project_mesh_assets->buffer[0],true,false,null);
	}
	else {
		project_import_asset(null,true);
	}
}

string_t_array_t * project_get_unwrap_plugins(){
	string_t_array_t * unwrap_plugins=any_array_create_from_raw((any[]){},0);
	if(box_preferences_files_plugin==null){
		box_preferences_fetch_plugins();
	}
	for(i32 i=0;i<box_preferences_files_plugin->length;++i){
		string_t * f=box_preferences_files_plugin->buffer[i];
		if(string_index_of(f,"uv_unwrap")>=0&&ends_with(f,".js")){
			any_array_push(unwrap_plugins,f);
		}
	}
	any_array_push(unwrap_plugins,"equirect");
	return unwrap_plugins;
}

void project_unwrap_mesh_box(raw_mesh_t * mesh,void(*done)(raw_mesh_t *),bool skip_ui){
	gc_unroot(_project_unwrap_mesh_box_mesh);_project_unwrap_mesh_box_mesh=mesh;gc_root(_project_unwrap_mesh_box_mesh);
	gc_unroot(_project_unwrap_mesh_box_done);_project_unwrap_mesh_box_done=done;gc_root(_project_unwrap_mesh_box_done);
	if(skip_ui){
		project_unwrap_mesh(mesh,done);
		return ;
	}
	ui_box_show_custom(&project_unwrap_mesh_box_103460	,400,200,null,true);
}

void project_unwrap_mesh_box_103460(ui_t * ui){
raw_mesh_t * mesh=_project_unwrap_mesh_box_mesh;
	void(*done)(raw_mesh_t *)=_project_unwrap_mesh_box_done;
	bool tab_vertical=config_raw->touch_ui;
	if(ui_tab(ui_handle("project.ts:530"),tr("Unwrap Mesh",null),tab_vertical,-1)){
		string_t_array_t * unwrap_plugins=project_get_unwrap_plugins();
		_project_unwrap_by=ui_combo(ui_handle("project.ts:533"),unwrap_plugins,tr("Plugin",null),true,ui_align_t_LEFT,true);
		ui_row2();
		if(ui_button(tr("Cancel",null),ui_align_t_CENTER,"")){
			ui_box_hide();
		}
		if(ui_button(tr("Unwrap",null),ui_align_t_CENTER,"")||ui->is_return_down){
			ui_box_hide();
			project_unwrap_mesh(mesh,done);
		}
	}
}

void project_unwrap_mesh(raw_mesh_t * mesh,void(*done)(raw_mesh_t *)){
	string_t_array_t * unwrap_plugins=project_get_unwrap_plugins();
	if(_project_unwrap_by==unwrap_plugins->length-1){
		util_mesh_equirect_unwrap(mesh);
	}
	else {
		string_t * f=unwrap_plugins->buffer[_project_unwrap_by];
		if(char_ptr_array_index_of(config_raw->plugins,f)==-1){
			config_enable_plugin(f);
			console_info(string_join(string_join(f," "),tr("plugin enabled",null)));
		}
		any cb=any_map_get(util_mesh_unwrappers,f);
		js_call_ptr(cb,mesh);
	}
	done(mesh);
}

void project_import_asset(string_t * filters,bool hdr_as_envmap){
	if(filters==null){
		filters=string_join(string_join(string_array_join(path_texture_formats,","),","),string_array_join(path_mesh_formats,","));
	}
	_project_import_asset_hdr_as_envmap=hdr_as_envmap;
	ui_files_show(filters,false,true,&project_import_asset_103758	);
}

void project_import_asset_103758(string_t * path){
import_asset_run(path,-1.0,-1.0,true,_project_import_asset_hdr_as_envmap,null);
}

void project_import_swatches(bool replace_existing){
	_project_import_swatches_replace_existing=replace_existing;
	ui_files_show("arm,gpl",false,false,&project_import_swatches_103804	);
}

void project_import_swatches_103804(string_t * path){
if(path_is_gimp_color_palette(path)){
	}
	else {
		import_arm_run_swatches(path,_project_import_swatches_replace_existing);
	}
}

void project_reimport_textures(){
	for(i32 i=0;i<project_assets->length;++i){
		asset_t * asset=project_assets->buffer[i];
		project_reimport_texture(asset);
	}
}

void project_reimport_texture_load(string_t * path,asset_t * asset){
	asset->file=string_copy(path);
	i32 i=array_index_of(project_assets,asset);
	data_delete_image(asset->file);
	imap_delete(project_asset_map,asset->id);
	asset_t * old_asset=project_assets->buffer[i];
	array_splice(project_assets,i,1);
	array_splice(project_asset_names,i,1);
	import_texture_run(asset->file,true);
	array_insert(project_assets,i,array_pop(project_assets));
	array_insert(project_asset_names,i,array_pop(project_asset_names));
	if(context_raw->texture==old_asset){
		context_raw->texture=project_assets->buffer[i];
	}
	sys_notify_on_next_frame(&project_reimport_texture_load_103986	,null);
}

void project_reimport_texture_load_103986(){
make_material_parse_paint_material(true);
	util_render_make_material_preview();
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
}

void project_reimport_texture(asset_t * asset){
	if(!file_exists(asset->file)){
		string_t * filters=string_array_join(path_texture_formats,",");
		gc_unroot(_project_reimport_texture_asset);_project_reimport_texture_asset=asset;gc_root(_project_reimport_texture_asset);
		ui_files_show(filters,false,false,&project_reimport_texture_104051		);
	}
	else {
		project_reimport_texture_load(asset->file,asset);
	}
}

void project_reimport_texture_104051(string_t * path){
project_reimport_texture_load(path,_project_reimport_texture_asset);
}

gpu_texture_t * project_get_image(asset_t * asset){
	return asset!=null?any_imap_get(project_asset_map,asset->id):null;
}

string_t_array_t * project_get_used_atlases(){
	if(project_atlas_objects==null){
		return null;
	}
	i32_array_t * used=i32_array_create_from_raw((i32[]){},0);
	for(i32 i=0;i<project_atlas_objects->length;++i){
		i32 ao=project_atlas_objects->buffer[i];
		if(i32_array_index_of(used,ao)==-1){
			i32_array_push(used,ao);
		}
	}
	if(used->length>1){
		string_t_array_t * res=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<used->length;++i){
			i32 u=used->buffer[i];
			any_array_push(res,project_atlas_names->buffer[u]);
		}
		return res;
	}
	else return null;
}

bool project_is_atlas_object(mesh_object_t * p){
	if(context_raw->layer_filter<=project_paint_objects->length){
		return false;
	}
	string_t * atlas_name=project_get_used_atlases()->buffer[context_raw->layer_filter-project_paint_objects->length-1];
	i32 atlas_i=char_ptr_array_index_of(project_atlas_names,atlas_name);
	return atlas_i==project_atlas_objects->buffer[array_index_of(project_paint_objects,p)];
}

mesh_object_t_array_t * project_get_atlas_objects(i32 object_mask){
	string_t * atlas_name=project_get_used_atlases()->buffer[object_mask-project_paint_objects->length-1];
	i32 atlas_i=char_ptr_array_index_of(project_atlas_names,atlas_name);
	mesh_object_t_array_t * visibles=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project_paint_objects->length;++i){
		if(project_atlas_objects->buffer[i]==atlas_i){
			any_array_push(visibles,project_paint_objects->buffer[i]);
		}
	}
	return visibles;
}

bool project_packed_asset_exists(packed_asset_t_array_t * packed_assets,string_t * name){
	for(i32 i=0;i<packed_assets->length;++i){
		packed_asset_t * pa=packed_assets->buffer[i];
		if(string_equals(pa->name,name)){
			return true;
		}
	}
	return false;
}

void project_export_swatches(){
	ui_files_show("arm,gpl",true,false,&project_export_swatches_104472	);
}

void project_export_swatches_104472(string_t * path){
string_t * f=ui_files_filename;
	if(string_equals(f,"")){
		f=string_copy(tr("untitled",null));
	}
	if(path_is_gimp_color_palette(f)){
	}
	else {
		export_arm_run_swatches(string_join(string_join(path,path_sep),f));
	}
}

swatch_color_t * make_swatch(i32 base){
	swatch_color_t * s=GC_ALLOC_INIT(swatch_color_t, {.base=base,.opacity=1.0,.occlusion=1.0,.roughness=0.0,.metallic=0.0,.normal=0xff8080ff,.emission=0.0,.height=0.0,.subsurface=0.0});
	return s;
}

swatch_color_t * project_clone_swatch(swatch_color_t * swatch){
	swatch_color_t * s=GC_ALLOC_INIT(swatch_color_t, {.base=swatch->base,.opacity=swatch->opacity,.occlusion=swatch->occlusion,.roughness=swatch->roughness,.metallic=swatch->metallic,.normal=swatch->normal,.emission=swatch->emission,.height=swatch->height,.subsurface=swatch->subsurface});
	return s;
}

void project_set_default_swatches(){
	project_raw->swatches=any_array_create_from_raw((any[]){},0);
	i32_array_t * colors=i32_array_create_from_raw((i32[]){0xffffffff,0xff000000,0xffd6a090,0xffa12c32,0xfffa2f7a,0xfffb9fda,0xffe61cf7,0xff992f7c,0xff47011f,0xff051155,0xff4f02ec,0xff2d69cb,0xff00a6ee,0xff6febff,0xff08a29a,0xff2a666a,0xff063619,0xff4a4957,0xff8e7ba4,0xffb7c0ff,0xffacbe9c,0xff827c70,0xff5a3b1c,0xffae6507,0xfff7aa30,0xfff4ea5c,0xff9b9500,0xff566204,0xff11963b,0xff51e113,0xff08fdcc,},31);
	for(i32 i=0;i<colors->length;++i){
		i32 c=colors->buffer[i];
		any_array_push(project_raw->swatches,make_swatch(c));
	}
}

node_group_t * project_get_material_group_by_name(string_t * group_name){
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * g=project_material_groups->buffer[i];
		if(string_equals(g->canvas->name,group_name)){
			return g;
		}
	}
	return null;
}

bool project_is_material_group_in_use(node_group_t * group){
	ui_node_canvas_t_array_t * canvases=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		any_array_push(canvases,m->canvas);
	}
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * m=project_material_groups->buffer[i];
		any_array_push(canvases,m->canvas);
	}
	for(i32 i=0;i<canvases->length;++i){
		ui_node_canvas_t * canvas=canvases->buffer[i];
		for(i32 i=0;i<canvas->nodes->length;++i){
			ui_node_t * n=canvas->nodes->buffer[i];
			string_t * cname=group->canvas->name;
			if(string_equals(n->type,"GROUP")&&string_equals(n->name,cname)){
				return true;
			}
		}
	}
	return false;
}

void render_path_base_init(){
	pipes_init();
	const_data_create_screen_aligned_data();
	render_path_base_super_sample=config_raw->rp_supersample;
}

void render_path_base_apply_config(){
	if(render_path_base_super_sample!=config_raw->rp_supersample){
		render_path_base_super_sample=config_raw->rp_supersample;
		string_t_array_t * keys=map_keys(render_path_render_targets);
		for(i32 i=0;i<keys->length;++i){
			render_target_t * rt=any_map_get(render_path_render_targets,keys->buffer[i]);
			if(rt->width==0){
				rt->scale=render_path_base_super_sample;
			}
		}
		render_path_resize();
	}
}

f32 render_path_base_get_super_sampling(){
	return render_path_base_super_sample;
}

void render_path_base_draw_compass(){
	compass_render();
}

void render_path_base_begin(){
	if(context_raw->split_view&&!context_raw->paint2d_view){
		if(context_raw->view_index_last==-1&&context_raw->view_index==-1){
			context_raw->view_index=1;
		}
		else {
			context_raw->view_index=mouse_view_x()>base_w()/(float)2?1:0;
		}
		camera_object_t * cam=scene_camera;
		if(context_raw->view_index_last>-1){
			camera_views->buffer[context_raw->view_index_last]->v=mat4_clone(cam->base->transform->local);
		}
		bool decal=context_is_decal();
		if(context_raw->view_index_last!=context_raw->view_index||decal||!config_raw->brush_3d){
			context_raw->ddirty=1;
		}
		transform_set_matrix(cam->base->transform,camera_views->buffer[context_raw->view_index]->v);
		camera_object_build_mat(cam);
		camera_object_build_proj(cam,-1.0);
	}
	bool skip_taa=context_raw->split_view||context_raw->viewport_mode==viewport_mode_t_PATH_TRACE||((context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE)&&context_raw->pdirty>0);
	scene_camera->frame=skip_taa?0:render_path_base_taa_frame;
	camera_object_proj_jitter(scene_camera);
	camera_object_build_mat(scene_camera);
}

void render_path_base_end(){
	context_raw->view_index_last=context_raw->view_index;
	context_raw->view_index=-1;
	if(context_raw->foreground_event&&!mouse_down("left")){
		context_raw->foreground_event=false;
		context_raw->pdirty=0;
	}
	render_path_base_taa_frame++;
}

bool render_path_base_ssaa4(){
	return config_raw->rp_supersample==4;
}

bool render_path_base_is_cached(){
	if(iron_window_width()==0||iron_window_height()==0){
		return true;
	}
	f32 mx=render_path_base_last_x;
	f32 my=render_path_base_last_y;
	render_path_base_last_x=mouse_view_x();
	render_path_base_last_y=mouse_view_y();
	if(context_raw->ddirty<=0&&context_raw->rdirty<=0&&context_raw->pdirty<=0){
		if(mx!=render_path_base_last_x||my!=render_path_base_last_y||mouse_locked){
			context_raw->ddirty=0;
		}
		if(context_raw->ddirty>-6){
			context_raw->ddirty--;
			return false;
		}
		if(context_raw->ddirty>-12){
			render_path_set_target("",null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target("last","tex");
			if(render_path_base_ssaa4()){
				render_path_draw_shader("shader_datas/supersample_resolve/supersample_resolveRGBA64");
			}
			else {
				render_path_draw_shader("shader_datas/copy_pass/copy_pass");
			}
			render_path_paint_commands_cursor();
			context_raw->ddirty--;
		}
		render_path_base_end();
		return true;
	}
	return false;
}

void render_path_base_commands(void(*draw_commands)(void)){
	if(render_path_base_is_cached()){
		return ;
	}
	render_path_base_begin();
	render_path_paint_begin();
	render_path_base_draw_split(draw_commands);
	render_path_base_draw_gbuffer();
	render_path_paint_draw();
	if(context_raw->viewport_mode==viewport_mode_t_PATH_TRACE){
		bool use_live_layer=context_raw->tool==workspace_tool_t_MATERIAL;
		render_path_raytrace_draw(use_live_layer);
		context_raw->foreground_event=false;
		render_path_base_end();
		return ;
	}
	draw_commands();
	render_path_paint_commands_cursor();
	render_path_paint_end();
	render_path_base_end();
}

void render_path_base_draw_bloom(){
	if(config_raw->rp_bloom==false){
		return ;
	}
	if(render_path_base_bloom_mipmaps==null){
		gc_unroot(render_path_base_bloom_mipmaps);render_path_base_bloom_mipmaps=any_array_create_from_raw((any[]){},0);gc_root(render_path_base_bloom_mipmaps);
		f32 prev_scale=1.0;
		for(i32 i=0;i<10;++i){
			render_target_t * t=render_target_create();
			t->name=string_join("bloom_mip_",i32_to_string(i));
			t->width=0;
			t->height=0;
			prev_scale*=0.5;
			t->scale=prev_scale;
			t->format="RGBA64";
			any_array_push(render_path_base_bloom_mipmaps,render_path_create_render_target(t));
		}
		render_path_load_shader("shader_datas/bloom_pass/bloom_downsample_pass");
		render_path_load_shader("shader_datas/bloom_pass/bloom_upsample_pass");
	}
	f32 bloom_radius=6.5;
	f32 min_dim=math_min(render_path_current_w,render_path_current_h);
	f32 log_min_dim=math_max(1.0,math_log2(min_dim)+(bloom_radius-8.0));
	i32 num_mips=math_floor(log_min_dim);
	render_path_base_bloom_sample_scale=0.5+log_min_dim-num_mips;
	for(i32 i=0;i<num_mips;++i){
		render_path_base_bloom_current_mip=i;
		render_path_set_target(render_path_base_bloom_mipmaps->buffer[i]->name,null,null,clear_flag_t_COLOR,0x00000000,0.0);
		render_path_bind_target(i==0?"buf":render_path_base_bloom_mipmaps->buffer[i-1]->name,"tex");
		render_path_draw_shader("shader_datas/bloom_pass/bloom_downsample_pass");
	}
	for(i32 i=0;i<num_mips;++i){
		i32 mip_level=num_mips-1-i;
		render_path_base_bloom_current_mip=mip_level;
		render_path_set_target(mip_level==0?"buf":render_path_base_bloom_mipmaps->buffer[mip_level-1]->name,null,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target(render_path_base_bloom_mipmaps->buffer[mip_level]->name,"tex");
		render_path_draw_shader("shader_datas/bloom_pass/bloom_upsample_pass");
	}
}

void render_path_base_draw_split(void(*draw_commands)(void)){
	if(context_raw->split_view&&!context_raw->paint2d_view){
		context_raw->ddirty=2;
		camera_object_t * cam=scene_camera;
		context_raw->view_index=context_raw->view_index==0?1:0;
		transform_set_matrix(cam->base->transform,camera_views->buffer[context_raw->view_index]->v);
		camera_object_build_mat(cam);
		camera_object_build_proj(cam,-1.0);
		render_path_base_draw_gbuffer();
		bool use_live_layer=context_raw->tool==workspace_tool_t_MATERIAL;
		context_raw->viewport_mode==viewport_mode_t_PATH_TRACE?render_path_raytrace_draw(use_live_layer):draw_commands();
		context_raw->view_index=context_raw->view_index==0?1:0;
		transform_set_matrix(cam->base->transform,camera_views->buffer[context_raw->view_index]->v);
		camera_object_build_mat(cam);
		camera_object_build_proj(cam,-1.0);
	}
}

void render_path_base_init_ssao(){
	f32 scale=1.0;
		{
		render_target_t * t=render_target_create();
		t->name="singlea";
		t->width=0;
		t->height=0;
		t->format="R8";
		t->scale=scale*render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="singleb";
		t->width=0;
		t->height=0;
		t->format="R8";
		t->scale=scale*render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
	render_path_load_shader("shader_datas/ssao_pass/ssao_pass");
	render_path_load_shader("shader_datas/ssao_blur_pass/ssao_blur_pass_x");
	render_path_load_shader("shader_datas/ssao_blur_pass/ssao_blur_pass_y");
}

void render_path_base_draw_ssao(){
	bool ssao=config_raw->rp_ssao!=false&&context_raw->camera_type==camera_type_t_PERSPECTIVE;
	if(ssao&&context_raw->ddirty>0&&render_path_base_taa_frame>0){
		if(any_map_get(render_path_render_targets,"singlea")==null){
			render_path_base_init_ssao();
		}
		render_path_set_target("singlea",null,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target("main","gbufferD");
		render_path_bind_target("gbuffer0","gbuffer0");
		render_path_draw_shader("shader_datas/ssao_pass/ssao_pass");
		render_path_set_target("singleb",null,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target("singlea","tex");
		render_path_bind_target("gbuffer0","gbuffer0");
		render_path_draw_shader("shader_datas/ssao_blur_pass/ssao_blur_pass_x");
		render_path_set_target("singlea",null,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target("singleb","tex");
		render_path_bind_target("gbuffer0","gbuffer0");
		render_path_draw_shader("shader_datas/ssao_blur_pass/ssao_blur_pass_y");
	}
}

void render_path_base_draw_deferred_light(){
	render_path_set_target("buf",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("main","gbufferD");
	render_path_bind_target("gbuffer0","gbuffer0");
	render_path_bind_target("gbuffer1","gbuffer1");
	bool ssao=config_raw->rp_ssao!=false&&context_raw->camera_type==camera_type_t_PERSPECTIVE;
	if(ssao&&render_path_base_taa_frame>0){
		render_path_bind_target("singlea","ssaotex");
	}
	else {
		render_path_bind_target("empty_white","ssaotex");
	}
	render_path_draw_shader("shader_datas/deferred_light/deferred_light");
	render_path_set_target("buf",null,"main",clear_flag_t_NONE,0,0.0);
	render_path_draw_skydome("shader_datas/world_pass/world_pass");
}

void render_path_base_draw_taa(string_t * bufa,string_t * bufb){
	render_path_set_target(bufb,null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target(bufa,"tex");
	bool skip_taa=context_raw->split_view;
	if(skip_taa){
		render_path_draw_shader("shader_datas/copy_pass/copy_pass");
	}
	else {
		render_path_bind_target("last","tex2");
		render_path_draw_shader("shader_datas/taa_pass/taa_pass");
	}
	render_path_set_target("",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target(bufb,"tex");
	if(render_path_base_ssaa4()){
		render_path_draw_shader("shader_datas/supersample_resolve/supersample_resolveRGBA64");
	}
	else {
		render_path_draw_shader("shader_datas/copy_pass/copy_pass");
	}
	render_target_t * last_target=any_map_get(render_path_render_targets,"last");
	last_target->name=string_copy(bufb);
	render_target_t * buf_target=any_map_get(render_path_render_targets,bufb);
	buf_target->name="last";
	any_map_set(render_path_render_targets,bufb,last_target);
	any_map_set(render_path_render_targets,"last",buf_target);
}

void render_path_base_draw_gbuffer(){
	render_path_set_target("gbuffer0",null,"main",clear_flag_t_DEPTH,0,1.0);
	string_t_array_t * additional=any_array_create_from_raw((any[]){"gbuffer1","gbuffer2",},2);
	render_path_set_target("gbuffer0",additional,"main",clear_flag_t_NONE,0,0.0);
	render_path_paint_bind_layers();
	render_path_draw_meshes("mesh");
	render_path_paint_unbind_layers();
	if(make_mesh_layer_pass_count>1){
		render_path_base_make_gbuffer_copy_textures();
		for(i32 i=1;i<make_mesh_layer_pass_count;++i){
			string_t * ping=i%2==1?"_copy":"";
			string_t * pong=i%2==1?"":"_copy";
			if(i==make_mesh_layer_pass_count-1){
				render_path_set_target(string_join("gbuffer2",ping),null,null,clear_flag_t_COLOR,0xff000000,0.0);
			}
			string_t * g1ping=string_join("gbuffer1",ping);
			string_t * g2ping=string_join("gbuffer2",ping);
			string_t_array_t * additional=any_array_create_from_raw((any[]){g1ping,g2ping,},2);
			render_path_set_target(string_join("gbuffer0",ping),additional,"main",clear_flag_t_NONE,0,0.0);
			render_path_bind_target(string_join("gbuffer0",pong),"gbuffer0");
			render_path_bind_target(string_join("gbuffer1",pong),"gbuffer1");
			render_path_bind_target(string_join("gbuffer2",pong),"gbuffer2");
			render_path_paint_bind_layers();
			render_path_draw_meshes(string_join("mesh",i32_to_string(i)));
			render_path_paint_unbind_layers();
		}
		if(make_mesh_layer_pass_count%2==0){
			render_path_base_copy_to_gbuffer();
		}
	}
	bool hide=operator_shortcut(any_map_get(config_keymap,"stencil_hide"),shortcut_type_t_DOWN)||keyboard_down("control");
	bool is_decal=base_is_decal_layer();
	if(is_decal&&!hide){
		line_draw_color=0xff000000;
		line_draw_strength=0.005;
		string_t_array_t * additional=any_array_create_from_raw((any[]){"gbuffer1",},1);
		render_path_set_target("gbuffer0",additional,"main",clear_flag_t_NONE,0,0.0);
		line_draw_render(context_raw->layer->decal_mat);
	}
}

void render_path_base_make_gbuffer_copy_textures(){
	render_target_t * copy=any_map_get(render_path_render_targets,"gbuffer0_copy");
	render_target_t * g0=any_map_get(render_path_render_targets,"gbuffer0");
	if(copy==null||copy->_image->width!=g0->_image->width||copy->_image->height!=g0->_image->height){
			{
			render_target_t * t=render_target_create();
			t->name="gbuffer0_copy";
			t->width=0;
			t->height=0;
			t->format="RGBA64";
			t->scale=render_path_base_get_super_sampling();
			render_path_create_render_target(t);
		}
			{
			render_target_t * t=render_target_create();
			t->name="gbuffer1_copy";
			t->width=0;
			t->height=0;
			t->format="RGBA64";
			t->scale=render_path_base_get_super_sampling();
			render_path_create_render_target(t);
		}
			{
			render_target_t * t=render_target_create();
			t->name="gbuffer2_copy";
			t->width=0;
			t->height=0;
			t->format="RGBA64";
			t->scale=render_path_base_get_super_sampling();
			render_path_create_render_target(t);
		}
	}
}

void render_path_base_copy_to_gbuffer(){
	string_t_array_t * additional=any_array_create_from_raw((any[]){"gbuffer1","gbuffer2",},2);
	render_path_set_target("gbuffer0",additional,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("gbuffer0_copy","tex0");
	render_path_bind_target("gbuffer1_copy","tex1");
	render_path_bind_target("gbuffer2_copy","tex2");
	render_path_draw_shader("shader_datas/copy_mrt3_pass/copy_mrt3RGBA64_pass");
}

void render_path_deferred_init(){
		{
		render_target_t * t=render_target_create();
		t->name="main";
		t->width=0;
		t->height=0;
		t->format="D32";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="gbuffer0";
		t->width=0;
		t->height=0;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="gbuffer1";
		t->width=0;
		t->height=0;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="gbuffer2";
		t->width=0;
		t->height=0;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="buf";
		t->width=0;
		t->height=0;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="last";
		t->width=0;
		t->height=0;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="empty_white";
		t->width=1;
		t->height=1;
		t->format="R8";
		buffer_t * b=buffer_create(1);
		buffer_set_u8(b,0,255);
		t->_image=gpu_create_texture_from_bytes(b,t->width,t->height,tex_format_t_R8);
		any_map_set(render_path_render_targets,t->name,t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="empty_black";
		t->width=1;
		t->height=1;
		t->format="RGBA32";
		buffer_t * b=buffer_create(4);
		buffer_set_u8(b,0,0);
		buffer_set_u8(b,1,0);
		buffer_set_u8(b,2,0);
		buffer_set_u8(b,3,0);
		t->_image=gpu_create_texture_from_bytes(b,t->width,t->height,tex_format_t_RGBA32);
		any_map_set(render_path_render_targets,t->name,t);
	}
	if(config_raw->rp_ssao){
		render_path_base_init_ssao();
	}
	render_path_load_shader("shader_datas/world_pass/world_pass");
	render_path_load_shader("shader_datas/deferred_light/deferred_light");
	render_path_load_shader("shader_datas/compositor_pass/compositor_pass");
	render_path_load_shader("shader_datas/copy_pass/copy_pass");
	render_path_load_shader("shader_datas/copy_pass/copyR8_pass");
	render_path_load_shader("shader_datas/copy_pass/copyRGBA64_pass");
	render_path_load_shader("shader_datas/copy_pass/copyRGBA128_pass");
	render_path_load_shader("shader_datas/taa_pass/taa_pass");
	render_path_load_shader("shader_datas/supersample_resolve/supersample_resolve");
	render_path_load_shader("shader_datas/supersample_resolve/supersample_resolveRGBA64");
	render_path_paint_init();
	render_path_preview_init();
	render_path_raytrace_init();
}

void render_path_deferred_commands(){
	render_path_paint_live_brush_dirty();
	render_path_base_commands(render_path_deferred_draw_deferred);
}

void render_path_deferred_draw_deferred(){
	render_path_base_draw_ssao();
	render_path_base_draw_deferred_light();
	render_path_base_draw_bloom();
	render_path_set_target("gbuffer1",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("buf","tex");
	render_path_draw_shader("shader_datas/compositor_pass/compositor_pass");
	render_path_set_target("gbuffer1",null,null,clear_flag_t_NONE,0,0.0);
	render_path_base_draw_compass();
	render_path_draw_meshes("overlay");
	render_path_base_draw_taa("gbuffer1","buf");
}

void render_path_forward_init(){
}

void render_path_forward_commands(){
	render_path_paint_live_brush_dirty();
	render_path_base_commands(render_path_forward_draw_forward);
}

void render_path_forward_draw_forward(){
	render_path_set_target("gbuffer1",null,"main",clear_flag_t_NONE,0,0.0);
	render_path_draw_skydome("shader_datas/world_pass/world_pass");
	render_path_set_target("buf",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("gbuffer1","tex");
	render_path_draw_shader("shader_datas/compositor_pass/compositor_pass");
	render_path_set_target("buf",null,null,clear_flag_t_NONE,0,0.0);
	render_path_base_draw_compass();
	render_path_draw_meshes("overlay");
	render_path_base_draw_taa("buf","gbuffer1");
}

void render_path_preview_init(){
		{
		render_target_t * t=render_target_create();
		t->name="texpreview";
		t->width=1;
		t->height=1;
		t->format="RGBA64";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpreview_icon";
		t->width=1;
		t->height=1;
		t->format="RGBA64";
		render_path_create_render_target(t);
	}
	i32 size=math_floor(util_render_material_preview_size*2.0);
		{
		render_target_t * t=render_target_create();
		t->name="mmain";
		t->width=size;
		t->height=size;
		t->format="D32";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="mtex";
		t->width=size;
		t->height=size;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="mgbuffer0";
		t->width=size;
		t->height=size;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="mgbuffer1";
		t->width=size;
		t->height=size;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="mgbuffer2";
		t->width=size;
		t->height=size;
		t->format="RGBA64";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
}

void render_path_preview_commands_preview(){
	render_path_set_target("mgbuffer2",null,null,clear_flag_t_COLOR,0xff000000,0.0);
	render_path_set_target("mgbuffer0",null,"mmain",clear_flag_t_COLOR|clear_flag_t_DEPTH,0xffffffff,1.0);
	string_t_array_t * additional=any_array_create_from_raw((any[]){"mgbuffer1","mgbuffer2",},2);
	render_path_set_target("mgbuffer0",additional,"mmain",clear_flag_t_NONE,0,0.0);
	render_path_draw_meshes("mesh");
	render_path_set_target("mtex",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("mmain","gbufferD");
	render_path_bind_target("mgbuffer0","gbuffer0");
	render_path_bind_target("mgbuffer1","gbuffer1");
		{
		render_path_bind_target("empty_white","ssaotex");
	}
	render_path_draw_shader("shader_datas/deferred_light/deferred_light");
	render_path_set_target("mtex",null,"mmain",clear_flag_t_NONE,0,0.0);
	render_path_draw_skydome("shader_datas/world_pass/world_pass");
	string_t * framebuffer="texpreview";
	slot_material_t * selected_mat=context_raw->material;
	render_target_t * texpreview=any_map_get(render_path_render_targets,"texpreview");
	render_target_t * texpreview_icon=any_map_get(render_path_render_targets,"texpreview_icon");
	texpreview->_image=selected_mat->image;
	texpreview_icon->_image=selected_mat->image_icon;
	render_path_set_target(framebuffer,null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("mtex","tex");
	render_path_draw_shader("shader_datas/compositor_pass/compositor_pass");
	render_path_set_target("texpreview_icon",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("texpreview","tex");
	render_path_draw_shader("shader_datas/supersample_resolve/supersample_resolveRGBA64");
}

void render_path_preview_commands_decal(){
	render_path_set_target("gbuffer2",null,null,clear_flag_t_COLOR,0xff000000,0.0);
	render_path_set_target("gbuffer0",null,"main",clear_flag_t_COLOR|clear_flag_t_DEPTH,0xffffffff,1.0);
	string_t_array_t * additional=any_array_create_from_raw((any[]){"gbuffer1","gbuffer2",},2);
	render_path_set_target("gbuffer0",additional,"main",clear_flag_t_NONE,0,0.0);
	render_path_draw_meshes("mesh");
	render_path_set_target("buf",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("main","gbufferD");
	render_path_bind_target("gbuffer0","gbuffer0");
	render_path_bind_target("gbuffer1","gbuffer1");
		{
		render_path_bind_target("empty_white","ssaotex");
	}
	render_path_draw_shader("shader_datas/deferred_light/deferred_light");
	render_path_set_target("buf",null,"main",clear_flag_t_NONE,0,0.0);
	render_path_draw_skydome("shader_datas/world_pass/world_pass");
	string_t * framebuffer="texpreview";
	render_target_t * texpreview=any_map_get(render_path_render_targets,"texpreview");
	texpreview->_image=context_raw->decal_image;
	render_path_set_target(framebuffer,null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("buf","tex");
	render_path_draw_shader("shader_datas/compositor_pass/compositor_pass");
}

void render_path_raytrace_init(){
}

void render_path_raytrace_commands(bool use_live_layer){
	if(!render_path_raytrace_ready||render_path_raytrace_is_bake){
		render_path_raytrace_ready=true;
		render_path_raytrace_is_bake=false;
		string_t * ext="";
		string_t * mode=config_raw->pathtrace_mode==pathtrace_mode_t_FAST?"core":"full";
		render_path_raytrace_raytrace_init(string_join(string_join(string_join("raytrace_brute_",ext),mode),render_path_raytrace_ext),true,false);
		gc_unroot(render_path_raytrace_last_envmap);render_path_raytrace_last_envmap=null;
	}
	if(!context_raw->envmap_loaded){
		context_load_envmap();
		context_update_envmap();
	}
	world_data_t * probe=scene_world;
	gpu_texture_t * saved_envmap=context_raw->show_envmap_blur?probe->_->radiance_mipmaps->buffer[0]:context_raw->saved_envmap;
	if(render_path_raytrace_last_envmap!=saved_envmap){
		gc_unroot(render_path_raytrace_last_envmap);render_path_raytrace_last_envmap=saved_envmap;gc_root(render_path_raytrace_last_envmap);
		gpu_texture_t * bnoise_sobol=any_map_get(scene_embedded,"bnoise_sobol.k");
		gpu_texture_t * bnoise_scramble=any_map_get(scene_embedded,"bnoise_scramble.k");
		gpu_texture_t * bnoise_rank=any_map_get(scene_embedded,"bnoise_rank.k");
		slot_layer_t * l=layers_flatten(true,null);
		iron_raytrace_set_textures(l->texpaint,l->texpaint_nor,l->texpaint_pack,saved_envmap,bnoise_sobol,bnoise_scramble,bnoise_rank);
	}
	if(context_raw->pdirty>0||render_path_raytrace_dirty>0){
		layers_flatten(true,null);
	}
	camera_object_t * cam=scene_camera;
	transform_t * ct=cam->base->transform;
	render_path_raytrace_help_mat=mat4_clone(cam->v);
	render_path_raytrace_help_mat=mat4_mult_mat(render_path_raytrace_help_mat,cam->p);
	render_path_raytrace_help_mat=mat4_inv(render_path_raytrace_help_mat);
	render_path_raytrace_f32a->buffer[0]=transform_world_x(ct);
	render_path_raytrace_f32a->buffer[1]=transform_world_y(ct);
	render_path_raytrace_f32a->buffer[2]=transform_world_z(ct);
	render_path_raytrace_f32a->buffer[3]=render_path_raytrace_frame;
	render_path_raytrace_frame=(render_path_raytrace_frame%4)+1;
	render_path_raytrace_f32a->buffer[4]=render_path_raytrace_help_mat.m00;
	render_path_raytrace_f32a->buffer[5]=render_path_raytrace_help_mat.m01;
	render_path_raytrace_f32a->buffer[6]=render_path_raytrace_help_mat.m02;
	render_path_raytrace_f32a->buffer[7]=render_path_raytrace_help_mat.m03;
	render_path_raytrace_f32a->buffer[8]=render_path_raytrace_help_mat.m10;
	render_path_raytrace_f32a->buffer[9]=render_path_raytrace_help_mat.m11;
	render_path_raytrace_f32a->buffer[10]=render_path_raytrace_help_mat.m12;
	render_path_raytrace_f32a->buffer[11]=render_path_raytrace_help_mat.m13;
	render_path_raytrace_f32a->buffer[12]=render_path_raytrace_help_mat.m20;
	render_path_raytrace_f32a->buffer[13]=render_path_raytrace_help_mat.m21;
	render_path_raytrace_f32a->buffer[14]=render_path_raytrace_help_mat.m22;
	render_path_raytrace_f32a->buffer[15]=render_path_raytrace_help_mat.m23;
	render_path_raytrace_f32a->buffer[16]=render_path_raytrace_help_mat.m30;
	render_path_raytrace_f32a->buffer[17]=render_path_raytrace_help_mat.m31;
	render_path_raytrace_f32a->buffer[18]=render_path_raytrace_help_mat.m32;
	render_path_raytrace_f32a->buffer[19]=render_path_raytrace_help_mat.m33;
	render_path_raytrace_f32a->buffer[20]=scene_world->strength*1.5;
	if(!context_raw->show_envmap){
		render_path_raytrace_f32a->buffer[20]=-render_path_raytrace_f32a->buffer[20];
	}
	render_path_raytrace_f32a->buffer[21]=context_raw->envmap_angle;
	render_path_raytrace_f32a->buffer[22]=render_path_raytrace_uv_scale;
	render_target_t * framebuffer=any_map_get(render_path_render_targets,"buf");
	iron_raytrace_dispatch_rays(framebuffer->_image,render_path_raytrace_f32a);
	if(context_raw->ddirty==1||context_raw->pdirty==1){
		context_raw->rdirty=4;
	}
	context_raw->ddirty--;
	context_raw->pdirty--;
	context_raw->rdirty--;
}

void render_path_raytrace_raytrace_init(string_t * shader_name,bool build,bool bake){
	if(render_path_raytrace_first){
		render_path_raytrace_first=false;
		scene_embed_data("bnoise_sobol.k");
		scene_embed_data("bnoise_scramble.k");
		scene_embed_data("bnoise_rank.k");
		buffer_t * shader=data_get_blob(shader_name);
		iron_raytrace_init(shader);
	}
	if(build){
		render_path_raytrace_build_data(bake);
	}
		{
		iron_raytrace_as_init();
		iron_raytrace_as_add(render_path_raytrace_vb,render_path_raytrace_ib,render_path_raytrace_transform);
		gpu_buffer_t * vb_full=context_raw->merged_object->data->_->vertex_buffer;
		gpu_buffer_t * ib_full=context_raw->merged_object->data->_->index_buffers->buffer[0];
		iron_raytrace_as_build(vb_full,ib_full);
	}
}

void render_path_raytrace_build_data(bool bake){
	if(context_raw->merged_object==null){
		util_mesh_merge(null);
	}
	mesh_object_t * mo=!context_layer_filter_used()?context_raw->merged_object:context_raw->paint_object;
	render_path_raytrace_transform=mat4_identity();
	if(!bake){
		f32 sc=mo->base->transform->scale.x*mo->data->scale_pos;
		if(mo->base->parent!=null){
			sc*=mo->base->parent->transform->scale.x;
		}
		render_path_raytrace_transform=mat4_scale(render_path_raytrace_transform,vec4_create(sc,sc,sc,1.0));
	}
	gc_unroot(render_path_raytrace_vb);render_path_raytrace_vb=mo->data->_->vertex_buffer;gc_root(render_path_raytrace_vb);
	gc_unroot(render_path_raytrace_ib);render_path_raytrace_ib=mo->data->_->index_buffers->buffer[0];gc_root(render_path_raytrace_ib);
}

void render_path_raytrace_draw(bool use_live_layer){
	bool is_live=config_raw->brush_live&&render_path_paint_live_layer_drawn>0;
	if(context_raw->ddirty>1||context_raw->pdirty>0||is_live){
		render_path_raytrace_frame=0;
	}
	render_path_raytrace_commands(use_live_layer);
	render_path_base_draw_bloom();
	render_path_set_target("buf",null,null,clear_flag_t_NONE,0,0.0);
	render_path_draw_meshes("overlay");
	render_path_set_target("buf",null,null,clear_flag_t_NONE,0,0.0);
	render_path_base_draw_compass();
	render_path_set_target("last",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("buf","tex");
	render_path_draw_shader("shader_datas/compositor_pass/compositor_pass");
	render_path_set_target("",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("last","tex");
	render_path_draw_shader("shader_datas/copy_pass/copy_pass");
	if(config_raw->brush_3d){
		render_path_paint_commands_cursor();
	}
}

bool render_path_raytrace_bake_commands(void(*parse_paint_material)(bool)){
	if(!render_path_raytrace_ready||!render_path_raytrace_is_bake||render_path_raytrace_bake_last_bake!=context_raw->bake_type){
		bool rebuild=!(render_path_raytrace_ready&&render_path_raytrace_is_bake&&render_path_raytrace_bake_last_bake!=context_raw->bake_type);
		render_path_raytrace_bake_last_bake=context_raw->bake_type;
		render_path_raytrace_ready=true;
		render_path_raytrace_is_bake=true;
		gc_unroot(render_path_raytrace_last_envmap);render_path_raytrace_last_envmap=null;
		gc_unroot(render_path_raytrace_bake_last_layer);render_path_raytrace_bake_last_layer=null;
		if(any_map_get(render_path_render_targets,"baketex0")!=null){
			render_target_t * baketex0=any_map_get(render_path_render_targets,"baketex0");
			render_target_t * baketex1=any_map_get(render_path_render_targets,"baketex1");
			render_target_t * baketex2=any_map_get(render_path_render_targets,"baketex2");
			iron_delete_texture(baketex0->_image);
			iron_delete_texture(baketex1->_image);
			iron_delete_texture(baketex2->_image);
		}
			{
			render_target_t * t=render_target_create();
			t->name="baketex0";
			t->width=config_get_texture_res_x();
			t->height=config_get_texture_res_y();
			t->format="RGBA64";
			render_path_create_render_target(t);
		}
			{
			render_target_t * t=render_target_create();
			t->name="baketex1";
			t->width=config_get_texture_res_x();
			t->height=config_get_texture_res_y();
			t->format="RGBA64";
			render_path_create_render_target(t);
		}
			{
			render_target_t * t=render_target_create();
			t->name="baketex2";
			t->width=config_get_texture_res_x();
			t->height=config_get_texture_res_y();
			t->format="RGBA64";
			render_path_create_render_target(t);
		}
		bake_type_t _bake_type=context_raw->bake_type;
		context_raw->bake_type=bake_type_t_INIT;
		parse_paint_material(true);
		render_path_set_target("baketex0",null,null,clear_flag_t_COLOR,0x00000000,0.0);
		string_t_array_t * additional=any_array_create_from_raw((any[]){"baketex1",},1);
		render_path_set_target("baketex0",additional,null,clear_flag_t_NONE,0,0.0);
		render_path_draw_meshes("paint");
		context_raw->bake_type=_bake_type;
		sys_notify_on_next_frame(parse_paint_material,null);
		render_path_raytrace_first=true;
		render_path_raytrace_raytrace_init(render_path_raytrace_bake_get_bake_shader_name(),rebuild,true);
		return false;
	}
	if(!context_raw->envmap_loaded){
		context_load_envmap();
		context_update_envmap();
	}
	world_data_t * probe=scene_world;
	gpu_texture_t * saved_envmap=context_raw->show_envmap_blur?probe->_->radiance_mipmaps->buffer[0]:context_raw->saved_envmap;
	if(render_path_raytrace_last_envmap!=saved_envmap||render_path_raytrace_bake_last_layer!=context_raw->layer->texpaint){
		gc_unroot(render_path_raytrace_last_envmap);render_path_raytrace_last_envmap=saved_envmap;gc_root(render_path_raytrace_last_envmap);
		gc_unroot(render_path_raytrace_bake_last_layer);render_path_raytrace_bake_last_layer=context_raw->layer->texpaint;gc_root(render_path_raytrace_bake_last_layer);
		gpu_texture_t * bnoise_sobol=any_map_get(scene_embedded,"bnoise_sobol.k");
		gpu_texture_t * bnoise_scramble=any_map_get(scene_embedded,"bnoise_scramble.k");
		gpu_texture_t * bnoise_rank=any_map_get(scene_embedded,"bnoise_rank.k");
		render_target_t * baketex0=any_map_get(render_path_render_targets,"baketex0");
		render_target_t * baketex1=any_map_get(render_path_render_targets,"baketex1");
		render_target_t * texpaint_undo=any_map_get(render_path_render_targets,string_join("texpaint_undo",i32_to_string(history_undo_i)));
		iron_raytrace_set_textures(baketex0->_image,baketex1->_image,texpaint_undo->_image,saved_envmap,bnoise_sobol,bnoise_scramble,bnoise_rank);
	}
	if(context_raw->brush_time>0){
		context_raw->pdirty=2;
		context_raw->rdirty=2;
	}
	if(context_raw->pdirty>0){
		f32_array_t * f32a=render_path_raytrace_f32a;
		f32a->buffer[0]=render_path_raytrace_frame++;
		f32a->buffer[1]=context_raw->bake_ao_strength;
		f32a->buffer[2]=context_raw->bake_ao_radius;
		f32a->buffer[3]=context_raw->bake_ao_offset;
		f32a->buffer[4]=scene_world->strength;
		f32a->buffer[5]=context_raw->bake_up_axis;
		f32a->buffer[6]=context_raw->envmap_angle;
		render_target_t * framebuffer=any_map_get(render_path_render_targets,"baketex2");
		iron_raytrace_dispatch_rays(framebuffer->_image,f32a);
		i32 id=context_raw->layer->id;
		string_t * texpaint_id=string_join("texpaint",i32_to_string(id));
		render_path_set_target(texpaint_id,null,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target("baketex2","tex");
		render_path_draw_shader("shader_datas/copy_pass/copy_pass");
		i32 samples_per_frame=64;
		render_path_raytrace_bake_rays_pix=render_path_raytrace_frame*samples_per_frame;
		render_path_raytrace_bake_rays_counter+=samples_per_frame;
		render_path_raytrace_bake_rays_timer+=sys_real_delta();
		if(render_path_raytrace_bake_rays_timer>=1){
			render_path_raytrace_bake_rays_sec=render_path_raytrace_bake_rays_counter;
			render_path_raytrace_bake_rays_timer=0;
			render_path_raytrace_bake_rays_counter=0;
		}
		render_path_raytrace_bake_current_sample++;
		iron_delay_idle_sleep();
		return true;
	}
	else {
		render_path_raytrace_frame=0;
		render_path_raytrace_bake_rays_timer=0;
		render_path_raytrace_bake_rays_counter=0;
		render_path_raytrace_bake_current_sample=0;
		return false;
	}
}

string_t * render_path_raytrace_bake_get_bake_shader_name(){
	return context_raw->bake_type==bake_type_t_AO?string_join("raytrace_bake_ao",render_path_raytrace_ext):context_raw->bake_type==bake_type_t_LIGHTMAP?string_join("raytrace_bake_light",render_path_raytrace_ext):context_raw->bake_type==bake_type_t_BENT_NORMAL?string_join("raytrace_bake_bent",render_path_raytrace_ext):string_join("raytrace_bake_thick",render_path_raytrace_ext);
}

void resource_load(string_t_array_t * names){
	for(i32 i=0;i<names->length;++i){
		string_t * s=names->buffer[i];
		gpu_texture_t * image=data_get_image(s);
		any_map_set(resource_bundled,s,image);
	}
}

gpu_texture_t * resource_get(string_t * name){
	return any_map_get(resource_bundled,name);
}

rect_t * resource_tile50(gpu_texture_t * img,i32 x,i32 y){
	i32 size=config_raw->window_scale>1?100:50;
	rect_t * r=GC_ALLOC_INIT(rect_t, {.x=x*size,.y=y*size,.w=size,.h=size});
	return r;
}

rect_t * resource_tile25(gpu_texture_t * img,i32 x,i32 y){
	i32 size=config_raw->window_scale>1?50:25;
	rect_t * r=GC_ALLOC_INIT(rect_t, {.x=x*size,.y=y*size,.w=size,.h=size});
	return r;
}

rect_t * resource_tile18(gpu_texture_t * img,i32 x,i32 y){
	i32 size=config_raw->window_scale>1?36:18;
	rect_t * r=GC_ALLOC_INIT(rect_t, {.x=x*size,.y=img->height-(y+1)*size,.w=size,.h=size});
	return r;
}

slot_brush_t * slot_brush_create(ui_node_canvas_t * c){
	slot_brush_t * raw=GC_ALLOC_INIT(slot_brush_t, {0});
	raw->nodes=ui_nodes_create();
	raw->preview_ready=false;
	raw->id=0;
	for(i32 i=0;i<project_brushes->length;++i){
		slot_brush_t * brush=project_brushes->buffer[i];
		if(brush->id>=raw->id){
			raw->id=brush->id+1;
		}
	}
	if(c==null){
		if(slot_brush_default_canvas==null){
			buffer_t * b=data_get_blob("default_brush.arm");
			gc_unroot(slot_brush_default_canvas);slot_brush_default_canvas=b;gc_root(slot_brush_default_canvas);
		}
		raw->canvas=armpack_decode(slot_brush_default_canvas);
		raw->canvas=util_clone_canvas(raw->canvas);
		i32 id=(raw->id+1);
		raw->canvas->name=string_join("Brush ",i32_to_string(id));
	}
	else {
		raw->canvas=util_clone_canvas(c);
	}
	return raw;
}

slot_font_t * slot_font_create(string_t * name,draw_font_t * font,string_t * file){
	slot_font_t * raw=GC_ALLOC_INIT(slot_font_t, {0});
	raw->preview_ready=false;
	raw->id=0;
	for(i32 i=0;i<project_fonts->length;++i){
		slot_font_t * slot=project_fonts->buffer[i];
		if(slot->id>=raw->id){
			raw->id=slot->id+1;
		}
	}
	raw->name=string_copy(name);
	raw->font=font;
	raw->file=string_copy(file);
	return raw;
}

slot_layer_t * slot_layer_create(string_t * ext,layer_slot_type_t type,slot_layer_t * parent){
	slot_layer_t * raw=GC_ALLOC_INIT(slot_layer_t, {0});
	raw->id=0;
	raw->ext="";
	raw->visible=true;
	raw->mask_opacity=1.0;
	raw->show_panel=true;
	raw->blending=blend_type_t_MIX;
	raw->object_mask=0;
	raw->scale=1.0;
	raw->angle=0.0;
	raw->uv_type=uv_type_t_UVMAP;
	raw->paint_base=true;
	raw->paint_opac=true;
	raw->paint_occ=true;
	raw->paint_rough=true;
	raw->paint_met=true;
	raw->paint_nor=true;
	raw->paint_nor_blend=true;
	raw->paint_height=true;
	raw->paint_height_blend=true;
	raw->paint_emis=true;
	raw->paint_subs=true;
	raw->decal_mat=mat4_identity();
	if(string_equals(ext,"")){
		raw->id=0;
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			if(l->id>=raw->id){
				raw->id=l->id+1;
			}
		}
		ext=string_join(i32_to_string(raw->id),"");
	}
	raw->ext=string_copy(ext);
	raw->parent=parent;
	if(type==layer_slot_type_t_GROUP){
		i32 id=(raw->id+1);
		raw->name=string_join("Group ",i32_to_string(id));
	}
	else if(type==layer_slot_type_t_LAYER){
		i32 id=(raw->id+1);
		raw->name=string_join("Layer ",i32_to_string(id));
		string_t * format=base_bits_handle->position==texture_bits_t_BITS8?"RGBA32":base_bits_handle->position==texture_bits_t_BITS16?"RGBA64":"RGBA128";
			{
			render_target_t * t=render_target_create();
			t->name=string_join("texpaint",ext);
			t->width=config_get_texture_res_x();
			t->height=config_get_texture_res_y();
			t->format=string_copy(format);
			raw->texpaint=render_path_create_render_target(t)->_image;
		}
			{
			render_target_t * t=render_target_create();
			t->name=string_join("texpaint_nor",ext);
			t->width=config_get_texture_res_x();
			t->height=config_get_texture_res_y();
			t->format=string_copy(format);
			raw->texpaint_nor=render_path_create_render_target(t)->_image;
		}
			{
			render_target_t * t=render_target_create();
			t->name=string_join("texpaint_pack",ext);
			t->width=config_get_texture_res_x();
			t->height=config_get_texture_res_y();
			t->format=string_copy(format);
			raw->texpaint_pack=render_path_create_render_target(t)->_image;
		}
		raw->texpaint_preview=gpu_create_render_target(util_render_layer_preview_size,util_render_layer_preview_size,tex_format_t_RGBA32);
	}
	else {
		i32 id=(raw->id+1);
		raw->name=string_join("Mask ",i32_to_string(id));
		string_t * format="RGBA32";
		raw->blending=blend_type_t_ADD;
			{
			render_target_t * t=render_target_create();
			t->name=string_join("texpaint",ext);
			t->width=config_get_texture_res_x();
			t->height=config_get_texture_res_y();
			t->format=string_copy(format);
			raw->texpaint=render_path_create_render_target(t)->_image;
		}
		raw->texpaint_preview=gpu_create_render_target(util_render_layer_preview_size,util_render_layer_preview_size,tex_format_t_RGBA32);
	}
	return raw;
}

void slot_layer_delete(slot_layer_t * raw){
	slot_layer_unload(raw);
	if(slot_layer_is_layer(raw)){
		slot_layer_t_array_t * masks=slot_layer_get_masks(raw,false);
		if(masks!=null){
			for(i32 i=0;i<masks->length;++i){
				slot_layer_t * m=masks->buffer[i];
				slot_layer_delete(m);
			}
		}
	}
	else if(slot_layer_is_group(raw)){
		slot_layer_t_array_t * children=slot_layer_get_children(raw);
		if(children!=null){
			for(i32 i=0;i<children->length;++i){
				slot_layer_t * c=children->buffer[i];
				slot_layer_delete(c);
			}
		}
		slot_layer_t_array_t * masks=slot_layer_get_masks(raw,true);
		if(masks!=null){
			for(i32 i=0;i<masks->length;++i){
				slot_layer_t * m=masks->buffer[i];
				slot_layer_delete(m);
			}
		}
	}
	i32 lpos=array_index_of(project_layers,raw);
	array_remove(project_layers,raw);
	if(project_layers->length>0){
		context_set_layer(project_layers->buffer[lpos>0?lpos-1:0]);
	}
}

void slot_layer_unload(slot_layer_t * raw){
	if(slot_layer_is_group(raw)){
		return ;
	}
	gpu_texture_t * _texpaint=raw->texpaint;
	gpu_texture_t * _texpaint_nor=raw->texpaint_nor;
	gpu_texture_t * _texpaint_pack=raw->texpaint_pack;
	gpu_texture_t * _texpaint_preview=raw->texpaint_preview;
	iron_delete_texture(_texpaint);
	if(_texpaint_nor!=null){
		iron_delete_texture(_texpaint_nor);
	}
	if(_texpaint_pack!=null){
		iron_delete_texture(_texpaint_pack);
	}
	if(_texpaint_preview!=null){
		iron_delete_texture(_texpaint_preview);
	}
	map_delete(render_path_render_targets,string_join("texpaint",raw->ext));
	if(slot_layer_is_layer(raw)){
		map_delete(render_path_render_targets,string_join("texpaint_nor",raw->ext));
		map_delete(render_path_render_targets,string_join("texpaint_pack",raw->ext));
	}
}

void slot_layer_swap(slot_layer_t * raw,slot_layer_t * other){
	if((slot_layer_is_layer(raw)||slot_layer_is_mask(raw))&&(slot_layer_is_layer(other)||slot_layer_is_mask(other))){
		render_target_t * rt0=any_map_get(render_path_render_targets,string_join("texpaint",raw->ext));
		render_target_t * rt1=any_map_get(render_path_render_targets,string_join("texpaint",other->ext));
		rt0->_image=other->texpaint;
		rt1->_image=raw->texpaint;
		gpu_texture_t * _texpaint=raw->texpaint;
		raw->texpaint=other->texpaint;
		other->texpaint=_texpaint;
		gpu_texture_t * _texpaint_preview=raw->texpaint_preview;
		raw->texpaint_preview=other->texpaint_preview;
		other->texpaint_preview=_texpaint_preview;
	}
	if(slot_layer_is_layer(raw)&&slot_layer_is_layer(other)){
		render_target_t * nor0=any_map_get(render_path_render_targets,string_join("texpaint_nor",raw->ext));
		nor0->_image=other->texpaint_nor;
		render_target_t * pack0=any_map_get(render_path_render_targets,string_join("texpaint_pack",raw->ext));
		pack0->_image=other->texpaint_pack;
		render_target_t * nor1=any_map_get(render_path_render_targets,string_join("texpaint_nor",other->ext));
		nor1->_image=raw->texpaint_nor;
		render_target_t * pack1=any_map_get(render_path_render_targets,string_join("texpaint_pack",other->ext));
		pack1->_image=raw->texpaint_pack;
		gpu_texture_t * _texpaint_nor=raw->texpaint_nor;
		gpu_texture_t * _texpaint_pack=raw->texpaint_pack;
		raw->texpaint_nor=other->texpaint_nor;
		raw->texpaint_pack=other->texpaint_pack;
		other->texpaint_nor=_texpaint_nor;
		other->texpaint_pack=_texpaint_pack;
	}
}

void slot_layer_clear(slot_layer_t * raw,i32 base_color,gpu_texture_t * base_image,f32 occlusion,f32 roughness,f32 metallic){
	_gpu_begin(raw->texpaint,null,null,clear_flag_t_COLOR,base_color,0.0);
	gpu_end();
	if(base_image!=null){
		draw_begin(raw->texpaint,false,0);
		draw_scaled_image(base_image,0,0,raw->texpaint->width,raw->texpaint->height);
		draw_end();
	}
	if(slot_layer_is_layer(raw)){
		_gpu_begin(raw->texpaint_nor,null,null,clear_flag_t_COLOR,color_from_floats(0.5,0.5,1.0,0.0),0.0);
		gpu_end();
		_gpu_begin(raw->texpaint_pack,null,null,clear_flag_t_COLOR,color_from_floats(occlusion,roughness,metallic,0.0),0.0);
		gpu_end();
	}
	context_raw->layer_preview_dirty=true;
	context_raw->ddirty=3;
}

void slot_layer_invert_mask(slot_layer_t * raw){
	gpu_texture_t * inverted=gpu_create_render_target(raw->texpaint->width,raw->texpaint->height,tex_format_t_RGBA32);
	draw_begin(inverted,false,0);
	draw_set_pipeline(pipes_invert8);
	draw_image(raw->texpaint,0,0);
	draw_set_pipeline(null);
	draw_end();
	gpu_texture_t * _texpaint=raw->texpaint;
	iron_delete_texture(_texpaint);
	render_target_t * rt=any_map_get(render_path_render_targets,string_join("texpaint",i32_to_string(raw->id)));
	raw->texpaint=rt->_image=inverted;
	context_raw->layer_preview_dirty=true;
	context_raw->ddirty=3;
}

void slot_layer_apply_mask(slot_layer_t * raw){
	if(raw->parent->fill_layer!=null){
		slot_layer_to_paint_layer(raw->parent);
	}
	if(slot_layer_is_group(raw->parent)){
		for(i32 i=0;i<slot_layer_get_children(raw->parent)->length;++i){
			slot_layer_t * c=slot_layer_get_children(raw->parent)->buffer[i];
			layers_apply_mask(c,raw);
		}
	}
	else {
		layers_apply_mask(raw->parent,raw);
	}
	slot_layer_delete(raw);
}

slot_layer_t * slot_layer_duplicate(slot_layer_t * raw){
	slot_layer_t_array_t * layers=project_layers;
	i32 i=array_index_of(layers,raw)+1;
	slot_layer_t * l=slot_layer_create("",slot_layer_is_layer(raw)?layer_slot_type_t_LAYER:slot_layer_is_mask(raw)?layer_slot_type_t_MASK:layer_slot_type_t_GROUP,raw->parent);
	array_insert(layers,i,l);
	if(slot_layer_is_layer(raw)){
		draw_begin(l->texpaint,false,0);
		draw_set_pipeline(pipes_copy);
		draw_image(raw->texpaint,0,0);
		draw_set_pipeline(null);
		draw_end();
		if(l->texpaint_nor!=null){
			draw_begin(l->texpaint_nor,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(raw->texpaint_nor,0,0);
			draw_set_pipeline(null);
			draw_end();
		}
		if(l->texpaint_pack!=null){
			draw_begin(l->texpaint_pack,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(raw->texpaint_pack,0,0);
			draw_set_pipeline(null);
			draw_end();
		}
	}
	else if(slot_layer_is_mask(raw)){
		draw_begin(l->texpaint,false,0);
		draw_set_pipeline(pipes_copy8);
		draw_image(raw->texpaint,0,0);
		draw_set_pipeline(null);
		draw_end();
	}
	if(l->texpaint_preview!=null){
		draw_begin(l->texpaint_preview,true,0x00000000);
		draw_set_pipeline(pipes_copy);
		draw_scaled_image(raw->texpaint_preview,0,0,raw->texpaint_preview->width,raw->texpaint_preview->height);
		draw_set_pipeline(null);
		draw_end();
	}
	l->visible=raw->visible;
	l->mask_opacity=raw->mask_opacity;
	l->fill_layer=raw->fill_layer;
	l->object_mask=raw->object_mask;
	l->blending=raw->blending;
	l->uv_type=raw->uv_type;
	l->scale=raw->scale;
	l->angle=raw->angle;
	l->paint_base=raw->paint_base;
	l->paint_opac=raw->paint_opac;
	l->paint_occ=raw->paint_occ;
	l->paint_rough=raw->paint_rough;
	l->paint_met=raw->paint_met;
	l->paint_nor=raw->paint_nor;
	l->paint_nor_blend=raw->paint_nor_blend;
	l->paint_height=raw->paint_height;
	l->paint_height_blend=raw->paint_height_blend;
	l->paint_emis=raw->paint_emis;
	l->paint_subs=raw->paint_subs;
	return l;
}

void slot_layer_resize_and_set_bits(slot_layer_t * raw){
	i32 res_x=config_get_texture_res_x();
	i32 res_y=config_get_texture_res_y();
	any_map_t * rts=render_path_render_targets;
	if(slot_layer_is_layer(raw)){
		tex_format_t format=base_bits_handle->position==texture_bits_t_BITS8?tex_format_t_RGBA32:base_bits_handle->position==texture_bits_t_BITS16?tex_format_t_RGBA64:tex_format_t_RGBA128;
		gpu_pipeline_t * pipe=format==tex_format_t_RGBA32?pipes_copy:format==tex_format_t_RGBA64?pipes_copy64:pipes_copy128;
		gpu_texture_t * _texpaint=raw->texpaint;
		raw->texpaint=gpu_create_render_target(res_x,res_y,format);
		draw_begin(raw->texpaint,false,0);
		draw_set_pipeline(pipe);
		draw_scaled_image(_texpaint,0,0,res_x,res_y);
		draw_set_pipeline(null);
		draw_end();
		gpu_texture_t * _texpaint_nor=raw->texpaint_nor;
		if(raw->texpaint_nor!=null){
			raw->texpaint_nor=gpu_create_render_target(res_x,res_y,format);
			draw_begin(raw->texpaint_nor,false,0);
			draw_set_pipeline(pipe);
			draw_scaled_image(_texpaint_nor,0,0,res_x,res_y);
			draw_set_pipeline(null);
			draw_end();
		}
		gpu_texture_t * _texpaint_pack=raw->texpaint_pack;
		if(raw->texpaint_pack!=null){
			raw->texpaint_pack=gpu_create_render_target(res_x,res_y,format);
			draw_begin(raw->texpaint_pack,false,0);
			draw_set_pipeline(pipe);
			draw_scaled_image(_texpaint_pack,0,0,res_x,res_y);
			draw_set_pipeline(null);
			draw_end();
		}
		iron_delete_texture(_texpaint);
		if(_texpaint_nor!=null){
			iron_delete_texture(_texpaint_nor);
		}
		if(_texpaint_pack!=null){
			iron_delete_texture(_texpaint_pack);
		}
		render_target_t * rt=any_map_get(rts,string_join("texpaint",raw->ext));
		rt->_image=raw->texpaint;
		if(raw->texpaint_nor!=null){
			render_target_t * rt_nor=any_map_get(rts,string_join("texpaint_nor",raw->ext));
			rt_nor->_image=raw->texpaint_nor;
		}
		if(raw->texpaint_pack!=null){
			render_target_t * rt_pack=any_map_get(rts,string_join("texpaint_pack",raw->ext));
			rt_pack->_image=raw->texpaint_pack;
		}
	}
	else if(slot_layer_is_mask(raw)){
		gpu_texture_t * _texpaint=raw->texpaint;
		raw->texpaint=gpu_create_render_target(res_x,res_y,tex_format_t_RGBA32);
		draw_begin(raw->texpaint,false,0);
		draw_set_pipeline(pipes_copy8);
		draw_scaled_image(_texpaint,0,0,res_x,res_y);
		draw_set_pipeline(null);
		draw_end();
		iron_delete_texture(_texpaint);
		render_target_t * rt=any_map_get(rts,string_join("texpaint",raw->ext));
		rt->_image=raw->texpaint;
	}
}

void slot_layer_to_fill_layer(slot_layer_t * raw){
	context_set_layer(raw);
	raw->fill_layer=context_raw->material;
	layers_update_fill_layer(true);
	sys_notify_on_next_frame(&slot_layer_to_fill_layer_113168	,null);
}

void slot_layer_to_fill_layer_113168(){
make_material_parse_paint_material(true);
	context_raw->layer_preview_dirty=true;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
}

void slot_layer_to_paint_layer(slot_layer_t * raw){
	context_set_layer(raw);
	raw->fill_layer=null;
	make_material_parse_paint_material(true);
	context_raw->layer_preview_dirty=true;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
}

bool slot_layer_is_visible(slot_layer_t * raw){
	return raw->visible&&(raw->parent==null||raw->parent->visible);
}

slot_layer_t_array_t * slot_layer_get_children(slot_layer_t * raw){
	slot_layer_t_array_t * children=null;
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(l->parent==raw&&slot_layer_is_layer(l)){
			if(children==null){
				children=any_array_create_from_raw((any[]){},0);
			}
			any_array_push(children,l);
		}
	}
	return children;
}

slot_layer_t_array_t * slot_layer_get_recursive_children(slot_layer_t * raw){
	slot_layer_t_array_t * children=null;
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(l->parent==raw){
			if(children==null){
				children=any_array_create_from_raw((any[]){},0);
			}
			any_array_push(children,l);
		}
		if(l->parent!=null&&l->parent->parent==raw){
			if(children==null){
				children=any_array_create_from_raw((any[]){},0);
			}
			any_array_push(children,l);
		}
	}
	return children;
}

slot_layer_t_array_t * slot_layer_get_masks(slot_layer_t * raw,bool include_group_masks){
	if(slot_layer_is_mask(raw)){
		return null;
	}
	slot_layer_t_array_t * children=null;
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(l->parent==raw&&slot_layer_is_mask(l)){
			if(children==null){
				children=any_array_create_from_raw((any[]){},0);
			}
			any_array_push(children,l);
		}
	}
	if(include_group_masks){
		if(raw->parent!=null&&slot_layer_is_group(raw->parent)){
			for(i32 i=0;i<project_layers->length;++i){
				slot_layer_t * l=project_layers->buffer[i];
				if(l->parent==raw->parent&&slot_layer_is_mask(l)){
					if(children==null){
						children=any_array_create_from_raw((any[]){},0);
					}
					any_array_push(children,l);
				}
			}
		}
	}
	return children;
}

bool slot_layer_has_masks(slot_layer_t * raw,bool include_group_masks){
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(l->parent==raw&&slot_layer_is_mask(l)){
			return true;
		}
	}
	if(include_group_masks&&raw->parent!=null&&slot_layer_is_group(raw->parent)){
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			if(l->parent==raw->parent&&slot_layer_is_mask(l)){
				return true;
			}
		}
	}
	return false;
}

f32 slot_layer_get_opacity(slot_layer_t * raw){
	f32 f=raw->mask_opacity;
	if(slot_layer_is_layer(raw)&&raw->parent!=null){
		f*=raw->parent->mask_opacity;
	}
	return f;
}

i32 slot_layer_get_object_mask(slot_layer_t * raw){
	return slot_layer_is_mask(raw)?raw->parent->object_mask:raw->object_mask;
}

bool slot_layer_is_layer(slot_layer_t * raw){
	return raw->texpaint!=null&&raw->texpaint_nor!=null;
}

bool slot_layer_is_group(slot_layer_t * raw){
	return raw->texpaint==null;
}

slot_layer_t * slot_layer_get_containing_group(slot_layer_t * raw){
	if(raw->parent!=null&&slot_layer_is_group(raw->parent)){
		return raw->parent;
	}
	else if(raw->parent!=null&&raw->parent->parent!=null&&slot_layer_is_group(raw->parent->parent)){
		return raw->parent->parent;
	}
	else {
		return null;
	}
}

bool slot_layer_is_mask(slot_layer_t * raw){
	return raw->texpaint!=null&&raw->texpaint_nor==null;
}

bool slot_layer_is_group_mask(slot_layer_t * raw){
	return raw->texpaint!=null&&raw->texpaint_nor==null&&slot_layer_is_group(raw->parent);
}

bool slot_layer_is_layer_mask(slot_layer_t * raw){
	return raw->texpaint!=null&&raw->texpaint_nor==null&&slot_layer_is_layer(raw->parent);
}

bool slot_layer_is_in_group(slot_layer_t * raw){
	return raw->parent!=null&&(slot_layer_is_group(raw->parent)||(raw->parent->parent!=null&&slot_layer_is_group(raw->parent->parent)));
}

bool slot_layer_can_move(slot_layer_t * raw,i32 to){
	i32 old_index=array_index_of(project_layers,raw);
	i32 delta=to-old_index;
	if(to<0||to>project_layers->length-1||delta==0){
		return false;
	}
	slot_layer_t * new_upper_layer=delta>0?(to<project_layers->length-1?project_layers->buffer[to+1]:null):project_layers->buffer[to];
	if(new_upper_layer!=null&&!new_upper_layer->show_panel){
		slot_layer_t_array_t * children=slot_layer_get_recursive_children(new_upper_layer);
		to-=children!=null?children->length:0;
		delta=to-old_index;
		new_upper_layer=delta>0?(to<project_layers->length-1?project_layers->buffer[to+1]:null):project_layers->buffer[to];
	}
	slot_layer_t * new_lower_layer=delta>0?project_layers->buffer[to]:(to>0?project_layers->buffer[to-1]:null);
	if(slot_layer_is_mask(raw)){
		if(new_upper_layer==null){
			return false;
		}
		if(slot_layer_is_in_group(new_upper_layer)&&!slot_layer_get_containing_group(new_upper_layer)->show_panel){
			return false;
		}
		if(slot_layer_is_mask(new_upper_layer)&&!new_upper_layer->parent->show_panel){
			return false;
		}
	}
	if(slot_layer_is_layer(raw)){
		if(new_upper_layer!=null&&slot_layer_is_mask(new_upper_layer)&&new_upper_layer->parent==raw){
			return false;
		}
		if(new_lower_layer!=null&&slot_layer_is_mask(new_lower_layer)){
			return false;
		}
	}
	if(slot_layer_is_group(raw)){
		if(new_upper_layer==null){
			return true;
		}
		if(slot_layer_get_containing_group(new_upper_layer)==raw){
			return false;
		}
		if(new_lower_layer==null){
			return true;
		}
		if(slot_layer_is_group(new_lower_layer)){
			return true;
		}
		if(slot_layer_is_layer(new_lower_layer)&&!slot_layer_is_in_group(new_lower_layer)){
			return true;
		}
		else {
			return false;
		}
	}
	return true;
}

void slot_layer_move(slot_layer_t * raw,i32 to){
	if(!slot_layer_can_move(raw,to)){
		return ;
	}
	i32_map_t * pointers=tab_layers_init_layer_map();
	i32 old_index=array_index_of(project_layers,raw);
	i32 delta=to-old_index;
	slot_layer_t * new_upper_layer=delta>0?(to<project_layers->length-1?project_layers->buffer[to+1]:null):project_layers->buffer[to];
	if(new_upper_layer!=null&&!new_upper_layer->show_panel){
		slot_layer_t_array_t * children=slot_layer_get_recursive_children(new_upper_layer);
		to-=children!=null?children->length:0;
		delta=to-old_index;
		new_upper_layer=delta>0?(to<project_layers->length-1?project_layers->buffer[to+1]:null):project_layers->buffer[to];
	}
	context_set_layer(raw);
	history_order_layers(to);
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	array_remove(project_layers,raw);
	array_insert(project_layers,to,raw);
	if(slot_layer_is_layer(raw)){
		slot_layer_t * old_parent=raw->parent;
		if(new_upper_layer==null){
			raw->parent=null;
		}
		else if(slot_layer_is_in_group(new_upper_layer)&&!slot_layer_get_containing_group(new_upper_layer)->show_panel){
			raw->parent=null;
		}
		else if(slot_layer_is_layer(new_upper_layer)){
			raw->parent=new_upper_layer->parent;
		}
		else if(slot_layer_is_group(new_upper_layer)){
			raw->parent=new_upper_layer;
		}
		else if(slot_layer_is_group_mask(new_upper_layer)){
			raw->parent=new_upper_layer->parent;
		}
		else if(slot_layer_is_layer_mask(new_upper_layer)){
			raw->parent=slot_layer_get_containing_group(new_upper_layer);
		}
		slot_layer_t_array_t * layer_masks=slot_layer_get_masks(raw,false);
		if(layer_masks!=null){
			for(i32 idx=0;idx<layer_masks->length;++idx){
				slot_layer_t * mask=layer_masks->buffer[idx];
				array_remove(project_layers,mask);
				array_insert(project_layers,delta>0?old_index+delta-1:old_index+delta+idx,mask);
			}
		}
		if(old_parent!=null&&slot_layer_get_children(old_parent)==null){
			slot_layer_delete(old_parent);
		}
	}
	else if(slot_layer_is_mask(raw)){
		if(slot_layer_is_layer(new_upper_layer)||slot_layer_is_group(new_upper_layer)){
			raw->parent=new_upper_layer;
		}
		else if(slot_layer_is_mask(new_upper_layer)){
			raw->parent=new_upper_layer->parent;
		}
	}
	else if(slot_layer_is_group(raw)){
		slot_layer_t_array_t * children=slot_layer_get_recursive_children(raw);
		if(children!=null){
			for(i32 idx=0;idx<children->length;++idx){
				slot_layer_t * child=children->buffer[idx];
				array_remove(project_layers,child);
				array_insert(project_layers,delta>0?old_index+delta-1:old_index+delta+idx,child);
			}
		}
	}
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		tab_layers_remap_layer_pointers(m->canvas->nodes,tab_layers_fill_layer_map(pointers));
	}
}

slot_material_t * slot_material_create(material_data_t * m,ui_node_canvas_t * c){
	slot_material_t * raw=GC_ALLOC_INIT(slot_material_t, {0});
	raw->nodes=ui_nodes_create();
	raw->preview_ready=false;
	raw->id=0;
	raw->paint_base=true;
	raw->paint_opac=true;
	raw->paint_occ=true;
	raw->paint_rough=true;
	raw->paint_met=true;
	raw->paint_nor=true;
	raw->paint_height=true;
	raw->paint_emis=true;
	raw->paint_subs=true;
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * mat=project_materials->buffer[i];
		if(mat->id>=raw->id){
			raw->id=mat->id+1;
		}
	}
	raw->data=m;
	i32 w=util_render_material_preview_size;
	i32 w_icon=50;
	raw->image=gpu_create_render_target(w,w,tex_format_t_RGBA64);
	raw->image_icon=gpu_create_render_target(w_icon,w_icon,tex_format_t_RGBA64);
	if(c==null){
		if(slot_material_default_canvas==null){
			buffer_t * b=data_get_blob("default_material.arm");
			gc_unroot(slot_material_default_canvas);slot_material_default_canvas=b;gc_root(slot_material_default_canvas);
		}
		raw->canvas=armpack_decode(slot_material_default_canvas);
		raw->canvas=util_clone_canvas(raw->canvas);
		i32 id=(raw->id+1);
		raw->canvas->name=string_join("Material ",i32_to_string(id));
	}
	else {
		raw->canvas=util_clone_canvas(c);
	}
	return raw;
}

void slot_material_unload(slot_material_t * raw){
	iron_delete_texture(raw->image);
	iron_delete_texture(raw->image_icon);
}

void slot_material_delete(slot_material_t * raw){
	slot_material_unload(raw);
	i32 mpos=array_index_of(project_materials,raw);
	array_remove(project_materials,raw);
	if(project_materials->length>0){
		context_set_material(project_materials->buffer[mpos>0?mpos-1:0]);
	}
}

string_t * strings_arm_file_expected(){
	return tr("Error: .arm file expected",null);
}

string_t * strings_unknown_asset_format(){
	return tr("Error: Unknown asset format",null);
}

string_t * strings_could_not_locate_texture(){
	return tr("Error: Could not locate texture",null);
}

string_t * strings_failed_to_read_mesh_data(){
	return tr("Error: Failed to read mesh data",null);
}

string_t * strings_check_internet_connection(){
	return tr("Error: Check internet connection to access the cloud",null);
}

string_t * strings_asset_already_imported(){
	return tr("Info: Asset already imported",null);
}

string_t * strings_graphics_api(){
	return "Direct3D12";
}

void tab_browser_show_directory(string_t * directory){
	tab_browser_hpath->text=string_copy(directory);
	tab_browser_hsearch->text="";
	ui_base_htabs->buffer[tab_area_t_STATUS]->position=0;
}

void tab_browser_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_tab(htab,tr("Browser",null),false,-1)&&statush>ui_status_default_status_h*ui_SCALE(ui)){
		if(config_raw->bookmarks==null){
			config_raw->bookmarks=any_array_create_from_raw((any[]){},0);
		}
		i32 bookmarks_w=math_floor(100*ui_SCALE(ui));
		if(string_equals(tab_browser_hpath->text,"")&&config_raw->bookmarks->length>0){
			tab_browser_hpath->text=string_copy(config_raw->bookmarks->buffer[0]);
			tab_browser_hpath->text=string_copy(string_replace_all(tab_browser_hpath->text,"/","\\"));
		}
		ui_begin_sticky();
		f32 step=(1.0-bookmarks_w/(float)ui->_w);
		if(!string_equals(tab_browser_hsearch->text,"")){
			f32_array_t * row=f32_array_create_from_raw((f32[]){bookmarks_w/(float)ui->_w,step*0.07,step*0.07,step*0.66,step*0.17,step*0.03,},6);
			ui_row(row);
		}
		else {
			f32_array_t * row=f32_array_create_from_raw((f32[]){bookmarks_w/(float)ui->_w,step*0.07,step*0.07,step*0.66,step*0.2,},5);
			ui_row(row);
		}
		if(ui_button("+",ui_align_t_CENTER,"")){
			string_t * bookmark=tab_browser_hpath->text;
			bookmark=string_copy(string_replace_all(bookmark,"\\","/"));
			any_array_push(config_raw->bookmarks,bookmark);
			config_save();
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Add bookmark",null));
		}
		bool refresh=false;
		bool in_focus=ui->input_x>ui->_window_x&&ui->input_x<ui->_window_x+ui->_window_w&&ui->input_y>ui->_window_y&&ui->input_y<ui->_window_y+ui->_window_h;
		if(ui_button(tr("Refresh",null),ui_align_t_CENTER,"")||(in_focus&&ui->is_key_pressed&&ui->key_code==key_code_t_F5)){
			refresh=true;
		}
		string_t * text=tab_browser_hpath->text;
		i32 i1=string_index_of(text,path_sep);
		bool nested=i1>-1&&string_length(text)-1>i1;
		nested=nested&&!(string_length(text)>=2&&string_equals(char_at(text,0),path_sep)&&string_equals(char_at(text,1),path_sep)&&string_last_index_of(text,path_sep)==1);
		ui->enabled=nested;
		if(ui_button("<",ui_align_t_CENTER,"")){
			ui_files_go_up(tab_browser_hpath);
		}
		ui->enabled=true;
		if(ui->is_hovered){
			ui_tooltip(tr("Previous folder",null));
		}
		tab_browser_hpath->text=string_copy(ui_text_input(tab_browser_hpath,tr("Path",null),ui_align_t_LEFT,true,false));
		tab_browser_hsearch->text=string_copy(ui_text_input(tab_browser_hsearch,tr("Search",null),ui_align_t_LEFT,true,true));
		if(ui->is_hovered){
			ui_tooltip(string_join(string_join(tr("ctrl+f to search",null),"\n"),tr("esc to cancel",null)));
		}
		if(ui->is_ctrl_down&&ui->is_key_pressed&&ui->key_code==key_code_t_F){
			ui_start_text_edit(tab_browser_hsearch,ui_align_t_LEFT);
		}
		if(!string_equals(tab_browser_hsearch->text,"")&&(ui_button(tr("X",null),ui_align_t_CENTER,"")||ui->is_escape_down)){
			tab_browser_hsearch->text="";
		}
		ui_end_sticky();
		if(!string_equals(tab_browser_last_path,tab_browser_hpath->text)){
			tab_browser_hsearch->text="";
		}
		gc_unroot(tab_browser_last_path);tab_browser_last_path=string_copy(tab_browser_hpath->text);gc_root(tab_browser_last_path);
		f32 _y=ui->_y;
		ui->_x=bookmarks_w;
		ui->_w-=bookmarks_w;
		ui_files_file_browser(ui,tab_browser_hpath,true,tab_browser_hsearch->text,refresh,&tab_browser_draw_116193		);
		if(tab_browser_known){
			string_t * path=tab_browser_hpath->text;
			sys_notify_on_init(&tab_browser_draw_116654			,path);
			tab_browser_hpath->text=string_copy(substring(tab_browser_hpath->text,0,string_last_index_of(tab_browser_hpath->text,path_sep)));
		}
		string_t * hpath_text=tab_browser_hpath->text;
		tab_browser_known=string_index_of(substring(tab_browser_hpath->text,string_last_index_of(tab_browser_hpath->text,path_sep),string_length(hpath_text)),".")>0;
		i32 bottom_y=ui->_y;
		ui->_x=0;
		ui->_y=_y;
		ui->_w=bookmarks_w;
		if(ui_button(tr("Cloud",null),ui_align_t_LEFT,"")){
			tab_browser_hpath->text="cloud";
		}
		if(ui_button(tr("Disk",null),ui_align_t_LEFT,"")){
			tab_browser_hpath->text=string_copy(ui_files_default_path);
		}
		for(i32 i=0;i<config_raw->bookmarks->length;++i){
			string_t * b=config_raw->bookmarks->buffer[i];
			string_t * folder=substring(b,string_last_index_of(b,"/")+1,string_length(b));
			if(ui_button(folder,ui_align_t_LEFT,"")){
				tab_browser_hpath->text=string_copy(b);
				tab_browser_hpath->text=string_copy(string_replace_all(tab_browser_hpath->text,"/","\\"));
			}
			if(ui->is_hovered&&ui->input_released_r){
				gc_unroot(_tab_browser_draw_b);_tab_browser_draw_b=string_copy(b);gc_root(_tab_browser_draw_b);
				ui_menu_draw(&tab_browser_draw_116859				,-1,-1);
			}
		}
		if(ui->_y<bottom_y){
			ui->_y=bottom_y;
		}
	}
}

void tab_browser_draw_116859(ui_t * ui){
if(ui_menu_button(tr("Delete",null),"")){
					char_ptr_array_remove(config_raw->bookmarks,_tab_browser_draw_b);
					config_save();
				}
}

void tab_browser_draw_116654(string_t * path){
import_asset_run(path,-1.0,-1.0,true,true,null);
}

void tab_browser_draw_116520(){
string_t * file=_tab_browser_draw_file;
				i32 asset_index=-1;
				for(i32 i=0;i<project_assets->length;++i){
					if(string_equals(project_assets->buffer[i]->file,file)){
						asset_index=i;
						break;
					}
				}
				if(asset_index!=-1){
					context_raw->colorid_handle->position=asset_index;
					context_raw->colorid_picked=false;
					ui_toolbar_handle->redraws=1;
					if(context_raw->tool==workspace_tool_t_COLORID){
						ui_header_handle->redraws=2;
						context_raw->ddirty=2;
					}
				}
}

void tab_browser_draw_116514(){
sys_notify_on_next_frame(&tab_browser_draw_116520				,null);
}

void tab_browser_draw_116415(){
string_t * file=_tab_browser_draw_file;
				i32 asset_index=-1;
				for(i32 i=0;i<project_assets->length;++i){
					if(string_equals(project_assets->buffer[i]->file,file)){
						asset_index=i;
						break;
					}
				}
				if(asset_index!=-1){
					layers_create_image_mask(project_assets->buffer[asset_index]);
				}
}

void tab_browser_draw_116409(){
sys_notify_on_next_frame(&tab_browser_draw_116415				,null);
}

void tab_browser_draw_116305(){
string_t * file=_tab_browser_draw_file;
				i32 asset_index=-1;
				for(i32 i=0;i<project_assets->length;++i){
					if(string_equals(project_assets->buffer[i]->file,file)){
						asset_index=i;
						break;
					}
				}
				if(asset_index!=-1){
					import_envmap_run(file,project_get_image(project_assets->buffer[asset_index]));
				}
}

void tab_browser_draw_116299(){
sys_notify_on_next_frame(&tab_browser_draw_116305				,null);
}

void tab_browser_draw_116237(ui_t * ui){
string_t * file=_tab_browser_draw_file;
		if(ui_menu_button(tr("Import",null),"")){
			import_asset_run(file,-1.0,-1.0,true,true,null);
		}
		if(path_is_texture(file)){
			if(ui_menu_button(tr("Set as Envmap",null),"")){
				import_asset_run(file,-1.0,-1.0,true,true,&tab_browser_draw_116299				);
			}
			if(ui_menu_button(tr("Set as Mask",null),"")){
				import_asset_run(file,-1.0,-1.0,true,true,&tab_browser_draw_116409				);
			}
			if(ui_menu_button(tr("Set as Color ID Map",null),"")){
				import_asset_run(file,-1.0,-1.0,true,true,&tab_browser_draw_116514				);
			}
		}
		if(ui_menu_button(tr("Open Externally",null),"")){
			file_start(file);
		}
}

void tab_browser_draw_116193(string_t * file){
string_t * file_name=substring(file,string_last_index_of(file,path_sep)+1,string_length(file));
		if(string_equals(file_name,"..")){
			return ;
		}
		gc_unroot(_tab_browser_draw_file);_tab_browser_draw_file=string_copy(file);gc_root(_tab_browser_draw_file);
		ui_menu_draw(&tab_browser_draw_116237		,-1,-1);
}

void tab_brushes_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	if(ui_tab(htab,tr("Brushes",null),false,-1)){
		ui_begin_sticky();
		f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,1/(float)4,},3);
		ui_row(row);
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
			context_raw->brush=slot_brush_create(null);
			any_array_push(project_brushes,context_raw->brush);
			make_material_parse_brush();
			ui_nodes_hwnd->redraws=2;
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			project_import_brush();
		}
		if(ui_button(tr("Nodes",null),ui_align_t_CENTER,"")){
			ui_base_show_brush_nodes();
		}
		ui_end_sticky();
		ui_separator(3,false);
		i32 slotw=math_floor(51*ui_SCALE(ui));
		i32 num=math_floor(config_raw->layout->buffer[layout_size_t_SIDEBAR_W]/(float)slotw);
		if(num==0){
			return ;
		}
		for(i32 row=0;row<math_floor(math_ceil(project_brushes->length/(float)num));++row){
			i32 mult=config_raw->show_asset_names?2:1;
			f32_array_t * ar=f32_array_create_from_raw((f32[]){},0);
			for(i32 i=0;i<num*mult;++i){
				f32_array_push(ar,1/(float)num);
			}
			ui_row(ar);
			ui->_x+=2;
			f32 off=config_raw->show_asset_names?ui_ELEMENT_OFFSET(ui)*10.0:6;
			if(row>0){
				ui->_y+=off;
			}
			for(i32 j=0;j<num;++j){
				i32 imgw=math_floor(50*ui_SCALE(ui));
				i32 i=j+row*num;
				if(i>=project_brushes->length){
					_ui_end_element(imgw);
					if(config_raw->show_asset_names){
						_ui_end_element(0);
					}
					continue;
				}
				gpu_texture_t * img=ui_SCALE(ui)>1?project_brushes->buffer[i]->image:project_brushes->buffer[i]->image_icon;
				gpu_texture_t * img_full=project_brushes->buffer[i]->image;
				if(context_raw->brush==project_brushes->buffer[i]){
					i32 off=row%2==1?1:0;
					i32 w=50;
					if(config_raw->window_scale>1){
						w+=math_floor(config_raw->window_scale*2);
					}
					ui_fill(-1,-2,w+3,2,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(-1,w-off,w+3,2+off,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(-1,-2,2,w+3,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(w+1,-2,2,w+4,ui->ops->theme->HIGHLIGHT_COL);
				}
				f32 uix=ui->_x;
				i32 tile=ui_SCALE(ui)>1?100:50;
				ui_state_t state=project_brushes->buffer[i]->preview_ready?_ui_image(img,0xffffffff,-1.0,0,0,0,0):_ui_image(resource_get("icons.k"),-1,-1.0,tile*5,tile,tile,tile);
				if(state==ui_state_t_STARTED){
					if(context_raw->brush!=project_brushes->buffer[i]){
						context_select_brush(i);
					}
					if(sys_time()-context_raw->select_time<0.25){
						ui_base_show_brush_nodes();
					}
					context_raw->select_time=sys_time();
				}
				if(ui->is_hovered&&ui->input_released_r){
					context_select_brush(i);
					_tab_brushes_draw_i=i;
					ui_menu_draw(&tab_brushes_draw_117542					,-1,-1);
				}
				if(ui->is_hovered){
					if(img_full==null){
						_tab_brushes_draw_i=i;
						sys_notify_on_init(&tab_brushes_draw_117693						,null);
					}
					else {
						ui_tooltip_image(img_full,0);
						ui_tooltip(project_brushes->buffer[i]->canvas->name);
					}
				}
				if(config_raw->show_asset_names){
					ui->_x=uix;
					ui->_y+=slotw*0.9;
					ui_text(project_brushes->buffer[i]->canvas->name,ui_align_t_CENTER,0x00000000);
					if(ui->is_hovered){
						ui_tooltip(project_brushes->buffer[i]->canvas->name);
					}
					ui->_y-=slotw*0.9;
					if(i==project_brushes->length-1){
						ui->_y+=j==num-1?imgw:imgw+ui_ELEMENT_H(ui)+ui_ELEMENT_OFFSET(ui);
					}
				}
			}
			ui->_y+=6;
		}
		bool in_focus=ui->input_x>ui->_window_x&&ui->input_x<ui->_window_x+ui->_window_w&&ui->input_y>ui->_window_y&&ui->input_y<ui->_window_y+ui->_window_h;
		if(in_focus&&ui->is_delete_down&&project_brushes->length>1){
			ui->is_delete_down=false;
			tab_brushes_delete_brush(context_raw->brush);
		}
	}
}

void tab_brushes_draw_117693(){
i32 i=_tab_brushes_draw_i;
						slot_brush_t * _brush=context_raw->brush;
						context_raw->brush=project_brushes->buffer[i];
						make_material_parse_brush();
						util_render_make_brush_preview();
						context_raw->brush=_brush;
}

void tab_brushes_draw_117590(){
i32 i=_tab_brushes_draw_i;
						context_raw->brush=slot_brush_create(null);
						any_array_push(project_brushes,context_raw->brush);
						any cloned=util_clone_canvas(project_brushes->buffer[i]->canvas);
						context_raw->brush->canvas=cloned;
						context_set_brush(context_raw->brush);
						util_render_make_brush_preview();
}

void tab_brushes_draw_117542(ui_t * ui){
i32 i=_tab_brushes_draw_i;
					if(ui_menu_button(tr("Export",null),"")){
						context_select_brush(i);
						box_export_show_brush();
					}
					if(ui_menu_button(tr("Duplicate",null),"")){
						sys_notify_on_init(&tab_brushes_draw_117590						,null);
					}
					if(project_brushes->length>1&&ui_menu_button(tr("Delete",null),"delete")){
						tab_brushes_delete_brush(project_brushes->buffer[i]);
					}
}

void tab_brushes_delete_brush(slot_brush_t * b){
	i32 i=array_index_of(project_brushes,b);
	context_select_brush(i==project_brushes->length-1?i-1:i+1);
	array_splice(project_brushes,i,1);
	ui_base_hwnds->buffer[1]->redraws=2;
}

void tab_console_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	string_t * title=console_message_timer>0?string_join(console_message,"        "):tr("Console",null);
	i32 color=console_message_timer>0?console_message_color:-1;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_tab(htab,title,false,color)&&statush>ui_status_default_status_h*ui_SCALE(ui)){
		ui_begin_sticky();
		if(config_raw->touch_ui){
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,1/(float)4,},3);
			ui_row(row);
		}
		else {
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)14,1/(float)14,1/(float)14,},3);
			ui_row(row);
		}
		if(ui_button(tr("Clear",null),ui_align_t_CENTER,"")){
			gc_unroot(console_last_traces);console_last_traces=any_array_create_from_raw((any[]){},0);gc_root(console_last_traces);
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_files_show("txt",true,false,&tab_console_draw_118121			);
		}
		if(ui_button(tr("Copy",null),ui_align_t_CENTER,"")){
			string_t * str=string_array_join(console_last_traces,"\n");
			iron_copy_to_clipboard(str);
		}
		ui_end_sticky();
		draw_font_t * _font=ui->ops->font;
		i32 _font_size=ui->font_size;
		draw_font_t * f=data_get_font("font_mono.ttf");
		ui_set_font(ui,f);
		ui->font_size=math_floor(15*ui_SCALE(ui));
		for(i32 i=0;i<console_last_traces->length;++i){
			string_t * t=console_last_traces->buffer[i];
			ui_text(t,ui_align_t_LEFT,0x00000000);
		}
		ui_set_font(ui,_font);
		ui->font_size=_font_size;
	}
}

void tab_console_draw_118121(string_t * path){
string_t * str=string_array_join(console_last_traces,"\n");
			string_t * f=ui_files_filename;
			if(string_equals(f,"")){
				f=string_copy(tr("untitled",null));
			}
			path=string_join(string_join(path,path_sep),f);
			if(!ends_with(path,".txt")){
				path=string_join(path,".txt");
			}
			iron_file_save_bytes(path,sys_string_to_buffer(str),0);
}

void tab_fonts_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_tab(htab,tr("Fonts",null),false,-1)&&statush>ui_status_default_status_h*ui_SCALE(ui)){
		ui_begin_sticky();
		if(config_raw->touch_ui){
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,},2);
			ui_row(row);
		}
		else {
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)14,1/(float)14,},2);
			ui_row(row);
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			project_import_asset("ttf,ttc,otf",true);
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Import font file",null));
		}
		if(ui_button(tr("2D View",null),ui_align_t_CENTER,"")){
			ui_base_show_2d_view(view_2d_type_t_FONT);
		}
		ui_end_sticky();
		ui_separator(3,false);
		i32 statusw=iron_window_width()-ui_toolbar_w(true)-config_raw->layout->buffer[layout_size_t_SIDEBAR_W];
		i32 slotw=math_floor(51*ui_SCALE(ui));
		i32 num=math_floor(statusw/(float)slotw);
		if(num==0){
			return ;
		}
		for(i32 row=0;row<math_floor(math_ceil(project_fonts->length/(float)num));++row){
			i32 mult=config_raw->show_asset_names?2:1;
			f32_array_t * ar=f32_array_create_from_raw((f32[]){},0);
			for(i32 i=0;i<num*mult;++i){
				f32_array_push(ar,1/(float)num);
			}
			ui_row(ar);
			ui->_x+=2;
			f32 off=config_raw->show_asset_names?ui_ELEMENT_OFFSET(ui)*10.0:6;
			if(row>0){
				ui->_y+=off;
			}
			for(i32 j=0;j<num;++j){
				i32 imgw=math_floor(50*ui_SCALE(ui));
				i32 i=j+row*num;
				if(i>=project_fonts->length){
					_ui_end_element(imgw);
					if(config_raw->show_asset_names){
						_ui_end_element(0);
					}
					continue;
				}
				gpu_texture_t * img=project_fonts->buffer[i]->image;
				if(context_raw->font==project_fonts->buffer[i]){
					i32 off=row%2==1?1:0;
					i32 w=50;
					if(config_raw->window_scale>1){
						w+=math_floor(config_raw->window_scale*2);
					}
					ui_fill(-1,-2,w+3,2,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(-1,w-off,w+3,2+off,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(-1,-2,2,w+3,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(w+1,-2,2,w+4,ui->ops->theme->HIGHLIGHT_COL);
				}
				f32 uix=ui->_x;
				i32 tile=ui_SCALE(ui)>1?100:50;
				ui_state_t state=ui_state_t_IDLE;
				if(project_fonts->buffer[i]->preview_ready){
					state=_ui_image(img,0xffffffff,-1.0,0,0,0,0);
				}
				else {
					state=_ui_image(resource_get("icons.k"),-1,-1.0,tile*6,tile,tile,tile);
				}
				if(state==ui_state_t_STARTED){
					if(context_raw->font!=project_fonts->buffer[i]){
						_tab_fonts_draw_i=i;
						sys_notify_on_init(&tab_fonts_draw_118950						,null);
					}
					if(sys_time()-context_raw->select_time<0.25){
						ui_base_show_2d_view(view_2d_type_t_FONT);
					}
					context_raw->select_time=sys_time();
				}
				if(ui->is_hovered&&ui->input_released_r){
					context_select_font(i);
					_tab_fonts_draw_i=i;
					ui_menu_draw(&tab_fonts_draw_119012					,-1,-1);
				}
				if(ui->is_hovered){
					if(img==null){
						_tab_fonts_draw_i=i;
						sys_notify_on_init(&tab_fonts_draw_119082						,null);
					}
					else {
						ui_tooltip_image(img,0);
						ui_tooltip(project_fonts->buffer[i]->name);
					}
				}
				if(config_raw->show_asset_names){
					ui->_x=uix;
					ui->_y+=slotw*0.9;
					ui_text(project_fonts->buffer[i]->name,ui_align_t_CENTER,0x00000000);
					if(ui->is_hovered){
						ui_tooltip(project_fonts->buffer[i]->name);
					}
					ui->_y-=slotw*0.9;
					if(i==project_fonts->length-1){
						ui->_y+=j==num-1?imgw:imgw+ui_ELEMENT_H(ui)+ui_ELEMENT_OFFSET(ui);
					}
				}
			}
			ui->_y+=6;
		}
		bool in_focus=ui->input_x>ui->_window_x&&ui->input_x<ui->_window_x+ui->_window_w&&ui->input_y>ui->_window_y&&ui->input_y<ui->_window_y+ui->_window_h;
		if(in_focus&&ui->is_delete_down&&project_fonts->length>1&&!string_equals(context_raw->font->file,"")){
			ui->is_delete_down=false;
			tab_fonts_delete_font(context_raw->font);
		}
	}
}

void tab_fonts_draw_119082(){
i32 i=_tab_fonts_draw_i;
						slot_font_t * _font=context_raw->font;
						context_raw->font=project_fonts->buffer[i];
						util_render_make_font_preview();
						context_raw->font=_font;
}

void tab_fonts_draw_119012(ui_t * ui){
i32 i=_tab_fonts_draw_i;
					if(project_fonts->length>1&&ui_menu_button(tr("Delete",null),"delete")&&!string_equals(project_fonts->buffer[i]->file,"")){
						tab_fonts_delete_font(project_fonts->buffer[i]);
					}
}

void tab_fonts_draw_118950(){
i32 i=_tab_fonts_draw_i;
						context_select_font(i);
}

void tab_fonts_delete_font(slot_font_t * font){
	sys_notify_on_init(&tab_fonts_delete_font_119285	,font);
	ui_base_hwnds->buffer[2]->redraws=2;
}

void tab_fonts_delete_font_119285(slot_font_t * font){
i32 i=array_index_of(project_fonts,font);
	context_select_font(i==project_fonts->length-1?i-1:i+1);
	data_delete_font(project_fonts->buffer[i]->file);
	array_splice(project_fonts,i,1);
}

void tab_history_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	if(ui_tab(htab,tr("History",null),false,-1)){
		for(i32 i=0;i<history_steps->length;++i){
			i32 active=history_steps->length-1-history_redos;
			if(i==active){
				ui_fill(0,0,ui->_window_w,ui->ops->theme->ELEMENT_H,ui->ops->theme->HIGHLIGHT_COL);
			}
			ui_text(history_steps->buffer[i]->name,ui_align_t_LEFT,0x00000000);
			if(ui->is_released){
				i32 diff=i-active;
				while(diff>0){
					diff--;
					history_redo();
				}
				while(diff<0){
					diff++;
					history_undo();
				}
			}
			ui_fill(0,0,(ui->_window_w/(float)ui_SCALE(ui)-2),1*ui_SCALE(ui),ui->ops->theme->SEPARATOR_COL);
		}
	}
}

void tab_layers_draw(ui_handle_t * htab){
	bool mini=config_raw->layout->buffer[layout_size_t_SIDEBAR_W]<=ui_base_sidebar_mini_w;
	mini?tab_layers_draw_mini(htab):tab_layers_draw_full(htab);
}

void tab_layers_draw_mini(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	ui_set_hovered_tab_name(tr("Layers",null));
	i32 _ELEMENT_H=ui->ops->theme->ELEMENT_H;
	ui->ops->theme->ELEMENT_H=math_floor(ui_base_sidebar_mini_w/(float)2/(float)ui_SCALE(ui));
	ui_begin_sticky();
	ui_separator(5,true);
	tab_layers_combo_filter();
	tab_layers_button_2d_view();
	tab_layers_button_new("+");
	ui_end_sticky();
	ui->_y+=2;
	tab_layers_highlight_odd_lines();
	tab_layers_draw_slots(true);
	ui->ops->theme->ELEMENT_H=_ELEMENT_H;
}

void tab_layers_draw_full(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	if(ui_tab(htab,tr("Layers",null),false,-1)){
		ui_begin_sticky();
		f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,1/(float)2,},3);
		ui_row(row);
		tab_layers_button_new(tr("New",null));
		tab_layers_button_2d_view();
		tab_layers_combo_filter();
		ui_end_sticky();
		ui->_y+=2;
		tab_layers_highlight_odd_lines();
		tab_layers_draw_slots(false);
	}
}

void tab_layers_button_2d_view(){
	ui_t * ui=ui_base_ui;
	if(ui_button(tr("2D View",null),ui_align_t_CENTER,"")){
		ui_base_show_2d_view(view_2d_type_t_LAYER);
	}
	else if(ui->is_hovered){
		ui_tooltip(string_join(string_join(string_join(tr("Show 2D View",null)," ("),any_map_get(config_keymap,"toggle_2d_view")),")"));
	}
}

void tab_layers_draw_slots(bool mini){
	for(i32 i=0;i<project_layers->length;++i){
		if(i>=project_layers->length){
			break;
		}
		i32 j=project_layers->length-1-i;
		slot_layer_t * l=project_layers->buffer[j];
		tab_layers_draw_layer_slot(l,j,mini);
	}
}

void tab_layers_highlight_odd_lines(){
	ui_t * ui=ui_base_ui;
	i32 step=ui->ops->theme->ELEMENT_H*2;
	i32 full_h=ui->_window_h-ui_base_hwnds->buffer[0]->scroll_offset;
	for(i32 i=0;i<math_floor(full_h/(float)step);++i){
		if(i%2==0){
			ui_fill(0,i*step,(ui->_w/(float)ui_SCALE(ui)-2),step,ui->ops->theme->WINDOW_BG_COL-0x00040404);
		}
	}
}

void tab_layers_button_new(string_t * text){
	if(ui_button(text,ui_align_t_CENTER,"")){
		ui_menu_draw(&tab_layers_button_new_119993		,-1,-1);
	}
}

void tab_layers_button_new_120254(slot_layer_t * m){
slot_layer_to_fill_layer(m);
}

void tab_layers_button_new_120179(slot_layer_t * m){
slot_layer_clear(m,0xffffffff,null,1.0,layers_default_rough,0.0);
}

void tab_layers_button_new_120104(slot_layer_t * m){
slot_layer_clear(m,0x00000000,null,1.0,layers_default_rough,0.0);
}

void tab_layers_button_new_119993(ui_t * ui){
slot_layer_t * l=context_raw->layer;
		if(ui_menu_button(tr("Paint Layer",null),"")){
			layers_new_layer(true,-1);
			history_new_layer();
		}
		if(ui_menu_button(tr("Fill Layer",null),"")){
			layers_create_fill_layer(uv_type_t_UVMAP,mat4nan,-1);
		}
		if(ui_menu_button(tr("Decal Layer",null),"")){
			layers_create_fill_layer(uv_type_t_PROJECT,mat4nan,-1);
		}
		if(ui_menu_button(tr("Black Mask",null),"")){
			if(slot_layer_is_mask(l)){
				context_set_layer(l->parent);
			}
			l=context_raw->layer;
			slot_layer_t * m=layers_new_mask(false,l,-1);
			sys_notify_on_next_frame(&tab_layers_button_new_120104			,m);
			context_raw->layer_preview_dirty=true;
			history_new_black_mask();
			layers_update_fill_layers();
		}
		if(ui_menu_button(tr("White Mask",null),"")){
			if(slot_layer_is_mask(l)){
				context_set_layer(l->parent);
			}
			l=context_raw->layer;
			slot_layer_t * m=layers_new_mask(false,l,-1);
			sys_notify_on_next_frame(&tab_layers_button_new_120179			,m);
			context_raw->layer_preview_dirty=true;
			history_new_white_mask();
			layers_update_fill_layers();
		}
		if(ui_menu_button(tr("Fill Mask",null),"")){
			if(slot_layer_is_mask(l)){
				context_set_layer(l->parent);
			}
			l=context_raw->layer;
			slot_layer_t * m=layers_new_mask(false,l,-1);
			sys_notify_on_init(&tab_layers_button_new_120254			,m);
			context_raw->layer_preview_dirty=true;
			history_new_fill_mask();
			layers_update_fill_layers();
		}
		ui->enabled=!slot_layer_is_group(context_raw->layer)&&!slot_layer_is_in_group(context_raw->layer);
		if(ui_menu_button(tr("Group",null),"")){
			if(slot_layer_is_group(l)||slot_layer_is_in_group(l)){
				return ;
			}
			if(slot_layer_is_layer_mask(l)){
				l=l->parent;
			}
			i32_map_t * pointers=tab_layers_init_layer_map();
			slot_layer_t * group=layers_new_group();
			context_set_layer(l);
			array_remove(project_layers,group);
			array_insert(project_layers,array_index_of(project_layers,l)+1,group);
			l->parent=group;
			for(i32 i=0;i<project_materials->length;++i){
				slot_material_t * m=project_materials->buffer[i];
				tab_layers_remap_layer_pointers(m->canvas->nodes,tab_layers_fill_layer_map(pointers));
			}
			context_set_layer(group);
			history_new_group();
		}
		ui->enabled=true;
}

void tab_layers_combo_filter(){
	string_t_array_t * ar=any_array_create_from_raw((any[]){tr("All",null),},1);
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		any_array_push(ar,p->base->name);
	}
	string_t_array_t * atlases=project_get_used_atlases();
	if(atlases!=null){
		for(i32 i=0;i<atlases->length;++i){
			string_t * a=atlases->buffer[i];
			any_array_push(ar,a);
		}
	}
	ui_handle_t * filter_handle=ui_handle("tab_layers.ts:183");
	filter_handle->position=context_raw->layer_filter;
	context_raw->layer_filter=ui_combo(filter_handle,ar,tr("Filter",null),false,ui_align_t_LEFT,true);
	if(filter_handle->changed){
		for(i32 i=0;i<project_paint_objects->length;++i){
			mesh_object_t * p=project_paint_objects->buffer[i];
			string_t * filter_name=ar->buffer[context_raw->layer_filter];
			p->base->visible=context_raw->layer_filter==0||string_equals(p->base->name,filter_name)||project_is_atlas_object(p);
		}
		if(context_raw->layer_filter==0&&context_raw->merged_object_is_atlas){
			util_mesh_merge(null);
		}
		else if(context_raw->layer_filter>project_paint_objects->length){
			mesh_object_t_array_t * visibles=any_array_create_from_raw((any[]){},0);
			for(i32 i=0;i<project_paint_objects->length;++i){
				mesh_object_t * p=project_paint_objects->buffer[i];
				if(p->base->visible){
					any_array_push(visibles,p);
				}
			}
			util_mesh_merge(visibles);
		}
		layers_set_object_mask();
		util_uv_uvmap_cached=false;
		context_raw->ddirty=2;
		render_path_raytrace_ready=false;
	}
}

void tab_layers_remap_layer_pointers(ui_node_t_array_t * nodes,i32_imap_t * pointer_map){
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * n=nodes->buffer[i];
		if(string_equals(n->type,"LAYER")||string_equals(n->type,"LAYER_MASK")){
			i32 i=n->buttons->buffer[0]->default_value->buffer[0];
			if(i32_imap_get(pointer_map,i)!=-1){
				n->buttons->buffer[0]->default_value->buffer[0]=i32_imap_get(pointer_map,i);
			}
		}
	}
}

i32_map_t * tab_layers_init_layer_map(){
	i32_map_t * res=any_map_create();
	for(i32 i=0;i<project_layers->length;++i){
		i32_map_set(res,project_layers->buffer[i],i);
	}
	return res;
}

i32_imap_t * tab_layers_fill_layer_map(i32_map_t * map){
	i32_imap_t * res=any_map_create();
	string_t_array_t * keys=map_keys(map);
	for(i32 i=0;i<keys->length;++i){
		string_t * l=keys->buffer[i];
		i32_imap_set(res,i32_map_get(map,l),array_index_of(project_layers,l)>-1?array_index_of(project_layers,l):9999);
	}
	return res;
}

void tab_layers_set_drag_layer(slot_layer_t * layer,f32 off_x,f32 off_y){
	base_drag_off_x=off_x;
	base_drag_off_y=off_y;
	gc_unroot(base_drag_layer);base_drag_layer=layer;gc_root(base_drag_layer);
	context_raw->drag_dest=array_index_of(project_layers,layer);
}

void tab_layers_draw_layer_slot(slot_layer_t * l,i32 i,bool mini){
	ui_t * ui=ui_base_ui;
	if(context_raw->layer_filter>0&&slot_layer_get_object_mask(l)>0&&slot_layer_get_object_mask(l)!=context_raw->layer_filter){
		return ;
	}
	if(l->parent!=null&&!l->parent->show_panel){
		return ;
	}
	if(l->parent!=null&&l->parent->parent!=null&&!l->parent->parent->show_panel){
		return ;
	}
	i32 step=ui->ops->theme->ELEMENT_H;
	f32 checkw=(ui->_window_w/(float)100*8)/(float)ui_SCALE(ui);
	f32 absy=ui->_window_y+ui->_y;
	if(base_is_dragging&&base_drag_layer!=null&&context_in_layers()){
		if(mouse_y>absy+step&&mouse_y<absy+step*3){
			bool down=array_index_of(project_layers,base_drag_layer)>=i;
			context_raw->drag_dest=down?i:i-1;
			slot_layer_t_array_t * ls=project_layers;
			i32 dest=context_raw->drag_dest;
			bool to_group=down?dest>0&&ls->buffer[dest-1]->parent!=null&&ls->buffer[dest-1]->parent->show_panel:dest<ls->length&&ls->buffer[dest]->parent!=null&&ls->buffer[dest]->parent->show_panel;
			bool nested_group=slot_layer_is_group(base_drag_layer)&&to_group;
			if(!nested_group){
				if(slot_layer_can_move(context_raw->layer,context_raw->drag_dest)){
					ui_fill(checkw,step*2,(ui->_window_w/(float)ui_SCALE(ui)-2)-checkw,2*ui_SCALE(ui),ui->ops->theme->HIGHLIGHT_COL);
				}
			}
		}
		else if(i==project_layers->length-1&&mouse_y<absy+step){
			context_raw->drag_dest=project_layers->length-1;
			if(slot_layer_can_move(context_raw->layer,context_raw->drag_dest)){
				ui_fill(checkw,0,(ui->_window_w/(float)ui_SCALE(ui)-2)-checkw,2*ui_SCALE(ui),ui->ops->theme->HIGHLIGHT_COL);
			}
		}
	}
	if(base_is_dragging&&(base_drag_material!=null||base_drag_swatch!=null)&&context_in_layers()){
		if(mouse_y>absy+step&&mouse_y<absy+step*3){
			context_raw->drag_dest=i;
			if(tab_layers_can_drop_new_layer(i)){
				ui_fill(checkw,2*step,(ui->_window_w/(float)ui_SCALE(ui)-2)-checkw,2*ui_SCALE(ui),ui->ops->theme->HIGHLIGHT_COL);
			}
		}
		else if(i==project_layers->length-1&&mouse_y<absy+step){
			context_raw->drag_dest=project_layers->length;
			if(tab_layers_can_drop_new_layer(project_layers->length)){
				ui_fill(checkw,0,(ui->_window_w/(float)ui_SCALE(ui)-2)-checkw,2*ui_SCALE(ui),ui->ops->theme->HIGHLIGHT_COL);
			}
		}
	}
	mini?tab_layers_draw_layer_slot_mini(l,i):tab_layers_draw_layer_slot_full(l,i);
	tab_layers_draw_layer_highlight(l,mini);
	if(tab_layers_show_context_menu){
		tab_layers_draw_layer_context_menu(l,mini);
	}
}

void tab_layers_draw_layer_slot_mini(slot_layer_t * l,i32 i){
	ui_t * ui=ui_base_ui;
	f32_array_t * row=f32_array_create_from_raw((f32[]){1,1,},2);
	ui_row(row);
	f32 uix=ui->_x;
	f32 uiy=ui->_y;
	ui_state_t state=tab_layers_draw_layer_icon(l,i,uix,uiy,true);
	tab_layers_handle_layer_icon_state(l,i,state,uix,uiy);
	_ui_end_element(-1.0);
	ui->_y+=ui_ELEMENT_H(ui);
	ui->_y-=ui_ELEMENT_OFFSET(ui);
}

void tab_layers_draw_layer_slot_full(slot_layer_t * l,i32 i){
	ui_t * ui=ui_base_ui;
	i32 step=ui->ops->theme->ELEMENT_H;
	f32 uiw=ui->_w;
	bool has_panel=slot_layer_is_group(l)||(slot_layer_is_layer(l)&&slot_layer_get_masks(l,false)!=null);
	if(has_panel){
		f32_array_t * row=f32_array_create_from_raw((f32[]){8/(float)100,16/(float)100,36/(float)100,30/(float)100,10/(float)100,},5);
		ui_row(row);
	}
	else {
		f32_array_t * row=f32_array_create_from_raw((f32[]){8/(float)100,16/(float)100,36/(float)100,30/(float)100,},4);
		ui_row(row);
	}
	gpu_texture_t * icons=resource_get("icons.k");
	rect_t * r=resource_tile18(icons,l->visible?0:1,0);
	f32 center=(step/(float)2)*ui_SCALE(ui);
	ui->_x+=2;
	ui->_y+=3;
	ui->_y+=center;
	i32 col=ui->ops->theme->ACCENT_COL;
	bool parent_hidden=l->parent!=null&&(!l->parent->visible||(l->parent->parent!=null&&!l->parent->parent->visible));
	if(parent_hidden){
		col-=0x99000000;
	}
	if(_ui_image(icons,col,-1.0,r->x,r->y,r->w,r->h)==ui_state_t_RELEASED){
		tab_layers_layer_toggle_visible(l);
	}
	ui->_x-=2;
	ui->_y-=3;
	ui->_y-=center;
	f32 uix=ui->_x;
	f32 uiy=ui->_y;
	ui->_x+=2;
	ui->_y+=3;
	if(l->parent!=null){
		ui->_x+=10*ui_SCALE(ui);
		if(l->parent->parent!=null)ui->_x+=10*ui_SCALE(ui);
	}
	ui_state_t state=tab_layers_draw_layer_icon(l,i,uix,uiy,false);
	ui->_x-=2;
	ui->_y-=3;
	if(config_raw->touch_ui){
		ui->_x+=12*ui_SCALE(ui);
	}
	tab_layers_handle_layer_icon_state(l,i,state,uix,uiy);
	ui->_y+=center;
	if(tab_layers_layer_name_edit==l->id){
		tab_layers_layer_name_handle->text=string_copy(l->name);
		l->name=string_copy(ui_text_input(tab_layers_layer_name_handle,"",ui_align_t_LEFT,true,false));
		if(ui->text_selected_handle!=tab_layers_layer_name_handle){
			tab_layers_layer_name_edit=-1;
		}
	}
	else {
		if(ui->enabled&&ui->input_enabled&&ui->combo_selected_handle==null&&ui->input_x>ui->_window_x+ui->_x&&ui->input_x<ui->_window_x+uiw&&ui->input_y>ui->_window_y+ui->_y-center&&ui->input_y<ui->_window_y+ui->_y-center+(step*ui_SCALE(ui))*2){
			if(ui->input_started){
				context_set_layer(l);
				tab_layers_set_drag_layer(context_raw->layer,-(mouse_x-uix-ui->_window_x-3),-(mouse_y-uiy-ui->_window_y+1));
			}
			else if(ui->input_released_r){
				context_set_layer(l);
				tab_layers_show_context_menu=true;
			}
		}
		ui_state_t state=ui_text(l->name,ui_align_t_LEFT,0x00000000);
		if(state==ui_state_t_RELEASED){
			if(sys_time()-context_raw->select_time<0.25){
				tab_layers_layer_name_edit=l->id;
				tab_layers_layer_name_handle->text=string_copy(l->name);
				ui_start_text_edit(tab_layers_layer_name_handle,ui_align_t_LEFT);
			}
			context_raw->select_time=sys_time();
		}
		bool in_focus=ui->input_x>ui->_window_x&&ui->input_x<ui->_window_x+ui->_window_w&&ui->input_y>ui->_window_y&&ui->input_y<ui->_window_y+ui->_window_h;
		if(in_focus&&ui->is_delete_down&&tab_layers_can_delete(context_raw->layer)){
			ui->is_delete_down=false;
			sys_notify_on_init(&tab_layers_draw_layer_slot_full_122290			,null);
		}
	}
	ui->_y-=center;
	if(l->parent!=null){
		ui->_x-=10*ui_SCALE(ui);
		if(l->parent->parent!=null)ui->_x-=10*ui_SCALE(ui);
	}
	if(slot_layer_is_group(l)){
		_ui_end_element(-1.0);
	}
	else {
		if(slot_layer_is_mask(l)){
			ui->_y+=center;
		}
		tab_layers_combo_blending(ui,l,false);
		if(slot_layer_is_mask(l)){
			ui->_y-=center;
		}
	}
	if(has_panel){
		ui->_y+=center;
		ui_handle_t * layer_panel=ui_nest(ui_handle("tab_layers.ts:453"),l->id);
		layer_panel->selected=l->show_panel;
		l->show_panel=ui_panel(layer_panel,"",true,false);
		ui->_y-=center;
	}
	if(slot_layer_is_group(l)||slot_layer_is_mask(l)){
		ui->_y-=ui_ELEMENT_OFFSET(ui);
		_ui_end_element(-1.0);
	}
	else {
		ui->_y-=ui_ELEMENT_OFFSET(ui);
		f32_array_t * row=f32_array_create_from_raw((f32[]){8/(float)100,16/(float)100,36/(float)100,30/(float)100,10/(float)100,},5);
		ui_row(row);
		_ui_end_element(-1.0);
		_ui_end_element(-1.0);
		_ui_end_element(-1.0);
		if(config_raw->touch_ui){
			ui->_x+=12*ui_SCALE(ui);
		}
		tab_layers_combo_object(ui,l,false);
		_ui_end_element(-1.0);
	}
	ui->_y-=ui_ELEMENT_OFFSET(ui);
}

void tab_layers_draw_layer_slot_full_122290(){
tab_layers_delete_layer(context_raw->layer);
}

ui_handle_t * tab_layers_combo_object(ui_t * ui,slot_layer_t * l,bool label){
	string_t_array_t * ar=any_array_create_from_raw((any[]){tr("Shared",null),},1);
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		any_array_push(ar,p->base->name);
	}
	string_t_array_t * atlases=project_get_used_atlases();
	if(atlases!=null){
		for(i32 i=0;i<atlases->length;++i){
			string_t * a=atlases->buffer[i];
			any_array_push(ar,a);
		}
	}
	ui_handle_t * object_handle=ui_nest(ui_handle("tab_layers.ts:496"),l->id);
	object_handle->position=l->object_mask;
	l->object_mask=ui_combo(object_handle,ar,tr("Object",null),label,ui_align_t_LEFT,true);
	if(object_handle->changed){
		context_set_layer(l);
		make_material_parse_mesh_material();
		if(l->fill_layer!=null){
			sys_notify_on_init(&tab_layers_combo_object_122731			,l);
		}
		else {
			layers_set_object_mask();
		}
	}
	return object_handle;
}

void tab_layers_combo_object_122731(slot_layer_t * l){
context_raw->material=l->fill_layer;
			slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
			layers_update_fill_layers();
}

ui_handle_t * tab_layers_combo_blending(ui_t * ui,slot_layer_t * l,bool label){
	ui_handle_t * blending_handle=ui_nest(ui_handle("tab_layers.ts:517"),l->id);
	blending_handle->position=l->blending;
	string_t_array_t * blending_combo=any_array_create_from_raw((any[]){tr("Mix",null),tr("Darken",null),tr("Multiply",null),tr("Burn",null),tr("Lighten",null),tr("Screen",null),tr("Dodge",null),tr("Add",null),tr("Overlay",null),tr("Soft Light",null),tr("Linear Light",null),tr("Difference",null),tr("Subtract",null),tr("Divide",null),tr("Hue",null),tr("Saturation",null),tr("Color",null),tr("Value",null),},18);
	ui_combo(blending_handle,blending_combo,tr("Blending",null),label,ui_align_t_LEFT,true);
	if(blending_handle->changed){
		context_set_layer(l);
		history_layer_blending();
		l->blending=blending_handle->position;
		make_material_parse_mesh_material();
	}
	return blending_handle;
}

void tab_layers_layer_toggle_visible(slot_layer_t * l){
	l->visible=!l->visible;
	ui_view2d_hwnd->redraws=2;
	make_material_parse_mesh_material();
}

void tab_layers_draw_layer_highlight(slot_layer_t * l,bool mini){
	ui_t * ui=ui_base_ui;
	i32 step=ui->ops->theme->ELEMENT_H;
	ui_fill(0,0,(ui->_w/(float)ui_SCALE(ui)-2),1*ui_SCALE(ui),ui->ops->theme->SEPARATOR_COL);
	if(context_raw->layer==l){
		if(mini){
			ui_rect(1,-step*2,ui->_w/(float)ui_SCALE(ui)-1,step*2+(mini?-1:1),ui->ops->theme->HIGHLIGHT_COL,3);
		}
		else {
			ui_rect(1,-step*2-1,ui->_w/(float)ui_SCALE(ui)-2,step*2+(mini?-2:1),ui->ops->theme->HIGHLIGHT_COL,2);
		}
	}
}

void tab_layers_handle_layer_icon_state(slot_layer_t * l,i32 i,ui_state_t state,f32 uix,f32 uiy){
	ui_t * ui=ui_base_ui;
	gpu_texture_t * texpaint_preview=l->texpaint_preview;
	tab_layers_show_context_menu=false;
	if(ui->is_hovered&&texpaint_preview!=null){
		if(slot_layer_is_mask(l)){
			tab_layers_make_mask_preview_rgba32(l);
			ui_tooltip_image(context_raw->mask_preview_rgba32,0);
		}
		else {
			ui_tooltip_image(texpaint_preview,0);
		}
		if(i<9){
			i32 i1=(i+1);
			ui_tooltip(string_join(string_join(string_join(string_join(string_join(l->name," - ("),any_map_get(config_keymap,"select_layer"))," "),i32_to_string(i1)),")"));
		}
		else {
			ui_tooltip(l->name);
		}
	}
	if(ui->is_hovered&&ui->input_released_r){
		context_set_layer(l);
		tab_layers_show_context_menu=true;
	}
	if(state==ui_state_t_STARTED){
		context_set_layer(l);
		tab_layers_set_drag_layer(context_raw->layer,-(mouse_x-uix-ui->_window_x-3),-(mouse_y-uiy-ui->_window_y+1));
	}
	else if(state==ui_state_t_RELEASED){
		if(sys_time()-context_raw->select_time<0.2){
			ui_base_show_2d_view(view_2d_type_t_LAYER);
		}
		if(sys_time()-context_raw->select_time>0.2){
			context_raw->select_time=sys_time();
		}
		if(l->fill_layer!=null){
			context_set_material(l->fill_layer);
		}
	}
}

ui_state_t tab_layers_draw_layer_icon(slot_layer_t * l,i32 i,f32 uix,f32 uiy,bool mini){
	ui_t * ui=ui_base_ui;
	gpu_texture_t * icons=resource_get("icons.k");
	i32 icon_h=(ui_ELEMENT_H(ui)-(mini?2:3))*2;
	if(mini&&ui_SCALE(ui)>1){
		ui->_x-=1*ui_SCALE(ui);
	}
	if(l->parent!=null){
		ui->_x+=(icon_h-icon_h*0.9)/(float)2;
		icon_h*=0.9;
		if(l->parent->parent!=null){
			ui->_x+=(icon_h-icon_h*0.9)/(float)2;
			icon_h*=0.9;
		}
	}
	if(!slot_layer_is_group(l)){
		gpu_texture_t * texpaint_preview=l->texpaint_preview;
		gpu_texture_t * icon=l->fill_layer==null?texpaint_preview:l->fill_layer->image_icon;
		if(l->fill_layer==null){
			rect_t * r=resource_tile50(icons,4,1);
			f32 _x=ui->_x;
			f32 _y=ui->_y;
			f32 _w=ui->_w;
			_ui_image(icons,0xffffffff,icon_h,r->x,r->y,r->w,r->h);
			ui->current_ratio--;
			ui->_x=_x;
			ui->_y=_y;
			ui->_w=_w;
		}
		if(l->fill_layer==null&&slot_layer_is_mask(l)){
			draw_set_pipeline(ui_view2d_pipe);
			gpu_set_int(ui_view2d_channel_loc,1);
		}
		ui_state_t state=_ui_image(icon,0xffffffff,icon_h,0,0,0,0);
		if(l->fill_layer==null&&slot_layer_is_mask(l)){
			draw_set_pipeline(null);
		}
		bool is_typing=ui->is_typing||ui_view2d_ui->is_typing||ui_nodes_ui->is_typing;
		if(!is_typing){
			if(i<9&&operator_shortcut(any_map_get(config_keymap,"select_layer"),shortcut_type_t_DOWN)){
				string_t * number=i32_to_string(i+1);
				i32 width=draw_string_width(ui->ops->font,ui->font_size,number)+10;
				i32 height=draw_font_height(ui->ops->font,ui->font_size);
				draw_set_color(ui->ops->theme->TEXT_COL);
				draw_filled_rect(uix,uiy,width,height);
				draw_set_color(ui->ops->theme->BUTTON_COL);
				draw_string(number,uix+5,uiy);
			}
		}
		return state;
	}
	else {
		rect_t * folder_closed=resource_tile50(icons,2,1);
		rect_t * folder_open=resource_tile50(icons,8,1);
		rect_t * folder=l->show_panel?folder_open:folder_closed;
		return _ui_image(icons,ui->ops->theme->LABEL_COL-0x00202020,icon_h,folder->x,folder->y,folder->w,folder->h);
	}
}

bool tab_layers_can_merge_down(slot_layer_t * l){
	i32 index=array_index_of(project_layers,l);
	if(index==0){
		return false;
	}
	if(slot_layer_is_layer(l)&&slot_layer_is_mask(project_layers->buffer[0])&&project_layers->buffer[0]->parent==l){
		return false;
	}
	if(slot_layer_is_group(l)&&slot_layer_is_in_group(project_layers->buffer[0])&&slot_layer_get_containing_group(project_layers->buffer[0])==l){
		return false;
	}
	if(slot_layer_is_mask(l)&&!slot_layer_is_mask(project_layers->buffer[index-1])){
		return false;
	}
	return true;
}

void tab_layers_draw_layer_context_menu(slot_layer_t * l,bool mini){
	gc_unroot(tab_layers_l);tab_layers_l=l;gc_root(tab_layers_l);
	tab_layers_mini=mini;
	ui_menu_draw(&tab_layers_draw_layer_context_menu_123965	,-1,-1);
}

void tab_layers_draw_layer_context_menu_125246(){
layers_update_fill_layers();
}

void tab_layers_draw_layer_context_menu_125150(){
layers_update_fill_layers();
}

void tab_layers_draw_layer_context_menu_125069(){
layers_update_fill_layers();
}

void tab_layers_draw_layer_context_menu_124722(){
slot_layer_t * l=tab_layers_l;
		context_set_layer(l);
		history_duplicate_layer();
		layers_duplicate_layer(l);
}

void tab_layers_draw_layer_context_menu_124666(){
slot_layer_t * l=tab_layers_l;
		context_set_layer(l);
		history_merge_layers();
		layers_merge_down();
		if(context_raw->layer->fill_layer!=null)slot_layer_to_paint_layer(context_raw->layer);
}

void tab_layers_draw_layer_context_menu_124626(){
slot_layer_t * l=tab_layers_l;
		layers_merge_group(l);
}

void tab_layers_draw_layer_context_menu_124567(){
slot_layer_t * l=tab_layers_l;
		context_raw->layer=l;
		history_apply_mask();
		slot_layer_apply_mask(l);
		context_set_layer(l->parent);
		make_material_parse_mesh_material();
		context_raw->layers_preview_dirty=true;
}

void tab_layers_draw_layer_context_menu_124520(){
slot_layer_t * l=tab_layers_l;
		context_set_layer(l);
		history_invert_mask();
		slot_layer_invert_mask(l);
}

void tab_layers_draw_layer_context_menu_124406(){
slot_layer_t * l=tab_layers_l;
		if(!slot_layer_is_group(l)){
			history_clear_layer();
			slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
		}
		else {
			for(i32 i=0;i<slot_layer_get_children(l)->length;++i){
				slot_layer_t * c=slot_layer_get_children(l)->buffer[i];
				context_raw->layer=c;
				history_clear_layer();
				slot_layer_clear(c,0x00000000,null,1.0,layers_default_rough,0.0);
			}
			context_raw->layers_preview_dirty=true;
			context_raw->layer=l;
		}
}

void tab_layers_draw_layer_context_menu_124367(){
tab_layers_delete_layer(context_raw->layer);
}

void tab_layers_draw_layer_context_menu_124311(){
slot_layer_t * l=tab_layers_l;
			slot_layer_is_layer(l)?history_to_paint_layer():history_to_paint_mask();
			slot_layer_to_paint_layer(l);
}

void tab_layers_draw_layer_context_menu_124264(){
slot_layer_t * l=tab_layers_l;
			slot_layer_is_layer(l)?history_to_fill_layer():history_to_fill_mask();
			slot_layer_to_fill_layer(l);
}

void tab_layers_draw_layer_context_menu_124113(string_t * path){
slot_layer_t * l=tab_layers_l;
			string_t * f=ui_files_filename;
			if(string_equals(f,"")){
				f=string_copy(tr("untitled",null));
			}
			if(!ends_with(f,".png")){
				f=string_join(f,".png");
			}
			iron_write_png(string_join(string_join(path,path_sep),f),gpu_get_texture_pixels(l->texpaint),l->texpaint->width,l->texpaint->height,3);
}

void tab_layers_draw_layer_context_menu_123965(ui_t * ui){
slot_layer_t * l=tab_layers_l;
	bool mini=tab_layers_mini;
	if(mini){
		ui_handle_t * visible_handle=ui_handle("tab_layers.ts:722");
		visible_handle->selected=l->visible;
		ui_check(visible_handle,tr("Visible",null),"");
		if(visible_handle->changed){
			tab_layers_layer_toggle_visible(l);
			ui_menu_keep_open=true;
		}
		if(!slot_layer_is_group(l)){
			if(tab_layers_combo_blending(ui,l,true)->changed){
				ui_menu_keep_open=true;
			}
		}
		if(slot_layer_is_layer(l)){
			if(tab_layers_combo_object(ui,l,true)->changed){
				ui_menu_keep_open=true;
			}
		}
	}
	if(ui_menu_button(tr("Export",null),"")){
		if(slot_layer_is_mask(l)){
			ui_files_show("png",true,false,&tab_layers_draw_layer_context_menu_124113			);
		}
		else {
			context_raw->layers_export=export_mode_t_SELECTED;
			box_export_show_textures();
		}
	}
	if(!slot_layer_is_group(l)){
		string_t * to_fill_string=slot_layer_is_layer(l)?tr("To Fill Layer",null):tr("To Fill Mask",null);
		string_t * to_paint_string=slot_layer_is_layer(l)?tr("To Paint Layer",null):tr("To Paint Mask",null);
		if(l->fill_layer==null&&ui_menu_button(to_fill_string,"")){
			sys_notify_on_init(&tab_layers_draw_layer_context_menu_124264			,null);
		}
		if(l->fill_layer!=null&&ui_menu_button(to_paint_string,"")){
			sys_notify_on_init(&tab_layers_draw_layer_context_menu_124311			,null);
		}
	}
	ui->enabled=tab_layers_can_delete(l);
	if(ui_menu_button(tr("Delete",null),"delete")){
		sys_notify_on_init(&tab_layers_draw_layer_context_menu_124367		,null);
	}
	ui->enabled=true;
	if(l->fill_layer==null&&ui_menu_button(tr("Clear",null),"")){
		context_set_layer(l);
		sys_notify_on_init(&tab_layers_draw_layer_context_menu_124406		,null);
	}
	if(slot_layer_is_mask(l)&&l->fill_layer==null&&ui_menu_button(tr("Invert",null),"")){
		sys_notify_on_init(&tab_layers_draw_layer_context_menu_124520		,null);
	}
	if(slot_layer_is_mask(l)&&ui_menu_button(tr("Apply",null),"")){
		sys_notify_on_init(&tab_layers_draw_layer_context_menu_124567		,null);
	}
	if(slot_layer_is_group(l)&&ui_menu_button(tr("Merge Group",null),"")){
		sys_notify_on_init(&tab_layers_draw_layer_context_menu_124626		,null);
	}
	ui->enabled=tab_layers_can_merge_down(l);
	if(ui_menu_button(tr("Merge Down",null),"")){
		sys_notify_on_init(&tab_layers_draw_layer_context_menu_124666		,null);
	}
	ui->enabled=true;
	if(ui_menu_button(tr("Duplicate",null),"")){
		sys_notify_on_init(&tab_layers_draw_layer_context_menu_124722		,null);
	}
	ui_menu_align(ui);
	ui_handle_t * layer_opac_handle=ui_nest(ui_handle("tab_layers.ts:856"),l->id);
	layer_opac_handle->value=l->mask_opacity;
	ui_slider(layer_opac_handle,tr("Opacity",null),0.0,1.0,true,100.0,true,ui_align_t_RIGHT,true);
	if(layer_opac_handle->changed){
		if(ui->input_started){
			history_layer_opacity();
		}
		l->mask_opacity=layer_opac_handle->value;
		make_material_parse_mesh_material();
		ui_menu_keep_open=true;
	}
	if(!slot_layer_is_group(l)){
		ui_menu_align(ui);
		bool res_handle_changed_last=base_res_handle->changed;
		string_t_array_t * ar=any_array_create_from_raw((any[]){"128","256","512","1K","2K","4K","8K","16K",},8);
		i32 _y=ui->_y;
		base_res_handle->value=base_res_handle->position;
		base_res_handle->position=math_floor(ui_slider(base_res_handle,ar->buffer[base_res_handle->position],0,ar->length-1,false,1,false,ui_align_t_LEFT,false));
		if(base_res_handle->changed){
			ui_menu_keep_open=true;
		}
		if(res_handle_changed_last&&!base_res_handle->changed){
			layers_on_resized();
		}
		ui->_y=_y;
		ui_draw_string(tr("Res",null),-1,0,ui_align_t_RIGHT,true);
		_ui_end_element(-1.0);
		ui_menu_align(ui);
		string_t_array_t * bits_items=any_array_create_from_raw((any[]){"8bit","16bit","32bit",},3);
		ui_inline_radio(base_bits_handle,bits_items,ui_align_t_LEFT);
		if(base_bits_handle->changed){
			sys_notify_on_init(layers_set_bits,null);
			make_material_parse_paint_material(true);
			ui_menu_keep_open=true;
		}
	}
	if(l->fill_layer!=null){
		ui_menu_align(ui);
		ui_handle_t * scale_handle=ui_nest(ui_handle("tab_layers.ts:906"),l->id);
		scale_handle->value=l->scale;
		l->scale=ui_slider(scale_handle,tr("UV Scale",null),0.0,5.0,true,100.0,true,ui_align_t_RIGHT,true);
		if(scale_handle->changed){
			context_set_material(l->fill_layer);
			context_set_layer(l);
			sys_notify_on_init(&tab_layers_draw_layer_context_menu_125069			,null);
			ui_menu_keep_open=true;
		}
		ui_menu_align(ui);
		ui_handle_t * angle_handle=ui_nest(ui_handle("tab_layers.ts:919"),l->id);
		angle_handle->value=l->angle;
		l->angle=ui_slider(angle_handle,tr("Angle",null),0.0,360,true,1,true,ui_align_t_RIGHT,true);
		if(angle_handle->changed){
			context_set_material(l->fill_layer);
			context_set_layer(l);
			make_material_parse_paint_material(true);
			sys_notify_on_init(&tab_layers_draw_layer_context_menu_125150			,null);
			ui_menu_keep_open=true;
		}
		ui_menu_align(ui);
		ui_handle_t * uv_type_handle=ui_nest(ui_handle("tab_layers.ts:933"),l->id);
		uv_type_handle->position=l->uv_type;
		string_t_array_t * uv_type_items=any_array_create_from_raw((any[]){tr("UV Map",null),tr("Triplanar",null),tr("Project",null),},3);
		l->uv_type=ui_inline_radio(uv_type_handle,uv_type_items,ui_align_t_LEFT);
		if(uv_type_handle->changed){
			context_set_material(l->fill_layer);
			context_set_layer(l);
			make_material_parse_paint_material(true);
			sys_notify_on_init(&tab_layers_draw_layer_context_menu_125246			,null);
			ui_menu_keep_open=true;
		}
	}
	if(!slot_layer_is_group(l)){
		ui_handle_t * base_handle=ui_nest(ui_handle("tab_layers.ts:949"),l->id);
		ui_handle_t * opac_handle=ui_nest(ui_handle("tab_layers.ts:950"),l->id);
		ui_handle_t * nor_handle=ui_nest(ui_handle("tab_layers.ts:951"),l->id);
		ui_handle_t * nor_blend_handle=ui_nest(ui_handle("tab_layers.ts:952"),l->id);
		ui_handle_t * occ_handle=ui_nest(ui_handle("tab_layers.ts:953"),l->id);
		ui_handle_t * rough_handle=ui_nest(ui_handle("tab_layers.ts:954"),l->id);
		ui_handle_t * met_handle=ui_nest(ui_handle("tab_layers.ts:955"),l->id);
		ui_handle_t * height_handle=ui_nest(ui_handle("tab_layers.ts:956"),l->id);
		ui_handle_t * height_blend_handle=ui_nest(ui_handle("tab_layers.ts:957"),l->id);
		ui_handle_t * emis_handle=ui_nest(ui_handle("tab_layers.ts:958"),l->id);
		ui_handle_t * subs_handle=ui_nest(ui_handle("tab_layers.ts:959"),l->id);
		base_handle->selected=l->paint_base;
		opac_handle->selected=l->paint_opac;
		nor_handle->selected=l->paint_nor;
		nor_blend_handle->selected=l->paint_nor_blend;
		occ_handle->selected=l->paint_occ;
		rough_handle->selected=l->paint_rough;
		met_handle->selected=l->paint_met;
		height_handle->selected=l->paint_height;
		height_blend_handle->selected=l->paint_height_blend;
		emis_handle->selected=l->paint_emis;
		subs_handle->selected=l->paint_subs;
		l->paint_base=ui_check(base_handle,tr("Base Color",null),"");
		l->paint_opac=ui_check(opac_handle,tr("Opacity",null),"");
		l->paint_nor=ui_check(nor_handle,tr("Normal",null),"");
		l->paint_nor_blend=ui_check(nor_blend_handle,tr("Normal Blending",null),"");
		l->paint_occ=ui_check(occ_handle,tr("Occlusion",null),"");
		l->paint_rough=ui_check(rough_handle,tr("Roughness",null),"");
		l->paint_met=ui_check(met_handle,tr("Metallic",null),"");
		l->paint_height=ui_check(height_handle,tr("Height",null),"");
		l->paint_height_blend=ui_check(height_blend_handle,tr("Height Blending",null),"");
		l->paint_emis=ui_check(emis_handle,tr("Emission",null),"");
		l->paint_subs=ui_check(subs_handle,tr("Subsurface",null),"");
		if(base_handle->changed||opac_handle->changed||nor_handle->changed||nor_blend_handle->changed||occ_handle->changed||rough_handle->changed||met_handle->changed||height_handle->changed||height_blend_handle->changed||emis_handle->changed||subs_handle->changed){
			make_material_parse_mesh_material();
			ui_menu_keep_open=true;
		}
	}
}

void tab_layers_make_mask_preview_rgba32(slot_layer_t * l){
	if(context_raw->mask_preview_rgba32==null){
		context_raw->mask_preview_rgba32=gpu_create_render_target(util_render_layer_preview_size,util_render_layer_preview_size,tex_format_t_RGBA32);
	}
	if(context_raw->mask_preview_last!=l){
		context_raw->mask_preview_last=l;
		gc_unroot(tab_layers_l);tab_layers_l=l;gc_root(tab_layers_l);
		sys_notify_on_init(&tab_layers_make_mask_preview_rgba32_125694		,null);
	}
}

void tab_layers_make_mask_preview_rgba32_125694(){
slot_layer_t * l=tab_layers_l;
		draw_begin(context_raw->mask_preview_rgba32,false,0);
		draw_set_pipeline(ui_view2d_pipe);
		gpu_set_int(ui_view2d_channel_loc,1);
		draw_image(l->texpaint_preview,0,0);
		draw_end();
		draw_set_pipeline(null);
}

void tab_layers_delete_layer(slot_layer_t * l){
	i32_map_t * pointers=tab_layers_init_layer_map();
	if(slot_layer_is_layer(l)&&slot_layer_has_masks(l,false)){
		slot_layer_t_array_t * masks=slot_layer_get_masks(l,false);
		for(i32 i=0;i<masks->length;++i){
			slot_layer_t * m=masks->buffer[i];
			context_raw->layer=m;
			history_delete_layer();
			slot_layer_delete(m);
		}
	}
	if(slot_layer_is_group(l)){
		slot_layer_t_array_t * children=slot_layer_get_children(l);
		for(i32 i=0;i<children->length;++i){
			slot_layer_t * c=children->buffer[i];
			if(slot_layer_has_masks(c,false)){
				slot_layer_t_array_t * masks=slot_layer_get_masks(c,false);
				for(i32 i=0;i<masks->length;++i){
					slot_layer_t * m=masks->buffer[i];
					context_raw->layer=m;
					history_delete_layer();
					slot_layer_delete(m);
				}
			}
			context_raw->layer=c;
			history_delete_layer();
			slot_layer_delete(c);
		}
		if(slot_layer_has_masks(l,true)){
			for(i32 i=0;i<slot_layer_get_masks(l,true)->length;++i){
				slot_layer_t * m=slot_layer_get_masks(l,true)->buffer[i];
				context_raw->layer=m;
				history_delete_layer();
				slot_layer_delete(m);
			}
		}
	}
	context_raw->layer=l;
	history_delete_layer();
	slot_layer_delete(l);
	if(slot_layer_is_mask(l)){
		context_raw->layer=l->parent;
		layers_update_fill_layers();
	}
	if(slot_layer_is_in_group(l)&&slot_layer_get_children(slot_layer_get_containing_group(l))==null){
		slot_layer_t * g=slot_layer_get_containing_group(l);
		if(slot_layer_has_masks(g,true)){
			for(i32 i=0;i<slot_layer_get_masks(g,true)->length;++i){
				slot_layer_t * m=slot_layer_get_masks(g,true)->buffer[i];
				context_raw->layer=m;
				history_delete_layer();
				slot_layer_delete(m);
			}
		}
		context_raw->layer=l->parent;
		history_delete_layer();
		slot_layer_delete(l->parent);
	}
	context_raw->ddirty=2;
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		tab_layers_remap_layer_pointers(m->canvas->nodes,tab_layers_fill_layer_map(pointers));
	}
}

bool tab_layers_can_delete(slot_layer_t * l){
	i32 num_layers=0;
	if(slot_layer_is_mask(l)){
		return true;
	}
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * slot=project_layers->buffer[i];
		if(slot_layer_is_layer(slot)){
			++num_layers;
		}
	}
	if(slot_layer_is_group(l)&&slot_layer_get_children(l)->length==num_layers){
		return false;
	}
	return num_layers>1;
}

bool tab_layers_can_drop_new_layer(i32 position){
	if(position>0&&position<project_layers->length&&slot_layer_is_mask(project_layers->buffer[position-1])){
		return false;
	}
	return true;
}

void tab_materials_draw(ui_handle_t * htab){
	bool mini=config_raw->layout->buffer[layout_size_t_SIDEBAR_W]<=ui_base_sidebar_mini_w;
	mini?tab_materials_draw_mini(htab):tab_materials_draw_full(htab);
}

void tab_materials_draw_mini(ui_handle_t * htab){
	ui_set_hovered_tab_name(tr("Materials",null));
	ui_begin_sticky();
	ui_separator(5,true);
	tab_materials_button_nodes();
	tab_materials_button_new("+");
	ui_end_sticky();
	ui_separator(3,false);
	tab_materials_draw_slots(true);
}

void tab_materials_draw_full(ui_handle_t * htab){
	if(ui_tab(htab,tr("Materials",null),false,-1)){
		ui_begin_sticky();
		f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,1/(float)4,},3);
		ui_row(row);
		tab_materials_button_new(tr("New",null));
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			project_import_material();
		}
		tab_materials_button_nodes();
		ui_end_sticky();
		ui_separator(3,false);
		tab_materials_draw_slots(false);
	}
}

void tab_materials_button_nodes(){
	ui_t * ui=ui_base_ui;
	if(ui_button(tr("Nodes",null),ui_align_t_CENTER,"")){
		ui_base_show_material_nodes();
	}
	else if(ui->is_hovered){
		ui_tooltip(string_join(string_join(string_join(tr("Show Node Editor",null)," ("),any_map_get(config_keymap,"toggle_node_editor")),")"));
	}
}

void tab_materials_draw_slots(bool mini){
	ui_t * ui=ui_base_ui;
	i32 slotw=math_floor(51*ui_SCALE(ui));
	i32 num=math_floor(config_raw->layout->buffer[layout_size_t_SIDEBAR_W]/(float)slotw);
	if(num==0){
		return ;
	}
	for(i32 row=0;row<math_floor(math_ceil(project_materials->length/(float)num));++row){
		i32 mult=config_raw->show_asset_names?2:1;
		f32_array_t * ar=f32_array_create_from_raw((f32[]){},0);
		for(i32 i=0;i<num*mult;++i){
			f32_array_push(ar,1/(float)num);
		}
		ui_row(ar);
		ui->_x+=2;
		f32 off=config_raw->show_asset_names?ui_ELEMENT_OFFSET(ui)*10.0:6;
		if(row>0){
			ui->_y+=off;
		}
		for(i32 j=0;j<num;++j){
			i32 imgw=math_floor(50*ui_SCALE(ui));
			i32 i=j+row*num;
			if(i>=project_materials->length){
				_ui_end_element(imgw);
				if(config_raw->show_asset_names){
					_ui_end_element(0);
				}
				continue;
			}
			gpu_texture_t * img=ui_SCALE(ui)>1?project_materials->buffer[i]->image:project_materials->buffer[i]->image_icon;
			gpu_texture_t * img_full=project_materials->buffer[i]->image;
			if(context_raw->material==project_materials->buffer[i]){
				if(mini){
					f32 w=ui->_w/(float)ui_SCALE(ui);
					ui_rect(0,-2,w-2,w-4,ui->ops->theme->HIGHLIGHT_COL,3);
				}
				else {
					i32 off=row%2==1?1:0;
					i32 w=50;
					if(config_raw->window_scale>1){
						w+=math_floor(config_raw->window_scale*2);
					}
					ui_fill(-1,-2,w+3,2,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(-1,w-off,w+3,2+off,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(-1,-2,2,w+3,ui->ops->theme->HIGHLIGHT_COL);
					ui_fill(w+1,-2,2,w+4,ui->ops->theme->HIGHLIGHT_COL);
				}
			}
			f32 uix=ui->_x;
			f32 uiy=ui->_y;
			i32 tile=ui_SCALE(ui)>1?100:50;
			f32 imgh=mini?ui_base_default_sidebar_mini_w*0.85*ui_SCALE(ui):-1.0;
			ui_state_t state=project_materials->buffer[i]->preview_ready?_ui_image(img,0xffffffff,imgh,0,0,0,0):_ui_image(resource_get("icons.k"),0xffffffff,-1.0,tile,tile,tile,tile);
			bool is_typing=ui->is_typing||ui_view2d_ui->is_typing||ui_nodes_ui->is_typing;
			if(!is_typing){
				if(i<9&&operator_shortcut(any_map_get(config_keymap,"select_material"),shortcut_type_t_DOWN)){
					string_t * number=i32_to_string(i+1);
					i32 width=draw_string_width(ui->ops->font,ui->font_size,number)+10;
					i32 height=draw_font_height(ui->ops->font,ui->font_size);
					draw_set_color(ui->ops->theme->TEXT_COL);
					draw_filled_rect(uix,uiy,width,height);
					draw_set_color(ui->ops->theme->BUTTON_COL);
					draw_string(number,uix+5,uiy);
				}
			}
			if(state==ui_state_t_STARTED&&ui->input_y>ui->_window_y){
				if(context_raw->material!=project_materials->buffer[i]){
					context_select_material(i);
					if(context_raw->tool==workspace_tool_t_MATERIAL){
						sys_notify_on_init(layers_update_fill_layers,null);
					}
				}
				base_drag_off_x=-(mouse_x-uix-ui->_window_x-3);
				base_drag_off_y=-(mouse_y-uiy-ui->_window_y+1);
				gc_unroot(base_drag_material);base_drag_material=context_raw->material;gc_root(base_drag_material);
				if(sys_time()-context_raw->select_time<0.25){
					ui_base_show_material_nodes();
					gc_unroot(base_drag_material);base_drag_material=null;
					base_is_dragging=false;
				}
				context_raw->select_time=sys_time();
			}
			if(ui->is_hovered&&ui->input_released_r){
				context_select_material(i);
				_tab_materials_draw_slots=i;
				ui_menu_draw(&tab_materials_draw_slots_127305				,-1,-1);
			}
			if(ui->is_hovered){
				ui_tooltip_image(img_full,0);
				if(i<9){
					i32 i1=i+1;
					ui_tooltip(string_join(string_join(string_join(string_join(string_join(project_materials->buffer[i]->canvas->name," - ("),any_map_get(config_keymap,"select_material"))," "),i32_to_string(i1)),")"));
				}
				else {
					ui_tooltip(project_materials->buffer[i]->canvas->name);
				}
			}
			if(config_raw->show_asset_names){
				ui->_x=uix;
				ui->_y+=slotw*0.9;
				ui_text(project_materials->buffer[i]->canvas->name,ui_align_t_CENTER,0x00000000);
				if(ui->is_hovered){
					if(i<9){
						i32 i1=i+1;
						ui_tooltip(string_join(string_join(string_join(string_join(string_join(project_materials->buffer[i]->canvas->name," - ("),any_map_get(config_keymap,"select_material"))," "),i32_to_string(i1)),")"));
					}
					else {
						ui_tooltip(project_materials->buffer[i]->canvas->name);
					}
				}
				ui->_y-=slotw*0.9;
				if(i==project_materials->length-1){
					ui->_y+=j==num-1?imgw:imgw+ui_ELEMENT_H(ui)+ui_ELEMENT_OFFSET(ui);
				}
			}
		}
		ui->_y+=mini?0:6;
	}
	bool in_focus=ui->input_x>ui->_window_x&&ui->input_x<ui->_window_x+ui->_window_w&&ui->input_y>ui->_window_y&&ui->input_y<ui->_window_y+ui->_window_h;
	if(in_focus&&ui->is_delete_down&&project_materials->length>1){
		ui->is_delete_down=false;
		tab_materials_delete_material(context_raw->material);
	}
}

void tab_materials_draw_slots_127405(){
i32 i=_tab_materials_draw_slots;
					context_raw->material=slot_material_create(project_materials->buffer[0]->data,null);
					any_array_push(project_materials,context_raw->material);
					ui_node_canvas_t * cloned=util_clone_canvas(project_materials->buffer[i]->canvas);
					context_raw->material->canvas=cloned;
					tab_materials_update_material();
					history_duplicate_material();
}

void tab_materials_draw_slots_127305(ui_t * ui){
i32 i=_tab_materials_draw_slots;
				slot_material_t * m=project_materials->buffer[i];
				if(ui_menu_button(tr("To Fill Layer",null),"")){
					context_select_material(i);
					layers_create_fill_layer(uv_type_t_UVMAP,mat4nan,-1);
				}
				if(ui_menu_button(tr("Export",null),"")){
					context_select_material(i);
					box_export_show_material();
				}
				if(ui_menu_button(tr("Bake",null),"")){
					context_select_material(i);
					box_export_show_bake_material();
				}
				if(ui_menu_button(tr("Duplicate",null),"")){
					sys_notify_on_init(&tab_materials_draw_slots_127405					,null);
				}
				if(project_materials->length>1&&ui_menu_button(tr("Delete",null),"delete")){
					tab_materials_delete_material(m);
				}
				ui_handle_t * base_handle=ui_nest(ui_handle("tab_materials.ts:192"),m->id);
				if(base_handle->init){
					base_handle->selected=m->paint_base;
				}
				ui_handle_t * opac_handle=ui_nest(ui_handle("tab_materials.ts:197"),m->id);
				if(opac_handle->init){
					opac_handle->selected=m->paint_opac;
				}
				ui_handle_t * nor_handle=ui_nest(ui_handle("tab_materials.ts:202"),m->id);
				if(nor_handle->init){
					nor_handle->selected=m->paint_nor;
				}
				ui_handle_t * occ_handle=ui_nest(ui_handle("tab_materials.ts:207"),m->id);
				if(occ_handle->init){
					occ_handle->selected=m->paint_occ;
				}
				ui_handle_t * rough_handle=ui_nest(ui_handle("tab_materials.ts:212"),m->id);
				if(rough_handle->init){
					rough_handle->selected=m->paint_rough;
				}
				ui_handle_t * met_handle=ui_nest(ui_handle("tab_materials.ts:217"),m->id);
				if(met_handle->init){
					met_handle->selected=m->paint_met;
				}
				ui_handle_t * height_handle=ui_nest(ui_handle("tab_materials.ts:222"),m->id);
				if(height_handle->init){
					height_handle->selected=m->paint_height;
				}
				ui_handle_t * emis_handle=ui_nest(ui_handle("tab_materials.ts:227"),m->id);
				if(emis_handle->init){
					emis_handle->selected=m->paint_emis;
				}
				ui_handle_t * subs_handle=ui_nest(ui_handle("tab_materials.ts:232"),m->id);
				if(subs_handle->init){
					subs_handle->selected=m->paint_subs;
				}
				m->paint_base=ui_check(base_handle,tr("Base Color",null),"");
				m->paint_opac=ui_check(opac_handle,tr("Opacity",null),"");
				m->paint_nor=ui_check(nor_handle,tr("Normal",null),"");
				m->paint_occ=ui_check(occ_handle,tr("Occlusion",null),"");
				m->paint_rough=ui_check(rough_handle,tr("Roughness",null),"");
				m->paint_met=ui_check(met_handle,tr("Metallic",null),"");
				m->paint_height=ui_check(height_handle,tr("Height",null),"");
				m->paint_emis=ui_check(emis_handle,tr("Emission",null),"");
				m->paint_subs=ui_check(subs_handle,tr("Subsurface",null),"");
				if(base_handle->changed||opac_handle->changed||nor_handle->changed||occ_handle->changed||rough_handle->changed||met_handle->changed||height_handle->changed||emis_handle->changed||subs_handle->changed){
					make_material_parse_paint_material(true);
					ui_menu_keep_open=true;
				}
}

void tab_materials_button_new(string_t * text){
	if(ui_button(text,ui_align_t_CENTER,"")){
		sys_notify_on_init(&tab_materials_button_new_128117		,null);
	}
}

void tab_materials_button_new_128117(){
context_raw->material=slot_material_create(project_materials->buffer[0]->data,null);
		any_array_push(project_materials,context_raw->material);
		tab_materials_update_material();
		history_new_material();
}

void tab_materials_update_material(){
	ui_header_handle->redraws=2;
	ui_nodes_hwnd->redraws=2;
	gc_unroot(ui_nodes_group_stack);ui_nodes_group_stack=any_array_create_from_raw((any[]){},0);gc_root(ui_nodes_group_stack);
	make_material_parse_paint_material(true);
	util_render_make_material_preview();
	bool decal=context_is_decal();
	if(decal){
		util_render_make_decal_preview();
	}
}

void tab_materials_update_material_pointers(ui_node_t_array_t * nodes,i32 i){
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * n=nodes->buffer[i];
		if(string_equals(n->type,"MATERIAL")){
			if(n->buttons->buffer[0]->default_value->buffer[0]==i){
				n->buttons->buffer[0]->default_value->buffer[0]=9999;
			}
			else if(n->buttons->buffer[0]->default_value->buffer[0]>i){
				n->buttons->buffer[0]->default_value->buffer[0]--;
			}
		}
	}
}

void tab_materials_accept_swatch_drag(swatch_color_t * swatch){
	context_raw->material=slot_material_create(project_materials->buffer[0]->data,null);
	for(i32 i=0;i<context_raw->material->canvas->nodes->length;++i){
		ui_node_t * node=context_raw->material->canvas->nodes->buffer[i];
		if(string_equals(node->type,"RGB")){
			node->outputs->buffer[0]->default_value=f32_array_create_xyzw(color_get_rb(swatch->base)/(float)255,color_get_gb(swatch->base)/(float)255,color_get_bb(swatch->base)/(float)255,color_get_ab(swatch->base)/(float)255);
		}
		else if(string_equals(node->type,"OUTPUT_MATERIAL_PBR")){
			node->inputs->buffer[1]->default_value->buffer[0]=swatch->opacity;
			node->inputs->buffer[2]->default_value->buffer[0]=swatch->occlusion;
			node->inputs->buffer[3]->default_value->buffer[0]=swatch->roughness;
			node->inputs->buffer[4]->default_value->buffer[0]=swatch->metallic;
			node->inputs->buffer[7]->default_value->buffer[0]=swatch->height;
		}
	}
	any_array_push(project_materials,context_raw->material);
	tab_materials_update_material();
	history_new_material();
}

void tab_materials_delete_material(slot_material_t * m){
	i32 i=array_index_of(project_materials,m);
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(l->fill_layer==m){
			l->fill_layer=null;
		}
	}
	history_delete_material();
	context_select_material(i==project_materials->length-1?i-1:i+1);
	array_splice(project_materials,i,1);
	ui_base_hwnds->buffer[1]->redraws=2;
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		tab_materials_update_material_pointers(m->canvas->nodes,i);
	}
}

void tab_meshes_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_tab(htab,tr("Meshes",null),false,-1)&&statush>ui_status_default_status_h*ui_SCALE(ui)){
		ui_begin_sticky();
		if(config_raw->touch_ui){
			ui_row6();
		}
		else {
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)14,1/(float)9,1/(float)9,1/(float)9,1/(float)9,1/(float)14,},6);
			ui_row(row);
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_menu_draw(&tab_meshes_draw_128723			,-1,-1);
		}
		if(ui->is_hovered)ui_tooltip(tr("Import mesh file",null));
		if(ui_button(tr("Flip Normals",null),ui_align_t_CENTER,"")){
			util_mesh_flip_normals();
			context_raw->ddirty=2;
		}
		if(ui_button(tr("Calculate Normals",null),ui_align_t_CENTER,"")){
			ui_menu_draw(&tab_meshes_draw_128819			,-1,-1);
		}
		if(ui_button(tr("Geometry to Origin",null),ui_align_t_CENTER,"")){
			util_mesh_to_origin();
			context_raw->ddirty=2;
		}
		if(ui_button(tr("Apply Displacement",null),ui_align_t_CENTER,"")){
			util_mesh_apply_displacement(project_layers->buffer[0]->texpaint_pack,0.1,1.0);
			util_mesh_calc_normals(false);
			context_raw->ddirty=2;
		}
		if(ui_button(tr("Rotate",null),ui_align_t_CENTER,"")){
			ui_menu_draw(&tab_meshes_draw_128934			,-1,-1);
		}
		ui_end_sticky();
		for(i32 i=0;i<project_paint_objects->length;++i){
			mesh_object_t * o=project_paint_objects->buffer[i];
			ui_handle_t * h=ui_handle("tab_meshes.ts:121");
			h->selected=o->base->visible;
			o->base->visible=ui_check(h,o->base->name,"");
			if(ui->is_hovered&&ui->input_released_r){
				_tab_meshes_draw_i=i;
				ui_menu_draw(&tab_meshes_draw_129080				,-1,-1);
			}
			if(h->changed){
				mesh_object_t_array_t * visibles=any_array_create_from_raw((any[]){},0);
				for(i32 i=0;i<project_paint_objects->length;++i){
					mesh_object_t * p=project_paint_objects->buffer[i];
					if(p->base->visible){
						any_array_push(visibles,p);
					}
				}
				util_mesh_merge(visibles);
				context_raw->ddirty=2;
			}
		}
	}
}

void tab_meshes_draw_129080(ui_t * ui){
i32 i=_tab_meshes_draw_i;
				mesh_object_t * o=project_paint_objects->buffer[i];
				if(ui_menu_button(tr("Export",null),"")){
					context_raw->export_mesh_index=i+1;
					box_export_show_mesh();
				}
				if(project_paint_objects->length>1&&ui_menu_button(tr("Delete",null),"")){
					array_remove(project_paint_objects,o);
					while(o->base->children->length>0){
						object_t * child=o->base->children->buffer[0];
						object_set_parent(child,null,false,false);
						if(project_paint_objects->buffer[0]->base!=child){
							object_set_parent(child,project_paint_objects->buffer[0]->base,false,false);
						}
						if(o->base->children->length==0){
							project_paint_objects->buffer[0]->base->transform->scale=vec4_clone(o->base->transform->scale);
							transform_build_matrix(project_paint_objects->buffer[0]->base->transform);
						}
					}
					data_delete_mesh(o->data->_->handle);
					mesh_object_remove(o);
					context_raw->paint_object=context_main_object();
					util_mesh_merge(null);
					context_raw->ddirty=2;
				}
}

void tab_meshes_draw_128934(ui_t * ui){
if(ui_menu_button(tr("Rotate X",null),"")){
				util_mesh_swap_axis(1,2);
				context_raw->ddirty=2;
			}
			if(ui_menu_button(tr("Rotate Y",null),"")){
				util_mesh_swap_axis(2,0);
				context_raw->ddirty=2;
			}
			if(ui_menu_button(tr("Rotate Z",null),"")){
				util_mesh_swap_axis(0,1);
				context_raw->ddirty=2;
			}
}

void tab_meshes_draw_128819(ui_t * ui){
if(ui_menu_button(tr("Smooth",null),"")){
				util_mesh_calc_normals(true);
				context_raw->ddirty=2;
			}
			if(ui_menu_button(tr("Flat",null),"")){
				util_mesh_calc_normals(false);
				context_raw->ddirty=2;
			}
}

void tab_meshes_draw_128723(ui_t * ui){
if(ui_menu_button(tr("Replace Existing",null),any_map_get(config_keymap,"file_import_assets"))){
				project_import_mesh(true,null);
			}
			if(ui_menu_button(tr("Append",null),"")){
				project_append_mesh();
			}
}

void tab_meshes_set_default_mesh(string_t * name){
	mesh_object_t * mo=null;
	if(string_equals(name,".Plane")||string_equals(name,".Sphere")){
		i32 res=config_raw->rp_supersample>1.0?2048:1024;
		raw_mesh_t * mesh=string_equals(name,".Plane")?geom_make_plane(1,1,res,res,1.0):geom_make_uv_sphere(1.0,res,math_floor(res/(float)2),false,2.0);
		mesh_data_t * raw=GC_ALLOC_INIT(mesh_data_t, {.name="Tessellated",.vertex_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_array_t, {.values=mesh->posa,.attrib="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_array_t, {.values=mesh->nora,.attrib="nor",.data="short2norm"}),GC_ALLOC_INIT(vertex_array_t, {.values=mesh->texa,.attrib="tex",.data="short2norm"}),},3),.index_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(index_array_t, {.values=mesh->inda,.material=0}),},1),.scale_pos=mesh->scale_pos,.scale_tex=mesh->scale_tex});
		mesh_data_t * md=mesh_data_create(raw);
		mo=mesh_object_create(md,context_raw->paint_object->materials);
		array_remove(scene_meshes,mo);
		mo->base->name="Tessellated";
	}
	else {
		mo=scene_get_child(name)->ext;
	}
	mo->base->visible=true;
	context_raw->ddirty=2;
	context_raw->paint_object=mo;
	project_paint_objects->buffer[0]=mo;
	if(ui_header_worktab->position==space_type_t_SPACE3D){
		gc_unroot(scene_meshes);scene_meshes=any_array_create_from_raw((any[]){mo,},1);gc_root(scene_meshes);
	}
	render_path_raytrace_ready=false;
}

void tab_particles_draw(ui_handle_t * htab){
	if(ui_tab(htab,tr("Particles",null),false,-1)){
		ui_begin_sticky();
		f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,1/(float)4,},3);
		ui_row(row);
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
		}
		if(ui_button(tr("Nodes",null),ui_align_t_CENTER,"")){
		}
		ui_end_sticky();
	}
}

void tab_plugins_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	if(ui_tab(htab,tr("Plugins",null),false,-1)){
		ui_begin_sticky();
		f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,},1);
		ui_row(row);
		if(ui_button(tr("Manager",null),ui_align_t_CENTER,"")){
			box_preferences_htab->position=6;
			box_preferences_show();
		}
		ui_end_sticky();
		string_t_array_t * keys=map_keys(plugin_map);
		for(i32 i=0;i<keys->length;++i){
			plugin_t * p=any_map_get(plugin_map,keys->buffer[i]);
			if(p->on_ui!=null){
				js_call(p->on_ui);
			}
		}
	}
}

void plugin_uv_unwrap_button(){
	any cb=any_map_get(util_mesh_unwrappers,"uv_unwrap.js");
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_data_t * md=project_paint_objects->buffer[i]->data;
		raw_mesh_t * mesh=GC_ALLOC_INIT(raw_mesh_t, {.posa=md->vertex_arrays->buffer[0]->values,.nora=md->vertex_arrays->buffer[1]->values,.texa=null,.inda=md->index_arrays->buffer[0]->values});
		js_call_ptr(cb,mesh);
		md->vertex_arrays->buffer[0]->values=mesh->posa;
		md->vertex_arrays->buffer[1]->values=mesh->nora;
		md->vertex_arrays->buffer[2]->values=mesh->texa;
		md->index_arrays->buffer[0]->values=mesh->inda;
		md->_->indices->buffer[0]=mesh->inda;
		md->_->ready=false;
		mesh_data_build(md);
	}
	util_mesh_merge(null);
}

void tab_script_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_tab(htab,tr("Script",null),false,-1)&&statush>ui_status_default_status_h*ui_SCALE(ui)){
		ui_begin_sticky();
		if(config_raw->touch_ui){
			ui_row4();
		}
		else {
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)14,1/(float)14,1/(float)14,1/(float)14,},4);
			ui_row(row);
		}
		if(ui_button(tr("Run",null),ui_align_t_CENTER,"")){
			js_eval(tab_script_hscript->text);
		}
		if(ui_button(tr("Clear",null),ui_align_t_CENTER,"")){
			tab_script_hscript->text="";
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_files_show("js",false,false,&tab_script_draw_130085			);
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			ui_files_show("js",true,false,&tab_script_draw_130137			);
		}
		ui_end_sticky();
		draw_font_t * _font=ui->ops->font;
		i32 _font_size=ui->font_size;
		draw_font_t * f=data_get_font("font_mono.ttf");
		ui_set_font(ui,f);
		ui->font_size=math_floor(15*ui_SCALE(ui));
		ui_text_area_line_numbers=true;
		ui_text_area_scroll_past_end=true;
		gc_unroot(ui_text_area_coloring);ui_text_area_coloring=tab_script_get_text_coloring();gc_root(ui_text_area_coloring);
		ui_text_area(tab_script_hscript,ui_align_t_LEFT,true,"",false);
		ui_text_area_line_numbers=false;
		ui_text_area_scroll_past_end=false;
		gc_unroot(ui_text_area_coloring);ui_text_area_coloring=null;
		ui_set_font(ui,_font);
		ui->font_size=_font_size;
	}
}

void tab_script_draw_130137(string_t * path){
string_t * str=tab_script_hscript->text;
			string_t * f=ui_files_filename;
			if(string_equals(f,"")){
				f=string_copy(tr("untitled",null));
			}
			path=string_join(string_join(path,path_sep),f);
			if(!ends_with(path,".js")){
				path=string_join(path,".js");
			}
			iron_file_save_bytes(path,sys_string_to_buffer(str),0);
}

void tab_script_draw_130085(string_t * path){
buffer_t * b=data_get_blob(path);
			tab_script_hscript->text=string_copy(sys_buffer_to_string(b));
			data_delete_blob(path);
}

ui_text_coloring_t * tab_script_get_text_coloring(){
	if(tab_script_text_coloring==null){
		buffer_t * blob=data_get_blob("text_coloring.json");
		gc_unroot(tab_script_text_coloring);tab_script_text_coloring=json_parse(sys_buffer_to_string(blob));gc_root(tab_script_text_coloring);
	}
	return tab_script_text_coloring;
}

void tab_swatches_empty_set(gpu_texture_t * image){
	gc_unroot(_tab_swatches_empty);_tab_swatches_empty=image;gc_root(_tab_swatches_empty);
}

gpu_texture_t * tab_swatches_empty_get(){
	if(_tab_swatches_empty==null){
		u8_array_t * b=u8_array_create(4);
		b->buffer[0]=255;
		b->buffer[1]=255;
		b->buffer[2]=255;
		b->buffer[3]=255;
		gc_unroot(_tab_swatches_empty);_tab_swatches_empty=gpu_create_texture_from_bytes(b,1,1,tex_format_t_RGBA32);gc_root(_tab_swatches_empty);
	}
	return _tab_swatches_empty;
}

void tab_swatches_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_tab(htab,tr("Swatches",null),false,-1)&&statush>ui_status_default_status_h*ui_SCALE(ui)){
		ui_begin_sticky();
		if(config_raw->touch_ui){
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)5,1/(float)5,1/(float)5,1/(float)5,1/(float)5,},5);
			ui_row5();
		}
		else {
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)14,1/(float)14,1/(float)14,1/(float)14,1/(float)14,},5);
			ui_row(row);
		}
		if(ui_button(tr("New",null),ui_align_t_CENTER,"")){
			context_set_swatch(make_swatch(0xffffffff));
			any_array_push(project_raw->swatches,context_raw->swatch);
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Add new swatch",null));
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_menu_draw(&tab_swatches_draw_130621			,-1,-1);
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Import swatches",null));
		}
		if(ui_button(tr("Export",null),ui_align_t_CENTER,"")){
			project_export_swatches();
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Export swatches",null));
		}
		if(ui_button(tr("Clear",null),ui_align_t_CENTER,"")){
			context_set_swatch(make_swatch(0xffffffff));
			project_raw->swatches=any_array_create_from_raw((any[]){context_raw->swatch,},1);
		}
		if(ui_button(tr("Restore",null),ui_align_t_CENTER,"")){
			project_set_default_swatches();
			context_set_swatch(project_raw->swatches->buffer[0]);
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Restore default swatches",null));
		}
		ui_end_sticky();
		ui_separator(3,false);
		i32 slotw=math_floor(26*ui_SCALE(ui));
		i32 num=math_floor(ui->_w/(float)(slotw+3));
		if(num==0){
			return ;
		}
		bool drag_pos_set=false;
		f32 uix=0.0;
		f32 uiy=0.0;
		for(i32 row=0;row<math_floor(math_ceil(project_raw->swatches->length/(float)num));++row){
			f32_array_t * ar=f32_array_create_from_raw((f32[]){},0);
			for(i32 i=0;i<num;++i){
				f32_array_push(ar,1/(float)num);
			}
			ui_row(ar);
			ui->_x+=2;
			if(row>0){
				ui->_y+=6;
			}
			for(i32 j=0;j<num;++j){
				i32 i=j+row*num;
				if(i>=project_raw->swatches->length){
					_ui_end_element(slotw);
					continue;
				}
				if(context_raw->swatch==project_raw->swatches->buffer[i]){
					i32 w=32;
					ui_fill(-2,-2,w,w,ui->ops->theme->HIGHLIGHT_COL);
				}
				uix=ui->_x;
				uiy=ui->_y;
				if(base_drag_swatch!=null&&tab_swatches_drag_pos==i){
					ui_fill(-1,-2,2,32,ui->ops->theme->HIGHLIGHT_COL);
				}
				ui_state_t state=_ui_image(tab_swatches_empty_get(),project_raw->swatches->buffer[i]->base,slotw,0,0,0,0);
				if(state==ui_state_t_STARTED){
					context_set_swatch(project_raw->swatches->buffer[i]);
					base_drag_off_x=-(mouse_x-uix-ui->_window_x-2*slotw);
					base_drag_off_y=-(mouse_y-uiy-ui->_window_y+1);
					gc_unroot(base_drag_swatch);base_drag_swatch=context_raw->swatch;gc_root(base_drag_swatch);
				}
				else if(state==ui_state_t_HOVERED){
					tab_swatches_drag_pos=(mouse_x>uix+ui->_window_x+slotw/(float)2)?i+1:i;
					drag_pos_set=true;
				}
				else if(state==ui_state_t_RELEASED){
					if(sys_time()-context_raw->select_time<0.25){
						_tab_swatches_draw_i=i;
						ui_menu_draw(&tab_swatches_draw_131168						,-1,-1);
					}
					context_raw->select_time=sys_time();
				}
				if(ui->is_hovered&&ui->input_released_r){
					context_set_swatch(project_raw->swatches->buffer[i]);
					_tab_swatches_draw_i=i;
					ui_menu_draw(&tab_swatches_draw_131458					,-1,-1);
				}
				if(ui->is_hovered){
					i32 color=project_raw->swatches->buffer[i]->base;
					color=color_set_ab(color,project_raw->swatches->buffer[i]->opacity*255);
					u32 val=color;
					ui_tooltip(string_join("#",i32_to_string_hex(val)));
				}
			}
		}
		if(base_drag_swatch!=null&&tab_swatches_drag_pos==project_raw->swatches->length){
			ui->_x=uix;
			ui->_y=uiy;
			ui_fill(28,-2,2,32,ui->ops->theme->HIGHLIGHT_COL);
		}
		if(!drag_pos_set){
			tab_swatches_drag_pos=-1;
		}
		bool in_focus=ui->input_x>ui->_window_x&&ui->input_x<ui->_window_x+ui->_window_w&&ui->input_y>ui->_window_y&&ui->input_y<ui->_window_y+ui->_window_h;
		if(in_focus&&ui->is_delete_down&&project_raw->swatches->length>1){
			ui->is_delete_down=false;
			tab_swatches_delete_swatch(context_raw->swatch);
		}
	}
}

void tab_swatches_draw_131458(ui_t * ui){
i32 i=_tab_swatches_draw_i;
					if(ui_menu_button(tr("Duplicate",null),"")){
						context_set_swatch(project_clone_swatch(context_raw->swatch));
						any_array_push(project_raw->swatches,context_raw->swatch);
					}
					else if(ui_menu_button(tr("Copy Hex Code",null),"")){
						i32 color=context_raw->swatch->base;
						color=color_set_ab(color,context_raw->swatch->opacity*255);
						u32 val=color;
						iron_copy_to_clipboard(i32_to_string(val));
					}
					else if(project_raw->swatches->length>1&&ui_menu_button(tr("Delete",null),"delete")){
						tab_swatches_delete_swatch(project_raw->swatches->buffer[i]);
					}
					else if(ui_menu_button(tr("Create Material",null),"")){
						tab_materials_accept_swatch_drag(project_raw->swatches->buffer[i]);
					}
					else if(ui_menu_button(tr("Create Color Layer",null),"")){
						i32 color=project_raw->swatches->buffer[i]->base;
						color=color_set_ab(color,project_raw->swatches->buffer[i]->opacity*255);
						layers_create_color_layer(color,project_raw->swatches->buffer[i]->occlusion,project_raw->swatches->buffer[i]->roughness,project_raw->swatches->buffer[i]->metallic,-1);
					}
}

void tab_swatches_draw_131229(swatch_color_t * color){
i32 i=_tab_swatches_draw_i;
						project_raw->swatches->buffer[i]=project_clone_swatch(color);
}

void tab_swatches_draw_131214(){
context_raw->color_picker_previous_tool=context_raw->tool;
						context_select_tool(workspace_tool_t_PICKER);
						context_raw->color_picker_callback=&tab_swatches_draw_131229;
						;
}

void tab_swatches_draw_131168(ui_t * ui){
ui->changed=false;
						ui_handle_t * h=ui_handle("tab_swatches.ts:143");
						h->color=context_raw->swatch->base;
						context_raw->swatch->base=ui_color_wheel(h,false,-1,11*ui->ops->theme->ELEMENT_H*ui_SCALE(ui),true,&tab_swatches_draw_131214						,null);
						ui_handle_t * hopacity=ui_handle("tab_swatches.ts:157");
						hopacity->value=context_raw->swatch->opacity;
						context_raw->swatch->opacity=ui_slider(hopacity,"Opacity",0,1,true,100.0,true,ui_align_t_RIGHT,true);
						ui_handle_t * hocclusion=ui_handle("tab_swatches.ts:160");
						hocclusion->value=context_raw->swatch->occlusion;
						context_raw->swatch->occlusion=ui_slider(hocclusion,"Occlusion",0,1,true,100.0,true,ui_align_t_RIGHT,true);
						ui_handle_t * hroughness=ui_handle("tab_swatches.ts:163");
						hroughness->value=context_raw->swatch->roughness;
						context_raw->swatch->roughness=ui_slider(hroughness,"Roughness",0,1,true,100.0,true,ui_align_t_RIGHT,true);
						ui_handle_t * hmetallic=ui_handle("tab_swatches.ts:166");
						hmetallic->value=context_raw->swatch->metallic;
						context_raw->swatch->metallic=ui_slider(hmetallic,"Metallic",0,1,true,100.0,true,ui_align_t_RIGHT,true);
						ui_handle_t * hheight=ui_handle("tab_swatches.ts:169");
						hheight->value=context_raw->swatch->height;
						context_raw->swatch->height=ui_slider(hheight,"Height",0,1,true,100.0,true,ui_align_t_RIGHT,true);
						if(ui->changed||ui->is_typing){
							ui_menu_keep_open=true;
						}
						if(ui->input_released){
							context_set_swatch(context_raw->swatch);
						}
}

void tab_swatches_draw_130621(ui_t * ui){
if(ui_menu_button(tr("Replace Existing",null),"")){
				project_import_swatches(true);
				context_set_swatch(project_raw->swatches->buffer[0]);
			}
			if(ui_menu_button(tr("Append",null),"")){
				project_import_swatches(false);
			}
}

void tab_swatches_accept_swatch_drag(swatch_color_t * swatch){
	if(tab_swatches_drag_pos==-1){
		return ;
	}
	i32 swatch_pos=array_index_of(project_raw->swatches,swatch);
	if(swatch_pos==-1){
		array_insert(project_raw->swatches,tab_swatches_drag_pos,swatch);
	}
	else if(math_abs(swatch_pos-tab_swatches_drag_pos)>0){
		array_remove(project_raw->swatches,swatch);
		i32 new_pos=tab_swatches_drag_pos-swatch_pos>0?tab_swatches_drag_pos-1:tab_swatches_drag_pos;
		array_insert(project_raw->swatches,new_pos,swatch);
	}
}

void tab_swatches_delete_swatch(swatch_color_t * swatch){
	i32 i=array_index_of(project_raw->swatches,swatch);
	context_set_swatch(project_raw->swatches->buffer[i==project_raw->swatches->length-1?i-1:i+1]);
	array_splice(project_raw->swatches,i,1);
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
}

void tab_textures_draw(ui_handle_t * htab){
	ui_t * ui=ui_base_ui;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_tab(htab,tr("Textures",null),false,-1)&&statush>ui_status_default_status_h*ui_SCALE(ui)){
		ui_begin_sticky();
		if(config_raw->touch_ui){
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)4,1/(float)4,},2);
			ui_row(row);
		}
		else {
			f32_array_t * row=f32_array_create_from_raw((f32[]){1/(float)14,1/(float)14,},2);
			ui_row(row);
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_files_show(string_array_join(path_texture_formats,","),false,true,&tab_textures_draw_132107			);
		}
		if(ui->is_hovered){
			ui_tooltip(string_join(string_join(string_join(tr("Import texture file",null)," ("),any_map_get(config_keymap,"file_import_assets")),")"));
		}
		if(ui_button(tr("2D View",null),ui_align_t_CENTER,"")){
			ui_base_show_2d_view(view_2d_type_t_ASSET);
		}
		ui_end_sticky();
		if(project_assets->length>0){
			i32 statusw=iron_window_width()-ui_toolbar_w(true)-config_raw->layout->buffer[layout_size_t_SIDEBAR_W];
			i32 slotw=math_floor(52*ui_SCALE(ui));
			i32 num=math_floor(statusw/(float)slotw);
			if(num==0){
				return ;
			}
			for(i32 row=0;row<math_floor(math_ceil(project_assets->length/(float)num));++row){
				i32 mult=config_raw->show_asset_names?2:1;
				f32_array_t * ar=f32_array_create_from_raw((f32[]){},0);
				for(i32 i=0;i<num*mult;++i){
					f32_array_push(ar,1/(float)num);
				}
				ui_row(ar);
				ui->_x+=2;
				f32 off=config_raw->show_asset_names?ui_ELEMENT_OFFSET(ui)*10.0:6;
				if(row>0){
					ui->_y+=off;
				}
				for(i32 j=0;j<num;++j){
					i32 imgw=math_floor(50*ui_SCALE(ui));
					i32 i=j+row*num;
					if(i>=project_assets->length){
						_ui_end_element(imgw);
						if(config_raw->show_asset_names){
							_ui_end_element(0);
						}
						continue;
					}
					asset_t * asset=project_assets->buffer[i];
					gpu_texture_t * img=project_get_image(asset);
					if(img==null){
						render_target_t * empty_rt=any_map_get(render_path_render_targets,"empty_black");
						img=empty_rt->_image;
					}
					f32 uix=ui->_x;
					f32 uiy=ui->_y;
					i32 sw=img->height<img->width?img->height:0;
					if(_ui_image(img,0xffffffff,slotw,0,0,sw,sw)==ui_state_t_STARTED&&ui->input_y>ui->_window_y){
						base_drag_off_x=-(mouse_x-uix-ui->_window_x-3);
						base_drag_off_y=-(mouse_y-uiy-ui->_window_y+1);
						gc_unroot(base_drag_asset);base_drag_asset=asset;gc_root(base_drag_asset);
						context_raw->texture=asset;
						if(sys_time()-context_raw->select_time<0.25){
							ui_base_show_2d_view(view_2d_type_t_ASSET);
						}
						context_raw->select_time=sys_time();
						ui_view2d_hwnd->redraws=2;
					}
					if(asset==context_raw->texture){
						f32 _uix=ui->_x;
						f32 _uiy=ui->_y;
						ui->_x=uix;
						ui->_y=uiy;
						i32 off=i%2==1?1:0;
						i32 w=50;
						ui_fill(0,0,w+3,2,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(0,w-off+2,w+3,2+off,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(0,0,2,w+3,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(w+2,0,2,w+4,ui->ops->theme->HIGHLIGHT_COL);
						ui->_x=_uix;
						ui->_y=_uiy;
					}
					bool is_packed=project_raw->packed_assets!=null&&project_packed_asset_exists(project_raw->packed_assets,asset->file);
					if(ui->is_hovered){
						ui_tooltip_image(img,256);
						if(is_packed){
							ui_tooltip(string_join(string_join(asset->name," "),tr("(packed)",null)));
						}
						else {
							ui_tooltip(asset->name);
						}
					}
					if(ui->is_hovered&&ui->input_released_r){
						context_raw->texture=asset;
						gc_unroot(_tab_textures_draw_img);_tab_textures_draw_img=img;gc_root(_tab_textures_draw_img);
						gc_unroot(_tab_textures_draw_asset);_tab_textures_draw_asset=asset;gc_root(_tab_textures_draw_asset);
						_tab_textures_draw_i=i;
						_tab_textures_draw_is_packed=is_packed;
						ui_menu_draw(&tab_textures_draw_132798						,-1,-1);
					}
					if(config_raw->show_asset_names){
						ui->_x=uix;
						ui->_y+=slotw*0.9;
						ui_text(project_assets->buffer[i]->name,ui_align_t_CENTER,0x00000000);
						if(ui->is_hovered){
							ui_tooltip(project_assets->buffer[i]->name);
						}
						ui->_y-=slotw*0.9;
						if(i==project_assets->length-1){
							ui->_y+=j==num-1?imgw:imgw+ui_ELEMENT_H(ui)+ui_ELEMENT_OFFSET(ui);
						}
					}
				}
			}
		}
		else {
			gpu_texture_t * img=resource_get("icons.k");
			rect_t * r=resource_tile50(img,0,1);
			_ui_image(img,ui->ops->theme->BUTTON_COL,r->h,r->x,r->y,r->w,r->h);
			if(ui->is_hovered){
				ui_tooltip(tr("Drag and drop files here",null));
			}
		}
		bool in_focus=ui->input_x>ui->_window_x&&ui->input_x<ui->_window_x+ui->_window_w&&ui->input_y>ui->_window_y&&ui->input_y<ui->_window_y+ui->_window_h;
		if(in_focus&&ui->is_delete_down&&project_assets->length>0&&array_index_of(project_assets,context_raw->texture)>=0){
			ui->is_delete_down=false;
			tab_textures_delete_texture(context_raw->texture);
		}
	}
}

void tab_textures_draw_133045(){
import_envmap_run(_tab_textures_draw_asset->file,_tab_textures_draw_img);
}

void tab_textures_draw_133019(){
layers_create_image_mask(_tab_textures_draw_asset);
}

void tab_textures_draw_132900(gpu_texture_t * target){
string_t * path=_tab_textures_draw_path;
							string_t * f=ui_files_filename;
							if(string_equals(f,"")){
								f=string_copy(tr("untitled",null));
							}
							if(!ends_with(f,".png")){
								f=string_join(f,".png");
							}
							iron_write_png(string_join(string_join(path,path_sep),f),gpu_get_texture_pixels(target),target->width,target->height,0);
							iron_delete_texture(target);
}

void tab_textures_draw_132837(){
gpu_texture_t * img=_tab_textures_draw_img;
							gpu_texture_t * target=gpu_create_render_target(tab_textures_to_pow2(img->width),tab_textures_to_pow2(img->height),tex_format_t_RGBA32);
							draw_begin(target,false,0);
							draw_set_pipeline(pipes_copy);
							draw_scaled_image(img,0,0,target->width,target->height);
							draw_set_pipeline(null);
							draw_end();
							sys_notify_on_next_frame(&tab_textures_draw_132900							,target);
}

void tab_textures_draw_132824(string_t * path){
gc_unroot(_tab_textures_draw_path);_tab_textures_draw_path=string_copy(path);gc_root(_tab_textures_draw_path);
							sys_notify_on_next_frame(&tab_textures_draw_132837							,null);
}

void tab_textures_draw_132798(ui_t * ui){
if(ui_menu_button(tr("Export",null),"")){
							ui_files_show("png",true,false,&tab_textures_draw_132824							);
						}
						if(ui_menu_button(tr("Reimport",null),"")){
							project_reimport_texture(_tab_textures_draw_asset);
						}
						if(ui_menu_button(tr("To Mask",null),"")){
							sys_notify_on_next_frame(&tab_textures_draw_133019							,null);
						}
						if(ui_menu_button(tr("Set as Envmap",null),"")){
							sys_notify_on_next_frame(&tab_textures_draw_133045							,null);
						}
						if(ui_menu_button(tr("Set as Color ID Map",null),"")){
							context_raw->colorid_handle->position=_tab_textures_draw_i;
							context_raw->colorid_picked=false;
							ui_toolbar_handle->redraws=1;
							if(context_raw->tool==workspace_tool_t_COLORID){
								ui_header_handle->redraws=2;
								context_raw->ddirty=2;
							}
						}
						if(ui_menu_button(tr("Delete",null),"delete")){
							tab_textures_delete_texture(_tab_textures_draw_asset);
						}
						if(!_tab_textures_draw_is_packed&&ui_menu_button(tr("Open Containing Directory...",null),"")){
							file_start(substring(_tab_textures_draw_asset->file,0,string_last_index_of(_tab_textures_draw_asset->file,path_sep)));
						}
						if(!_tab_textures_draw_is_packed&&ui_menu_button(tr("Open in Browser",null),"")){
							tab_browser_show_directory(substring(_tab_textures_draw_asset->file,0,string_last_index_of(_tab_textures_draw_asset->file,path_sep)));
						}
}

void tab_textures_draw_132107(string_t * path){
import_asset_run(path,-1.0,-1.0,true,false,null);
			ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
}

i32 tab_textures_to_pow2(i32 i){
	i--;
	i|=i>>1;
	i|=i>>2;
	i|=i>>4;
	i|=i>>8;
	i|=i>>16;
	i++;
	return i;
}

void tab_textures_update_texture_pointers(ui_node_t_array_t * nodes,i32 i){
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * n=nodes->buffer[i];
		if(string_equals(n->type,"TEX_IMAGE")){
			if(n->buttons->buffer[0]->default_value->buffer[0]==i){
				n->buttons->buffer[0]->default_value->buffer[0]=9999;
			}
			else if(n->buttons->buffer[0]->default_value->buffer[0]>i){
				n->buttons->buffer[0]->default_value->buffer[0]--;
			}
		}
	}
}

void tab_textures_delete_texture(asset_t * asset){
	i32 i=array_index_of(project_assets,asset);
	if(project_assets->length>1){
		context_raw->texture=project_assets->buffer[i==project_assets->length-1?i-1:i+1];
	}
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
	if(context_raw->tool==workspace_tool_t_COLORID&&i==context_raw->colorid_handle->position){
		ui_header_handle->redraws=2;
		context_raw->ddirty=2;
		context_raw->colorid_picked=false;
		ui_toolbar_handle->redraws=1;
	}
	data_delete_image(asset->file);
	imap_delete(project_asset_map,asset->id);
	array_splice(project_assets,i,1);
	array_splice(project_asset_names,i,1);
	sys_notify_on_next_frame(&tab_textures_delete_texture_133656	,null);
	for(i32 i=0;i<project_materials->length;++i){
		slot_material_t * m=project_materials->buffer[i];
		tab_textures_update_texture_pointers(m->canvas->nodes,i);
	}
	for(i32 i=0;i<project_brushes->length;++i){
		slot_brush_t * b=project_brushes->buffer[i];
		tab_textures_update_texture_pointers(b->canvas->nodes,i);
	}
}

void tab_textures_delete_texture_133656(){
make_material_parse_paint_material(true);
	util_render_make_material_preview();
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
}

string_t * _tr(string_t * s){
	return s;
}

string_t * tr(string_t * id,any_map_t * vars){
	string_t * translation=string_copy(id);
	if(!string_equals(config_raw->locale,"en")){
		if(string_index_of(id,"\n")>-1){
			id=string_copy(string_replace_all(id,"\n","\\n"));
		}
		string_t * s=any_map_get(translator_translations,id);
		if(s!=null){
			if(string_index_of(s,"\\n")>-1){
				s=string_copy(string_replace_all(s,"\\n","\n"));
			}
			translation=string_copy(s);
		}
	}
	if(vars!=null){
		string_t_array_t * keys=map_keys(vars);
		for(i32 i=0;i<keys->length;++i){
			string_t * search=string_join(string_join("{",keys->buffer[i]),"}");
			translation=string_copy(string_replace_all(translation,search,any_map_get(vars,keys->buffer[i])));
		}
	}
	return translation;
}

void translator_load_translations(string_t * new_locale){
	if(translator_cjk_font_indices==null){
		gc_unroot(translator_cjk_font_indices);translator_cjk_font_indices=i32_map_create();gc_root(translator_cjk_font_indices);
		i32_map_set(translator_cjk_font_indices,"ja",0);
		i32_map_set(translator_cjk_font_indices,"ko",1);
		i32_map_set(translator_cjk_font_indices,"zh_cn",2);
		i32_map_set(translator_cjk_font_indices,"zh_tw",3);
		i32_map_set(translator_cjk_font_indices,"zh_tw.big5",4);
	}
	if(string_equals(new_locale,"system")){
		config_raw->locale=string_copy(iron_language());
	}
	if(!string_equals(config_raw->locale,"en")&&char_ptr_array_index_of(translator_get_supported_locales(),config_raw->locale)==-1){
		config_raw->locale="en";
	}
	gc_unroot(translator_translations);translator_translations=any_map_create();gc_root(translator_translations);
	if(string_equals(config_raw->locale,"en")&&string_equals(translator_last_locale,"en")){
		return ;
	}
	gc_unroot(translator_last_locale);translator_last_locale=string_copy(config_raw->locale);gc_root(translator_last_locale);
	if(!string_equals(config_raw->locale,"en")){
		string_t * translation_json=sys_buffer_to_string(iron_load_blob(string_join(string_join("data/locale/",config_raw->locale),".json")));
		gc_unroot(translator_translations);translator_translations=json_parse_to_map(translation_json);gc_root(translator_translations);
	}
	translator_extended_glyphs();
	bool cjk=false;
	string_t_array_t * keys=map_keys(translator_translations);
	for(i32 i=0;i<keys->length;++i){
		string_t * s=any_map_get(translator_translations,keys->buffer[i]);
		for(i32 i=0;char_code_at(s,i)!=0;){
			i32 l=0;
			i32 codepoint=string_utf8_decode((s)+i,ADDRESS(l));
			i+=l;
			if(codepoint>1119&&!draw_font_has_glyph(codepoint)){
				cjk=true;
				draw_font_add_glyph(codepoint);
			}
		}
	}
	if(cjk){
		if(path_is_protected()){
			gc_unroot(_translator_load_translations_cjk_font_path);_translator_load_translations_cjk_font_path=string_copy(iron_internal_save_path());gc_root(_translator_load_translations_cjk_font_path);
			gc_unroot(_translator_load_translations_cjk_font_disk_path);_translator_load_translations_cjk_font_disk_path=string_copy(iron_internal_save_path());gc_root(_translator_load_translations_cjk_font_disk_path);
		}
		else {
			gc_unroot(_translator_load_translations_cjk_font_path);_translator_load_translations_cjk_font_path="";gc_root(_translator_load_translations_cjk_font_path);
			gc_unroot(_translator_load_translations_cjk_font_disk_path);_translator_load_translations_cjk_font_disk_path=string_join(path_data(),path_sep);gc_root(_translator_load_translations_cjk_font_disk_path);
		}
		gc_unroot(_translator_load_translations_cjk_font_path);_translator_load_translations_cjk_font_path=string_join(_translator_load_translations_cjk_font_path,"font_cjk.ttc");gc_root(_translator_load_translations_cjk_font_path);
		gc_unroot(_translator_load_translations_cjk_font_disk_path);_translator_load_translations_cjk_font_disk_path=string_join(_translator_load_translations_cjk_font_disk_path,"font_cjk.ttc");gc_root(_translator_load_translations_cjk_font_disk_path);
		if(!file_exists(_translator_load_translations_cjk_font_disk_path)){
			file_download("https://github.com/armory3d/armorbase/raw/main/Assets/common/extra/font_cjk.ttc",_translator_load_translations_cjk_font_disk_path,&translator_load_translations_134357			,20332392);
		}
		else {
			translator_init_font(true,_translator_load_translations_cjk_font_path,1.4);
		}
	}
	else {
		translator_init_font(false,"font.ttf",1.0);
	}
}

void translator_load_translations_134357(){
if(!file_exists(_translator_load_translations_cjk_font_disk_path)){
				config_raw->locale="en";
				translator_extended_glyphs();
				gc_unroot(translator_translations);translator_translations=any_map_create();gc_root(translator_translations);
				translator_init_font(false,"font.ttf",1.0);
			}
			else {
				translator_init_font(true,_translator_load_translations_cjk_font_path,1.4);
			}
}

void translator_init_font(bool cjk,string_t * font_path,f32 font_scale){
	_translator_init_font_cjk=cjk;
	gc_unroot(_translator_init_font_font_path);_translator_init_font_font_path=string_copy(font_path);gc_root(_translator_init_font_font_path);
	_translator_init_font_font_scale=font_scale;
	sys_notify_on_init(&translator_init_font_134468	,null);
}

void translator_init_font_134468(){
bool cjk=_translator_init_font_cjk;
	string_t * font_path=_translator_init_font_font_path;
	f32 font_scale=_translator_init_font_font_scale;
	draw_font_t * f=data_get_font(font_path);
	if(cjk){
		i32 font_index=i32_map_get(translator_cjk_font_indices,config_raw->locale)!=-1?i32_map_get(translator_cjk_font_indices,config_raw->locale):0;
		f->index=font_index;
		f->glyphs_version=0;
		draw_font_init(f);
	}
	gc_unroot(base_font);base_font=f;gc_root(base_font);
	base_theme->FONT_SIZE=math_floor(base_default_font_size*font_scale);
	base_theme->ELEMENT_W=math_floor(base_default_element_w*(!string_equals(config_raw->locale,"en")?1.4:1.0));
	ui_t_array_t * uis=base_get_uis();
	for(i32 i=0;i<uis->length;++i){
		ui_t * ui=uis->buffer[i];
		ui_set_font(ui,f);
		_ui_set_scale(ui,ui_SCALE(ui));
	}
}

void translator_extended_glyphs(){
	draw_font_init_glyphs(32,383);
	for(i32 i=880;i<1023;++i){
		draw_font_add_glyph(i);
	}
	for(i32 i=1024;i<1119;++i){
		draw_font_add_glyph(i);
	}
}

string_t_array_t * translator_get_supported_locales(){
	string_t_array_t * locales=any_array_create_from_raw((any[]){"system","en",},2);
	string_t_array_t * files=file_read_directory(string_join(string_join(path_data(),path_sep),"locale"));
	for(i32 i=0;i<files->length;++i){
		string_t * locale_filename=files->buffer[i];
		any_array_push(locales,substring(locale_filename,0,string_length(locale_filename)-5));
	}
	return locales;
}

ui_handle_t_array_t * ui_base_init_hwnds(){
	ui_handle_t_array_t * hwnds=any_array_create_from_raw((any[]){ui_handle_create(),ui_handle_create(),ui_handle_create(),},3);
	return hwnds;
}

ui_handle_t_array_t * ui_base_init_htabs(){
	ui_handle_t_array_t * htabs=any_array_create_from_raw((any[]){ui_handle_create(),ui_handle_create(),ui_handle_create(),},3);
	return htabs;
}

tab_draw_t * _draw_callback_create(void(*f)(ui_handle_t *)){
	tab_draw_t * cb=GC_ALLOC_INIT(tab_draw_t, {.f=f});
	return cb;
}

tab_draw_array_t_array_t * ui_base_init_hwnd_tabs(){
	return ui_base_ext_init_hwnd_tabs();
}

void ui_base_init(){
	ui_toolbar_init();
	context_raw->text_tool_text=string_copy(tr("Text",null));
	ui_header_init();
	ui_status_init();
	ui_menubar_init();
	ui_header_h=math_floor(ui_header_default_h*config_raw->window_scale);
	ui_menubar_w=math_floor(ui_menubar_default_w*config_raw->window_scale);
	if(project_materials==null){
		gc_unroot(project_materials);project_materials=any_array_create_from_raw((any[]){},0);gc_root(project_materials);
		material_data_t * m=data_get_material("Scene","Material");
		any_array_push(project_materials,slot_material_create(m,null));
		context_raw->material=project_materials->buffer[0];
	}
	if(project_brushes==null){
		gc_unroot(project_brushes);project_brushes=any_array_create_from_raw((any[]){},0);gc_root(project_brushes);
		any_array_push(project_brushes,slot_brush_create(null));
		context_raw->brush=project_brushes->buffer[0];
		make_material_parse_brush();
	}
	if(project_fonts==null){
		gc_unroot(project_fonts);project_fonts=any_array_create_from_raw((any[]){},0);gc_root(project_fonts);
		any_array_push(project_fonts,slot_font_create("default.ttf",base_font,""));
		context_raw->font=project_fonts->buffer[0];
	}
	if(project_layers==null){
		gc_unroot(project_layers);project_layers=any_array_create_from_raw((any[]){},0);gc_root(project_layers);
		any_array_push(project_layers,slot_layer_create("",layer_slot_type_t_LAYER,null));
		context_raw->layer=project_layers->buffer[0];
	}
	if(project_raw->swatches==null){
		project_set_default_swatches();
		context_raw->swatch=project_raw->swatches->buffer[0];
	}
	if(context_raw->empty_envmap==null){
		ui_base_make_empty_envmap(base_theme->VIEWPORT_COL);
	}
	if(context_raw->preview_envmap==null){
		u8_array_t * b=u8_array_create(4);
		b->buffer[0]=0;
		b->buffer[1]=0;
		b->buffer[2]=0;
		b->buffer[3]=255;
		context_raw->preview_envmap=gpu_create_texture_from_bytes(b,1,1,tex_format_t_RGBA32);
	}
	world_data_t * world=scene_world;
	if(context_raw->saved_envmap==null){
		context_raw->default_irradiance=world->_->irradiance;
		context_raw->default_radiance=world->_->radiance;
		context_raw->default_radiance_mipmaps=world->_->radiance_mipmaps;
	}
	world->_->envmap=context_raw->show_envmap?context_raw->saved_envmap:context_raw->empty_envmap;
	context_raw->ddirty=1;
	history_reset();
	f32 scale=config_raw->window_scale;
	ui_options_t * ops=GC_ALLOC_INIT(ui_options_t, {.theme=base_theme,.font=base_font,.scale_factor=scale,.color_wheel=base_color_wheel,.black_white_gradient=base_color_wheel_gradient});
	gc_unroot(ui_base_ui);ui_base_ui=ui_create(ops);gc_root(ui_base_ui);
	gc_unroot(ui_on_border_hover);ui_on_border_hover=ui_base_on_border_hover;gc_root(ui_on_border_hover);
	gc_unroot(ui_on_text_hover);ui_on_text_hover=ui_base_on_text_hover;gc_root(ui_on_text_hover);
	gc_unroot(ui_on_deselect_text);ui_on_deselect_text=ui_base_on_deselect_text;gc_root(ui_on_deselect_text);
	gc_unroot(ui_on_tab_drop);ui_on_tab_drop=ui_base_on_tab_drop;gc_root(ui_on_tab_drop);
	string_t_array_t * resources=any_array_create_from_raw((any[]){"cursor.k","icons.k",},2);
	context_raw->gizmo=scene_get_child(".Gizmo");
	context_raw->gizmo_translate_x=object_get_child(context_raw->gizmo,".TranslateX");
	context_raw->gizmo_translate_y=object_get_child(context_raw->gizmo,".TranslateY");
	context_raw->gizmo_translate_z=object_get_child(context_raw->gizmo,".TranslateZ");
	context_raw->gizmo_scale_x=object_get_child(context_raw->gizmo,".ScaleX");
	context_raw->gizmo_scale_y=object_get_child(context_raw->gizmo,".ScaleY");
	context_raw->gizmo_scale_z=object_get_child(context_raw->gizmo,".ScaleZ");
	context_raw->gizmo_rotate_x=object_get_child(context_raw->gizmo,".RotateX");
	context_raw->gizmo_rotate_y=object_get_child(context_raw->gizmo,".RotateY");
	context_raw->gizmo_rotate_z=object_get_child(context_raw->gizmo,".RotateZ");
	resource_load(resources);
	if(ui_SCALE(ui_base_ui)>1){
		ui_base_set_icon_scale();
	}
	context_raw->paint_object=scene_get_child(".Cube")->ext;
	gc_unroot(project_paint_objects);project_paint_objects=any_array_create_from_raw((any[]){context_raw->paint_object,},1);gc_root(project_paint_objects);
	if(string_equals(project_filepath,"")){
		sys_notify_on_init(layers_init,null);
	}
	context_raw->project_objects=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<scene_meshes->length;++i){
		mesh_object_t * m=scene_meshes->buffer[i];
		any_array_push(context_raw->project_objects,m);
	}
	operator_register("view_top",ui_base_view_top);
}

void ui_base_update(){
	ui_base_update_ui();
	operator_update();
	string_t_array_t * keys=map_keys(plugin_map);
	for(i32 i=0;i<keys->length;++i){
		plugin_t * p=any_map_get(plugin_map,keys->buffer[i]);
		if(p->on_update!=null){
			js_call(p->on_update);
		}
	}
	if(!base_ui_enabled){
		return ;
	}
	if(!ui_nodes_ui->is_typing&&!ui_base_ui->is_typing){
		if(operator_shortcut(any_map_get(config_keymap,"toggle_node_editor"),shortcut_type_t_STARTED)){
			ui_nodes_canvas_type==canvas_type_t_MATERIAL?ui_base_show_material_nodes():ui_base_show_brush_nodes();
		}
		else if(operator_shortcut(any_map_get(config_keymap,"toggle_browser"),shortcut_type_t_STARTED)){
			ui_base_toggle_browser();
		}
		else if(operator_shortcut(any_map_get(config_keymap,"toggle_2d_view"),shortcut_type_t_STARTED)){
			ui_base_show_2d_view(view_2d_type_t_LAYER);
		}
	}
	if(operator_shortcut(any_map_get(config_keymap,"file_save_as"),shortcut_type_t_STARTED)){
		project_save_as(false);
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_save"),shortcut_type_t_STARTED)){
		project_save(false);
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_open"),shortcut_type_t_STARTED)){
		project_open();
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_open_recent"),shortcut_type_t_STARTED)){
		box_projects_show();
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_reimport_mesh"),shortcut_type_t_STARTED)){
		project_reimport_mesh();
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_reimport_textures"),shortcut_type_t_STARTED)){
		project_reimport_textures();
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_new"),shortcut_type_t_STARTED)){
		project_new_box();
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_export_textures"),shortcut_type_t_STARTED)){
		if(string_equals(context_raw->texture_export_path,"")){
			context_raw->layers_export=export_mode_t_VISIBLE;
			box_export_show_textures();
		}
		else {
			sys_notify_on_init(&ui_base_update_135942			,null);
		}
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_export_textures_as"),shortcut_type_t_STARTED)){
		context_raw->layers_export=export_mode_t_VISIBLE;
		box_export_show_textures();
	}
	else if(operator_shortcut(any_map_get(config_keymap,"file_import_assets"),shortcut_type_t_STARTED)){
		project_import_asset(null,true);
	}
	else if(operator_shortcut(any_map_get(config_keymap,"edit_prefs"),shortcut_type_t_STARTED)){
		box_preferences_show();
	}
	if(keyboard_started(any_map_get(config_keymap,"view_distract_free"))||(keyboard_started("escape")&&!ui_base_show&&!ui_box_show)){
		ui_base_toggle_distract_free();
	}
	bool decal=context_is_decal();
	bool decal_mask=context_is_decal_mask();
	if((context_raw->brush_can_lock||context_raw->brush_locked)&&mouse_moved){
		if(operator_shortcut(any_map_get(config_keymap,"brush_radius"),shortcut_type_t_DOWN)||operator_shortcut(any_map_get(config_keymap,"brush_opacity"),shortcut_type_t_DOWN)||operator_shortcut(any_map_get(config_keymap,"brush_angle"),shortcut_type_t_DOWN)||(decal_mask&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"brush_radius")),shortcut_type_t_DOWN))){
			if(context_raw->brush_locked){
				if(operator_shortcut(any_map_get(config_keymap,"brush_opacity"),shortcut_type_t_DOWN)){
					context_raw->brush_opacity+=mouse_movement_x/(float)500;
					context_raw->brush_opacity=math_max(0.0,math_min(1.0,context_raw->brush_opacity));
					context_raw->brush_opacity=math_round(context_raw->brush_opacity*100)/(float)100;
					context_raw->brush_opacity_handle->value=context_raw->brush_opacity;
				}
				else if(operator_shortcut(any_map_get(config_keymap,"brush_angle"),shortcut_type_t_DOWN)){
					context_raw->brush_angle+=mouse_movement_x/(float)5;
					i32 i=math_floor(context_raw->brush_angle);
					context_raw->brush_angle=i%360;
					if(context_raw->brush_angle<0)context_raw->brush_angle+=360;
					context_raw->brush_angle_handle->value=context_raw->brush_angle;
					make_material_parse_paint_material(true);
				}
				else if(decal_mask&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"brush_radius")),shortcut_type_t_DOWN)){
					context_raw->brush_decal_mask_radius+=mouse_movement_x/(float)150;
					context_raw->brush_decal_mask_radius=math_max(0.01,math_min(4.0,context_raw->brush_decal_mask_radius));
					context_raw->brush_decal_mask_radius=math_round(context_raw->brush_decal_mask_radius*100)/(float)100;
					context_raw->brush_decal_mask_radius_handle->value=context_raw->brush_decal_mask_radius;
				}
				else {
					context_raw->brush_radius+=mouse_movement_x/(float)150;
					context_raw->brush_radius=math_max(0.01,math_min(4.0,context_raw->brush_radius));
					context_raw->brush_radius=math_round(context_raw->brush_radius*100)/(float)100;
					context_raw->brush_radius_handle->value=context_raw->brush_radius;
				}
				ui_header_handle->redraws=2;
			}
			else if(context_raw->brush_can_lock){
				context_raw->brush_can_lock=false;
				context_raw->brush_locked=true;
			}
		}
	}
	bool is_typing=ui_base_ui->is_typing||ui_view2d_ui->is_typing||ui_nodes_ui->is_typing;
	if(!is_typing){
		if(operator_shortcut(any_map_get(config_keymap,"select_material"),shortcut_type_t_DOWN)){
			ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
			for(i32 i=1;i<10;++i){
				if(keyboard_started(string_join(i32_to_string(i),""))){
					context_select_material(i-1);
				}
			}
		}
		else if(operator_shortcut(any_map_get(config_keymap,"select_layer"),shortcut_type_t_DOWN)){
			ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
			for(i32 i=1;i<10;++i){
				if(keyboard_started(string_join(i32_to_string(i),""))){
					context_select_layer(i-1);
				}
			}
		}
	}
	if(context_in_paint_area()&&!is_typing){
		if(!mouse_down("right")){
			if(operator_shortcut(any_map_get(config_keymap,"tool_brush"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_BRUSH);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_eraser"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_ERASER);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_fill"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_FILL);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_colorid"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_COLORID);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_decal"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_DECAL);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_text"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_TEXT);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_clone"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_CLONE);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_blur"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_BLUR);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_smudge"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_SMUDGE);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_particle"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_PARTICLE);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_picker"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_PICKER);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_bake"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_BAKE);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_gizmo"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_GIZMO);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"tool_material"),shortcut_type_t_STARTED)){
				context_select_tool(workspace_tool_t_MATERIAL);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"swap_brush_eraser"),shortcut_type_t_STARTED)){
				context_select_tool(context_raw->tool==workspace_tool_t_BRUSH?workspace_tool_t_ERASER:workspace_tool_t_BRUSH);
			}
		}
		if(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER||context_raw->tool==workspace_tool_t_DECAL||context_raw->tool==workspace_tool_t_TEXT||context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE||context_raw->tool==workspace_tool_t_PARTICLE){
			if(operator_shortcut(any_map_get(config_keymap,"brush_radius"),shortcut_type_t_STARTED)||operator_shortcut(any_map_get(config_keymap,"brush_opacity"),shortcut_type_t_STARTED)||operator_shortcut(any_map_get(config_keymap,"brush_angle"),shortcut_type_t_STARTED)||(decal_mask&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"brush_radius")),shortcut_type_t_STARTED))){
				context_raw->brush_can_lock=true;
				if(!pen_connected){
					mouse_lock();
				}
				context_raw->lock_started_x=mouse_x;
				context_raw->lock_started_y=mouse_y;
			}
			else if(operator_shortcut(any_map_get(config_keymap,"brush_radius_decrease"),shortcut_type_t_REPEAT)){
				context_raw->brush_radius-=ui_base_get_radius_increment();
				context_raw->brush_radius=math_max(math_round(context_raw->brush_radius*100)/(float)100,0.01);
				context_raw->brush_radius_handle->value=context_raw->brush_radius;
				ui_header_handle->redraws=2;
			}
			else if(operator_shortcut(any_map_get(config_keymap,"brush_radius_increase"),shortcut_type_t_REPEAT)){
				context_raw->brush_radius+=ui_base_get_radius_increment();
				context_raw->brush_radius=math_round(context_raw->brush_radius*100)/(float)100;
				context_raw->brush_radius_handle->value=context_raw->brush_radius;
				ui_header_handle->redraws=2;
			}
			else if(decal_mask){
				if(operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"brush_radius_decrease")),shortcut_type_t_REPEAT)){
					context_raw->brush_decal_mask_radius-=ui_base_get_radius_increment();
					context_raw->brush_decal_mask_radius=math_max(math_round(context_raw->brush_decal_mask_radius*100)/(float)100,0.01);
					context_raw->brush_decal_mask_radius_handle->value=context_raw->brush_decal_mask_radius;
					ui_header_handle->redraws=2;
				}
				else if(operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"brush_radius_increase")),shortcut_type_t_REPEAT)){
					context_raw->brush_decal_mask_radius+=ui_base_get_radius_increment();
					context_raw->brush_decal_mask_radius=math_round(context_raw->brush_decal_mask_radius*100)/(float)100;
					context_raw->brush_decal_mask_radius_handle->value=context_raw->brush_decal_mask_radius;
					ui_header_handle->redraws=2;
				}
			}
		}
		if(decal_mask&&(operator_shortcut(any_map_get(config_keymap,"decal_mask"),shortcut_type_t_STARTED)||operator_shortcut(any_map_get(config_keymap,"decal_mask"),shortcut_type_t_RELEASED))){
			ui_header_handle->redraws=2;
		}
		if(mouse_view_x()<sys_w()){
			if(operator_shortcut(any_map_get(config_keymap,"view_reset"),shortcut_type_t_STARTED)){
				viewport_reset();
				viewport_scale_to_bounds();
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_back"),shortcut_type_t_STARTED)){
				viewport_set_view(0,1,0,math_pi()/(float)2,0,math_pi());
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_front"),shortcut_type_t_STARTED)){
				viewport_set_view(0,-1,0,math_pi()/(float)2,0,0);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_left"),shortcut_type_t_STARTED)){
				viewport_set_view(-1,0,0,math_pi()/(float)2,0,-math_pi()/(float)2);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_right"),shortcut_type_t_STARTED)){
				viewport_set_view(1,0,0,math_pi()/(float)2,0,math_pi()/(float)2);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_bottom"),shortcut_type_t_STARTED)){
				viewport_set_view(0,0,-1,math_pi(),0,math_pi());
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_camera_type"),shortcut_type_t_STARTED)){
				context_raw->camera_type=context_raw->camera_type==camera_type_t_PERSPECTIVE?camera_type_t_ORTHOGRAPHIC:camera_type_t_PERSPECTIVE;
				context_raw->cam_handle->position=context_raw->camera_type;
				viewport_update_camera_type(context_raw->camera_type);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_orbit_left"),shortcut_type_t_REPEAT)){
				viewport_orbit(-math_pi()/(float)12,0);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_orbit_right"),shortcut_type_t_REPEAT)){
				viewport_orbit(math_pi()/(float)12,0);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_orbit_up"),shortcut_type_t_REPEAT)){
				viewport_orbit(0,-math_pi()/(float)12);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_orbit_down"),shortcut_type_t_REPEAT)){
				viewport_orbit(0,math_pi()/(float)12);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_orbit_opposite"),shortcut_type_t_STARTED)){
				viewport_orbit_opposite();
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_zoom_in"),shortcut_type_t_REPEAT)){
				viewport_zoom(0.2);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"view_zoom_out"),shortcut_type_t_REPEAT)){
				viewport_zoom(-0.2);
			}
			else if(operator_shortcut(any_map_get(config_keymap,"viewport_mode"),shortcut_type_t_STARTED)){
				base_ui_menu->is_key_pressed=false;
				ui_menu_draw(&ui_base_update_137635				,-1,-1);
			}
		}
		if(operator_shortcut(any_map_get(config_keymap,"operator_search"),shortcut_type_t_STARTED)){
			ui_base_operator_search();
		}
	}
	if(context_raw->brush_can_lock||context_raw->brush_locked){
		if(mouse_moved&&context_raw->brush_can_unlock){
			context_raw->brush_locked=false;
			context_raw->brush_can_unlock=false;
		}
		bool b=(context_raw->brush_can_lock||context_raw->brush_locked)&&!operator_shortcut(any_map_get(config_keymap,"brush_radius"),shortcut_type_t_DOWN)&&!operator_shortcut(any_map_get(config_keymap,"brush_opacity"),shortcut_type_t_DOWN)&&!operator_shortcut(any_map_get(config_keymap,"brush_angle"),shortcut_type_t_DOWN)&&!(decal_mask&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"brush_radius")),shortcut_type_t_DOWN));
		if(b){
			mouse_unlock();
			context_raw->last_paint_x=-1;
			context_raw->last_paint_y=-1;
			if(context_raw->brush_can_lock){
				context_raw->brush_can_lock=false;
				context_raw->brush_can_unlock=false;
				context_raw->brush_locked=false;
			}
			else {
				context_raw->brush_can_unlock=true;
			}
		}
	}
	if(ui_base_border_handle!=null){
		if(ui_base_border_handle==ui_nodes_hwnd||ui_base_border_handle==ui_view2d_hwnd){
			if(ui_base_border_started==border_side_t_LEFT){
				config_raw->layout->buffer[layout_size_t_NODES_W]-=math_floor(mouse_movement_x);
				if(config_raw->layout->buffer[layout_size_t_NODES_W]<32){
					config_raw->layout->buffer[layout_size_t_NODES_W]=32;
				}
				else if(config_raw->layout->buffer[layout_size_t_NODES_W]>iron_window_width()*0.7){
					config_raw->layout->buffer[layout_size_t_NODES_W]=math_floor(iron_window_width()*0.7);
				}
			}
			else {
				config_raw->layout->buffer[layout_size_t_NODES_H]-=math_floor(mouse_movement_y);
				if(config_raw->layout->buffer[layout_size_t_NODES_H]<32){
					config_raw->layout->buffer[layout_size_t_NODES_H]=32;
				}
				else if(config_raw->layout->buffer[layout_size_t_NODES_H]>sys_h()*0.95){
					config_raw->layout->buffer[layout_size_t_NODES_H]=math_floor(sys_h()*0.95);
				}
			}
		}
		else if(ui_base_border_handle==ui_base_hwnds->buffer[tab_area_t_STATUS]){
			i32 my=math_floor(mouse_movement_y);
			if(config_raw->layout->buffer[layout_size_t_STATUS_H]-my>=ui_status_default_status_h*config_raw->window_scale&&config_raw->layout->buffer[layout_size_t_STATUS_H]-my<iron_window_height()*0.7){
				config_raw->layout->buffer[layout_size_t_STATUS_H]-=my;
			}
		}
		else {
			if(ui_base_border_started==border_side_t_LEFT){
				config_raw->layout->buffer[layout_size_t_SIDEBAR_W]-=math_floor(mouse_movement_x);
				if(config_raw->layout->buffer[layout_size_t_SIDEBAR_W]<ui_base_sidebar_mini_w){
					config_raw->layout->buffer[layout_size_t_SIDEBAR_W]=ui_base_sidebar_mini_w;
				}
				else if(config_raw->layout->buffer[layout_size_t_SIDEBAR_W]>iron_window_width()-ui_base_sidebar_mini_w){
					config_raw->layout->buffer[layout_size_t_SIDEBAR_W]=iron_window_width()-ui_base_sidebar_mini_w;
				}
			}
			else {
				i32 my=math_floor(mouse_movement_y);
				if(ui_base_border_handle==ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]&&ui_base_border_started==border_side_t_TOP){
					if(config_raw->layout->buffer[layout_size_t_SIDEBAR_H0]+my>32&&config_raw->layout->buffer[layout_size_t_SIDEBAR_H1]-my>32){
						config_raw->layout->buffer[layout_size_t_SIDEBAR_H0]+=my;
						config_raw->layout->buffer[layout_size_t_SIDEBAR_H1]-=my;
					}
				}
			}
		}
	}
	if(!mouse_down("left")){
		gc_unroot(ui_base_border_handle);ui_base_border_handle=null;
		base_is_resizing=false;
	}
	if(context_raw->tool==workspace_tool_t_PARTICLE&&context_in_paint_area()&&!context_raw->paint2d){
		util_particle_init_physics();
		physics_world_t * world=physics_world_active;
		physics_world_update(world);
		context_raw->ddirty=2;
		context_raw->rdirty=2;
		if(mouse_started("left")){
			if(context_raw->particle_timer!=null){
				tween_stop(context_raw->particle_timer);
				tween_anim_t * timer=context_raw->particle_timer;
				timer->done(timer->done_data);
				context_raw->particle_timer=null;
			}
			history_push_undo=true;
			context_raw->particle_hit_x=context_raw->particle_hit_y=context_raw->particle_hit_z=0;
			object_t * o=scene_spawn_object(".Sphere",null,true);
			mesh_object_t * mo=o->ext;
			mo->base->name=".Bullet";
			mo->base->visible=true;
			camera_object_t * camera=scene_camera;
			transform_t * ct=camera->base->transform;
			mo->base->transform->loc=vec4_create(transform_world_x(ct),transform_world_y(ct),transform_world_z(ct),1.0);
			mo->base->transform->scale=vec4_create(context_raw->brush_radius*0.2,context_raw->brush_radius*0.2,context_raw->brush_radius*0.2,1.0);
			transform_build_matrix(mo->base->transform);
			physics_body_t * body=physics_body_create();
			body->shape=physics_shape_t_SPHERE;
			body->mass=1.0;
			physics_body_init(body,mo->base);
			ray_t * ray=raycast_get_ray(mouse_view_x(),mouse_view_y(),camera);
			physics_body_apply_impulse(body,vec4_mult(ray->dir,0.15));
			context_raw->particle_timer=tween_timer(5,&ui_base_update_138648			,mo);
		}
		physics_pair_t_array_t * pairs=physics_world_get_contact_pairs(world,context_raw->paint_body);
		if(pairs!=null){
			for(i32 i=0;i<pairs->length;++i){
				physics_pair_t * p=pairs->buffer[i];
				context_raw->last_particle_hit_x=context_raw->particle_hit_x!=0?context_raw->particle_hit_x:p->pos_a_x;
				context_raw->last_particle_hit_y=context_raw->particle_hit_y!=0?context_raw->particle_hit_y:p->pos_a_y;
				context_raw->last_particle_hit_z=context_raw->particle_hit_z!=0?context_raw->particle_hit_z:p->pos_a_z;
				context_raw->particle_hit_x=p->pos_a_x;
				context_raw->particle_hit_y=p->pos_a_y;
				context_raw->particle_hit_z=p->pos_a_z;
				context_raw->pdirty=1;
				break;
			}
		}
	}
}

void ui_base_update_138648(mesh_object_t * mo){
mesh_object_remove(mo);
}

void ui_base_update_137635(ui_t * ui){
ui_handle_t * mode_handle=ui_handle("ui_base.ts:567");
				mode_handle->position=context_raw->viewport_mode;
				ui_text(tr("Viewport Mode",null),ui_align_t_RIGHT,0x00000000);
				string_t_array_t * modes=any_array_create_from_raw((any[]){tr("Lit",null),tr("Base Color",null),tr("Normal",null),tr("Occlusion",null),tr("Roughness",null),tr("Metallic",null),tr("Opacity",null),tr("Height",null),tr("Emission",null),tr("Subsurface",null),tr("TexCoord",null),tr("Object Normal",null),tr("Material ID",null),tr("Object ID",null),tr("Mask",null),},15);
				string_t_array_t * shortcuts=any_array_create_from_raw((any[]){"l","b","n","o","r","m","a","h","e","s","t","1","2","3","4",},15);
				if(gpu_raytrace_supported()){
					any_array_push(modes,tr("Path Traced",null));
					any_array_push(shortcuts,"p");
				}
				for(i32 i=0;i<modes->length;++i){
					ui_radio(mode_handle,i,modes->buffer[i],shortcuts->buffer[i]);
				}
				i32 index=char_ptr_array_index_of(shortcuts,keyboard_key_code(ui->key_code));
				if(ui->is_key_pressed&&index!=-1){
					mode_handle->position=index;
					ui->changed=true;
					context_set_viewport_mode(mode_handle->position);
				}
				else if(mode_handle->changed){
					context_set_viewport_mode(mode_handle->position);
					ui->changed=true;
				}
}

void ui_base_update_135942(){
export_texture_run(context_raw->texture_export_path,false);
}

void ui_base_view_top(){
	bool is_typing=ui_base_ui->is_typing||ui_view2d_ui->is_typing||ui_nodes_ui->is_typing;
	if(context_in_paint_area()&&!is_typing){
		if(mouse_view_x()<sys_w()){
			viewport_set_view(0,0,1,0,0,0);
		}
	}
}

void ui_base_operator_search(){
	_ui_base_operator_search_first=true;
	ui_menu_draw(&ui_base_operator_search_138831	,-1,-1);
}

void ui_base_operator_search_138831(ui_t * ui){
ui_menu_h=ui_ELEMENT_H(ui)*8;
	ui_handle_t * search_handle=ui_handle("ui_base.ts:780");
	string_t * search=ui_text_input(search_handle,"",ui_align_t_LEFT,true,true);
	ui->changed=false;
	if(_ui_base_operator_search_first){
		_ui_base_operator_search_first=false;
		search_handle->text="";
		ui_start_text_edit(search_handle,ui_align_t_LEFT);
	}
	if(search_handle->changed){
		ui_base_operator_search_offset=0;
	}
	if(ui->is_key_pressed){
		if(ui->key_code==key_code_t_DOWN&&ui_base_operator_search_offset<6){
			ui_base_operator_search_offset++;
		}
		if(ui->key_code==key_code_t_UP&&ui_base_operator_search_offset>0){
			ui_base_operator_search_offset--;
		}
	}
	bool enter=keyboard_down("enter");
	i32 count=0;
	i32 BUTTON_COL=ui->ops->theme->BUTTON_COL;
	string_t_array_t * keys=map_keys(config_keymap);
	for(i32 i=0;i<keys->length;++i){
		string_t * n=keys->buffer[i];
		if(string_index_of(n,search)>=0){
			ui->ops->theme->BUTTON_COL=count==ui_base_operator_search_offset?ui->ops->theme->HIGHLIGHT_COL:ui->ops->theme->SEPARATOR_COL;
			if(ui_button(n,ui_align_t_LEFT,any_map_get(config_keymap,n))||(enter&&count==ui_base_operator_search_offset)){
				if(enter){
					ui->changed=true;
					count=6;
				}
				operator_run(n);
			}
			if(++count>6){
				break;
			}
		}
	}
	if(enter&&count==0){
		ui->changed=true;
		search_handle->text="";
	}
	ui->ops->theme->BUTTON_COL=BUTTON_COL;
}

void ui_base_toggle_distract_free(){
	ui_base_show=!ui_base_show;
	base_resize();
}

f32 ui_base_get_radius_increment(){
	return 0.1;
}

bool ui_base_hit_rect(f32 mx,f32 my,i32 x,i32 y,i32 w,i32 h){
	return mx>x&&mx<x+w&&my>y&&my<y+h;
}

rect_t * ui_base_get_brush_stencil_rect(){
	i32 w=math_floor(context_raw->brush_stencil_image->width*(base_h()/(float)context_raw->brush_stencil_image->height)*context_raw->brush_stencil_scale);
	i32 h=math_floor(base_h()*context_raw->brush_stencil_scale);
	i32 x=math_floor(base_x()+context_raw->brush_stencil_x*base_w());
	i32 y=math_floor(base_y()+context_raw->brush_stencil_y*base_h());
	rect_t * r=GC_ALLOC_INIT(rect_t, {.w=w,.h=h,.x=x,.y=y});
	return r;
}

void ui_base_update_ui(){
	if(console_message_timer>0){
		console_message_timer-=sys_delta();
		if(console_message_timer<=0){
			ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
		}
	}
	ui_base_sidebar_mini_w=math_floor(ui_base_default_sidebar_mini_w*ui_SCALE(ui_base_ui));
	if(!base_ui_enabled){
		return ;
	}
	if(context_in_viewport()){
		if(mouse_started("left")&&any_map_get(config_keymap,"action_paint")==any_map_get(config_keymap,"action_rotate")){
			gc_unroot(ui_base_action_paint_remap);ui_base_action_paint_remap=string_copy(any_map_get(config_keymap,"action_paint"));gc_root(ui_base_action_paint_remap);
			util_render_pick_pos_nor_tex();
			bool is_mesh=math_abs(context_raw->posx_picked)<50&&math_abs(context_raw->posy_picked)<50&&math_abs(context_raw->posz_picked)<50;
			bool pen_only=context_raw->pen_painting_only;
			bool is_pen=pen_only&&pen_down("tip");
			if((is_mesh&&!pen_only)||is_pen){
				any_map_set(config_keymap,"action_rotate","");
				any_map_set(config_keymap,"action_paint",ui_base_action_paint_remap);
			}
			else {
				any_map_set(config_keymap,"action_paint","");
				any_map_set(config_keymap,"action_rotate",ui_base_action_paint_remap);
			}
		}
		else if(!mouse_down("left")&&!string_equals(ui_base_action_paint_remap,"")){
			any_map_set(config_keymap,"action_rotate",ui_base_action_paint_remap);
			any_map_set(config_keymap,"action_paint",ui_base_action_paint_remap);
			gc_unroot(ui_base_action_paint_remap);ui_base_action_paint_remap="";gc_root(ui_base_action_paint_remap);
		}
	}
	if(context_raw->brush_stencil_image!=null&&operator_shortcut(any_map_get(config_keymap,"stencil_transform"),shortcut_type_t_DOWN)){
		rect_t * r=ui_base_get_brush_stencil_rect();
		if(mouse_started("left")){
			context_raw->brush_stencil_scaling=ui_base_hit_rect(mouse_x,mouse_y,r->x-8,r->y-8,16,16)||ui_base_hit_rect(mouse_x,mouse_y,r->x-8,r->h+r->y-8,16,16)||ui_base_hit_rect(mouse_x,mouse_y,r->w+r->x-8,r->y-8,16,16)||ui_base_hit_rect(mouse_x,mouse_y,r->w+r->x-8,r->h+r->y-8,16,16);
			f32 cosa=math_cos(-context_raw->brush_stencil_angle);
			f32 sina=math_sin(-context_raw->brush_stencil_angle);
			f32 ox=0;
			f32 oy=-r->h/(float)2;
			f32 x=ox*cosa-oy*sina;
			f32 y=ox*sina+oy*cosa;
			x+=r->x+r->w/(float)2;
			y+=r->y+r->h/(float)2;
			context_raw->brush_stencil_rotating=ui_base_hit_rect(mouse_x,mouse_y,math_floor(x-16),math_floor(y-16),32,32);
		}
		f32 _scale=context_raw->brush_stencil_scale;
		if(mouse_down("left")){
			if(context_raw->brush_stencil_scaling){
				i32 mult=mouse_x>r->x+r->w/(float)2?1:-1;
				context_raw->brush_stencil_scale+=mouse_movement_x/(float)400*mult;
			}
			else if(context_raw->brush_stencil_rotating){
				f32 gizmo_x=r->x+r->w/(float)2;
				f32 gizmo_y=r->y+r->h/(float)2;
				context_raw->brush_stencil_angle=-math_atan2(mouse_y-gizmo_y,mouse_x-gizmo_x)-math_pi()/(float)2;
			}
			else {
				context_raw->brush_stencil_x+=mouse_movement_x/(float)base_w();
				context_raw->brush_stencil_y+=mouse_movement_y/(float)base_h();
			}
		}
		else {
			context_raw->brush_stencil_scaling=false;
		}
		if(mouse_wheel_delta!=0){
			context_raw->brush_stencil_scale-=mouse_wheel_delta/(float)10;
		}
		f32 ratio=base_h()/(float)context_raw->brush_stencil_image->height;
		f32 old_w=_scale*context_raw->brush_stencil_image->width*ratio;
		f32 new_w=context_raw->brush_stencil_scale*context_raw->brush_stencil_image->width*ratio;
		f32 old_h=_scale*base_h();
		f32 new_h=context_raw->brush_stencil_scale*base_h();
		context_raw->brush_stencil_x+=(old_w-new_w)/(float)base_w()/(float)2;
		context_raw->brush_stencil_y+=(old_h-new_h)/(float)base_h()/(float)2;
	}
	bool set_clone_source=context_raw->tool==workspace_tool_t_CLONE&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"set_clone_source"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN);
	bool decal=context_is_decal();
	bool decal_mask=context_is_decal_mask_paint();
	bool down=operator_shortcut(any_map_get(config_keymap,"action_paint"),shortcut_type_t_DOWN)||decal_mask||set_clone_source||operator_shortcut(string_join(string_join(any_map_get(config_keymap,"brush_ruler"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN)||(pen_down("tip")&&!keyboard_down("alt"));
	if(config_raw->touch_ui){
		if(pen_down("tip")){
			context_raw->pen_painting_only=true;
		}
		else if(context_raw->pen_painting_only){
			down=false;
		}
	}
	if(context_raw->tool==workspace_tool_t_PARTICLE){
		down=false;
	}
	if(down){
		i32 mx=mouse_view_x();
		i32 my=mouse_view_y();
		i32 ww=sys_w();
		if(context_raw->paint2d){
			mx-=sys_w();
			ww=ui_view2d_ww;
		}
		if(mx<ww&&mx>sys_x()&&my<sys_h()&&my>sys_y()){
			if(set_clone_source){
				context_raw->clone_start_x=mx;
				context_raw->clone_start_y=my;
			}
			else {
				if(context_raw->brush_time==0&&!base_is_dragging&&!base_is_resizing&&!base_is_combo_selected()){
					if(operator_shortcut(string_join(string_join(any_map_get(config_keymap,"brush_ruler"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN)){
						context_raw->last_paint_vec_x=context_raw->last_paint_x;
						context_raw->last_paint_vec_y=context_raw->last_paint_y;
					}
					history_push_undo=true;
					if(context_raw->tool==workspace_tool_t_CLONE&&context_raw->clone_start_x>=0.0){
						context_raw->clone_delta_x=(context_raw->clone_start_x-mx)/(float)ww;
						context_raw->clone_delta_y=(context_raw->clone_start_y-my)/(float)sys_h();
						context_raw->clone_start_x=-1;
					}
					else if(context_raw->tool==workspace_tool_t_FILL&&context_raw->fill_type_handle->position==fill_type_t_UV_ISLAND){
						util_uv_uvislandmap_cached=false;
					}
				}
				context_raw->brush_time+=sys_delta();
				if(context_raw->run_brush!=null){
					context_raw->run_brush(context_raw->brush_output_node_inst,0);
				}
			}
		}
	}
	else if(context_raw->brush_time>0){
		context_raw->brush_time=0;
		context_raw->prev_paint_vec_x=-1;
		context_raw->prev_paint_vec_y=-1;
		context_raw->brush_blend_dirty=true;
		context_raw->layer_preview_dirty=true;
		if(context_raw->tool==workspace_tool_t_COLORID&&context_raw->layer->fill_layer!=null){
			sys_notify_on_next_frame(&ui_base_update_ui_140380			,null);
		}
	}
	if(context_raw->layers_preview_dirty){
		context_raw->layers_preview_dirty=false;
		context_raw->layer_preview_dirty=false;
		context_raw->mask_preview_last=null;
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			if(slot_layer_is_group(l)){
				continue;
			}
			gpu_texture_t * target=l->texpaint_preview;
			if(target==null){
				continue;
			}
			gpu_texture_t * source=l->texpaint;
			draw_begin(target,true,0x00000000);
			draw_set_pipeline(pipes_copy);
			draw_scaled_image(source,0,0,target->width,target->height);
			draw_set_pipeline(null);
			draw_end();
		}
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	}
	if(context_raw->layer!=null&&context_raw->layer_preview_dirty&&!slot_layer_is_group(context_raw->layer)){
		context_raw->layer_preview_dirty=false;
		context_raw->mask_preview_last=null;
		slot_layer_t * l=context_raw->layer;
		gpu_texture_t * target=l->texpaint_preview;
		if(target!=null){
			gpu_texture_t * source=l->texpaint;
			draw_begin(target,true,0x00000000);
			draw_set_pipeline(pipes_copy);
			draw_scaled_image(source,0,0,target->width,target->height);
			draw_set_pipeline(null);
			draw_end();
			ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
		}
	}
	bool undo_pressed=operator_shortcut(any_map_get(config_keymap,"edit_undo"),shortcut_type_t_STARTED);
	bool redo_pressed=operator_shortcut(any_map_get(config_keymap,"edit_redo"),shortcut_type_t_STARTED)||(keyboard_down("control")&&keyboard_started("y"));
	if(context_in_viewport()&&config_raw->touch_ui){
		if(mouse_started("middle")){
			ui_base_redo_tap_time=sys_time();
		}
		else if(mouse_started("right")){
			ui_base_undo_tap_time=sys_time();
		}
		else if(mouse_released("middle")&&sys_time()-ui_base_redo_tap_time<0.1){
			ui_base_redo_tap_time=ui_base_undo_tap_time=0;
			redo_pressed=true;
		}
		else if(mouse_released("right")&&sys_time()-ui_base_undo_tap_time<0.1){
			ui_base_redo_tap_time=ui_base_undo_tap_time=0;
			undo_pressed=true;
		}
	}
	if(undo_pressed){
		history_undo();
	}
	else if(redo_pressed){
		history_redo();
	}
	gizmo_update();
}

void ui_base_update_ui_140380(){
layers_update_fill_layer(true);
			make_material_parse_paint_material(false);
}

void ui_base_render(){
	if(!ui_base_show&&config_raw->touch_ui){
		ui_base_ui->input_enabled=true;
		ui_begin(ui_base_ui);
		if(ui_window(ui_handle("ui_base.ts:1154"),0,0,150,math_floor(ui_ELEMENT_H(ui_base_ui)+ui_ELEMENT_OFFSET(ui_base_ui)+1),false)){
			if(ui_button(tr("Close",null),ui_align_t_CENTER,"")){
				ui_base_toggle_distract_free();
			}
		}
		ui_end(true);
	}
	if(!ui_base_show||iron_window_width()==0||iron_window_height()==0){
		return ;
	}
	ui_base_ui->input_enabled=base_ui_enabled;
	for(i32 i=0;i<ui_base_htabs->length;++i){
		if(ui_base_htabs->buffer[i]->changed){
			config_raw->layout_tabs->buffer[i]=ui_base_htabs->buffer[i]->position;
			config_save();
		}
	}
	for(i32 i=0;i<ui_base_htabs->length;++i){
		ui_base_htabs->buffer[i]->position=config_raw->layout_tabs->buffer[i];
	}
	ui_begin(ui_base_ui);
	ui_toolbar_render_ui();
	ui_menubar_render_ui();
	ui_header_render_ui();
	ui_status_render_ui();
	ui_base_draw_sidebar();
	ui_end(true);
}

void ui_base_draw_sidebar(){
	bool mini=config_raw->layout->buffer[layout_size_t_SIDEBAR_W]<=ui_base_sidebar_mini_w;
	i32 expand_button_offset=config_raw->touch_ui?math_floor(ui_ELEMENT_H(ui_base_ui)+ui_ELEMENT_OFFSET(ui_base_ui)):0;
	ui_base_tabx=iron_window_width()-config_raw->layout->buffer[layout_size_t_SIDEBAR_W];
	i32 _SCROLL_W=ui_base_ui->ops->theme->SCROLL_W;
	if(mini){
		ui_base_ui->ops->theme->SCROLL_W=ui_base_ui->ops->theme->SCROLL_MINI_W;
	}
	if(ui_window(ui_base_hwnds->buffer[tab_area_t_SIDEBAR0],ui_base_tabx,0,config_raw->layout->buffer[layout_size_t_SIDEBAR_W],config_raw->layout->buffer[layout_size_t_SIDEBAR_H0],false)){
		tab_draw_t_array_t * tabs=ui_base_hwnd_tabs->buffer[tab_area_t_SIDEBAR0];
		for(i32 i=0;i<(mini?1:tabs->length);++i){
			tabs->buffer[i]->f(ui_base_htabs->buffer[tab_area_t_SIDEBAR0]);
		}
	}
	if(ui_window(ui_base_hwnds->buffer[tab_area_t_SIDEBAR1],ui_base_tabx,config_raw->layout->buffer[layout_size_t_SIDEBAR_H0],config_raw->layout->buffer[layout_size_t_SIDEBAR_W],config_raw->layout->buffer[layout_size_t_SIDEBAR_H1]-expand_button_offset,false)){
		tab_draw_t_array_t * tabs=ui_base_hwnd_tabs->buffer[tab_area_t_SIDEBAR1];
		for(i32 i=0;i<(mini?1:tabs->length);++i){
			tabs->buffer[i]->f(ui_base_htabs->buffer[tab_area_t_SIDEBAR1]);
		}
	}
	ui_end_window();
	ui_base_ui->ops->theme->SCROLL_W=_SCROLL_W;
	if(config_raw->touch_ui){
		i32 width=config_raw->layout->buffer[layout_size_t_SIDEBAR_W];
		i32 height=math_floor(ui_ELEMENT_H(ui_base_ui)+ui_ELEMENT_OFFSET(ui_base_ui));
		if(ui_window(ui_handle("ui_base.ts:1228"),iron_window_width()-width,iron_window_height()-height,width,height+1,false)){
			ui_base_ui->_w=width;
			i32 _BUTTON_H=ui_base_ui->ops->theme->BUTTON_H;
			i32 _BUTTON_COL=ui_base_ui->ops->theme->BUTTON_COL;
			ui_base_ui->ops->theme->BUTTON_H=ui_base_ui->ops->theme->ELEMENT_H;
			ui_base_ui->ops->theme->BUTTON_COL=ui_base_ui->ops->theme->WINDOW_BG_COL;
			if(ui_button(mini?"<<":">>",ui_align_t_CENTER,"")){
				config_raw->layout->buffer[layout_size_t_SIDEBAR_W]=mini?ui_base_default_sidebar_full_w:ui_base_default_sidebar_mini_w;
				config_raw->layout->buffer[layout_size_t_SIDEBAR_W]=math_floor(config_raw->layout->buffer[layout_size_t_SIDEBAR_W]*ui_SCALE(ui_base_ui));
			}
			ui_base_ui->ops->theme->BUTTON_H=_BUTTON_H;
			ui_base_ui->ops->theme->BUTTON_COL=_BUTTON_COL;
		}
	}
	if(config_raw->layout->buffer[layout_size_t_SIDEBAR_W]==0){
		i32 width=math_floor(draw_string_width(ui_base_ui->ops->font,ui_base_ui->font_size,"<<")+25*ui_SCALE(ui_base_ui));
		if(ui_window(ui_base_hminimized,iron_window_width()-width,0,width,math_floor(ui_ELEMENT_H(ui_base_ui)+ui_ELEMENT_OFFSET(ui_base_ui)+1),false)){
			ui_base_ui->_w=width;
			i32 _BUTTON_H=ui_base_ui->ops->theme->BUTTON_H;
			i32 _BUTTON_COL=ui_base_ui->ops->theme->BUTTON_COL;
			ui_base_ui->ops->theme->BUTTON_H=ui_base_ui->ops->theme->ELEMENT_H;
			ui_base_ui->ops->theme->BUTTON_COL=ui_base_ui->ops->theme->SEPARATOR_COL;
			if(ui_button("<<",ui_align_t_CENTER,"")){
				config_raw->layout->buffer[layout_size_t_SIDEBAR_W]=context_raw->maximized_sidebar_width!=0?context_raw->maximized_sidebar_width:math_floor(ui_base_default_sidebar_w*config_raw->window_scale);
			}
			ui_base_ui->ops->theme->BUTTON_H=_BUTTON_H;
			ui_base_ui->ops->theme->BUTTON_COL=_BUTTON_COL;
		}
	}
	else if(ui_base_htabs->buffer[tab_area_t_SIDEBAR0]->changed&&ui_base_htabs->buffer[tab_area_t_SIDEBAR0]->position==context_raw->last_htab0_pos){
		if(sys_time()-context_raw->select_time<0.25){
			context_raw->maximized_sidebar_width=config_raw->layout->buffer[layout_size_t_SIDEBAR_W];
			config_raw->layout->buffer[layout_size_t_SIDEBAR_W]=0;
		}
		context_raw->select_time=sys_time();
	}
	context_raw->last_htab0_pos=ui_base_htabs->buffer[tab_area_t_SIDEBAR0]->position;
}

void ui_base_render_cursor(){
	if(!base_ui_enabled){
		return ;
	}
	if(context_raw->tool==workspace_tool_t_MATERIAL||context_raw->tool==workspace_tool_t_BAKE){
		return ;
	}
	draw_begin(null,false,0);
	draw_set_color(0xffffffff);
	context_raw->view_index=context_raw->view_index_last;
	i32 mx=base_x()+context_raw->paint_vec.x*base_w();
	i32 my=base_y()+context_raw->paint_vec.y*base_h();
	context_raw->view_index=-1;
	if(context_raw->brush_locked){
		mx+=context_raw->lock_started_x-iron_window_width()/(float)2;
		my+=context_raw->lock_started_y-iron_window_height()/(float)2;
	}
	if(context_raw->brush_stencil_image!=null&&context_raw->tool!=workspace_tool_t_BAKE&&context_raw->tool!=workspace_tool_t_PICKER&&context_raw->tool!=workspace_tool_t_MATERIAL&&context_raw->tool!=workspace_tool_t_COLORID){
		rect_t * r=ui_base_get_brush_stencil_rect();
		if(!operator_shortcut(any_map_get(config_keymap,"stencil_hide"),shortcut_type_t_DOWN)){
			draw_set_color(0x88ffffff);
			f32 angle=context_raw->brush_stencil_angle;
			draw_set_transform(mat3_multmat(mat3_multmat(mat3_translation(0.5,0.5),mat3_rotation(-angle)),mat3_translation(-0.5,-0.5)));
			draw_scaled_image(context_raw->brush_stencil_image,r->x,r->y,r->w,r->h);
			draw_set_transform(mat3_nan());
			draw_set_color(0xffffffff);
		}
		bool transform=operator_shortcut(any_map_get(config_keymap,"stencil_transform"),shortcut_type_t_DOWN);
		if(transform){
			draw_rect(r->x,r->y,r->w,r->h,1.0);
			draw_rect(r->x-8,r->y-8,16,16,1.0);
			draw_rect(r->x-8+r->w,r->y-8,16,16,1.0);
			draw_rect(r->x-8,r->y-8+r->h,16,16,1.0);
			draw_rect(r->x-8+r->w,r->y-8+r->h,16,16,1.0);
			f32 cosa=math_cos(-context_raw->brush_stencil_angle);
			f32 sina=math_sin(-context_raw->brush_stencil_angle);
			f32 ox=0;
			f32 oy=-r->h/(float)2;
			f32 x=ox*cosa-oy*sina;
			f32 y=ox*sina+oy*cosa;
			x+=r->x+r->w/(float)2;
			y+=r->y+r->h/(float)2;
			draw_filled_circle(x,y,8,0);
		}
	}
	if(context_raw->tool==workspace_tool_t_PICKER&&context_raw->picker_select_material&&context_raw->color_picker_callback==null){
		gpu_texture_t * img=context_raw->material->image_icon;
		draw_image(img,mx+10,my+10);
	}
	if(context_raw->tool==workspace_tool_t_PICKER&&context_raw->color_picker_callback!=null){
		gpu_texture_t * img=resource_get("icons.k");
		rect_t * rect=resource_tile50(img,workspace_tool_t_PICKER,0);
		draw_sub_image(img,mx+10,my+10,rect->x,rect->y,rect->w,rect->h);
	}
	gpu_texture_t * cursor_img=resource_get("cursor.k");
	i32 psize=math_floor(182*(context_raw->brush_radius*context_raw->brush_nodes_radius)*ui_SCALE(ui_base_ui));
	if(context_raw->tool==workspace_tool_t_CLONE&&!keyboard_down("alt")&&(mouse_down("left")||pen_down("tip"))){
		draw_set_color(0x66ffffff);
		draw_scaled_image(cursor_img,mx+context_raw->clone_delta_x*sys_w()-psize/(float)2,my+context_raw->clone_delta_y*sys_h()-psize/(float)2,psize,psize);
		draw_set_color(0xffffffff);
	}
	bool decal=context_is_decal();
	if(!config_raw->brush_3d||context_in_2d_view(view_2d_type_t_LAYER)||decal){
		bool decal_mask=context_is_decal_mask();
		if(decal&&!context_in_nodes()){
			f32 decal_alpha=0.5;
			if(!decal_mask){
				context_raw->decal_x=context_raw->paint_vec.x;
				context_raw->decal_y=context_raw->paint_vec.y;
				decal_alpha=context_raw->brush_opacity;
				if(context_raw->brush_locked){
					context_raw->decal_x+=(context_raw->lock_started_x-iron_window_width()/(float)2)/(float)base_w();
					context_raw->decal_y+=(context_raw->lock_started_y-iron_window_height()/(float)2)/(float)base_h();
				}
			}
			if(!config_raw->brush_live){
				i32 psizex=math_floor(256*ui_SCALE(ui_base_ui)*(context_raw->brush_radius*context_raw->brush_nodes_radius*context_raw->brush_scale_x));
				i32 psizey=math_floor(256*ui_SCALE(ui_base_ui)*(context_raw->brush_radius*context_raw->brush_nodes_radius));
				context_raw->view_index=context_raw->view_index_last;
				f32 decalx=base_x()+context_raw->decal_x*base_w()-psizex/(float)2;
				f32 decaly=base_y()+context_raw->decal_y*base_h()-psizey/(float)2;
				context_raw->view_index=-1;
				draw_set_color(color_from_floats(1,1,1,decal_alpha));
				f32 angle=(context_raw->brush_angle+context_raw->brush_nodes_angle)*(math_pi()/(float)180);
				draw_set_transform(mat3_multmat(mat3_multmat(mat3_translation(0.5,0.5),mat3_rotation(angle)),mat3_translation(-0.5,-0.5)));
				draw_scaled_image(context_raw->decal_image,decalx,decaly,psizex,psizey);
				draw_set_transform(mat3_nan());
				draw_set_color(0xffffffff);
			}
		}
		if(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER||context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE||context_raw->tool==workspace_tool_t_PARTICLE||(decal_mask&&!config_raw->brush_3d)||(decal_mask&&context_in_2d_view(view_2d_type_t_LAYER))){
			if(decal_mask){
				psize=math_floor(cursor_img->width*(context_raw->brush_decal_mask_radius*context_raw->brush_nodes_radius)*ui_SCALE(ui_base_ui));
			}
			if(config_raw->brush_3d&&context_in_2d_view(view_2d_type_t_LAYER)){
				psize=math_floor(psize*ui_view2d_pan_scale);
			}
			draw_scaled_image(cursor_img,mx-psize/(float)2,my-psize/(float)2,psize,psize);
		}
	}
	if(context_raw->brush_lazy_radius>0&&!context_raw->brush_locked&&(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER||context_raw->tool==workspace_tool_t_DECAL||context_raw->tool==workspace_tool_t_TEXT||context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE||context_raw->tool==workspace_tool_t_PARTICLE)){
		draw_filled_rect(mx-1,my-1,2,2);
		mx=context_raw->brush_lazy_x*base_w()+base_x();
		my=context_raw->brush_lazy_y*base_h()+base_y();
		f32 radius=context_raw->brush_lazy_radius*180;
		draw_set_color(0xff666666);
		draw_scaled_image(cursor_img,mx-radius/(float)2,my-radius/(float)2,radius,radius);
		draw_set_color(0xffffffff);
	}
	draw_end();
}

void ui_base_show_material_nodes(){
	_ui_end_input(ui_nodes_ui);
	ui_nodes_show=!ui_nodes_show||ui_nodes_canvas_type!=canvas_type_t_MATERIAL;
	ui_nodes_canvas_type=canvas_type_t_MATERIAL;
	base_resize();
}

void ui_base_show_brush_nodes(){
	_ui_end_input(ui_nodes_ui);
	ui_nodes_show=!ui_nodes_show||ui_nodes_canvas_type!=canvas_type_t_BRUSH;
	ui_nodes_canvas_type=canvas_type_t_BRUSH;
	base_resize();
}

void ui_base_show_2d_view(view_2d_type_t type){
	_ui_end_input(ui_view2d_ui);
	if(ui_view2d_type!=type){
		ui_view2d_show=true;
	}
	else {
		ui_view2d_show=!ui_view2d_show;
	}
	ui_view2d_type=type;
	ui_view2d_hwnd->redraws=2;
	base_resize();
}

void ui_base_toggle_browser(){
	bool minimized=config_raw->layout->buffer[layout_size_t_STATUS_H]<=(ui_status_default_status_h*config_raw->window_scale);
	config_raw->layout->buffer[layout_size_t_STATUS_H]=minimized?240:ui_status_default_status_h;
	config_raw->layout->buffer[layout_size_t_STATUS_H]=math_floor(config_raw->layout->buffer[layout_size_t_STATUS_H]*config_raw->window_scale);
}

void ui_base_set_icon_scale(){
	if(ui_SCALE(ui_base_ui)>1){
		string_t_array_t * res=any_array_create_from_raw((any[]){"icons2x.k",},1);
		resource_load(res);
		any_map_set(resource_bundled,"icons.k",resource_get("icons2x.k"));
	}
	else {
		string_t_array_t * res=any_array_create_from_raw((any[]){"icons.k",},1);
		resource_load(res);
	}
}

void ui_base_on_border_hover(ui_handle_t * handle,i32 side){
	if(!base_ui_enabled)return ;
	if(handle!=ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]&&handle!=ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]&&handle!=ui_base_hwnds->buffer[tab_area_t_STATUS]&&handle!=ui_nodes_hwnd&&handle!=ui_view2d_hwnd){
		return ;
	}
	if(handle==ui_view2d_hwnd&&side!=border_side_t_LEFT){
		return ;
	}
	if(handle==ui_nodes_hwnd&&side==border_side_t_TOP&&!ui_view2d_show){
		return ;
	}
	if(handle==ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]&&side==border_side_t_TOP){
		return ;
	}
	if(handle==ui_nodes_hwnd&&side!=border_side_t_LEFT&&side!=border_side_t_TOP){
		return ;
	}
	if(handle==ui_base_hwnds->buffer[tab_area_t_STATUS]&&side!=border_side_t_TOP){
		return ;
	}
	if(side==border_side_t_RIGHT){
		return ;
	}
	side==border_side_t_LEFT||side==border_side_t_RIGHT?iron_set_mouse_cursor(3):iron_set_mouse_cursor(4);
	if(ui_get_current()->input_started){
		ui_base_border_started=side;
		gc_unroot(ui_base_border_handle);ui_base_border_handle=handle;gc_root(ui_base_border_handle);
		base_is_resizing=true;
	}
}

void ui_base_on_text_hover(){
	iron_set_mouse_cursor(2);
}

void ui_base_on_deselect_text(){
}

void ui_base_on_tab_drop(ui_handle_t * to,i32 to_position,ui_handle_t * from,i32 from_position){
	i32 i=-1;
	i32 j=-1;
	for(i32 k=0;k<ui_base_htabs->length;++k){
		if(ui_base_htabs->buffer[k]==to){
			i=k;
		}
		if(ui_base_htabs->buffer[k]==from){
			j=k;
		}
	}
	if(i==j&&to_position==from_position){
		return ;
	}
	if(i>-1&&j>-1){
		tab_draw_t_array_t * tabsi=ui_base_hwnd_tabs->buffer[i];
		tab_draw_t_array_t * tabsj=ui_base_hwnd_tabs->buffer[j];
		tab_draw_t * element=tabsj->buffer[from_position];
		array_splice(tabsj,from_position,1);
		array_insert(tabsi,to_position,element);
		ui_base_hwnds->buffer[i]->redraws=2;
		ui_base_hwnds->buffer[j]->redraws=2;
	}
}

void ui_base_tag_ui_redraw(){
	ui_header_handle->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=2;
	ui_menubar_workspace_handle->redraws=2;
	ui_menubar_menu_handle->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
	ui_toolbar_handle->redraws=2;
}

void ui_base_make_empty_envmap(i32 col){
	ui_base_viewport_col=col;
	u8_array_t * b=u8_array_create(4);
	b->buffer[0]=color_get_rb(col);
	b->buffer[1]=color_get_gb(col);
	b->buffer[2]=color_get_bb(col);
	b->buffer[3]=255;
	context_raw->empty_envmap=gpu_create_texture_from_bytes(b,1,1,tex_format_t_RGBA32);
}

void ui_base_set_viewport_col(i32 col){
	ui_base_make_empty_envmap(col);
	context_raw->ddirty=2;
	if(!context_raw->show_envmap){
		scene_world->_->envmap=context_raw->empty_envmap;
	}
}

void ui_box_init(){
	ui_box_hwnd->redraws=2;
	ui_box_hwnd->drag_x=0;
	ui_box_hwnd->drag_y=0;
	ui_box_show=true;
	ui_box_draws=0;
	ui_box_click_to_hide=true;
}

void ui_box_render(){
	if(!ui_menu_show){
		ui_t * ui=base_ui_box;
		bool in_use=ui->combo_selected_handle!=null;
		bool is_escape=keyboard_started("escape");
		if(ui_box_draws>2&&(ui->input_released||is_escape)&&!in_use&&!ui->is_typing){
			i32 appw=iron_window_width();
			i32 apph=iron_window_height();
			i32 mw=math_floor(ui_box_modalw*ui_SCALE(ui));
			i32 mh=math_floor(ui_box_modalh*ui_SCALE(ui));
			f32 left=(appw/(float)2-mw/(float)2)+ui_box_hwnd->drag_x;
			f32 right=(appw/(float)2+mw/(float)2)+ui_box_hwnd->drag_x;
			f32 top=(apph/(float)2-mh/(float)2)+ui_box_hwnd->drag_y;
			f32 bottom=(apph/(float)2+mh/(float)2)+ui_box_hwnd->drag_y;
			i32 mx=mouse_x;
			i32 my=mouse_y;
			if((ui_box_click_to_hide&&(mx<left||mx>right||my<top||my>bottom))||is_escape){
				ui_box_hide();
			}
		}
	}
	if(config_raw->touch_ui){
		draw_begin(null,false,0);
		draw_set_color(color_from_floats(0,0,0,0.5));
		draw_filled_rect(0,0,iron_window_width(),iron_window_height());
		draw_end();
	}
	ui_t * ui=base_ui_box;
	i32 appw=iron_window_width();
	i32 apph=iron_window_height();
	i32 mw=math_floor(ui_box_modalw*ui_SCALE(ui));
	i32 mh=math_floor(ui_box_modalh*ui_SCALE(ui));
	if(mw>appw){
		mw=appw;
	}
	if(mh>apph){
		mh=apph;
	}
	i32 left=math_floor(appw/(float)2-mw/(float)2);
	i32 top=math_floor(apph/(float)2-mh/(float)2);
	if(ui_box_commands==null){
		ui_begin(ui);
		if(ui_window(ui_box_hwnd,left,top,mw,mh,ui_box_draggable)){
			ui->_y+=10;
			bool tab_vertical=config_raw->touch_ui;
			if(ui_tab(ui_handle("ui_box.ts:76"),ui_box_title,tab_vertical,-1)){
				ui_handle_t * htext=ui_handle("ui_box.ts:77");
				htext->text=string_copy(ui_box_text);
				if(ui_box_copyable){
					ui_text_area(htext,ui_align_t_LEFT,false,"",false);
				}
				else {
					ui_text(ui_box_text,ui_align_t_LEFT,0x00000000);
				}
				_ui_end_element(-1.0);
				if(ui_box_copyable){
					ui_row3();
				}
				else {
					f32_array_t * row=f32_array_create_from_raw((f32[]){2/(float)3,1/(float)3,},2);
					ui_row(row);
				}
				_ui_end_element(-1.0);
				if(ui_box_copyable&&ui_button(tr("Copy",null),ui_align_t_CENTER,"")){
					iron_copy_to_clipboard(ui_box_text);
				}
				if(ui_button(tr("OK",null),ui_align_t_CENTER,"")){
					ui_box_hide();
				}
			}
			ui_box_window_border(ui);
		}
		ui_end(true);
	}
	else {
		ui_begin(ui);
		if(ui_window(ui_box_hwnd,left,top,mw,mh,ui_box_draggable)){
			ui->_y+=10;
			ui_box_commands(ui);
			ui_box_window_border(ui);
		}
		ui_end(true);
	}
	ui_box_draws++;
}

void ui_box_show_message(string_t * title,string_t * text,bool copyable){
	ui_box_init();
	ui_box_modalw=400;
	ui_box_modalh=210;
	gc_unroot(ui_box_title);ui_box_title=string_copy(title);gc_root(ui_box_title);
	gc_unroot(ui_box_text);ui_box_text=string_copy(text);gc_root(ui_box_text);
	gc_unroot(ui_box_commands);ui_box_commands=null;
	ui_box_copyable=copyable;
	ui_box_draggable=true;
}

void ui_box_show_custom(void(*commands)(ui_t *),i32 mw,i32 mh,void(*on_hide)(void),bool draggable){
	ui_box_init();
	ui_box_modalw=mw;
	ui_box_modalh=mh;
	gc_unroot(ui_box_modal_on_hide);ui_box_modal_on_hide=on_hide;gc_root(ui_box_modal_on_hide);
	gc_unroot(ui_box_commands);ui_box_commands=commands;gc_root(ui_box_commands);
	ui_box_draggable=draggable;
}

void ui_box_hide(){
	ui_box_hide_internal();
}

void ui_box_hide_internal(){
	if(ui_box_modal_on_hide!=null){
		ui_box_modal_on_hide();
	}
	ui_box_show=false;
	base_redraw_ui();
}

void ui_box_tween_in(){
	tween_reset();
	tween_anim_t * a=GC_ALLOC_INIT(tween_anim_t, {.target=ADDRESS(ui_box_tween_alpha),.to=0.5,.duration=0.2,.ease=ease_t_EXPO_OUT});
	tween_to(a);
	ui_box_hwnd->drag_y=math_floor(iron_window_height()/(float)2);
	a=GC_ALLOC_INIT(tween_anim_t, {.target=ADDRESS(ui_box_hwnd->drag_y),.to=0.0,.duration=0.2,.ease=ease_t_EXPO_OUT,.tick=ui_box_tween_tick});
	tween_to(a);
}

void ui_box_tween_out(){
	tween_anim_t * a=GC_ALLOC_INIT(tween_anim_t, {.target=ADDRESS(ui_box_tween_alpha),.to=0.0,.duration=0.2,.ease=ease_t_EXPO_IN,.done=ui_box_hide_internal});
	tween_to(a);
	a=GC_ALLOC_INIT(tween_anim_t, {.target=ADDRESS(ui_box_hwnd->drag_y),.to=iron_window_height()/2,.duration=0.2,.ease=ease_t_EXPO_IN});
	tween_to(a);
}

void ui_box_tween_tick(){
	base_redraw_ui();
}

void ui_box_window_border(ui_t * ui){
	if(ui->scissor){
		ui->scissor=false;
		gpu_disable_scissor();
	}
	draw_set_color(ui->ops->theme->SEPARATOR_COL);
	draw_filled_rect(0,0,1,ui->_window_h);
	draw_filled_rect(0+ui->_window_w-1,0,1,ui->_window_h);
	draw_filled_rect(0,0+ui->_window_h-1,ui->_window_w,1);
}

void ui_files_show(string_t * filters,bool is_save,bool open_multiple,void(*files_done)(string_t *)){
	if(is_save){
		gc_unroot(ui_files_path);ui_files_path=string_copy(iron_save_dialog(filters,""));gc_root(ui_files_path);
		if(ui_files_path!=null){
			string_t * sep2=string_join(path_sep,path_sep);
			while(string_index_of(ui_files_path,sep2)>=0){
				gc_unroot(ui_files_path);ui_files_path=string_copy(string_replace_all(ui_files_path,sep2,path_sep));gc_root(ui_files_path);
			}
			gc_unroot(ui_files_path);ui_files_path=string_copy(string_replace_all(ui_files_path,"\r",""));gc_root(ui_files_path);
			gc_unroot(ui_files_filename);ui_files_filename=string_copy(substring(ui_files_path,string_last_index_of(ui_files_path,path_sep)+1,string_length(ui_files_path)));gc_root(ui_files_filename);
			gc_unroot(ui_files_path);ui_files_path=string_copy(substring(ui_files_path,0,string_last_index_of(ui_files_path,path_sep)));gc_root(ui_files_path);
			files_done(ui_files_path);
		}
	}
	else {
		string_t_array_t * paths=iron_open_dialog(filters,"",open_multiple);
		if(paths!=null){
			for(i32 i=0;i<paths->length;++i){
				string_t * path=paths->buffer[i];
				string_t * sep2=string_join(path_sep,path_sep);
				while(string_index_of(path,sep2)>=0){
					path=string_copy(string_replace_all(path,sep2,path_sep));
				}
				path=string_copy(string_replace_all(path,"\r",""));
				gc_unroot(ui_files_filename);ui_files_filename=string_copy(substring(path,string_last_index_of(path,path_sep)+1,string_length(path)));gc_root(ui_files_filename);
				files_done(path);
			}
		}
	}
	ui_files_release_keys();
}

void ui_files_release_keys(){
	keyboard_up_listener(key_code_t_SHIFT);
	keyboard_up_listener(key_code_t_CONTROL);
}

draw_cloud_icon_data_t * make_draw_cloud_icon_data(string_t * f,gpu_texture_t * image){
	draw_cloud_icon_data_t * data=GC_ALLOC_INIT(draw_cloud_icon_data_t, {.f=f,.image=image});
	return data;
}

string_t * ui_files_file_browser(ui_t * ui,ui_handle_t * handle,bool drag_files,string_t * search,bool refresh,void(*context_menu)(string_t *)){
	gpu_texture_t * icons=resource_get("icons.k");
	rect_t * folder=resource_tile50(icons,2,1);
	rect_t * file=resource_tile50(icons,3,1);
	bool is_cloud=starts_with(handle->text,"cloud");
	if(is_cloud&&file_cloud==null){
		file_init_cloud(&ui_files_file_browser_145055		);
	}
	if(is_cloud&&file_read_directory("cloud")->length==0){
		return handle->text;
	}
	if(string_equals(handle->text,"")){
		handle->text=string_copy(ui_files_default_path);
	}
	if(!string_equals(handle->text,ui_files_last_path)||!string_equals(search,ui_files_last_search)||refresh){
		gc_unroot(ui_files_files);ui_files_files=any_array_create_from_raw((any[]){},0);gc_root(ui_files_files);
		string_t * dir_path=handle->text;
		string_t_array_t * files_all=file_read_directory(dir_path);
		for(i32 i=0;i<files_all->length;++i){
			string_t * f=files_all->buffer[i];
			if(string_equals(f,"")||string_equals(char_at(f,0),".")){
				continue;
			}
			if(string_index_of(f,".")>0&&!path_is_known(f)){
				continue;
			}
			if(is_cloud&&string_index_of(f,"_icon.")>=0){
				continue;
			}
			if(string_index_of(to_lower_case(f),to_lower_case(search))<0){
				continue;
			}
			any_array_push(ui_files_files,f);
		}
	}
	gc_unroot(ui_files_last_path);ui_files_last_path=string_copy(handle->text);gc_root(ui_files_last_path);
	gc_unroot(ui_files_last_search);ui_files_last_search=string_copy(search);gc_root(ui_files_last_search);
	handle->changed=false;
	i32 slotw=math_floor(70*ui_SCALE(ui));
	i32 num=math_floor(ui->_w/(float)slotw);
	if(num==0){
		return handle->text;
	}
	ui->_y+=4;
	for(i32 row=0;row<math_floor(math_ceil(ui_files_files->length/(float)num));++row){
		f32_array_t * ar=f32_array_create_from_raw((f32[]){},0);
		for(i32 i=0;i<num*2;++i){
			f32_array_push(ar,1/(float)num);
		}
		ui_row(ar);
		if(row>0){
			ui->_y+=ui_ELEMENT_OFFSET(ui)*14.0;
		}
		for(i32 j=0;j<num;++j){
			i32 i=j+row*num;
			if(i>=ui_files_files->length){
				_ui_end_element(slotw);
				_ui_end_element(slotw);
				continue;
			}
			string_t * f=ui_files_files->buffer[i];
			f32 _x=ui->_x;
			rect_t * rect=string_index_of(f,".")>0?file:folder;
			i32 col=rect==file?ui->ops->theme->LABEL_COL:ui->ops->theme->LABEL_COL-0x00202020;
			if(ui_files_selected==i)col=ui->ops->theme->HIGHLIGHT_COL;
			f32 off=ui->_w/(float)2-25*ui_SCALE(ui);
			ui->_x+=off;
			f32 uix=ui->_x;
			f32 uiy=ui->_y;
			ui_state_t state=ui_state_t_IDLE;
			bool generic=true;
			gpu_texture_t * icon=null;
			if(is_cloud&&!string_equals(f,"..")&&!ui_files_offline){
				if(ui_files_icon_map==null){
					gc_unroot(ui_files_icon_map);ui_files_icon_map=any_map_create();gc_root(ui_files_icon_map);
					gc_unroot(ui_files_icon_file_map);ui_files_icon_file_map=any_map_create();gc_root(ui_files_icon_file_map);
				}
				icon=any_map_get(ui_files_icon_map,string_join(string_join(handle->text,path_sep),f));
				if(icon==null){
					i32 dot=string_last_index_of(f,".");
					if(dot>-1){
						string_t_array_t * files_all=file_read_directory(handle->text);
						string_t * icon_file=string_join(substring(f,0,dot),"_icon.jpg");
						if(char_ptr_array_index_of(files_all,icon_file)>=0){
							render_target_t * rt=any_map_get(render_path_render_targets,"empty_black");
							gpu_texture_t * empty=rt->_image;
							any_map_set(ui_files_icon_map,string_join(string_join(handle->text,path_sep),f),empty);
							gc_unroot(_ui_files_file_browser_handle);_ui_files_file_browser_handle=handle;gc_root(_ui_files_file_browser_handle);
							any_map_set(ui_files_icon_file_map,icon_file,f);
							file_cache_cloud(string_join(string_join(handle->text,path_sep),icon_file),&ui_files_file_browser_145717							);
						}
					}
				}
				if(icon!=null){
					i32 w=50;
					if(i==ui_files_selected){
						ui_fill(-2,-2,w+4,2,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(-2,w+2,w+4,2,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(-2,0,2,w+4,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(w+2,-2,2,w+6,ui->ops->theme->HIGHLIGHT_COL);
					}
					state=_ui_image(icon,0xffffffff,w*ui_SCALE(ui),0,0,0,0);
					if(ui->is_hovered){
						ui_tooltip_image(icon,0);
						ui_tooltip(f);
					}
					generic=false;
				}
			}
			if(ends_with(f,".arm")&&!is_cloud){
				if(ui_files_icon_map==null){
					gc_unroot(ui_files_icon_map);ui_files_icon_map=any_map_create();gc_root(ui_files_icon_map);
				}
				string_t * key=string_join(string_join(handle->text,path_sep),f);
				icon=any_map_get(ui_files_icon_map,key);
				if(any_map_get(ui_files_icon_map,key)==null){
					string_t * blob_path=key;
					buffer_t * buffer=iron_load_blob(blob_path);
					project_format_t * raw=armpack_decode(buffer);
					if(raw->material_icons!=null){
						any bytes_icon=raw->material_icons->buffer[0];
						icon=gpu_create_texture_from_bytes(lz4_decode(bytes_icon,256*256*4),256,256,tex_format_t_RGBA32);
					}
					else if(raw->mesh_icons!=null){
						any bytes_icon=raw->mesh_icons->buffer[0];
						icon=gpu_create_texture_from_bytes(lz4_decode(bytes_icon,256*256*4),256,256,tex_format_t_RGBA32);
					}
					else if(raw->brush_icons!=null){
						any bytes_icon=raw->brush_icons->buffer[0];
						icon=gpu_create_texture_from_bytes(lz4_decode(bytes_icon,256*256*4),256,256,tex_format_t_RGBA32);
					}
					any_map_set(ui_files_icon_map,key,icon);
				}
				if(icon!=null){
					i32 w=50;
					if(i==ui_files_selected){
						ui_fill(-2,-2,w+4,2,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(-2,w+2,w+4,2,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(-2,0,2,w+4,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(w+2,-2,2,w+6,ui->ops->theme->HIGHLIGHT_COL);
					}
					state=_ui_image(icon,0xffffffff,w*ui_SCALE(ui),0,0,0,0);
					if(ui->is_hovered){
						ui_tooltip_image(icon,0);
						ui_tooltip(f);
					}
					generic=false;
				}
			}
			if(path_is_texture(f)&&!is_cloud){
				i32 w=50;
				if(ui_files_icon_map==null){
					gc_unroot(ui_files_icon_map);ui_files_icon_map=any_map_create();gc_root(ui_files_icon_map);
				}
				string_t * shandle=string_join(string_join(handle->text,path_sep),f);
				icon=any_map_get(ui_files_icon_map,shandle);
				if(icon==null){
					render_target_t * rt=any_map_get(render_path_render_targets,"empty_black");
					gpu_texture_t * empty=rt->_image;
					any_map_set(ui_files_icon_map,shandle,empty);
					gpu_texture_t * image=data_get_image(shandle);
					ui_files_make_icon_t * args=GC_ALLOC_INIT(ui_files_make_icon_t, {.image=image,.shandle=shandle,.w=w});
					sys_notify_on_init(ui_files_make_icon,args);
				}
				if(icon!=null){
					if(i==ui_files_selected){
						ui_fill(-2,-2,w+4,2,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(-2,w+2,w+4,2,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(-2,0,2,w+4,ui->ops->theme->HIGHLIGHT_COL);
						ui_fill(w+2,-2,2,w+6,ui->ops->theme->HIGHLIGHT_COL);
					}
					state=_ui_image(icon,0xffffffff,icon->height*ui_SCALE(ui),0,0,0,0);
					generic=false;
				}
			}
			if(generic){
				state=_ui_image(icons,col,50*ui_SCALE(ui),rect->x,rect->y,rect->w,rect->h);
			}
			if(ui->is_hovered&&ui->input_released_r&&context_menu!=null){
				context_menu(string_join(string_join(handle->text,path_sep),f));
			}
			if(state==ui_state_t_STARTED){
				if(!string_equals(f,"..")&&drag_files){
					base_drag_off_x=-(mouse_x-uix-ui->_window_x-3);
					base_drag_off_y=-(mouse_y-uiy-ui->_window_y+1);
					gc_unroot(base_drag_file);base_drag_file=string_copy(handle->text);gc_root(base_drag_file);
					if(!string_equals(char_at(base_drag_file,string_length(base_drag_file)-1),path_sep)){
						gc_unroot(base_drag_file);base_drag_file=string_join(base_drag_file,path_sep);gc_root(base_drag_file);
					}
					gc_unroot(base_drag_file);base_drag_file=string_join(base_drag_file,f);gc_root(base_drag_file);
					gc_unroot(base_drag_file_icon);base_drag_file_icon=icon;gc_root(base_drag_file_icon);
				}
				ui_files_selected=i;
				if(sys_time()-context_raw->select_time<0.25){
					gc_unroot(base_drag_file);base_drag_file=null;
					gc_unroot(base_drag_file_icon);base_drag_file_icon=null;
					base_is_dragging=false;
					handle->changed=ui->changed=true;
					if(string_equals(f,"..")){
						handle->text=string_copy(substring(handle->text,0,string_last_index_of(handle->text,path_sep)));
						if(string_length(handle->text)==2&&string_equals(char_at(handle->text,1),":")){
							handle->text=string_join(handle->text,path_sep);
						}
					}
					else {
						if(!string_equals(char_at(handle->text,string_length(handle->text)-1),path_sep)){
							handle->text=string_join(handle->text,path_sep);
						}
						handle->text=string_join(handle->text,f);
					}
					ui_files_selected=-1;
				}
				context_raw->select_time=sys_time();
			}
			ui->_x=_x;
			ui->_y+=slotw*0.75;
			string_t * label0=(ui_files_show_extensions||string_index_of(f,".")<=0)?f:substring(f,0,string_last_index_of(f,"."));
			string_t * label1="";
			while(string_length(label0)>0&&draw_string_width(ui->ops->font,ui->font_size,label0)>ui->_w-6){
				label1=string_join(char_at(label0,string_length(label0)-1),label1);
				label0=string_copy(substring(label0,0,string_length(label0)-1));
			}
			if(!string_equals(label1,"")){
				ui->current_ratio--;
			}
			ui_text(label0,ui_align_t_CENTER,0x00000000);
			if(ui->is_hovered){
				ui_tooltip(string_join(label0,label1));
			}
			if(!string_equals(label1,"")){
				ui->_x=_x;
				ui->_y+=draw_font_height(ui->ops->font,ui->font_size);
				ui_text(label1,ui_align_t_CENTER,0x00000000);
				if(ui->is_hovered){
					ui_tooltip(string_join(label0,label1));
				}
				ui->_y-=draw_font_height(ui->ops->font,ui->font_size);
			}
			ui->_y-=slotw*0.75;
			if(handle->changed){
				break;
			}
		}
		if(handle->changed){
			break;
		}
	}
	ui->_y+=slotw*0.8;
	return handle->text;
}

void ui_files_file_browser_145799(draw_cloud_icon_data_t * data){
gpu_texture_t * icon=gpu_create_render_target(data->image->width,data->image->height,tex_format_t_RGBA32);
								if(ends_with(data->f,".arm")){
									draw_begin(icon,false,0);
									draw_image(project_materials->buffer[0]->image,0,0);
								}
								else {
									draw_begin(icon,true,0xffffffff);
								}
								draw_set_pipeline(pipes_copy_rgb);
								draw_image(data->image,0,0);
								draw_set_pipeline(null);
								draw_end();
								any_map_set(ui_files_icon_map,string_join(string_join(_ui_files_file_browser_handle->text,path_sep),data->f),icon);
								ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=3;
}

void ui_files_file_browser_145717(string_t * abs){
if(abs!=null){
								gpu_texture_t * image=data_get_image(abs);
								abs=string_copy(string_replace_all(abs,"\\","/"));
								string_t * icon_file=substring(abs,string_last_index_of(abs,"/")+1,string_length(abs));
								string_t * f=any_map_get(ui_files_icon_file_map,icon_file);
								draw_cloud_icon_data_t * data=make_draw_cloud_icon_data(f,image);
								sys_notify_on_init(&ui_files_file_browser_145799								,data);
							}
							else {
								ui_files_offline=true;
							}
}

void ui_files_file_browser_145055(){
ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=3;
}

void ui_files_make_icon(ui_files_make_icon_t * args){
	i32 w=args->w;
	gpu_texture_t * image=args->image;
	i32 sw=image->width>image->height?w:math_floor(1.0*image->width/(float)image->height*w);
	i32 sh=image->width>image->height?math_floor(1.0*image->height/(float)image->width*w):w;
	gpu_texture_t * icon=gpu_create_render_target(sw,sh,tex_format_t_RGBA32);
	draw_begin(icon,true,0xffffffff);
	draw_set_pipeline(pipes_copy_rgb);
	draw_scaled_image(image,0,0,sw,sh);
	draw_set_pipeline(null);
	draw_end();
	any_map_set(ui_files_icon_map,args->shandle,icon);
	ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=3;
	data_delete_image(args->shandle);
}

void ui_files_go_up(ui_handle_t * handle){
	handle->text=string_copy(substring(handle->text,0,string_last_index_of(handle->text,path_sep)));
	if(string_length(handle->text)==2&&string_equals(char_at(handle->text,1),":")){
		handle->text=string_join(handle->text,path_sep);
	}
}

void ui_header_init(){
	ui_header_handle->layout=ui_layout_t_HORIZONTAL;
}

void ui_header_render_ui(){
	ui_t * ui=ui_base_ui;
	if(config_raw->touch_ui){
		ui_header_h=ui_header_default_h+6;
	}
	else {
		ui_header_h=ui_header_default_h;
	}
	ui_header_h=math_floor(ui_header_h*ui_SCALE(ui));
	if(config_raw->layout->buffer[layout_size_t_HEADER]==0){
		return ;
	}
	i32 nodesw=(ui_nodes_show||ui_view2d_show)?config_raw->layout->buffer[layout_size_t_NODES_W]:0;
	i32 ww=iron_window_width()-ui_toolbar_w(true)-config_raw->layout->buffer[layout_size_t_SIDEBAR_W]-nodesw;
	if(ui_window(ui_header_handle,sys_x(),ui_header_h,ww,ui_header_h,false)){
		ui->_y+=2;
		ui_header_draw_tool_properties(ui);
	}
}

void ui_menu_render(){
	ui_t * ui=base_ui_menu;
	i32 menu_w=ui_menu_commands!=null?math_floor(base_default_element_w*ui_SCALE(base_ui_menu)*2.3):math_floor(ui_ELEMENT_W(ui)*2.3);
	i32 _FILL_BUTTON_BG=ui->ops->theme->FILL_BUTTON_BG;
	ui->ops->theme->FILL_BUTTON_BG=false;
	i32 _ELEMENT_OFFSET=ui->ops->theme->ELEMENT_OFFSET;
	ui->ops->theme->ELEMENT_OFFSET=0;
	i32 _ELEMENT_H=ui->ops->theme->ELEMENT_H;
	ui->ops->theme->ELEMENT_H=config_raw->touch_ui?(28+2):28;
	if(ui_menu_show_first){
		ui_menu_x-=iron_window_width()*2;
		ui_menu_y-=iron_window_height()*2;
	}
	draw_begin(null,false,0);
	ui_begin_region(ui,ui_menu_x,ui_menu_y,menu_w);
	ui_menu_start(ui);
	if(ui_menu_commands!=null){
		ui_menu_commands(ui);
	}
	else {
		if(ui_menu_category==menu_category_t_FILE){
			if(ui_menu_button(tr("New Project...",null),any_map_get(config_keymap,"file_new"))){
				project_new_box();
			}
			if(ui_menu_button(tr("Open...",null),any_map_get(config_keymap,"file_open"))){
				project_open();
			}
			if(ui_menu_button(tr("Open Recent...",null),any_map_get(config_keymap,"file_open_recent"))){
				box_projects_show();
			}
			if(ui_menu_button(tr("Save",null),any_map_get(config_keymap,"file_save"))){
				project_save(false);
			}
			if(ui_menu_button(tr("Save As...",null),any_map_get(config_keymap,"file_save_as"))){
				project_save_as(false);
			}
			ui_menu_separator(ui);
			if(ui_menu_button(tr("Import Texture...",null),any_map_get(config_keymap,"file_import_assets"))){
				project_import_asset(string_array_join(path_texture_formats,","),false);
			}
			if(ui_menu_button(tr("Import Envmap...",null),"")){
				ui_files_show("hdr",false,false,&ui_menu_render_147841				);
			}
			if(ui_menu_button(tr("Import Font...",null),"")){
				project_import_asset("ttf,ttc,otf",true);
			}
			if(ui_menu_button(tr("Import Material...",null),"")){
				project_import_material();
			}
			if(ui_menu_button(tr("Import Brush...",null),"")){
				project_import_brush();
			}
			if(ui_menu_button(tr("Import Swatches...",null),"")){
				project_import_swatches(false);
			}
			if(ui_menu_button(tr("Import Mesh...",null),"")){
				project_import_mesh(true,null);
			}
			if(ui_menu_button(tr("Reimport Mesh",null),any_map_get(config_keymap,"file_reimport_mesh"))){
				project_reimport_mesh();
			}
			if(ui_menu_button(tr("Reimport Textures",null),any_map_get(config_keymap,"file_reimport_textures"))){
				project_reimport_textures();
			}
			ui_menu_separator(ui);
			if(ui_menu_button(tr("Export Textures...",null),any_map_get(config_keymap,"file_export_textures_as"))){
				context_raw->layers_export=export_mode_t_VISIBLE;
				box_export_show_textures();
			}
			if(ui_menu_button(tr("Export Swatches...",null),"")){
				project_export_swatches();
			}
			if(ui_menu_button(tr("Export Mesh...",null),"")){
				context_raw->export_mesh_index=0;
				box_export_show_mesh();
			}
			if(ui_menu_button(tr("Bake Material...",null),"")){
				box_export_show_bake_material();
			}
			ui_menu_separator(ui);
			if(ui_menu_button(tr("Exit",null),"")){
				iron_stop();
			}
		}
		else if(ui_menu_category==menu_category_t_EDIT){
			string_t * step_undo="";
			string_t * step_redo="";
			if(history_undos>0){
				step_undo=string_copy(history_steps->buffer[history_steps->length-1-history_redos]->name);
			}
			if(history_redos>0){
				step_redo=string_copy(history_steps->buffer[history_steps->length-history_redos]->name);
			}
			ui->enabled=history_undos>0;
			any_map_t * vars_undo=any_map_create();
			any_map_set(vars_undo,"step",step_undo);
			if(ui_menu_button(tr("Undo {step}",vars_undo),any_map_get(config_keymap,"edit_undo"))){
				history_undo();
			}
			ui->enabled=history_redos>0;
			any_map_t * vars_redo=any_map_create();
			any_map_set(vars_redo,"step",step_redo);
			if(ui_menu_button(tr("Redo {step}",vars_redo),any_map_get(config_keymap,"edit_redo"))){
				history_redo();
			}
			ui->enabled=true;
			ui_menu_separator(ui);
			if(ui_menu_button(tr("Preferences...",null),any_map_get(config_keymap,"edit_prefs"))){
				box_preferences_show();
			}
		}
		else if(ui_menu_category==menu_category_t_VIEWPORT){
			if(ui_menu_button(tr("Distract Free",null),any_map_get(config_keymap,"view_distract_free"))){
				ui_base_toggle_distract_free();
				ui_base_ui->is_hovered=false;
			}
			if(ui_menu_button(tr("Toggle Fullscreen",null),"alt+enter")){
				base_toggle_fullscreen();
			}
			ui->changed=false;
			world_data_t * p=scene_world;
			ui_handle_t * env_handle=ui_handle("ui_menu.ts:172");
			env_handle->value=p->strength;
			ui_menu_align(ui);
			p->strength=ui_slider(env_handle,tr("Environment",null),0.0,8.0,true,100.0,true,ui_align_t_RIGHT,true);
			if(env_handle->changed){
				context_raw->ddirty=2;
			}
			ui_handle_t * enva_handle=ui_handle("ui_menu.ts:180");
			enva_handle->value=context_raw->envmap_angle/(float)math_pi()*180.0;
			if(enva_handle->value<0){
				enva_handle->value+=(math_floor(-enva_handle->value/(float)360)+1)*360;
			}
			else if(enva_handle->value>360){
				enva_handle->value-=math_floor(enva_handle->value/(float)360)*360;
			}
			ui_menu_align(ui);
			context_raw->envmap_angle=ui_slider(enva_handle,tr("Environment Angle",null),0.0,360.0,true,1,true,ui_align_t_RIGHT,true)/(float)180.0*math_pi();
			if(ui->is_hovered){
				any_map_t * vars=any_map_create();
				any_map_set(vars,"shortcut",any_map_get(config_keymap,"rotate_envmap"));
				ui_tooltip(tr("{shortcut} and move mouse",vars));
			}
			if(enva_handle->changed){
				context_raw->ddirty=2;
			}
			ui_handle_t * split_view_handle=ui_handle("ui_menu.ts:200");
			if(split_view_handle->init){
				split_view_handle->selected=context_raw->split_view;
			}
			context_raw->split_view=ui_check(split_view_handle,string_join(" ",tr("Split View",null)),"");
			if(split_view_handle->changed){
				base_resize();
			}
			ui_handle_t * cull_handle=ui_handle("ui_menu.ts:224");
			if(cull_handle->init){
				cull_handle->selected=context_raw->cull_backfaces;
			}
			context_raw->cull_backfaces=ui_check(cull_handle,string_join(" ",tr("Cull Backfaces",null)),"");
			if(cull_handle->changed){
				make_material_parse_mesh_material();
			}
			ui_handle_t * filter_handle=ui_handle("ui_menu.ts:233");
			if(filter_handle->init){
				filter_handle->selected=context_raw->texture_filter;
			}
			context_raw->texture_filter=ui_check(filter_handle,string_join(" ",tr("Filter Textures",null)),"");
			if(filter_handle->changed){
				make_material_parse_paint_material(true);
				make_material_parse_mesh_material();
			}
			context_raw->draw_wireframe=ui_check(context_raw->wireframe_handle,string_join(" ",tr("Wireframe",null)),"");
			if(context_raw->wireframe_handle->changed){
				gpu_texture_t * current=_draw_current;
				draw_end();
				util_uv_cache_uv_map();
				draw_begin(current,false,0);
				make_material_parse_mesh_material();
			}
			context_raw->draw_texels=ui_check(context_raw->texels_handle,string_join(" ",tr("Texels",null)),"");
			if(context_raw->texels_handle->changed){
				make_material_parse_mesh_material();
			}
			ui_handle_t * compass_handle=ui_handle("ui_menu.ts:261");
			if(compass_handle->init){
				compass_handle->selected=context_raw->show_compass;
			}
			context_raw->show_compass=ui_check(compass_handle,string_join(" ",tr("Compass",null)),"");
			if(compass_handle->changed){
				context_raw->ddirty=2;
			}
			context_raw->show_envmap=ui_check(context_raw->show_envmap_handle,string_join(" ",tr("Envmap",null)),"");
			if(context_raw->show_envmap_handle->changed){
				context_load_envmap();
				context_raw->ddirty=2;
			}
			context_raw->show_envmap_blur=ui_check(context_raw->show_envmap_blur_handle,string_join(" ",tr("Blur Envmap",null)),"");
			if(context_raw->show_envmap_blur_handle->changed){
				context_raw->ddirty=2;
			}
			context_update_envmap();
			if(ui->changed){
				ui_menu_keep_open=true;
			}
		}
		else if(ui_menu_category==menu_category_t_MODE){
			ui_handle_t * mode_handle=ui_handle("ui_menu.ts:288");
			mode_handle->position=context_raw->viewport_mode;
			string_t_array_t * modes=any_array_create_from_raw((any[]){tr("Lit",null),tr("Base Color",null),tr("Normal",null),tr("Occlusion",null),tr("Roughness",null),tr("Metallic",null),tr("Opacity",null),tr("Height",null),tr("Emission",null),tr("Subsurface",null),tr("TexCoord",null),tr("Object Normal",null),tr("Material ID",null),tr("Object ID",null),tr("Mask",null),},15);
			string_t_array_t * shortcuts=any_array_create_from_raw((any[]){"l","b","n","o","r","m","a","h","e","s","t","1","2","3","4",},15);
			if(gpu_raytrace_supported()){
				any_array_push(modes,tr("Path Traced",null));
				any_array_push(shortcuts,"p");
			}
			for(i32 i=0;i<modes->length;++i){
				string_t * shortcut=config_raw->touch_ui?"":string_join(string_join(any_map_get(config_keymap,"viewport_mode"),", "),shortcuts->buffer[i]);
				ui_radio(mode_handle,i,modes->buffer[i],shortcut);
			}
			if(mode_handle->changed){
				context_set_viewport_mode(mode_handle->position);
				if(mode_handle->position==viewport_mode_t_PATH_TRACE&&context_raw->camera_controls==camera_controls_t_ROTATE){
					context_raw->camera_controls=camera_controls_t_ORBIT;
					viewport_reset();
				}
			}
		}
		else if(ui_menu_category==menu_category_t_CAMERA){
			if(ui_menu_button(tr("Reset",null),any_map_get(config_keymap,"view_reset"))){
				viewport_reset();
				viewport_scale_to_bounds();
			}
			ui_menu_separator(ui);
			if(ui_menu_button(tr("Front",null),any_map_get(config_keymap,"view_front"))){
				viewport_set_view(0,-1,0,math_pi()/(float)2,0,0);
			}
			if(ui_menu_button(tr("Back",null),any_map_get(config_keymap,"view_back"))){
				viewport_set_view(0,1,0,math_pi()/(float)2,0,math_pi());
			}
			if(ui_menu_button(tr("Right",null),any_map_get(config_keymap,"view_right"))){
				viewport_set_view(1,0,0,math_pi()/(float)2,0,math_pi()/(float)2);
			}
			if(ui_menu_button(tr("Left",null),any_map_get(config_keymap,"view_left"))){
				viewport_set_view(-1,0,0,math_pi()/(float)2,0,-math_pi()/(float)2);
			}
			if(ui_menu_button(tr("Top",null),any_map_get(config_keymap,"view_top"))){
				viewport_set_view(0,0,1,0,0,0);
			}
			if(ui_menu_button(tr("Bottom",null),any_map_get(config_keymap,"view_bottom"))){
				viewport_set_view(0,0,-1,math_pi(),0,math_pi());
			}
			ui_menu_separator(ui);
			ui->changed=false;
			if(ui_menu_button(tr("Orbit Left",null),any_map_get(config_keymap,"view_orbit_left"))){
				viewport_orbit(-math_pi()/(float)12,0);
			}
			if(ui_menu_button(tr("Orbit Right",null),any_map_get(config_keymap,"view_orbit_right"))){
				viewport_orbit(math_pi()/(float)12,0);
			}
			if(ui_menu_button(tr("Orbit Up",null),any_map_get(config_keymap,"view_orbit_up"))){
				viewport_orbit(0,-math_pi()/(float)12);
			}
			if(ui_menu_button(tr("Orbit Down",null),any_map_get(config_keymap,"view_orbit_down"))){
				viewport_orbit(0,math_pi()/(float)12);
			}
			if(ui_menu_button(tr("Orbit Opposite",null),any_map_get(config_keymap,"view_orbit_opposite"))){
				viewport_orbit_opposite();
			}
			if(ui_menu_button(tr("Zoom In",null),any_map_get(config_keymap,"view_zoom_in"))){
				viewport_zoom(0.2);
			}
			if(ui_menu_button(tr("Zoom Out",null),any_map_get(config_keymap,"view_zoom_out"))){
				viewport_zoom(-0.2);
			}
			camera_object_t * cam=scene_camera;
			context_raw->fov_handle=ui_handle("ui_menu.ts:385");
			if(context_raw->fov_handle->init){
				context_raw->fov_handle->value=math_floor(cam->data->fov*100)/(float)100;
			}
			ui_menu_align(ui);
			cam->data->fov=ui_slider(context_raw->fov_handle,tr("FoV",null),0.3,1.4,true,100.0,true,ui_align_t_RIGHT,true);
			if(context_raw->fov_handle->changed){
				viewport_update_camera_type(context_raw->camera_type);
			}
			ui_menu_align(ui);
			ui_handle_t * camera_controls_handle=ui_handle("ui_menu.ts:396");
			camera_controls_handle->position=context_raw->camera_controls;
			string_t_array_t * camera_controls_items=any_array_create_from_raw((any[]){tr("Orbit",null),tr("Rotate",null),tr("Fly",null),},3);
			context_raw->camera_controls=ui_inline_radio(camera_controls_handle,camera_controls_items,ui_align_t_LEFT);
			any_map_t * vars=any_map_create();
			any_map_set(vars,"rotate_shortcut",any_map_get(config_keymap,"action_rotate"));
			any_map_set(vars,"zoom_shortcut",any_map_get(config_keymap,"action_zoom"));
			any_map_set(vars,"pan_shortcut",any_map_get(config_keymap,"action_pan"));
			string_t * orbit_and_rotate_tooltip=tr("Orbit and Rotate mode:\n{rotate_shortcut} or move right mouse button to rotate.\n{zoom_shortcut} or scroll to zoom.\n{pan_shortcut} or move middle mouse to pan.",vars);
			string_t * fly_tooltip=tr("Fly mode:\nHold the right mouse button and one of the following commands:\nmove mouse to rotate.\nw, up or scroll up to move forward.\ns, down or scroll down to move backward.\na or left to move left.\nd or right to move right.\ne to move up.\nq to move down.\nHold shift to move faster or alt to move slower.",null);
			if(ui->is_hovered){
				ui_tooltip(string_join(string_join(orbit_and_rotate_tooltip,"\n\n"),fly_tooltip));
			}
			ui_menu_align(ui);
			string_t_array_t * camera_type_items=any_array_create_from_raw((any[]){tr("Perspective",null),tr("Orthographic",null),},2);
			context_raw->camera_type=ui_inline_radio(context_raw->cam_handle,camera_type_items,ui_align_t_LEFT);
			if(ui->is_hovered){
				ui_tooltip(string_join(string_join(string_join(tr("Camera Type",null)," ("),any_map_get(config_keymap,"view_camera_type")),")"));
			}
			if(context_raw->cam_handle->changed){
				viewport_update_camera_type(context_raw->camera_type);
			}
			if(ui->changed){
				ui_menu_keep_open=true;
			}
		}
		else if(ui_menu_category==menu_category_t_HELP){
			if(ui_menu_button(tr("Manual",null),"")){
				file_load_url(string_join(manifest_url,"/manual"));
			}
			if(ui_menu_button(tr("How To",null),"")){
				file_load_url(string_join(manifest_url,"/howto"));
			}
			if(ui_menu_button(tr("What's New",null),"")){
				file_load_url(string_join(manifest_url,"/notes"));
			}
			if(ui_menu_button(tr("Issue Tracker",null),"")){
				file_load_url("https://github.com/armory3d/armortools/issues");
			}
			if(ui_menu_button(tr("Report Bug",null),"")){
				file_load_url(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("https://github.com/armory3d/armortools/issues/new?labels=bug&template=bug_report.md&body=*",manifest_title),"%20"),manifest_version),"-"),config_get_sha()),",%20"),iron_system_id()),"*%0A%0A**Issue description:**%0A%0A**Steps to reproduce:**%0A%0A"));
			}
			if(ui_menu_button(tr("Request Feature",null),"")){
				file_load_url(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("https://github.com/armory3d/armortools/issues/new?labels=feature%20request&template=feature_request.md&body=*",manifest_title),"%20"),manifest_version),"-"),config_get_sha()),",%20"),iron_system_id()),"*%0A%0A**Feature description:**%0A%0A"));
			}
			ui_menu_separator(ui);
			if(ui_menu_button(tr("Check for Updates...",null),"")){
				file_download_bytes(string_join(string_join("https://server.armorpaint.org/",to_lower_case(manifest_title)),".html"),&ui_menu_render_150094				);
			}
			if(ui_menu_button(tr("About...",null),"")){
				string_t * msg=string_join(string_join(string_join(string_join(string_join(string_join(string_join(manifest_title,".org - v"),manifest_version)," ("),config_get_date()),") - "),config_get_sha()),"\n");
				msg=string_join(msg,string_join(string_join(iron_system_id()," - "),strings_graphics_api()));
				string_t * save;
				if(path_is_protected()){
					save=string_copy(iron_internal_save_path());
				}
				else {
					save=string_copy(path_data());
				}
				save=string_join(save,string_join(path_sep,"tmp.txt"));
				iron_sys_command(string_join(string_join("wmic path win32_VideoController get name > \"",save),"\""));
				buffer_t * blob=iron_load_blob(save);
				u8_array_t * u8=blob;
				string_t * gpu_raw="";
				for(i32 i=0;i<math_floor(u8->length/(float)2);++i){
					string_t * c=string_from_char_code(u8->buffer[i*2]);
					gpu_raw=string_join(gpu_raw,c);
				}
				string_t_array_t * gpus=string_split(gpu_raw,"\n");
				array_splice(gpus,1,gpus->length-2);
				string_t * gpu="";
				for(i32 i=0;i<gpus->length;++i){
					string_t * g=gpus->buffer[i];
					gpu=string_join(gpu,string_join(trim_end(g),", "));
				}
				gpu=string_copy(substring(gpu,0,string_length(gpu)-2));
				msg=string_join(msg,string_join("\n",gpu));
				gc_unroot(_ui_menu_render_msg);_ui_menu_render_msg=string_copy(msg);gc_root(_ui_menu_render_msg);
				ui_box_show_custom(&ui_menu_render_150537				,400,320,null,true);
			}
		}
	}
	ui_menu_hide_flag=ui->combo_selected_handle==null&&!ui_menu_keep_open&&!ui_menu_show_first&&(ui->changed||ui->input_released||ui->input_released_r||ui->is_escape_down);
	ui_menu_keep_open=false;
	ui->ops->theme->FILL_BUTTON_BG=_FILL_BUTTON_BG;
	ui->ops->theme->ELEMENT_OFFSET=_ELEMENT_OFFSET;
	ui->ops->theme->ELEMENT_H=_ELEMENT_H;
	ui_menu_end(ui);
	ui_end_region(true);
	draw_end();
	if(ui_menu_show_first){
		ui_menu_show_first=false;
		ui_menu_h=ui->_y-ui_menu_y;
		ui_menu_x+=iron_window_width()*2;
		ui_menu_y+=iron_window_height()*2;
		ui_menu_fit_to_screen();
		ui_menu_render();
	}
	if(ui_menu_hide_flag){
		ui_menu_hide();
		ui_menu_show_first=true;
		gc_unroot(ui_menu_commands);ui_menu_commands=null;
	}
}

void ui_menu_render_150537(ui_t * ui){
bool tab_vertical=config_raw->touch_ui;
				if(ui_tab(ui_handle("ui_menu.ts:529"),tr("About",null),tab_vertical,-1)){
					gpu_texture_t * img=data_get_image("badge.k");
					_ui_image(img,0xffffffff,-1.0,0,0,0,0);
					_ui_end_element(-1.0);
					ui_handle_t * h=ui_handle("ui_menu.ts:535");
					if(h->init){
						h->text=string_copy(_ui_menu_render_msg);
					}
					ui_text_area(h,ui_align_t_LEFT,false,"",false);
					ui_row3();
					if(ui_button(tr("Copy",null),ui_align_t_CENTER,"")){
						iron_copy_to_clipboard(_ui_menu_render_msg);
					}
					if(ui_button(tr("Contributors",null),ui_align_t_CENTER,"")){
						file_load_url("https://github.com/armory3d/armortools/graphs/contributors");
					}
					if(ui_button(tr("OK",null),ui_align_t_CENTER,"")){
						ui_box_hide();
					}
				}
}

void ui_menu_render_150094(string_t * url,buffer_t * buffer){
if(buffer!=null){
					update_info_t * update=json_parse(sys_buffer_to_string(buffer));
					i32 update_version=math_floor(update->version);
					if(update_version>0){
						string_t * date=config_get_date();
						date=string_copy(substring(date,2,string_length(date)));
						i32 date_int=parse_int(string_replace_all(date,"-",""));
						if(update_version>date_int){
							any_map_t * vars=any_map_create();
							any_map_set(vars,"url",manifest_url);
							ui_box_show_message(tr("Update",null),tr("Update is available!\nPlease visit {url}.",vars),false);
						}
						else {
							ui_box_show_message(tr("Update",null),tr("You are up to date!",null),false);
						}
					}
				}
				else {
					any_map_t * vars=any_map_create();
					any_map_set(vars,"url",manifest_url);
					ui_box_show_message(tr("Update",null),tr("Unable to check for updates.\nPlease visit {url}.",vars),false);
				}
}

void ui_menu_render_147841(string_t * path){
if(!ends_with(path,".hdr")){
					console_error(tr("Error: .hdr file expected",null));
					return ;
				}
				import_asset_run(path,-1.0,-1.0,true,true,null);
}

void ui_menu_hide(){
	ui_menu_show=false;
	base_redraw_ui();
}

void ui_menu_draw(void(*commands)(ui_t *),i32 x,i32 y){
	ui_end_input();
	ui_menu_show=true;
	gc_unroot(ui_menu_commands);ui_menu_commands=commands;gc_root(ui_menu_commands);
	ui_menu_x=x>-1?x:math_floor(mouse_x+1);
	ui_menu_y=y>-1?y:math_floor(mouse_y+1);
	ui_menu_h=0;
}

void ui_menu_fit_to_screen(){
	f32 menu_w=base_default_element_w*ui_SCALE(base_ui_menu)*2.3;
	if(ui_menu_x+menu_w>iron_window_width()){
		if(ui_menu_x-menu_w>0){
			ui_menu_x=math_floor(ui_menu_x-menu_w);
		}
		else {
			ui_menu_x=math_floor(iron_window_width()-menu_w);
		}
	}
	if(ui_menu_y+ui_menu_h>iron_window_height()){
		if(ui_menu_y-ui_menu_h>0){
			ui_menu_y=math_floor(ui_menu_y-ui_menu_h);
		}
		else {
			ui_menu_y=iron_window_height()-ui_menu_h;
		}
		ui_menu_x+=1;
	}
}

void ui_menu_separator(ui_t * ui){
	ui->_y++;
	if(config_raw->touch_ui){
		ui_fill(0,0,ui->_w/(float)ui_SCALE(ui),1,ui->ops->theme->BUTTON_COL);
	}
	else {
		ui_fill(26,0,ui->_w/(float)ui_SCALE(ui)-26,1,ui->ops->theme->BUTTON_COL);
	}
}

bool ui_menu_button(string_t * text,string_t * label){
	if(config_raw->touch_ui){
		label="";
	}
	return ui_button(string_join(config_button_spacing,text),config_button_align,label);
}

void ui_menu_align(ui_t * ui){
	if(!config_raw->touch_ui){
		f32_array_t * row=f32_array_create_from_raw((f32[]){12/(float)100,88/(float)100,},2);
		ui_row(row);
		_ui_end_element(-1.0);
	}
}

void ui_menu_start(ui_t * ui){
	ui_draw_shadow(ui->_x,ui->_y,ui->_w,ui_menu_h);
	draw_set_color(ui->ops->theme->SEPARATOR_COL);
	ui_draw_rect(true,ui->_x,ui->_y,ui->_w,ui_menu_h);
	draw_set_color(0xffffffff);
}

void ui_menu_end(ui_t * ui){
}

void ui_menubar_init(){
	ui_menubar_workspace_handle->layout=ui_layout_t_HORIZONTAL;
	ui_menubar_menu_handle->layout=ui_layout_t_HORIZONTAL;
}

void ui_menubar_render_ui(){
	ui_t * ui=ui_base_ui;
	i32 item_w=ui_toolbar_w(false);
	i32 panel_x=sys_x();
	if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
		panel_x=sys_x()-item_w;
	}
	if(ui_window(ui_menubar_menu_handle,panel_x,0,ui_menubar_w,ui_header_h,false)){
		ui->_x+=1;
		ui_begin_menu();
		if(config_raw->touch_ui){
			ui->_w=item_w;
			if(ui_menubar_icon_button(ui,0,2))box_preferences_show();
			if(ui_menubar_icon_button(ui,0,3)){
				sys_notify_on_next_frame(&ui_menubar_render_ui_151356				,null);
			}
			if(ui_menubar_icon_button(ui,4,2)){
				project_import_asset(null,true);
			}
			if(ui_menubar_icon_button(ui,5,2)){
				box_export_show_textures();
			}
			i32 size=math_floor(ui->_w/(float)ui_SCALE(ui));
			if(ui_menu_show&&ui_menu_category==menu_category_t_VIEWPORT){
				ui_fill(0,-6,size,size-4,ui->ops->theme->HIGHLIGHT_COL);
			}
			if(ui_menubar_icon_button(ui,8,2)){
				ui_menubar_show_menu(ui,menu_category_t_VIEWPORT);
			}
			if(ui_menu_show&&ui_menu_category==menu_category_t_MODE){
				ui_fill(0,-6,size,size-4,ui->ops->theme->HIGHLIGHT_COL);
			}
			if(ui_menubar_icon_button(ui,9,2)){
				ui_menubar_show_menu(ui,menu_category_t_MODE);
			}
			if(ui_menu_show&&ui_menu_category==menu_category_t_CAMERA){
				ui_fill(0,-6,size,size-4,ui->ops->theme->HIGHLIGHT_COL);
			}
			if(ui_menubar_icon_button(ui,10,2)){
				ui_menubar_show_menu(ui,menu_category_t_CAMERA);
			}
			if(ui_menu_show&&ui_menu_category==menu_category_t_HELP){
				ui_fill(0,-6,size,size-4,ui->ops->theme->HIGHLIGHT_COL);
			}
			if(ui_menubar_icon_button(ui,11,2)){
				ui_menubar_show_menu(ui,menu_category_t_HELP);
			}
			ui->enabled=history_undos>0;
			if(ui_menubar_icon_button(ui,6,2)){
				history_undo();
			}
			ui->enabled=history_redos>0;
			if(ui_menubar_icon_button(ui,7,2)){
				history_redo();
			}
			ui->enabled=true;
		}
		else {
			string_t_array_t * categories=any_array_create_from_raw((any[]){tr("File",null),tr("Edit",null),tr("Viewport",null),tr("Mode",null),tr("Camera",null),tr("Help",null),},6);
			for(i32 i=0;i<categories->length;++i){
				if(_ui_menu_button(categories->buffer[i])||(ui_menu_show&&ui_menu_commands==null&&ui->is_hovered)){
					ui_menubar_show_menu(ui,i);
				}
			}
		}
		if(ui_menubar_w<ui->_x+10){
			ui_menubar_w=math_floor(ui->_x+10);
			ui_toolbar_handle->redraws=2;
		}
		ui_end_menu();
	}
	if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
		ui_menubar_draw_tab_header();
	}
}

void ui_menubar_render_ui_151356(){
box_projects_show();
}

void ui_menubar_draw_tab_header(){
	ui_t * ui=ui_base_ui;
	i32 item_w=ui_toolbar_w(false);
	i32 panel_x=sys_x();
	i32 nodesw=(ui_nodes_show||ui_view2d_show)?config_raw->layout->buffer[layout_size_t_NODES_W]:0;
	i32 ww=iron_window_width()-config_raw->layout->buffer[layout_size_t_SIDEBAR_W]-ui_menubar_w-nodesw;
	panel_x=(sys_x()-item_w)+ui_menubar_w;
	if(ui_window(ui_menubar_workspace_handle,panel_x,0,ww,ui_header_h,false)){
		if(!config_raw->touch_ui){
			ui_tab(ui_header_worktab,tr("3D View",null),false,-1);
		}
		else {
			ui_fill(0,0,ui->_window_w,ui->_window_h+4,ui->ops->theme->SEPARATOR_COL);
		}
	}
}

void ui_menubar_show_menu(ui_t * ui,i32 category){
	if(ui_menu_show&&ui_menu_category==category){
		return ;
	}
	ui_menu_show=true;
	ui_menu_show_first=true;
	gc_unroot(ui_menu_commands);ui_menu_commands=null;
	ui_menu_category=category;
	ui_menu_x=math_floor(ui->_x-ui->_w);
	ui_menu_y=math_floor(ui_MENUBAR_H(ui));
	if(config_raw->touch_ui){
		i32 menu_w=math_floor(base_default_element_w*ui_SCALE(base_ui_menu)*2.0);
		ui_menu_x-=math_floor((menu_w-ui->_w)/(float)2)+math_floor(ui_header_h/(float)2);
		ui_menu_x+=math_floor(2*ui_SCALE(base_ui_menu));
		ui_menu_y-=math_floor(2*ui_SCALE(base_ui_menu));
		ui_menu_keep_open=true;
	}
}

bool ui_menubar_icon_button(ui_t * ui,i32 i,i32 j){
	u32 col=ui->ops->theme->WINDOW_BG_COL;
	bool light=col>0xff666666;
	i32 icon_accent=light?0xff666666:0xffaaaaaa;
	gpu_texture_t * img=resource_get("icons.k");
	rect_t * rect=resource_tile50(img,i,j);
	return _ui_image(img,icon_accent,-1.0,rect->x,rect->y,rect->w,rect->h)==ui_state_t_RELEASED;
}

void ui_viewnodes_init(){
	gc_unroot(ui_nodes_on_link_drag);ui_nodes_on_link_drag=ui_viewnodes_on_link_drag;gc_root(ui_nodes_on_link_drag);
	gc_unroot(ui_nodes_on_socket_released);ui_nodes_on_socket_released=ui_viewnodes_on_socket_released;gc_root(ui_nodes_on_socket_released);
	gc_unroot(ui_nodes_on_canvas_released);ui_nodes_on_canvas_released=ui_viewnodes_on_canvas_released;gc_root(ui_nodes_on_canvas_released);
	gc_unroot(ui_nodes_on_canvas_control);ui_nodes_on_canvas_control=ui_viewnodes_on_canvas_control;gc_root(ui_nodes_on_canvas_control);
	ui_nodes_grid_snap=config_raw->grid_snap;
	nodes_material_init();
	f32 scale=config_raw->window_scale;
	ui_options_t * ops=GC_ALLOC_INIT(ui_options_t, {.theme=base_theme,.font=base_font,.color_wheel=base_color_wheel,.black_white_gradient=base_color_wheel_gradient,.scale_factor=scale});
	gc_unroot(ui_nodes_ui);ui_nodes_ui=ui_create(ops);gc_root(ui_nodes_ui);
	ui_nodes_ui->scroll_enabled=false;
}

void ui_viewnodes_on_link_drag(i32 link_drag_id,bool is_new_link){
	if(!is_new_link){
		return ;
	}
	ui_nodes_t * ui_nodes=ui_nodes_get_nodes();
	ui_node_link_t_array_t * links=ui_nodes_get_canvas(true)->links;
	ui_node_link_t * link_drag=ui_get_link(links,link_drag_id);
	ui_node_t_array_t * nodes=ui_nodes_get_canvas(true)->nodes;
	ui_node_t * node=ui_get_node(nodes,link_drag->from_id>-1?link_drag->from_id:link_drag->to_id);
	i32 link_x=ui_nodes_ui->_window_x+UI_NODE_X(node);
	i32 link_y=ui_nodes_ui->_window_y+UI_NODE_Y(node);
	if(link_drag->from_id>-1){
		link_x+=UI_NODE_W(node);
		link_y+=UI_OUTPUT_Y(node->outputs->length,link_drag->from_socket);
	}
	else {
		link_y+=ui_nodes_INPUT_Y(ui_nodes_get_canvas(true),node->inputs,link_drag->to_socket)+UI_OUTPUTS_H(node->outputs->length,-1)+UI_BUTTONS_H(node);
	}
	if(math_abs(mouse_x-link_x)>5||math_abs(mouse_y-link_y)>5){
		gc_unroot(_ui_nodes_on_link_drag_link_drag);_ui_nodes_on_link_drag_link_drag=link_drag;gc_root(_ui_nodes_on_link_drag_link_drag);
		gc_unroot(_ui_nodes_on_link_drag_node);_ui_nodes_on_link_drag_node=node;gc_root(_ui_nodes_on_link_drag_node);
		ui_nodes_node_search(-1,-1,&ui_viewnodes_on_link_drag_152739		);
	}
	else if(ui_nodes->nodes_selected_id->length>0&&node->id==ui_nodes->nodes_selected_id->buffer[0]){
		context_raw->node_preview_socket=link_drag->from_id>-1?link_drag->from_socket:0;
		context_raw->node_preview_dirty=true;
	}
}

void ui_viewnodes_on_link_drag_152739(){
ui_nodes_t * ui_nodes=ui_nodes_get_nodes();
		i32 node_selected_id=_ui_nodes_on_link_drag_node->id;
		if(ui_nodes->nodes_selected_id->length>0){
			node_selected_id=ui_nodes->nodes_selected_id->buffer[0];
		}
		ui_node_link_t * link_drag=_ui_nodes_on_link_drag_link_drag;
		ui_node_t_array_t * nodes=ui_nodes_get_canvas(true)->nodes;
		ui_node_t * n=ui_get_node(nodes,node_selected_id);
		if(link_drag->to_id==-1&&n->inputs->length>0){
			link_drag->to_id=n->id;
			string_t * from_type=_ui_nodes_on_link_drag_node->outputs->buffer[link_drag->from_socket]->type;
			link_drag->to_socket=0;
			for(i32 i=0;i<n->inputs->length;++i){
				ui_node_socket_t * socket=n->inputs->buffer[i];
				if(string_equals(socket->type,from_type)){
					link_drag->to_socket=array_index_of(n->inputs,socket);
					break;
				}
			}
			any_array_push(ui_nodes_get_canvas(true)->links,link_drag);
		}
		else if(link_drag->from_id==-1&&n->outputs->length>0){
			link_drag->from_id=n->id;
			link_drag->from_socket=0;
			any_array_push(ui_nodes_get_canvas(true)->links,link_drag);
		}
}

void ui_viewnodes_on_socket_released(i32 socket_id){
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	ui_node_canvas_t * canvas=ui_nodes_get_canvas(true);
	ui_node_socket_t * socket=ui_get_socket(canvas->nodes,socket_id);
	ui_node_t * node=ui_get_node(canvas->nodes,socket->node_id);
	if(ui_nodes_ui->input_released_r){
		if(string_equals(node->type,"GROUP_INPUT")||string_equals(node->type,"GROUP_OUTPUT")){
			gc_unroot(_ui_nodes_on_socket_released_socket);_ui_nodes_on_socket_released_socket=socket;gc_root(_ui_nodes_on_socket_released_socket);
			gc_unroot(_ui_nodes_on_socket_released_node);_ui_nodes_on_socket_released_node=node;gc_root(_ui_nodes_on_socket_released_node);
			sys_notify_on_next_frame(&ui_viewnodes_on_socket_released_153038			,null);
		}
		else ui_viewnodes_on_canvas_released();
	}
	else if(nodes->nodes_selected_id->length>0&&node->id==nodes->nodes_selected_id->buffer[0]){
		i32 i=array_index_of(node->outputs,socket);
		if(i>-1){
			context_raw->node_preview_socket=i;
			context_raw->node_preview_dirty=true;
		}
	}
}

void ui_viewnodes_on_socket_released_153174(ui_t * ui){
ui_node_socket_t * socket=_ui_nodes_on_socket_released_socket;
				ui_node_t * node=_ui_nodes_on_socket_released_node;
				if(ui_tab(ui_handle("ui_nodes.ts:194"),tr("Socket",null),false,-1)){
					string_t_array_t * type_combo=any_array_create_from_raw((any[]){tr("Color",null),tr("Vector",null),tr("Value",null),},3);
					i32 type=ui_combo(_ui_nodes_htype,type_combo,tr("Type",null),true,ui_align_t_LEFT,true);
					if(_ui_nodes_htype->changed){
						_ui_nodes_hname->text=type==0?tr("Color",null):type==1?tr("Vector",null):tr("Value",null);
					}
					string_t * name=ui_text_input(_ui_nodes_hname,tr("Name",null),ui_align_t_LEFT,true,false);
					f32 min=ui_float_input(_ui_nodes_hmin,tr("Min",null),ui_align_t_LEFT,1000.0);
					f32 max=ui_float_input(_ui_nodes_hmax,tr("Max",null),ui_align_t_LEFT,1000.0);
					f32_array_t * default_value=null;
					if(type==0){
						ui_row4();
						ui_float_input(_ui_nodes_hval0,tr("R",null),ui_align_t_LEFT,1000.0);
						ui_float_input(_ui_nodes_hval1,tr("G",null),ui_align_t_LEFT,1000.0);
						ui_float_input(_ui_nodes_hval2,tr("B",null),ui_align_t_LEFT,1000.0);
						ui_float_input(_ui_nodes_hval3,tr("A",null),ui_align_t_LEFT,1000.0);
						default_value=f32_array_create_xyzw(_ui_nodes_hval0->value,_ui_nodes_hval1->value,_ui_nodes_hval2->value,_ui_nodes_hval3->value);
					}
					else if(type==1){
						ui_row3();
						_ui_nodes_hval0->value=ui_float_input(_ui_nodes_hval0,tr("X",null),ui_align_t_LEFT,1000.0);
						_ui_nodes_hval1->value=ui_float_input(_ui_nodes_hval1,tr("Y",null),ui_align_t_LEFT,1000.0);
						_ui_nodes_hval2->value=ui_float_input(_ui_nodes_hval2,tr("Z",null),ui_align_t_LEFT,1000.0);
						default_value=f32_array_create_xyz(_ui_nodes_hval0->value,_ui_nodes_hval1->value,_ui_nodes_hval2->value);
					}
					else {
						f32 f=ui_float_input(_ui_nodes_hval0,tr("default_value",null),ui_align_t_LEFT,1000.0);
						default_value=f32_array_create_x(f);
					}
					if(ui_button(tr("OK",null),ui_align_t_CENTER,"")){
						socket->name=string_copy(name);
						socket->type=type==0?"RGBA":type==1?"VECTOR":"VALUE";
						socket->color=nodes_material_get_socket_color(socket->type);
						socket->min=min;
						socket->max=max;
						socket->default_value=default_value;
						ui_box_hide();
						nodes_material_sync_sockets(node);
						ui_nodes_hwnd->redraws=2;
					}
				}
}

void ui_viewnodes_on_socket_released_153164(){
ui_end_input();
				ui_box_show_custom(&ui_viewnodes_on_socket_released_153174				,400,250,null,true);
}

void ui_viewnodes_on_socket_released_153044(ui_t * ui){
ui_node_socket_t * socket=_ui_nodes_on_socket_released_socket;
			ui_node_t * node=_ui_nodes_on_socket_released_node;
			if(ui_menu_button(tr("Edit",null),"")){
				_ui_nodes_htype->position=string_equals(socket->type,"RGBA")?0:string_equals(socket->type,"VECTOR")?1:2;
				_ui_nodes_hname->text=string_copy(socket->name);
				_ui_nodes_hmin->value=socket->min;
				_ui_nodes_hmax->value=socket->max;
				if(string_equals(socket->type,"RGBA")||string_equals(socket->type,"VECTOR")){
					_ui_nodes_hval0->value=socket->default_value->buffer[0];
					_ui_nodes_hval1->value=socket->default_value->buffer[1];
					_ui_nodes_hval2->value=socket->default_value->buffer[2];
					if(string_equals(socket->type,"RGBA")){
						_ui_nodes_hval3->value=socket->default_value->buffer[3];
					}
				}
				else {
					_ui_nodes_hval0->value=socket->default_value->buffer[0];
				}
				sys_notify_on_next_frame(&ui_viewnodes_on_socket_released_153164				,null);
			}
			if(ui_menu_button(tr("Delete",null),"")){
				i32 i=0;
				ui_node_canvas_t * canvas=ui_nodes_get_canvas(true);
				while(i<canvas->links->length){
					ui_node_link_t * l=canvas->links->buffer[i];
					if((l->from_id==node->id&&l->from_socket==array_index_of(node->outputs,socket))||(l->to_id==node->id&&l->to_socket==array_index_of(node->inputs,socket))){
						array_splice(canvas->links,i,1);
					}
					else {
						i++;
					}
				}
				array_remove(node->inputs,socket);
				array_remove(node->outputs,socket);
				nodes_material_sync_sockets(node);
			}
}

void ui_viewnodes_on_socket_released_153038(){
ui_menu_draw(&ui_viewnodes_on_socket_released_153044			,-1,-1);
}

void ui_viewnodes_on_canvas_released(){
	if(ui_nodes_ui->input_released_r&&context_in_nodes()&&math_abs(ui_nodes_ui->input_x-ui_nodes_ui->input_started_x)<2&&math_abs(ui_nodes_ui->input_y-ui_nodes_ui->input_started_y)<2){
		ui_nodes_t * nodes=ui_nodes_get_nodes();
		ui_node_canvas_t * canvas=ui_nodes_get_canvas(true);
		ui_node_t * selected=null;
		for(i32 i=0;i<canvas->nodes->length;++i){
			ui_node_t * node=canvas->nodes->buffer[i];
			if(ui_input_in_rect(ui_nodes_ui->_window_x+UI_NODE_X(node),ui_nodes_ui->_window_y+UI_NODE_Y(node),UI_NODE_W(node),UI_NODE_H(canvas,node))){
				selected=node;
				break;
			}
		}
		if(selected==null){
			nodes->nodes_selected_id=i32_array_create_from_raw((i32[]){},0);
		}
		else if(i32_array_index_of(nodes->nodes_selected_id,selected->id)==-1){
			nodes->nodes_selected_id=i32_array_create_from_raw((i32[]){selected->id,},1);
		}
		if(!ui_nodes_socket_released){
			gc_unroot(_ui_nodes_on_canvas_released_selected);_ui_nodes_on_canvas_released_selected=selected;gc_root(_ui_nodes_on_canvas_released_selected);
			ui_menu_draw(&ui_viewnodes_on_canvas_released_153904			,-1,-1);
		}
	}
	if(ui_nodes_ui->input_released){
		ui_nodes_t * nodes=ui_nodes_get_nodes();
		ui_node_canvas_t * canvas=ui_nodes_get_canvas(true);
		for(i32 i=0;i<canvas->nodes->length;++i){
			ui_node_t * node=canvas->nodes->buffer[i];
			if(ui_input_in_rect(ui_nodes_ui->_window_x+UI_NODE_X(node),ui_nodes_ui->_window_y+UI_NODE_Y(node),UI_NODE_W(node),UI_NODE_H(canvas,node))){
				if(nodes->nodes_selected_id->length>0&&node->id==nodes->nodes_selected_id->buffer[0]){
					ui_view2d_hwnd->redraws=2;
					if(sys_time()-context_raw->select_time<0.25)ui_base_show_2d_view(view_2d_type_t_NODE);
					context_raw->select_time=sys_time();
				}
				break;
			}
		}
	}
}

void ui_viewnodes_on_canvas_released_154116(){
ui_nodes_hwnd->redraws=2;
				ui_is_copy=true;
				ui_is_paste=true;
				ui_nodes_is_node_menu_op=true;
}

void ui_viewnodes_on_canvas_released_154083(){
ui_nodes_hwnd->redraws=2;
				ui_nodes_ui->is_delete_down=true;
				ui_nodes_is_node_menu_op=true;
}

void ui_viewnodes_on_canvas_released_154043(){
ui_nodes_hwnd->redraws=2;
				ui_is_paste=true;
				ui_nodes_is_node_menu_op=true;
}

void ui_viewnodes_on_canvas_released_154006(){
ui_is_copy=true;
				ui_nodes_is_node_menu_op=true;
}

void ui_viewnodes_on_canvas_released_153967(){
ui_nodes_hwnd->redraws=2;
				ui_is_copy=true;
				ui_is_cut=true;
				ui_nodes_is_node_menu_op=true;
}

void ui_viewnodes_on_canvas_released_153904(ui_t * ui_menu){
ui_node_t * selected=_ui_nodes_on_canvas_released_selected;
			ui_menu->_y+=1;
			bool is_protected=selected==null||string_equals(selected->type,"OUTPUT_MATERIAL_PBR")||string_equals(selected->type,"GROUP_INPUT")||string_equals(selected->type,"GROUP_OUTPUT")||string_equals(selected->type,"brush_output_node");
			ui_menu->enabled=!is_protected;
			if(ui_menu_button(tr("Cut",null),"ctrl+x")){
				sys_notify_on_next_frame(&ui_viewnodes_on_canvas_released_153967				,null);
			}
			if(ui_menu_button(tr("Copy",null),"ctrl+c")){
				sys_notify_on_next_frame(&ui_viewnodes_on_canvas_released_154006				,null);
			}
			ui_menu->enabled=!string_equals(ui_clipboard,"");
			if(ui_menu_button(tr("Paste",null),"ctrl+v")){
				sys_notify_on_next_frame(&ui_viewnodes_on_canvas_released_154043				,null);
			}
			ui_menu->enabled=!is_protected;
			if(ui_menu_button(tr("Delete",null),"delete")){
				sys_notify_on_next_frame(&ui_viewnodes_on_canvas_released_154083				,null);
			}
			if(ui_menu_button(tr("Duplicate",null),"")){
				sys_notify_on_next_frame(&ui_viewnodes_on_canvas_released_154116				,null);
			}
			if(selected!=null&&string_equals(selected->type,"RGB")){
				if(ui_menu_button(tr("Add Swatch",null),"")){
					f32_array_t * color=selected->outputs->buffer[0]->default_value;
					swatch_color_t * new_swatch=make_swatch(color_from_floats(color->buffer[0],color->buffer[1],color->buffer[2],color->buffer[3]));
					context_set_swatch(new_swatch);
					any_array_push(project_raw->swatches,new_swatch);
					ui_base_hwnds->buffer[tab_area_t_STATUS]->redraws=1;
				}
			}
			if(ui_nodes_canvas_type==canvas_type_t_MATERIAL){
				ui_menu_separator(ui_menu);
				if(ui_menu_button(tr("2D View",null),"")){
					ui_base_show_2d_view(view_2d_type_t_NODE);
				}
			}
			ui_menu->enabled=true;
}

ui_canvas_control_t * ui_viewnodes_on_canvas_control(){
	ui_canvas_control_t * control=ui_nodes_get_canvas_control(ui_nodes_ui,ui_nodes_controls_down);
	ui_nodes_controls_down=control->controls_down;
	return control;
}

ui_canvas_control_t * ui_nodes_get_canvas_control(ui_t * ui,bool controls_down){
	if(config_raw->wrap_mouse&&controls_down){
		if(ui->input_x<ui->_window_x){
			ui->input_x=ui->_window_x+ui->_window_w;
			iron_mouse_set_position(math_floor(ui->input_x),math_floor(ui->input_y));
		}
		else if(ui->input_x>ui->_window_x+ui->_window_w){
			ui->input_x=ui->_window_x;
			iron_mouse_set_position(math_floor(ui->input_x),math_floor(ui->input_y));
		}
		else if(ui->input_y<ui->_window_y){
			ui->input_y=ui->_window_y+ui->_window_h;
			iron_mouse_set_position(math_floor(ui->input_x),math_floor(ui->input_y));
		}
		else if(ui->input_y>ui->_window_y+ui->_window_h){
			ui->input_y=ui->_window_y;
			iron_mouse_set_position(math_floor(ui->input_x),math_floor(ui->input_y));
		}
	}
	if(operator_shortcut(any_map_get(config_keymap,"action_pan"),shortcut_type_t_STARTED)||operator_shortcut(any_map_get(config_keymap,"action_zoom"),shortcut_type_t_STARTED)||ui->input_started_r||ui->input_wheel_delta!=0.0){
		controls_down=true;
	}
	else if(!operator_shortcut(any_map_get(config_keymap,"action_pan"),shortcut_type_t_DOWN)&&!operator_shortcut(any_map_get(config_keymap,"action_zoom"),shortcut_type_t_DOWN)&&!ui->input_down_r&&ui->input_wheel_delta==0.0){
		controls_down=false;
	}
	if(!controls_down){
		ui_canvas_control_t * cc=GC_ALLOC_INIT(ui_canvas_control_t, {.pan_x=0,.pan_y=0,.zoom=0,.controls_down=controls_down});
		return cc;
	}
	bool pan=ui->input_down_r||operator_shortcut(any_map_get(config_keymap,"action_pan"),shortcut_type_t_DOWN);
	f32 zoom_delta=operator_shortcut(any_map_get(config_keymap,"action_zoom"),shortcut_type_t_DOWN)?ui_nodes_get_zoom_delta(ui)/(float)100.0:0.0;
	ui_canvas_control_t * control=GC_ALLOC_INIT(ui_canvas_control_t, {.pan_x=pan?ui->input_dx:0.0,.pan_y=pan?ui->input_dy:0.0,.zoom=ui->input_wheel_delta!=0.0?-ui->input_wheel_delta/10:zoom_delta,.controls_down=controls_down});
	if(base_is_combo_selected()){
		control->zoom=0.0;
	}
	if(control->zoom!=0.0){
		ui_nodes_grid_redraw=true;
	}
	return control;
}

f32 ui_nodes_get_zoom_delta(ui_t * ui){
	return config_raw->zoom_direction==zoom_direction_t_VERTICAL?-ui->input_dy:config_raw->zoom_direction==zoom_direction_t_VERTICAL_INVERTED?-ui->input_dy:config_raw->zoom_direction==zoom_direction_t_HORIZONTAL?ui->input_dx:config_raw->zoom_direction==zoom_direction_t_HORIZONTAL_INVERTED?ui->input_dx:-(ui->input_dy-ui->input_dx);
}

bool ui_nodes_is_tab_selected(){
	return ui_nodes_htab->position>0&&ui_nodes_htab->position%2==1&&ui_nodes_tabs->length>=ui_nodes_htab->position/(float)2;
}

i32 ui_nodes_tab_index(){
	return (int)(ui_nodes_htab->position/(float)2);
}

ui_node_canvas_t * ui_nodes_get_canvas(bool groups){
	if(ui_nodes_canvas_type==canvas_type_t_MATERIAL){
		if(groups&&ui_nodes_group_stack->length>0){
			return ui_nodes_group_stack->buffer[ui_nodes_group_stack->length-1]->canvas;
		}
		else if(ui_nodes_is_tab_selected()){
			return ui_nodes_tabs->buffer[ui_nodes_tab_index()]->canvas;
		}
		else {
			return ui_nodes_get_canvas_material();
		}
	}
	else {
		return context_raw->brush->canvas;
	}
}

ui_node_canvas_t * ui_nodes_get_canvas_material(){
	return context_raw->material->canvas;
}

ui_nodes_t * ui_nodes_get_nodes(){
	if(ui_nodes_canvas_type==canvas_type_t_MATERIAL){
		if(ui_nodes_group_stack->length>0){
			return ui_nodes_group_stack->buffer[ui_nodes_group_stack->length-1]->nodes;
		}
		else if(ui_nodes_is_tab_selected()){
			return ui_nodes_tabs->buffer[ui_nodes_tab_index()]->nodes;
		}
		else {
			return context_raw->material->nodes;
		}
	}
	else {
		return context_raw->brush->nodes;
	}
}

void ui_nodes_update(){
	if(!ui_nodes_show||!base_ui_enabled){
		return ;
	}
	ui_nodes_wx=math_floor(sys_w())+ui_toolbar_w(true);
	ui_nodes_wy=ui_header_h*2;
	if(ui_view2d_show){
		ui_nodes_wy+=sys_h()-config_raw->layout->buffer[layout_size_t_NODES_H];
	}
	i32 ww=config_raw->layout->buffer[layout_size_t_NODES_W];
	if(!ui_base_show){
		ww+=config_raw->layout->buffer[layout_size_t_SIDEBAR_W]+ui_toolbar_w(true);
		ui_nodes_wx-=ui_toolbar_w(true);
		ui_nodes_wy=0;
	}
	i32 mx=mouse_x;
	i32 my=mouse_y;
	if(mx<ui_nodes_wx||mx>ui_nodes_wx+ww||my<ui_nodes_wy){
		return ;
	}
	if(ui_nodes_ui->is_typing||!ui_nodes_ui->input_enabled){
		return ;
	}
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	if(nodes->nodes_selected_id->length>0&&ui_nodes_ui->is_key_pressed){
		if(ui_nodes_ui->key_code==key_code_t_LEFT){
			for(i32 i=0;i<nodes->nodes_selected_id->length;++i){
				i32 n=nodes->nodes_selected_id->buffer[i];
				ui_node_t_array_t * _nodes=ui_nodes_get_canvas(true)->nodes;
				ui_get_node(_nodes,n)->x-=1;
			}
		}
		else if(ui_nodes_ui->key_code==key_code_t_RIGHT){
			for(i32 i=0;i<nodes->nodes_selected_id->length;++i){
				i32 n=nodes->nodes_selected_id->buffer[i];
				ui_node_t_array_t * _nodes=ui_nodes_get_canvas(true)->nodes;
				ui_get_node(_nodes,n)->x+=1;
			}
		}
		if(ui_nodes_ui->key_code==key_code_t_UP){
			for(i32 i=0;i<nodes->nodes_selected_id->length;++i){
				i32 n=nodes->nodes_selected_id->buffer[i];
				ui_node_t_array_t * _nodes=ui_nodes_get_canvas(true)->nodes;
				ui_get_node(_nodes,n)->y-=1;
			}
		}
		else if(ui_nodes_ui->key_code==key_code_t_DOWN){
			for(i32 i=0;i<nodes->nodes_selected_id->length;++i){
				i32 n=nodes->nodes_selected_id->buffer[i];
				ui_node_t_array_t * _nodes=ui_nodes_get_canvas(true)->nodes;
				ui_get_node(_nodes,n)->y+=1;
			}
		}
	}
	if(operator_shortcut(any_map_get(config_keymap,"node_search"),shortcut_type_t_STARTED)){
		ui_nodes_node_search(-1,-1,null);
	}
	if(ui_nodes_node_search_spawn!=null){
		ui_nodes_ui->input_x=mouse_x;
		ui_nodes_ui->input_y=mouse_y;
		gc_unroot(ui_nodes_node_search_spawn);ui_nodes_node_search_spawn=null;
	}
	if(operator_shortcut(any_map_get(config_keymap,"view_reset"),shortcut_type_t_STARTED)){
		nodes->pan_x=0.0;
		nodes->pan_y=0.0;
		nodes->zoom=1.0;
	}
}

void ui_nodes_canvas_changed(){
	ui_nodes_recompile_mat=true;
	ui_nodes_recompile_mat_final=true;
}

void ui_nodes_node_search(i32 x,i32 y,void(*done)(void)){
	_ui_nodes_node_search_first=true;
	gc_unroot(_ui_nodes_node_search_done);_ui_nodes_node_search_done=done;gc_root(_ui_nodes_node_search_done);
	ui_menu_draw(&ui_nodes_node_search_155517	,x,y);
}

void ui_nodes_node_search_155517(ui_t * ui){
ui_menu_h=ui_ELEMENT_H(ui)*8;
	ui_handle_t * search_handle=ui_handle("ui_nodes.ts:633");
	string_t * search=to_lower_case(ui_text_input(search_handle,"",ui_align_t_LEFT,true,true));
	ui->changed=false;
	if(_ui_nodes_node_search_first){
		_ui_nodes_node_search_first=false;
		search_handle->text="";
		ui_start_text_edit(search_handle,ui_align_t_LEFT);
	}
	if(search_handle->changed){
		ui_nodes_node_search_offset=0;
	}
	if(ui->is_key_pressed){
		if(ui->key_code==key_code_t_DOWN&&ui_nodes_node_search_offset<6){
			ui_nodes_node_search_offset++;
		}
		if(ui->key_code==key_code_t_UP&&ui_nodes_node_search_offset>0){
			ui_nodes_node_search_offset--;
		}
	}
	bool enter=keyboard_down("enter");
	i32 count=0;
	i32 BUTTON_COL=ui->ops->theme->BUTTON_COL;
	bool FILL_BUTTON_BG=ui->ops->theme->FILL_BUTTON_BG;
	ui->ops->theme->FILL_BUTTON_BG=true;
	node_list_t_array_t * node_list=ui_nodes_canvas_type==canvas_type_t_MATERIAL?nodes_material_list:nodes_brush_list;
	for(i32 i=0;i<node_list->length;++i){
		ui_node_t_array_t * list=node_list->buffer[i];
		for(i32 i=0;i<list->length;++i){
			ui_node_t * n=list->buffer[i];
			if(string_index_of(to_lower_case(tr(n->name,null)),search)>=0){
				ui->ops->theme->BUTTON_COL=count==ui_nodes_node_search_offset?ui->ops->theme->HIGHLIGHT_COL:ui->ops->theme->SEPARATOR_COL;
				if(ui_button(tr(n->name,null),ui_align_t_LEFT,"")||(enter&&count==ui_nodes_node_search_offset)){
					ui_nodes_push_undo(null);
					ui_nodes_t * nodes=ui_nodes_get_nodes();
					ui_node_canvas_t * canvas=ui_nodes_get_canvas(true);
					gc_unroot(ui_nodes_node_search_spawn);ui_nodes_node_search_spawn=ui_nodes_make_node(n,nodes,canvas);gc_root(ui_nodes_node_search_spawn);
					any_array_push(canvas->nodes,ui_nodes_node_search_spawn);
					nodes->nodes_selected_id=i32_array_create_from_raw((i32[]){ui_nodes_node_search_spawn->id,},1);
					nodes->nodes_drag=true;
					ui_nodes_hwnd->redraws=2;
					if(enter){
						ui->changed=true;
						count=6;
					}
					if(_ui_nodes_node_search_done!=null){
						_ui_nodes_node_search_done();
					}
				}
				if(++count>6){
					break;
				}
			}
		}
		if(count>6){
			break;
		}
	}
	if(enter&&count==0){
		ui->changed=true;
		search_handle->text="";
	}
	ui->ops->theme->BUTTON_COL=BUTTON_COL;
	ui->ops->theme->FILL_BUTTON_BG=FILL_BUTTON_BG;
}

i32 ui_nodes_get_node_x(){
	return math_floor((mouse_x-ui_nodes_wx-UI_NODES_PAN_X())/(float)UI_NODES_SCALE());
}

i32 ui_nodes_get_node_y(){
	return math_floor((mouse_y-ui_nodes_wy-UI_NODES_PAN_Y())/(float)UI_NODES_SCALE());
}

gpu_texture_t * ui_nodes_draw_grid(f32 zoom){
	i32 ww=config_raw->layout->buffer[layout_size_t_NODES_W];
	if(!ui_base_show){
		ww+=config_raw->layout->buffer[layout_size_t_SIDEBAR_W]+ui_toolbar_w(true);
	}
	i32 wh=sys_h();
	f32 step=ui_nodes_grid_cell_w*zoom;
	i32 mult=5*ui_SCALE(ui_nodes_ui);
	i32 w=math_floor(ww+step*mult);
	i32 h=math_floor(wh+step*mult);
	if(w<1){
		w=1;
	}
	if(h<1){
		h=1;
	}
	gpu_texture_t * grid=gpu_create_render_target(w,h,tex_format_t_RGBA32);
	draw_begin(grid,true,ui_nodes_ui->ops->theme->SEPARATOR_COL);
	i32 sep_col=ui_nodes_ui->ops->theme->SEPARATOR_COL;
	i32 line_primary=sep_col-0x00050505;
	if(line_primary<0xff000000){
		line_primary=sep_col+0x00050505;
	}
	i32 line_secondary=sep_col-0x00090909;
	if(line_secondary<0xff000000){
		line_secondary=sep_col+0x00090909;
	}
	draw_set_color(line_primary);
	step=ui_nodes_grid_small_cell_w*zoom;
	for(i32 i=0;i<math_floor(h/(float)step)+1;++i){
		draw_line(0,i*step,w,i*step,1.0);
	}
	for(i32 i=0;i<math_floor(w/(float)step)+1;++i){
		draw_line(i*step,0,i*step,h,1.0);
	}
	draw_set_color(line_secondary);
	step=ui_nodes_grid_cell_w*zoom;
	for(i32 i=0;i<math_floor(h/(float)step)+1;++i){
		draw_line(0,i*step,w,i*step,1.0);
	}
	for(i32 i=0;i<math_floor(w/(float)step)+1;++i){
		draw_line(i*step,0,i*step,h,1.0);
	}
	draw_end();
	return grid;
}

void ui_nodes_render(){
	if(ui_nodes_recompile_mat){
		if(ui_nodes_canvas_type==canvas_type_t_BRUSH){
			make_material_parse_brush();
			util_render_make_brush_preview();
			ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
		}
		else {
			slot_material_t * _material=context_raw->material;
			if(ui_nodes_is_tab_selected()){
				context_raw->material=ui_nodes_tabs->buffer[ui_nodes_tab_index()];
			}
			layers_is_fill_material()?layers_update_fill_layers():util_render_make_material_preview();
			context_raw->material=_material;
			if(ui_view2d_show&&ui_view2d_type==view_2d_type_t_NODE){
				ui_view2d_hwnd->redraws=2;
			}
		}
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
		if(context_raw->split_view){
			context_raw->ddirty=2;
		}
		ui_nodes_recompile_mat=false;
	}
	else if(ui_nodes_recompile_mat_final){
		make_material_parse_paint_material(true);
		if(ui_nodes_canvas_type==canvas_type_t_MATERIAL&&layers_is_fill_material()){
			layers_update_fill_layers();
			util_render_make_material_preview();
		}
		bool decal=context_is_decal();
		if(decal){
			util_render_make_decal_preview();
		}
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
		context_raw->node_preview_dirty=true;
		ui_nodes_recompile_mat_final=false;
	}
	ui_nodes_t * nodes=ui_nodes_get_nodes();
	if(nodes->nodes_selected_id->length>0&&nodes->nodes_selected_id->buffer[0]!=ui_nodes_last_node_selected_id){
		ui_nodes_last_node_selected_id=nodes->nodes_selected_id->buffer[0];
		context_raw->node_preview_dirty=true;
		context_raw->node_preview_socket=0;
	}
	ui_node_canvas_t * c=ui_nodes_get_canvas(true);
	if(ui_nodes_release_link&&nodes->link_drag_id!=-1){
		array_remove(c->links,ui_get_link(c->links,nodes->link_drag_id));
		nodes->link_drag_id=-1;
	}
	ui_nodes_release_link=ui_nodes_ui->input_released;
	if(!ui_nodes_show||iron_window_width()==0||iron_window_height()==0){
		return ;
	}
	ui_nodes_ui->input_enabled=base_ui_enabled;
	if(ui_nodes_grid_redraw){
		if(ui_nodes_grid!=null){
			iron_delete_texture(ui_nodes_grid);
		}
		ui_nodes_t * ui_nodes=ui_nodes_get_nodes();
		gc_unroot(ui_nodes_grid);ui_nodes_grid=ui_nodes_draw_grid(ui_nodes->zoom);gc_root(ui_nodes_grid);
		ui_nodes_grid_redraw=false;
	}
	if(config_raw->node_preview&&context_raw->node_preview_dirty){
		ui_nodes_make_node_preview();
	}
	ui_begin(ui_nodes_ui);
	ui_nodes_ww=config_raw->layout->buffer[layout_size_t_NODES_W];
	ui_nodes_wx=math_floor(sys_w())+ui_toolbar_w(true);
	ui_nodes_wy=0;
	if(!ui_base_show){
		ui_nodes_ww+=config_raw->layout->buffer[layout_size_t_SIDEBAR_W]+ui_toolbar_w(true);
		ui_nodes_wx-=ui_toolbar_w(true);
	}
	i32 ew=math_floor(ui_ELEMENT_W(ui_nodes_ui)*0.7);
	ui_nodes_wh=sys_h();
	if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
		ui_nodes_wh+=ui_header_h*2;
	}
	if(ui_view2d_show){
		ui_nodes_wh=config_raw->layout->buffer[layout_size_t_NODES_H];
		ui_nodes_wy=sys_h()-config_raw->layout->buffer[layout_size_t_NODES_H]+ui_header_h;
		if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
			ui_nodes_wy+=ui_header_h;
		}
		if(!ui_base_show){
			ui_nodes_wy-=ui_header_h*2;
		}
	}
	if(ui_window(ui_nodes_hwnd,ui_nodes_wx,ui_nodes_wy,ui_nodes_ww,ui_nodes_wh,false)){
		ui_tab(ui_nodes_htab,tr("Nodes",null),false,-1);
		if(ui_nodes_canvas_type==canvas_type_t_MATERIAL){
			if(ui_nodes_tabs==null){
				gc_unroot(ui_nodes_tabs);ui_nodes_tabs=any_array_create_from_raw((any[]){},0);gc_root(ui_nodes_tabs);
			}
			for(i32 i=0;i<ui_nodes_tabs->length;++i){
				ui_tab(ui_nodes_htab,ui_nodes_tabs->buffer[i]->canvas->name,false,-1);
				if(ui_tab(ui_nodes_htab,tr("x",null),false,-1)){
					array_splice(ui_nodes_tabs,i,1);
					ui_nodes_htab->position=0;
				}
			}
			if(ui_tab(ui_nodes_htab,tr("+",null),false,-1)){
				any_array_push(ui_nodes_tabs,context_raw->material);
			}
		}
		draw_set_color(0xffffffff);
		f32 step=ui_nodes_grid_cell_w*nodes->zoom;
		f32 x=math_fmod(UI_NODES_PAN_X(),step)-step;
		f32 y=math_fmod(UI_NODES_PAN_Y(),step)-step;
		draw_image(ui_nodes_grid,x,y);
		if(ui_nodes_ui->input_started||ui_nodes_ui->is_key_pressed){
			gc_unroot(ui_nodes_last_canvas);ui_nodes_last_canvas=util_clone_canvas(ui_nodes_get_canvas(true));gc_root(ui_nodes_last_canvas);
		}
		bool _input_enabled=ui_nodes_ui->input_enabled;
		ui_nodes_ui->input_enabled=_input_enabled&&!ui_nodes_show_menu;
		ui_nodes_ui->window_border_right=config_raw->layout->buffer[layout_size_t_SIDEBAR_W];
		ui_nodes_ui->window_border_top=ui_header_h*2;
		ui_nodes_ui->window_border_bottom=config_raw->layout->buffer[layout_size_t_STATUS_H];
		ui_node_canvas(nodes,c);
		ui_nodes_ui->input_enabled=_input_enabled;
		if(nodes->color_picker_callback!=null){
			context_raw->color_picker_previous_tool=context_raw->tool;
			context_select_tool(workspace_tool_t_PICKER);
			gc_unroot(_ui_nodes_render_tmp);_ui_nodes_render_tmp=nodes->color_picker_callback;gc_root(_ui_nodes_render_tmp);
			context_raw->color_picker_callback=&ui_nodes_render_157114;
			;
			nodes->color_picker_callback=null;
		}
		if(ui_is_paste){
			node_list_t_array_t * node_list=ui_nodes_canvas_type==canvas_type_t_MATERIAL?nodes_material_list:nodes_brush_list;
			i32 i=0;
			while(i++<c->nodes->length){
				ui_node_t * canvas_node=c->nodes->buffer[i-1];
				if(char_ptr_array_index_of(ui_nodes_exclude_remove,canvas_node->type)>=0){
					continue;
				}
				bool found=false;
				for(i32 i=0;i<node_list->length;++i){
					ui_node_t_array_t * list=node_list->buffer[i];
					for(i32 i=0;i<list->length;++i){
						ui_node_t * list_node=list->buffer[i];
						if(string_equals(canvas_node->type,list_node->type)){
							found=true;
							break;
						}
					}
					if(found){
						break;
					}
				}
				if(string_equals(canvas_node->type,"GROUP")&&!ui_nodes_can_place_group(canvas_node->name)){
					found=false;
				}
				if(!found){
					ui_remove_node(canvas_node,c);
					i32_array_remove(nodes->nodes_selected_id,canvas_node->id);
					i--;
				}
			}
		}
		if(ui_nodes_is_node_menu_op){
			ui_is_copy=false;
			ui_is_cut=false;
			ui_is_paste=false;
			ui_nodes_ui->is_delete_down=false;
		}
		if(ui_nodes_ui->changed){
			ui_nodes_recompile_mat=(ui_nodes_ui->input_dx!=0||ui_nodes_ui->input_dy!=0||!ui_nodes_uichanged_last)&&config_raw->material_live;
		}
		else if(ui_nodes_uichanged_last){
			ui_nodes_canvas_changed();
			ui_nodes_push_undo(ui_nodes_last_canvas);
		}
		ui_nodes_uichanged_last=ui_nodes_ui->changed;
		if(config_raw->node_preview&&nodes->nodes_selected_id->length>0){
			gpu_texture_t * img=null;
			ui_node_t * sel=ui_get_node(c->nodes,nodes->nodes_selected_id->buffer[0]);
			bool single_channel=string_equals(sel->type,"LAYER_MASK");
			if(string_equals(sel->type,"LAYER")||string_equals(sel->type,"LAYER_MASK")){
				i32 id=sel->buttons->buffer[0]->default_value->buffer[0];
				if(id<project_layers->length){
					img=project_layers->buffer[id]->texpaint_preview;
				}
			}
			else if(string_equals(sel->type,"MATERIAL")){
				i32 id=sel->buttons->buffer[0]->default_value->buffer[0];
				if(id<project_materials->length){
					img=project_materials->buffer[id]->image;
				}
			}
			else if(string_equals(sel->type,"OUTPUT_MATERIAL_PBR")){
				img=context_raw->material->image;
			}
			else if(string_equals(sel->type,"brush_output_node")){
				img=context_raw->brush->image;
			}
			else if(ui_nodes_canvas_type==canvas_type_t_MATERIAL){
				img=context_raw->node_preview;
			}
			if(img!=null){
				f32 tw=128*ui_SCALE(ui_nodes_ui);
				f32 th=tw*(img->height/(float)img->width);
				f32 tx=ui_nodes_ww-tw-8*ui_SCALE(ui_nodes_ui);
				f32 ty=ui_nodes_wh-th-8*ui_SCALE(ui_nodes_ui);
				bool invert_y=false;
				if(single_channel){
					draw_set_pipeline(ui_view2d_pipe);
					gpu_set_int(ui_view2d_channel_loc,1);
				}
				draw_set_color(0xffffffff);
				invert_y?draw_scaled_image(img,tx,ty+th,tw,-th):draw_scaled_image(img,tx,ty,tw,th);
				if(single_channel){
					draw_set_pipeline(null);
				}
			}
		}
		draw_set_color(ui_nodes_ui->ops->theme->SEPARATOR_COL);
		draw_filled_rect(0,ui_ELEMENT_H(ui_nodes_ui),ui_nodes_ww,ui_ELEMENT_H(ui_nodes_ui)+ui_ELEMENT_OFFSET(ui_nodes_ui)*2);
		draw_set_color(0xffffffff);
		i32 start_y=ui_ELEMENT_H(ui_nodes_ui)+ui_ELEMENT_OFFSET(ui_nodes_ui);
		ui_nodes_ui->_x=0;
		ui_nodes_ui->_y=2+start_y;
		ui_nodes_ui->_w=ew;
		ui_handle_t * h=ui_handle("ui_nodes.ts:1138");
		h->text=string_copy(c->name);
		ui_nodes_ui->_w=math_floor(math_min(draw_string_width(ui_nodes_ui->ops->font,ui_nodes_ui->font_size,h->text)+15*ui_SCALE(ui_nodes_ui),100*ui_SCALE(ui_nodes_ui)));
		string_t * new_name=ui_text_input(h,"",ui_align_t_LEFT,true,false);
		ui_nodes_ui->_x+=ui_nodes_ui->_w+3;
		ui_nodes_ui->_y=2+start_y;
		ui_nodes_ui->_w=ew;
		if(h->changed){
			if(ui_nodes_group_stack->length>0){
				bool can_rename=true;
				for(i32 i=0;i<project_material_groups->length;++i){
					node_group_t * m=project_material_groups->buffer[i];
					if(string_equals(m->canvas->name,new_name)){
						can_rename=false;
					}
				}
				if(can_rename){
					string_t * old_name=c->name;
					c->name=string_copy(new_name);
					ui_node_canvas_t_array_t * canvases=any_array_create_from_raw((any[]){},0);
					for(i32 i=0;i<project_materials->length;++i){
						slot_material_t * m=project_materials->buffer[i];
						any_array_push(canvases,m->canvas);
					}
					for(i32 i=0;i<project_material_groups->length;++i){
						node_group_t * m=project_material_groups->buffer[i];
						any_array_push(canvases,m->canvas);
					}
					for(i32 i=0;i<canvases->length;++i){
						ui_node_canvas_t * canvas=canvases->buffer[i];
						for(i32 i=0;i<canvas->nodes->length;++i){
							ui_node_t * n=canvas->nodes->buffer[i];
							if(string_equals(n->type,"GROUP")&&string_equals(n->name,old_name)){
								n->name=string_copy(c->name);
							}
						}
					}
				}
			}
			else {
				c->name=string_copy(new_name);
			}
		}
		i32 _BUTTON_COL=ui_nodes_ui->ops->theme->BUTTON_COL;
		ui_nodes_ui->ops->theme->BUTTON_COL=ui_nodes_ui->ops->theme->SEPARATOR_COL;
		string_t_array_t * cats=ui_nodes_canvas_type==canvas_type_t_MATERIAL?nodes_material_categories:nodes_brush_categories;
		for(i32 i=0;i<cats->length;++i){
			if((_ui_menu_button(tr(cats->buffer[i],null)))||(ui_nodes_ui->is_hovered&&ui_nodes_show_menu)){
				ui_nodes_show_menu=true;
				ui_nodes_menu_category=i;
				ui_nodes_popup_x=ui_nodes_wx+ui_nodes_ui->_x;
				ui_nodes_popup_y=ui_nodes_wy+ui_nodes_ui->_y;
				if(config_raw->touch_ui){
					ui_nodes_show_menu_first=true;
					i32 menuw=math_floor(ew*2.3);
					ui_nodes_popup_x-=menuw/(float)2;
					ui_nodes_popup_x+=ui_nodes_ui->_w/(float)2;
				}
			}
			ui_nodes_ui->_x+=ui_nodes_ui->_w+3;
			ui_nodes_ui->_y=2+start_y;
		}
		if(config_raw->touch_ui){
			i32 _w=ui_nodes_ui->_w;
			ui_nodes_ui->_w=math_floor(36*ui_SCALE(ui_nodes_ui));
			ui_nodes_ui->_y=4*ui_SCALE(ui_nodes_ui)+start_y;
			if(ui_menubar_icon_button(ui_nodes_ui,2,3)){
				ui_nodes_node_search(math_floor(ui_nodes_ui->_window_x+ui_nodes_ui->_x),math_floor(ui_nodes_ui->_window_y+ui_nodes_ui->_y),null);
			}
			ui_nodes_ui->_w=_w;
		}
		else {
			if(_ui_menu_button(tr("Search",null))){
				ui_nodes_node_search_x=ui_nodes_ui->_window_x+ui_nodes_ui->_x;
				ui_nodes_node_search_y=ui_nodes_ui->_window_y+ui_nodes_ui->_y;
				sys_notify_on_init(&ui_nodes_render_158303				,null);
			}
		}
		if(ui_nodes_ui->is_hovered){
			ui_tooltip(string_join(string_join(string_join(tr("Search for nodes",null)," ("),any_map_get(config_keymap,"node_search")),")"));
		}
		ui_nodes_ui->_x+=ui_nodes_ui->_w+3;
		ui_nodes_ui->_y=2+start_y;
		ui_nodes_ui->ops->theme->BUTTON_COL=_BUTTON_COL;
		if(ui_nodes_group_stack->length>0&&_ui_menu_button(tr("Close",null))){
			array_pop(ui_nodes_group_stack);
		}
	}
	ui_end(!ui_nodes_show_menu);
	if(ui_nodes_show_menu){
		node_list_t_array_t * list=ui_nodes_canvas_type==canvas_type_t_MATERIAL?nodes_material_list:nodes_brush_list;
		ui_node_t_array_t * category=list->buffer[ui_nodes_menu_category];
		i32 num_nodes=category->length;
		bool is_group_category=ui_nodes_canvas_type==canvas_type_t_MATERIAL&&string_equals(nodes_material_categories->buffer[ui_nodes_menu_category],"Group");
		if(is_group_category){
			num_nodes+=project_material_groups->length;
		}
		i32 py=ui_nodes_popup_y;
		i32 menuw=math_floor(ew*2.3);
		draw_begin(null,false,0);
		ui_begin_region(ui_nodes_ui,math_floor(ui_nodes_popup_x),math_floor(py),menuw);
		i32 _FILL_BUTTON_BG=ui_nodes_ui->ops->theme->FILL_BUTTON_BG;
		ui_nodes_ui->ops->theme->FILL_BUTTON_BG=false;
		i32 _ELEMENT_OFFSET=ui_nodes_ui->ops->theme->ELEMENT_OFFSET;
		ui_nodes_ui->ops->theme->ELEMENT_OFFSET=0;
		i32 _ELEMENT_H=ui_nodes_ui->ops->theme->ELEMENT_H;
		ui_nodes_ui->ops->theme->ELEMENT_H=config_raw->touch_ui?(28+2):28;
		ui_menu_h=category->length*ui_ELEMENT_H(ui_nodes_ui);
		if(is_group_category){
			ui_menu_h+=project_material_groups->length*ui_ELEMENT_H(ui_nodes_ui);
		}
		ui_menu_start(ui_nodes_ui);
		for(i32 i=0;i<category->length;++i){
			ui_node_t * n=category->buffer[i];
			if(ui_menu_button(ui_nodes_ui,tr(n->name,null))){
				ui_nodes_push_undo(null);
				ui_node_canvas_t * canvas=ui_nodes_get_canvas(true);
				ui_nodes_t * nodes=ui_nodes_get_nodes();
				ui_node_t * node=ui_nodes_make_node(n,nodes,canvas);
				any_array_push(canvas->nodes,node);
				nodes->nodes_selected_id=i32_array_create_from_raw((i32[]){node->id,},1);
				nodes->nodes_drag=true;
			}
			if(ui_nodes_ui->_y-ui_nodes_wy+ui_ELEMENT_H(ui_nodes_ui)/(float)2>ui_nodes_wh){
				ui_nodes_ui->_x+=menuw;
				ui_nodes_ui->_y=py;
			}
		}
		if(is_group_category){
			for(i32 i=0;i<project_material_groups->length;++i){
				node_group_t * g=project_material_groups->buffer[i];
				ui_nodes_ui->enabled=ui_nodes_can_place_group(g->canvas->name);
				f32_array_t * row=f32_array_create_from_raw((f32[]){5/(float)6,1/(float)6,},2);
				ui_row(row);
				if(ui_button(string_join(config_button_spacing,g->canvas->name),ui_align_t_LEFT,"")){
					ui_nodes_push_undo(null);
					ui_node_canvas_t * canvas=ui_nodes_get_canvas(true);
					ui_nodes_t * nodes=ui_nodes_get_nodes();
					ui_node_t * node=ui_nodes_make_group_node(g->canvas,nodes,canvas);
					any_array_push(canvas->nodes,node);
					nodes->nodes_selected_id=i32_array_create_from_raw((i32[]){node->id,},1);
					nodes->nodes_drag=true;
				}
				ui_nodes_ui->enabled=!project_is_material_group_in_use(g);
				if(ui_button("x",ui_align_t_CENTER,"")){
					history_delete_material_group(g);
					array_remove(project_material_groups,g);
				}
				ui_nodes_ui->enabled=true;
			}
		}
		ui_nodes_hide_menu=ui_nodes_ui->combo_selected_handle==null&&!ui_nodes_show_menu_first&&(ui_nodes_ui->changed||ui_nodes_ui->input_released||ui_nodes_ui->input_released_r||ui_nodes_ui->is_escape_down);
		ui_nodes_show_menu_first=false;
		ui_nodes_ui->ops->theme->FILL_BUTTON_BG=_FILL_BUTTON_BG;
		ui_nodes_ui->ops->theme->ELEMENT_OFFSET=_ELEMENT_OFFSET;
		ui_nodes_ui->ops->theme->ELEMENT_H=_ELEMENT_H;
		ui_menu_end(ui_nodes_ui);
		ui_end_region(true);
		draw_end();
	}
	if(ui_nodes_hide_menu){
		ui_nodes_show_menu=false;
		ui_nodes_show_menu_first=true;
	}
}

void ui_nodes_render_158303(){
ui_nodes_node_search(math_floor(ui_nodes_node_search_x),math_floor(ui_nodes_node_search_y),null);
}

void ui_nodes_render_157114(swatch_color_t * color){
_ui_nodes_render_tmp(color->base);
			ui_nodes_hwnd->redraws=2;
			bool material_live=config_raw->material_live;
			if(material_live){
				ui_nodes_canvas_changed();
			}
}

bool ui_nodes_contains_node_group_recursive(node_group_t * group,string_t * group_name){
	if(string_equals(group->canvas->name,group_name)){
		return true;
	}
	for(i32 i=0;i<group->canvas->nodes->length;++i){
		ui_node_t * n=group->canvas->nodes->buffer[i];
		if(string_equals(n->type,"GROUP")){
			node_group_t * g=project_get_material_group_by_name(n->name);
			if(g!=null&&ui_nodes_contains_node_group_recursive(g,group_name)){
				return true;
			}
		}
	}
	return false;
}

bool ui_nodes_can_place_group(string_t * group_name){
	if(ui_nodes_group_stack->length>0){
		for(i32 i=0;i<ui_nodes_group_stack->length;++i){
			node_group_t * g=ui_nodes_group_stack->buffer[i];
			if(ui_nodes_contains_node_group_recursive(project_get_material_group_by_name(group_name),g->canvas->name))return false;
		}
	}
	bool group_exists=false;
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * group=project_material_groups->buffer[i];
		if(string_equals(group_name,group->canvas->name)){
			group_exists=true;
		}
	}
	if(!group_exists){
		return false;
	}
	return true;
}

void ui_nodes_push_undo(ui_node_canvas_t * last_canvas){
	if(last_canvas==null){
		last_canvas=ui_nodes_get_canvas(true);
	}
	i32 canvas_group=-1;
	if(ui_nodes_group_stack->length>0){
		canvas_group=array_index_of(project_material_groups,ui_nodes_group_stack->buffer[ui_nodes_group_stack->length-1]);
	}
	ui_base_hwnds->buffer[tab_area_t_SIDEBAR0]->redraws=2;
	history_edit_nodes(last_canvas,ui_nodes_canvas_type,canvas_group);
}

void ui_nodes_accept_asset_drag(i32 index){
	ui_nodes_push_undo(null);
	node_group_t * g=ui_nodes_group_stack->length>0?ui_nodes_group_stack->buffer[ui_nodes_group_stack->length-1]:null;
	ui_node_t * n=ui_nodes_canvas_type==canvas_type_t_MATERIAL?nodes_material_create_node("TEX_IMAGE",g):nodes_brush_create_node("TEX_IMAGE");
	n->buttons->buffer[0]->default_value->buffer[0]=index;
	ui_nodes_get_nodes()->nodes_selected_id=i32_array_create_from_raw((i32[]){n->id,},1);
}

void ui_nodes_accept_layer_drag(i32 index){
	ui_nodes_push_undo(null);
	if(slot_layer_is_group(project_layers->buffer[index])){
		return ;
	}
	node_group_t * g=ui_nodes_group_stack->length>0?ui_nodes_group_stack->buffer[ui_nodes_group_stack->length-1]:null;
	ui_node_t * n=nodes_material_create_node(slot_layer_is_mask(context_raw->layer)?"LAYER_MASK":"LAYER",g);
	n->buttons->buffer[0]->default_value->buffer[0]=index;
	ui_nodes_get_nodes()->nodes_selected_id=i32_array_create_from_raw((i32[]){n->id,},1);
}

void ui_nodes_accept_material_drag(i32 index){
	ui_nodes_push_undo(null);
	node_group_t * g=ui_nodes_group_stack->length>0?ui_nodes_group_stack->buffer[ui_nodes_group_stack->length-1]:null;
	ui_node_t * n=nodes_material_create_node("MATERIAL",g);
	n->buttons->buffer[0]->default_value->buffer[0]=index;
	ui_nodes_get_nodes()->nodes_selected_id=i32_array_create_from_raw((i32[]){n->id,},1);
}

void ui_nodes_accept_swatch_drag(swatch_color_t * swatch){
	ui_nodes_push_undo(null);
	node_group_t * g=ui_nodes_group_stack->length>0?ui_nodes_group_stack->buffer[ui_nodes_group_stack->length-1]:null;
	ui_node_t * n=nodes_material_create_node("RGB",g);
	n->outputs->buffer[0]->default_value=f32_array_create_xyzw(color_get_rb(swatch->base)/(float)255,color_get_gb(swatch->base)/(float)255,color_get_bb(swatch->base)/(float)255,color_get_ab(swatch->base)/(float)255);
	ui_nodes_get_nodes()->nodes_selected_id=i32_array_create_from_raw((i32[]){n->id,},1);
}

ui_node_t * ui_nodes_make_node(ui_node_t * n,ui_nodes_t * nodes,ui_node_canvas_t * canvas){
	ui_node_t * node=GC_ALLOC_INIT(ui_node_t, {0});
	node->id=ui_next_node_id(canvas->nodes);
	node->name=string_copy(n->name);
	node->type=string_copy(n->type);
	node->x=ui_nodes_get_node_x();
	node->y=ui_nodes_get_node_y();
	node->color=n->color;
	node->inputs=any_array_create_from_raw((any[]){},0);
	node->outputs=any_array_create_from_raw((any[]){},0);
	node->buttons=any_array_create_from_raw((any[]){},0);
	node->width=0;
	i32 count=0;
	for(i32 i=0;i<n->inputs->length;++i){
		ui_node_socket_t * soc=GC_ALLOC_INIT(ui_node_socket_t, {0});
		soc->id=ui_get_socket_id(canvas->nodes)+count;
		count++;
		soc->node_id=node->id;
		soc->name=string_copy(n->inputs->buffer[i]->name);
		soc->type=string_copy(n->inputs->buffer[i]->type);
		soc->color=n->inputs->buffer[i]->color;
		soc->default_value=f32_array_create_from_array(n->inputs->buffer[i]->default_value);
		soc->min=n->inputs->buffer[i]->min;
		soc->max=n->inputs->buffer[i]->max;
		soc->precision=n->inputs->buffer[i]->precision;
		soc->display=n->inputs->buffer[i]->display;
		any_array_push(node->inputs,soc);
	}
	for(i32 i=0;i<n->outputs->length;++i){
		ui_node_socket_t * soc=GC_ALLOC_INIT(ui_node_socket_t, {0});
		soc->id=ui_get_socket_id(canvas->nodes)+count;
		count++;
		soc->node_id=node->id;
		soc->name=string_copy(n->outputs->buffer[i]->name);
		soc->type=string_copy(n->outputs->buffer[i]->type);
		soc->color=n->outputs->buffer[i]->color;
		soc->default_value=f32_array_create_from_array(n->outputs->buffer[i]->default_value);
		soc->min=n->outputs->buffer[i]->min;
		soc->max=n->outputs->buffer[i]->max;
		soc->precision=n->outputs->buffer[i]->precision;
		soc->display=n->outputs->buffer[i]->display;
		any_array_push(node->outputs,soc);
	}
	for(i32 i=0;i<n->buttons->length;++i){
		ui_node_button_t * but=GC_ALLOC_INIT(ui_node_button_t, {0});
		but->name=string_copy(n->buttons->buffer[i]->name);
		but->type=string_copy(n->buttons->buffer[i]->type);
		but->output=n->buttons->buffer[i]->output;
		but->default_value=f32_array_create_from_array(n->buttons->buffer[i]->default_value);
		if(n->buttons->buffer[i]->data!=null){
			but->data=u8_array_create_from_array(n->buttons->buffer[i]->data);
		}
		but->min=n->buttons->buffer[i]->min;
		but->max=n->buttons->buffer[i]->max;
		but->precision=n->buttons->buffer[i]->precision;
		but->height=n->buttons->buffer[i]->height;
		any_array_push(node->buttons,but);
	}
	return node;
}

ui_node_t * ui_nodes_make_group_node(ui_node_canvas_t * group_canvas,ui_nodes_t * nodes,ui_node_canvas_t * canvas){
	ui_node_t_array_t * category=nodes_material_list->buffer[5];
	ui_node_t * n=category->buffer[0];
	ui_node_t * node=util_clone_canvas_node(n);
	node->name=string_copy(group_canvas->name);
	node->id=ui_next_node_id(canvas->nodes);
	node->x=ui_nodes_get_node_x();
	node->y=ui_nodes_get_node_y();
	ui_node_t * group_input=null;
	ui_node_t * group_output=null;
	for(i32 i=0;i<project_material_groups->length;++i){
		node_group_t * g=project_material_groups->buffer[i];
		string_t * cname=g->canvas->name;
		if(string_equals(cname,node->name)){
			for(i32 i=0;i<g->canvas->nodes->length;++i){
				ui_node_t * n=g->canvas->nodes->buffer[i];
				if(string_equals(n->type,"GROUP_INPUT")){
					group_input=n;
				}
				else if(string_equals(n->type,"GROUP_OUTPUT")){
					group_output=n;
				}
			}
			break;
		}
	}
	if(group_input!=null&&group_output!=null){
		for(i32 i=0;i<group_input->outputs->length;++i){
			ui_node_socket_t * soc=group_input->outputs->buffer[i];
			any_array_push(node->inputs,nodes_material_create_socket(nodes,node,soc->name,soc->type,canvas,soc->min,soc->max,soc->default_value));
		}
		for(i32 i=0;i<group_output->inputs->length;++i){
			ui_node_socket_t * soc=group_output->inputs->buffer[i];
			any_array_push(node->outputs,nodes_material_create_socket(nodes,node,soc->name,soc->type,canvas,soc->min,soc->max,soc->default_value));
		}
	}
	return node;
}

void ui_nodes_make_node_preview(){
	ui_nodes_t * ui_nodes=context_raw->material->nodes;
	if(ui_nodes->nodes_selected_id->length==0){
		return ;
	}
	ui_node_t_array_t * nodes=context_raw->material->canvas->nodes;
	ui_node_t * node=ui_get_node(nodes,ui_nodes->nodes_selected_id->buffer[0]);
	context_raw->node_preview_name=string_copy(node->name);
	if(string_equals(node->type,"LAYER")||string_equals(node->type,"LAYER_MASK")||string_equals(node->type,"MATERIAL")||string_equals(node->type,"OUTPUT_MATERIAL_PBR")){
		return ;
	}
	if(array_index_of(nodes,node)==-1){
		return ;
	}
	if(context_raw->node_preview==null){
		context_raw->node_preview=gpu_create_render_target(util_render_material_preview_size,util_render_material_preview_size,tex_format_t_RGBA32);
	}
	context_raw->node_preview_dirty=false;
	ui_nodes_hwnd->redraws=2;
	util_render_make_node_preview(context_raw->material->canvas,node,context_raw->node_preview,null,null);
}

bool ui_nodes_has_group(ui_node_canvas_t * c){
	for(i32 i=0;i<c->nodes->length;++i){
		ui_node_t * n=c->nodes->buffer[i];
		if(string_equals(n->type,"GROUP")){
			return true;
		}
	}
	return false;
}

void ui_nodes_traverse_group(ui_node_canvas_t_array_t * mgroups,ui_node_canvas_t * c){
	for(i32 i=0;i<c->nodes->length;++i){
		ui_node_t * n=c->nodes->buffer[i];
		if(string_equals(n->type,"GROUP")){
			if(ui_nodes_get_group(mgroups,n->name)==null){
				ui_node_canvas_t_array_t * canvases=any_array_create_from_raw((any[]){},0);
				for(i32 i=0;i<project_material_groups->length;++i){
					node_group_t * g=project_material_groups->buffer[i];
					any_array_push(canvases,g->canvas);
				}
				ui_node_canvas_t * group=ui_nodes_get_group(canvases,n->name);
				any_array_push(mgroups,util_clone_canvas(group));
				ui_nodes_traverse_group(mgroups,group);
			}
		}
	}
}

ui_node_canvas_t * ui_nodes_get_group(ui_node_canvas_t_array_t * canvases,string_t * name){
	for(i32 i=0;i<canvases->length;++i){
		ui_node_canvas_t * c=canvases->buffer[i];
		if(string_equals(c->name,name)){
			return c;
		}
	}
	return null;
}

void ui_status_init(){
}

i32 ui_status_width(){
	return iron_window_width()-ui_toolbar_w(true)-config_raw->layout->buffer[layout_size_t_SIDEBAR_W];
}

void ui_status_render_ui(){
	ui_t * ui=ui_base_ui;
	i32 statush=config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_window(ui_base_hwnds->buffer[tab_area_t_STATUS],sys_x(),iron_window_height()-statush,ui_status_width(),statush,false)){
		ui->_y+=2;
		draw_set_color(ui->ops->theme->SEPARATOR_COL);
		draw_filled_rect(0,0,1,ui->_window_h);
		draw_filled_rect(ui->_window_w-1,0,1,ui->_window_h);
		tab_draw_t_array_t * hwnd_draws=ui_base_hwnd_tabs->buffer[tab_area_t_STATUS];
		ui_handle_t * htab=ui_base_htabs->buffer[tab_area_t_STATUS];
		for(i32 i=0;i<hwnd_draws->length;++i){
			tab_draw_t * draw=hwnd_draws->buffer[i];
			draw->f(htab);
		}
		bool minimized=statush<=ui_status_default_status_h*config_raw->window_scale;
		if(htab->changed&&(htab->position==context_raw->last_status_position||minimized)){
			ui_base_toggle_browser();
		}
		context_raw->last_status_position=htab->position;
	}
}

void ui_status_draw_version_tab(ui_handle_t * htab){
	if(!config_raw->touch_ui){
		ui_t * ui=ui_base_ui;
		ui->enabled=false;
		ui_tab(ui_base_htabs->buffer[tab_area_t_STATUS],manifest_version,false,-1);
		ui->enabled=true;
	}
}

void ui_toolbar_init(){
}

void ui_toolbar_draw_tool(i32 i,ui_t * ui,gpu_texture_t * img,i32 icon_accent,string_t_array_t * keys){
	ui->_x+=2;
	if(context_raw->tool==i){
		ui_toolbar_draw_highlight();
	}
	i32 tile_y=math_floor(i/(float)12);
	i32 tile_x=tile_y%2==0?i%12:(11-(i%12));
	rect_t * rect=resource_tile50(img,tile_x,tile_y);
	i32 _y=ui->_y;
	ui_state_t image_state=_ui_image(img,icon_accent,-1.0,rect->x,rect->y,rect->w,rect->h);
	if(image_state==ui_state_t_STARTED){
		_ui_toolbar_i=i;
		sys_notify_on_next_frame(&ui_toolbar_draw_tool_161114		,null);
	}
	else if(image_state==ui_state_t_RELEASED&&config_raw->layout->buffer[layout_size_t_HEADER]==0){
		if(ui_toolbar_last_tool==i){
			ui_toolbar_tool_properties_menu();
		}
		ui_toolbar_last_tool=i;
	}
	if(i==workspace_tool_t_COLORID&&context_raw->colorid_picked){
		render_target_t * rt=any_map_get(render_path_render_targets,"texpaint_colorid");
		draw_scaled_sub_image(rt->_image,0,0,1,1,0,_y+1.5*ui_SCALE(ui),5*ui_SCALE(ui),34*ui_SCALE(ui));
	}
	if(ui->is_hovered){
		ui_tooltip(string_join(string_join(tr(ui_toolbar_tool_names->buffer[i],null)," "),keys->buffer[i]));
	}
	ui->_x-=2;
	ui->_y+=2;
}

void ui_toolbar_draw_tool_161114(){
context_select_tool(_ui_toolbar_i);
}

i32 ui_toolbar_w(bool screen_size_request){
	if(screen_size_request&&context_is_floating_toolbar()){
		return 0;
	}
	i32 w=0;
	if(config_raw->touch_ui){
		w=ui_toolbar_default_w+6;
	}
	else {
		w=ui_toolbar_default_w;
	}
	w=math_floor(w*config_raw->window_scale);
	return w;
}

i32 ui_toolbar_x(){
	ui_t * ui=ui_base_ui;
	return 5*ui_SCALE(ui);
}

void ui_toolbar_render_ui(){
	ui_t * ui=ui_base_ui;
	i32 x=0;
	i32 y=ui_header_h;
	i32 h=iron_window_height()-ui_header_h;
	i32 _WINDOW_BG_COL=ui->ops->theme->WINDOW_BG_COL;
	if(context_is_floating_toolbar()){
		x+=ui_toolbar_x();
		y+=ui_toolbar_x();
		h=ui_toolbar_tool_names->length*(ui_toolbar_w(false)+2);
		ui->ops->theme->WINDOW_BG_COL=ui->ops->theme->SEPARATOR_COL;
	}
	if(ui_window(ui_toolbar_handle,x,y,ui_toolbar_w(false),h,false)){
		ui->_y-=4*ui_SCALE(ui);
		ui->image_scroll_align=false;
		gpu_texture_t * img=resource_get("icons.k");
		u32 col=ui->ops->theme->WINDOW_BG_COL;
		bool light=col>0xff666666;
		i32 icon_accent=light?0xff666666:-1;
		if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
			rect_t * rect=resource_tile50(img,7,1);
			if(_ui_image(img,light?0xff666666:ui->ops->theme->BUTTON_COL,-1.0,rect->x,rect->y,rect->w,rect->h)==ui_state_t_RELEASED){
				config_raw->layout->buffer[layout_size_t_HEADER]=0;
			}
		}
		else {
			i32 _ELEMENT_H=ui->ops->theme->ELEMENT_H;
			i32 _BUTTON_H=ui->ops->theme->BUTTON_H;
			i32 _BUTTON_COL=ui->ops->theme->BUTTON_COL;
			i32 _fontOffsetY=ui->font_offset_y;
			ui->ops->theme->ELEMENT_H=math_floor(ui->ops->theme->ELEMENT_H*1.5);
			ui->ops->theme->BUTTON_H=ui->ops->theme->ELEMENT_H;
			ui->ops->theme->BUTTON_COL=ui->ops->theme->WINDOW_BG_COL;
			i32 font_height=draw_font_height(ui->ops->font,ui->font_size);
			ui->font_offset_y=(ui_ELEMENT_H(ui)-font_height)/(float)2;
			i32 _w=ui->_w;
			ui->_w=ui_toolbar_w(false);
			if(ui_button(">>",ui_align_t_CENTER,"")){
				ui_toolbar_tool_properties_menu();
			}
			ui->_w=_w;
			ui->ops->theme->ELEMENT_H=_ELEMENT_H;
			ui->ops->theme->BUTTON_H=_BUTTON_H;
			ui->ops->theme->BUTTON_COL=_BUTTON_COL;
			ui->font_offset_y=_fontOffsetY;
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Toggle header",null));
		}
		ui->_y-=4*ui_SCALE(ui);
		any_map_t * vars_brush=any_map_create();
		any_map_set(vars_brush,"key",any_map_get(config_keymap,"brush_ruler"));
		any_map_set(vars_brush,"action_paint",any_map_get(config_keymap,"action_paint"));
		any_map_t * vars_decal=any_map_create();
		any_map_set(vars_decal,"key",any_map_get(config_keymap,"decal_mask"));
		any_map_t * vars_clone=any_map_create();
		any_map_set(vars_clone,"key",any_map_get(config_keymap,"set_clone_source"));
		string_t * key_tool_brush=any_map_get(config_keymap,"tool_brush");
		string_t * key_tool_eraser=any_map_get(config_keymap,"tool_eraser");
		string_t * key_tool_fill=any_map_get(config_keymap,"tool_fill");
		string_t * key_tool_decal=any_map_get(config_keymap,"tool_decal");
		string_t * key_tool_text=any_map_get(config_keymap,"tool_text");
		string_t * key_tool_clone=any_map_get(config_keymap,"tool_clone");
		string_t * key_tool_blur=any_map_get(config_keymap,"tool_blur");
		string_t * key_tool_smudge=any_map_get(config_keymap,"tool_smudge");
		string_t * key_tool_particle=any_map_get(config_keymap,"tool_particle");
		string_t * key_tool_colorid=any_map_get(config_keymap,"tool_colorid");
		string_t * key_tool_picker=any_map_get(config_keymap,"tool_picker");
		string_t * key_tool_bake=any_map_get(config_keymap,"tool_bake");
		string_t * key_tool_gizmo=any_map_get(config_keymap,"tool_gizmo");
		string_t * key_tool_material=any_map_get(config_keymap,"tool_material");
		key_tool_brush=string_join(string_join(string_join("(",key_tool_brush),") - "),tr("Hold {action_paint} to paint\nHold {key} and press {action_paint} to paint a straight line (ruler mode)",vars_brush));
		key_tool_eraser=string_join(string_join(string_join("(",key_tool_eraser),") - "),tr("Hold {action_paint} to erase\nHold {key} and press {action_paint} to erase a straight line (ruler mode)",vars_brush));
		key_tool_fill=string_join(string_join("(",key_tool_fill),")");
		key_tool_decal=string_join(string_join(string_join("(",key_tool_decal),") - "),tr("Hold {key} to paint on a decal mask",vars_decal));
		key_tool_text=string_join(string_join(string_join("(",key_tool_text),") - "),tr("Hold {key} to use the text as a mask",vars_decal));
		key_tool_clone=string_join(string_join(string_join("(",key_tool_clone),") - "),tr("Hold {key} to set source",vars_clone));
		key_tool_blur=string_join(string_join("(",key_tool_blur),")");
		key_tool_smudge=string_join(string_join("(",key_tool_smudge),")");
		key_tool_particle=string_join(string_join("(",key_tool_particle),")");
		key_tool_colorid=string_join(string_join("(",key_tool_colorid),")");
		key_tool_picker=string_join(string_join("(",key_tool_picker),")");
		key_tool_bake=string_join(string_join("(",key_tool_bake),")");
		key_tool_gizmo=string_join(string_join("(",key_tool_gizmo),")");
		key_tool_material=string_join(string_join("(",key_tool_material),")");
		string_t_array_t * keys=any_array_create_from_raw((any[]){key_tool_brush,key_tool_eraser,key_tool_fill,key_tool_decal,key_tool_text,key_tool_clone,key_tool_blur,key_tool_smudge,key_tool_particle,key_tool_colorid,key_tool_picker,key_tool_bake,key_tool_gizmo,key_tool_material,},14);
		ui_toolbar_ext_draw_tools(ui,img,icon_accent,keys);
		ui->image_scroll_align=true;
	}
	if(context_is_floating_toolbar()){
		ui->ops->theme->WINDOW_BG_COL=_WINDOW_BG_COL;
	}
	if(config_raw->touch_ui){
		i32 _SCROLL_W=ui->ops->theme->SCROLL_W;
		ui->ops->theme->SCROLL_W=0;
		ui_end_window();
		ui->ops->theme->SCROLL_W=_SCROLL_W;
	}
}

void ui_toolbar_tool_properties_menu(){
	ui_t * ui=ui_base_ui;
	ui_menu_draw(&ui_toolbar_tool_properties_menu_162206	,math_floor(ui->_x+ui->_w+2),math_floor(ui->_y-6*ui_SCALE(ui)));
}

void ui_toolbar_tool_properties_menu_162206(ui_t * ui){
ui->changed=false;
	ui_header_draw_tool_properties(ui);
	if(ui->changed){
		ui_menu_keep_open=true;
	}
	if(ui_button(tr("Pin to Header",null),ui_align_t_LEFT,"")){
		config_raw->layout->buffer[layout_size_t_HEADER]=1;
	}
}

void ui_toolbar_draw_highlight(){
	ui_t * ui=ui_base_ui;
	i32 size=ui_toolbar_w(false)-4;
	draw_set_color(ui->ops->theme->HIGHLIGHT_COL);
	ui_draw_rect(true,ui->_x+-1,ui->_y+2,size+2,size+2);
}

void ui_view2d_init(){
	gc_unroot(ui_view2d_pipe);ui_view2d_pipe=gpu_create_pipeline();gc_root(ui_view2d_pipe);
	ui_view2d_pipe->vertex_shader=sys_get_shader("layer_view.vert");
	ui_view2d_pipe->fragment_shader=sys_get_shader("layer_view.frag");
	gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
	gpu_vertex_struct_add(vs,"pos",vertex_data_t_F32_2X);
	ui_view2d_pipe->input_layout=vs;
	ui_view2d_pipe->blend_source=blend_factor_t_BLEND_ONE;
	ui_view2d_pipe->blend_destination=blend_factor_t_BLEND_ZERO;
	ARRAY_ACCESS(ui_view2d_pipe->color_write_mask_alpha,0)=false;
	gpu_pipeline_compile(ui_view2d_pipe);
	pipes_offset=0;
	pipes_get_constant_location("mat4");
	pipes_get_constant_location("float4");
	pipes_get_constant_location("float4");
	pipes_get_constant_location("float4");
	ui_view2d_channel_loc=pipes_get_constant_location("int");
	f32 scale=config_raw->window_scale;
	ui_options_t * ops=GC_ALLOC_INIT(ui_options_t, {.theme=base_theme,.font=base_font,.color_wheel=base_color_wheel,.black_white_gradient=base_color_wheel_gradient,.scale_factor=scale});
	gc_unroot(ui_view2d_ui);ui_view2d_ui=ui_create(ops);gc_root(ui_view2d_ui);
	ui_view2d_ui->scroll_enabled=false;
}

void ui_view2d_render(){
	ui_view2d_ww=config_raw->layout->buffer[layout_size_t_NODES_W];
	ui_view2d_wx=math_floor(sys_w())+ui_toolbar_w(true);
	ui_view2d_wy=0;
	if(!ui_base_show){
		ui_view2d_ww+=config_raw->layout->buffer[layout_size_t_SIDEBAR_W]+ui_toolbar_w(true);
		ui_view2d_wx-=ui_toolbar_w(true);
	}
	if(!ui_view2d_show){
		return ;
	}
	if(iron_window_width()==0||iron_window_height()==0){
		return ;
	}
	if(context_raw->pdirty>=0){
		ui_view2d_hwnd->redraws=2;
	}
	if(ui_view2d_grid_redraw){
		if(ui_view2d_grid!=null){
			iron_delete_texture(ui_view2d_grid);
		}
		gc_unroot(ui_view2d_grid);ui_view2d_grid=ui_nodes_draw_grid(ui_view2d_pan_scale);gc_root(ui_view2d_grid);
		ui_view2d_grid_redraw=false;
	}
	if(ui_view2d_uvmap_show){
		util_uv_cache_uv_map();
	}
	if(context_raw->font->image==null){
		util_render_make_font_preview();
	}
	ui_begin(ui_view2d_ui);
	i32 headerh=config_raw->layout->buffer[layout_size_t_HEADER]==1?ui_header_h*2:ui_header_h;
	i32 apph=iron_window_height()-config_raw->layout->buffer[layout_size_t_STATUS_H]+headerh;
	ui_view2d_wh=iron_window_height()-config_raw->layout->buffer[layout_size_t_STATUS_H];
	if(ui_nodes_show){
		ui_view2d_wh-=config_raw->layout->buffer[layout_size_t_NODES_H];
		if(config_raw->touch_ui){
			ui_view2d_wh+=ui_header_h;
		}
	}
	if(ui_window(ui_view2d_hwnd,ui_view2d_wx,ui_view2d_wy,ui_view2d_ww,ui_view2d_wh,false)){
		ui_tab(ui_handle("ui_view2d.ts:132"),tr("2D View",null),false,-1);
		draw_set_color(0xffffffff);
		f32 step=ui_nodes_grid_cell_w*ui_view2d_pan_scale;
		f32 x=math_fmod(ui_view2d_pan_x,step)-step;
		f32 y=math_fmod(ui_view2d_pan_y,step)-step;
		draw_image(ui_view2d_grid,x,y);
		gpu_texture_t * tex=null;
		slot_layer_t * l=context_raw->layer;
		i32 channel=0;
		f32 tw=ui_view2d_ww*0.95*ui_view2d_pan_scale;
		f32 tx=ui_view2d_ww/(float)2-tw/(float)2+ui_view2d_pan_x;
		f32 ty=apph/(float)2-tw/(float)2+ui_view2d_pan_y;
		if(ui_view2d_type==view_2d_type_t_ASSET){
			tex=project_get_image(context_raw->texture);
		}
		else if(ui_view2d_type==view_2d_type_t_NODE){
			tex=context_raw->node_preview;
		}
		else if(ui_view2d_type==view_2d_type_t_LAYER){
			slot_layer_t * layer=l;
			if(config_raw->brush_live&&render_path_paint_live_layer_drawn>0){
				layer=render_path_paint_live_layer;
			}
			if(ui_view2d_layer_mode==view_2d_layer_mode_t_VISIBLE){
				gpu_texture_t * current=_draw_current;
				bool in_use=gpu_in_use;
				if(in_use)draw_end();
				layer=layers_flatten(false,null);
				if(in_use)draw_begin(current,false,0);
			}
			else if(slot_layer_is_group(layer)){
				gpu_texture_t * current=_draw_current;
				bool in_use=gpu_in_use;
				if(in_use)draw_end();
				layer=layers_flatten(false,slot_layer_get_children(layer));
				if(in_use)draw_begin(current,false,0);
			}
			tex=slot_layer_is_mask(context_raw->layer)?layer->texpaint:ui_view2d_tex_type==paint_tex_t_BASE?layer->texpaint:ui_view2d_tex_type==paint_tex_t_OPACITY?layer->texpaint:ui_view2d_tex_type==paint_tex_t_NORMAL?layer->texpaint_nor:layer->texpaint_pack;
			channel=slot_layer_is_mask(context_raw->layer)?1:ui_view2d_tex_type==paint_tex_t_OCCLUSION?1:ui_view2d_tex_type==paint_tex_t_ROUGHNESS?2:ui_view2d_tex_type==paint_tex_t_METALLIC?3:ui_view2d_tex_type==paint_tex_t_OPACITY?4:ui_view2d_tex_type==paint_tex_t_HEIGHT?4:ui_view2d_tex_type==paint_tex_t_NORMAL?5:0;
		}
		else if(ui_view2d_type==view_2d_type_t_FONT){
			tex=context_raw->font->image;
		}
		f32 th=tw;
		if(tex!=null){
			th=tw*(tex->height/(float)tex->width);
			ty=apph/(float)2-th/(float)2+ui_view2d_pan_y;
			if(ui_view2d_type==view_2d_type_t_LAYER){
				draw_set_pipeline(ui_view2d_pipe);
				if(!context_raw->texture_filter){
					draw_set_bilinear_filter(false);
				}
				gpu_set_int(ui_view2d_channel_loc,channel);
			}
			draw_scaled_image(tex,tx,ty,tw,th);
			if(ui_view2d_tiled_show){
				draw_scaled_image(tex,tx-tw,ty,tw,th);
				draw_scaled_image(tex,tx-tw,ty-th,tw,th);
				draw_scaled_image(tex,tx-tw,ty+th,tw,th);
				draw_scaled_image(tex,tx+tw,ty,tw,th);
				draw_scaled_image(tex,tx+tw,ty-th,tw,th);
				draw_scaled_image(tex,tx+tw,ty+th,tw,th);
				draw_scaled_image(tex,tx,ty-th,tw,th);
				draw_scaled_image(tex,tx,ty+th,tw,th);
			}
			if(ui_view2d_type==view_2d_type_t_LAYER){
				draw_set_pipeline(null);
				if(!context_raw->texture_filter){
					draw_set_bilinear_filter(true);
				}
			}
			if((context_in_2d_view(view_2d_type_t_ASSET)||context_in_2d_view(view_2d_type_t_NODE))&&context_raw->tool==workspace_tool_t_PICKER&&ui_view2d_ui->input_down){
				gc_unroot(_ui_view2d_render_tex);_ui_view2d_render_tex=tex;gc_root(_ui_view2d_render_tex);
				_ui_view2d_render_x=ui_view2d_ui->input_x-tx-ui_view2d_wx;
				;
				_ui_view2d_render_y=ui_view2d_ui->input_y-ty-ui_view2d_wy;
				_ui_view2d_render_tw=tw;
				_ui_view2d_render_th=th;
				sys_notify_on_next_frame(&ui_view2d_render_163534				,null);
			}
		}
		if(ui_view2d_type==view_2d_type_t_LAYER&&ui_view2d_uvmap_show){
			draw_scaled_image(util_uv_uvmap,tx,ty,tw,th);
		}
		i32 ew=math_floor(ui_ELEMENT_W(ui_view2d_ui));
		draw_set_color(ui_view2d_ui->ops->theme->SEPARATOR_COL);
		draw_filled_rect(0,ui_ELEMENT_H(ui_view2d_ui),ui_view2d_ww,ui_ELEMENT_H(ui_view2d_ui)+ui_ELEMENT_OFFSET(ui_view2d_ui)*2);
		draw_set_color(0xffffffff);
		f32 start_y=ui_ELEMENT_H(ui_view2d_ui)+ui_ELEMENT_OFFSET(ui_view2d_ui);
		ui_view2d_ui->_x=2;
		ui_view2d_ui->_y=2+start_y;
		ui_view2d_ui->_w=ew;
		ui_handle_t * h=ui_handle("ui_view2d.ts:304");
		string_t * text=ui_view2d_type==view_2d_type_t_NODE?context_raw->node_preview_name:h->text;
		ui_view2d_ui->_w=math_floor(math_min(draw_string_width(ui_view2d_ui->ops->font,ui_view2d_ui->font_size,text)+15*ui_SCALE(ui_view2d_ui),100*ui_SCALE(ui_view2d_ui)));
		if(ui_view2d_type==view_2d_type_t_ASSET){
			asset_t * asset=context_raw->texture;
			if(asset!=null){
				string_t_array_t * asset_names=project_asset_names;
				i32 i=char_ptr_array_index_of(asset_names,asset->name);
				h->text=string_copy(asset->name);
				asset->name=string_copy(ui_text_input(h,"",ui_align_t_LEFT,true,false));
				asset_names->buffer[i]=asset->name;
			}
		}
		else if(ui_view2d_type==view_2d_type_t_NODE){
			ui_text(context_raw->node_preview_name,ui_align_t_LEFT,0x00000000);
		}
		else if(ui_view2d_type==view_2d_type_t_LAYER){
			h->text=string_copy(l->name);
			l->name=string_copy(ui_text_input(h,"",ui_align_t_LEFT,true,false));
			ui_view2d_text_input_hover=ui_view2d_ui->is_hovered;
		}
		else if(ui_view2d_type==view_2d_type_t_FONT){
			h->text=string_copy(context_raw->font->name);
			context_raw->font->name=ui_text_input(h,"",ui_align_t_LEFT,true,false);
		}
		if(h->changed){
			ui_base_hwnds->buffer[0]->redraws=2;
		}
		ui_view2d_ui->_x+=ui_view2d_ui->_w+3;
		ui_view2d_ui->_y=2+start_y;
		ui_view2d_ui->_w=ew;
		if(ui_view2d_type==view_2d_type_t_LAYER){
			ui_handle_t * h_layer_mode=ui_handle("ui_view2d.ts:359");
			if(h_layer_mode->init){
				h_layer_mode->position=ui_view2d_layer_mode;
			}
			string_t_array_t * layer_mode_combo=any_array_create_from_raw((any[]){tr("Visible",null),tr("Selected",null),},2);
			ui_view2d_layer_mode=ui_combo(h_layer_mode,layer_mode_combo,tr("Layers",null),false,ui_align_t_LEFT,true);
			ui_view2d_ui->_x+=ew+3;
			ui_view2d_ui->_y=2+start_y;
			if(!slot_layer_is_mask(context_raw->layer)){
				ui_handle_t * h_tex_type=ui_handle("ui_view2d.ts:369");
				if(h_tex_type->init){
					h_tex_type->position=ui_view2d_tex_type;
				}
				string_t_array_t * tex_type_combo=any_array_create_from_raw((any[]){tr("Base Color",null),tr("Normal Map",null),tr("Occlusion",null),tr("Roughness",null),tr("Metallic",null),tr("Opacity",null),tr("Height",null),},7);
				ui_view2d_tex_type=ui_combo(h_tex_type,tex_type_combo,tr("Texture",null),false,ui_align_t_LEFT,true);
				ui_view2d_ui->_x+=ew+3;
				ui_view2d_ui->_y=2+start_y;
			}
			ui_view2d_ui->_w=math_floor(ew*0.7+3);
			ui_handle_t * h_uvmap_show=ui_handle("ui_view2d.ts:388");
			if(h_uvmap_show->init){
				h_uvmap_show->selected=ui_view2d_uvmap_show;
			}
			ui_view2d_uvmap_show=ui_check(h_uvmap_show,tr("UV Map",null),"");
			ui_view2d_ui->_x+=ew*0.7+3;
			ui_view2d_ui->_y=2+start_y;
		}
		ui_handle_t * h_tiled_show=ui_handle("ui_view2d.ts:398");
		if(h_tiled_show->init){
			h_tiled_show->selected=ui_view2d_tiled_show;
		}
		ui_view2d_tiled_show=ui_check(h_tiled_show,tr("Tiled",null),"");
		ui_view2d_ui->_x+=ew*0.7+3;
		ui_view2d_ui->_y=2+start_y;
		if(ui_view2d_type==view_2d_type_t_ASSET&&tex!=null){
			ui_text(string_join(string_join(i32_to_string(tex->width),"x"),i32_to_string(tex->height)),ui_align_t_LEFT,0x00000000);
		}
		if(context_raw->tool==workspace_tool_t_PICKER&&(ui_view2d_type==view_2d_type_t_LAYER||ui_view2d_type==view_2d_type_t_ASSET)){
			gpu_texture_t * cursor_img=resource_get("cursor.k");
			f32 hsize=16*ui_SCALE(ui_view2d_ui);
			f32 size=hsize*2;
			draw_scaled_image(cursor_img,tx+tw*context_raw->uvx_picked-hsize,ty+th*context_raw->uvy_picked-hsize,size,size);
		}
	}
	ui_end(true);
}

void ui_view2d_render_163534(){
render_target_t * rt=any_map_get(render_path_render_targets,"texpaint_picker");
				gpu_texture_t * texpaint_picker=rt->_image;
				draw_begin(texpaint_picker,false,0);
				draw_scaled_image(_ui_view2d_render_tex,-_ui_view2d_render_x,-_ui_view2d_render_y,_ui_view2d_render_tw,_ui_view2d_render_th);
				draw_end();
				buffer_t * a=gpu_get_texture_pixels(texpaint_picker);
				i32 i0=0;
				i32 i1=1;
				i32 i2=2;
				context_raw->picked_color->base=color_set_rb(context_raw->picked_color->base,buffer_get_u8(a,i0));
				context_raw->picked_color->base=color_set_gb(context_raw->picked_color->base,buffer_get_u8(a,i1));
				context_raw->picked_color->base=color_set_bb(context_raw->picked_color->base,buffer_get_u8(a,i2));
				ui_header_handle->redraws=2;
}

void ui_view2d_update(){
	f32 headerh=ui_ELEMENT_H(ui_view2d_ui)*1.4;
	context_raw->paint2d=false;
	if(!base_ui_enabled||!ui_view2d_show||mouse_x<ui_view2d_wx||mouse_x>ui_view2d_wx+ui_view2d_ww||mouse_y<ui_view2d_wy+headerh||mouse_y>ui_view2d_wy+ui_view2d_wh){
		if(ui_view2d_controls_down){
			ui_canvas_control_t * control=ui_nodes_get_canvas_control(ui_view2d_ui,ui_view2d_controls_down);
			ui_view2d_controls_down=control->controls_down;
		}
		return ;
	}
	ui_canvas_control_t * control=ui_nodes_get_canvas_control(ui_view2d_ui,ui_view2d_controls_down);
	ui_view2d_pan_x+=control->pan_x;
	ui_view2d_pan_y+=control->pan_y;
	ui_view2d_controls_down=control->controls_down;
	if(control->zoom!=0.0){
		f32 _pan_x=ui_view2d_pan_x/(float)ui_view2d_pan_scale;
		f32 _pan_y=ui_view2d_pan_y/(float)ui_view2d_pan_scale;
		ui_view2d_pan_scale+=control->zoom;
		if(ui_view2d_pan_scale<0.1){
			ui_view2d_pan_scale=0.1;
		}
		if(ui_view2d_pan_scale>6.0){
			ui_view2d_pan_scale=6.0;
		}
		ui_view2d_pan_x=_pan_x*ui_view2d_pan_scale;
		ui_view2d_pan_y=_pan_y*ui_view2d_pan_scale;
		if(ui_touch_scroll){
			ui_view2d_pan_x-=(ui_view2d_ui->input_x-ui_view2d_ui->_window_x-ui_view2d_ui->_window_w/(float)2)*control->zoom;
			ui_view2d_pan_y-=(ui_view2d_ui->input_y-ui_view2d_ui->_window_y-ui_view2d_ui->_window_h/(float)2)*control->zoom;
		}
		ui_view2d_grid_redraw=true;
	}
	bool decal_mask=context_is_decal_mask_paint();
	bool set_clone_source=context_raw->tool==workspace_tool_t_CLONE&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"set_clone_source"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN);
	bool bake=context_raw->tool==workspace_tool_t_BAKE;
	if(ui_view2d_type==view_2d_type_t_LAYER&&!ui_view2d_text_input_hover&&!bake&&(operator_shortcut(any_map_get(config_keymap,"action_paint"),shortcut_type_t_DOWN)||operator_shortcut(string_join(string_join(any_map_get(config_keymap,"brush_ruler"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN)||decal_mask||set_clone_source||config_raw->brush_live)){
		context_raw->paint2d=true;
	}
	if(ui_view2d_ui->is_typing){
		return ;
	}
	if(keyboard_started("left")){
		ui_view2d_pan_x-=5;
	}
	else if(keyboard_started("right")){
		ui_view2d_pan_x+=5;
	}
	if(keyboard_started("up")){
		ui_view2d_pan_y-=5;
	}
	else if(keyboard_started("down")){
		ui_view2d_pan_y+=5;
	}
	i32 border=32;
	f32 tw=ui_view2d_ww*0.95*ui_view2d_pan_scale;
	f32 tx=ui_view2d_ww/(float)2-tw/(float)2+ui_view2d_pan_x;
	f32 hh=sys_h();
	f32 ty=hh/(float)2-tw/(float)2+ui_view2d_pan_y;
	if(tx+border>ui_view2d_ww){
		ui_view2d_pan_x=ui_view2d_ww/(float)2+tw/(float)2-border;
	}
	else if(tx-border<-tw){
		ui_view2d_pan_x=-tw/(float)2-ui_view2d_ww/(float)2+border;
	}
	if(ty+border>hh){
		ui_view2d_pan_y=hh/(float)2+tw/(float)2-border;
	}
	else if(ty-border<-tw){
		ui_view2d_pan_y=-tw/(float)2-hh/(float)2+border;
	}
	if(operator_shortcut(any_map_get(config_keymap,"view_reset"),shortcut_type_t_STARTED)){
		ui_view2d_pan_x=0.0;
		ui_view2d_pan_y=0.0;
		ui_view2d_pan_scale=1.0;
	}
}

void uniforms_ext_init(){
	gc_unroot(uniforms_i32_links);uniforms_i32_links=uniforms_ext_i32_link;gc_root(uniforms_i32_links);
	gc_unroot(uniforms_f32_links);uniforms_f32_links=uniforms_ext_f32_link;gc_root(uniforms_f32_links);
	gc_unroot(uniforms_vec2_links);uniforms_vec2_links=uniforms_ext_vec2_link;gc_root(uniforms_vec2_links);
	gc_unroot(uniforms_vec3_links);uniforms_vec3_links=uniforms_ext_vec3_link;gc_root(uniforms_vec3_links);
	gc_unroot(uniforms_vec4_links);uniforms_vec4_links=uniforms_ext_vec4_link;gc_root(uniforms_vec4_links);
	gc_unroot(uniforms_mat4_links);uniforms_mat4_links=uniforms_ext_mat4_link;gc_root(uniforms_mat4_links);
	gc_unroot(uniforms_tex_links);uniforms_tex_links=uniforms_ext_tex_link;gc_root(uniforms_tex_links);
}

i32 uniforms_ext_i32_link(object_t * object,material_data_t * mat,string_t * link){
	if(string_equals(link,"_bloom_current_mip")){
		return render_path_base_bloom_current_mip;
	}
	return INT_MAX;
}

f32 uniforms_ext_f32_link(object_t * object,material_data_t * mat,string_t * link){
	if(string_equals(link,"_brush_radius")){
		bool decal=context_is_decal();
		bool decal_mask=decal&&operator_shortcut(string_join(string_join(any_map_get(config_keymap,"decal_mask"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN);
		f32 brush_decal_mask_radius=context_raw->brush_decal_mask_radius;
		if(config_raw->brush_3d){
			brush_decal_mask_radius*=context_raw->paint2d?0.55*ui_view2d_pan_scale:2.0;
		}
		f32 radius=decal_mask?brush_decal_mask_radius:context_raw->brush_radius;
		f32 val=(radius*context_raw->brush_nodes_radius)/(float)15.0;
		if(config_raw->pressure_radius&&pen_down("tip")){
			val*=pen_pressure*config_raw->pressure_sensitivity;
		}
		f32 scale2d=(900/(float)base_h())*config_raw->window_scale;
		if(config_raw->brush_3d&&!decal){
			val*=context_raw->paint2d?0.55*scale2d*ui_view2d_pan_scale:2;
		}
		else {
			val*=scale2d;
		}
		return val;
	}
	else if(string_equals(link,"_vignette_strength")){
		return config_raw->rp_vignette;
	}
	else if(string_equals(link,"_grain_strength")){
		return config_raw->rp_grain;
	}
	else if(string_equals(link,"_cone_offset")){
		return context_raw->vxao_offset;
	}
	else if(string_equals(link,"_cone_aperture")){
		return context_raw->vxao_aperture;
	}
	else if(string_equals(link,"_bloom_sample_scale")){
		return render_path_base_bloom_sample_scale;
	}
	else if(string_equals(link,"_brush_scale_x")){
		return 1/(float)context_raw->brush_scale_x;
	}
	else if(string_equals(link,"_brush_opacity")){
		f32 val=context_raw->brush_opacity*context_raw->brush_nodes_opacity;
		if(config_raw->pressure_opacity&&pen_down("tip")){
			val*=pen_pressure*config_raw->pressure_sensitivity;
		}
		return val;
	}
	else if(string_equals(link,"_brush_hardness")){
		bool decal_mask=context_is_decal_mask_paint();
		if(context_raw->tool!=workspace_tool_t_BRUSH&&context_raw->tool!=workspace_tool_t_ERASER&&context_raw->tool!=workspace_tool_t_CLONE&&!decal_mask){
			return 1.0;
		}
		f32 val=context_raw->brush_hardness*context_raw->brush_nodes_hardness;
		if(config_raw->pressure_hardness&&pen_down("tip")){
			val*=pen_pressure*config_raw->pressure_sensitivity;
		}
		if(config_raw->brush_3d){
			if(context_raw->paint2d){
				val*=1.0/(float)ui_view2d_pan_scale;
			}
			else {
				val*=val;
			}
		}
		return val;
	}
	else if(string_equals(link,"_brush_scale")){
		bool fill=context_raw->layer->fill_layer!=null;
		f32 val=(fill?context_raw->layer->scale:context_raw->brush_scale)*context_raw->brush_nodes_scale;
		return val;
	}
	else if(string_equals(link,"_object_id")){
		return array_index_of(project_paint_objects,object->ext);
	}
	else if(string_equals(link,"_dilate_radius")){
		return util_uv_dilatemap!=null?config_raw->dilate_radius:0.0;
	}
	else if(string_equals(link,"_decal_layer_dim")){
		vec4_t sc=mat4_get_scale(context_raw->layer->decal_mat);
		return sc.z*0.5;
	}
	else if(string_equals(link,"_picker_opacity")){
		return context_raw->picked_color->opacity;
	}
	else if(string_equals(link,"_picker_occlusion")){
		return context_raw->picked_color->occlusion;
	}
	else if(string_equals(link,"_picker_roughness")){
		return context_raw->picked_color->roughness;
	}
	else if(string_equals(link,"_picker_metallic")){
		return context_raw->picked_color->metallic;
	}
	else if(string_equals(link,"_picker_height")){
		return context_raw->picked_color->height;
	}
	else if(string_equals(link,"_taa_blend")){
		if(render_path_base_taa_frame==0){
			return 0.0;
		}
		if(context_raw->ddirty>1||context_raw->pdirty>0){
			camera_object_taa_frames=2;
			return 0.5;
		}
		camera_object_taa_frames=6;
		return 0.833;
	}
	if(parser_material_script_links!=null){
		string_t_array_t * keys=map_keys(parser_material_script_links);
		for(i32 i=0;i<keys->length;++i){
			string_t * key=keys->buffer[i];
			string_t * script=any_map_get(parser_material_script_links,key);
			f32 result=f32_nan();
			if(!string_equals(script,"")){
				result=js_eval(script);
			}
			return result;
		}
	}
	return f32_nan();
}

vec2_t uniforms_ext_vec2_link(object_t * object,material_data_t * mat,string_t * link){
	if(string_equals(link,"_gbuffer_size")){
		render_target_t * gbuffer2=any_map_get(render_path_render_targets,"gbuffer2");
		return vec2_create(gbuffer2->_image->width,gbuffer2->_image->height);
	}
	else if(string_equals(link,"_clone_delta")){
		return vec2_create(context_raw->clone_delta_x,context_raw->clone_delta_y);
	}
	else if(string_equals(link,"_texpaint_size")){
		return vec2_create(config_get_texture_res_x(),config_get_texture_res_y());
	}
	else if(string_equals(link,"_brush_angle")){
		f32 brush_angle=context_raw->brush_angle+context_raw->brush_nodes_angle;
		f32 angle=context_raw->layer->fill_layer!=null?context_raw->layer->angle:brush_angle;
		angle*=(math_pi()/(float)180);
		if(config_raw->pressure_angle&&pen_down("tip")){
			angle*=pen_pressure*config_raw->pressure_sensitivity;
		}
		return vec2_create(math_cos(-angle),math_sin(-angle));
	}
	return vec2_nan();
}

vec4_t uniforms_ext_vec3_link(object_t * object,material_data_t * mat,string_t * link){
	vec4_t v=vec4_nan();
	if(string_equals(link,"_brush_direction")){
		v=_uniforms_vec;
		bool allow_paint=context_raw->prev_paint_vec_x!=context_raw->last_paint_vec_x&&context_raw->prev_paint_vec_y!=context_raw->last_paint_vec_y&&context_raw->prev_paint_vec_x>0&&context_raw->prev_paint_vec_y>0;
		f32 x=context_raw->paint_vec.x;
		f32 y=context_raw->paint_vec.y;
		f32 lastx=context_raw->prev_paint_vec_x;
		f32 lasty=context_raw->prev_paint_vec_y;
		if(context_raw->paint2d){
			x=vec2d(x);
			lastx=vec2d(lastx);
		}
		f32 angle=math_atan2(-y+lasty,x-lastx)-math_pi()/(float)2;
		v=vec4_create(math_cos(angle),math_sin(angle),allow_paint?1:0,1.0);
		context_raw->prev_paint_vec_x=context_raw->last_paint_vec_x;
		context_raw->prev_paint_vec_y=context_raw->last_paint_vec_y;
		return v;
	}
	else if(string_equals(link,"_decal_layer_loc")){
		v=_uniforms_vec;
		v=vec4_create(context_raw->layer->decal_mat.m30,context_raw->layer->decal_mat.m31,context_raw->layer->decal_mat.m32,1.0);
		return v;
	}
	else if(string_equals(link,"_decal_layer_nor")){
		v=_uniforms_vec;
		v=vec4_create(context_raw->layer->decal_mat.m20,context_raw->layer->decal_mat.m21,context_raw->layer->decal_mat.m22,1.0);
		v=vec4_norm(v);
		return v;
	}
	else if(string_equals(link,"_picker_base")){
		v=_uniforms_vec;
		v=vec4_create(color_get_rb(context_raw->picked_color->base)/(float)255,color_get_gb(context_raw->picked_color->base)/(float)255,color_get_bb(context_raw->picked_color->base)/(float)255,1.0);
		return v;
	}
	else if(string_equals(link,"_picker_normal")){
		v=_uniforms_vec;
		v=vec4_create(color_get_rb(context_raw->picked_color->normal)/(float)255,color_get_gb(context_raw->picked_color->normal)/(float)255,color_get_bb(context_raw->picked_color->normal)/(float)255,1.0);
		return v;
	}
	else if(string_equals(link,"_particle_hit")){
		v=_uniforms_vec;
		v=vec4_create(context_raw->particle_hit_x,context_raw->particle_hit_y,context_raw->particle_hit_z,1.0);
		return v;
	}
	else if(string_equals(link,"_particle_hit_last")){
		v=_uniforms_vec;
		v=vec4_create(context_raw->last_particle_hit_x,context_raw->last_particle_hit_y,context_raw->last_particle_hit_z,1.0);
		return v;
	}
	return v;
}

f32 vec2d(f32 x){
	context_raw->paint2d_view=false;
	f32 res=(x*base_w()-base_w())/(float)ui_view2d_ww;
	context_raw->paint2d_view=true;
	return res;
}

vec4_t uniforms_ext_vec4_link(object_t * object,material_data_t * mat,string_t * link){
	if(string_equals(link,"_input_brush")){
		bool down=mouse_down("left")||pen_down("tip");
		vec4_t v=vec4_create(context_raw->paint_vec.x,context_raw->paint_vec.y,down?1.0:0.0,context_raw->paint2d?1.0:0.0);
		if(context_raw->paint2d){
			v.x=vec2d(v.x);
		}
		return v;
	}
	else if(string_equals(link,"_input_brush_last")){
		bool down=mouse_down("left")||pen_down("tip");
		vec4_t v=vec4_create(context_raw->last_paint_vec_x,context_raw->last_paint_vec_y,down?1.0:0.0,context_raw->paint2d?1.0:0.0);
		if(context_raw->paint2d){
			v.x=vec2d(v.x);
		}
		return v;
	}
	else if(string_equals(link,"_envmap_data")){
		return vec4_create(context_raw->envmap_angle,math_sin(-context_raw->envmap_angle),math_cos(-context_raw->envmap_angle),scene_world->strength*1.5);
	}
	else if(string_equals(link,"_envmap_data_world")){
		return vec4_create(context_raw->envmap_angle,0.0,0.0,context_raw->show_envmap?scene_world->strength:1.0);
	}
	else if(string_equals(link,"_stencil_transform")){
		vec4_t v=vec4_create(context_raw->brush_stencil_x,context_raw->brush_stencil_y,context_raw->brush_stencil_scale,context_raw->brush_stencil_angle);
		if(context_raw->paint2d){
			v.x=vec2d(v.x);
		}
		return v;
	}
	else if(string_equals(link,"_decal_mask")){
		bool decal_mask=context_is_decal_mask_paint();
		f32 val=(context_raw->brush_radius*context_raw->brush_nodes_radius)/(float)15.0;
		f32 scale2d=(900/(float)base_h())*config_raw->window_scale;
		val*=scale2d;
		vec4_t v=vec4_create(context_raw->decal_x,context_raw->decal_y,decal_mask?1:0,val);
		if(context_raw->paint2d){
			v.x=vec2d(v.x);
		}
		return v;
	}
	return vec4_nan();
}

mat4_t uniforms_ext_mat4_link(object_t * object,material_data_t * mat,string_t * link){
	if(string_equals(link,"_decal_layer_matrix")){
		mat4_t m=mat4_inv(context_raw->layer->decal_mat);
		m=mat4_mult_mat(m,uniforms_ext_ortho_p);
		return m;
	}
	return mat4_nan();
}

gpu_texture_t * uniforms_ext_tex_link(object_t * object,material_data_t * mat,string_t * link){
	if(string_equals(link,"_texpaint_undo")){
		i32 i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
		render_target_t * rt=any_map_get(render_path_render_targets,string_join("texpaint_undo",i32_to_string(i)));
		return rt->_image;
	}
	else if(string_equals(link,"_texpaint_nor_undo")){
		i32 i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
		render_target_t * rt=any_map_get(render_path_render_targets,string_join("texpaint_nor_undo",i32_to_string(i)));
		return rt->_image;
	}
	else if(string_equals(link,"_texpaint_pack_undo")){
		i32 i=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
		render_target_t * rt=any_map_get(render_path_render_targets,string_join("texpaint_pack_undo",i32_to_string(i)));
		return rt->_image;
	}
	else if(string_equals(link,"_texcolorid")){
		if(project_assets->length==0){
			render_target_t * rt=any_map_get(render_path_render_targets,"empty_white");
			return rt->_image;
		}
		else {
			return project_get_image(project_assets->buffer[context_raw->colorid_handle->position]);
		}
	}
	else if(string_equals(link,"_textexttool")){
		return context_raw->text_tool_image;
	}
	else if(string_equals(link,"_texbrushmask")){
		return context_raw->brush_mask_image;
	}
	else if(string_equals(link,"_texbrushstencil")){
		return context_raw->brush_stencil_image;
	}
	else if(string_equals(link,"_texparticle")){
		render_target_t * rt=any_map_get(render_path_render_targets,"texparticle");
		return rt->_image;
	}
	else if(string_equals(link,"_texuvmap")){
		if(!util_uv_uvmap_cached){
			sys_notify_on_init(util_uv_cache_uv_map,null);
		}
		return util_uv_uvmap;
	}
	else if(string_equals(link,"_textrianglemap")){
		if(!util_uv_trianglemap_cached){
			sys_notify_on_init(util_uv_cache_triangle_map,null);
		}
		return util_uv_trianglemap;
	}
	else if(string_equals(link,"_texuvislandmap")){
		sys_notify_on_init(util_uv_cache_uv_island_map,null);
		if(util_uv_uvislandmap_cached){
			return util_uv_uvislandmap;
		}
		else {
			render_target_t * rt=any_map_get(render_path_render_targets,"empty_black");
			return rt->_image;
		}
	}
	else if(string_equals(link,"_texdilatemap")){
		return util_uv_dilatemap;
	}
	if(starts_with(link,"_texpaint_pack_vert")){
		string_t * tid=substring(link,string_length(link)-1,string_length(link));
		render_target_t * rt=any_map_get(render_path_render_targets,string_join("texpaint_pack",tid));
		return rt->_image;
	}
	if(starts_with(link,"_texpaint_vert")){
		i32 tid=parse_int(substring(link,string_length(link)-1,string_length(link)));
		return tid<project_layers->length?project_layers->buffer[tid]->texpaint:null;
	}
	if(starts_with(link,"_texpaint_nor")){
		i32 tid=parse_int(substring(link,string_length(link)-1,string_length(link)));
		return tid<project_layers->length?project_layers->buffer[tid]->texpaint_nor:null;
	}
	if(starts_with(link,"_texpaint_pack")){
		i32 tid=parse_int(substring(link,string_length(link)-1,string_length(link)));
		return tid<project_layers->length?project_layers->buffer[tid]->texpaint_pack:null;
	}
	if(starts_with(link,"_texpaint")){
		i32 tid=parse_int(substring(link,string_length(link)-1,string_length(link)));
		return tid<project_layers->length?project_layers->buffer[tid]->texpaint:null;
	}
	if(starts_with(link,"_texblur_")){
		string_t * id=substring(link,9,string_length(link));
		if(context_raw->node_previews!=null){
			return any_map_get(context_raw->node_previews,id);
		}
		else {
			render_target_t * rt=any_map_get(render_path_render_targets,"empty_black");
			return rt->_image;
		}
	}
	if(starts_with(link,"_texwarp_")){
		string_t * id=substring(link,9,string_length(link));
		if(context_raw->node_previews!=null){
			return any_map_get(context_raw->node_previews,id);
		}
		else {
			render_target_t * rt=any_map_get(render_path_render_targets,"empty_black");
			return rt->_image;
		}
	}
	if(starts_with(link,"_texbake_")){
		string_t * id=substring(link,9,string_length(link));
		if(context_raw->node_previews!=null){
			return any_map_get(context_raw->node_previews,id);
		}
		else {
			render_target_t * rt=any_map_get(render_path_render_targets,"empty_black");
			return rt->_image;
		}
	}
	return null;
}

f32_array_t * util_clone_f32_array(f32_array_t * f32a){
	if(f32a==null){
		return null;
	}
	return f32_array_create_from_array(f32a);
}

u32_array_t * util_clone_u32_array(u32_array_t * u32a){
	if(u32a==null){
		return null;
	}
	return u32_array_create_from_array(u32a);
}

u8_array_t * util_clone_u8_array(u8_array_t * u8a){
	if(u8a==null){
		return null;
	}
	return u8_array_create_from_array(u8a);
}

string_t_array_t * util_clone_string_array(string_t_array_t * a){
	if(a==null){
		return null;
	}
	string_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<a->length;++i){
		string_t * s=a->buffer[i];
		any_array_push(r,s);
	}
	return r;
}

u8_array_t * util_clone_bool_array(u8_array_t * a){
	if(a==null){
		return null;
	}
	u8_array_t * r=u8_array_create_from_raw((u8[]){},0);
	for(i32 i=0;i<a->length;++i){
		bool s=a->buffer[i];
		u8_array_push(r,s);
	}
	return r;
}

ui_node_socket_t_array_t * util_clone_canvas_sockets(ui_node_socket_t_array_t * sockets){
	if(sockets==null){
		return null;
	}
	ui_node_socket_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<sockets->length;++i){
		ui_node_socket_t * s=GC_ALLOC_INIT(ui_node_socket_t, {0});
		s->id=sockets->buffer[i]->id;
		;
		s->node_id=sockets->buffer[i]->node_id;
		s->name=string_copy(sockets->buffer[i]->name);
		s->type=string_copy(sockets->buffer[i]->type);
		s->color=sockets->buffer[i]->color;
		s->default_value=util_clone_f32_array(sockets->buffer[i]->default_value);
		s->min=sockets->buffer[i]->min;
		s->max=sockets->buffer[i]->max;
		s->precision=sockets->buffer[i]->precision;
		s->display=sockets->buffer[i]->display;
		any_array_push(r,s);
	}
	return r;
}

ui_node_button_t_array_t * util_clone_canvas_buttons(ui_node_button_t_array_t * buttons){
	if(buttons==null){
		return null;
	}
	ui_node_button_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<buttons->length;++i){
		ui_node_button_t * b=GC_ALLOC_INIT(ui_node_button_t, {0});
		b->name=string_copy(buttons->buffer[i]->name);
		b->type=string_copy(buttons->buffer[i]->type);
		b->output=buttons->buffer[i]->output;
		b->default_value=util_clone_f32_array(buttons->buffer[i]->default_value);
		b->data=util_clone_u8_array(buttons->buffer[i]->data);
		b->min=buttons->buffer[i]->min;
		b->max=buttons->buffer[i]->max;
		b->precision=buttons->buffer[i]->precision;
		b->height=buttons->buffer[i]->height;
		any_array_push(r,b);
	}
	return r;
}

ui_node_t * util_clone_canvas_node(ui_node_t * n){
	if(n==null){
		return null;
	}
	ui_node_t * r=GC_ALLOC_INIT(ui_node_t, {0});
	r->id=n->id;
	r->name=string_copy(n->name);
	r->type=string_copy(n->type);
	r->x=n->x;
	r->y=n->y;
	r->color=n->color;
	r->inputs=util_clone_canvas_sockets(n->inputs);
	r->outputs=util_clone_canvas_sockets(n->outputs);
	r->buttons=util_clone_canvas_buttons(n->buttons);
	r->width=n->width;
	return r;
}

ui_node_t_array_t * util_clone_canvas_nodes(ui_node_t_array_t * nodes){
	if(nodes==null){
		return null;
	}
	ui_node_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * n=util_clone_canvas_node(nodes->buffer[i]);
		any_array_push(r,n);
	}
	return r;
}

ui_node_link_t_array_t * util_clone_canvas_links(ui_node_link_t_array_t * links){
	if(links==null){
		return null;
	}
	ui_node_link_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<links->length;++i){
		ui_node_link_t * l=GC_ALLOC_INIT(ui_node_link_t, {0});
		l->id=links->buffer[i]->id;
		l->from_id=links->buffer[i]->from_id;
		l->from_socket=links->buffer[i]->from_socket;
		l->to_id=links->buffer[i]->to_id;
		l->to_socket=links->buffer[i]->to_socket;
		any_array_push(r,l);
	}
	return r;
}

ui_node_canvas_t * util_clone_canvas(ui_node_canvas_t * c){
	if(c==null){
		return null;
	}
	ui_node_canvas_t * r=GC_ALLOC_INIT(ui_node_canvas_t, {0});
	r->name=string_copy(c->name);
	r->nodes=util_clone_canvas_nodes(c->nodes);
	r->links=util_clone_canvas_links(c->links);
	return r;
}

vertex_element_t_array_t * util_clone_vertex_elements(vertex_element_t_array_t * elems){
	if(elems==null){
		return null;
	}
	vertex_element_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<elems->length;++i){
		vertex_element_t * e=GC_ALLOC_INIT(vertex_element_t, {0});
		e->name=string_copy(elems->buffer[i]->name);
		e->data=string_copy(elems->buffer[i]->data);
		any_array_push(r,e);
	}
	return r;
}

shader_const_t_array_t * util_clone_shader_consts(shader_const_t_array_t * consts){
	if(consts==null){
		return null;
	}
	shader_const_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<consts->length;++i){
		shader_const_t * s=GC_ALLOC_INIT(shader_const_t, {0});
		s->name=string_copy(consts->buffer[i]->name);
		s->type=string_copy(consts->buffer[i]->type);
		s->link=string_copy(consts->buffer[i]->link);
		any_array_push(r,s);
	}
	return r;
}

tex_unit_t_array_t * util_clone_tex_units(tex_unit_t_array_t * units){
	if(units==null){
		return null;
	}
	tex_unit_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<units->length;++i){
		tex_unit_t * u=GC_ALLOC_INIT(tex_unit_t, {0});
		u->name=string_copy(units->buffer[i]->name);
		u->link=string_copy(units->buffer[i]->link);
		any_array_push(r,u);
	}
	return r;
}

shader_context_t_array_t * util_clone_shader_contexts(shader_context_t_array_t * contexts){
	if(contexts==null){
		return null;
	}
	shader_context_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<contexts->length;++i){
		shader_context_t * c=GC_ALLOC_INIT(shader_context_t, {0});
		c->name=string_copy(contexts->buffer[i]->name);
		c->depth_write=contexts->buffer[i]->depth_write;
		c->compare_mode=string_copy(contexts->buffer[i]->compare_mode);
		c->cull_mode=string_copy(contexts->buffer[i]->cull_mode);
		c->vertex_shader=string_copy(contexts->buffer[i]->vertex_shader);
		c->fragment_shader=string_copy(contexts->buffer[i]->fragment_shader);
		c->shader_from_source=contexts->buffer[i]->shader_from_source;
		c->blend_source=string_copy(contexts->buffer[i]->blend_source);
		c->blend_destination=string_copy(contexts->buffer[i]->blend_destination);
		c->alpha_blend_source=string_copy(contexts->buffer[i]->alpha_blend_source);
		c->alpha_blend_destination=string_copy(contexts->buffer[i]->alpha_blend_destination);
		c->color_writes_red=util_clone_bool_array(contexts->buffer[i]->color_writes_red);
		c->color_writes_green=util_clone_bool_array(contexts->buffer[i]->color_writes_green);
		c->color_writes_blue=util_clone_bool_array(contexts->buffer[i]->color_writes_blue);
		c->color_writes_alpha=util_clone_bool_array(contexts->buffer[i]->color_writes_alpha);
		c->color_attachments=util_clone_string_array(contexts->buffer[i]->color_attachments);
		c->depth_attachment=string_copy(contexts->buffer[i]->depth_attachment);
		c->vertex_elements=util_clone_vertex_elements(contexts->buffer[i]->vertex_elements);
		c->constants=util_clone_shader_consts(contexts->buffer[i]->constants);
		c->texture_units=util_clone_tex_units(contexts->buffer[i]->texture_units);
		any_array_push(r,c);
	}
	return r;
}

shader_data_t * util_clone_shader_data(shader_data_t * s){
	if(s==null){
		return null;
	}
	shader_data_t * r=GC_ALLOC_INIT(shader_data_t, {0});
	r->name=string_copy(s->name);
	r->contexts=util_clone_shader_contexts(s->contexts);
	return r;
}

bind_const_t_array_t * util_clone_bind_constants(bind_const_t_array_t * consts){
	if(consts==null){
		return null;
	}
	bind_const_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<consts->length;++i){
		bind_const_t * c=GC_ALLOC_INIT(bind_const_t, {0});
		c->name=string_copy(consts->buffer[i]->name);
		c->vec=util_clone_f32_array(consts->buffer[i]->vec);
		any_array_push(r,c);
	}
	return r;
}

bind_tex_t_array_t * util_clone_bind_textures(bind_tex_t_array_t * texs){
	if(texs==null){
		return null;
	}
	bind_tex_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<texs->length;++i){
		bind_tex_t * t=GC_ALLOC_INIT(bind_tex_t, {0});
		t->name=string_copy(texs->buffer[i]->name);
		t->file=string_copy(texs->buffer[i]->file);
		any_array_push(r,t);
	}
	return r;
}

material_context_t_array_t * util_clone_material_contexts(material_context_t_array_t * contexts){
	if(contexts==null){
		return null;
	}
	material_context_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<contexts->length;++i){
		material_context_t * c=GC_ALLOC_INIT(material_context_t, {0});
		c->name=string_copy(contexts->buffer[i]->name);
		c->bind_constants=util_clone_bind_constants(contexts->buffer[i]->bind_constants);
		c->bind_textures=util_clone_bind_textures(contexts->buffer[i]->bind_textures);
		any_array_push(r,c);
	}
	return r;
}

material_data_t * util_clone_material_data(material_data_t * m){
	if(m==null){
		return null;
	}
	material_data_t * r=GC_ALLOC_INIT(material_data_t, {0});
	r->name=string_copy(m->name);
	r->shader=string_copy(m->shader);
	r->contexts=util_clone_material_contexts(m->contexts);
	return r;
}

track_t_array_t * util_clone_tracks(track_t_array_t * tracks){
	if(tracks==null){
		return null;
	}
	track_t_array_t * r=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<tracks->length;++i){
		track_t * t=GC_ALLOC_INIT(track_t, {0});
		t->target=string_copy(tracks->buffer[i]->target);
		t->frames=util_clone_u32_array(tracks->buffer[i]->frames);
		t->values=util_clone_f32_array(tracks->buffer[i]->values);
		any_array_push(r,t);
	}
	return r;
}

anim_t * util_clone_anim(anim_t * a){
	if(a==null){
		return null;
	}
	anim_t * r=GC_ALLOC_INIT(anim_t, {0});
	r->object_actions=util_clone_string_array(a->object_actions);
	r->bone_actions=util_clone_string_array(a->bone_actions);
	r->parent_bone=string_copy(a->parent_bone);
	r->parent_bone_tail=util_clone_f32_array(a->parent_bone_tail);
	r->parent_bone_tail_pose=util_clone_f32_array(a->parent_bone_tail_pose);
	r->parent_bone_connected=a->parent_bone_connected;
	r->tracks=util_clone_tracks(a->tracks);
	r->begin=a->begin;
	r->end=a->end;
	r->has_delta=a->has_delta;
	r->marker_frames=util_clone_u32_array(a->marker_frames);
	r->marker_names=util_clone_string_array(a->marker_names);
	return r;
}

obj_t * util_clone_obj(obj_t * o){
	if(o==null){
		return null;
	}
	obj_t * r=GC_ALLOC_INIT(obj_t, {0});
	r->name=string_copy(o->name);
	r->type=string_copy(o->type);
	r->data_ref=string_copy(o->data_ref);
	r->transform=util_clone_f32_array(o->transform);
	r->dimensions=util_clone_f32_array(o->dimensions);
	r->visible=o->visible;
	r->spawn=o->spawn;
	r->anim=util_clone_anim(o->anim);
	r->material_refs=util_clone_string_array(o->material_refs);
	if(o->children!=null){
		r->children=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<o->children->length;++i){
			obj_t * c=util_clone_obj(o->children->buffer[i]);
			any_array_push(r->children,c);
		}
	}
	return r;
}

swatch_color_t * util_clone_swatch_color(swatch_color_t * s){
	swatch_color_t * r=GC_ALLOC_INIT(swatch_color_t, {0});
	r->base=s->base;
	r->opacity=s->opacity;
	r->occlusion=s->occlusion;
	r->roughness=s->roughness;
	r->metallic=s->metallic;
	r->normal=s->normal;
	r->emission=s->emission;
	r->height=s->height;
	r->subsurface=s->subsurface;
	return r;
}

buffer_t * util_encode_scene(scene_t * raw){
	i32 size=8*1024*1024+util_encode_mesh_data_size(raw->mesh_datas);
	buffer_t * encoded=buffer_create(size);
	armpack_encode_start(encoded->buffer);
	armpack_encode_map(13);
	armpack_encode_string("name");
	armpack_encode_null();
	armpack_encode_string("objects");
	armpack_encode_null();
	util_encode_mesh_datas(raw->mesh_datas);
	armpack_encode_string("camera_datas");
	armpack_encode_null();
	armpack_encode_string("camera_ref");
	armpack_encode_null();
	armpack_encode_string("material_datas");
	armpack_encode_null();
	armpack_encode_string("shader_datas");
	armpack_encode_null();
	armpack_encode_string("world_datas");
	armpack_encode_null();
	armpack_encode_string("world_ref");
	armpack_encode_null();
	armpack_encode_string("speaker_datas");
	armpack_encode_null();
	armpack_encode_string("embedded_datas");
	armpack_encode_null();
	i32 ei=armpack_encode_end();
	encoded->length=ei;
	return encoded;
}

void util_encode_node_canvas(ui_node_canvas_t * c){
	ui_node_canvas_encode(c);
}

i32 util_encode_mesh_data_size(mesh_data_t_array_t * datas){
	if(datas==null){
		return 0;
	}
	i32 size=0;
	for(i32 i=0;i<datas->length;++i){
		for(i32 j=0;j<datas->buffer[i]->vertex_arrays->length;++j){
			size+=datas->buffer[i]->vertex_arrays->buffer[j]->values->length*2;
		}
		for(i32 j=0;j<datas->buffer[i]->index_arrays->length;++j){
			size+=datas->buffer[i]->index_arrays->buffer[j]->values->length*4;
		}
	}
	return size;
}

i32 util_encode_layer_data_size(layer_data_t_array_t * datas){
	if(datas==null){
		return 0;
	}
	i32 size=0;
	for(i32 i=0;i<datas->length;++i){
		buffer_t * tp=datas->buffer[i]->texpaint;
		if(tp!=null){
			size+=tp->length;
		}
		buffer_t * tp_nor=datas->buffer[i]->texpaint_nor;
		if(tp_nor!=null){
			size+=tp_nor->length;
		}
		buffer_t * tp_pack=datas->buffer[i]->texpaint_pack;
		if(tp_pack!=null){
			size+=tp_pack->length;
		}
	}
	return size;
}

void util_encode_mesh_datas(mesh_data_t_array_t * datas){
	armpack_encode_string("mesh_datas");
	if(datas==null){
		armpack_encode_null();
		return ;
	}
	armpack_encode_array(datas->length);
	for(i32 i=0;i<datas->length;++i){
		armpack_encode_map(6);
		armpack_encode_string("name");
		armpack_encode_string(datas->buffer[i]->name);
		armpack_encode_string("scale_pos");
		armpack_encode_f32(datas->buffer[i]->scale_pos);
		armpack_encode_string("scale_tex");
		armpack_encode_f32(datas->buffer[i]->scale_tex);
		armpack_encode_string("skin");
		armpack_encode_null();
		armpack_encode_string("vertex_arrays");
		armpack_encode_array(datas->buffer[i]->vertex_arrays->length);
		for(i32 j=0;j<datas->buffer[i]->vertex_arrays->length;++j){
			armpack_encode_map(3);
			armpack_encode_string("attrib");
			armpack_encode_string(datas->buffer[i]->vertex_arrays->buffer[j]->attrib);
			armpack_encode_string("data");
			armpack_encode_string(datas->buffer[i]->vertex_arrays->buffer[j]->data);
			armpack_encode_string("values");
			armpack_encode_array_i16(datas->buffer[i]->vertex_arrays->buffer[j]->values);
		}
		armpack_encode_string("index_arrays");
		armpack_encode_array(datas->buffer[i]->index_arrays->length);
		for(i32 j=0;j<datas->buffer[i]->index_arrays->length;++j){
			armpack_encode_map(2);
			armpack_encode_string("material");
			armpack_encode_i32(datas->buffer[i]->index_arrays->buffer[j]->material);
			armpack_encode_string("values");
			armpack_encode_array_i32(datas->buffer[i]->index_arrays->buffer[j]->values);
		}
	}
}

buffer_t * util_encode_project(project_format_t * raw){
	i32 size=32*1024*1024+util_encode_layer_data_size(raw->layer_datas)+util_encode_mesh_data_size(raw->mesh_datas);
	buffer_t * encoded=buffer_create(size);
	armpack_encode_start(encoded->buffer);
	armpack_encode_map(22);
	armpack_encode_string("version");
	armpack_encode_string(raw->version);
	armpack_encode_string("assets");
	armpack_encode_array_string(raw->assets);
	armpack_encode_string("is_bgra");
	armpack_encode_bool(raw->is_bgra);
	armpack_encode_string("packed_assets");
	if(raw->packed_assets!=null){
		armpack_encode_array(raw->packed_assets->length);
		for(i32 i=0;i<raw->packed_assets->length;++i){
			armpack_encode_map(2);
			armpack_encode_string("name");
			armpack_encode_string(raw->packed_assets->buffer[i]->name);
			armpack_encode_string("bytes");
			armpack_encode_array_u8(raw->packed_assets->buffer[i]->bytes);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("envmap");
	armpack_encode_string(raw->envmap);
	armpack_encode_string("envmap_strength");
	armpack_encode_f32(raw->envmap_strength);
	armpack_encode_string("camera_world");
	armpack_encode_array_f32(raw->camera_world);
	armpack_encode_string("camera_origin");
	armpack_encode_array_f32(raw->camera_origin);
	armpack_encode_string("camera_fov");
	armpack_encode_f32(raw->camera_fov);
	armpack_encode_string("swatches");
	if(raw->swatches!=null){
		armpack_encode_array(raw->swatches->length);
		for(i32 i=0;i<raw->swatches->length;++i){
			armpack_encode_map(9);
			armpack_encode_string("base");
			armpack_encode_i32(raw->swatches->buffer[i]->base);
			armpack_encode_string("opacity");
			armpack_encode_f32(raw->swatches->buffer[i]->opacity);
			armpack_encode_string("occlusion");
			armpack_encode_f32(raw->swatches->buffer[i]->occlusion);
			armpack_encode_string("roughness");
			armpack_encode_f32(raw->swatches->buffer[i]->roughness);
			armpack_encode_string("metallic");
			armpack_encode_f32(raw->swatches->buffer[i]->metallic);
			armpack_encode_string("normal");
			armpack_encode_i32(raw->swatches->buffer[i]->normal);
			armpack_encode_string("emission");
			armpack_encode_f32(raw->swatches->buffer[i]->emission);
			armpack_encode_string("height");
			armpack_encode_f32(raw->swatches->buffer[i]->height);
			armpack_encode_string("subsurface");
			armpack_encode_f32(raw->swatches->buffer[i]->subsurface);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("brush_nodes");
	if(raw->brush_nodes!=null){
		armpack_encode_array(raw->brush_nodes->length);
		for(i32 i=0;i<raw->brush_nodes->length;++i){
			util_encode_node_canvas(raw->brush_nodes->buffer[i]);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("brush_icons");
	if(raw->brush_icons!=null){
		armpack_encode_array(raw->brush_icons->length);
		for(i32 i=0;i<raw->brush_icons->length;++i){
			armpack_encode_array_u8(raw->brush_icons->buffer[i]);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("material_nodes");
	if(raw->material_nodes!=null){
		armpack_encode_array(raw->material_nodes->length);
		for(i32 i=0;i<raw->material_nodes->length;++i){
			util_encode_node_canvas(raw->material_nodes->buffer[i]);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("material_groups");
	if(raw->material_groups!=null){
		armpack_encode_array(raw->material_groups->length);
		for(i32 i=0;i<raw->material_groups->length;++i){
			util_encode_node_canvas(raw->material_groups->buffer[i]);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("material_icons");
	if(raw->material_icons!=null){
		armpack_encode_array(raw->material_icons->length);
		for(i32 i=0;i<raw->material_icons->length;++i){
			armpack_encode_array_u8(raw->material_icons->buffer[i]);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("font_assets");
	armpack_encode_array_string(raw->font_assets);
	armpack_encode_string("layer_datas");
	if(raw->layer_datas!=null){
		armpack_encode_array(raw->layer_datas->length);
		for(i32 i=0;i<raw->layer_datas->length;++i){
			armpack_encode_map(27);
			armpack_encode_string("name");
			armpack_encode_string(raw->layer_datas->buffer[i]->name);
			armpack_encode_string("res");
			armpack_encode_i32(raw->layer_datas->buffer[i]->res);
			armpack_encode_string("bpp");
			armpack_encode_i32(raw->layer_datas->buffer[i]->bpp);
			armpack_encode_string("texpaint");
			armpack_encode_array_u8(raw->layer_datas->buffer[i]->texpaint);
			armpack_encode_string("uv_scale");
			armpack_encode_f32(raw->layer_datas->buffer[i]->uv_scale);
			armpack_encode_string("uv_rot");
			armpack_encode_f32(raw->layer_datas->buffer[i]->uv_rot);
			armpack_encode_string("uv_type");
			armpack_encode_i32(raw->layer_datas->buffer[i]->uv_type);
			armpack_encode_string("decal_mat");
			armpack_encode_array_f32(raw->layer_datas->buffer[i]->decal_mat);
			armpack_encode_string("opacity_mask");
			armpack_encode_f32(raw->layer_datas->buffer[i]->opacity_mask);
			armpack_encode_string("fill_layer");
			armpack_encode_i32(raw->layer_datas->buffer[i]->fill_layer);
			armpack_encode_string("object_mask");
			armpack_encode_i32(raw->layer_datas->buffer[i]->object_mask);
			armpack_encode_string("blending");
			armpack_encode_i32(raw->layer_datas->buffer[i]->blending);
			armpack_encode_string("parent");
			armpack_encode_i32(raw->layer_datas->buffer[i]->parent);
			armpack_encode_string("visible");
			armpack_encode_bool(raw->layer_datas->buffer[i]->visible);
			armpack_encode_string("texpaint_nor");
			armpack_encode_array_u8(raw->layer_datas->buffer[i]->texpaint_nor);
			armpack_encode_string("texpaint_pack");
			armpack_encode_array_u8(raw->layer_datas->buffer[i]->texpaint_pack);
			armpack_encode_string("paint_base");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_base);
			armpack_encode_string("paint_opac");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_opac);
			armpack_encode_string("paint_occ");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_occ);
			armpack_encode_string("paint_rough");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_rough);
			armpack_encode_string("paint_met");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_met);
			armpack_encode_string("paint_nor");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_nor);
			armpack_encode_string("paint_nor_blend");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_nor_blend);
			armpack_encode_string("paint_height");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_height);
			armpack_encode_string("paint_height_blend");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_height_blend);
			armpack_encode_string("paint_emis");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_emis);
			armpack_encode_string("paint_subs");
			armpack_encode_bool(raw->layer_datas->buffer[i]->paint_subs);
		}
	}
	else {
		armpack_encode_null();
	}
	util_encode_mesh_datas(raw->mesh_datas);
	armpack_encode_string("mesh_assets");
	armpack_encode_array_string(raw->mesh_assets);
	armpack_encode_string("mesh_icons");
	if(raw->mesh_icons!=null){
		armpack_encode_array(raw->mesh_icons->length);
		for(i32 i=0;i<raw->mesh_icons->length;++i){
			armpack_encode_array_u8(raw->mesh_icons->buffer[i]);
		}
	}
	else {
		armpack_encode_null();
	}
	armpack_encode_string("atlas_objects");
	armpack_encode_array_i32(raw->atlas_objects);
	armpack_encode_string("atlas_names");
	armpack_encode_array_string(raw->atlas_names);
	i32 ei=armpack_encode_end();
	encoded->length=ei;
	return encoded;
}

void util_mesh_merge(mesh_object_t_array_t * paint_objects){
	if(paint_objects==null){
		paint_objects=project_paint_objects;
	}
	if(paint_objects->length==0){
		return ;
	}
	context_raw->merged_object_is_atlas=paint_objects->length<project_paint_objects->length;
	i32 vlen=0;
	i32 ilen=0;
	f32 max_scale=0.0;
	for(i32 i=0;i<paint_objects->length;++i){
		vlen+=paint_objects->buffer[i]->data->vertex_arrays->buffer[0]->values->length;
		ilen+=paint_objects->buffer[i]->data->index_arrays->buffer[0]->values->length;
		if(paint_objects->buffer[i]->data->scale_pos>max_scale){
			max_scale=paint_objects->buffer[i]->data->scale_pos;
		}
	}
	vlen=math_floor(vlen/(float)4);
	i16_array_t * va0=i16_array_create(vlen*4);
	i16_array_t * va1=i16_array_create(vlen*2);
	i16_array_t * va2=i16_array_create(vlen*2);
	i16_array_t * va3=paint_objects->buffer[0]->data->vertex_arrays->length>3?i16_array_create(vlen*4):null;
	u32_array_t * ia=u32_array_create(ilen);
	i32 voff=0;
	i32 ioff=0;
	for(i32 i=0;i<paint_objects->length;++i){
		vertex_array_t_array_t * vas=paint_objects->buffer[i]->data->vertex_arrays;
		index_array_t_array_t * ias=paint_objects->buffer[i]->data->index_arrays;
		f32 scale=paint_objects->buffer[i]->data->scale_pos;
		for(i32 j=0;j<vas->buffer[0]->values->length;++j){
			va0->buffer[j+voff*4]=vas->buffer[0]->values->buffer[j];
		}
		for(i32 j=voff;j<math_floor(va0->length/(float)4);++j){
			va0->buffer[j*4]=math_floor((va0->buffer[j*4]*scale)/(float)max_scale);
			va0->buffer[j*4+1]=math_floor((va0->buffer[j*4+1]*scale)/(float)max_scale);
			va0->buffer[j*4+2]=math_floor((va0->buffer[j*4+2]*scale)/(float)max_scale);
		}
		for(i32 j=0;j<vas->buffer[1]->values->length;++j){
			va1->buffer[j+voff*2]=vas->buffer[1]->values->buffer[j];
		}
		for(i32 j=0;j<vas->buffer[2]->values->length;++j){
			va2->buffer[j+voff*2]=vas->buffer[2]->values->buffer[j];
		}
		if(va3!=null){
			for(i32 j=0;j<vas->buffer[3]->values->length;++j){
				va3->buffer[j+voff*4]=vas->buffer[3]->values->buffer[j];
			}
		}
		for(i32 j=0;j<ias->buffer[0]->values->length;++j){
			ia->buffer[j+ioff]=ias->buffer[0]->values->buffer[j]+voff;
		}
		voff+=math_floor(vas->buffer[0]->values->length/(float)4);
		ioff+=math_floor(ias->buffer[0]->values->length);
	}
	mesh_data_t * raw=GC_ALLOC_INIT(mesh_data_t, {.name=context_raw->paint_object->base->name,.vertex_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_array_t, {.values=va0,.attrib="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_array_t, {.values=va1,.attrib="nor",.data="short2norm"}),GC_ALLOC_INIT(vertex_array_t, {.values=va2,.attrib="tex",.data="short2norm"}),},3),.index_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(index_array_t, {.values=ia,.material=0}),},1),.scale_pos=max_scale,.scale_tex=1.0});
	if(va3!=null){
		vertex_array_t * col=GC_ALLOC_INIT(vertex_array_t, {.values=va3,.attrib="col",.data="short4norm"});
		any_array_push(raw->vertex_arrays,col);
	}
	util_mesh_remove_merged();
	mesh_data_t * md=mesh_data_create(raw);
	context_raw->merged_object=mesh_object_create(md,context_raw->paint_object->materials);
	context_raw->merged_object->base->name=string_join(context_raw->paint_object->base->name,"_merged");
	context_raw->merged_object->force_context="paint";
	object_set_parent(context_raw->merged_object->base,context_main_object()->base,false,false);
	render_path_raytrace_ready=false;
}

void util_mesh_remove_merged(){
	if(context_raw->merged_object!=null){
		mesh_data_delete(context_raw->merged_object->data);
		mesh_object_remove(context_raw->merged_object);
		context_raw->merged_object=null;
	}
}

void util_mesh_swap_axis(i32 a,i32 b){
	mesh_object_t_array_t * objects=project_paint_objects;
	for(i32 i=0;i<objects->length;++i){
		mesh_object_t * o=objects->buffer[i];
		vertex_array_t_array_t * vas=o->data->vertex_arrays;
		i16_array_t * pa=vas->buffer[0]->values;
		i16_array_t * na0=a==2?vas->buffer[0]->values:vas->buffer[1]->values;
		i16_array_t * na1=b==2?vas->buffer[0]->values:vas->buffer[1]->values;
		i32 c=a==2?3:a;
		i32 d=b==2?3:b;
		i32 e=a==2?4:2;
		i32 f=b==2?4:2;
		for(i32 i=0;i<math_floor(pa->length/(float)4);++i){
			i32 t=pa->buffer[i*4+a];
			pa->buffer[i*4+a]=pa->buffer[i*4+b];
			pa->buffer[i*4+b]=-t;
			t=na0->buffer[i*e+c];
			na0->buffer[i*e+c]=na1->buffer[i*f+d];
			na1->buffer[i*f+d]=-t;
		}
		mesh_data_t * g=o->data;
		i32 l=gpu_vertex_struct_size(g->_->structure)/(float)2;
		buffer_t * vertices=gpu_lock_vertex_buffer(g->_->vertex_buffer);
		for(i32 i=0;i<math_floor((vertices->length)/(float)2/(float)l);++i){
			buffer_set_i16(vertices,(i*l)*2,vas->buffer[0]->values->buffer[i*4]);
			buffer_set_i16(vertices,(i*l+1)*2,vas->buffer[0]->values->buffer[i*4+1]);
			buffer_set_i16(vertices,(i*l+2)*2,vas->buffer[0]->values->buffer[i*4+2]);
			buffer_set_i16(vertices,(i*l+3)*2,vas->buffer[0]->values->buffer[i*4+3]);
			buffer_set_i16(vertices,(i*l+4)*2,vas->buffer[1]->values->buffer[i*2]);
			buffer_set_i16(vertices,(i*l+5)*2,vas->buffer[1]->values->buffer[i*2+1]);
		}
		gpu_vertex_buffer_unlock(g->_->vertex_buffer);
	}
	util_mesh_remove_merged();
	util_mesh_merge(null);
}

void util_mesh_flip_normals(){
	mesh_object_t_array_t * objects=project_paint_objects;
	for(i32 i=0;i<objects->length;++i){
		mesh_object_t * o=objects->buffer[i];
		vertex_array_t_array_t * vas=o->data->vertex_arrays;
		i16_array_t * va0=vas->buffer[0]->values;
		i16_array_t * va1=vas->buffer[1]->values;
		mesh_data_t * g=o->data;
		i32 l=gpu_vertex_struct_size(g->_->structure)/(float)2;
		buffer_t * vertices=gpu_lock_vertex_buffer(g->_->vertex_buffer);
		for(i32 i=0;i<math_floor((vertices->length)/(float)2/(float)l);++i){
			va0->buffer[i*4+3]=-va0->buffer[i*4+3];
			va1->buffer[i*2]=-va1->buffer[i*2];
			va1->buffer[i*2+1]=-va1->buffer[i*2+1];
			buffer_set_i16(vertices,(i*l+3)*2,-buffer_get_i16(vertices,(i*l+3)*2));
			buffer_set_i16(vertices,(i*l+4)*2,-buffer_get_i16(vertices,(i*l+4)*2));
			buffer_set_i16(vertices,(i*l+5)*2,-buffer_get_i16(vertices,(i*l+5)*2));
		}
		gpu_vertex_buffer_unlock(g->_->vertex_buffer);
	}
	render_path_raytrace_ready=false;
}

void util_mesh_calc_normals(bool smooth){
	vec4_t va=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t vb=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t vc=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t cb=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t ab=vec4_create(0.0,0.0,0.0,1.0);
	mesh_object_t_array_t * objects=project_paint_objects;
	for(i32 i=0;i<objects->length;++i){
		mesh_object_t * o=objects->buffer[i];
		mesh_data_t * g=o->data;
		i32 l=gpu_vertex_struct_size(g->_->structure)/(float)2;
		u32_array_t * inda=g->_->indices->buffer[0];
		buffer_t * vertices=gpu_lock_vertex_buffer(g->_->vertex_buffer);
		for(i32 i=0;i<math_floor(inda->length/(float)3);++i){
			i32 i1=inda->buffer[i*3];
			i32 i2=inda->buffer[i*3+1];
			i32 i3=inda->buffer[i*3+2];
			va=vec4_create(buffer_get_i16(vertices,(i1*l)*2),buffer_get_i16(vertices,(i1*l+1)*2),buffer_get_i16(vertices,(i1*l+2)*2),1.0);
			vb=vec4_create(buffer_get_i16(vertices,(i2*l)*2),buffer_get_i16(vertices,(i2*l+1)*2),buffer_get_i16(vertices,(i2*l+2)*2),1.0);
			vc=vec4_create(buffer_get_i16(vertices,(i3*l)*2),buffer_get_i16(vertices,(i3*l+1)*2),buffer_get_i16(vertices,(i3*l+2)*2),1.0);
			cb=vec4_sub(vc,vb);
			ab=vec4_sub(va,vb);
			cb=vec4_cross(cb,ab);
			cb=vec4_norm(cb);
			buffer_set_i16(vertices,(i1*l+4)*2,math_floor(cb.x*32767));
			buffer_set_i16(vertices,(i1*l+5)*2,math_floor(cb.y*32767));
			buffer_set_i16(vertices,(i1*l+3)*2,math_floor(cb.z*32767));
			buffer_set_i16(vertices,(i2*l+4)*2,math_floor(cb.x*32767));
			buffer_set_i16(vertices,(i2*l+5)*2,math_floor(cb.y*32767));
			buffer_set_i16(vertices,(i2*l+3)*2,math_floor(cb.z*32767));
			buffer_set_i16(vertices,(i3*l+4)*2,math_floor(cb.x*32767));
			buffer_set_i16(vertices,(i3*l+5)*2,math_floor(cb.y*32767));
			buffer_set_i16(vertices,(i3*l+3)*2,math_floor(cb.z*32767));
		}
		if(smooth){
			u32_array_t * shared=u32_array_create(1024);
			i32 shared_len=0;
			i32_array_t * found=i32_array_create_from_raw((i32[]){},0);
			for(i32 i=0;i<(inda->length-1);++i){
				if(i32_array_index_of(found,i)>=0){
					continue;
				}
				i32 i1=inda->buffer[i];
				shared_len=0;
				shared->buffer[shared_len++]=i1;
				for(i32 j=(i+1);j<inda->length;++j){
					i32 i2=inda->buffer[j];
					i32 i1l=i1*l;
					i32 i2l=i2*l;
					if(buffer_get_i16(vertices,(i1l)*2)==buffer_get_i16(vertices,(i2l)*2)&&buffer_get_i16(vertices,(i1l+1)*2)==buffer_get_i16(vertices,(i2l+1)*2)&&buffer_get_i16(vertices,(i1l+2)*2)==buffer_get_i16(vertices,(i2l+2)*2)){
						shared->buffer[shared_len++]=i2;
						i32_array_push(found,j);
						if(shared_len>=1024){
							break;
						}
					}
				}
				if(shared_len>1){
					va=vec4_create(0,0,0,1.0);
					for(i32 j=0;j<shared_len;++j){
						i32 i1=shared->buffer[j];
						i32 i1l=i1*l;
						va=vec4_fadd(va,buffer_get_i16(vertices,(i1l+4)*2),buffer_get_i16(vertices,(i1l+5)*2),buffer_get_i16(vertices,(i1l+3)*2),0.0);
					}
					va=vec4_mult(va,1/(float)shared_len);
					va=vec4_norm(va);
					i32 vax=math_floor(va.x*32767);
					i32 vay=math_floor(va.y*32767);
					i32 vaz=math_floor(va.z*32767);
					for(i32 j=0;j<shared_len;++j){
						i32 i1=shared->buffer[j];
						i32 i1l=i1*l;
						buffer_set_i16(vertices,(i1l+4)*2,vax);
						buffer_set_i16(vertices,(i1l+5)*2,vay);
						buffer_set_i16(vertices,(i1l+3)*2,vaz);
					}
				}
			}
		}
		gpu_vertex_buffer_unlock(g->_->vertex_buffer);
		i16_array_t * va0=o->data->vertex_arrays->buffer[0]->values;
		i16_array_t * va1=o->data->vertex_arrays->buffer[1]->values;
		for(i32 i=0;i<math_floor((vertices->length)/(float)4/(float)l);++i){
			va1->buffer[i*2]=buffer_get_i16(vertices,(i*l+4)*2);
			va1->buffer[i*2+1]=buffer_get_i16(vertices,(i*l+5)*2);
			va0->buffer[i*4+3]=buffer_get_i16(vertices,(i*l+3)*2);
		}
	}
	util_mesh_merge(null);
	render_path_raytrace_ready=false;
}

void util_mesh_to_origin(){
	f32 dx=0.0;
	f32 dy=0.0;
	f32 dz=0.0;
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * o=project_paint_objects->buffer[i];
		i32 l=4;
		f32 sc=o->data->scale_pos/(float)32767;
		i16_array_t * va=o->data->vertex_arrays->buffer[0]->values;
		f32 minx=va->buffer[0];
		f32 maxx=va->buffer[0];
		f32 miny=va->buffer[1];
		f32 maxy=va->buffer[1];
		f32 minz=va->buffer[2];
		f32 maxz=va->buffer[2];
		for(i32 i=1;i<math_floor(va->length/(float)l);++i){
			if(va->buffer[i*l]<minx){
				minx=va->buffer[i*l];
			}
			else if(va->buffer[i*l]>maxx){
				maxx=va->buffer[i*l];
			}
			if(va->buffer[i*l+1]<miny){
				miny=va->buffer[i*l+1];
			}
			else if(va->buffer[i*l+1]>maxy){
				maxy=va->buffer[i*l+1];
			}
			if(va->buffer[i*l+2]<minz){
				minz=va->buffer[i*l+2];
			}
			else if(va->buffer[i*l+2]>maxz){
				maxz=va->buffer[i*l+2];
			}
		}
		dx+=(minx+maxx)/(float)2*sc;
		dy+=(miny+maxy)/(float)2*sc;
		dz+=(minz+maxz)/(float)2*sc;
	}
	dx/=project_paint_objects->length;
	dy/=project_paint_objects->length;
	dz/=project_paint_objects->length;
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * o=project_paint_objects->buffer[i];
		mesh_data_t * g=o->data;
		f32 sc=o->data->scale_pos/(float)32767;
		i16_array_t * va=o->data->vertex_arrays->buffer[0]->values;
		f32 max_scale=0.0;
		for(i32 i=0;i<math_floor(va->length/(float)4);++i){
			if(math_abs(va->buffer[i*4]*sc-dx)>max_scale){
				max_scale=math_abs(va->buffer[i*4]*sc-dx);
			}
			if(math_abs(va->buffer[i*4+1]*sc-dy)>max_scale){
				max_scale=math_abs(va->buffer[i*4+1]*sc-dy);
			}
			if(math_abs(va->buffer[i*4+2]*sc-dz)>max_scale){
				max_scale=math_abs(va->buffer[i*4+2]*sc-dz);
			}
		}
		o->base->transform->scale_world=o->data->scale_pos=o->data->scale_pos=max_scale;
		transform_build_matrix(o->base->transform);
		for(i32 i=0;i<math_floor(va->length/(float)4);++i){
			va->buffer[i*4]=math_floor((va->buffer[i*4]*sc-dx)/(float)max_scale*32767);
			va->buffer[i*4+1]=math_floor((va->buffer[i*4+1]*sc-dy)/(float)max_scale*32767);
			va->buffer[i*4+2]=math_floor((va->buffer[i*4+2]*sc-dz)/(float)max_scale*32767);
		}
		i32 l=gpu_vertex_struct_size(g->_->structure)/(float)2;
		buffer_t * vertices=gpu_lock_vertex_buffer(g->_->vertex_buffer);
		for(i32 i=0;i<math_floor((vertices->length)/(float)2/(float)l);++i){
			buffer_set_i16(vertices,(i*l)*2,va->buffer[i*4]);
			buffer_set_i16(vertices,(i*l+1)*2,va->buffer[i*4+1]);
			buffer_set_i16(vertices,(i*l+2)*2,va->buffer[i*4+2]);
		}
		gpu_vertex_buffer_unlock(g->_->vertex_buffer);
	}
	util_mesh_merge(null);
}

void util_mesh_apply_displacement(gpu_texture_t * texpaint_pack,f32 strength,f32 uv_scale){
	buffer_t * height=gpu_get_texture_pixels(texpaint_pack);
	i32 res=texpaint_pack->width;
	mesh_object_t * o=project_paint_objects->buffer[0];
	mesh_data_t * g=o->data;
	i32 l=gpu_vertex_struct_size(g->_->structure)/(float)2;
	buffer_t * vertices=gpu_lock_vertex_buffer(g->_->vertex_buffer);
	for(i32 i=0;i<math_floor((vertices->length)/(float)2/(float)l);++i){
		i32 x=math_floor(buffer_get_i16(vertices,(i*l+6)*2)/(float)32767*res);
		i32 y=math_floor(buffer_get_i16(vertices,(i*l+7)*2)/(float)32767*res);
		i32 ix=math_floor(x*uv_scale);
		i32 iy=math_floor(y*uv_scale);
		i32 xx=ix%res;
		i32 yy=iy%res;
		f32 h=(1.0-buffer_get_u8(height,(yy*res+xx)*4+3)/(float)255)*strength;
		buffer_set_i16(vertices,(i*l)*2,buffer_get_i16(vertices,(i*l)*2)-math_floor(buffer_get_i16(vertices,(i*l+4)*2)*h));
		buffer_set_i16(vertices,(i*l+1)*2,buffer_get_i16(vertices,(i*l+1)*2)-math_floor(buffer_get_i16(vertices,(i*l+5)*2)*h));
		buffer_set_i16(vertices,(i*l+2)*2,buffer_get_i16(vertices,(i*l+2)*2)-math_floor(buffer_get_i16(vertices,(i*l+3)*2)*h));
	}
	gpu_vertex_buffer_unlock(g->_->vertex_buffer);
	i16_array_t * va0=o->data->vertex_arrays->buffer[0]->values;
	for(i32 i=0;i<math_floor((vertices->length)/(float)4/(float)l);++i){
		va0->buffer[i*4]=buffer_get_i16(vertices,(i*l)*2);
		va0->buffer[i*4+1]=buffer_get_i16(vertices,(i*l+1)*2);
		va0->buffer[i*4+2]=buffer_get_i16(vertices,(i*l+2)*2);
	}
}

void util_mesh_equirect_unwrap(raw_mesh_t * mesh){
	i32 verts=math_floor(mesh->posa->length/(float)4);
	mesh->texa=i16_array_create(verts*2);
	vec4_t n=vec4_create(0.0,0.0,0.0,1.0);
	for(i32 i=0;i<verts;++i){
		n=vec4_create(mesh->posa->buffer[i*4]/(float)32767,mesh->posa->buffer[i*4+1]/(float)32767,mesh->posa->buffer[i*4+2]/(float)32767,1.0);
		n=vec4_norm(n);
		mesh->texa->buffer[i*2]=math_floor(((math_atan2(-n.z,n.x)+math_pi())/(float)(math_pi()*2))*32767);
		mesh->texa->buffer[i*2+1]=math_floor((math_acos(n.y)/(float)math_pi())*32767);
	}
}

bool util_mesh_pnpoly(f32 v0x,f32 v0y,f32 v1x,f32 v1y,f32 v2x,f32 v2y,f32 px,f32 py){
	bool c=false;
	if(((v0y>py)!=(v2y>py))&&(px<(v2x-v0x)*(py-v0y)/(float)(v2y-v0y)+v0x)){
		c=!c;
	}
	if(((v1y>py)!=(v0y>py))&&(px<(v0x-v1x)*(py-v1y)/(float)(v0y-v1y)+v1x)){
		c=!c;
	}
	if(((v2y>py)!=(v1y>py))&&(px<(v1x-v2x)*(py-v2y)/(float)(v1y-v2y)+v2x)){
		c=!c;
	}
	return c;
}

vec4_t util_mesh_calc_normal(vec4_t p0,vec4_t p1,vec4_t p2){
	vec4_t cb=vec4_sub(p2,p1);
	vec4_t ab=vec4_sub(p0,p1);
	cb=vec4_cross(cb,ab);
	cb=vec4_norm(cb);
	return cb;
}

void util_mesh_decimate(){
	mesh_object_t * o=project_paint_objects->buffer[0];
	vertex_array_t_array_t * vas=o->data->vertex_arrays;
	i16_array_t * posa=vas->buffer[0]->values;
	i16_array_t * nora=vas->buffer[1]->values;
	i16_array_t * texa=vas->buffer[2]->values;
	u32_array_t * inda=o->data->index_arrays->buffer[0]->values;
	raw_mesh_t * mesh=GC_ALLOC_INIT(raw_mesh_t, {.posa=posa,.nora=nora,.texa=texa,.cola=null,.inda=inda,.vertex_count=posa->length/4,.index_count=inda->length,.scale_pos=o->data->scale_pos,.scale_tex=1.0,.name="Decimated",});
	import_mesh_add_mesh(mesh);
}

void util_particle_init(){
	if(context_raw->particle_material!=null){
		return ;
	}
		{
		render_target_t * t=render_target_create();
		t->name="texparticle";
		t->width=0;
		t->height=0;
		t->format="R8";
		t->scale=render_path_base_get_super_sampling();
		render_path_create_render_target(t);
	}
	for(i32 i=0;i<_scene_raw->material_datas->length;++i){
		material_data_t * mat=_scene_raw->material_datas->buffer[i];
		if(string_equals(mat->name,"Material2")){
			material_data_t * m=util_clone_material_data(mat);
			m->name="MaterialParticle";
			any_array_push(_scene_raw->material_datas,m);
			break;
		}
	}
	material_data_t * md=data_get_material("Scene","MaterialParticle");
	context_raw->particle_material=md;
	for(i32 i=0;i<_scene_raw->objects->length;++i){
		obj_t * obj=_scene_raw->objects->buffer[i];
		if(string_equals(obj->name,".Sphere")){
			obj_t * particle=util_clone_obj(obj);
			particle->name=".Particle";
			particle->material_refs=any_array_create_from_raw((any[]){"MaterialParticle",},1);
			any_array_push(_scene_raw->objects,particle);
			for(i32 i=0;i<16;++i){
				particle->transform->buffer[i]*=0.01;
			}
			break;
		}
	}
	object_t * o=scene_spawn_object(".Sphere",null,true);
	mesh_object_t * mo=o->ext;
	mo->base->name=".ParticleEmitter";
	mo->base->raw=util_clone_obj(mo->base->raw);
}

void util_particle_init_physics(){
	if(physics_world_active!=null){
		util_particle_init_mesh();
		return ;
	}
	physics_world_create();
	util_particle_init_mesh();
}

void util_particle_init_mesh(){
	if(context_raw->paint_body!=null){
		return ;
	}
	mesh_object_t * po=context_raw->merged_object!=null?context_raw->merged_object:context_raw->paint_object;
	po->base->transform->scale.x=po->base->parent->transform->scale.x;
	po->base->transform->scale.y=po->base->parent->transform->scale.y;
	po->base->transform->scale.z=po->base->parent->transform->scale.z;
	context_raw->paint_body=physics_body_create();
	context_raw->paint_body->shape=physics_shape_t_MESH;
	physics_body_init(context_raw->paint_body,po->base);
}

void util_render_make_material_preview(){
	context_raw->material_preview=true;
	mesh_object_t * sphere=scene_get_child(".Sphere")->ext;
	sphere->base->visible=true;
	mesh_object_t_array_t * meshes=scene_meshes;
	gc_unroot(scene_meshes);scene_meshes=any_array_create_from_raw((any[]){sphere,},1);gc_root(scene_meshes);
	mesh_object_t * painto=context_raw->paint_object;
	context_raw->paint_object=sphere;
	sphere->materials->buffer[0]=project_materials->buffer[0]->data;
	context_raw->material->preview_ready=true;
	context_raw->saved_camera=mat4_clone(scene_camera->base->transform->local);
	mat4_t m=mat4_create(0.9146286343879498,-0.0032648027153306235,0.404281837254303,0.4659988049397712,0.404295023959927,0.007367569133732468,-0.9145989516155143,-1.0687517188018691,0.000007410128652369705,0.9999675337275382,0.008058532943908717,0.015935682577325486,0,0,0,1);
	transform_set_matrix(scene_camera->base->transform,m);
	f32 saved_fov=scene_camera->data->fov;
	scene_camera->data->fov=0.92;
	viewport_update_camera_type(camera_type_t_PERSPECTIVE);
	world_data_t * probe=scene_world;
	f32 _probe_strength=probe->strength;
	probe->strength=7;
	f32 _envmap_angle=context_raw->envmap_angle;
	context_raw->envmap_angle=6.0;
	f32 _brush_scale=context_raw->brush_scale;
	context_raw->brush_scale=1.5;
	f32 _brush_nodes_scale=context_raw->brush_nodes_scale;
	context_raw->brush_nodes_scale=1.0;
	scene_world->_->envmap=context_raw->preview_envmap;
	_render_path_last_w=util_render_material_preview_size;
	_render_path_last_h=util_render_material_preview_size;
	camera_object_build_proj(scene_camera,-1.0);
	camera_object_build_mat(scene_camera);
	make_material_parse_mesh_preview_material(null);
	void(*_commands)(void)=render_path_commands;
	gc_unroot(render_path_commands);render_path_commands=render_path_preview_commands_preview;gc_root(render_path_commands);
	render_path_render_frame();
	gc_unroot(render_path_commands);render_path_commands=_commands;gc_root(render_path_commands);
	context_raw->material_preview=false;
	_render_path_last_w=sys_w();
	_render_path_last_h=sys_h();
	sphere->base->visible=false;
	gc_unroot(scene_meshes);scene_meshes=meshes;gc_root(scene_meshes);
	context_raw->paint_object=painto;
	transform_set_matrix(scene_camera->base->transform,context_raw->saved_camera);
	viewport_update_camera_type(context_raw->camera_type);
	scene_camera->data->fov=saved_fov;
	camera_object_build_proj(scene_camera,-1.0);
	camera_object_build_mat(scene_camera);
	probe->strength=_probe_strength;
	context_raw->envmap_angle=_envmap_angle;
	context_raw->brush_scale=_brush_scale;
	context_raw->brush_nodes_scale=_brush_nodes_scale;
	scene_world->_->envmap=context_raw->show_envmap?context_raw->saved_envmap:context_raw->empty_envmap;
	make_material_parse_mesh_material();
	context_raw->ddirty=0;
}

void util_render_make_decal_preview(){
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	if(context_raw->decal_image==null){
		context_raw->decal_image=gpu_create_render_target(util_render_decal_preview_size,util_render_decal_preview_size,tex_format_t_RGBA64);
	}
	context_raw->decal_preview=true;
	mesh_object_t * plane=scene_get_child(".Plane")->ext;
	plane->base->transform->scale=vec4_create(1,1,1,1.0);
	plane->base->transform->rot=quat_from_euler(-math_pi()/(float)2,0,0);
	transform_build_matrix(plane->base->transform);
	plane->base->visible=true;
	mesh_object_t_array_t * meshes=scene_meshes;
	gc_unroot(scene_meshes);scene_meshes=any_array_create_from_raw((any[]){plane,},1);gc_root(scene_meshes);
	mesh_object_t * painto=context_raw->paint_object;
	context_raw->paint_object=plane;
	context_raw->saved_camera=mat4_clone(scene_camera->base->transform->local);
	mat4_t m=mat4_identity();
	m=mat4_translate(m,0,0,1);
	transform_set_matrix(scene_camera->base->transform,m);
	f32 saved_fov=scene_camera->data->fov;
	scene_camera->data->fov=0.92;
	viewport_update_camera_type(camera_type_t_PERSPECTIVE);
	scene_world->_->envmap=context_raw->preview_envmap;
	_render_path_last_w=util_render_decal_preview_size;
	_render_path_last_h=util_render_decal_preview_size;
	camera_object_build_proj(scene_camera,-1.0);
	camera_object_build_mat(scene_camera);
	make_material_parse_mesh_preview_material(null);
	void(*_commands)(void)=render_path_commands;
	gc_unroot(render_path_commands);render_path_commands=render_path_preview_commands_decal;gc_root(render_path_commands);
	render_path_render_frame();
	gc_unroot(render_path_commands);render_path_commands=_commands;gc_root(render_path_commands);
	context_raw->decal_preview=false;
	_render_path_last_w=sys_w();
	_render_path_last_h=sys_h();
	plane->base->visible=false;
	gc_unroot(scene_meshes);scene_meshes=meshes;gc_root(scene_meshes);
	context_raw->paint_object=painto;
	transform_set_matrix(scene_camera->base->transform,context_raw->saved_camera);
	scene_camera->data->fov=saved_fov;
	viewport_update_camera_type(context_raw->camera_type);
	camera_object_build_proj(scene_camera,-1.0);
	camera_object_build_mat(scene_camera);
	scene_world->_->envmap=context_raw->show_envmap?context_raw->saved_envmap:context_raw->empty_envmap;
	make_material_parse_mesh_material();
	context_raw->ddirty=1;
	if(in_use)draw_begin(current,false,0);
}

void util_render_make_text_preview(){
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	string_t * text=context_raw->text_tool_text;
	draw_font_t * font=context_raw->font->font;
	i32 font_size=util_render_font_preview_size;
	i32 text_w=math_floor(draw_string_width(font,font_size,text));
	i32 text_h=math_floor(draw_font_height(font,font_size));
	i32 tex_w=text_w+32;
	if(tex_w<512){
		tex_w=512;
	}
	if(context_raw->text_tool_image!=null&&context_raw->text_tool_image->width<tex_w){
		iron_delete_texture(context_raw->text_tool_image);
		context_raw->text_tool_image=null;
	}
	if(context_raw->text_tool_image==null){
		context_raw->text_tool_image=gpu_create_render_target(tex_w,tex_w,tex_format_t_RGBA32);
	}
	draw_begin(context_raw->text_tool_image,true,0xff000000);
	draw_set_font(font,font_size);
	draw_set_color(0xffffffff);
	draw_string(text,tex_w/(float)2-text_w/(float)2,tex_w/(float)2-text_h/(float)2);
	draw_end();
	if(in_use)draw_begin(current,false,0);
}

void util_render_make_font_preview(){
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	string_t * text="Abg";
	draw_font_t * font=context_raw->font->font;
	i32 font_size=util_render_font_preview_size;
	i32 text_w=math_floor(draw_string_width(font,font_size,text))+8;
	i32 text_h=math_floor(draw_font_height(font,font_size))+8;
	i32 tex_w=text_w+32;
	if(context_raw->font->image==null){
		context_raw->font->image=gpu_create_render_target(tex_w,tex_w,tex_format_t_RGBA32);
	}
	draw_begin(context_raw->font->image,true,0x00000000);
	draw_set_font(font,font_size);
	draw_set_color(0xffffffff);
	draw_string(text,tex_w/(float)2-text_w/(float)2,tex_w/(float)2-text_h/(float)2);
	draw_end();
	context_raw->font->preview_ready=true;
	if(in_use)draw_begin(current,false,0);
}

void util_render_make_brush_preview(){
	if(render_path_paint_live_layer_locked){
		return ;
	}
	gpu_texture_t * current=_draw_current;
	bool in_use=gpu_in_use;
	if(in_use)draw_end();
	context_raw->material_preview=true;
	if(render_path_paint_live_layer==null){
		gc_unroot(render_path_paint_live_layer);render_path_paint_live_layer=slot_layer_create("_live",layer_slot_type_t_LAYER,null);gc_root(render_path_paint_live_layer);
	}
	slot_layer_t * l=render_path_paint_live_layer;
	slot_layer_clear(l,0x00000000,null,1.0,layers_default_rough,0.0);
	if(context_raw->brush->image==null){
		context_raw->brush->image=gpu_create_render_target(util_render_material_preview_size,util_render_material_preview_size,tex_format_t_RGBA32);
		context_raw->brush->image_icon=gpu_create_render_target(50,50,tex_format_t_RGBA32);
	}
	slot_material_t * _material=context_raw->material;
	context_raw->material=slot_material_create(null,null);
	context_raw->material->nodes->pan_x=context_raw->brush->nodes->pan_x;
	context_raw->material->nodes->pan_y=context_raw->brush->nodes->pan_y;
	context_raw->material->nodes->zoom=context_raw->brush->nodes->zoom;
	workspace_tool_t _tool=context_raw->tool;
	context_raw->tool=workspace_tool_t_BRUSH;
	slot_layer_t * _layer=context_raw->layer;
	if(slot_layer_is_mask(context_raw->layer)){
		context_raw->layer=context_raw->layer->parent;
	}
	slot_material_t * _fill_layer=context_raw->layer->fill_layer;
	context_raw->layer->fill_layer=null;
	render_path_paint_use_live_layer(true);
	make_material_parse_paint_material(false);
	i32 hid=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
	any_map_set(render_path_render_targets,string_join("texpaint_undo",i32_to_string(hid)),any_map_get(render_path_render_targets,"empty_black"));
	mesh_object_t * painto=context_raw->paint_object;
	u8_array_t * visibles=u8_array_create_from_raw((u8[]){},0);
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		u8_array_push(visibles,p->base->visible);
		p->base->visible=false;
	}
	bool merged_object_visible=false;
	if(context_raw->merged_object!=null){
		merged_object_visible=context_raw->merged_object->base->visible;
		context_raw->merged_object->base->visible=false;
	}
	camera_object_t * cam=scene_camera;
	context_raw->saved_camera=mat4_clone(cam->base->transform->local);
	f32 saved_fov=cam->data->fov;
	viewport_update_camera_type(camera_type_t_PERSPECTIVE);
	mat4_t m=mat4_identity();
	m=mat4_translate(m,0,0,0.5);
	transform_set_matrix(cam->base->transform,m);
	cam->data->fov=0.92;
	camera_object_build_proj(cam,-1.0);
	camera_object_build_mat(cam);
	m=mat4_inv(scene_camera->vp);
	mesh_object_t * planeo=scene_get_child(".Plane")->ext;
	planeo->base->visible=true;
	context_raw->paint_object=planeo;
	vec4_t v=vec4_create(0.0,0.0,0.0,1.0);
	v=vec4_create(m.m00,m.m01,m.m02,1.0);
	f32 sx=vec4_len(v);
	planeo->base->transform->rot=quat_from_euler(-math_pi()/(float)2,0,0);
	planeo->base->transform->scale=vec4_create(sx,1.0,sx,1.0);
	planeo->base->transform->loc=vec4_create(m.m30,-m.m31,0.0,1.0);
	transform_build_matrix(planeo->base->transform);
	render_path_paint_live_layer_drawn=0;
	render_path_base_draw_gbuffer();
	f32 _brush_radius=context_raw->brush_radius;
	f32 _brush_opacity=context_raw->brush_opacity;
	f32 _brush_hardness=context_raw->brush_hardness;
	context_raw->brush_radius=0.33;
	context_raw->brush_opacity=1.0;
	context_raw->brush_hardness=0.8;
	f32 _x=context_raw->paint_vec.x;
	f32 _y=context_raw->paint_vec.y;
	f32 _last_x=context_raw->last_paint_vec_x;
	f32 _last_y=context_raw->last_paint_vec_y;
	i32 _pdirty=context_raw->pdirty;
	context_raw->pdirty=2;
	f32_array_t * points_x=f32_array_create_from_raw((f32[]){0.2,0.2,0.35,0.5,0.5,0.5,0.65,0.8,0.8,0.8,},10);
	f32_array_t * points_y=f32_array_create_from_raw((f32[]){0.5,0.5,0.35-0.04,0.2-0.08,0.4+0.015,0.6+0.03,0.45-0.025,0.3-0.05,0.5+0.025,0.7+0.05,},10);
	for(i32 i=1;i<points_x->length;++i){
		context_raw->last_paint_vec_x=points_x->buffer[i-1];
		context_raw->last_paint_vec_y=points_y->buffer[i-1];
		context_raw->paint_vec.x=points_x->buffer[i];
		context_raw->paint_vec.y=points_y->buffer[i];
		render_path_paint_commands_paint(false);
	}
	context_raw->brush_radius=_brush_radius;
	context_raw->brush_opacity=_brush_opacity;
	context_raw->brush_hardness=_brush_hardness;
	context_raw->paint_vec.x=_x;
	context_raw->paint_vec.y=_y;
	context_raw->last_paint_vec_x=_last_x;
	context_raw->last_paint_vec_y=_last_y;
	context_raw->prev_paint_vec_x=-1;
	context_raw->prev_paint_vec_y=-1;
	context_raw->pdirty=_pdirty;
	render_path_paint_use_live_layer(false);
	context_raw->layer->fill_layer=_fill_layer;
	context_raw->layer=_layer;
	context_raw->material=_material;
	context_raw->tool=_tool;
	sys_notify_on_init(&util_render_make_brush_preview_178016	,null);
	context_raw->material_preview=false;
	planeo->base->visible=false;
	for(i32 i=0;i<project_paint_objects->length;++i){
		project_paint_objects->buffer[i]->base->visible=visibles->buffer[i];
	}
	if(context_raw->merged_object!=null){
		context_raw->merged_object->base->visible=merged_object_visible;
	}
	context_raw->paint_object=painto;
	transform_set_matrix(scene_camera->base->transform,context_raw->saved_camera);
	scene_camera->data->fov=saved_fov;
	viewport_update_camera_type(context_raw->camera_type);
	camera_object_build_proj(scene_camera,-1.0);
	camera_object_build_mat(scene_camera);
	l=render_path_paint_live_layer;
	gpu_texture_t * target=context_raw->brush->image;
	draw_begin(target,true,0x00000000);
	draw_set_pipeline(pipes_copy);
	draw_scaled_image(l->texpaint,0,0,target->width,target->height);
	draw_set_pipeline(null);
	draw_end();
	render_target_t * texpreview=any_map_get(render_path_render_targets,"texpreview");
	texpreview->_image=context_raw->brush->image;
	render_target_t * texpreview_icon=any_map_get(render_path_render_targets,"texpreview_icon");
	texpreview_icon->_image=context_raw->brush->image_icon;
	render_path_set_target("texpreview_icon",null,null,clear_flag_t_NONE,0,0.0);
	render_path_bind_target("texpreview","tex");
	render_path_draw_shader("shader_datas/supersample_resolve/supersample_resolve");
	context_raw->brush->preview_ready=true;
	context_raw->brush_blend_dirty=true;
	if(in_use)draw_begin(current,false,0);
}

void util_render_make_brush_preview_178016(){
make_material_parse_paint_material(false);
}

void util_render_make_node_preview(ui_node_canvas_t * canvas,ui_node_t * node,gpu_texture_t * image,ui_node_canvas_t * group,ui_node_t_array_t * parents){
	parse_node_preview_result_t * res=make_material_parse_node_preview_material(node,group,parents);
	if(res==null||res->scon==null){
		return ;
	}
	if(util_render_screen_aligned_full_vb==null){
		util_render_create_screen_aligned_full_data();
	}
	f32 _scale_world=context_raw->paint_object->base->transform->scale_world;
	context_raw->paint_object->base->transform->scale_world=3.0;
	transform_build_matrix(context_raw->paint_object->base->transform);
	_gpu_begin(image,null,null,clear_flag_t_NONE,0,0.0);
	gpu_set_pipeline(res->scon->_->pipe_state);
	string_t_array_t * empty=any_array_create_from_raw((any[]){"",},1);
	uniforms_set_context_consts(res->scon,empty);
	uniforms_set_obj_consts(res->scon,context_raw->paint_object->base);
	uniforms_set_material_consts(res->scon,res->mcon);
	gpu_set_vertex_buffer(util_render_screen_aligned_full_vb);
	gpu_set_index_buffer(util_render_screen_aligned_full_ib);
	gpu_draw();
	gpu_end();
	context_raw->paint_object->base->transform->scale_world=_scale_world;
	transform_build_matrix(context_raw->paint_object->base->transform);
}

void util_render_pick_pos_nor_tex(){
	context_raw->pick_pos_nor_tex=true;
	context_raw->pdirty=1;
	workspace_tool_t _tool=context_raw->tool;
	context_raw->tool=workspace_tool_t_PICKER;
	make_material_parse_paint_material(true);
	if(context_raw->paint2d){
		render_path_paint_set_plane_mesh();
	}
	render_path_paint_commands_paint(false);
	if(context_raw->paint2d){
		render_path_paint_restore_plane_mesh();
	}
	context_raw->tool=_tool;
	context_raw->pick_pos_nor_tex=false;
	make_material_parse_paint_material(true);
	context_raw->pdirty=0;
}

mat4_t util_render_get_decal_mat(){
	util_render_pick_pos_nor_tex();
	mat4_t decal_mat=mat4_identity();
	vec4_t loc=vec4_create(context_raw->posx_picked,context_raw->posy_picked,context_raw->posz_picked,1.0);
	quat_t rot=quat_from_to(vec4_create(0.0,0.0,-1.0,1.0),vec4_create(context_raw->norx_picked,context_raw->nory_picked,context_raw->norz_picked,1.0));
	vec4_t scale=vec4_create(context_raw->brush_radius*0.5,context_raw->brush_radius*0.5,context_raw->brush_radius*0.5,1.0);
	decal_mat=mat4_compose(loc,rot,scale);
	return decal_mat;
}

void util_render_create_screen_aligned_full_data(){
	i16_array_t * data=i16_array_create_from_raw((i16[]){-math_floor(32767/3),-math_floor(32767/3),0,32767,0,0,0,0,0,0,0,0,32767,-math_floor(32767/3),0,32767,0,0,0,0,0,0,0,0,-math_floor(32767/3),32767,0,32767,0,0,0,0,0,0,0,0,},36);
	u32_array_t * indices=u32_array_create_from_raw((u32[]){0,1,2,},3);
	gpu_vertex_structure_t * structure=gpu_vertex_struct_create();
	gpu_vertex_struct_add(structure,"pos",vertex_data_t_I16_4X_NORM);
	gpu_vertex_struct_add(structure,"nor",vertex_data_t_I16_2X_NORM);
	gpu_vertex_struct_add(structure,"tex",vertex_data_t_I16_2X_NORM);
	gpu_vertex_struct_add(structure,"col",vertex_data_t_I16_4X_NORM);
	gc_unroot(util_render_screen_aligned_full_vb);util_render_screen_aligned_full_vb=gpu_create_vertex_buffer(math_floor(data->length/(float)math_floor(gpu_vertex_struct_size(structure)/(float)2)),structure);gc_root(util_render_screen_aligned_full_vb);
	buffer_t * vertices=gpu_lock_vertex_buffer(util_render_screen_aligned_full_vb);
	for(i32 i=0;i<math_floor((vertices->length)/(float)2);++i){
		buffer_set_i16(vertices,i*2,data->buffer[i]);
	}
	gpu_vertex_buffer_unlock(util_render_screen_aligned_full_vb);
	gc_unroot(util_render_screen_aligned_full_ib);util_render_screen_aligned_full_ib=gpu_create_index_buffer(indices->length);gc_root(util_render_screen_aligned_full_ib);
	u32_array_t * id=gpu_lock_index_buffer(util_render_screen_aligned_full_ib);
	for(i32 i=0;i<id->length;++i){
		id->buffer[i]=indices->buffer[i];
	}
	gpu_index_buffer_unlock(util_render_screen_aligned_full_ib);
}

void util_uv_cache_uv_map(){
	if(util_uv_uvmap!=null&&(util_uv_uvmap->width!=config_get_texture_res_x()||util_uv_uvmap->height!=config_get_texture_res_y())){
		iron_delete_texture(util_uv_uvmap);
		gc_unroot(util_uv_uvmap);util_uv_uvmap=null;
		util_uv_uvmap_cached=false;
	}
	if(util_uv_uvmap_cached){
		return ;
	}
	i32 res_x=config_get_texture_res_x();
	i32 res_y=config_get_texture_res_y();
	if(util_uv_uvmap==null){
		gc_unroot(util_uv_uvmap);util_uv_uvmap=gpu_create_render_target(res_x,res_y,tex_format_t_RGBA32);gc_root(util_uv_uvmap);
	}
	util_uv_uvmap_cached=true;
	mesh_object_t * merged=context_raw->merged_object;
	mesh_data_t * mesh=(context_raw->layer_filter==0&&merged!=null)?merged->data:context_raw->paint_object->data;
	i16_array_t * texa=mesh->vertex_arrays->buffer[2]->values;
	u32_array_t * inda=mesh->index_arrays->buffer[0]->values;
	draw_begin(util_uv_uvmap,true,0x00000000);
	draw_set_color(0xffffffff);
	f32 strength=res_x>2048?2.0:1.0;
	f32 f=(1/(float)32767)*util_uv_uvmap->width;
	for(i32 i=0;i<math_floor(inda->length/(float)3);++i){
		f32 x1=(texa->buffer[inda->buffer[i*3]*2])*f;
		f32 x2=(texa->buffer[inda->buffer[i*3+1]*2])*f;
		f32 x3=(texa->buffer[inda->buffer[i*3+2]*2])*f;
		f32 y1=(texa->buffer[inda->buffer[i*3]*2+1])*f;
		f32 y2=(texa->buffer[inda->buffer[i*3+1]*2+1])*f;
		f32 y3=(texa->buffer[inda->buffer[i*3+2]*2+1])*f;
		draw_line_aa(x1,y1,x2,y2,strength);
		draw_line_aa(x2,y2,x3,y3,strength);
		draw_line_aa(x3,y3,x1,y1,strength);
	}
	draw_end();
}

void util_uv_cache_triangle_map(){
	if(util_uv_trianglemap!=null&&(util_uv_trianglemap->width!=config_get_texture_res_x()||util_uv_trianglemap->height!=config_get_texture_res_y())){
		iron_delete_texture(util_uv_trianglemap);
		gc_unroot(util_uv_trianglemap);util_uv_trianglemap=null;
		util_uv_trianglemap_cached=false;
	}
	if(util_uv_trianglemap_cached){
		return ;
	}
	if(util_uv_trianglemap==null){
		gc_unroot(util_uv_trianglemap);util_uv_trianglemap=gpu_create_render_target(config_get_texture_res_x(),config_get_texture_res_y(),tex_format_t_RGBA32);gc_root(util_uv_trianglemap);
	}
	util_uv_trianglemap_cached=true;
	mesh_data_t * merged=context_raw->merged_object!=null?context_raw->merged_object->data:context_raw->paint_object->data;
	mesh_data_t * mesh=merged;
	i16_array_t * texa=mesh->vertex_arrays->buffer[2]->values;
	u32_array_t * inda=mesh->index_arrays->buffer[0]->values;
	draw_begin(util_uv_trianglemap,true,0xff000000);
	f32 f=(1/(float)32767)*util_uv_trianglemap->width;
	i32 color=0xff000001;
	for(i32 i=0;i<math_floor(inda->length/(float)3);++i){
		if(color==0xffffffff)color=0xff000001;
		color++;
		draw_set_color(color);
		f32 x1=(texa->buffer[inda->buffer[i*3]*2])*f;
		f32 x2=(texa->buffer[inda->buffer[i*3+1]*2])*f;
		f32 x3=(texa->buffer[inda->buffer[i*3+2]*2])*f;
		f32 y1=(texa->buffer[inda->buffer[i*3]*2+1])*f;
		f32 y2=(texa->buffer[inda->buffer[i*3+1]*2+1])*f;
		f32 y3=(texa->buffer[inda->buffer[i*3+2]*2+1])*f;
		draw_filled_triangle(x1,y1,x2,y2,x3,y3);
	}
	draw_end();
}

void util_uv_cache_dilate_map(){
	if(util_uv_dilatemap!=null&&(util_uv_dilatemap->width!=config_get_texture_res_x()||util_uv_dilatemap->height!=config_get_texture_res_y())){
		iron_delete_texture(util_uv_dilatemap);
		gc_unroot(util_uv_dilatemap);util_uv_dilatemap=null;
		util_uv_dilatemap_cached=false;
	}
	if(util_uv_dilatemap_cached)return ;
	if(util_uv_dilatemap==null){
		gc_unroot(util_uv_dilatemap);util_uv_dilatemap=gpu_create_render_target(config_get_texture_res_x(),config_get_texture_res_y(),tex_format_t_R8);gc_root(util_uv_dilatemap);
	}
	if(util_uv_pipe_dilate==null){
		gc_unroot(util_uv_pipe_dilate);util_uv_pipe_dilate=gpu_create_pipeline();gc_root(util_uv_pipe_dilate);
		util_uv_pipe_dilate->vertex_shader=sys_get_shader("dilate_map.vert");
		util_uv_pipe_dilate->fragment_shader=sys_get_shader("dilate_map.frag");
		gpu_vertex_structure_t * vs=gpu_vertex_struct_create();
		gpu_vertex_struct_add(vs,"pos",vertex_data_t_I16_4X_NORM);
		gpu_vertex_struct_add(vs,"nor",vertex_data_t_I16_2X_NORM);
		gpu_vertex_struct_add(vs,"tex",vertex_data_t_I16_2X_NORM);
		util_uv_pipe_dilate->input_layout=vs;
		util_uv_pipe_dilate->depth_write=false;
		util_uv_pipe_dilate->depth_mode=compare_mode_t_ALWAYS;
		ARRAY_ACCESS(util_uv_pipe_dilate->color_attachment,0)=tex_format_t_R8;
		gpu_pipeline_compile(util_uv_pipe_dilate);
	}
	i32 mask=context_object_mask_used()?slot_layer_get_object_mask(context_raw->layer):0;
	if(context_layer_filter_used()){
		mask=context_raw->layer_filter;
	}
	mesh_data_t * geom=mask==0&&context_raw->merged_object!=null?context_raw->merged_object->data:context_raw->paint_object->data;
	_gpu_begin(util_uv_dilatemap,null,null,clear_flag_t_COLOR,0x00000000,0.0);
	gpu_set_pipeline(util_uv_pipe_dilate);
	gpu_set_vertex_buffer(geom->_->vertex_buffer);
	gpu_set_index_buffer(geom->_->index_buffers->buffer[0]);
	gpu_draw();
	gpu_end();
	util_uv_dilatemap_cached=true;
	gc_unroot(util_uv_dilate_bytes);util_uv_dilate_bytes=null;
}

void _util_uv_check(i32 cx,i32 cy,i32 w,i32 h,i32 r,buffer_t * view,i32_array_t * coords_x,i32_array_t * coords_y){
	if(cx<0||cx>=w||cy<0||cy>=h){
		return ;
	}
	if(buffer_get_u8(view,cy*w+cx)==255){
		return ;
	}
	if(buffer_get_u8(util_uv_dilate_bytes,cy*r*util_uv_dilatemap->width+cx*r)==0){
		return ;
	}
	buffer_set_u8(view,cy*w+cx,255);
	i32_array_push(coords_x,cx+1);
	i32_array_push(coords_y,cy);
	i32_array_push(coords_x,cx-1);
	i32_array_push(coords_y,cy);
	i32_array_push(coords_x,cx);
	i32_array_push(coords_y,cy+1);
	i32_array_push(coords_x,cx);
	i32_array_push(coords_y,cy-1);
}

void util_uv_cache_uv_island_map(){
	util_uv_cache_dilate_map();
	if(util_uv_dilate_bytes==null){
		gc_unroot(util_uv_dilate_bytes);util_uv_dilate_bytes=gpu_get_texture_pixels(util_uv_dilatemap);gc_root(util_uv_dilate_bytes);
	}
	util_render_pick_pos_nor_tex();
	i32 w=2048;
	i32 h=2048;
	i32 x=math_floor(context_raw->uvx_picked*w);
	i32 y=math_floor(context_raw->uvy_picked*h);
	buffer_t * bytes=buffer_create(w*h);
	i32_array_t * coords_x=i32_array_create_from_raw((i32[]){x,},1);
	i32_array_t * coords_y=i32_array_create_from_raw((i32[]){y,},1);
	i32 r=math_floor(util_uv_dilatemap->width/(float)w);
	while(coords_x->length>0){
		i32 cx=i32_array_pop(coords_x);
		i32 cy=i32_array_pop(coords_y);
		_util_uv_check(cx,cy,w,h,r,bytes,coords_x,coords_y);
	}
	if(util_uv_uvislandmap!=null){
		iron_delete_texture(util_uv_uvislandmap);
	}
	gc_unroot(util_uv_uvislandmap);util_uv_uvislandmap=gpu_create_texture_from_bytes(bytes,w,h,tex_format_t_R8);gc_root(util_uv_uvislandmap);
	util_uv_uvislandmap_cached=true;
}

void viewport_scale_to_bounds(){
	mesh_object_t * po=context_raw->merged_object==null?context_main_object():context_raw->merged_object;
	mesh_data_t * md=po->data;
	vec4_t aabb=mesh_data_calculate_aabb(md);
	f32 r=math_sqrt(aabb.x*aabb.x+aabb.y*aabb.y+aabb.z*aabb.z);
	po=context_main_object();
	po->base->transform->dim.x=aabb.x;
	po->base->transform->dim.y=aabb.y;
	po->base->transform->dim.z=aabb.z;
	po->base->transform->scale=vec4_create(2/(float)r,2/(float)r,2/(float)r,1.0);
	po->base->transform->loc=vec4_create(0,0,0,1.0);
	transform_build_matrix(po->base->transform);
	for(i32 i=0;i<po->base->children->length;++i){
		object_t * c=po->base->children->buffer[i];
		c->transform->loc=vec4_create(0,0,0,1.0);
		transform_build_matrix(c->transform);
	}
}

void viewport_reset(){
	camera_object_t * cam=scene_camera;
	for(i32 i=0;i<_scene_raw->objects->length;++i){
		obj_t * o=_scene_raw->objects->buffer[i];
		if(string_equals(o->type,"camera_object")){
			cam->base->transform->local=mat4_from_f32_array(o->transform,0);
			transform_decompose(cam->base->transform);
			if(context_raw->fov_handle!=null){
				context_raw->fov_handle->value=cam->data->fov=base_default_fov;
			}
			context_raw->cam_handle->position=0;
			cam->data->ortho=null;
			camera_object_build_proj(cam,-1.0);
			context_raw->ddirty=2;
			camera_reset(-1);
			transform_reset(context_main_object()->base->transform);
			break;
		}
	}
}

void viewport_set_view(f32 x,f32 y,f32 z,f32 rx,f32 ry,f32 rz){
	context_raw->paint_object->base->transform->rot=quat_create(0,0,0,1);
	context_raw->paint_object->base->transform->dirty=true;
	camera_object_t * cam=scene_camera;
	f32 dist=vec4_len(cam->base->transform->loc);
	cam->base->transform->loc=vec4_create(x*dist,y*dist,z*dist,1.0);
	cam->base->transform->rot=quat_from_euler(rx,ry,rz);
	transform_build_matrix(cam->base->transform);
	camera_object_build_proj(cam,-1.0);
	context_raw->ddirty=2;
	camera_reset(context_raw->view_index_last);
}

void viewport_orbit(f32 x,f32 y){
	camera_object_t * cam=scene_camera;
	f32 dist=camera_distance();
	transform_move(cam->base->transform,camera_object_look_world(cam),dist);
	transform_rotate(cam->base->transform,vec4_create(0,0,1,1.0),x);
	transform_rotate(cam->base->transform,camera_object_right_world(cam),y);
	transform_move(cam->base->transform,camera_object_look_world(cam),-dist);
	context_raw->ddirty=2;
}

void viewport_orbit_opposite(){
	camera_object_t * cam=scene_camera;
	vec4_t look=camera_object_look(cam);
	f32 z=math_abs(look.z)-1.0;
	(z<0.0001&&z>-0.0001)?viewport_orbit(0,math_pi()):viewport_orbit(math_pi(),0);
}

void viewport_zoom(f32 f){
	camera_object_t * cam=scene_camera;
	transform_move(cam->base->transform,camera_object_look(cam),f);
	context_raw->ddirty=2;
}

void viewport_update_camera_type(i32 camera_type){
	camera_object_t * cam=scene_cameras->buffer[0];
	if(camera_type==camera_type_t_PERSPECTIVE){
		cam->data->ortho=null;
	}
	else {
		f32_array_t * f32a=f32_array_create(4);
		f32 f=cam->data->fov*vec4_len(mat4_get_loc(cam->base->transform->world))/(float)2.5;
		f32a->buffer[0]=-2*f;
		f32a->buffer[1]=2*f;
		f32a->buffer[2]=-2*f*(sys_h()/(float)sys_w());
		f32a->buffer[3]=2*f*(sys_h()/(float)sys_w());
		cam->data->ortho=f32a;
	}
	camera_object_build_proj(cam,-1.0);
	context_raw->ddirty=2;
}

camera_data_t * camera_data_parse(string_t * name,string_t * id){
	scene_t * format=data_get_scene_raw(name);
	camera_data_t * raw=camera_data_get_raw_by_name(format->camera_datas,id);
	if(raw==null){
		iron_log(string_join(string_join("Camera data '",id),"' not found!"));
	}
	return raw;
}

camera_data_t * camera_data_get_raw_by_name(camera_data_t_array_t * datas,string_t * name){
	if(string_equals(name,"")){
		return datas->buffer[0];
	}
	for(i32 i=0;i<datas->length;++i){
		if(string_equals(datas->buffer[i]->name,name)){
			return datas->buffer[i];
		}
	}
	return null;
}

camera_object_t * camera_object_create(camera_data_t * data){
	camera_object_t * raw=GC_ALLOC_INIT(camera_object_t, {0});
	raw->no_jitter_p=mat4_identity();
	raw->frame=0;
	raw->base=object_create(false);
	raw->base->ext=raw;
	raw->base->ext_type="camera_object_t";
	raw->data=data;
	camera_object_build_proj(raw,-1.0);
	raw->v=mat4_identity();
	raw->vp=mat4_identity();
	if(data->frustum_culling){
		raw->frustum_planes=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<6;++i){
			any_array_push(raw->frustum_planes,frustum_plane_create());
		}
	}
	any_array_push(scene_cameras,raw);
	return raw;
}

void camera_object_build_proj(camera_object_t * raw,f32 screen_aspect){
	if(raw->data->ortho!=null){
		raw->p=mat4_ortho(raw->data->ortho->buffer[0],raw->data->ortho->buffer[1],raw->data->ortho->buffer[2],raw->data->ortho->buffer[3],raw->data->near_plane,raw->data->far_plane);
	}
	else {
		if(screen_aspect<0){
			screen_aspect=sys_w()/(float)sys_h();
		}
		f32 aspect=raw->data->aspect?raw->data->aspect:screen_aspect;
		raw->p=mat4_persp(raw->data->fov,aspect,raw->data->near_plane,raw->data->far_plane);
	}
	raw->no_jitter_p=mat4_clone(raw->p);
}

void camera_object_remove(camera_object_t * raw){
	array_remove(scene_cameras,raw);
	object_remove_super(raw->base);
}

void camera_object_render_frame(camera_object_t * raw){
	camera_object_proj_jitter(raw);
	camera_object_build_mat(raw);
	render_path_render_frame();
}

void camera_object_proj_jitter(camera_object_t * raw){
	i32 w=render_path_current_w;
	i32 h=render_path_current_h;
	raw->p=mat4_clone(raw->no_jitter_p);
	i32 i=raw->frame%camera_object_taa_frames;
	f32 x=0.0;
	f32 y=0.0;
	if(i==0){
		x=0.5;
		y=0.333;
	}
	else if(i==1){
		x=-0.5;
		y=-0.333;
	}
	else if(i==2){
		x=0.25;
		y=0.111;
	}
	else if(i==3){
		x=-0.25;
		y=-0.111;
	}
	else if(i==4){
		x=0.375;
		y=0.444;
	}
	else {
		x=-0.375;
		y=-0.444;
	}
	x*=2;
	y*=2;
	raw->p.m20+=x/(float)w;
	raw->p.m21+=y/(float)h;
	raw->frame++;
}

void camera_object_build_mat(camera_object_t * raw){
	transform_build_matrix(raw->base->transform);
	vec4_t sc=mat4_get_scale(raw->base->transform->world);
	if(sc.x!=1.0||sc.y!=1.0||sc.z!=1.0){
		_camera_object_v=vec4_create(1.0/(float)sc.x,1.0/(float)sc.y,1.0/(float)sc.z,1.0);
		raw->base->transform->world=mat4_scale(raw->base->transform->world,_camera_object_v);
	}
	raw->v=mat4_inv(raw->base->transform->world);
	raw->vp=mat4_mult_mat(raw->v,raw->p);
	if(raw->data->frustum_culling){
		camera_object_build_view_frustum(raw->vp,raw->frustum_planes);
	}
}

vec4_t camera_object_right(camera_object_t * raw){
	return vec4_norm(vec4_create(raw->base->transform->local.m00,raw->base->transform->local.m01,raw->base->transform->local.m02,1.0));
}

vec4_t camera_object_up(camera_object_t * raw){
	return vec4_norm(vec4_create(raw->base->transform->local.m10,raw->base->transform->local.m11,raw->base->transform->local.m12,1.0));
}

vec4_t camera_object_look(camera_object_t * raw){
	return vec4_norm(vec4_create(-raw->base->transform->local.m20,-raw->base->transform->local.m21,-raw->base->transform->local.m22,1.0));
}

vec4_t camera_object_right_world(camera_object_t * raw){
	return vec4_norm(vec4_create(raw->base->transform->world.m00,raw->base->transform->world.m01,raw->base->transform->world.m02,1.0));
}

vec4_t camera_object_up_world(camera_object_t * raw){
	return vec4_norm(vec4_create(raw->base->transform->world.m10,raw->base->transform->world.m11,raw->base->transform->world.m12,1.0));
}

vec4_t camera_object_look_world(camera_object_t * raw){
	return vec4_norm(vec4_create(-raw->base->transform->world.m20,-raw->base->transform->world.m21,-raw->base->transform->world.m22,1.0));
}

void camera_object_build_view_frustum(mat4_t vp,frustum_plane_t_array_t * frustum_planes){
	frustum_plane_set_components(frustum_planes->buffer[0],vp.m03+vp.m00,vp.m13+vp.m10,vp.m23+vp.m20,vp.m33+vp.m30);
	frustum_plane_set_components(frustum_planes->buffer[1],vp.m03-vp.m00,vp.m13-vp.m10,vp.m23-vp.m20,vp.m33-vp.m30);
	frustum_plane_set_components(frustum_planes->buffer[2],vp.m03-vp.m01,vp.m13-vp.m11,vp.m23-vp.m21,vp.m33-vp.m31);
	frustum_plane_set_components(frustum_planes->buffer[3],vp.m03+vp.m01,vp.m13+vp.m11,vp.m23+vp.m21,vp.m33+vp.m31);
	frustum_plane_set_components(frustum_planes->buffer[4],vp.m02,vp.m12,vp.m22,vp.m32);
	frustum_plane_set_components(frustum_planes->buffer[5],vp.m03-vp.m02,vp.m13-vp.m12,vp.m23-vp.m22,vp.m33-vp.m32);
	for(i32 i=0;i<frustum_planes->length;++i){
		frustum_plane_t * plane=frustum_planes->buffer[i];
		frustum_plane_normalize(plane);
	}
}

bool camera_object_sphere_in_frustum(frustum_plane_t_array_t * frustum_planes,transform_t * t,f32 radius_scale,f32 offset_x,f32 offset_y,f32 offset_z){
	f32 radius=t->radius*radius_scale;
	for(i32 i=0;i<frustum_planes->length;++i){
		frustum_plane_t * plane=frustum_planes->buffer[i];
		_camera_object_sphere_center=vec4_create(transform_world_x(t)+offset_x,transform_world_y(t)+offset_y,transform_world_z(t)+offset_z,1.0);
		if(frustum_plane_dist_to_sphere(plane,_camera_object_sphere_center,radius)+radius*2<0){
			return false;
		}
	}
	return true;
}

frustum_plane_t * frustum_plane_create(){
	frustum_plane_t * raw=GC_ALLOC_INIT(frustum_plane_t, {0});
	raw->normal=vec4_create(1.0,0.0,0.0,1.0);
	raw->constant=0.0;
	return raw;
}

void frustum_plane_normalize(frustum_plane_t * raw){
	f32 inv_normal_length=1.0/(float)vec4_len(raw->normal);
	raw->normal=vec4_mult(raw->normal,inv_normal_length);
	raw->constant*=inv_normal_length;
}

f32 frustum_plane_dist_to_sphere(frustum_plane_t * raw,vec4_t sphere_center,f32 sphere_radius){
	return (vec4_dot(raw->normal,sphere_center)+raw->constant)-sphere_radius;
}

void frustum_plane_set_components(frustum_plane_t * raw,f32 x,f32 y,f32 z,f32 w){
	raw->normal=vec4_create(x,y,z,1.0);
	raw->constant=w;
}

void const_data_create_screen_aligned_data(){
	f32_array_t * data=f32_array_create_from_raw((f32[]){-1.0,-1.0,3.0,-1.0,-1.0,3.0,},6);
	i32_array_t * indices=i32_array_create_from_raw((i32[]){0,1,2,},3);
	gpu_vertex_structure_t * structure=gpu_vertex_struct_create();
	gpu_vertex_struct_add(structure,"pos",vertex_data_t_F32_2X);
	gc_unroot(const_data_screen_aligned_vb);const_data_screen_aligned_vb=gpu_create_vertex_buffer(math_floor(data->length/(float)math_floor(gpu_vertex_struct_size(structure)/(float)4)),structure);gc_root(const_data_screen_aligned_vb);
	buffer_t * vertices=gpu_lock_vertex_buffer(const_data_screen_aligned_vb);
	for(i32 i=0;i<math_floor((vertices->length)/(float)4);++i){
		buffer_set_f32(vertices,i*4,data->buffer[i]);
	}
	gpu_vertex_buffer_unlock(const_data_screen_aligned_vb);
	gc_unroot(const_data_screen_aligned_ib);const_data_screen_aligned_ib=gpu_create_index_buffer(indices->length);gc_root(const_data_screen_aligned_ib);
	u32_array_t * id=gpu_lock_index_buffer(const_data_screen_aligned_ib);
	for(i32 i=0;i<id->length;++i){
		id->buffer[i]=indices->buffer[i];
	}
	gpu_index_buffer_unlock(const_data_screen_aligned_ib);
}

void const_data_create_skydome_data(){
	gpu_vertex_structure_t * structure=gpu_vertex_struct_create();
	gpu_vertex_struct_add(structure,"pos",vertex_data_t_F32_3X);
	gpu_vertex_struct_add(structure,"nor",vertex_data_t_F32_3X);
	i32 struct_length=math_floor(gpu_vertex_struct_size(structure)/(float)4);
	gc_unroot(const_data_skydome_vb);const_data_skydome_vb=gpu_create_vertex_buffer(math_floor(_const_data_skydome_pos_count/(float)3),structure);gc_root(const_data_skydome_vb);
	buffer_t * vertices=gpu_lock_vertex_buffer(const_data_skydome_vb);
	for(i32 i=0;i<math_floor((vertices->length)/(float)4/(float)struct_length);++i){
		buffer_set_f32(vertices,(i*struct_length)*4,ARRAY_ACCESS(_const_data_skydome_pos,i*3));
		buffer_set_f32(vertices,(i*struct_length+1)*4,ARRAY_ACCESS(_const_data_skydome_pos,i*3+1));
		buffer_set_f32(vertices,(i*struct_length+2)*4,ARRAY_ACCESS(_const_data_skydome_pos,i*3+2));
		buffer_set_f32(vertices,(i*struct_length+3)*4,ARRAY_ACCESS(_const_data_skydome_nor,i*3));
		buffer_set_f32(vertices,(i*struct_length+4)*4,ARRAY_ACCESS(_const_data_skydome_nor,i*3+1));
		buffer_set_f32(vertices,(i*struct_length+5)*4,ARRAY_ACCESS(_const_data_skydome_nor,i*3+2));
	}
	gpu_vertex_buffer_unlock(const_data_skydome_vb);
	gc_unroot(const_data_skydome_ib);const_data_skydome_ib=gpu_create_index_buffer(_const_data_skydome_indices_count);gc_root(const_data_skydome_ib);
	u32_array_t * id=gpu_lock_index_buffer(const_data_skydome_ib);
	for(i32 i=0;i<id->length;++i){
		id->buffer[i]=ARRAY_ACCESS(_const_data_skydome_indices,i);
	}
	gpu_index_buffer_unlock(const_data_skydome_ib);
}

mesh_data_t * data_get_mesh(string_t * file,string_t * name){
	string_t * handle=string_join(file,name);
	mesh_data_t * cached=any_map_get(data_cached_meshes,handle);
	if(cached!=null){
		return cached;
	}
	mesh_data_t * b=mesh_data_parse(file,name);
	any_map_set(data_cached_meshes,handle,b);
	b->_->handle=handle;
	return b;
}

camera_data_t * data_get_camera(string_t * file,string_t * name){
	string_t * handle=string_join(file,name);
	camera_data_t * cached=any_map_get(data_cached_cameras,handle);
	if(cached!=null){
		return cached;
	}
	camera_data_t * b=camera_data_parse(file,name);
	any_map_set(data_cached_cameras,handle,b);
	return b;
}

material_data_t * data_get_material(string_t * file,string_t * name){
	string_t * handle=string_join(file,name);
	material_data_t * cached=any_map_get(data_cached_materials,handle);
	if(cached!=null){
		return cached;
	}
	material_data_t * b=material_data_parse(file,name);
	any_map_set(data_cached_materials,handle,b);
	return b;
}

world_data_t * data_get_world(string_t * file,string_t * name){
	if(name==null){
		return null;
	}
	string_t * handle=string_join(file,name);
	world_data_t * cached=any_map_get(data_cached_worlds,handle);
	if(cached!=null){
		return cached;
	}
	world_data_t * b=world_data_parse(file,name);
	any_map_set(data_cached_worlds,handle,b);
	return b;
}

shader_data_t * data_get_shader(string_t * file,string_t * name){
	string_t * handle=name;
	shader_data_t * cached=any_map_get(data_cached_shaders,handle);
	if(cached!=null){
		return cached;
	}
	shader_data_t * b=shader_data_parse(file,name);
	any_map_set(data_cached_shaders,handle,b);
	return b;
}

scene_t * data_get_scene_raw(string_t * file){
	scene_t * cached=any_map_get(data_cached_scene_raws,file);
	if(cached!=null){
		return cached;
	}
	string_t * ext=ends_with(file,".arm")?"":".arm";
	buffer_t * b=data_get_blob(string_join(file,ext));
	scene_t * parsed=armpack_decode(b);
	any_map_set(data_cached_scene_raws,file,parsed);
	return parsed;
}

buffer_t * data_get_blob(string_t * file){
	buffer_t * cached=any_map_get(data_cached_blobs,file);
	if(cached!=null){
		return cached;
	}
	buffer_t * b=iron_load_blob(data_resolve_path(file));
	any_map_set(data_cached_blobs,file,b);
	data_assets_loaded++;
	return b;
}

gpu_texture_t * data_get_image(string_t * file){
	gpu_texture_t * cached=any_map_get(data_cached_images,file);
	if(cached!=null){
		return cached;
	}
	any image_=iron_load_texture(data_resolve_path(file));
	if(image_==null){
		return null;
	}
	gpu_texture_t * b=image_;
	any_map_set(data_cached_images,file,b);
	data_assets_loaded++;
	return b;
}

video_t * data_get_video(string_t * file){
	file=string_join(substring(file,0,string_length(file)-4),".webm");
	video_t * cached=any_map_get(data_cached_videos,file);
	if(cached!=null){
		return cached;
	}
	return null;
}

draw_font_t * data_get_font(string_t * file){
	draw_font_t * cached=any_map_get(data_cached_fonts,file);
	if(cached!=null){
		return cached;
	}
	buffer_t * blob=iron_load_blob(data_resolve_path(file));
	draw_font_t * b=GC_ALLOC_INIT(draw_font_t, {.buf=blob,.index=0});
	any_map_set(data_cached_fonts,file,b);
	data_assets_loaded++;
	return b;
}

void data_delete_mesh(string_t * handle){
	mesh_data_t * mesh=any_map_get(data_cached_meshes,handle);
	if(mesh==null){
		return ;
	}
	mesh_data_delete(mesh);
	map_delete(data_cached_meshes,handle);
}

void data_delete_blob(string_t * handle){
	buffer_t * blob=any_map_get(data_cached_blobs,handle);
	if(blob==null){
		return ;
	}
	map_delete(data_cached_blobs,handle);
}

void data_delete_image(string_t * handle){
	gpu_texture_t * image=any_map_get(data_cached_images,handle);
	if(image==null){
		return ;
	}
	iron_delete_texture(image);
	map_delete(data_cached_images,handle);
}

void data_delete_video(string_t * handle){
	video_t * video=any_map_get(data_cached_videos,handle);
	if(video==null){
		return ;
	}
	video_unload(video);
	map_delete(data_cached_videos,handle);
}

void data_delete_font(string_t * handle){
	draw_font_t * font=any_map_get(data_cached_fonts,handle);
	if(font==null){
		return ;
	}
	draw_font_destroy(font);
	map_delete(data_cached_fonts,handle);
}

void data_delete_all(){
	string_t_array_t * cached_meshes_keys=map_keys(data_cached_meshes);
	for(i32 i=0;i<cached_meshes_keys->length;++i){
		mesh_data_t * c=any_map_get(data_cached_meshes,cached_meshes_keys->buffer[i]);
		mesh_data_delete(c);
	}
	gc_unroot(data_cached_meshes);data_cached_meshes=any_map_create();gc_root(data_cached_meshes);
	string_t_array_t * cached_shaders_keys=map_keys(data_cached_shaders);
	for(i32 i=0;i<cached_shaders_keys->length;++i){
		shader_data_t * c=any_map_get(data_cached_shaders,cached_shaders_keys->buffer[i]);
		shader_data_delete(c);
	}
	gc_unroot(data_cached_shaders);data_cached_shaders=any_map_create();gc_root(data_cached_shaders);
	gc_unroot(data_cached_scene_raws);data_cached_scene_raws=any_map_create();gc_root(data_cached_scene_raws);
	gc_unroot(data_cached_cameras);data_cached_cameras=any_map_create();gc_root(data_cached_cameras);
	gc_unroot(data_cached_materials);data_cached_materials=any_map_create();gc_root(data_cached_materials);
	gc_unroot(data_cached_worlds);data_cached_worlds=any_map_create();gc_root(data_cached_worlds);
	render_path_unload();
	gc_unroot(data_cached_blobs);data_cached_blobs=any_map_create();gc_root(data_cached_blobs);
	string_t_array_t * cached_images_keys=map_keys(data_cached_images);
	for(i32 i=0;i<cached_images_keys->length;++i){
		gpu_texture_t * c=any_map_get(data_cached_images,cached_images_keys->buffer[i]);
		iron_delete_texture(c);
	}
	gc_unroot(data_cached_images);data_cached_images=any_map_create();gc_root(data_cached_images);
	string_t_array_t * cached_videos_keys=map_keys(data_cached_videos);
	for(i32 i=0;i<cached_videos_keys->length;++i){
		video_t * c=any_map_get(data_cached_videos,cached_videos_keys->buffer[i]);
		video_unload(c);
	}
	gc_unroot(data_cached_videos);data_cached_videos=any_map_create();gc_root(data_cached_videos);
	string_t_array_t * cached_fonts_keys=map_keys(data_cached_fonts);
	for(i32 i=0;i<cached_fonts_keys->length;++i){
		draw_font_t * c=any_map_get(data_cached_fonts,cached_fonts_keys->buffer[i]);
		draw_font_destroy(c);
	}
	gc_unroot(data_cached_fonts);data_cached_fonts=any_map_create();gc_root(data_cached_fonts);
}

string_t * data_sep(){
	return "\\";
}

string_t * data_path(){
	return string_join(string_join(string_join(".",data_sep()),"data"),data_sep());
}

bool data_is_abs(string_t * file){
	return string_equals(char_at(file,0),"/")||string_equals(char_at(file,1),":")||(string_equals(char_at(file,0),"\\")&&string_equals(char_at(file,1),"\\"));
}

bool data_is_up(string_t * file){
	return string_equals(char_at(file,0),".")&&string_equals(char_at(file,1),".");
}

string_t * data_base_name(string_t * path){
	i32 slash=string_last_index_of(path,data_sep());
	return slash>=0?substring(path,slash+1,string_length(path)):path;
}

string_t * data_resolve_path(string_t * file){
	if(data_is_abs(file)||data_is_up(file)){
		return file;
	}
	return string_join(data_path(),file);
}

void input_reset(){
	mouse_reset();
	pen_reset();
	keyboard_reset();
	gamepad_reset();
}

void input_end_frame(){
	mouse_end_frame();
	pen_end_frame();
	keyboard_end_frame();
	gamepad_end_frame();
}

void _input_on_foreground(){
	mouse_reset();
}

void input_register(){
	if(_input_registered){
		return ;
	}
	_input_registered=true;
	sys_notify_on_end_frame(input_end_frame,null);
	sys_notify_on_reset(input_reset,null);
	sys_notify_on_app_state(_input_on_foreground,null,null,null,null);
	keyboard_reset();
	gamepad_reset();
}

void mouse_end_frame(){
	_mouse_buttons_started->buffer[0]=_mouse_buttons_started->buffer[1]=_mouse_buttons_started->buffer[2]=_mouse_buttons_started->buffer[3]=_mouse_buttons_started->buffer[4]=false;
	_mouse_buttons_released->buffer[0]=_mouse_buttons_released->buffer[1]=_mouse_buttons_released->buffer[2]=_mouse_buttons_released->buffer[3]=_mouse_buttons_released->buffer[4]=false;
	mouse_moved=false;
	mouse_movement_x=0;
	mouse_movement_y=0;
	mouse_wheel_delta=0;
}

void mouse_reset(){
	_mouse_buttons_down->buffer[0]=_mouse_buttons_down->buffer[1]=_mouse_buttons_down->buffer[2]=_mouse_buttons_down->buffer[3]=_mouse_buttons_down->buffer[4]=false;
	mouse_end_frame();
}

i32 mouse_button_index(string_t * button){
	for(i32 i=0;i<_mouse_buttons->length;++i){
		if(string_equals(_mouse_buttons->buffer[i],button)){
			return i;
		}
	}
	return 0;
}

bool mouse_down(string_t * button){
	return _mouse_buttons_down->buffer[mouse_button_index(button)];
}

bool mouse_down_any(){
	return _mouse_buttons_down->buffer[0]||_mouse_buttons_down->buffer[1]||_mouse_buttons_down->buffer[2]||_mouse_buttons_down->buffer[3]||_mouse_buttons_down->buffer[4];
}

bool mouse_started(string_t * button){
	return _mouse_buttons_started->buffer[mouse_button_index(button)];
}

bool mouse_started_any(){
	return _mouse_buttons_started->buffer[0]||_mouse_buttons_started->buffer[1]||_mouse_buttons_started->buffer[2]||_mouse_buttons_started->buffer[3]||_mouse_buttons_started->buffer[4];
}

bool mouse_released(string_t * button){
	return _mouse_buttons_released->buffer[mouse_button_index(button)];
}

void mouse_lock(){
	if(iron_mouse_can_lock()){
		iron_mouse_lock();
		mouse_locked=true;
		mouse_hidden=true;
	}
}

void mouse_unlock(){
	if(iron_mouse_can_lock()){
		iron_mouse_unlock();
		mouse_locked=false;
		mouse_hidden=false;
	}
}

void mouse_hide(){
	iron_mouse_hide();
	mouse_hidden=true;
}

void mouse_show(){
	iron_mouse_show();
	mouse_hidden=false;
}

void mouse_down_listener(i32 index,i32 x,i32 y){
	if(pen_in_use){
		return ;
	}
	_mouse_buttons_down->buffer[index]=true;
	_mouse_buttons_started->buffer[index]=true;
	mouse_x=x;
	mouse_y=y;
}

void mouse_up_listener(i32 index,i32 x,i32 y){
	if(pen_in_use){
		return ;
	}
	_mouse_buttons_down->buffer[index]=false;
	_mouse_buttons_released->buffer[index]=true;
	mouse_x=x;
	mouse_y=y;
}

void mouse_move_listener(i32 x,i32 y,i32 movement_x,i32 movement_y){
	if(mouse_last_x==-1.0&&mouse_last_y==-1.0){
		mouse_last_x=x;
		mouse_last_y=y;
	}
	if(mouse_locked){
		mouse_movement_x+=movement_x;
		mouse_movement_y+=movement_y;
	}
	else {
		mouse_movement_x+=x-mouse_last_x;
		mouse_movement_y+=y-mouse_last_y;
	}
	mouse_last_x=x;
	mouse_last_y=y;
	mouse_x=x;
	mouse_y=y;
	mouse_moved=true;
}

void mouse_wheel_listener(i32 delta){
	mouse_wheel_delta=delta;
}

f32 mouse_view_x(){
	return mouse_x-sys_x();
}

f32 mouse_view_y(){
	return mouse_y-sys_y();
}

void pen_end_frame(){
	pen_buttons_started->buffer[0]=false;
	pen_buttons_released->buffer[0]=false;
	pen_moved=false;
	pen_movement_x=0;
	pen_movement_y=0;
	pen_in_use=false;
}

void pen_reset(){
	pen_buttons_down->buffer[0]=false;
	pen_end_frame();
}

i32 pen_button_index(string_t * button){
	return 0;
}

bool pen_down(string_t * button){
	return pen_buttons_down->buffer[pen_button_index(button)];
}

bool pen_started(string_t * button){
	return pen_buttons_started->buffer[pen_button_index(button)];
}

bool pen_released(string_t * button){
	return pen_buttons_released->buffer[pen_button_index(button)];
}

void pen_down_listener(i32 x,i32 y,f32 pressure){
	pen_buttons_down->buffer[0]=true;
	pen_buttons_started->buffer[0]=true;
	pen_x=x;
	pen_y=y;
	pen_pressure=pressure;
	mouse_down_listener(0,x,y);
}

void pen_up_listener(i32 x,i32 y,f32 pressure){
	if(pen_buttons_started->buffer[0]){
		pen_buttons_started->buffer[0]=false;
		pen_in_use=true;
		return ;
	}
	pen_buttons_down->buffer[0]=false;
	pen_buttons_released->buffer[0]=true;
	pen_x=x;
	pen_y=y;
	pen_pressure=pressure;
	mouse_up_listener(0,x,y);
	pen_in_use=true;
}

void pen_move_listener(i32 x,i32 y,f32 pressure){
	if(pen_last_x==-1.0&&pen_last_y==-1.0){
		pen_last_x=x;
		pen_last_y=y;
	}
	pen_movement_x=x-pen_last_x;
	pen_movement_y=y-pen_last_y;
	pen_last_x=x;
	pen_last_y=y;
	pen_x=x;
	pen_y=y;
	pen_moved=true;
	pen_pressure=pressure;
	pen_connected=true;
}

f32 pen_view_x(){
	return pen_x-sys_x();
}

f32 pen_view_y(){
	return pen_y-sys_y();
}

void keyboard_end_frame(){
	if(keyboard_keys_frame->length>0){
		for(i32 i=0;i<keyboard_keys_frame->length;++i){
			string_t * s=keyboard_keys_frame->buffer[i];
			i32_map_set(keyboard_keys_started,s,false);
			i32_map_set(keyboard_keys_released,s,false);
		}
		array_splice(keyboard_keys_frame,0,keyboard_keys_frame->length);
	}
	if(sys_time()-keyboard_repeat_time>0.05){
		keyboard_repeat_time=sys_time();
		keyboard_repeat_key=true;
	}
	else {
		keyboard_repeat_key=false;
	}
}

void keyboard_reset(){
	for(i32 i=0;i<keyboard_keys->length;++i){
		string_t * s=keyboard_keys->buffer[i];
		i32_map_set(keyboard_keys_down,s,false);
		i32_map_set(keyboard_keys_started,s,false);
		i32_map_set(keyboard_keys_released,s,false);
	}
	keyboard_end_frame();
}

bool keyboard_down(string_t * key){
	return i32_map_get(keyboard_keys_down,key);
}

bool keyboard_started(string_t * key){
	return i32_map_get(keyboard_keys_started,key);
}

bool keyboard_started_any(){
	return keyboard_keys_frame->length>0;
}

bool keyboard_released(string_t * key){
	return i32_map_get(keyboard_keys_released,key);
}

bool keyboard_repeat(string_t * key){
	return i32_map_get(keyboard_keys_started,key)||(keyboard_repeat_key&&i32_map_get(keyboard_keys_down,key));
}

string_t * keyboard_key_code(key_code_t key){
	if(key==key_code_t_SPACE){
		return "space";
	}
	else if(key==key_code_t_BACKSPACE){
		return "backspace";
	}
	else if(key==key_code_t_TAB){
		return "tab";
	}
	else if(key==key_code_t_RETURN){
		return "enter";
	}
	else if(key==key_code_t_SHIFT){
		return "shift";
	}
	else if(key==key_code_t_CONTROL){
		return "control";
	}
	else if(key==key_code_t_ALT){
		return "alt";
	}
	else if(key==key_code_t_WIN){
		return "win";
	}
	else if(key==key_code_t_ESCAPE){
		return "escape";
	}
	else if(key==key_code_t_DELETE){
		return "delete";
	}
	else if(key==key_code_t_UP){
		return "up";
	}
	else if(key==key_code_t_DOWN){
		return "down";
	}
	else if(key==key_code_t_LEFT){
		return "left";
	}
	else if(key==key_code_t_RIGHT){
		return "right";
	}
	else if(key==key_code_t_BACK){
		return "back";
	}
	else if(key==key_code_t_COMMA){
		return ",";
	}
	else if(key==key_code_t_PERIOD){
		return ".";
	}
	else if(key==key_code_t_COLON){
		return ":";
	}
	else if(key==key_code_t_SEMICOLON){
		return ";";
	}
	else if(key==key_code_t_LESS_THAN){
		return "<";
	}
	else if(key==key_code_t_EQUALS){
		return "=";
	}
	else if(key==key_code_t_GREATER_THAN){
		return ">";
	}
	else if(key==key_code_t_QUESTION_MARK){
		return "?";
	}
	else if(key==key_code_t_EXCLAMATION){
		return "!";
	}
	else if(key==key_code_t_DOUBLE_QUOTE){
		return "\"";
	}
	else if(key==key_code_t_HASH){
		return "#";
	}
	else if(key==key_code_t_DOLLAR){
		return "$";
	}
	else if(key==key_code_t_PERCENT){
		return "%";
	}
	else if(key==key_code_t_AMPERSAND){
		return "&";
	}
	else if(key==key_code_t_UNDERSCORE){
		return "_";
	}
	else if(key==key_code_t_OPEN_PAREN){
		return "(";
	}
	else if(key==key_code_t_CLOSE_PAREN){
		return ")";
	}
	else if(key==key_code_t_ASTERISK){
		return "*";
	}
	else if(key==key_code_t_PIPE){
		return "|";
	}
	else if(key==key_code_t_OPEN_CURLY_BRACKET){
		return "{";
	}
	else if(key==key_code_t_CLOSE_CURLY_BRACKET){
		return "}";
	}
	else if(key==key_code_t_OPEN_BRACKET){
		return "[";
	}
	else if(key==key_code_t_CLOSE_BRACKET){
		return "]";
	}
	else if(key==key_code_t_TILDE){
		return "~";
	}
	else if(key==key_code_t_BACK_QUOTE){
		return "`";
	}
	else if(key==key_code_t_SLASH){
		return "/";
	}
	else if(key==key_code_t_BACK_SLASH){
		return "\\";
	}
	else if(key==key_code_t_AT){
		return "@";
	}
	else if(key==key_code_t_ADD){
		return "+";
	}
	else if(key==key_code_t_PLUS){
		return "+";
	}
	else if(key==key_code_t_SUBTRACT){
		return "-";
	}
	else if(key==key_code_t_HYPHEN_MINUS){
		return "-";
	}
	else if(key==key_code_t_MULTIPLY){
		return "*";
	}
	else if(key==key_code_t_DIVIDE){
		return "/";
	}
	else if(key==key_code_t_DECIMAL){
		return ".";
	}
	else if(key==key_code_t_ZERO){
		return "0";
	}
	else if(key==key_code_t_NUMPAD0){
		return "0";
	}
	else if(key==key_code_t_ONE){
		return "1";
	}
	else if(key==key_code_t_NUMPAD1){
		return "1";
	}
	else if(key==key_code_t_TWO){
		return "2";
	}
	else if(key==key_code_t_NUMPAD2){
		return "2";
	}
	else if(key==key_code_t_THREE){
		return "3";
	}
	else if(key==key_code_t_NUMPAD3){
		return "3";
	}
	else if(key==key_code_t_FOUR){
		return "4";
	}
	else if(key==key_code_t_NUMPAD4){
		return "4";
	}
	else if(key==key_code_t_FIVE){
		return "5";
	}
	else if(key==key_code_t_NUMPAD5){
		return "5";
	}
	else if(key==key_code_t_SIX){
		return "6";
	}
	else if(key==key_code_t_NUMPAD6){
		return "6";
	}
	else if(key==key_code_t_SEVEN){
		return "7";
	}
	else if(key==key_code_t_NUMPAD7){
		return "7";
	}
	else if(key==key_code_t_EIGHT){
		return "8";
	}
	else if(key==key_code_t_NUMPAD8){
		return "8";
	}
	else if(key==key_code_t_NINE){
		return "9";
	}
	else if(key==key_code_t_NUMPAD9){
		return "9";
	}
	else if(key==key_code_t_F1){
		return "f1";
	}
	else if(key==key_code_t_F2){
		return "f2";
	}
	else if(key==key_code_t_F3){
		return "f3";
	}
	else if(key==key_code_t_F4){
		return "f4";
	}
	else if(key==key_code_t_F5){
		return "f5";
	}
	else if(key==key_code_t_F6){
		return "f6";
	}
	else if(key==key_code_t_F7){
		return "f7";
	}
	else if(key==key_code_t_F8){
		return "f8";
	}
	else if(key==key_code_t_F9){
		return "f9";
	}
	else if(key==key_code_t_F10){
		return "f10";
	}
	else if(key==key_code_t_F11){
		return "f11";
	}
	else if(key==key_code_t_F12){
		return "f12";
	}
	else {
		return to_lower_case(string_from_char_code(key));
	}
}

void keyboard_down_listener(key_code_t code){
	string_t * s=keyboard_key_code(code);
	any_array_push(keyboard_keys_frame,s);
	i32_map_set(keyboard_keys_started,s,true);
	i32_map_set(keyboard_keys_down,s,true);
	keyboard_repeat_time=sys_time()+0.4;
}

void keyboard_up_listener(key_code_t code){
	string_t * s=keyboard_key_code(code);
	any_array_push(keyboard_keys_frame,s);
	i32_map_set(keyboard_keys_released,s,true);
	i32_map_set(keyboard_keys_down,s,false);
}

void keyboard_press_listener(string_t * c){
}

void gamepad_end_frame(){
}

gamepad_stick_t * gamepad_stick_create(){
	gamepad_stick_t * raw=GC_ALLOC_INIT(gamepad_stick_t, {0});
	raw->x=0.0;
	raw->y=0.0;
	raw->last_x=0.0;
	raw->last_y=0.0;
	raw->moved=false;
	raw->movement_x=0.0;
	raw->movement_y=0.0;
	return raw;
}

gamepad_t * gamepad_create(){
	gamepad_t * raw=GC_ALLOC_INIT(gamepad_t, {0});
	raw->buttons_down=f32_array_create_from_raw((f32[]){},0);
	raw->buttons_started=u8_array_create_from_raw((u8[]){},0);
	raw->buttons_released=u8_array_create_from_raw((u8[]){},0);
	raw->buttons_frame=i32_array_create_from_raw((i32[]){},0);
	raw->left_stick=gamepad_stick_create();
	raw->right_stick=gamepad_stick_create();
	return raw;
}

void gamepad_reset(){
	gc_unroot(gamepad_raws);gamepad_raws=any_array_create_from_raw((any[]){},0);gc_root(gamepad_raws);
	for(i32 i=0;i<4;++i){
		gamepad_t * g=gamepad_create();
		any_array_push(gamepad_raws,g);
		for(i32 i=0;i<gamepad_buttons->length;++i){
			f32_array_push(g->buttons_down,0.0);
			u8_array_push(g->buttons_started,false);
			u8_array_push(g->buttons_released,false);
		}
	}
	gamepad_end_frame();
}

string_t * gamepad_key_code(i32 button){
	return gamepad_buttons->buffer[button];
}

i32 gamepad_button_index(string_t * button){
	for(i32 i=0;i<gamepad_buttons->length;++i){
		if(string_equals(gamepad_buttons->buffer[i],button)){
			return i;
		}
	}
	return 0;
}

f32 gamepad_down(i32 i,string_t * button){
	return gamepad_raws->buffer[i]->buttons_down->buffer[gamepad_button_index(button)];
}

bool gamepad_started(i32 i,string_t * button){
	return gamepad_raws->buffer[i]->buttons_started->buffer[gamepad_button_index(button)];
}

bool gamepad_released(i32 i,string_t * button){
	return gamepad_raws->buffer[i]->buttons_released->buffer[gamepad_button_index(button)];
}

void gamepad_axis_listener(i32 i,i32 axis,f32 value){
	gamepad_stick_t * stick=axis<=1?gamepad_raws->buffer[i]->left_stick:gamepad_raws->buffer[i]->right_stick;
	if(axis==0||axis==2){
		stick->last_x=stick->x;
		stick->x=value;
		stick->movement_x=stick->x-stick->last_x;
	}
	else if(axis==1||axis==3){
		stick->last_y=stick->y;
		stick->y=value;
		stick->movement_y=stick->y-stick->last_y;
	}
	stick->moved=true;
}

void gamepad_button_listener(i32 i,i32 button,f32 value){
}

gpu_vertex_structure_t * gpu_vertex_struct_create(){
	gpu_vertex_structure_t * raw=GC_ALLOC_INIT(gpu_vertex_structure_t, {0});
	return raw;
}

void gpu_vertex_struct_add(gpu_vertex_structure_t * raw,string_t * name,vertex_data_t data){
	gpu_vertex_element_t * e=ADDRESS(ARRAY_ACCESS(raw->elements,raw->size));
	e->name=string_copy(name);
	e->data=data;
	raw->size++;
}

f32 ui_SCALE(ui_t * ui){
	ui_t * current=ui_get_current();
	ui_set_current(ui);
	f32 f=UI_SCALE();
	ui_set_current(current);
	return f;
}

f32 ui_ELEMENT_OFFSET(ui_t * ui){
	ui_t * current=ui_get_current();
	ui_set_current(ui);
	f32 f=UI_ELEMENT_OFFSET();
	ui_set_current(current);
	return f;
}

f32 ui_ELEMENT_W(ui_t * ui){
	ui_t * current=ui_get_current();
	ui_set_current(ui);
	f32 f=UI_ELEMENT_W();
	ui_set_current(current);
	return f;
}

f32 ui_ELEMENT_H(ui_t * ui){
	ui_t * current=ui_get_current();
	ui_set_current(ui);
	f32 f=UI_ELEMENT_H();
	ui_set_current(current);
	return f;
}

f32 ui_MENUBAR_H(ui_t * ui){
	f32 button_offset_y=(ui->ops->theme->ELEMENT_H*ui_SCALE(ui)-ui->ops->theme->BUTTON_H*ui_SCALE(ui))/(float)2;
	return ui->ops->theme->BUTTON_H*ui_SCALE(ui)*1.1+2+button_offset_y;
}

f32 ui_nodes_INPUT_Y(ui_node_canvas_t * canvas,ui_node_socket_t_array_t * sockets,i32 pos){
	return UI_INPUT_Y(canvas,sockets->buffer,sockets->length,pos);
}

ui_state_t _ui_image(gpu_texture_t * image,i32 tint,f32 h,i32 sx,i32 sy,i32 sw,i32 sh){
	return ui_sub_image(image,tint,h,sx,sy,sw,sh);
}

bool ui_window(ui_handle_t * handle,i32 x,i32 y,i32 w,i32 h,bool drag){
	return _ui_window(handle,x,y,w,h,drag);
}

void ui_end(bool last){
	_ui_end(last);
}

void _ui_set_scale(ui_t * ui,f32 factor){
	ui_t * current=ui_get_current();
	ui_set_current(ui);
	ui_set_scale(factor);
	ui_set_current(current);
}

void _ui_end_element(f32 element_size){
	if(element_size<0){
		ui_end_element();
	}
	else {
		ui_end_element_of_size(element_size);
	}
}

void _ui_end_input(ui_t * ui){
	ui_t * current=ui_get_current();
	ui_set_current(ui);
	ui_end_input();
	ui_set_current(current);
}

ui_handle_t * ui_handle(string_t * s){
	ui_handle_t * h=any_map_get(ui_children,s);
	if(h==null){
		h=ui_handle_create();
		any_map_set(ui_children,s,h);
		return h;
	}
	h->init=false;
	return h;
}

ui_t * ui_create(ui_options_t * ops){
	ui_t * raw=GC_ALLOC_INIT(ui_t, {0});
	ui_init(raw,ops);
	return raw;
}

ui_theme_t * ui_theme_create(){
	ui_theme_t * raw=GC_ALLOC_INIT(ui_theme_t, {0});
	ui_theme_default(raw);
	return raw;
}

void nodes_on_custom_button(i32 node_id,string_t * button_name){
	void(*f)(i32)=any_map_get(ui_nodes_custom_buttons,button_name);
	f(node_id);
}

ui_nodes_t * ui_nodes_create(){
	ui_nodes_t * raw=GC_ALLOC_INIT(ui_nodes_t, {0});
	ui_nodes_init(raw);
	gc_unroot(ui_nodes_exclude_remove);ui_nodes_exclude_remove=any_array_create_from_raw((any[]){"OUTPUT_MATERIAL_PBR","GROUP_OUTPUT","GROUP_INPUT","BrushOutputNode",},4);gc_root(ui_nodes_exclude_remove);
	ui_nodes_on_custom_button=nodes_on_custom_button;
	return raw;
}

ui_node_socket_t * ui_get_socket(ui_node_t_array_t * nodes,i32 id){
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * n=nodes->buffer[i];
		for(i32 j=0;j<n->inputs->length;++j){
			ui_node_socket_t * s=n->inputs->buffer[j];
			if(s->id==id){
				return s;
			}
		}
		for(i32 j=0;j<n->outputs->length;++j){
			ui_node_socket_t * s=n->outputs->buffer[j];
			if(s->id==id){
				return s;
			}
		}
	}
	return null;
}

void ui_set_font(ui_t * raw,draw_font_t * font){
	draw_font_init(font);
	raw->ops->font=font;
}

u32 lz4_encode_bound(u32 size){
	u32 i=size/(float)255;
	return size>0x7e000000?0:size+(i|0)+16;
}

buffer_t * lz4_encode(buffer_t * b){
	u8_array_t * ibuf=b;
	u32 ilen=ibuf->length;
	if(ilen>=0x7e000000){
		iron_log("LZ4 range error");
		return null;
	}
	u32 last_match_pos=ilen-12;
	u32 last_literal_pos=ilen-5;
	if(_lz4_hash_table==null){
		gc_unroot(_lz4_hash_table);_lz4_hash_table=i32_array_create(65536);gc_root(_lz4_hash_table);
	}
	for(u32 i=0;i<_lz4_hash_table->length;++i){
		_lz4_hash_table->buffer[i]=-65536;
	}
	u32 olen=lz4_encode_bound(ilen);
	u8_array_t * obuf=u8_array_create(olen);
	u32 ipos=0;
	u32 opos=0;
	u32 anchor_pos=0;
	while(true){
		u32 ref_pos=0;
		u32 moffset=0;
		u32 sequence=ibuf->buffer[ipos]<<8|ibuf->buffer[ipos+1]<<16|ibuf->buffer[ipos+2]<<24;
		while(ipos<=last_match_pos){
			sequence=sequence>>8|ibuf->buffer[ipos+3]<<24;
			u32 hash=(sequence*0x9e37&0xffff)+(sequence*0x79b1>>16)&0xffff;
			ref_pos=_lz4_hash_table->buffer[hash];
			_lz4_hash_table->buffer[hash]=ipos;
			moffset=ipos-ref_pos;
			if(moffset<65536&&ibuf->buffer[ref_pos+0]==((sequence)&0xff)&&ibuf->buffer[ref_pos+1]==((sequence>>8)&0xff)&&ibuf->buffer[ref_pos+2]==((sequence>>16)&0xff)&&ibuf->buffer[ref_pos+3]==((sequence>>24)&0xff)){
				break;
			}
			ipos+=1;
		}
		if(ipos>last_match_pos){
			break;
		}
		u32 llen=ipos-anchor_pos;
		u32 mlen=ipos;
		ipos+=4;
		ref_pos+=4;
		while(ipos<last_literal_pos&&ibuf->buffer[ipos]==ibuf->buffer[ref_pos]){
			ipos+=1;
			ref_pos+=1;
		}
		mlen=ipos-mlen;
		u32 token=mlen<19?mlen-4:15;
		if(llen>=15){
			obuf->buffer[opos++]=0xf0|token;
			u32 l=llen-15;
			while(l>=255){
				obuf->buffer[opos++]=255;
				l-=255;
			}
			obuf->buffer[opos++]=l;
		}
		else {
			obuf->buffer[opos++]=(llen<<4)|token;
		}
		while(llen-->0){
			obuf->buffer[opos++]=ibuf->buffer[anchor_pos++];
		}
		if(mlen==0){
			break;
		}
		obuf->buffer[opos+0]=moffset;
		obuf->buffer[opos+1]=moffset>>8;
		opos+=2;
		if(mlen>=19){
			u32 l=mlen-19;
			while(l>=255){
				obuf->buffer[opos++]=255;
				l-=255;
			}
			obuf->buffer[opos++]=l;
		}
		anchor_pos=ipos;
	}
	u32 llen=ilen-anchor_pos;
	if(llen>=15){
		obuf->buffer[opos++]=0xf0;
		u32 l=llen-15;
		while(l>=255){
			obuf->buffer[opos++]=255;
			l-=255;
		}
		obuf->buffer[opos++]=l;
	}
	else {
		obuf->buffer[opos++]=llen<<4;
	}
	while(llen-->0){
		obuf->buffer[opos++]=ibuf->buffer[anchor_pos++];
	}
	return buffer_slice(obuf,0,opos);
}

buffer_t * lz4_decode(buffer_t * b,u32 olen){
	u8_array_t * ibuf=b;
	u32 ilen=ibuf->length;
	u8_array_t * obuf=u8_array_create(olen);
	u32 ipos=0;
	u32 opos=0;
	while(ipos<ilen){
		u32 token=ibuf->buffer[ipos++];
		u32 clen=token>>4;
		if(clen!=0){
			if(clen==15){
				u32 l=0;
				while(true){
					l=ibuf->buffer[ipos++];
					if(l!=255){
						break;
					}
					clen+=255;
				}
				clen+=l;
			}
			u32 end=ipos+clen;
			while(ipos<end){
				obuf->buffer[opos++]=ibuf->buffer[ipos++];
			}
			if(ipos==ilen){
				break;
			}
		}
		u32 moffset=ibuf->buffer[ipos+0]|(ibuf->buffer[ipos+1]<<8);
		if(moffset==0||moffset>opos){
			return null;
		}
		ipos+=2;
		clen=(token&0x0f)+4;
		if(clen==19){
			u32 l=0;
			while(true){
				l=ibuf->buffer[ipos++];
				if(l!=255){
					break;
				}
				clen+=255;
			}
			clen+=l;
		}
		u32 mpos=opos-moffset;
		u32 end=opos+clen;
		while(opos<end){
			obuf->buffer[opos++]=obuf->buffer[mpos++];
		}
	}
	return obuf;
}

material_data_t * material_data_create(material_data_t * raw,string_t * file){
	raw->_=GC_ALLOC_INIT(material_data_runtime_t, {0});
	raw->_->uid=++_material_data_uid_counter;
	string_t_array_t * ref=string_split(raw->shader,"/");
	string_t * object_file="";
	string_t * data_ref="";
	if(ref->length==2){
		object_file=string_copy(ref->buffer[0]);
		data_ref=string_copy(ref->buffer[1]);
	}
	else {
		object_file=string_copy(file);
		data_ref=string_copy(raw->shader);
	}
	shader_data_t * b=data_get_shader(object_file,data_ref);
	raw->_->shader=b;
	raw->_->contexts=any_array_create_from_raw((any[]){},0);
	while(raw->_->contexts->length<raw->contexts->length){
		any_array_push(raw->_->contexts,null);
	}
	for(i32 i=0;i<raw->contexts->length;++i){
		material_context_t * c=raw->contexts->buffer[i];
		material_context_t * self=material_context_create(c);
		raw->_->contexts->buffer[i]=self;
	}
	return raw;
}

material_data_t * material_data_parse(string_t * file,string_t * name){
	scene_t * format=data_get_scene_raw(file);
	material_data_t * raw=material_data_get_raw_by_name(format->material_datas,name);
	if(raw==null){
		iron_log(string_join(string_join("Material data '",name),"' not found!"));
		return null;
	}
	return material_data_create(raw,file);
}

material_data_t * material_data_get_raw_by_name(material_data_t_array_t * datas,string_t * name){
	if(string_equals(name,"")){
		return datas->buffer[0];
	}
	for(i32 i=0;i<datas->length;++i){
		if(string_equals(datas->buffer[i]->name,name)){
			return datas->buffer[i];
		}
	}
	return null;
}

material_context_t * material_data_get_context(material_data_t * raw,string_t * name){
	for(i32 i=0;i<raw->_->contexts->length;++i){
		material_context_t * c=raw->_->contexts->buffer[i];
		if(string_equals(substring(c->name,0,string_length(name)),name)){
			return c;
		}
	}
	return null;
}

material_context_t * material_context_create(material_context_t * raw){
	raw->_=GC_ALLOC_INIT(material_context_runtime_t, {0});
	if(raw->bind_textures!=null&&raw->bind_textures->length>0){
		raw->_->textures=any_array_create_from_raw((any[]){},0);
		for(i32 i=0;i<raw->bind_textures->length;++i){
			bind_tex_t * tex=raw->bind_textures->buffer[i];
			if(string_equals(tex->file,"")){
				continue;
			}
			gpu_texture_t * image=data_get_image(tex->file);
			any_array_push(raw->_->textures,image);
		}
	}
	return raw;
}

mesh_data_t * mesh_data_parse(string_t * name,string_t * id){
	scene_t * format=data_get_scene_raw(name);
	mesh_data_t * raw=mesh_data_get_raw_by_name(format->mesh_datas,id);
	if(raw==null){
		iron_log(string_join(string_join("Mesh data '",id),"' not found!"));
		return null;
	}
	mesh_data_t * data=mesh_data_create(raw);
	return data;
}

mesh_data_t * mesh_data_get_raw_by_name(mesh_data_t_array_t * datas,string_t * name){
	if(string_equals(name,"")){
		return datas->buffer[0];
	}
	for(i32 i=0;i<datas->length;++i){
		if(string_equals(datas->buffer[i]->name,name)){
			return datas->buffer[i];
		}
	}
	return null;
}

mesh_data_t * mesh_data_create(mesh_data_t * raw){
	raw->_=GC_ALLOC_INIT(mesh_data_runtime_t, {0});
	if(!raw->scale_pos){
		raw->scale_pos=1.0;
	}
	if(!raw->scale_tex){
		raw->scale_tex=1.0;
	}
	raw->_->refcount=0;
	raw->_->vertex_buffer_map=any_map_create();
	raw->_->ready=false;
	u32_array_t_array_t * indices=any_array_create_from_raw((any[]){},0);
	i32_array_t * material_indices=i32_array_create_from_raw((i32[]){},0);
	for(i32 i=0;i<raw->index_arrays->length;++i){
		index_array_t * ind=raw->index_arrays->buffer[i];
		any_array_push(indices,ind->values);
		i32_array_push(material_indices,ind->material);
	}
	vertex_array_t_array_t * vertex_arrays=raw->vertex_arrays;
	if(raw->skin!=null){
		vertex_array_t * va_bone=GC_ALLOC_INIT(vertex_array_t, {0});
		va_bone->attrib="bone";
		va_bone->values=null;
		va_bone->data="short4norm";
		vertex_array_t * va_weight=GC_ALLOC_INIT(vertex_array_t, {0});
		va_weight->attrib="weight";
		va_weight->values=null;
		va_weight->data="short4norm";
		any_array_push(vertex_arrays,va_bone);
		any_array_push(vertex_arrays,va_weight);
	}
	if(raw->skin!=null){
		i32 size=mesh_data_get_vertex_size(vertex_arrays->buffer[0]->data);
		i32 vertex_length=math_floor(vertex_arrays->buffer[0]->values->length/(float)size);
		i32 l=vertex_length*4;
		i16_array_t * bonea=i16_array_create(l);
		i16_array_t * weighta=i16_array_create(l);
		i32 index=0;
		i32 ai=0;
		for(i32 i=0;i<vertex_length;++i){
			i32 bone_count=raw->skin->bone_count_array->buffer[i];
			for(i32 j=index;j<index+bone_count;++j){
				bonea->buffer[ai]=raw->skin->bone_index_array->buffer[j];
				weighta->buffer[ai]=raw->skin->bone_weight_array->buffer[j];
				ai++;
			}
			for(i32 j=bone_count;j<4;++j){
				bonea->buffer[ai]=0;
				weighta->buffer[ai]=0;
				ai++;
			}
			index+=bone_count;
		}
		vertex_arrays->buffer[vertex_arrays->length-2]->values=bonea;
		vertex_arrays->buffer[vertex_arrays->length-1]->values=weighta;
	}
	raw->_->indices=indices;
	raw->_->material_indices=material_indices;
	raw->_->structure=mesh_data_get_vertex_struct(raw->vertex_arrays);
	return raw;
}

gpu_vertex_structure_t * mesh_data_get_vertex_struct(vertex_array_t_array_t * vertex_arrays){
	gpu_vertex_structure_t * structure=gpu_vertex_struct_create();
	for(i32 i=0;i<vertex_arrays->length;++i){
		gpu_vertex_struct_add(structure,vertex_arrays->buffer[i]->attrib,mesh_data_get_vertex_data(vertex_arrays->buffer[i]->data));
	}
	return structure;
}

vertex_data_t mesh_data_get_vertex_data(string_t * data){
	if(string_equals(data,"short4norm")){
		return vertex_data_t_I16_4X_NORM;
	}
	else if(string_equals(data,"short2norm")){
		return vertex_data_t_I16_2X_NORM;
	}
	else {
		return vertex_data_t_I16_4X_NORM;
	}
}

void mesh_data_build_vertices(buffer_t * vertices,vertex_array_t_array_t * vertex_arrays,i32 offset,bool fake_uvs,i32 uvs_index){
	i32 size=mesh_data_get_vertex_size(vertex_arrays->buffer[0]->data);
	i32 num_verts=vertex_arrays->buffer[0]->values->length/(float)size;
	i32 di=-1+offset;
	for(i32 i=0;i<num_verts;++i){
		for(i32 va=0;va<vertex_arrays->length;++va){
			i32 l=mesh_data_get_vertex_size(vertex_arrays->buffer[va]->data);
			if(fake_uvs&&va==uvs_index){
				for(i32 j=0;j<l;++j){
					buffer_set_i16(vertices,++di*2,0);
				}
				continue;
			}
			for(i32 o=0;o<l;++o){
				buffer_set_i16(vertices,++di*2,vertex_arrays->buffer[va]->values->buffer[i*l+o]);
			}
		}
	}
}

i32 mesh_data_get_vertex_size(string_t * vertex_data){
	if(string_equals(vertex_data,"short4norm")){
		return 4;
	}
	else if(string_equals(vertex_data,"short2norm")){
		return 2;
	}
	else {
		return 0;
	}
}

vertex_array_t * mesh_data_get_vertex_array(mesh_data_t * raw,string_t * name){
	for(i32 i=0;i<raw->vertex_arrays->length;++i){
		if(string_equals(raw->vertex_arrays->buffer[i]->attrib,name)){
			return raw->vertex_arrays->buffer[i];
		}
	}
	return null;
}

gpu_buffer_t * mesh_data_get(mesh_data_t * raw,vertex_element_t_array_t * vs){
	string_t * key="";
	for(i32 i=0;i<vs->length;++i){
		vertex_element_t * e=vs->buffer[i];
		key=string_join(key,e->name);
	}
	gpu_buffer_t * vb=any_map_get(raw->_->vertex_buffer_map,key);
	if(vb==null){
		vertex_array_t_array_t * vertex_arrays=any_array_create_from_raw((any[]){},0);
		bool has_tex=false;
		i32 tex_offset=-1;
		bool has_col=false;
		for(i32 e=0;e<vs->length;++e){
			if(string_equals(vs->buffer[e]->name,"tex")){
				has_tex=true;
				tex_offset=e;
			}
			else if(string_equals(vs->buffer[e]->name,"col")){
				has_col=true;
			}
			for(i32 va=0;va<raw->vertex_arrays->length;++va){
				string_t * name=vs->buffer[e]->name;
				if(string_equals(name,raw->vertex_arrays->buffer[va]->attrib)){
					any_array_push(vertex_arrays,raw->vertex_arrays->buffer[va]);
				}
			}
		}
		vertex_array_t * positions=mesh_data_get_vertex_array(raw,"pos");
		vertex_array_t * uvs=mesh_data_get_vertex_array(raw,"tex");
		vertex_array_t * cols=mesh_data_get_vertex_array(raw,"col");
		gpu_vertex_structure_t * vstruct=mesh_data_get_vertex_struct(vertex_arrays);
		i32 size=mesh_data_get_vertex_size(positions->data);
		vb=gpu_create_vertex_buffer(math_floor(positions->values->length/(float)size),vstruct);
		raw->_->vertices=gpu_lock_vertex_buffer(vb);
		mesh_data_build_vertices(raw->_->vertices,vertex_arrays,0,has_tex&&uvs==null,tex_offset);
		gpu_vertex_buffer_unlock(vb);
		any_map_set(raw->_->vertex_buffer_map,key,vb);
		if(has_tex&&uvs==null){
			iron_log(string_join(string_join("Geometry ",raw->name)," is missing UV map"));
		}
		if(has_col&&cols==null){
			iron_log(string_join(string_join("Geometry ",raw->name)," is missing vertex colors"));
		}
	}
	return vb;
}

void mesh_data_build(mesh_data_t * raw){
	if(raw->_->ready){
		return ;
	}
	vertex_array_t * positions=mesh_data_get_vertex_array(raw,"pos");
	i32 size=mesh_data_get_vertex_size(positions->data);
	raw->_->vertex_buffer=gpu_create_vertex_buffer(math_floor(positions->values->length/(float)size),raw->_->structure);
	raw->_->vertices=gpu_lock_vertex_buffer(raw->_->vertex_buffer);
	mesh_data_build_vertices(raw->_->vertices,raw->vertex_arrays,0,false,-1);
	gpu_vertex_buffer_unlock(raw->_->vertex_buffer);
	string_t * struct_str="";
	for(i32 i=0;i<raw->_->structure->size;++i){
		gpu_vertex_element_t * e=ADDRESS(ARRAY_ACCESS(raw->_->structure->elements,i));
		struct_str=string_join(struct_str,e->name);
	}
	any_map_set(raw->_->vertex_buffer_map,struct_str,raw->_->vertex_buffer);
	raw->_->index_buffers=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<raw->_->indices->length;++i){
		u32_array_t * id=raw->_->indices->buffer[i];
		if(id->length==0){
			continue;
		}
		gpu_buffer_t * index_buffer=gpu_create_index_buffer(id->length);
		u32_array_t * indices_array=gpu_lock_index_buffer(index_buffer);
		for(i32 i=0;i<indices_array->length;++i){
			indices_array->buffer[i]=id->buffer[i];
		}
		gpu_index_buffer_unlock(index_buffer);
		any_array_push(raw->_->index_buffers,index_buffer);
	}
	raw->_->ready=true;
}

vec4_t mesh_data_calculate_aabb(mesh_data_t * raw){
	vec4_t aabb_min=vec4_create(-0.01,-0.01,-0.01,1.0);
	vec4_t aabb_max=vec4_create(0.01,0.01,0.01,1.0);
	vec4_t aabb=vec4_create(0.0,0.0,0.0,1.0);
	i32 i=0;
	vertex_array_t * positions=mesh_data_get_vertex_array(raw,"pos");
	while(i<positions->values->length){
		if(positions->values->buffer[i]>aabb_max.x){
			aabb_max.x=positions->values->buffer[i];
		}
		if(positions->values->buffer[i+1]>aabb_max.y){
			aabb_max.y=positions->values->buffer[i+1];
		}
		if(positions->values->buffer[i+2]>aabb_max.z){
			aabb_max.z=positions->values->buffer[i+2];
		}
		if(positions->values->buffer[i]<aabb_min.x){
			aabb_min.x=positions->values->buffer[i];
		}
		if(positions->values->buffer[i+1]<aabb_min.y){
			aabb_min.y=positions->values->buffer[i+1];
		}
		if(positions->values->buffer[i+2]<aabb_min.z){
			aabb_min.z=positions->values->buffer[i+2];
		}
		i+=4;
	}
	aabb.x=(math_abs(aabb_min.x)+math_abs(aabb_max.x))/(float)32767*raw->scale_pos;
	aabb.y=(math_abs(aabb_min.y)+math_abs(aabb_max.y))/(float)32767*raw->scale_pos;
	aabb.z=(math_abs(aabb_min.z)+math_abs(aabb_max.z))/(float)32767*raw->scale_pos;
	return aabb;
}

void mesh_data_delete(mesh_data_t * raw){
	string_t_array_t * vertex_buffer_keys=map_keys(raw->_->vertex_buffer_map);
	for(i32 i=0;i<vertex_buffer_keys->length;++i){
		gpu_buffer_t * buf=any_map_get(raw->_->vertex_buffer_map,vertex_buffer_keys->buffer[i]);
		if(buf!=null){
			gpu_delete_buffer(buf);
		}
	}
	for(i32 i=0;i<raw->_->index_buffers->length;++i){
		gpu_buffer_t * buf=raw->_->index_buffers->buffer[i];
		gpu_delete_buffer(buf);
	}
}

mesh_object_t * mesh_object_create(mesh_data_t * data,material_data_t_array_t * materials){
	mesh_object_t * raw=GC_ALLOC_INIT(mesh_object_t, {0});
	raw->material_index=0;
	raw->screen_size=0.0;
	raw->frustum_culling=true;
	raw->base=object_create(false);
	raw->base->ext=raw;
	raw->base->ext_type="mesh_object_t";
	raw->materials=materials;
	mesh_object_set_data(raw,data);
	any_array_push(scene_meshes,raw);
	return raw;
}

void mesh_object_set_data(mesh_object_t * raw,mesh_data_t * data){
	raw->data=data;
	data->_->refcount++;
	mesh_data_build(data);
	raw->base->transform->scale_world=data->scale_pos;
}

void mesh_object_remove(mesh_object_t * raw){
	array_remove(scene_meshes,raw);
	raw->data->_->refcount--;
	object_remove_super(raw->base);
}

void mesh_object_setup_animation(mesh_object_t * raw,scene_t_array_t * oactions){
}

bool mesh_object_set_culled(mesh_object_t * raw,bool b){
	raw->base->culled=b;
	return b;
}

bool mesh_object_cull_material(mesh_object_t * raw,string_t * context){
	if(!mesh_object_valid_context(raw,raw->materials,context)){
		return true;
	}
	if(!raw->base->visible){
		return mesh_object_set_culled(raw,true);
	}
	if(string_equals(raw->skip_context,context)){
		return mesh_object_set_culled(raw,true);
	}
	if(raw->force_context!=null&&!string_equals(raw->force_context,context)){
		return mesh_object_set_culled(raw,true);
	}
	return mesh_object_set_culled(raw,false);
}

bool mesh_object_cull_mesh(mesh_object_t * raw,string_t * context,camera_object_t * camera){
	if(camera==null){
		return false;
	}
	if(camera->data->frustum_culling&&raw->frustum_culling){
		f32 radius_scale=1.0;
		frustum_plane_t_array_t * frustum_planes=camera->frustum_planes;
		if(!camera_object_sphere_in_frustum(frustum_planes,raw->base->transform,radius_scale,0.0,0.0,0.0)){
			return mesh_object_set_culled(raw,true);
		}
	}
	raw->base->culled=false;
	return raw->base->culled;
}

void mesh_object_get_contexts(mesh_object_t * raw,string_t * context,material_data_t_array_t * materials,material_context_t_array_t * material_contexts,shader_context_t_array_t * shader_contexts){
	for(i32 i=0;i<materials->length;++i){
		material_data_t * mat=materials->buffer[i];
		bool found=false;
		for(i32 j=0;j<mat->contexts->length;++j){
			if(string_equals(substring(mat->contexts->buffer[j]->name,0,string_length(context)),context)){
				any_array_push(material_contexts,mat->_->contexts->buffer[j]);
				any_array_push(shader_contexts,shader_data_get_context(mat->_->shader,context));
				found=true;
				break;
			}
		}
		if(!found){
			any_array_push(material_contexts,null);
			any_array_push(shader_contexts,null);
		}
	}
}

void mesh_object_render(mesh_object_t * raw,string_t * context,string_t_array_t * bind_params){
	if(raw->data==null||!raw->data->_->ready){
		return ;
	}
	if(!raw->base->visible){
		return ;
	}
	if(mesh_object_cull_mesh(raw,context,scene_camera)){
		return ;
	}
	if(mesh_object_cull_material(raw,context)){
		return ;
	}
	material_context_t_array_t * material_contexts=_mesh_object_material_contexts;
	shader_context_t_array_t * shader_contexts=_mesh_object_shader_contexts;
	material_contexts->length=0;
	shader_contexts->length=0;
	mesh_object_get_contexts(raw,context,raw->materials,material_contexts,shader_contexts);
	uniforms_pos_unpack=raw->data->scale_pos;
	uniforms_tex_unpack=raw->data->scale_tex;
	transform_update(raw->base->transform);
	for(i32 i=0;i<raw->data->_->index_buffers->length;++i){
		i32 mi=raw->data->_->material_indices->buffer[i];
		if(shader_contexts->length<=mi||shader_contexts->buffer[mi]==null){
			continue;
		}
		raw->material_index=mi;
		shader_context_t * scontext=shader_contexts->buffer[mi];
		if(scontext==null){
			continue;
		}
		vertex_element_t_array_t * elems=scontext->vertex_elements;
		if(scontext->_->pipe_state!=_mesh_object_last_pipeline){
			gpu_set_pipeline(scontext->_->pipe_state);
			gc_unroot(_mesh_object_last_pipeline);_mesh_object_last_pipeline=scontext->_->pipe_state;gc_root(_mesh_object_last_pipeline);
		}
		uniforms_set_context_consts(scontext,bind_params);
		uniforms_set_obj_consts(scontext,raw->base);
		if(material_contexts->length>mi){
			uniforms_set_material_consts(scontext,material_contexts->buffer[mi]);
		}
		gpu_set_vertex_buffer(mesh_data_get(raw->data,elems));
		gpu_set_index_buffer(raw->data->_->index_buffers->buffer[i]);
		gpu_draw();
	}
}

bool mesh_object_valid_context(mesh_object_t * raw,material_data_t_array_t * mats,string_t * context){
	for(i32 i=0;i<mats->length;++i){
		material_data_t * mat=mats->buffer[i];
		if(material_data_get_context(mat,context)!=null){
			return true;
		}
	}
	return false;
}

void mesh_object_compute_camera_dist(mesh_object_t * raw,f32 cam_x,f32 cam_y,f32 cam_z){
	raw->camera_dist=vec4_fdist(cam_x,cam_y,cam_z,transform_world_x(raw->base->transform),transform_world_y(raw->base->transform),transform_world_z(raw->base->transform));
}

void mesh_object_compute_screen_size(mesh_object_t * raw,camera_object_t * camera){
	transform_t * tr=raw->base->transform;
	f32 volume=tr->dim.x*tr->dim.y*tr->dim.z;
	raw->screen_size=volume*(1.0/(float)raw->camera_dist);
	raw->screen_size=raw->screen_size>1.0?1.0:raw->screen_size;
}

object_t * object_create(bool is_empty){
	object_t * raw=GC_ALLOC_INIT(object_t, {0});
	raw->name="";
	raw->children=any_array_create_from_raw((any[]){},0);
	raw->visible=true;
	raw->culled=false;
	raw->uid=_object_uid_counter++;
	raw->transform=transform_create(raw);
	raw->is_empty=is_empty;
	if(raw->is_empty&&_scene_ready){
		any_array_push(scene_empties,raw);
	}
	return raw;
}

void object_set_parent(object_t * raw,object_t * parent_object,bool parent_inv,bool keep_transform){
	if(parent_object==raw||parent_object==raw->parent){
		return ;
	}
	if(raw->parent!=null){
		array_remove(raw->parent->children,raw);
		if(keep_transform){
			transform_apply_parent(raw->transform);
		}
		raw->parent=null;
		transform_build_matrix(raw->transform);
	}
	if(parent_object==null){
		parent_object=_scene_scene_parent;
	}
	raw->parent=parent_object;
	any_array_push(raw->parent->children,raw);
	if(parent_inv){
		transform_apply_parent_inv(raw->transform);
	}
}

void object_remove_super(object_t * raw){
	if(raw->is_empty&&_scene_ready){
		array_remove(scene_empties,raw);
	}
	while(raw->children->length>0){
		object_remove(raw->children->buffer[0]);
	}
	if(raw->parent!=null){
		array_remove(raw->parent->children,raw);
		raw->parent=null;
	}
}

void object_remove(object_t * raw){
	if(string_equals(raw->ext_type,"mesh_object_t")){
		mesh_object_remove(raw->ext);
	}
	else if(string_equals(raw->ext_type,"camera_object_t")){
		camera_object_remove(raw->ext);
	}
	else {
		object_remove_super(raw);
	}
}

object_t * object_get_child(object_t * raw,string_t * name){
	if(string_equals(raw->name,name)){
		return raw;
	}
	else {
		for(i32 i=0;i<raw->children->length;++i){
			object_t * c=raw->children->buffer[i];
			object_t * r=object_get_child(c,name);
			if(r!=null){
				return r;
			}
		}
	}
	return null;
}

object_t_array_t * object_get_children(object_t * raw,bool recursive){
	if(!recursive){
		return raw->children;
	}
	object_t_array_t * ret_children=array_slice(raw->children,0,raw->children->length);
	for(i32 i=0;i<raw->children->length;++i){
		object_t * c=raw->children->buffer[i];
		ret_children=array_concat(ret_children,object_get_children(c,recursive));
	}
	return ret_children;
}

ray_t * raycast_get_ray(f32 input_x,f32 input_y,camera_object_t * camera){
	vec4_t start=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t end=vec4_create(0.0,0.0,0.0,1.0);
	start.x=(input_x/(float)sys_w())*2.0-1.0;
	start.y=-((input_y/(float)sys_h())*2.0-1.0);
	start.z=-1.0;
	end.x=start.x;
	end.y=start.y;
	end.z=1.0;
	_raycast_p_inv=mat4_inv(camera->p);
	_raycast_v_inv=mat4_inv(camera->v);
	_raycast_vp_inv=mat4_mult_mat(_raycast_p_inv,_raycast_v_inv);
	start=vec4_apply_proj(start,_raycast_vp_inv);
	end=vec4_apply_proj(end,_raycast_vp_inv);
	end=vec4_sub(end,start);
	end=vec4_norm(end);
	end.x*=camera->data->far_plane;
	end.y*=camera->data->far_plane;
	end.z*=camera->data->far_plane;
	return ray_create(start,end);
}

vec4_t raycast_box_intersect(transform_t * transform,f32 input_x,f32 input_y,camera_object_t * camera){
	ray_t * ray=raycast_get_ray(input_x,input_y,camera);
	transform_t * t=transform;
	vec4_t c=vec4_create(transform_world_x(t),transform_world_y(t),transform_world_z(t),1.0);
	vec4_t s=vec4_create(t->dim.x,t->dim.y,t->dim.z,1.0);
	return ray_intersect_box(ray,c,s);
}

transform_t * raycast_closest_box_intersect(transform_t_array_t * transforms,f32 input_x,f32 input_y,camera_object_t * camera){
	transform_t_array_t * intersects=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<transforms->length;++i){
		transform_t * t=transforms->buffer[i];
		vec4_t intersect=raycast_box_intersect(t,input_x,input_y,camera);
		if(!vec4_isnan(intersect)){
			any_array_push(intersects,t);
		}
	}
	if(intersects->length==0){
		return null;
	}
	transform_t * closest=null;
	f32 inf=100000;
	f32 min_dist=inf;
	for(i32 i=0;i<intersects->length;++i){
		transform_t * t=intersects->buffer[i];
		f32 dist=vec4_dist(t->loc,camera->base->transform->loc);
		if(dist<min_dist){
			min_dist=dist;
			closest=t;
		}
	}
	return closest;
}

plane_t * plane_create(){
	plane_t * raw=GC_ALLOC_INIT(plane_t, {0});
	raw->normal=vec4_create(1.0,0.0,0.0,1.0);
	raw->constant=0.0;
	return raw;
}

vec4_t raycast_plane_intersect(vec4_t normal,vec4_t a,f32 input_x,f32 input_y,camera_object_t * camera){
	ray_t * ray=raycast_get_ray(input_x,input_y,camera);
	plane_t * plane=plane_create();
	plane_set(plane,normal,a);
	return ray_intersect_plane(ray,plane);
}

ray_t * ray_create(vec4_t origin,vec4_t dir){
	ray_t * raw=GC_ALLOC_INIT(ray_t, {0});
	raw->origin=origin;
	raw->dir=dir;
	return raw;
}

vec4_t ray_at(ray_t * raw,f32 t){
	return vec4_add(vec4_mult(raw->dir,t),raw->origin);
}

f32 ray_dist_to_point(ray_t * raw,vec4_t point){
	vec4_t v1=vec4_create(0.0,0.0,0.0,1.0);
	f32 dir_dist=vec4_dot(vec4_sub(point,raw->origin),raw->dir);
	if(dir_dist<0){
		return vec4_dist(raw->origin,point);
	}
	raw->dir=vec4_mult(raw->dir,dir_dist);
	raw->dir=vec4_add(raw->dir,raw->origin);
	return vec4_dist(v1,point);
}

bool ray_intersects_sphere(ray_t * raw,vec4_t sphere_center,f32 sphere_radius){
	return ray_dist_to_point(raw,sphere_center)<=sphere_radius;
}

bool ray_intersects_plane(ray_t * raw,plane_t * plane){
	f32 dist_to_point=plane_dist_to_point(plane,raw->origin);
	if(dist_to_point==0){
		return true;
	}
	f32 denominator=vec4_dot(plane->normal,raw->dir);
	if(denominator*dist_to_point<0){
		return true;
	}
	return false;
}

f32 ray_dist_to_plane(ray_t * raw,plane_t * plane){
	f32 denominator=vec4_dot(plane->normal,raw->dir);
	if(denominator==0){
		if(plane_dist_to_point(plane,raw->origin)==0){
			return 0;
		}
		return -1;
	}
	f32 t=-(vec4_dot(raw->origin,plane->normal)+plane->constant)/(float)denominator;
	return t>=0?t:-1;
}

vec4_t ray_intersect_plane(ray_t * raw,plane_t * plane){
	f32 t=ray_dist_to_plane(raw,plane);
	if(t==-1){
		return vec4_nan();
	}
	return ray_at(raw,t);
}

vec4_t ray_intersect_box(ray_t * raw,vec4_t center,vec4_t dim){
	f32 tmin;
	f32 tmax;
	f32 tymin;
	f32 tymax;
	f32 tzmin;
	f32 tzmax;
	f32 half_x=dim.x/(float)2;
	f32 half_y=dim.y/(float)2;
	f32 half_z=dim.z/(float)2;
	f32 box_min_x=center.x-half_x;
	f32 box_min_y=center.y-half_y;
	f32 box_min_z=center.z-half_z;
	f32 box_max_x=center.x+half_x;
	f32 box_max_y=center.y+half_y;
	f32 box_max_z=center.z+half_z;
	f32 invdirx=1/(float)raw->dir.x;
	f32 invdiry=1/(float)raw->dir.y;
	f32 invdirz=1/(float)raw->dir.z;
	vec4_t origin=raw->origin;
	if(invdirx>=0){
		tmin=(box_min_x-origin.x)*invdirx;
		tmax=(box_max_x-origin.x)*invdirx;
	}
	else {
		tmin=(box_max_x-origin.x)*invdirx;
		tmax=(box_min_x-origin.x)*invdirx;
	}
	if(invdiry>=0){
		tymin=(box_min_y-origin.y)*invdiry;
		tymax=(box_max_y-origin.y)*invdiry;
	}
	else {
		tymin=(box_max_y-origin.y)*invdiry;
		tymax=(box_min_y-origin.y)*invdiry;
	}
	if((tmin>tymax)||(tymin>tmax)){
		return vec4_nan();
	}
	if(tymin>tmin||tmin!=tmin){
		tmin=tymin;
	}
	if(tymax<tmax||tmax!=tmax){
		tmax=tymax;
	}
	if(invdirz>=0){
		tzmin=(box_min_z-origin.z)*invdirz;
		tzmax=(box_max_z-origin.z)*invdirz;
	}
	else {
		tzmin=(box_max_z-origin.z)*invdirz;
		tzmax=(box_min_z-origin.z)*invdirz;
	}
	if((tmin>tzmax)||(tzmin>tmax)){
		return vec4_nan();
	}
	if(tzmin>tmin||tmin!=tmin){
		tmin=tzmin;
	}
	if(tzmax<tmax||tmax!=tmax){
		tmax=tzmax;
	}
	if(tmax<0){
		return vec4_nan();
	}
	return ray_at(raw,tmin>=0?tmin:tmax);
}

vec4_t ray_intersect_triangle(ray_t * raw,vec4_t a,vec4_t b,vec4_t c,bool cull_backface){
	vec4_t diff=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t edge1=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t edge2=vec4_create(0.0,0.0,0.0,1.0);
	vec4_t normal=vec4_create(0.0,0.0,0.0,1.0);
	edge1=vec4_sub(b,a);
	edge2=vec4_sub(c,a);
	normal=vec4_cross(edge1,edge2);
	f32 ddn=vec4_dot(raw->dir,normal);
	i32 sign;
	if(ddn>0){
		if(cull_backface){
			return vec4_nan();
		}
		sign=1;
	}
	else if(ddn<0){
		sign=-1;
		ddn=-ddn;
	}
	else {
		return vec4_nan();
	}
	diff=vec4_sub(raw->origin,a);
	f32 ddqxe2=sign*vec4_dot(raw->dir,vec4_cross(diff,edge2));
	if(ddqxe2<0){
		return vec4_nan();
	}
	f32 dde1xq=sign*vec4_dot(raw->dir,vec4_cross(edge1,diff));
	if(dde1xq<0){
		return vec4_nan();
	}
	if(ddqxe2+dde1xq>ddn){
		return vec4_nan();
	}
	f32 qdn=-sign*vec4_dot(diff,normal);
	if(qdn<0){
		return vec4_nan();
	}
	return ray_at(raw,qdn/(float)ddn);
}

f32 plane_dist_to_point(plane_t * raw,vec4_t point){
	return vec4_dot(raw->normal,point)+raw->constant;
}

plane_t * plane_set(plane_t * raw,vec4_t normal,vec4_t point){
	raw->normal=vec4_clone(normal);
	raw->constant=-vec4_dot(point,raw->normal);
	return raw;
}

bool render_path_ready(){
	return _render_path_loading==0;
}

void render_path_render_frame(){
	if(!render_path_ready()||_render_path_paused||sys_w()==0||sys_h()==0){
		return ;
	}
	if(_render_path_last_w>0&&(_render_path_last_w!=sys_w()||_render_path_last_h!=sys_h())){
		render_path_resize();
	}
	_render_path_last_w=sys_w();
	_render_path_last_h=sys_h();
	_render_path_frame_time=sys_time()-_render_path_last_frame_time;
	_render_path_last_frame_time=sys_time();
	render_path_current_w=sys_w();
	render_path_current_h=sys_h();
	_render_path_meshes_sorted=false;
	render_path_commands();
	_render_path_frame++;
}

void render_path_set_target(string_t * target,string_t_array_t * additional,string_t * depth_buffer,i32 flags,i32 color,f32 depth){
	if(_render_path_current_image!=null){
		render_path_end();
	}
	if(string_equals(target,"")){
		gc_unroot(_render_path_current_target);_render_path_current_target=null;
		render_path_current_w=sys_w();
		render_path_current_h=sys_h();
		_gpu_begin(null,null,null,flags,color,depth);
		gpu_viewport(sys_x(),render_path_current_h-(sys_h()-sys_y()),sys_w(),sys_h());
	}
	else {
		render_target_t * rt=any_map_get(render_path_render_targets,target);
		gc_unroot(_render_path_current_target);_render_path_current_target=rt;gc_root(_render_path_current_target);
		gpu_texture_t_array_t * additional_images=null;
		if(additional!=null){
			additional_images=any_array_create_from_raw((any[]){},0);
			for(i32 i=0;i<additional->length;++i){
				string_t * s=additional->buffer[i];
				render_target_t * t=any_map_get(render_path_render_targets,s);
				any_array_push(additional_images,t->_image);
			}
		}
		render_path_current_w=rt->_image->width;
		render_path_current_h=rt->_image->height;
		render_target_t * db=any_map_get(render_path_render_targets,depth_buffer);
		gc_unroot(_render_path_current_image);_render_path_current_image=rt->_image;gc_root(_render_path_current_image);
		_gpu_begin(rt->_image,additional_images,db!=null?db->_image:null,flags,color,depth);
	}
	gc_unroot(_render_path_bind_params);_render_path_bind_params=null;
}

void render_path_end(){
	gpu_end();
	gc_unroot(_render_path_current_image);_render_path_current_image=null;
	gc_unroot(_render_path_bind_params);_render_path_bind_params=null;
}

i32 _render_path_sort_dist(any_ptr a,any_ptr b){
	mesh_object_t * ma=DEREFERENCE(a);
	mesh_object_t * mb=DEREFERENCE(b);
	return ma->camera_dist>=mb->camera_dist?1:-1;
}

void render_path_sort_meshes_dist(mesh_object_t_array_t * meshes){
	array_sort(meshes,_render_path_sort_dist);
}

i32 _render_path_sort_shader(any_ptr a,any_ptr b){
	mesh_object_t * ma=DEREFERENCE(a);
	mesh_object_t * mb=DEREFERENCE(b);
	return strcmp(ma->materials->buffer[0]->name,mb->materials->buffer[0]->name);
}

void render_path_sort_meshes_shader(mesh_object_t_array_t * meshes){
	array_sort(meshes,_render_path_sort_shader);
}

void render_path_draw_meshes(string_t * context){
	render_path_submit_draw(context);
	render_path_end();
}

void render_path_submit_draw(string_t * context){
	camera_object_t * camera=scene_camera;
	mesh_object_t_array_t * meshes=scene_meshes;
	gc_unroot(_mesh_object_last_pipeline);_mesh_object_last_pipeline=null;
	if(!_render_path_meshes_sorted&&camera!=null){
		f32 cam_x=transform_world_x(camera->base->transform);
		f32 cam_y=transform_world_y(camera->base->transform);
		f32 cam_z=transform_world_z(camera->base->transform);
		for(i32 i=0;i<meshes->length;++i){
			mesh_object_t * mesh=meshes->buffer[i];
			mesh_object_compute_camera_dist(mesh,cam_x,cam_y,cam_z);
		}
		if(_render_path_draw_order==draw_order_t_SHADER){
			render_path_sort_meshes_shader(meshes);
		}
		else {
			render_path_sort_meshes_dist(meshes);
		}
		_render_path_meshes_sorted=true;
	}
	for(i32 i=0;i<meshes->length;++i){
		mesh_object_t * mesh=meshes->buffer[i];
		mesh_object_render(mesh,context,_render_path_bind_params);
	}
}

void render_path_draw_skydome(string_t * handle){
	if(const_data_skydome_vb==null){
		const_data_create_skydome_data();
	}
	cached_shader_context_t * cc=any_map_get(_render_path_cached_shader_contexts,handle);
	if(cc->context==null){
		return ;
	}
	gpu_set_pipeline(cc->context->_->pipe_state);
	uniforms_set_context_consts(cc->context,_render_path_bind_params);
	uniforms_set_obj_consts(cc->context,null);
	gpu_set_vertex_buffer(const_data_skydome_vb);
	gpu_set_index_buffer(const_data_skydome_ib);
	gpu_draw();
	render_path_end();
}

void render_path_bind_target(string_t * target,string_t * uniform){
	if(_render_path_bind_params!=null){
		any_array_push(_render_path_bind_params,target);
		any_array_push(_render_path_bind_params,uniform);
	}
	else {
		gc_unroot(_render_path_bind_params);_render_path_bind_params=any_array_create_from_raw((any[]){target,uniform,},2);gc_root(_render_path_bind_params);
	}
}

void render_path_draw_shader(string_t * handle){
	cached_shader_context_t * cc=any_map_get(_render_path_cached_shader_contexts,handle);
	if(const_data_screen_aligned_vb==null){
		const_data_create_screen_aligned_data();
	}
	gpu_set_pipeline(cc->context->_->pipe_state);
	uniforms_set_context_consts(cc->context,_render_path_bind_params);
	uniforms_set_obj_consts(cc->context,null);
	gpu_set_vertex_buffer(const_data_screen_aligned_vb);
	gpu_set_index_buffer(const_data_screen_aligned_ib);
	gpu_draw();
	render_path_end();
}

void render_path_load_shader(string_t * handle){
	_render_path_loading++;
	cached_shader_context_t * cc=any_map_get(_render_path_cached_shader_contexts,handle);
	if(cc!=null){
		_render_path_loading--;
		return ;
	}
	cc=GC_ALLOC_INIT(cached_shader_context_t, {0});
	any_map_set(_render_path_cached_shader_contexts,handle,cc);
	string_t_array_t * shader_path=string_split(handle,"/");
	shader_data_t * res=data_get_shader(shader_path->buffer[0],shader_path->buffer[1]);
	cc->context=shader_data_get_context(res,shader_path->buffer[2]);
	_render_path_loading--;
}

void render_path_unload_shader(string_t * handle){
	map_delete(_render_path_cached_shader_contexts,handle);
	string_t_array_t * shader_path=string_split(handle,"/");
	map_delete(data_cached_shaders,shader_path->buffer[1]);
}

void render_path_unload(){
	string_t_array_t * render_targets_keys=map_keys(render_path_render_targets);
	for(i32 i=0;i<render_targets_keys->length;++i){
		render_target_t * rt=any_map_get(render_path_render_targets,render_targets_keys->buffer[i]);
		render_target_unload(rt);
	}
}

void render_path_resize(){
	if(iron_window_width()==0||iron_window_height()==0){
		return ;
	}
	string_t_array_t * render_targets_keys=map_keys(render_path_render_targets);
	for(i32 i=0;i<render_targets_keys->length;++i){
		render_target_t * rt=any_map_get(render_path_render_targets,render_targets_keys->buffer[i]);
		if(rt!=null&&rt->width==0){
			gpu_texture_t * _image=rt->_image;
			iron_delete_texture(_image);
			rt->_image=render_path_create_image(rt);
		}
	}
}

render_target_t * render_path_create_render_target(render_target_t * t){
	t->_image=render_path_create_image(t);
	any_map_set(render_path_render_targets,t->name,t);
	return t;
}

gpu_texture_t * render_path_create_image(render_target_t * t){
	i32 width=t->width==0?sys_w():t->width;
	i32 height=t->height==0?sys_h():t->height;
	width=math_floor(width*t->scale);
	height=math_floor(height*t->scale);
	if(width<1){
		width=1;
	}
	if(height<1){
		height=1;
	}
	return gpu_create_render_target(width,height,t->format!=null?render_path_get_tex_format(t->format):tex_format_t_RGBA32);
}

tex_format_t render_path_get_tex_format(string_t * s){
	if(string_equals(s,"RGBA32")){
		return tex_format_t_RGBA32;
	}
	if(string_equals(s,"RGBA64")){
		return tex_format_t_RGBA64;
	}
	if(string_equals(s,"RGBA128")){
		return tex_format_t_RGBA128;
	}
	if(string_equals(s,"R32")){
		return tex_format_t_R32;
	}
	if(string_equals(s,"R16")){
		return tex_format_t_R16;
	}
	if(string_equals(s,"R8")){
		return tex_format_t_R8;
	}
	if(string_equals(s,"D32")){
		return tex_format_t_D32;
	}
	return tex_format_t_RGBA32;
}

render_target_t * render_target_create(){
	render_target_t * raw=GC_ALLOC_INIT(render_target_t, {0});
	raw->scale=1.0;
	return raw;
}

void render_target_unload(render_target_t * raw){
	if(raw->_image!=null){
		iron_delete_texture(raw->_image);
	}
}

object_t * scene_create(scene_t * format){
	_scene_uid=_scene_uid_counter++;
	gc_unroot(scene_meshes);scene_meshes=any_array_create_from_raw((any[]){},0);gc_root(scene_meshes);
	gc_unroot(scene_cameras);scene_cameras=any_array_create_from_raw((any[]){},0);gc_root(scene_cameras);
	gc_unroot(scene_empties);scene_empties=any_array_create_from_raw((any[]){},0);gc_root(scene_empties);
	gc_unroot(scene_embedded);scene_embedded=any_map_create();gc_root(scene_embedded);
	gc_unroot(_scene_root);_scene_root=object_create(true);gc_root(_scene_root);
	_scene_root->name="Root";
	_scene_ready=false;
	gc_unroot(_scene_raw);_scene_raw=format;gc_root(_scene_raw);
	gc_unroot(scene_world);scene_world=data_get_world(format->name,format->world_ref);gc_root(scene_world);
	object_t * scene_object=scene_add_scene(format->name,null);
	if(scene_cameras->length==0){
		iron_log(string_join(string_join("No camera found for scene '",format->name),"'"));
	}
	gc_unroot(scene_camera);scene_camera=scene_get_camera(format->camera_ref);gc_root(scene_camera);
	gc_unroot(_scene_scene_parent);_scene_scene_parent=scene_object;gc_root(_scene_scene_parent);
	_scene_ready=true;
	return scene_object;
}

void scene_remove(){
	for(i32 i=0;i<scene_meshes->length;++i){
		mesh_object_t * o=scene_meshes->buffer[i];
		mesh_object_remove(o);
	}
	for(i32 i=0;i<scene_cameras->length;++i){
		camera_object_t * o=scene_cameras->buffer[i];
		camera_object_remove(o);
	}
	for(i32 i=0;i<scene_empties->length;++i){
		object_t * o=scene_empties->buffer[i];
		object_remove(o);
	}
	object_remove(_scene_root);
}

object_t * scene_set_active(string_t * scene_name){
	if(_scene_root!=null){
		scene_remove();
	}
	scene_t * format=data_get_scene_raw(scene_name);
	object_t * o=scene_create(format);
	return o;
}

void scene_update_frame(){
	if(!_scene_ready){
		return ;
	}
	for(i32 i=0;i<scene_empties->length;++i){
		object_t * e=scene_empties->buffer[i];
		if(e!=null&&e->parent!=null){
			transform_update(e->transform);
		}
	}
}

void scene_render_frame(){
	if(!_scene_ready||render_path_commands==null){
		return ;
	}
	scene_camera!=null?camera_object_render_frame(scene_camera):render_path_render_frame();
}

object_t * scene_add_object(object_t * parent){
	object_t * object=object_create(true);
	parent!=null?object_set_parent(object,parent,false,false):object_set_parent(object,_scene_root,false,false);
	return object;
}

object_t * scene_get_child(string_t * name){
	return object_get_child(_scene_root,name);
}

mesh_object_t * scene_get_mesh(string_t * name){
	for(i32 i=0;i<scene_meshes->length;++i){
		mesh_object_t * m=scene_meshes->buffer[i];
		if(string_equals(m->base->name,name)){
			return m;
		}
	}
	return null;
}

camera_object_t * scene_get_camera(string_t * name){
	for(i32 i=0;i<scene_cameras->length;++i){
		camera_object_t * c=scene_cameras->buffer[i];
		if(string_equals(c->base->name,name)){
			return c;
		}
	}
	return null;
}

object_t * scene_get_empty(string_t * name){
	for(i32 i=0;i<scene_empties->length;++i){
		object_t * e=scene_empties->buffer[i];
		if(string_equals(e->name,name)){
			return e;
		}
	}
	return null;
}

mesh_object_t * scene_add_mesh_object(mesh_data_t * data,material_data_t_array_t * materials,object_t * parent){
	mesh_object_t * object=mesh_object_create(data,materials);
	parent!=null?object_set_parent(object->base,parent,false,false):object_set_parent(object->base,_scene_root,false,false);
	return object;
}

camera_object_t * scene_add_camera_object(camera_data_t * data,object_t * parent){
	camera_object_t * object=camera_object_create(data);
	parent!=null?object_set_parent(object->base,parent,false,false):object_set_parent(object->base,_scene_root,false,false);
	return object;
}

void scene_traverse_objects(scene_t * format,object_t * parent,obj_t_array_t * objects,obj_t * parent_object){
	if(objects==null){
		return ;
	}
	for(i32 i=0;i<objects->length;++i){
		obj_t * o=objects->buffer[i];
		if(o->spawn==false){
			continue;
		}
		object_t * object=scene_create_object(o,format,parent,parent_object);
		scene_traverse_objects(format,object,o->children,o);
	}
}

object_t * scene_add_scene(string_t * scene_name,object_t * parent){
	if(parent==null){
		parent=scene_add_object(null);
		parent->name=string_copy(scene_name);
	}
	scene_t * format=data_get_scene_raw(scene_name);
	scene_load_embedded_data(format->embedded_datas);
	_scene_objects_traversed=0;
	_scene_objects_count=scene_get_objects_count(format->objects);
	if(format->objects!=null&&format->objects->length>0){
		scene_traverse_objects(format,parent,format->objects,null);
	}
	return parent;
}

i32 scene_get_objects_count(obj_t_array_t * objects){
	if(objects==null){
		return 0;
	}
	i32 result=objects->length;
	for(i32 i=0;i<objects->length;++i){
		obj_t * o=objects->buffer[i];
		if(o->spawn==false){
			continue;
		}
		if(o->children!=null){
			result+=scene_get_objects_count(o->children);
		}
	}
	return result;
}

object_t * _scene_spawn_object_tree(obj_t * obj,object_t * parent,obj_t * parent_object,bool spawn_children){
	object_t * object=scene_create_object(obj,_scene_raw,parent,parent_object);
	if(spawn_children&&obj->children!=null){
		for(i32 i=0;i<obj->children->length;++i){
			obj_t * child=obj->children->buffer[i];
			_scene_spawn_object_tree(child,object,obj,spawn_children);
		}
	}
	return object;
}

object_t * scene_spawn_object(string_t * name,object_t * parent,bool spawn_children){
	obj_t * obj=scene_get_raw_object_by_name(_scene_raw,name);
	return _scene_spawn_object_tree(obj,parent,null,spawn_children);
}

obj_t * scene_get_raw_object_by_name(scene_t * format,string_t * name){
	return scene_traverse_objs(format->objects,name);
}

obj_t * scene_traverse_objs(obj_t_array_t * children,string_t * name){
	for(i32 i=0;i<children->length;++i){
		obj_t * o=children->buffer[i];
		if(string_equals(o->name,name)){
			return o;
		}
		if(o->children!=null){
			obj_t * res=scene_traverse_objs(o->children,name);
			if(res!=null){
				return res;
			}
		}
	}
	return null;
}

object_t * scene_create_object(obj_t * o,scene_t * format,object_t * parent,obj_t * parent_object){
	string_t * scene_name=format->name;
	if(string_equals(o->type,"camera_object")){
		camera_data_t * b=data_get_camera(scene_name,o->data_ref);
		camera_object_t * object=scene_add_camera_object(b,parent);
		return scene_return_object(object->base,o);
	}
	else if(string_equals(o->type,"mesh_object")){
		if(o->material_refs==null||o->material_refs->length==0){
			return scene_create_mesh_object(o,format,parent,parent_object,null);
		}
		else {
			material_data_t_array_t * materials=any_array_create_from_raw((any[]){},0);
			for(i32 i=0;i<o->material_refs->length;++i){
				string_t * ref=o->material_refs->buffer[i];
				material_data_t * mat=data_get_material(scene_name,ref);
				any_array_push(materials,mat);
			}
			return scene_create_mesh_object(o,format,parent,parent_object,materials);
		}
	}
	else if(string_equals(o->type,"object")){
		object_t * object=scene_add_object(parent);
		return scene_return_object(object,o);
	}
	else {
		return null;
	}
}

object_t * scene_create_mesh_object(obj_t * o,scene_t * format,object_t * parent,obj_t * parent_object,material_data_t_array_t * materials){
	string_t_array_t * ref=string_split(o->data_ref,"/");
	string_t * object_file="";
	string_t * data_ref="";
	string_t * scene_name=format->name;
	if(ref->length==2){
		object_file=string_copy(ref->buffer[0]);
		data_ref=string_copy(ref->buffer[1]);
	}
	else {
		object_file=string_copy(scene_name);
		data_ref=string_copy(o->data_ref);
	}
	return scene_return_mesh_object(object_file,data_ref,scene_name,null,materials,parent,parent_object,o);
}

object_t * scene_return_mesh_object(string_t * object_file,string_t * data_ref,string_t * scene_name,any armature,material_data_t_array_t * materials,object_t * parent,obj_t * parent_object,obj_t * o){
	mesh_data_t * mesh=data_get_mesh(object_file,data_ref);
	mesh_object_t * object=scene_add_mesh_object(mesh,materials,parent);
	return scene_return_object(object->base,o);
}

object_t * scene_return_object(object_t * object,obj_t * o){
	return scene_return_object_loaded(object,o,null);
}

object_t * scene_return_object_loaded(object_t * object,obj_t * o,scene_t_array_t * oactions){
	if(object!=null){
		object->raw=o;
		object->name=string_copy(o->name);
		object->visible=o->visible;
		scene_gen_transform(o,object->transform);
	}
	return object;
}

void scene_gen_transform(obj_t * object,transform_t * transform){
	transform->world=object->transform!=null?mat4_from_f32_array(object->transform,0):mat4_identity();
	mat4_decomposed_t * dec=mat4_decompose(transform->world);
	transform->loc=dec->loc;
	transform->rot=dec->rot;
	transform->scale=dec->scl;
	if(transform->object->parent!=null){
		transform_update(transform);
	}
}

void scene_load_embedded_data(string_t_array_t * datas){
	if(datas==null){
		return ;
	}
	for(i32 i=0;i<datas->length;++i){
		string_t * file=datas->buffer[i];
		scene_embed_data(file);
	}
}

void scene_embed_data(string_t * file){
	gpu_texture_t * image=data_get_image(file);
	any_map_set(scene_embedded,file,image);
}

shader_data_t * shader_data_create(shader_data_t * raw){
	raw->_=GC_ALLOC_INIT(shader_data_runtime_t, {0});
	raw->_->contexts=any_array_create_from_raw((any[]){},0);
	for(i32 i=0;i<raw->contexts->length;++i){
		shader_context_t * c=raw->contexts->buffer[i];
		shader_context_t * con=shader_context_create(c);
		any_array_push(raw->_->contexts,con);
	}
	return raw;
}

string_t * shader_data_ext(){
	return ".d3d11";
}

shader_data_t * shader_data_parse(string_t * file,string_t * name){
	scene_t * format=data_get_scene_raw(file);
	shader_data_t * raw=shader_data_get_raw_by_name(format->shader_datas,name);
	if(raw==null){
		iron_log(string_join(string_join("Shader data '",name),"' not found!"));
		return null;
	}
	return shader_data_create(raw);
}

shader_data_t * shader_data_get_raw_by_name(shader_data_t_array_t * datas,string_t * name){
	if(string_equals(name,"")){
		return datas->buffer[0];
	}
	for(i32 i=0;i<datas->length;++i){
		if(string_equals(datas->buffer[i]->name,name)){
			return datas->buffer[i];
		}
	}
	return null;
}

void shader_data_delete(shader_data_t * raw){
	for(i32 i=0;i<raw->_->contexts->length;++i){
		shader_context_t * c=raw->_->contexts->buffer[i];
		shader_context_delete(c);
	}
}

shader_context_t * shader_data_get_context(shader_data_t * raw,string_t * name){
	for(i32 i=0;i<raw->_->contexts->length;++i){
		shader_context_t * c=raw->_->contexts->buffer[i];
		if(string_equals(c->name,name)){
			return c;
		}
	}
	return null;
}

shader_context_t * shader_context_create(shader_context_t * raw){
	if(raw->_==null){
		raw->_=GC_ALLOC_INIT(shader_context_runtime_t, {0});
	}
	shader_context_parse_vertex_struct(raw);
	return shader_context_compile(raw);
}

shader_context_t * shader_context_compile(shader_context_t * raw){
	if(raw->_->pipe_state!=null){
		gpu_delete_pipeline(raw->_->pipe_state);
	}
	raw->_->pipe_state=gpu_create_pipeline();
	raw->_->constants=i32_array_create_from_raw((i32[]){},0);
	raw->_->tex_units=i32_array_create_from_raw((i32[]){},0);
	raw->_->pipe_state->input_layout=raw->_->structure;
	raw->_->pipe_state->depth_write=raw->depth_write;
	raw->_->pipe_state->depth_mode=shader_context_get_compare_mode(raw->compare_mode);
	raw->_->pipe_state->cull_mode=shader_context_get_cull_mode(raw->cull_mode);
	if(raw->blend_source!=null){
		raw->_->pipe_state->blend_source=shader_context_get_blend_fac(raw->blend_source);
	}
	if(raw->blend_destination!=null){
		raw->_->pipe_state->blend_destination=shader_context_get_blend_fac(raw->blend_destination);
	}
	if(raw->alpha_blend_source!=null){
		raw->_->pipe_state->alpha_blend_source=shader_context_get_blend_fac(raw->alpha_blend_source);
	}
	if(raw->alpha_blend_destination!=null){
		raw->_->pipe_state->alpha_blend_destination=shader_context_get_blend_fac(raw->alpha_blend_destination);
	}
	if(raw->color_writes_red!=null){
		for(i32 i=0;i<raw->color_writes_red->length;++i){
			ARRAY_ACCESS(raw->_->pipe_state->color_write_mask_red,i)=raw->color_writes_red->buffer[i];
		}
	}
	if(raw->color_writes_green!=null){
		for(i32 i=0;i<raw->color_writes_green->length;++i){
			ARRAY_ACCESS(raw->_->pipe_state->color_write_mask_green,i)=raw->color_writes_green->buffer[i];
		}
	}
	if(raw->color_writes_blue!=null){
		for(i32 i=0;i<raw->color_writes_blue->length;++i){
			ARRAY_ACCESS(raw->_->pipe_state->color_write_mask_blue,i)=raw->color_writes_blue->buffer[i];
		}
	}
	if(raw->color_writes_alpha!=null){
		for(i32 i=0;i<raw->color_writes_alpha->length;++i){
			ARRAY_ACCESS(raw->_->pipe_state->color_write_mask_alpha,i)=raw->color_writes_alpha->buffer[i];
		}
	}
	if(raw->color_attachments!=null){
		raw->_->pipe_state->color_attachment_count=raw->color_attachments->length;
		for(i32 i=0;i<raw->color_attachments->length;++i){
			ARRAY_ACCESS(raw->_->pipe_state->color_attachment,i)=shader_context_get_tex_format(raw->color_attachments->buffer[i]);
		}
	}
	if(raw->depth_attachment!=null){
		raw->_->pipe_state->depth_attachment_bits=string_equals(raw->depth_attachment,"NONE")?0:32;
	}
	if(raw->shader_from_source){
		raw->_->pipe_state->vertex_shader=gpu_create_shader_from_source(raw->vertex_shader,raw->_->vertex_shader_size,shader_type_t_VERTEX);
		raw->_->pipe_state->fragment_shader=gpu_create_shader_from_source(raw->fragment_shader,raw->_->fragment_shader_size,shader_type_t_FRAGMENT);
		if(raw->_->pipe_state->vertex_shader==null||raw->_->pipe_state->fragment_shader==null){
			return null;
		}
	}
	else {
		buffer_t * vs_buffer=data_get_blob(string_join(raw->vertex_shader,shader_data_ext()));
		raw->_->pipe_state->vertex_shader=gpu_create_shader(vs_buffer,shader_type_t_VERTEX);
		buffer_t * fs_buffer=data_get_blob(string_join(raw->fragment_shader,shader_data_ext()));
		raw->_->pipe_state->fragment_shader=gpu_create_shader(fs_buffer,shader_type_t_FRAGMENT);
	}
	return shader_context_finish_compile(raw);
}

i32 shader_context_type_size(string_t * t){
	if(string_equals(t,"int"))return 4;
	if(string_equals(t,"float"))return 4;
	if(string_equals(t,"vec2"))return 8;
	if(string_equals(t,"vec3"))return 12;
	if(string_equals(t,"vec4"))return 16;
	if(string_equals(t,"mat3"))return 48;
	if(string_equals(t,"mat4"))return 64;
	if(string_equals(t,"float2"))return 8;
	if(string_equals(t,"float3"))return 12;
	if(string_equals(t,"float4"))return 16;
	if(string_equals(t,"float3x3"))return 48;
	if(string_equals(t,"float4x4"))return 64;
	return 0;
}

i32 shader_context_type_pad(i32 offset,i32 size){
	i32 r=offset%16;
	if(r==0){
		return 0;
	}
	if(size>=16||r+size>16){
		return 16-r;
	}
	return 0;
}

shader_context_t * shader_context_finish_compile(shader_context_t * raw){
	gpu_pipeline_compile(raw->_->pipe_state);
	if(raw->constants!=null){
		i32 offset=0;
		for(i32 i=0;i<raw->constants->length;++i){
			shader_const_t * c=raw->constants->buffer[i];
			i32 size=shader_context_type_size(c->type);
			offset+=shader_context_type_pad(offset,size);
			shader_context_add_const(raw,c,offset);
			offset+=size;
		}
	}
	if(raw->texture_units!=null){
		for(i32 i=0;i<raw->texture_units->length;++i){
			tex_unit_t * tu=raw->texture_units->buffer[i];
			shader_context_add_tex(raw,tu,i);
		}
	}
	return raw;
}

vertex_data_t shader_context_parse_data(string_t * data){
	if(string_equals(data,"float1")){
		return vertex_data_t_F32_1X;
	}
	else if(string_equals(data,"float2")){
		return vertex_data_t_F32_2X;
	}
	else if(string_equals(data,"float3")){
		return vertex_data_t_F32_3X;
	}
	else if(string_equals(data,"float4")){
		return vertex_data_t_F32_4X;
	}
	else if(string_equals(data,"short2norm")){
		return vertex_data_t_I16_2X_NORM;
	}
	else if(string_equals(data,"short4norm")){
		return vertex_data_t_I16_4X_NORM;
	}
	return vertex_data_t_F32_1X;
}

void shader_context_parse_vertex_struct(shader_context_t * raw){
	raw->_->structure=gpu_vertex_struct_create();
	for(i32 i=0;i<raw->vertex_elements->length;++i){
		vertex_element_t * elem=raw->vertex_elements->buffer[i];
		gpu_vertex_struct_add(raw->_->structure,elem->name,shader_context_parse_data(elem->data));
	}
}

void shader_context_delete(shader_context_t * raw){
	if(raw->_->pipe_state->fragment_shader!=null){
		gpu_shader_destroy(raw->_->pipe_state->fragment_shader);
	}
	if(raw->_->pipe_state->vertex_shader!=null){
		gpu_shader_destroy(raw->_->pipe_state->vertex_shader);
	}
	gpu_delete_pipeline(raw->_->pipe_state);
}

compare_mode_t shader_context_get_compare_mode(string_t * s){
	if(string_equals(s,"always")){
		return compare_mode_t_ALWAYS;
	}
	if(string_equals(s,"never")){
		return compare_mode_t_NEVER;
	}
	if(string_equals(s,"equal")){
		return compare_mode_t_EQUAL;
	}
	return compare_mode_t_LESS;
}

cull_mode_t shader_context_get_cull_mode(string_t * s){
	if(string_equals(s,"none")){
		return cull_mode_t_NONE;
	}
	if(string_equals(s,"clockwise")){
		return cull_mode_t_CLOCKWISE;
	}
	return cull_mode_t_COUNTER_CLOCKWISE;
}

blend_factor_t shader_context_get_blend_fac(string_t * s){
	if(string_equals(s,"blend_one")){
		return blend_factor_t_BLEND_ONE;
	}
	if(string_equals(s,"blend_zero")){
		return blend_factor_t_BLEND_ZERO;
	}
	if(string_equals(s,"source_alpha")){
		return blend_factor_t_SOURCE_ALPHA;
	}
	if(string_equals(s,"destination_alpha")){
		return blend_factor_t_DEST_ALPHA;
	}
	if(string_equals(s,"inverse_source_alpha")){
		return blend_factor_t_INV_SOURCE_ALPHA;
	}
	if(string_equals(s,"inverse_destination_alpha")){
		return blend_factor_t_INV_DEST_ALPHA;
	}
	return blend_factor_t_BLEND_ONE;
}

tex_format_t shader_context_get_tex_format(string_t * s){
	if(string_equals(s,"RGBA32")){
		return tex_format_t_RGBA32;
	}
	if(string_equals(s,"RGBA64")){
		return tex_format_t_RGBA64;
	}
	if(string_equals(s,"RGBA128")){
		return tex_format_t_RGBA128;
	}
	if(string_equals(s,"R32")){
		return tex_format_t_R32;
	}
	if(string_equals(s,"R16")){
		return tex_format_t_R16;
	}
	if(string_equals(s,"R8")){
		return tex_format_t_R8;
	}
	return tex_format_t_RGBA32;
}

void shader_context_add_const(shader_context_t * raw,shader_const_t * c,i32 offset){
	i32_array_push(raw->_->constants,offset);
}

void shader_context_add_tex(shader_context_t * raw,tex_unit_t * tu,i32 i){
	i32_array_push(raw->_->tex_units,i);
}

void sys_start(iron_window_options_t * ops){
	_iron_init(ops);
	_sys_start_time=iron_time();
	draw_init(iron_load_blob(string_join(string_join(data_path(),"draw_image.vert"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_image.frag"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_image_transform.vert"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_image_transform.frag"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_rect.vert"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_rect.frag"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_tris.vert"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_tris.frag"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_text.vert"),sys_shader_ext())),iron_load_blob(string_join(string_join(data_path(),"draw_text.frag"),sys_shader_ext())));
	_iron_set_update_callback(sys_render_callback);
	_iron_set_drop_files_callback(sys_drop_files_callback);
	iron_set_application_state_callback(sys_foreground_callback,sys_resume_callback,sys_pause_callback,sys_background_callback,sys_shutdown_callback);
	iron_set_keyboard_down_callback(sys_keyboard_down_callback);
	iron_set_keyboard_up_callback(sys_keyboard_up_callback);
	iron_set_keyboard_press_callback(sys_keyboard_press_callback);
	iron_set_mouse_down_callback(sys_mouse_down_callback);
	iron_set_mouse_up_callback(sys_mouse_up_callback);
	iron_set_mouse_move_callback(sys_mouse_move_callback);
	iron_set_mouse_wheel_callback(sys_mouse_wheel_callback);
	iron_set_touch_down_callback(sys_touch_down_callback);
	iron_set_touch_up_callback(sys_touch_up_callback);
	iron_set_touch_move_callback(sys_touch_move_callback);
	iron_set_pen_down_callback(sys_pen_down_callback);
	iron_set_pen_up_callback(sys_pen_up_callback);
	iron_set_pen_move_callback(sys_pen_move_callback);
	iron_set_gamepad_axis_callback(sys_gamepad_axis_callback);
	iron_set_gamepad_button_callback(sys_gamepad_button_callback);
	input_register();
}

sys_callback_t * _sys_callback_create(void(*f)(void)){
	sys_callback_t * cb=GC_ALLOC_INIT(sys_callback_t, {0});
	cb->f=f;
	return cb;
}

void sys_notify_on_frames(void(*listener)(void)){
	any_array_push(_sys_render_listeners,_sys_callback_create(listener));
}

void sys_notify_on_app_state(void(*on_foreground)(void),void(*on_resume)(void),void(*on_pause)(void),void(*on_background)(void),void(*on_shutdown)(void)){
	if(on_foreground!=null){
		any_array_push(_sys_foreground_listeners,_sys_callback_create(on_foreground));
	}
	if(on_resume!=null){
		any_array_push(_sys_resume_listeners,_sys_callback_create(on_resume));
	}
	if(on_pause!=null){
		any_array_push(_sys_pause_listeners,_sys_callback_create(on_pause));
	}
	if(on_background!=null){
		any_array_push(_sys_background_listeners,_sys_callback_create(on_background));
	}
	if(on_shutdown!=null){
		any_array_push(_sys_shutdown_listeners,_sys_callback_create(on_shutdown));
	}
}

void sys_notify_on_drop_files(void(*drop_files_listener)(string_t *)){
	sys_string_callback_t * cb=GC_ALLOC_INIT(sys_string_callback_t, {0});
	cb->f=drop_files_listener;
	any_array_push(_sys_drop_files_listeners,cb);
}

void sys_foreground(){
	for(i32 i=0;i<_sys_foreground_listeners->length;++i){
		_sys_foreground_listeners->buffer[i]->f();
	}
}

void sys_resume(){
	for(i32 i=0;i<_sys_resume_listeners->length;++i){
		_sys_resume_listeners->buffer[i]->f();
	}
}

void sys_pause(){
	for(i32 i=0;i<_sys_pause_listeners->length;++i){
		_sys_pause_listeners->buffer[i]->f();
	}
}

void sys_background(){
	for(i32 i=0;i<_sys_background_listeners->length;++i){
		_sys_background_listeners->buffer[i]->f();
	}
}

void sys_shutdown(){
	for(i32 i=0;i<_sys_shutdown_listeners->length;++i){
		_sys_shutdown_listeners->buffer[i]->f();
	}
}

void sys_drop_files(string_t * file_path){
	for(i32 i=0;i<_sys_drop_files_listeners->length;++i){
		_sys_drop_files_listeners->buffer[i]->f(file_path);
	}
}

f32 sys_time(){
	return iron_time()-_sys_start_time;
}

void sys_render_callback(){
	for(i32 i=0;i<_sys_render_listeners->length;++i){
		_sys_render_listeners->buffer[i]->f();
	}
}

void sys_drop_files_callback(string_t * file_path){
	sys_drop_files(file_path);
}

void sys_foreground_callback(){
	sys_foreground();
}

void sys_resume_callback(){
	sys_resume();
}

void sys_pause_callback(){
	sys_pause();
}

void sys_background_callback(){
	sys_background();
}

void sys_shutdown_callback(){
	sys_shutdown();
}

void sys_keyboard_down_callback(i32 code){
	keyboard_down_listener(code);
}

void sys_keyboard_up_callback(i32 code){
	keyboard_up_listener(code);
}

void sys_keyboard_press_callback(i32 char_code){
	keyboard_press_listener(string_from_char_code(char_code));
}

void sys_mouse_down_callback(i32 button,i32 x,i32 y){
	mouse_down_listener(button,x,y);
}

void sys_mouse_up_callback(i32 button,i32 x,i32 y){
	mouse_up_listener(button,x,y);
}

void sys_mouse_move_callback(i32 x,i32 y,i32 mx,i32 my){
	mouse_move_listener(x,y,mx,my);
}

void sys_mouse_wheel_callback(i32 delta){
	mouse_wheel_listener(delta);
}

void sys_touch_down_callback(i32 index,i32 x,i32 y){
}

void sys_touch_up_callback(i32 index,i32 x,i32 y){
}

void sys_touch_move_callback(i32 index,i32 x,i32 y){
}

void sys_pen_down_callback(i32 x,i32 y,f32 pressure){
	pen_down_listener(x,y,pressure);
}

void sys_pen_up_callback(i32 x,i32 y,f32 pressure){
	pen_up_listener(x,y,pressure);
}

void sys_pen_move_callback(i32 x,i32 y,f32 pressure){
	pen_move_listener(x,y,pressure);
}

void sys_gamepad_axis_callback(i32 gamepad,i32 axis,f32 value){
	gamepad_axis_listener(gamepad,axis,value);
}

void sys_gamepad_button_callback(i32 gamepad,i32 button,f32 value){
	gamepad_button_listener(gamepad,button,value);
}

string_t * sys_title(){
	return _sys_window_title;
}

void sys_title_set(string_t * value){
	iron_set_window_title(value);
	gc_unroot(_sys_window_title);_sys_window_title=string_copy(value);gc_root(_sys_window_title);
}

i32 sys_display_primary_id(){
	for(i32 i=0;i<iron_count_displays();++i){
		if(iron_display_is_primary(i)){
			return i;
		}
	}
	return 0;
}

i32 sys_display_width(){
	return iron_display_width(sys_display_primary_id());
}

i32 sys_display_height(){
	return iron_display_height(sys_display_primary_id());
}

i32 sys_display_frequency(){
	return iron_display_frequency(sys_display_primary_id());
}

string_t * sys_buffer_to_string(buffer_t * b){
	string_t * str=string_alloc(b->length+1);
	memcpy(str,b->buffer,b->length);
	return str;
}

buffer_t * sys_string_to_buffer(string_t * str){
	u8_array_t * b=u8_array_create(string_length(str));
	memcpy(b->buffer,str,string_length(str));
	return b;
}

string_t * sys_shader_ext(){
	return ".d3d11";
}

gpu_shader_t * sys_get_shader(string_t * name){
	gpu_shader_t * shader=any_map_get(_sys_shaders,name);
	if(shader==null){
		shader=gpu_create_shader(iron_load_blob(string_join(string_join(data_path(),name),sys_shader_ext())),ends_with(name,".frag")?shader_type_t_FRAGMENT:shader_type_t_VERTEX);
		any_map_set(_sys_shaders,name,shader);
	}
	return shader;
}

void video_unload(video_t * self){
}

i32 sys_w(){
	if(sys_on_w!=null){
		return sys_on_w();
	}
	return iron_window_width();
}

i32 sys_h(){
	if(sys_on_h!=null){
		return sys_on_h();
	}
	return iron_window_height();
}

i32 sys_x(){
	if(sys_on_x!=null){
		return sys_on_x();
	}
	return 0;
}

i32 sys_y(){
	if(sys_on_y!=null){
		return sys_on_y();
	}
	return 0;
}

void sys_init(){
	sys_notify_on_frames(sys_render);
}

void sys_reset(){
	gc_unroot(_sys_on_next_frames);_sys_on_next_frames=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_next_frames);
	gc_unroot(_sys_on_end_frames);_sys_on_end_frames=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_end_frames);
	gc_unroot(_sys_on_inits);_sys_on_inits=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_inits);
	gc_unroot(_sys_on_updates);_sys_on_updates=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_updates);
	gc_unroot(_sys_on_renders);_sys_on_renders=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_renders);
	gc_unroot(_sys_on_renders_2d);_sys_on_renders_2d=any_array_create_from_raw((any[]){},0);gc_root(_sys_on_renders_2d);
	for(i32 i=0;i<_sys_on_resets->length;++i){
		callback_t * cb=_sys_on_resets->buffer[i];
		cb->f(cb->data);
	}
}

void _sys_run_callbacks(callback_t_array_t * cbs){
	for(i32 i=0;i<cbs->length;++i){
		callback_t * cb=cbs->buffer[i];
		cb->f(cb->data);
	}
}

void sys_update(){
	if(!_scene_ready){
		return ;
	}
	if(_sys_pause_updates){
		return ;
	}
	if(_sys_on_next_frames->length>0){
		_sys_run_callbacks(_sys_on_next_frames);
		array_splice(_sys_on_next_frames,0,_sys_on_next_frames->length);
	}
	scene_update_frame();
	i32 i=0;
	i32 l=_sys_on_updates->length;
	while(i<l){
		if(_sys_on_inits->length>0){
			_sys_run_callbacks(_sys_on_inits);
			array_splice(_sys_on_inits,0,_sys_on_inits->length);
		}
		callback_t * cb=_sys_on_updates->buffer[i];
		cb->f(cb->data);
		if(l<=_sys_on_updates->length){
			i++;
		}
		else {
			l=_sys_on_updates->length;
		}
	}
	_sys_run_callbacks(_sys_on_end_frames);
	if(_sys_lastw==-1){
		_sys_lastw=sys_w();
		_sys_lasth=sys_h();
	}
	if(_sys_lastw!=sys_w()||_sys_lasth!=sys_h()){
		if(sys_on_resize!=null){
			sys_on_resize();
		}
		else if(scene_camera!=null){
			camera_object_build_proj(scene_camera,-1.0);
		}
	}
	_sys_lastw=sys_w();
	_sys_lasth=sys_h();
}

f32 sys_delta(){
	if(_sys_time_frequency<0){
		_sys_time_frequency=sys_display_frequency();
	}
	return (1/(float)_sys_time_frequency);
}

f32 sys_real_delta(){
	return _sys_time_real_delta;
}

void sys_render(){
	sys_update();
	_sys_time_real_delta=sys_time()-_sys_time_last;
	_sys_time_last=sys_time();
	if(!_scene_ready){
		sys_render_2d();
		return ;
	}
	if(_sys_on_inits->length>0){
		_sys_run_callbacks(_sys_on_inits);
		array_splice(_sys_on_inits,0,_sys_on_inits->length);
	}
	scene_render_frame();
	_sys_run_callbacks(_sys_on_renders);
	sys_render_2d();
}

void sys_render_2d(){
	if(_sys_on_renders_2d->length>0){
		_sys_run_callbacks(_sys_on_renders_2d);
	}
}

callback_t * _callback_create(void(*f)(any),any data){
	callback_t * cb=GC_ALLOC_INIT(callback_t, {0});
	cb->f=f;
	cb->data=data;
	return cb;
}

void sys_notify_on_init(void(*f)(any),any data){
	any_array_push(_sys_on_inits,_callback_create(f,data));
}

void sys_notify_on_update(void(*f)(any),any data){
	any_array_push(_sys_on_updates,_callback_create(f,data));
}

void sys_notify_on_render(void(*f)(any),any data){
	any_array_push(_sys_on_renders,_callback_create(f,data));
}

void sys_notify_on_render_2d(void(*f)(any),any data){
	any_array_push(_sys_on_renders_2d,_callback_create(f,data));
}

void sys_notify_on_reset(void(*f)(any),any data){
	any_array_push(_sys_on_resets,_callback_create(f,data));
}

void sys_notify_on_next_frame(void(*f)(any),any data){
	any_array_push(_sys_on_next_frames,_callback_create(f,data));
}

void sys_notify_on_end_frame(void(*f)(any),any data){
	any_array_push(_sys_on_end_frames,_callback_create(f,data));
}

void _sys_remove_callback(callback_t_array_t * ar,void(*f)(any)){
	for(i32 i=0;i<ar->length;++i){
		if(ar->buffer[i]->f==f){
			array_splice(ar,i,1);
			break;
		}
	}
}

void sys_remove_init(void(*f)(any)){
	_sys_remove_callback(_sys_on_inits,f);
}

void sys_remove_update(void(*f)(any)){
	_sys_remove_callback(_sys_on_updates,f);
}

void sys_remove_render(void(*f)(any)){
	_sys_remove_callback(_sys_on_renders,f);
}

void sys_remove_render_2d(void(*f)(any)){
	_sys_remove_callback(_sys_on_renders_2d,f);
}

void sys_remove_reset(void(*f)(any)){
	_sys_remove_callback(_sys_on_resets,f);
}

void sys_remove_end_frame(void(*f)(any)){
	_sys_remove_callback(_sys_on_end_frames,f);
}

tilesheet_t * tilesheet_create(string_t * scene_name,string_t * tilesheet_ref,string_t * tilesheet_action_ref){
	tilesheet_t * t=GC_ALLOC_INIT(tilesheet_t, {0});
	t->ready=false;
	for(i32 i=0;i<tilesheet_datas->length;++i){
		tilesheet_data_t * ts=tilesheet_datas->buffer[i];
		if(string_equals(ts->name,tilesheet_ref)){
			t->raw=ts;
			tilesheet_play(t,tilesheet_action_ref,null);
			t->ready=true;
			break;
		}
	}
	return t;
}

void tilesheet_play(tilesheet_t * self,string_t * action_ref,void(*on_action_complete)(void)){
	self->on_action_complete=on_action_complete;
	for(i32 i=0;i<self->raw->actions->length;++i){
		tilesheet_action_t * a=self->raw->actions->buffer[i];
		if(string_equals(a->name,action_ref)){
			self->action=a;
			break;
		}
	}
	tilesheet_set_frame(self,self->action->start);
	self->paused=false;
	self->time=0.0;
}

void tilesheet_pause(tilesheet_t * self){
	self->paused=true;
}

void tilesheet_resume(tilesheet_t * self){
	self->paused=false;
}

void tilesheet_set_frame_offset(tilesheet_t * self,i32 frame){
	tilesheet_set_frame(self,self->action->start+frame);
	self->paused=false;
}

i32 tilesheet_get_frame_offset(tilesheet_t * self){
	return self->frame-self->action->start;
}

void tilesheet_update(tilesheet_t * self){
	if(!self->ready||self->paused){
		return ;
	}
	self->time+=sys_real_delta();
	f32 frame_time=1/(float)self->raw->framerate;
	i32 frames_to_advance=0;
	while(self->time>=frame_time){
		self->time-=frame_time;
		frames_to_advance++;
	}
	if(frames_to_advance!=0){
		tilesheet_set_frame(self,self->frame+frames_to_advance);
	}
}

void tilesheet_set_frame(tilesheet_t * self,i32 f){
	self->frame=f;
	if(self->frame>self->action->end){
		if(self->on_action_complete!=null){
			self->on_action_complete();
		}
		if(self->action->loop){
			tilesheet_set_frame(self,self->action->start);
		}
		else {
			self->paused=true;
		}
		return ;
	}
	i32 tx=self->frame%self->raw->tiles_x;
	i32 ty=math_floor(self->frame/(float)self->raw->tiles_x);
	self->tile_x=tx*(1/(float)self->raw->tiles_x);
	self->tile_y=ty*(1/(float)self->raw->tiles_y);
}

transform_t * transform_create(object_t * object){
	transform_t * raw=GC_ALLOC_INIT(transform_t, {0});
	raw->local_only=false;
	raw->scale_world=1.0;
	raw->object=object;
	transform_reset(raw);
	return raw;
}

void transform_reset(transform_t * raw){
	raw->world=mat4_identity();
	raw->world_unpack=mat4_identity();
	raw->local=mat4_identity();
	raw->loc=vec4_create(0.0,0.0,0.0,1.0);
	raw->rot=quat_create(0.0,0.0,0.0,1.0);
	raw->scale=vec4_create(1.0,1.0,1.0,1.0);
	raw->dim=vec4_create(2.0,2.0,2.0,1.0);
	raw->radius=1.0;
	raw->dirty=true;
}

void transform_update(transform_t * raw){
	if(raw->dirty){
		transform_build_matrix(raw);
	}
}

void transform_build_matrix(transform_t * raw){
	raw->local=mat4_compose(raw->loc,raw->rot,raw->scale);
	if(raw->object->parent!=null&&!raw->local_only){
		raw->world=mat4_mult_mat3x4(raw->local,raw->object->parent->transform->world);
	}
	else {
		raw->world=mat4_clone(raw->local);
	}
	raw->world_unpack=mat4_clone(raw->world);
	if(raw->scale_world!=1.0){
		raw->world_unpack.m00*=raw->scale_world;
		raw->world_unpack.m01*=raw->scale_world;
		raw->world_unpack.m02*=raw->scale_world;
		raw->world_unpack.m03*=raw->scale_world;
		raw->world_unpack.m10*=raw->scale_world;
		raw->world_unpack.m11*=raw->scale_world;
		raw->world_unpack.m12*=raw->scale_world;
		raw->world_unpack.m13*=raw->scale_world;
		raw->world_unpack.m20*=raw->scale_world;
		raw->world_unpack.m21*=raw->scale_world;
		raw->world_unpack.m22*=raw->scale_world;
		raw->world_unpack.m23*=raw->scale_world;
	}
	transform_compute_dim(raw);
	for(i32 i=0;i<raw->object->children->length;++i){
		object_t * n=raw->object->children->buffer[i];
		transform_build_matrix(n->transform);
	}
	raw->dirty=false;
}

void transform_translate(transform_t * raw,f32 x,f32 y,f32 z){
	raw->loc.x+=x;
	raw->loc.y+=y;
	raw->loc.z+=z;
	transform_build_matrix(raw);
}

void transform_set_matrix(transform_t * raw,mat4_t mat){
	raw->local=mat4_clone(mat);
	transform_decompose(raw);
	transform_build_matrix(raw);
}

void transform_mult_matrix(transform_t * raw,mat4_t mat){
	raw->local=mat4_mult_mat(raw->local,mat);
	transform_decompose(raw);
	transform_build_matrix(raw);
}

void transform_decompose(transform_t * raw){
	mat4_decomposed_t * dec=mat4_decompose(raw->local);
	raw->loc=dec->loc;
	raw->rot=dec->rot;
	raw->scale=dec->scl;
}

void transform_rotate(transform_t * raw,vec4_t axis,f32 f){
	quat_t q=quat_from_axis_angle(axis,f);
	raw->rot=quat_mult(q,raw->rot);
	transform_build_matrix(raw);
}

void transform_move(transform_t * raw,vec4_t axis,f32 f){
	raw->loc=vec4_fadd(raw->loc,axis.x*f,axis.y*f,axis.z*f,0.0);
	transform_build_matrix(raw);
}

void transform_set_rot(transform_t * raw,f32 x,f32 y,f32 z){
	raw->rot=quat_from_euler(x,y,z);
	raw->dirty=true;
}

void transform_compute_radius(transform_t * raw){
	raw->radius=math_sqrt(raw->dim.x*raw->dim.x+raw->dim.y*raw->dim.y+raw->dim.z*raw->dim.z);
}

void transform_compute_dim(transform_t * raw){
	if(raw->object->raw==null||raw->object->raw->dimensions==null){
		raw->dim=vec4_create(2*raw->scale.x,2*raw->scale.y,2*raw->scale.z,1.0);
	}
	else {
		f32_array_t * d=raw->object->raw->dimensions;
		raw->dim=vec4_create(d->buffer[0]*raw->scale.x,d->buffer[1]*raw->scale.y,d->buffer[2]*raw->scale.z,1.0);
	}
	transform_compute_radius(raw);
}

void transform_apply_parent_inv(transform_t * raw){
	transform_t * pt=raw->object->parent->transform;
	transform_build_matrix(pt);
	mat4_t pinv=mat4_inv(pt->world);
	raw->local=mat4_mult_mat(raw->local,pinv);
	transform_decompose(raw);
	transform_build_matrix(raw);
}

void transform_apply_parent(transform_t * raw){
	transform_t * pt=raw->object->parent->transform;
	transform_build_matrix(pt);
	raw->local=mat4_mult_mat(raw->local,pt->world);
	transform_decompose(raw);
	transform_build_matrix(raw);
}

vec4_t transform_look(transform_t * raw){
	return mat4_look(raw->world);
}

vec4_t transform_right(transform_t * raw){
	return mat4_right(raw->world);
}

vec4_t transform_up(transform_t * raw){
	return mat4_up(raw->world);
}

f32 transform_world_x(transform_t * raw){
	return raw->world.m30;
}

f32 transform_world_y(transform_t * raw){
	return raw->world.m31;
}

f32 transform_world_z(transform_t * raw){
	return raw->world.m32;
}

void tween_on_reset(){
	sys_notify_on_update(tween_update,null);
	tween_reset();
}

void _tween_register(){
	_tween_registered=true;
	sys_notify_on_update(tween_update,null);
	sys_notify_on_reset(tween_on_reset,null);
}

tween_anim_t * tween_to(tween_anim_t * anim){
	if(!_tween_registered){
		_tween_register();
	}
	f32_ptr f32_target=anim->target;
	if(f32_target!=null){
		anim->_from=DEREFERENCE(f32_target);
	}
	any_array_push(_tween_anims,anim);
	return anim;
}

tween_anim_t * tween_timer(f32 delay,void(*done)(any),any data){
	tween_anim_t * a=GC_ALLOC_INIT(tween_anim_t, {.delay=delay,.done=done,.done_data=data});
	return tween_to(a);
}

void tween_stop(tween_anim_t * anim){
	array_remove(_tween_anims,anim);
}

void tween_reset(){
	gc_unroot(_tween_anims);_tween_anims=any_array_create_from_raw((any[]){},0);gc_root(_tween_anims);
}

void tween_update(){
	f32 d=sys_delta();
	i32 i=_tween_anims->length;
	while(i-->0&&_tween_anims->length>0){
		tween_anim_t * a=_tween_anims->buffer[i];
		if(a->delay>0){
			a->delay-=d;
			continue;
		}
		a->_time+=d;
		if(a->_time>=a->duration){
			array_splice(_tween_anims,i,1);
			i--;
			if(a->done!=null){
				a->done(a->done_data);
			}
			continue;
		}
		f32 k=a->_time/(float)a->duration;
		if(k>1){
			k=1;
		}
		f32_ptr f32_target=a->target;
		DEREFERENCE(f32_target)=a->_from+(a->to-a->_from)*_tween_ease(a->ease,k);
		if(a->tick!=null){
			a->tick();
		}
	}
}

f32 _tween_ease_linear(f32 k){
	return k;
}

f32 _tween_ease_expo_in(f32 k){
	return k==0?0:math_pow(2,10*(k-1));
}

f32 _tween_ease_expo_out(f32 k){
	return k==1?1:(1-math_pow(2,-10*k));
}

f32 _tween_ease(ease_t ease,f32 k){
	if(ease==ease_t_LINEAR){
		return _tween_ease_linear(k);
	}
	if(ease==ease_t_QUAD_IN){
	}
	if(ease==ease_t_QUAD_OUT){
	}
	if(ease==ease_t_QUAD_IN_OUT){
	}
	if(ease==ease_t_EXPO_IN){
		return _tween_ease_expo_in(k);
	}
	if(ease==ease_t_EXPO_OUT){
		return _tween_ease_expo_out(k);
	}
	if(ease==ease_t_EXPO_IN_OUT){
	}
	if(ease==ease_t_BOUNCE_IN){
	}
	if(ease==ease_t_BOUNCE_OUT){
	}
	if(ease==ease_t_BOUNCE_IN_OUT){
	}
	if(ease==ease_t_ELASTIC_IN){
	}
	if(ease==ease_t_ELASTIC_OUT){
	}
	if(ease==ease_t_ELASTIC_IN_OUT){
	}
	return 0.0;
}

void uniforms_set_context_consts(shader_context_t * context,string_t_array_t * bind_params){
	if(context->constants!=null){
		for(i32 i=0;i<context->constants->length;++i){
			shader_const_t * c=context->constants->buffer[i];
			uniforms_set_context_const(context->_->constants->buffer[i],c);
		}
	}
	if(bind_params!=null){
		for(i32 i=0;i<math_floor(bind_params->length/(float)2);++i){
			i32 pos=i*2;
			string_t * rt_id=bind_params->buffer[pos];
			string_t * sampler_id=bind_params->buffer[pos+1];
			render_target_t * rt=any_map_get(render_path_render_targets,rt_id);
			uniforms_bind_render_target(rt,context,sampler_id);
		}
	}
	if(context->texture_units!=null){
		for(i32 j=0;j<context->texture_units->length;++j){
			string_t * tulink=context->texture_units->buffer[j]->link;
			if(tulink==null){
				continue;
			}
			if(string_equals(char_at(tulink,0),"$")){
				gpu_set_texture(context->_->tex_units->buffer[j],any_map_get(scene_embedded,substring(tulink,1,string_length(tulink))));
			}
			else if(string_equals(tulink,"_envmap_radiance")){
				world_data_t * w=scene_world;
				if(w!=null){
					gpu_set_texture(context->_->tex_units->buffer[j],w->_->radiance);
				}
			}
			else if(string_equals(tulink,"_envmap_radiance0")){
				world_data_t * w=scene_world;
				if(w!=null){
					gpu_set_texture(context->_->tex_units->buffer[j],w->_->radiance_mipmaps->buffer[0]);
				}
			}
			else if(string_equals(tulink,"_envmap_radiance1")){
				world_data_t * w=scene_world;
				if(w!=null){
					gpu_set_texture(context->_->tex_units->buffer[j],w->_->radiance_mipmaps->buffer[1]);
				}
			}
			else if(string_equals(tulink,"_envmap_radiance2")){
				world_data_t * w=scene_world;
				if(w!=null){
					gpu_set_texture(context->_->tex_units->buffer[j],w->_->radiance_mipmaps->buffer[2]);
				}
			}
			else if(string_equals(tulink,"_envmap_radiance3")){
				world_data_t * w=scene_world;
				if(w!=null){
					gpu_set_texture(context->_->tex_units->buffer[j],w->_->radiance_mipmaps->buffer[3]);
				}
			}
			else if(string_equals(tulink,"_envmap_radiance4")){
				world_data_t * w=scene_world;
				if(w!=null){
					gpu_set_texture(context->_->tex_units->buffer[j],w->_->radiance_mipmaps->buffer[4]);
				}
			}
			else if(string_equals(tulink,"_envmap")){
				world_data_t * w=scene_world;
				if(w!=null){
					gpu_set_texture(context->_->tex_units->buffer[j],w->_->envmap);
				}
			}
		}
	}
}

void uniforms_set_obj_consts(shader_context_t * context,object_t * object){
	if(context->constants!=null){
		for(i32 i=0;i<context->constants->length;++i){
			shader_const_t * c=context->constants->buffer[i];
			uniforms_set_obj_const(object,context->_->constants->buffer[i],c);
		}
	}
	if(uniforms_tex_links!=null&&context->texture_units!=null){
		for(i32 j=0;j<context->texture_units->length;++j){
			tex_unit_t * tu=context->texture_units->buffer[j];
			if(tu->link==null){
				continue;
			}
			gpu_texture_t * image=uniforms_tex_links(object,current_material(object),tu->link);
			if(image!=null){
				gpu_set_texture(context->_->tex_units->buffer[j],image);
			}
		}
	}
}

void uniforms_bind_render_target(render_target_t * rt,shader_context_t * context,string_t * sampler_id){
	if(rt==null){
		return ;
	}
	tex_unit_t_array_t * tus=context->texture_units;
	for(i32 j=0;j<tus->length;++j){
		if(string_equals(sampler_id,tus->buffer[j]->name)){
			gpu_set_texture(context->_->tex_units->buffer[j],rt->_image);
		}
	}
}

bool uniforms_set_context_const(i32 location,shader_const_t * c){
	if(c->link==null){
		return true;
	}
	camera_object_t * camera=scene_camera;
	if(string_equals(c->type,"mat4")){
		mat4_t m=mat4_nan();
		if(string_equals(c->link,"_view_matrix")){
			m=camera->v;
		}
		else if(string_equals(c->link,"_proj_matrix")){
			m=camera->p;
		}
		else if(string_equals(c->link,"_inv_proj_matrix")){
			m=mat4_inv(camera->p);
		}
		else if(string_equals(c->link,"_view_proj_matrix")){
			m=camera->vp;
		}
		else if(string_equals(c->link,"_inv_view_proj_matrix")){
			m=mat4_mult_mat(camera->v,camera->p);
			m=mat4_inv(m);
		}
		else if(string_equals(c->link,"_skydome_matrix")){
			transform_t * tr=camera->base->transform;
			vec4_t v=vec4_create(transform_world_x(tr),transform_world_y(tr),transform_world_z(tr),1.0);
			f32 bounds=camera->data->far_plane*0.9;
			vec4_t v2=vec4_create(bounds,bounds,bounds,1.0);
			m=mat4_compose(v,_uniforms_quat,v2);
			m=mat4_mult_mat(m,camera->v);
			m=mat4_mult_mat(m,camera->p);
		}
		else {
			return false;
		}
		gpu_set_matrix4(location,m);
		return true;
	}
	else if(string_equals(c->type,"vec4")){
		vec4_t v=vec4_nan();
		if(string_equals(c->link,"_envmap_irradiance0")){
			f32_array_t * fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
			v.x=fa->buffer[0];
			v.y=fa->buffer[1];
			v.z=fa->buffer[2];
			v.w=fa->buffer[3];
		}
		else if(string_equals(c->link,"_envmap_irradiance1")){
			f32_array_t * fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
			v.x=fa->buffer[4];
			v.y=fa->buffer[5];
			v.z=fa->buffer[6];
			v.w=fa->buffer[7];
		}
		else if(string_equals(c->link,"_envmap_irradiance2")){
			f32_array_t * fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
			v.x=fa->buffer[8];
			v.y=fa->buffer[9];
			v.z=fa->buffer[10];
			v.w=fa->buffer[11];
		}
		else if(string_equals(c->link,"_envmap_irradiance3")){
			f32_array_t * fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
			v.x=fa->buffer[12];
			v.y=fa->buffer[13];
			v.z=fa->buffer[14];
			v.w=fa->buffer[15];
		}
		else if(string_equals(c->link,"_envmap_irradiance4")){
			f32_array_t * fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
			v.x=fa->buffer[16];
			v.y=fa->buffer[17];
			v.z=fa->buffer[18];
			v.w=fa->buffer[19];
		}
		else if(string_equals(c->link,"_envmap_irradiance5")){
			f32_array_t * fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
			v.x=fa->buffer[20];
			v.y=fa->buffer[21];
			v.z=fa->buffer[22];
			v.w=fa->buffer[23];
		}
		else if(string_equals(c->link,"_envmap_irradiance6")){
			f32_array_t * fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
			v.x=fa->buffer[24];
			v.y=fa->buffer[25];
			v.z=fa->buffer[26];
			v.w=fa->buffer[27];
		}
		else {
			return false;
		}
		if(!vec4_isnan(v)){
			gpu_set_float4(location,v.x,v.y,v.z,v.w);
		}
		else {
			gpu_set_float4(location,0,0,0,0);
		}
		return true;
	}
	else if(string_equals(c->type,"vec3")){
		vec4_t v=vec4_nan();
		if(string_equals(c->link,"_camera_pos")){
			v=vec4_create(transform_world_x(camera->base->transform),transform_world_y(camera->base->transform),transform_world_z(camera->base->transform),1.0);
		}
		else if(string_equals(c->link,"_camera_look")){
			v=vec4_norm(camera_object_look_world(camera));
		}
		else {
			return false;
		}
		if(!vec4_isnan(v)){
			gpu_set_float3(location,v.x,v.y,v.z);
		}
		else {
			gpu_set_float3(location,0.0,0.0,0.0);
		}
		return true;
	}
	else if(string_equals(c->type,"vec2")){
		vec4_t v=vec4_nan();
		if(string_equals(c->link,"_vec2x")){
			v.x=1.0;
			v.y=0.0;
		}
		else if(string_equals(c->link,"_vec2x_inv")){
			v.x=1.0/(float)render_path_current_w;
			v.y=0.0;
		}
		else if(string_equals(c->link,"_vec2x2")){
			v.x=2.0;
			v.y=0.0;
		}
		else if(string_equals(c->link,"_vec2x2_inv")){
			v.x=2.0/(float)render_path_current_w;
			v.y=0.0;
		}
		else if(string_equals(c->link,"_vec2y")){
			v.x=0.0;
			v.y=1.0;
		}
		else if(string_equals(c->link,"_vec2y_inv")){
			v.x=0.0;
			v.y=1.0/(float)render_path_current_h;
		}
		else if(string_equals(c->link,"_vec2y2")){
			v.x=0.0;
			v.y=2.0;
		}
		else if(string_equals(c->link,"_vec2y2_inv")){
			v.x=0.0;
			v.y=2.0/(float)render_path_current_h;
		}
		else if(string_equals(c->link,"_vec2y3")){
			v.x=0.0;
			v.y=3.0;
		}
		else if(string_equals(c->link,"_vec2y3_inv")){
			v.x=0.0;
			v.y=3.0/(float)render_path_current_h;
		}
		else if(string_equals(c->link,"_screen_size")){
			v.x=render_path_current_w;
			v.y=render_path_current_h;
		}
		else if(string_equals(c->link,"_screen_size_inv")){
			v.x=1.0/(float)render_path_current_w;
			v.y=1.0/(float)render_path_current_h;
		}
		else if(string_equals(c->link,"_camera_plane_proj")){
			f32 znear=camera->data->near_plane;
			f32 zfar=camera->data->far_plane;
			v.x=zfar/(float)(zfar-znear);
			v.y=(-zfar*znear)/(float)(zfar-znear);
		}
		else if(starts_with(c->link,"_size(")){
			string_t * tex=substring(c->link,6,string_length(c->link)-1);
			gpu_texture_t * image=uniforms_tex_links(null,null,tex);
			if(image!=null){
				v.x=image->width;
				v.y=image->height;
			}
			else if(_render_path_bind_params!=null){
				for(i32 i=0;i<math_floor(_render_path_bind_params->length/(float)2);++i){
					i32 pos=i*2;
					string_t * sampler_id=_render_path_bind_params->buffer[pos+1];
					if(string_equals(sampler_id,tex)){
						string_t * rt_id=_render_path_bind_params->buffer[pos];
						render_target_t * rt=any_map_get(render_path_render_targets,rt_id);
						v.x=rt->width;
						v.y=rt->height;
					}
				}
			}
		}
		else {
			return false;
		}
		if(!vec4_isnan(v)){
			gpu_set_float2(location,v.x,v.y);
		}
		else {
			gpu_set_float2(location,0.0,0.0);
		}
		return true;
	}
	else if(string_equals(c->type,"float")){
		f32 f=0.0;
		if(string_equals(c->link,"_time")){
			f=sys_time();
		}
		else if(string_equals(c->link,"_aspect_ratio_window")){
			f=sys_w()/(float)sys_h();
		}
		else {
			return false;
		}
		gpu_set_float(location,f);
		return true;
	}
	else if(string_equals(c->type,"floats")){
		f32_array_t * fa=null;
		if(string_equals(c->link,"_envmap_irradiance")){
			fa=scene_world==null?world_data_get_empty_irradiance():scene_world->_->irradiance;
		}
		if(fa!=null){
			gpu_set_floats(location,fa);
			return true;
		}
	}
	else if(string_equals(c->type,"int")){
		i32 i=0;
		if(string_equals(c->link,"_envmap_num_mipmaps")){
			world_data_t * w=scene_world;
			i=w!=null?w->radiance_mipmaps+1-2:1;
		}
		else {
			return false;
		}
		gpu_set_int(location,i);
		return true;
	}
	return false;
}

void uniforms_set_obj_const(object_t * obj,i32 loc,shader_const_t * c){
	if(c->link==null){
		return ;
	}
	camera_object_t * camera=scene_camera;
	if(string_equals(c->type,"mat4")){
		mat4_t m=mat4_nan();
		if(string_equals(c->link,"_world_matrix")){
			m=obj->transform->world_unpack;
		}
		else if(string_equals(c->link,"_inv_world_matrix")){
			m=mat4_inv(obj->transform->world_unpack);
		}
		else if(string_equals(c->link,"_world_view_proj_matrix")){
			m=mat4_mult_mat(obj->transform->world_unpack,camera->v);
			m=mat4_mult_mat(m,camera->p);
		}
		else if(string_equals(c->link,"_world_wiew_matrix")){
			m=mat4_mult_mat(obj->transform->world_unpack,camera->v);
		}
		else if(uniforms_mat4_links!=null){
			m=uniforms_mat4_links(obj,current_material(obj),c->link);
		}
		if(mat4_isnan(m)){
			return ;
		}
		gpu_set_matrix4(loc,m);
	}
	else if(string_equals(c->type,"mat3")){
		mat3_t m=mat3_nan();
		if(string_equals(c->link,"_normal_matrix")){
			mat4_t m4=mat4_inv(obj->transform->world);
			m4=mat4_transpose3x3(m4);
			m=mat3_set_from4(m4);
		}
		else if(string_equals(c->link,"_view_matrix3")){
			m=mat3_set_from4(camera->v);
		}
		if(mat3_isnan(m)){
			return ;
		}
		gpu_set_matrix3(loc,m);
	}
	else if(string_equals(c->type,"vec4")){
		vec4_t v=vec4_nan();
		if(uniforms_vec4_links!=null){
			v=uniforms_vec4_links(obj,current_material(obj),c->link);
		}
		if(vec4_isnan(v)){
			return ;
		}
		gpu_set_float4(loc,v.x,v.y,v.z,v.w);
	}
	else if(string_equals(c->type,"vec3")){
		vec4_t v=vec4_nan();
		if(string_equals(c->link,"_dim")){
			vec4_t d=obj->transform->dim;
			vec4_t s=obj->transform->scale;
			v=vec4_create((d.x/(float)s.x),(d.y/(float)s.y),(d.z/(float)s.z),1.0);
		}
		else if(string_equals(c->link,"_half_dim")){
			vec4_t d=obj->transform->dim;
			vec4_t s=obj->transform->scale;
			v=vec4_create((d.x/(float)s.x)/(float)2,(d.y/(float)s.y)/(float)2,(d.z/(float)s.z)/(float)2,1.0);
		}
		else if(uniforms_vec3_links!=null){
			v=uniforms_vec3_links(obj,current_material(obj),c->link);
		}
		if(vec4_isnan(v)){
			return ;
		}
		gpu_set_float3(loc,v.x,v.y,v.z);
	}
	else if(string_equals(c->type,"vec2")){
		vec2_t v=vec2_nan();
		if(uniforms_vec2_links!=null){
			v=uniforms_vec2_links(obj,current_material(obj),c->link);
		}
		if(vec2_isnan(v)){
			return ;
		}
		gpu_set_float2(loc,v.x,v.y);
	}
	else if(string_equals(c->type,"float")){
		f32 f=f32_nan();
		if(string_equals(c->link,"_object_info_index")){
			f=obj->uid;
		}
		else if(string_equals(c->link,"_object_info_material_index")){
			f=current_material(obj)->_->uid;
		}
		else if(string_equals(c->link,"_object_info_random")){
			f=obj->urandom;
		}
		else if(string_equals(c->link,"_pos_unpack")){
			f=uniforms_pos_unpack;
		}
		else if(string_equals(c->link,"_tex_unpack")){
			f=uniforms_tex_unpack;
		}
		else if(uniforms_f32_links!=null){
			f=uniforms_f32_links(obj,current_material(obj),c->link);
		}
		if(f32_isnan(f)){
			return ;
		}
		gpu_set_float(loc,f);
	}
	else if(string_equals(c->type,"floats")){
		f32_array_t * fa=null;
		if(string_equals(c->link,"_skin_bones")){
		}
		else if(uniforms_f32_array_links!=null){
			fa=uniforms_f32_array_links(obj,current_material(obj),c->link);
		}
		if(fa==null){
			return ;
		}
		gpu_set_floats(loc,fa);
	}
	else if(string_equals(c->type,"int")){
		i32 i=INT_MAX;
		if(string_equals(c->link,"_uid")){
			i=obj->uid;
		}
		else if(uniforms_i32_links!=null){
			i=uniforms_i32_links(obj,current_material(obj),c->link);
		}
		if(i==INT_MAX){
			return ;
		}
		gpu_set_int(loc,i);
	}
}

void uniforms_set_material_consts(shader_context_t * context,material_context_t * material_context){
	if(material_context->bind_constants!=null){
		for(i32 i=0;i<material_context->bind_constants->length;++i){
			bind_const_t * matc=material_context->bind_constants->buffer[i];
			i32 pos=-1;
			for(i32 i=0;i<context->constants->length;++i){
				string_t * name=context->constants->buffer[i]->name;
				if(string_equals(name,matc->name)){
					pos=i;
					break;
				}
			}
			if(pos==-1){
				continue;
			}
			shader_const_t * c=context->constants->buffer[pos];
			uniforms_set_material_const(context->_->constants->buffer[pos],c,matc);
		}
	}
	if(material_context->_->textures!=null){
		for(i32 i=0;i<material_context->_->textures->length;++i){
			string_t * mname=material_context->bind_textures->buffer[i]->name;
			for(i32 j=0;j<context->_->tex_units->length;++j){
				string_t * sname=context->texture_units->buffer[j]->name;
				if(string_equals(mname,sname)){
					gpu_set_texture(context->_->tex_units->buffer[j],material_context->_->textures->buffer[i]);
					break;
				}
			}
		}
	}
}

material_data_t * current_material(object_t * object){
	if(object!=null&&object->ext!=null){
		mesh_object_t * mo=object->ext;
		if(mo->materials!=null){
			return mo->materials->buffer[mo->material_index];
		}
	}
	return null;
}

void uniforms_set_material_const(i32 location,shader_const_t * shader_const,bind_const_t * material_const){
	if(string_equals(shader_const->type,"vec4")){
		gpu_set_float4(location,material_const->vec->buffer[0],material_const->vec->buffer[1],material_const->vec->buffer[2],material_const->vec->buffer[3]);
	}
	else if(string_equals(shader_const->type,"vec3")){
		gpu_set_float3(location,material_const->vec->buffer[0],material_const->vec->buffer[1],material_const->vec->buffer[2]);
	}
	else if(string_equals(shader_const->type,"vec2")){
		gpu_set_float2(location,material_const->vec->buffer[0],material_const->vec->buffer[1]);
	}
	else if(string_equals(shader_const->type,"float")){
		gpu_set_float(location,material_const->vec->buffer[0]);
	}
	else if(string_equals(shader_const->type,"bool")){
		gpu_set_bool(location,material_const->vec->buffer[0]>0.0);
	}
	else if(string_equals(shader_const->type,"int")){
		gpu_set_int(location,math_floor(material_const->vec->buffer[0]));
	}
}

world_data_t * world_data_parse(string_t * name,string_t * id){
	scene_t * format=data_get_scene_raw(name);
	world_data_t * raw=world_data_get_raw_by_name(format->world_datas,id);
	if(raw==null){
		iron_log(string_join(string_join("World data '",id),"' not found!"));
		return null;
	}
	raw->_=GC_ALLOC_INIT(world_data_runtime_t, {0});
	raw->_->radiance_mipmaps=any_array_create_from_raw((any[]){},0);
	f32_array_t * irr=world_data_set_irradiance(raw);
	raw->_->irradiance=irr;
	if(raw->radiance!=null){
		gpu_texture_t * rad=data_get_image(raw->radiance);
		raw->_->radiance=rad;
		while(raw->_->radiance_mipmaps->length<raw->radiance_mipmaps){
			any_array_push(raw->_->radiance_mipmaps,null);
		}
		i32 dot=string_last_index_of(raw->radiance,".");
		string_t * ext=substring(raw->radiance,dot,string_length(raw->radiance));
		string_t * base=substring(raw->radiance,0,dot);
		for(i32 i=0;i<raw->radiance_mipmaps;++i){
			gpu_texture_t * mipimg=data_get_image(string_join(string_join(string_join(base,"_"),i32_to_string(i)),ext));
			raw->_->radiance_mipmaps->buffer[i]=mipimg;
		}
	}
	return raw;
}

world_data_t * world_data_get_raw_by_name(world_data_t_array_t * datas,string_t * name){
	if(string_equals(name,"")){
		return datas->buffer[0];
	}
	for(i32 i=0;i<datas->length;++i){
		if(string_equals(datas->buffer[i]->name,name)){
			return datas->buffer[i];
		}
	}
	return null;
}

f32_array_t * world_data_get_empty_irradiance(){
	if(_world_data_empty_irr==null){
		gc_unroot(_world_data_empty_irr);_world_data_empty_irr=f32_array_create(28);gc_root(_world_data_empty_irr);
		for(i32 i=0;i<_world_data_empty_irr->length;++i){
			_world_data_empty_irr->buffer[i]=0.0;
		}
	}
	return _world_data_empty_irr;
}

f32_array_t * world_data_set_irradiance(world_data_t * raw){
	if(raw->irradiance==null){
		return world_data_get_empty_irradiance();
	}
	else {
		buffer_t * b=data_get_blob(string_join(raw->irradiance,".arm"));
		irradiance_t * irradiance_parsed=armpack_decode(b);
		f32_array_t * irr=f32_array_create(28);
		for(i32 i=0;i<27;++i){
			irr->buffer[i]=irradiance_parsed->irradiance->buffer[i];
		}
		return irr;
	}
}

void world_data_load_envmap(world_data_t * raw){
	if(raw->envmap!=null){
		gpu_texture_t * image=data_get_image(raw->envmap);
		raw->_->envmap=image;
	}
}

boolean_node_t * boolean_node_create(ui_node_t * raw,f32_array_t * args){
	boolean_node_t * n=GC_ALLOC_INIT(boolean_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=boolean_node_get;
	n->base->set=boolean_node_set;
	n->value=args==null?false:args->buffer[0]>0.0;
	return n;
}

logic_node_value_t * boolean_node_get(boolean_node_t * self,i32 from){
	if(self->base->inputs->length>0){
		return logic_node_input_get(self->base->inputs->buffer[0]);
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=self->value?1.0:0.0});
		return v;
	}
}

void boolean_node_set(boolean_node_t * self,f32_array_t * value){
	if(self->base->inputs->length>0){
		logic_node_input_set(self->base->inputs->buffer[0],value);
	}
	else {
		self->value=value->buffer[0]>0.0;
	}
}

brush_output_node_t * brush_output_node_create(ui_node_t * raw,f32_array_t * args){
	context_raw->run_brush=brush_output_node_run;
	context_raw->parse_brush_inputs=brush_output_node_parse_inputs;
	brush_output_node_t * n=GC_ALLOC_INIT(brush_output_node_t, {0});
	n->base=logic_node_create(n);
	n->raw=raw;
	brush_output_node_create_ext(n);
	return n;
}

color_node_t * color_node_create(ui_node_t * raw,f32_array_t * args){
	f32 r=args==null?0.8:args->buffer[0];
	f32 g=args==null?0.8:args->buffer[1];
	f32 b=args==null?0.8:args->buffer[2];
	f32 a=args==null?1.0:args->buffer[3];
	color_node_t * n=GC_ALLOC_INIT(color_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=color_node_get;
	n->base->get_as_image=color_node_get_as_image;
	n->base->set=color_node_set;
	n->value=vec4_create(r,g,b,a);
	return n;
}

logic_node_value_t * color_node_get(color_node_t * self,i32 from){
	if(self->base->inputs->length>0){
		return logic_node_input_get(self->base->inputs->buffer[0]);
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._vec4=self->value});
		return v;
	}
}

gpu_texture_t * color_node_get_as_image(color_node_t * self,i32 from){
	if(self->base->inputs->length>0){
		return logic_node_input_get_as_image(self->base->inputs->buffer[0]);
	}
	if(self->image!=null){
		iron_delete_texture(self->image);
	}
	buffer_t * b=buffer_create(16);
	buffer_set_f32(b,0,self->value.x);
	buffer_set_f32(b,4,self->value.y);
	buffer_set_f32(b,8,self->value.z);
	buffer_set_f32(b,12,self->value.w);
	self->image=gpu_create_texture_from_bytes(b,1,1,tex_format_t_RGBA128);
	return self->image;
}

void color_node_set(color_node_t * self,f32_array_t * value){
	if(self->base->inputs->length>0){
		logic_node_input_set(self->base->inputs->buffer[0],value);
	}
	else {
		self->value.x=value->buffer[0];
		self->value.y=value->buffer[1];
		self->value.z=value->buffer[2];
		self->value.w=value->buffer[3];
	}
}

float_node_t * float_node_create(ui_node_t * raw,f32_array_t * args){
	float_node_t * n=GC_ALLOC_INIT(float_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=float_node_get;
	n->base->get_as_image=float_node_get_as_image;
	n->base->set=float_node_set;
	n->value=args==null?0.5:args->buffer[0];
	return n;
}

logic_node_value_t * float_node_get(float_node_t * self,i32 from){
	if(self->base->inputs->length>0){
		return logic_node_input_get(self->base->inputs->buffer[0]);
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=self->value});
		return v;
	}
}

gpu_texture_t * float_node_get_as_image(float_node_t * self,i32 from){
	if(self->base->inputs->length>0){
		return logic_node_input_get_as_image(self->base->inputs->buffer[0]);
	}
	if(self->image!=null){
		iron_delete_texture(self->image);
	}
	buffer_t * b=buffer_create(16);
	buffer_set_f32(b,0,self->value);
	buffer_set_f32(b,4,self->value);
	buffer_set_f32(b,8,self->value);
	buffer_set_f32(b,12,1.0);
	self->image=gpu_create_texture_from_bytes(b,1,1,tex_format_t_RGBA128);
	return self->image;
}

void float_node_set(float_node_t * self,f32_array_t * value){
	if(self->base->inputs->length>0){
		logic_node_input_set(self->base->inputs->buffer[0],value);
	}
	else {
		self->value=value->buffer[0];
	}
}

integer_node_t * integer_node_create(ui_node_t * raw,f32_array_t * args){
	float_node_t * n=GC_ALLOC_INIT(float_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=integer_node_get;
	n->base->set=integer_node_set;
	n->value=args==null?0:args->buffer[0];
	return n;
}

logic_node_value_t * integer_node_get(integer_node_t * self,i32 from){
	if(self->base->inputs->length>0){
		return logic_node_input_get(self->base->inputs->buffer[0]);
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=self->value});
		return v;
	}
}

void integer_node_set(integer_node_t * self,f32_array_t * value){
	if(self->base->inputs->length>0){
		logic_node_input_set(self->base->inputs->buffer[0],value);
	}
	else {
		self->value=value->buffer[0];
	}
}

math_node_t * math_node_create(ui_node_t * raw,f32_array_t * args){
	math_node_t * n=GC_ALLOC_INIT(math_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=math_node_get;
	return n;
}

logic_node_value_t * math_node_get(math_node_t * self,i32 from){
	f32 v1=logic_node_input_get(self->base->inputs->buffer[0])->_f32;
	f32 v2=logic_node_input_get(self->base->inputs->buffer[1])->_f32;
	f32 f=0.0;
	string_t * op=self->operation;
	if(string_equals(op,"Add")){
		f=v1+v2;
	}
	else if(string_equals(op,"Multiply")){
		f=v1*v2;
	}
	else if(string_equals(op,"Sine")){
		f=math_sin(v1);
	}
	else if(string_equals(op,"Cosine")){
		f=math_cos(v1);
	}
	else if(string_equals(op,"Max")){
		f=math_max(v1,v2);
	}
	else if(string_equals(op,"Min")){
		f=math_min(v1,v2);
	}
	else if(string_equals(op,"Absolute")){
		f=math_abs(v1);
	}
	else if(string_equals(op,"Subtract")){
		f=v1-v2;
	}
	else if(string_equals(op,"Divide")){
		f=v1/(float)(v2==0.0?0.000001:v2);
	}
	else if(string_equals(op,"Tangent")){
		f=math_tan(v1);
	}
	else if(string_equals(op,"Arcsine")){
		f=math_asin(v1);
	}
	else if(string_equals(op,"Arccosine")){
		f=math_acos(v1);
	}
	else if(string_equals(op,"Arctangent")){
		f=math_atan(v1);
	}
	else if(string_equals(op,"Arctan2")){
		f=math_atan2(v2,v1);
	}
	else if(string_equals(op,"Power")){
		f=math_pow(v1,v2);
	}
	else if(string_equals(op,"Logarithm")){
		f=math_log(v1);
	}
	else if(string_equals(op,"Round")){
		f=math_round(v1);
	}
	else if(string_equals(op,"Floor")){
		f=math_floor(v1);
	}
	else if(string_equals(op,"Ceil")){
		f=math_ceil(v1);
	}
	else if(string_equals(op,"Truncate")){
		f=math_floor(v1);
	}
	else if(string_equals(op,"Fraction")){
		f=v1-math_floor(v1);
	}
	else if(string_equals(op,"Less Than")){
		f=v1<v2?1.0:0.0;
	}
	else if(string_equals(op,"Greater Than")){
		f=v1>v2?1.0:0.0;
	}
	else if(string_equals(op,"Modulo")){
		f=math_fmod(v1,v2);
	}
	else if(string_equals(op,"Snap")){
		f=math_floor(v1/(float)v2)*v2;
	}
	else if(string_equals(op,"Square Root")){
		f=math_sqrt(v1);
	}
	else if(string_equals(op,"Inverse Square Root")){
		f=1.0/(float)math_sqrt(v1);
	}
	else if(string_equals(op,"Exponent")){
		f=math_exp(v1);
	}
	else if(string_equals(op,"Sign")){
		f=v1>0?1.0:(v1<0?-1.0:0);
	}
	else if(string_equals(op,"Ping-Pong")){
		f=(v2!=0.0)?v2-math_abs(math_fmod(math_abs(v1),(2*v2))-v2):0.0;
	}
	else if(string_equals(op,"Hyperbolic Sine")){
		f=(math_exp(v1)-math_exp(-v1))/(float)2.0;
	}
	else if(string_equals(op,"Hyperbolic Cosine")){
		f=(math_exp(v1)+math_exp(-v1))/(float)2.0;
	}
	else if(string_equals(op,"Hyperbolic Tangent")){
		f=1.0-(2.0/(float)(math_exp(2*v1)+1));
	}
	else if(string_equals(op,"To Radians")){
		f=v1/(float)180.0*math_pi();
	}
	else if(string_equals(op,"To Degrees")){
		f=v1/(float)math_pi()*180.0;
	}
	if(self->use_clamp){
		f=f<0.0?0.0:(f>1.0?1.0:f);
	}
	logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=f});
	return v;
}

null_node_t * null_node_create(ui_node_t * raw,f32_array_t * args){
	null_node_t * n=GC_ALLOC_INIT(null_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=float_node_get;
	return n;
}

logic_node_value_t * null_node_get(null_node_t * self,i32 from){
	return null;
}

random_node_t * random_node_create(ui_node_t * raw,f32_array_t * args){
	random_node_t * n=GC_ALLOC_INIT(random_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=random_node_get;
	return n;
}

logic_node_value_t * random_node_get(random_node_t * self,i32 from){
	f32 min=logic_node_input_get(self->base->inputs->buffer[0])->_f32;
	f32 max=logic_node_input_get(self->base->inputs->buffer[1])->_f32;
	logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=min+random_node_get_float()*(max-min)});
	return v;
}

i32 random_node_get_int(){
	if(random_node_d==-1){
		random_node_set_seed(352124);
	}
	i32 t=(random_node_a+random_node_b|0)+random_node_d|0;
	random_node_d=random_node_d+1|0;
	u32 urandom_node_b=random_node_b;
	random_node_a=random_node_b^urandom_node_b>>9;
	random_node_b=random_node_c+(random_node_c<<3)|0;
	u32 urandom_node_c=random_node_c;
	random_node_c=random_node_c<<21|urandom_node_c>>11;
	random_node_c=random_node_c+t|0;
	return t&0x7fffffff;
}

void random_node_set_seed(i32 seed){
	random_node_d=seed;
	random_node_a=0x36aef51a;
	random_node_b=0x21d4b3eb;
	random_node_c=0xf2517abf;
	for(i32 i=0;i<15;++i){
		random_node_get_int();
	}
}

i32 random_node_get_seed(){
	return random_node_d;
}

f32 random_node_get_float(){
	return random_node_get_int()/(float)0x7fffffff;
}

separate_vector_node_t * separate_vector_node_create(ui_node_t * raw,f32_array_t * args){
	separate_vector_node_t * n=GC_ALLOC_INIT(separate_vector_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=separate_vector_node_get;
	return n;
}

logic_node_value_t * separate_vector_node_get(separate_vector_node_t * self,i32 from){
	vec4_t vector=logic_node_input_get(self->base->inputs->buffer[0])->_vec4;
	if(from==0){
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=vector.x});
		return v;
	}
	else if(from==1){
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=vector.y});
		return v;
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=vector.z});
		return v;
	}
}

string_node_t * string_node_create(ui_node_t * raw,f32_array_t * args){
	string_node_t * n=GC_ALLOC_INIT(string_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=string_node_get;
	n->base->set=string_node_set;
	n->value=args==null?"":sys_buffer_to_string(args->buffer);
	return n;
}

logic_node_value_t * string_node_get(string_node_t * self,i32 from){
	if(self->base->inputs->length>0){
		return logic_node_input_get(self->base->inputs->buffer[0]);
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._str=self->value});
		return v;
	}
}

void string_node_set(string_node_t * self,any value){
	if(self->base->inputs->length>0){
		logic_node_input_set(self->base->inputs->buffer[0],value);
	}
	else {
		self->value=string_copy(value);
	}
}

time_node_t * time_node_create(ui_node_t * raw,f32_array_t * args){
	time_node_t * n=GC_ALLOC_INIT(time_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=time_node_get;
	return n;
}

logic_node_value_t * time_node_get(time_node_t * self,i32 from){
	if(from==0){
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=sys_time()});
		return v;
	}
	else if(from==1){
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=sys_delta()});
		return v;
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=context_raw->brush_time});
		return v;
	}
}

vector_math_node_t * vector_math_node_create(ui_node_t * raw,f32_array_t * args){
	vector_math_node_t * n=GC_ALLOC_INIT(vector_math_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=vector_math_node_get;
	n->v=vec4_create(0.0,0.0,0.0,1.0);
	return n;
}

logic_node_value_t * vector_math_node_get(vector_math_node_t * self,i32 from){
	vec4_t v1=logic_node_input_get(self->base->inputs->buffer[0])->_vec4;
	vec4_t v2=logic_node_input_get(self->base->inputs->buffer[1])->_vec4;
	self->v=vec4_clone(v1);
	f32 f=0.0;
	string_t * op=self->operation;
	if(string_equals(op,"Add")){
		self->v=vec4_add(self->v,v2);
	}
	else if(string_equals(op,"Subtract")){
		self->v=vec4_sub(self->v,v2);
	}
	else if(string_equals(op,"Average")){
		self->v=vec4_add(self->v,v2);
		self->v.x*=0.5;
		self->v.y*=0.5;
		self->v.z*=0.5;
	}
	else if(string_equals(op,"Dot Product")){
		f=vec4_dot(self->v,v2);
		self->v=vec4_create(f,f,f,1.0);
	}
	else if(string_equals(op,"Cross Product")){
		self->v=vec4_cross(self->v,v2);
	}
	else if(string_equals(op,"Normalize")){
		self->v=vec4_norm(self->v);
	}
	else if(string_equals(op,"Multiply")){
		self->v.x*=v2.x;
		self->v.y*=v2.y;
		self->v.z*=v2.z;
	}
	else if(string_equals(op,"Divide")){
		self->v.x/=v2.x==0.0?0.000001:v2.x;
		self->v.y/=v2.y==0.0?0.000001:v2.y;
		self->v.z/=v2.z==0.0?0.000001:v2.z;
	}
	else if(string_equals(op,"Length")){
		f=vec4_len(self->v);
		self->v=vec4_create(f,f,f,1.0);
	}
	else if(string_equals(op,"Distance")){
		f=vec4_dist(self->v,v2);
		self->v=vec4_create(f,f,f,1.0);
	}
	else if(string_equals(op,"Project")){
		self->v=vec4_clone(v2);
		self->v=vec4_mult(self->v,vec4_dot(v1,v2)/(float)vec4_dot(v2,v2));
	}
	else if(string_equals(op,"Reflect")){
		vec4_t tmp=vec4_create(0.0,0.0,0.0,1.0);
		tmp=vec4_clone(v2);
		tmp=vec4_norm(tmp);
		self->v=vec4_reflect(self->v,tmp);
	}
	else if(string_equals(op,"Scale")){
		self->v.x*=v2.x;
		self->v.y*=v2.x;
		self->v.z*=v2.x;
	}
	else if(string_equals(op,"Absolute")){
		self->v.x=math_abs(self->v.x);
		self->v.y=math_abs(self->v.y);
		self->v.z=math_abs(self->v.z);
	}
	else if(string_equals(op,"Minimum")){
		self->v.x=math_min(v1.x,v2.x);
		self->v.y=math_min(v1.y,v2.y);
		self->v.z=math_min(v1.z,v2.z);
	}
	else if(string_equals(op,"Maximum")){
		self->v.x=math_max(v1.x,v2.x);
		self->v.y=math_max(v1.y,v2.y);
		self->v.z=math_max(v1.z,v2.z);
	}
	else if(string_equals(op,"Floor")){
		self->v.x=math_floor(v1.x);
		self->v.y=math_floor(v1.y);
		self->v.z=math_floor(v1.z);
	}
	else if(string_equals(op,"Ceil")){
		self->v.x=math_ceil(v1.x);
		self->v.y=math_ceil(v1.y);
		self->v.z=math_ceil(v1.z);
	}
	else if(string_equals(op,"Fraction")){
		self->v.x=v1.x-math_floor(v1.x);
		self->v.y=v1.y-math_floor(v1.y);
		self->v.z=v1.z-math_floor(v1.z);
	}
	else if(string_equals(op,"Modulo")){
		self->v.x=math_fmod(v1.x,v2.x);
		self->v.y=math_fmod(v1.y,v2.y);
		self->v.z=math_fmod(v1.z,v2.z);
	}
	else if(string_equals(op,"Snap")){
		self->v.x=math_floor(v1.x/(float)v2.x)*v2.x;
		self->v.y=math_floor(v1.y/(float)v2.y)*v2.y;
		self->v.z=math_floor(v1.z/(float)v2.z)*v2.z;
	}
	else if(string_equals(op,"Sine")){
		self->v.x=math_sin(v1.x);
		self->v.y=math_sin(v1.y);
		self->v.z=math_sin(v1.z);
	}
	else if(string_equals(op,"Cosine")){
		self->v.x=math_cos(v1.x);
		self->v.y=math_cos(v1.y);
		self->v.z=math_cos(v1.z);
	}
	else if(string_equals(op,"Tangent")){
		self->v.x=math_tan(v1.x);
		self->v.y=math_tan(v1.y);
		self->v.z=math_tan(v1.z);
	}
	if(from==0){
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._vec4=self->v});
		return v;
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._f32=f});
		return v;
	}
}

vector_node_t * vector_node_create(ui_node_t * raw,f32_array_t * args){
	vector_node_t * n=GC_ALLOC_INIT(vector_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=vector_node_get;
	n->base->get_as_image=vector_node_get_as_image;
	n->base->set=vector_node_set;
	n->value=vec4_create(0.0,0.0,0.0,1.0);
	if(args!=null){
		logic_node_add_input(n->base,float_node_create(null,f32_array_create_x(args->buffer[0])),0);
		logic_node_add_input(n->base,float_node_create(null,f32_array_create_x(args->buffer[1])),0);
		logic_node_add_input(n->base,float_node_create(null,f32_array_create_x(args->buffer[2])),0);
	}
	return n;
}

logic_node_value_t * vector_node_get(vector_node_t * self,i32 from){
	f32 x=logic_node_input_get(self->base->inputs->buffer[0])->_f32;
	f32 y=logic_node_input_get(self->base->inputs->buffer[1])->_f32;
	f32 z=logic_node_input_get(self->base->inputs->buffer[2])->_f32;
	self->value.x=x;
	self->value.y=y;
	self->value.z=z;
	logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._vec4=self->value});
	return v;
}

gpu_texture_t * vector_node_get_as_image(vector_node_t * self,i32 from){
	if(self->image!=null){
		iron_delete_texture(self->image);
	}
	buffer_t * b=buffer_create(16);
	float_node_t * n0=self->base->inputs->buffer[0]->node;
	float_node_t * n1=self->base->inputs->buffer[1]->node;
	float_node_t * n2=self->base->inputs->buffer[2]->node;
	buffer_set_f32(b,0,n0->value);
	buffer_set_f32(b,4,n1->value);
	buffer_set_f32(b,8,n2->value);
	buffer_set_f32(b,12,1.0);
	self->image=gpu_create_texture_from_bytes(b,1,1,tex_format_t_RGBA128);
	return self->image;
}

void vector_node_set(vector_node_t * self,f32_array_t * value){
	logic_node_input_set(self->base->inputs->buffer[0],f32_array_create_x(value->buffer[0]));
	logic_node_input_set(self->base->inputs->buffer[1],f32_array_create_x(value->buffer[1]));
	logic_node_input_set(self->base->inputs->buffer[2],f32_array_create_x(value->buffer[2]));
}

void base_ext_init(){
}

void base_ext_render(){
	if(context_raw->frame==2){
		util_render_make_material_preview();
		ui_base_hwnds->buffer[tab_area_t_SIDEBAR1]->redraws=2;
		base_init_undo_layers();
	}
}

void base_ext_init_config(config_t * raw){
}

void base_ext_update(){
}

void context_ext_init(context_t * c){
	c->tool=workspace_tool_t_BRUSH;
	c->color_picker_previous_tool=workspace_tool_t_BRUSH;
	c->brush_radius=0.5;
	c->brush_radius_handle->value=0.5;
	c->brush_hardness=0.8;
}

void context_ext_select_paint_object(mesh_object_t * o){
	ui_header_handle->redraws=2;
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		p->skip_context="paint";
	}
	context_raw->paint_object=o;
	i32 mask=slot_layer_get_object_mask(context_raw->layer);
	if(context_layer_filter_used()){
		mask=context_raw->layer_filter;
	}
	if(context_raw->merged_object==null||mask>0){
		context_raw->paint_object->skip_context="";
	}
	util_uv_uvmap_cached=false;
	util_uv_trianglemap_cached=false;
	util_uv_dilatemap_cached=false;
}

slot_layer_t * layers_ext_flatten(bool height_to_normal,slot_layer_t_array_t * layers){
	if(layers==null){
		layers=project_layers;
	}
	layers_make_temp_img();
	layers_make_export_img();
	render_target_t * empty_rt=any_map_get(render_path_render_targets,"empty_white");
	gpu_texture_t * empty=empty_rt->_image;
	_gpu_begin(layers_expa,null,null,clear_flag_t_COLOR,color_from_floats(0.0,0.0,0.0,0.0),0.0);
	gpu_end();
	_gpu_begin(layers_expb,null,null,clear_flag_t_COLOR,color_from_floats(0.5,0.5,1.0,0.0),0.0);
	gpu_end();
	_gpu_begin(layers_expc,null,null,clear_flag_t_COLOR,color_from_floats(1.0,0.0,0.0,0.0),0.0);
	gpu_end();
	for(i32 i=0;i<layers->length;++i){
		slot_layer_t * l1=layers->buffer[i];
		if(!slot_layer_is_visible(l1)){
			continue;
		}
		if(!slot_layer_is_layer(l1)){
			continue;
		}
		gpu_texture_t * mask=empty;
		slot_layer_t_array_t * l1masks=slot_layer_get_masks(l1,true);
		if(l1masks!=null){
			if(l1masks->length>1){
				layers_make_temp_mask_img();
				draw_begin(pipes_temp_mask_image,clear_flag_t_COLOR,0x00000000);
				draw_end();
				slot_layer_t * l1=GC_ALLOC_INIT(slot_layer_t, {.texpaint=pipes_temp_mask_image});
				for(i32 i=0;i<l1masks->length;++i){
					layers_merge_layer(l1,l1masks->buffer[i],false);
				}
				mask=pipes_temp_mask_image;
			}
			else {
				mask=l1masks->buffer[0]->texpaint;
			}
		}
		if(l1->paint_base){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(layers_expa,0,0);
			draw_set_pipeline(null);
			draw_end();
			_gpu_begin(layers_expa,null,null,clear_flag_t_NONE,0,0.0);
			gpu_set_pipeline(pipes_merge);
			gpu_set_texture(pipes_tex0,l1->texpaint);
			gpu_set_texture(pipes_tex1,empty);
			gpu_set_texture(pipes_texmask,mask);
			gpu_set_texture(pipes_texa,layers_temp_image);
			gpu_set_float(pipes_opac,slot_layer_get_opacity(l1));
			gpu_set_float(pipes_tex1w,empty->width);
			gpu_set_int(pipes_blending,layers->length>1?l1->blending:0);
			gpu_set_vertex_buffer(const_data_screen_aligned_vb);
			gpu_set_index_buffer(const_data_screen_aligned_ib);
			gpu_draw();
			gpu_end();
		}
		if(l1->paint_nor){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(layers_expb,0,0);
			draw_set_pipeline(null);
			draw_end();
			_gpu_begin(layers_expb,null,null,clear_flag_t_NONE,0,0.0);
			gpu_set_pipeline(pipes_merge);
			gpu_set_texture(pipes_tex0,l1->texpaint);
			gpu_set_texture(pipes_tex1,l1->texpaint_nor);
			gpu_set_texture(pipes_texmask,mask);
			gpu_set_texture(pipes_texa,layers_temp_image);
			gpu_set_float(pipes_opac,slot_layer_get_opacity(l1));
			gpu_set_float(pipes_tex1w,l1->texpaint_nor->width);
			gpu_set_int(pipes_blending,l1->paint_nor_blend?102:101);
			gpu_set_vertex_buffer(const_data_screen_aligned_vb);
			gpu_set_index_buffer(const_data_screen_aligned_ib);
			gpu_draw();
			gpu_end();
		}
		if(l1->paint_occ||l1->paint_rough||l1->paint_met||l1->paint_height){
			draw_begin(layers_temp_image,false,0);
			draw_set_pipeline(pipes_copy);
			draw_image(layers_expc,0,0);
			draw_set_pipeline(null);
			draw_end();
			if(l1->paint_occ&&l1->paint_rough&&l1->paint_met&&l1->paint_height){
				layers_commands_merge_pack(pipes_merge,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,l1->paint_height_blend?103:101);
			}
			else {
				if(l1->paint_occ){
					layers_commands_merge_pack(pipes_merge_r,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
				}
				if(l1->paint_rough){
					layers_commands_merge_pack(pipes_merge_g,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
				}
				if(l1->paint_met){
					layers_commands_merge_pack(pipes_merge_b,layers_expc,l1->texpaint,l1->texpaint_pack,slot_layer_get_opacity(l1),mask,101);
				}
			}
		}
	}
	slot_layer_t * l0=GC_ALLOC_INIT(slot_layer_t, {.texpaint=layers_expa,.texpaint_nor=layers_expb,.texpaint_pack=layers_expc});
	if(height_to_normal&&make_material_height_used){
		draw_begin(layers_temp_image,false,0);
		draw_set_pipeline(pipes_copy);
		draw_image(l0->texpaint_nor,0,0);
		draw_set_pipeline(null);
		draw_end();
		_gpu_begin(l0->texpaint_nor,null,null,clear_flag_t_NONE,0,0.0);
		gpu_set_pipeline(pipes_merge);
		gpu_set_texture(pipes_tex0,layers_temp_image);
		gpu_set_texture(pipes_tex1,l0->texpaint_pack);
		gpu_set_texture(pipes_texmask,empty);
		gpu_set_texture(pipes_texa,empty);
		gpu_set_float(pipes_opac,1.0);
		gpu_set_float(pipes_tex1w,l0->texpaint_pack->width);
		gpu_set_int(pipes_blending,104);
		gpu_set_vertex_buffer(const_data_screen_aligned_vb);
		gpu_set_index_buffer(const_data_screen_aligned_ib);
		gpu_draw();
		gpu_end();
	}
	return l0;
}

void layers_ext_on_resized(){
	sys_notify_on_init(&layers_ext_on_resized_226461	,null);
	gc_unroot(util_uv_uvmap);util_uv_uvmap=null;
	util_uv_uvmap_cached=false;
	gc_unroot(util_uv_trianglemap);util_uv_trianglemap=null;
	util_uv_trianglemap_cached=false;
	util_uv_dilatemap_cached=false;
	render_path_raytrace_ready=false;
}

void layers_ext_on_resized_226461(){
layers_resize();
	slot_layer_t * _layer=context_raw->layer;
	slot_material_t * _material=context_raw->material;
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		if(l->fill_layer!=null){
			context_raw->layer=l;
			context_raw->material=l->fill_layer;
			layers_update_fill_layer(true);
		}
	}
	context_raw->layer=_layer;
	context_raw->material=_material;
	make_material_parse_paint_material(true);
}

void make_bake_run(node_shader_context_t * con,node_shader_t * kong){
	if(context_raw->bake_type==bake_type_t_CURVATURE){
		bool pass=parser_material_bake_passthrough;
		string_t * strength=pass?parser_material_bake_passthrough_strength:string_join(f32_to_string(context_raw->bake_curv_strength),"");
		string_t * radius=pass?parser_material_bake_passthrough_radius:string_join(f32_to_string(context_raw->bake_curv_radius),"");
		string_t * offset=pass?parser_material_bake_passthrough_offset:string_join(f32_to_string(context_raw->bake_curv_offset),"");
		strength=string_join(string_join("float(",strength),")");
		radius=string_join(string_join("float(",radius),")");
		offset=string_join(string_join("float(",offset),")");
		kong->frag_n=true;
		node_shader_write_frag(kong,"var dx: float3 = ddx3(n);");
		node_shader_write_frag(kong,"var dy: float3 = ddy3(n);");
		node_shader_write_frag(kong,"var curvature: float = max(dot(dx, dx), dot(dy, dy));");
		node_shader_write_frag(kong,string_join(string_join(string_join(string_join(string_join(string_join("curvature = clamp(pow(curvature, (1.0 / ",radius),") * 0.25) * "),strength)," * 2.0 + "),offset)," / 10.0, 0.0, 1.0);"));
		if(context_raw->bake_axis!=bake_axis_t_XYZ){
			string_t * axis=make_bake_axis_string(context_raw->bake_axis);
			node_shader_write_frag(kong,string_join(string_join("curvature *= dot(n, ",axis),");"));
		}
		node_shader_write_frag(kong,"output[0] = float4(curvature, curvature, curvature, 1.0);");
	}
	else if(context_raw->bake_type==bake_type_t_NORMAL){
		kong->frag_n=true;
		node_shader_add_texture(kong,"texpaint_undo","_texpaint_undo");
		node_shader_write_frag(kong,"var n0: float3 = sample_lod(texpaint_undo, sampler_linear, tex_coord, 0.0).rgb * float3(2.0, 2.0, 2.0) - float3(1.0, 1.0, 1.0);");
		node_shader_add_function(kong,str_cotangent_frame);
		node_shader_add_function(kong,str_transpose);
		node_shader_write_frag(kong,"var invTBN: float3x3 = _transpose(cotangent_frame(n, n, tex_coord));");
		node_shader_write_frag(kong,"var res: float3 = normalize(invTBN * n0) * float3(0.5, 0.5, 0.5) + float3(0.5, 0.5, 0.5);");
		node_shader_write_frag(kong,"output[0] = float4(res, 1.0);");
	}
	else if(context_raw->bake_type==bake_type_t_NORMAL_OBJECT){
		kong->frag_n=true;
		node_shader_write_frag(kong,"output[0] = float4(n * float3(0.5, 0.5, 0.5) + float3(0.5, 0.5, 0.5), 1.0);");
		if(context_raw->bake_up_axis==bake_up_axis_t_Y){
			node_shader_write_frag(kong,"output[0].rgb = float3(output[0].r, output[0].b, 1.0 - output[0].g);");
		}
	}
	else if(context_raw->bake_type==bake_type_t_HEIGHT){
		kong->frag_wposition=true;
		node_shader_add_texture(kong,"texpaint_undo","_texpaint_undo");
		node_shader_write_frag(kong,"var wpos0: float3 = sample_lod(texpaint_undo, sampler_linear, tex_coord, 0.0).rgb * float3(2.0, 2.0, 2.0) - float3(1.0, 1.0, 1.0);");
		node_shader_write_frag(kong,"var res: float = distance(wpos0, input.wposition) * 10.0;");
		node_shader_write_frag(kong,"output[0] = float4(res, res, res, 1.0);");
	}
	else if(context_raw->bake_type==bake_type_t_DERIVATIVE){
		node_shader_add_texture(kong,"texpaint_undo","_texpaint_undo");
		node_shader_write_frag(kong,"var tex_dx: float2 = ddx2(tex_coord);");
		node_shader_write_frag(kong,"var tex_dy: float2 = ddy2(tex_coord);");
		node_shader_write_frag(kong,"var h0: float = sample_lod(texpaint_undo, sampler_linear, tex_coord, 0.0).r * 100;");
		node_shader_write_frag(kong,"var h1: float = sample_lod(texpaint_undo, sampler_linear, tex_coord + tex_dx, 0.0).r * 100;");
		node_shader_write_frag(kong,"var h2: float = sample_lod(texpaint_undo, sampler_linear, tex_coord + tex_dy, 0.0).r * 100;");
		node_shader_write_frag(kong,"output[0] = float4((h1 - h0) * 0.5 + 0.5, (h2 - h0) * 0.5 + 0.5, 0.0, 1.0);");
	}
	else if(context_raw->bake_type==bake_type_t_POSITION){
		kong->frag_wposition=true;
		node_shader_write_frag(kong,"output[0] = float4(input.wposition * float3(0.5, 0.5, 0.5) + float3(0.5, 0.5, 0.5), 1.0);");
		if(context_raw->bake_up_axis==bake_up_axis_t_Y){
			node_shader_write_frag(kong,"output[0].rgb = float3(output[0].r, output[0].b, 1.0 - output[0].g);");
		}
	}
	else if(context_raw->bake_type==bake_type_t_TEXCOORD){
		node_shader_write_frag(kong,"output[0] = float4(tex_coord.xy, 0.0, 1.0);");
	}
	else if(context_raw->bake_type==bake_type_t_MATERIALID){
		node_shader_add_texture(kong,"texpaint_nor_undo","_texpaint_nor_undo");
		node_shader_write_frag(kong,"var sample_matid: float = sample_lod(texpaint_nor_undo, sampler_linear, tex_coord, 0.0).a + 1.0 / 255.0;");
		node_shader_write_frag(kong,"var matid_r: float = frac(sin(dot(float2(sample_matid, sample_matid * 20.0), float2(12.9898, 78.233))) * 43758.5453);");
		node_shader_write_frag(kong,"var matid_g: float = frac(sin(dot(float2(sample_matid * 20.0, sample_matid), float2(12.9898, 78.233))) * 43758.5453);");
		node_shader_write_frag(kong,"var matid_b: float = frac(sin(dot(float2(sample_matid, sample_matid * 40.0), float2(12.9898, 78.233))) * 43758.5453);");
		node_shader_write_frag(kong,"output[0] = float4(matid_r, matid_g, matid_b, 1.0);");
	}
	else if(context_raw->bake_type==bake_type_t_OBJECTID){
		node_shader_add_constant(kong,"object_id: float","_object_id");
		node_shader_write_frag(kong,"var obid: float = constants.object_id + 1.0 / 255.0;");
		node_shader_write_frag(kong,"var id_r: float = frac(sin(dot(float2(obid, obid * 20.0), float2(12.9898, 78.233))) * 43758.5453);");
		node_shader_write_frag(kong,"var id_g: float = frac(sin(dot(float2(obid * 20.0, obid), float2(12.9898, 78.233))) * 43758.5453);");
		node_shader_write_frag(kong,"var id_b: float = frac(sin(dot(float2(obid, obid * 40.0), float2(12.9898, 78.233))) * 43758.5453);");
		node_shader_write_frag(kong,"output[0] = float4(id_r, id_g, id_b, 1.0);");
	}
	else if(context_raw->bake_type==bake_type_t_VERTEX_COLOR){
		if(con->allow_vcols){
			node_shader_context_add_elem(con,"col","short4norm");
			node_shader_write_frag(kong,"output[0] = float4(vcolor.r, vcolor.g, vcolor.b, 1.0);");
		}
		else {
			node_shader_write_frag(kong,"output[0] = float4(1.0, 1.0, 1.0, 1.0);");
		}
	}
}

void make_bake_position_normal(node_shader_t * kong){
	node_shader_add_out(kong,"position: float3");
	node_shader_add_out(kong,"normal: float3");
	node_shader_add_constant(kong,"W: float4x4","_world_matrix");
	node_shader_write_vert(kong,"output.position = (constants.W * float4(input.pos.xyz, 1.0)).xyz;");
	node_shader_write_vert(kong,"output.normal = float3(input.nor.xy, input.pos.w);");
	node_shader_write_vert(kong,"var tpos: float2 = float2(input.tex.x * 2.0 - 1.0, (1.0 - input.tex.y) * 2.0 - 1.0);");
	node_shader_write_vert(kong,"output.pos = float4(tpos, 0.0, 1.0);");
	kong->frag_out="float4[2]";
	node_shader_write_frag(kong,"output[0] = float4(input.position, 1.0);");
	node_shader_write_frag(kong,"output[1] = float4(input.normal, 1.0);");
}

void make_bake_set_color_writes(node_shader_context_t * con_paint){
	con_paint->data->color_writes_red->buffer[1]=false;
	con_paint->data->color_writes_green->buffer[1]=false;
	con_paint->data->color_writes_blue->buffer[1]=false;
	con_paint->data->color_writes_alpha->buffer[1]=false;
	con_paint->data->color_writes_red->buffer[2]=false;
	con_paint->data->color_writes_green->buffer[2]=false;
	con_paint->data->color_writes_blue->buffer[2]=false;
	con_paint->data->color_writes_alpha->buffer[2]=false;
}

string_t * make_bake_axis_string(i32 i){
	return i==bake_axis_t_X?"float3(1,0,0)":i==bake_axis_t_Y?"float3(0,1,0)":i==bake_axis_t_Z?"float3(0,0,1)":i==bake_axis_t_MX?"float3(-1,0,0)":i==bake_axis_t_MY?"float3(0,-1,0)":"float3(0,0,-1)";
}

void make_blur_run(node_shader_t * kong){
	node_shader_write_frag(kong,"var tex_coord_inp4: float4 = gbuffer2[uint2(uint(sp.x * constants.gbuffer_size.x), uint(sp.y * constants.gbuffer_size.y))];");
	node_shader_write_frag(kong,"var tex_coord_inp: float2 = tex_coord_inp4.ba;");
	node_shader_write_frag(kong,"var basecol: float3 = float3(0.0, 0.0, 0.0);");
	node_shader_write_frag(kong,"var roughness: float = 0.0;");
	node_shader_write_frag(kong,"var metallic: float = 0.0;");
	node_shader_write_frag(kong,"var occlusion: float = 0.0;");
	node_shader_write_frag(kong,"var nortan: float3 = float3(0.0, 0.0, 0.0);");
	node_shader_write_frag(kong,"var height: float = 0.0;");
	node_shader_write_frag(kong,"var mat_opacity: float = 1.0;");
	bool is_mask=slot_layer_is_mask(context_raw->layer);
	if(is_mask){
		node_shader_write_frag(kong,"var opacity: float = 1.0;");
	}
	else {
		node_shader_write_frag(kong,"var opacity: float = 0.0;");
	}
	if(context_raw->material->paint_emis){
		node_shader_write_frag(kong,"var emis: float = 0.0;");
	}
	if(context_raw->material->paint_subs){
		node_shader_write_frag(kong,"var subs: float = 0.0;");
	}
	node_shader_add_constant(kong,"texpaint_size: float2","_texpaint_size");
	node_shader_write_frag(kong,"var blur_step: float = 1.0 / constants.texpaint_size.x;");
	if(context_raw->tool==workspace_tool_t_SMUDGE){
		node_shader_add_function(kong,str_get_smudge_tool_weight);
		node_shader_add_constant(kong,"brush_direction: float3","_brush_direction");
		node_shader_write_frag(kong,"var blur_direction: float2 = constants.brush_direction.yx;");
		node_shader_write_frag(kong,"for (var i: int = 0; i < 7; i += 1) {");
		node_shader_write_frag(kong,"var tex_coord_inp24: float4 = gbuffer2[uint2(uint((sp.x + blur_direction.x * blur_step * float(i)) * constants.gbuffer_size.x), uint((sp.y + blur_direction.y * blur_step * float(i)) * constants.gbuffer_size.y))];");
		node_shader_write_frag(kong,"var tex_coord_inp2: float2 = tex_coord_inp24.ba;");
		node_shader_write_frag(kong,"var texpaint_sample: float4 = sample(texpaint_undo, sampler_linear, tex_coord_inp2);");
		node_shader_write_frag(kong,"var blur_weight_i: float = get_smudge_tool_weight(i);");
		node_shader_write_frag(kong,"opacity += texpaint_sample.a * blur_weight_i;");
		node_shader_write_frag(kong,"basecol += texpaint_sample.rgb * blur_weight_i;");
		node_shader_write_frag(kong,"var texpaint_pack_sample: float4 = sample(texpaint_pack_undo, sampler_linear, tex_coord_inp2) * blur_weight_i;");
		node_shader_write_frag(kong,"roughness += texpaint_pack_sample.g;");
		node_shader_write_frag(kong,"metallic += texpaint_pack_sample.b;");
		node_shader_write_frag(kong,"occlusion += texpaint_pack_sample.r;");
		node_shader_write_frag(kong,"height += texpaint_pack_sample.a;");
		node_shader_write_frag(kong,"nortan += sample(texpaint_nor_undo, sampler_linear, tex_coord_inp2).rgb * blur_weight_i;");
		node_shader_write_frag(kong,"}");
	}
	else {
		node_shader_add_function(kong,str_get_blur_tool_weight);
		node_shader_write_frag(kong,"for (var i: int = 0; i <= 14; i += 1) {");
		node_shader_write_frag(kong,"var texpaint_sample: float4 = sample(texpaint_undo, sampler_linear, tex_coord_inp + float2(blur_step * float(i - 7), 0.0));");
		node_shader_write_frag(kong,"var blur_weight_i: float = get_blur_tool_weight(i);");
		node_shader_write_frag(kong,"opacity += texpaint_sample.a * blur_weight_i;");
		node_shader_write_frag(kong,"basecol += texpaint_sample.rgb * blur_weight_i;");
		node_shader_write_frag(kong,"var texpaint_pack_sample: float4 = sample(texpaint_pack_undo, sampler_linear, tex_coord_inp + float2(blur_step * float(i - 7), 0.0)) * blur_weight_i;");
		node_shader_write_frag(kong,"roughness += texpaint_pack_sample.g;");
		node_shader_write_frag(kong,"metallic += texpaint_pack_sample.b;");
		node_shader_write_frag(kong,"occlusion += texpaint_pack_sample.r;");
		node_shader_write_frag(kong,"height += texpaint_pack_sample.a;");
		node_shader_write_frag(kong,"nortan += sample(texpaint_nor_undo, sampler_linear, tex_coord_inp + float2(blur_step * float(i - 7), 0.0)).rgb * blur_weight_i;");
		node_shader_write_frag(kong,"}");
		node_shader_write_frag(kong,"for (var j: int = 0; j <= 14; j += 1) {");
		node_shader_write_frag(kong,"var texpaint_sample: float4 = sample(texpaint_undo, sampler_linear, tex_coord_inp + float2(0.0, blur_step * float(j - 7)));");
		node_shader_write_frag(kong,"var blur_weight_j: float = get_blur_tool_weight(j);");
		node_shader_write_frag(kong,"opacity += texpaint_sample.a * blur_weight_j;");
		node_shader_write_frag(kong,"basecol += texpaint_sample.rgb * blur_weight_j;");
		node_shader_write_frag(kong,"var texpaint_pack_sample: float4 = sample(texpaint_pack_undo, sampler_linear, tex_coord_inp + float2(0.0, blur_step * float(j - 7))) * blur_weight_j;");
		node_shader_write_frag(kong,"roughness += texpaint_pack_sample.g;");
		node_shader_write_frag(kong,"metallic += texpaint_pack_sample.b;");
		node_shader_write_frag(kong,"occlusion += texpaint_pack_sample.r;");
		node_shader_write_frag(kong,"height += texpaint_pack_sample.a;");
		node_shader_write_frag(kong,"nortan += sample(texpaint_nor_undo, sampler_linear, tex_coord_inp + float2(0.0, blur_step * float(j - 7))).rgb * blur_weight_j;");
		node_shader_write_frag(kong,"}");
	}
	node_shader_write_frag(kong,"opacity *= constants.brush_opacity;");
}

void make_brush_run(node_shader_t * kong){
	node_shader_write_frag(kong,"var dist: float = 0.0;");
	if(context_raw->tool==workspace_tool_t_PARTICLE){
		return ;
	}
	bool fill_layer=context_raw->layer->fill_layer!=null;
	bool decal=context_is_decal();
	if(decal&&!fill_layer){
		node_shader_write_frag(kong,"if (constants.decal_mask.z > 0.0) {");
	}
	if(config_raw->brush_3d){
		node_shader_write_frag(kong,"var depth: float = sample_lod(gbufferD, sampler_linear, constants.inp.xy, 0.0).r;");
		node_shader_add_constant(kong,"invVP: float4x4","_inv_view_proj_matrix");
		node_shader_write_frag(kong,"var winp: float4 = float4(float2(constants.inp.x, 1.0 - constants.inp.y) * 2.0 - 1.0, depth * 2.0 - 1.0, 1.0);");
		node_shader_write_frag(kong,"winp = constants.invVP * winp;");
		node_shader_write_frag(kong,"winp.xyz = winp.xyz / winp.w;");
		kong->frag_wposition=true;
		if(config_raw->brush_angle_reject||context_raw->xray){
			node_shader_add_function(kong,str_octahedron_wrap);
			node_shader_add_texture(kong,"gbuffer0",null);
			node_shader_write_frag(kong,"var g0: float2 = sample_lod(gbuffer0, sampler_linear, constants.inp.xy, 0.0).rg;");
			node_shader_write_frag(kong,"var wn: float3;");
			node_shader_write_frag(kong,"wn.z = 1.0 - abs(g0.x) - abs(g0.y);");
			node_shader_write_frag(kong,"if (wn.z >= 0.0) { wn.x = g0.x; wn.y = g0.y; } else { var f2: float2 = octahedron_wrap(g0.xy); wn.x = f2.x; wn.y = f2.y; }");
			node_shader_write_frag(kong,"wn = normalize(wn);");
			node_shader_write_frag(kong,"var plane_dist: float = dot(wn, winp.xyz - input.wposition);");
			if(config_raw->brush_angle_reject&&!context_raw->xray){
				node_shader_write_frag(kong,"if (plane_dist < -0.01 && constants.inp.w == 0.0) { discard; }");
				kong->frag_n=true;
				f32 angle=context_raw->brush_angle_reject_dot;
				node_shader_write_frag(kong,string_join(string_join("if (dot(wn, n) < ",f32_to_string(angle))," && constants.inp.w == 0.0) { discard; }"));
			}
		}
		node_shader_write_frag(kong,"var depthlast: float = sample_lod(gbufferD, sampler_linear, constants.inplast.xy, 0.0).r;");
		node_shader_write_frag(kong,"var winplast: float4 = float4(float2(constants.inplast.x, 1.0 - constants.inplast.y) * 2.0 - 1.0, depthlast * 2.0 - 1.0, 1.0);");
		node_shader_write_frag(kong,"winplast = constants.invVP * winplast;");
		node_shader_write_frag(kong,"winplast.xyz = winplast.xyz / winplast.w;");
		node_shader_write_frag(kong,"var pa: float3 = input.wposition - winp.xyz;");
		if(context_raw->xray){
			node_shader_write_frag(kong,"pa += wn * float3(plane_dist, plane_dist, plane_dist);");
		}
		node_shader_write_frag(kong,"var ba: float3 = winplast.xyz - winp.xyz;");
		if(context_raw->brush_lazy_radius>0&&context_raw->brush_lazy_step>0){
			node_shader_write_frag(kong,"dist = distance(input.wposition, winp.xyz);");
		}
		else {
			node_shader_write_frag(kong,"var h: float = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);");
			node_shader_write_frag(kong,"dist = length(pa - ba * h);");
		}
	}
	else {
		node_shader_write_frag(kong,"var binp: float2 = constants.inp.xy * 2.0 - 1.0;");
		node_shader_write_frag(kong,"binp.x *= constants.aspect_ratio;");
		node_shader_write_frag(kong,"binp = binp * 0.5 + 0.5;");
		node_shader_write_frag(kong,"var binplast: float2 = constants.inplast.xy * 2.0 - 1.0;");
		node_shader_write_frag(kong,"binplast.x *= constants.aspect_ratio;");
		node_shader_write_frag(kong,"binplast = binplast * 0.5 + 0.5;");
		node_shader_write_frag(kong,"var pa: float2 = bsp.xy - binp.xy;");
		node_shader_write_frag(kong,"var ba: float2 = binplast.xy - binp.xy;");
		node_shader_write_frag(kong,"var h: float = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);");
		node_shader_write_frag(kong,"dist = length(pa - ba * h);");
	}
	node_shader_write_frag(kong,"if (dist > constants.brush_radius) { discard; }");
	if(decal&&!fill_layer){
		node_shader_write_frag(kong,"}");
	}
}

void make_clone_run(node_shader_t * kong){
	node_shader_add_constant(kong,"clone_delta: float2","_clone_delta");
	node_shader_write_frag(kong,"var tex_coord_coord: uint2 = uint2(uint((sp.x + constants.clone_delta.x) * constants.gbuffer_size.x), uint((sp.y + constants.clone_delta.y) * constants.gbuffer_size.y));");
	node_shader_write_frag(kong,"var tex_coord_inp4: float4 = gbuffer2[tex_coord_coord];");
	node_shader_write_frag(kong,"var tex_coord_inp: float2 = tex_coord_inp4.ba;");
	node_shader_write_frag(kong,"var texpaint_pack_sample: float3 = sample_lod(texpaint_pack_undo, sampler_linear, tex_coord_inp, 0.0).rgb;");
	string_t * base="sample_lod(texpaint_undo, sampler_linear, tex_coord_inp, 0.0).rgb";
	string_t * rough="texpaint_pack_sample.g";
	string_t * met="texpaint_pack_sample.b";
	string_t * occ="texpaint_pack_sample.r";
	string_t * nortan="sample_lod(texpaint_nor_undo, sampler_linear, tex_coord_inp, 0.0).rgb";
	string_t * height="0.0";
	string_t * opac="1.0";
	node_shader_write_frag(kong,string_join(string_join("var basecol: float3 = ",base),";"));
	node_shader_write_frag(kong,string_join(string_join("var roughness: float = ",rough),";"));
	node_shader_write_frag(kong,string_join(string_join("var metallic: float = ",met),";"));
	node_shader_write_frag(kong,string_join(string_join("var occlusion: float = ",occ),";"));
	node_shader_write_frag(kong,string_join(string_join("var nortan: float3 = ",nortan),";"));
	node_shader_write_frag(kong,string_join(string_join("var height: float = ",height),";"));
	node_shader_write_frag(kong,string_join(string_join("var mat_opacity: float = ",opac),";"));
	node_shader_write_frag(kong,"var opacity: float = mat_opacity * constants.brush_opacity;");
	if(context_raw->material->paint_emis){
		node_shader_write_frag(kong,"var emis: float = 0.0;");
	}
	if(context_raw->material->paint_subs){
		node_shader_write_frag(kong,"var subs: float = 0.0;");
	}
}

void make_colorid_picker_run(node_shader_t * kong){
	node_shader_write_vert(kong,"output.pos = float4(-1.0 + float((vertex_id() & 1) << 2), -1.0 + float((vertex_id() & 2) << 1), 0.0, 1.0);");
	node_shader_add_texture(kong,"gbuffer2",null);
	node_shader_add_constant(kong,"gbuffer_size: float2","_gbuffer_size");
	node_shader_add_constant(kong,"inp: float4","_input_brush");
	node_shader_write_frag(kong,"var tex_coord_inp4: float4 = gbuffer2[uint2(uint(constants.inp.x * constants.gbuffer_size.x), uint(constants.inp.y * constants.gbuffer_size.y))];");
	node_shader_write_frag(kong,"var tex_coord_inp: float2 = tex_coord_inp4.ba;");
	if(context_raw->tool==workspace_tool_t_COLORID){
		kong->frag_out="float4";
		node_shader_add_texture(kong,"texcolorid","_texcolorid");
		node_shader_write_frag(kong,"var idcol: float3 = sample_lod(texcolorid, sampler_linear, tex_coord_inp, 0.0).rgb;");
		node_shader_write_frag(kong,"output = float4(idcol, 1.0);");
	}
	else if(context_raw->tool==workspace_tool_t_PICKER||context_raw->tool==workspace_tool_t_MATERIAL){
		if(context_raw->pick_pos_nor_tex){
			kong->frag_out="float4[2]";
			node_shader_add_texture(kong,"gbufferD",null);
			node_shader_add_constant(kong,"invVP: float4x4","_inv_view_proj_matrix");
			node_shader_add_function(kong,str_get_pos_nor_from_depth);
			node_shader_write_frag(kong,"output[0] = float4(get_pos_from_depth(float2(constants.inp.x, 1.0 - constants.inp.y), constants.invVP), tex_coord_inp.x);");
			node_shader_write_frag(kong,"output[1] = float4(get_nor_from_depth(output[0].rgb, float2(constants.inp.x, 1.0 - constants.inp.y), constants.invVP, float2(1.0, 1.0) / constants.gbuffer_size), tex_coord_inp.y);");
		}
		else {
			kong->frag_out="float4[4]";
			node_shader_add_texture(kong,"texpaint",null);
			node_shader_add_texture(kong,"texpaint_nor",null);
			node_shader_add_texture(kong,"texpaint_pack",null);
			node_shader_write_frag(kong,"output[0] = sample_lod(texpaint, sampler_linear, tex_coord_inp, 0.0);");
			node_shader_write_frag(kong,"output[1] = sample_lod(texpaint_nor, sampler_linear, tex_coord_inp, 0.0);");
			node_shader_write_frag(kong,"output[2] = sample_lod(texpaint_pack, sampler_linear, tex_coord_inp, 0.0);");
			node_shader_write_frag(kong,"output[3].rg = tex_coord_inp.xy;");
		}
	}
}

void make_discard_color_id(node_shader_t * kong){
	node_shader_add_texture(kong,"texpaint_colorid",null);
	node_shader_add_texture(kong,"texcolorid","_texcolorid");
	node_shader_write_frag(kong,"var colorid_c14: float4 = texpaint_colorid[uint2(uint(0), uint(0))];");
	node_shader_write_frag(kong,"var colorid_c1: float3 = colorid_c14.rgb;");
	node_shader_write_frag(kong,"var colorid_c2: float3 = sample_lod(texcolorid, sampler_linear, input.tex_coord_pick, 0.0).rgb;");
	node_shader_write_frag(kong,"if (colorid_c1.r != colorid_c2.r || colorid_c1.g != colorid_c2.g || colorid_c1.b != colorid_c2.b) { discard; }");
}

void make_discard_face(node_shader_t * kong){
	node_shader_add_texture(kong,"gbuffer2",null);
	node_shader_add_texture(kong,"textrianglemap","_textrianglemap");
	node_shader_add_constant(kong,"textrianglemap_size: float2","_texpaint_size");
	node_shader_add_constant(kong,"gbuffer_size: float2","_gbuffer_size");
	node_shader_write_frag(kong,"var tex_coord_inp4: float4 = gbuffer2[uint2(uint(inp.x * constants.gbuffer_size.x), uint(inp.y * constants.gbuffer_size.y))];");
	node_shader_write_frag(kong,"var tex_coord_inp: float2 = tex_coord_inp4.ba;");
	node_shader_write_frag(kong,"var face_c1: float4 = textrianglemap[uint2(uint(tex_coord_inp.x * constants.textrianglemap_size.x), uint(tex_coord_inp.y * constants.textrianglemap_size.y))];");
	node_shader_write_frag(kong,"var face_c2: float4 = sample_lod(textrianglemap, sampler_linear, input.tex_coord_pick, 0.0);");
	node_shader_write_frag(kong,"if (face_c1.x != face_c2.x || face_c1.y != face_c2.y || face_c1.z != face_c2.z || face_c1.w != face_c2.w) { discard; }");
}

void make_discard_uv_island(node_shader_t * kong){
	node_shader_add_texture(kong,"texuvislandmap","_texuvislandmap");
	node_shader_write_frag(kong,"if (sample_lod(texuvislandmap, sampler_linear, input.tex_coord_pick, 0.0).r == 0.0) { discard; }");
}

void make_discard_material_id(node_shader_t * kong){
	kong->frag_wvpposition=true;
	node_shader_write_frag(kong,"var picker_sample_tc: float2 = float2(input.wvpposition.x / input.wvpposition.w, input.wvpposition.y / input.wvpposition.w) * 0.5 + 0.5;");
	node_shader_write_frag(kong,"picker_sample_tc.y = 1.0 - picker_sample_tc.y;");
	node_shader_add_texture(kong,"texpaint_nor_undo","_texpaint_nor_undo");
	i32 matid=context_raw->materialid_picked/(float)255;
	node_shader_write_frag(kong,string_join(string_join("if (",i32_to_string(matid))," != sample_lod(texpaint_nor_undo, sampler_linear, picker_sample_tc, 0.0).a) { discard; }"));
}

bool make_material_get_mout(){
	for(i32 i=0;i<ui_nodes_get_canvas_material()->nodes->length;++i){
		ui_node_t * n=ui_nodes_get_canvas_material()->nodes->buffer[i];
		if(string_equals(n->type,"OUTPUT_MATERIAL_PBR")){
			return true;
		}
	}
	return false;
}

void make_material_parse_mesh_material(){
	material_data_t * m=project_materials->buffer[0]->data;
	for(i32 i=0;i<m->_->shader->_->contexts->length;++i){
		shader_context_t * c=m->_->shader->_->contexts->buffer[i];
		if(string_equals(c->name,"mesh")){
			array_remove(m->_->shader->contexts,c);
			array_remove(m->_->shader->_->contexts,c);
			make_material_delete_context(c);
			break;
		}
	}
	if(make_mesh_layer_pass_count>1){
		i32 i=0;
		while(i<m->_->shader->_->contexts->length){
			shader_context_t * c=m->_->shader->_->contexts->buffer[i];
			for(i32 j=1;j<make_mesh_layer_pass_count;++j){
				string_t * name=string_join("mesh",i32_to_string(j));
				if(string_equals(c->name,name)){
					array_remove(m->_->shader->contexts,c);
					array_remove(m->_->shader->_->contexts,c);
					make_material_delete_context(c);
					i--;
					break;
				}
			}
			i++;
		}
		i=0;
		while(i<m->_->contexts->length){
			material_context_t * c=m->_->contexts->buffer[i];
			for(i32 j=1;j<make_mesh_layer_pass_count;++j){
				string_t * name=string_join("mesh",i32_to_string(j));
				if(string_equals(c->name,name)){
					array_remove(m->contexts,c);
					array_remove(m->_->contexts,c);
					i--;
					break;
				}
			}
			i++;
		}
	}
	material_t * mm=GC_ALLOC_INIT(material_t, {.name="Material",.canvas=null});
	node_shader_context_t * con=make_mesh_run(mm,0);
	shader_context_t * scon=shader_context_create(con->data);
	any_array_push(m->_->shader->contexts,scon);
	any_array_push(m->_->shader->_->contexts,scon);
	for(i32 i=1;i<make_mesh_layer_pass_count;++i){
		material_t * mm=GC_ALLOC_INIT(material_t, {.name="Material",.canvas=null});
		node_shader_context_t * con=make_mesh_run(mm,i);
		shader_context_t * scon=shader_context_create(con->data);
		any_array_push(m->_->shader->contexts,scon);
		any_array_push(m->_->shader->_->contexts,scon);
		material_context_t * mcon;
		material_context_t * mmcon=GC_ALLOC_INIT(material_context_t, {.name=string_join("mesh",i32_to_string(i)),.bind_textures=any_array_create_from_raw((any[]){},0)});
		mcon=material_context_create(mmcon);
		any_array_push(m->contexts,mcon);
		any_array_push(m->_->contexts,mcon);
	}
	context_raw->ddirty=2;
	render_path_raytrace_dirty=1;
}

void make_material_parse_mesh_preview_material(material_data_t * md){
	if(!make_material_get_mout()){
		return ;
	}
	material_data_t * m=md==null?project_materials->buffer[0]->data:md;
	shader_context_t * scon=null;
	for(i32 i=0;i<m->_->shader->_->contexts->length;++i){
		shader_context_t * c=m->_->shader->_->contexts->buffer[i];
		if(string_equals(c->name,"mesh")){
			scon=c;
			break;
		}
	}
	array_remove(m->_->shader->contexts,scon);
	array_remove(m->_->shader->_->contexts,scon);
	material_context_t * mcon=GC_ALLOC_INIT(material_context_t, {.name="mesh",.bind_textures=any_array_create_from_raw((any[]){},0)});
	material_t * sd=GC_ALLOC_INIT(material_t, {.name="Material",.canvas=null});
	node_shader_context_t * con=make_mesh_preview_run(sd,mcon);
	for(i32 i=0;i<m->_->contexts->length;++i){
		if(string_equals(m->_->contexts->buffer[i]->name,"mesh")){
			m->_->contexts->buffer[i]=material_context_create(mcon);
			break;
		}
	}
	if(scon!=null){
		make_material_delete_context(scon);
	}
	bool compile_error=false;
	shader_context_t * _scon=shader_context_create(con->data);
	if(_scon==null){
		compile_error=true;
	}
	scon=_scon;
	if(compile_error){
		return ;
	}
	any_array_push(m->_->shader->contexts,scon);
	any_array_push(m->_->shader->_->contexts,scon);
}

void make_material_parse_paint_material(bool bake_previews){
	if(!make_material_get_mout()){
		return ;
	}
	if(bake_previews){
		gpu_texture_t * current=_draw_current;
		bool in_use=gpu_in_use;
		if(in_use)draw_end();
		make_material_bake_node_previews();
		if(in_use)draw_begin(current,false,0);
	}
	material_data_t * m=project_materials->buffer[0]->data;
	for(i32 i=0;i<m->_->shader->_->contexts->length;++i){
		shader_context_t * c=m->_->shader->_->contexts->buffer[i];
		if(string_equals(c->name,"paint")){
			array_remove(m->_->shader->contexts,c);
			array_remove(m->_->shader->_->contexts,c);
			if(c!=make_material_default_scon){
				make_material_delete_context(c);
			}
			break;
		}
	}
	for(i32 i=0;i<m->_->contexts->length;++i){
		material_context_t * c=m->_->contexts->buffer[i];
		if(string_equals(c->name,"paint")){
			array_remove(m->contexts,c);
			array_remove(m->_->contexts,c);
			break;
		}
	}
	material_t * sdata=GC_ALLOC_INIT(material_t, {.name="Material",.canvas=ui_nodes_get_canvas_material()});
	material_context_t * tmcon=GC_ALLOC_INIT(material_context_t, {.name="paint",.bind_textures=any_array_create_from_raw((any[]){},0)});
	node_shader_context_t * con=make_paint_run(sdata,tmcon);
	bool compile_error=false;
	shader_context_t * scon;
	shader_context_t * _scon=shader_context_create(con->data);
	if(_scon==null){
		compile_error=true;
	}
	scon=_scon;
	if(compile_error){
		return ;
	}
	material_context_t * mcon=material_context_create(tmcon);
	any_array_push(m->_->shader->contexts,scon);
	any_array_push(m->_->shader->_->contexts,scon);
	any_array_push(m->contexts,mcon);
	any_array_push(m->_->contexts,mcon);
	if(make_material_default_scon==null){
		gc_unroot(make_material_default_scon);make_material_default_scon=scon;gc_root(make_material_default_scon);
	}
	if(make_material_default_mcon==null){
		gc_unroot(make_material_default_mcon);make_material_default_mcon=mcon;gc_root(make_material_default_mcon);
	}
}

void make_material_bake_node_previews(){
	context_raw->node_previews_used=any_array_create_from_raw((any[]){},0);
	if(context_raw->node_previews==null){
		context_raw->node_previews=any_map_create();
	}
	ui_node_t_array_t * empty=any_array_create_from_raw((any[]){},0);
	make_material_traverse_nodes(ui_nodes_get_canvas_material()->nodes,null,empty);
	string_t_array_t * keys=map_keys(context_raw->node_previews);
	for(i32 i=0;i<keys->length;++i){
		string_t * key=keys->buffer[i];
		if(char_ptr_array_index_of(context_raw->node_previews_used,key)==-1){
			gpu_texture_t * image=any_map_get(context_raw->node_previews,key);
			iron_delete_texture(image);
			map_delete(context_raw->node_previews,key);
		}
	}
}

void make_material_traverse_nodes(ui_node_t_array_t * nodes,ui_node_canvas_t * group,ui_node_t_array_t * parents){
	for(i32 i=0;i<nodes->length;++i){
		ui_node_t * node=nodes->buffer[i];
		make_material_bake_node_preview(node,group,parents);
		if(string_equals(node->type,"GROUP")){
			for(i32 j=0;j<project_material_groups->length;++j){
				node_group_t * g=project_material_groups->buffer[j];
				string_t * cname=g->canvas->name;
				if(string_equals(cname,node->name)){
					any_array_push(parents,node);
					make_material_traverse_nodes(g->canvas->nodes,g->canvas,parents);
					array_pop(parents);
					break;
				}
			}
		}
	}
}

void make_material_bake_node_preview(ui_node_t * node,ui_node_canvas_t * group,ui_node_t_array_t * parents){
	if(string_equals(node->type,"BLUR")){
		string_t * id=parser_material_node_name(node,parents);
		gpu_texture_t * image=any_map_get(context_raw->node_previews,id);
		any_array_push(context_raw->node_previews_used,id);
		i32 res_x=math_floor(config_get_texture_res_x()/(float)4);
		i32 res_y=math_floor(config_get_texture_res_y()/(float)4);
		if(image==null||image->width!=res_x||image->height!=res_y){
			if(image!=null){
				iron_delete_texture(image);
			}
			image=gpu_create_render_target(res_x,res_y,tex_format_t_RGBA32);
			any_map_set(context_raw->node_previews,id,image);
		}
		parser_material_blur_passthrough=true;
		util_render_make_node_preview(ui_nodes_get_canvas_material(),node,image,group,parents);
		parser_material_blur_passthrough=false;
	}
	else if(string_equals(node->type,"DIRECT_WARP")){
		string_t * id=parser_material_node_name(node,parents);
		gpu_texture_t * image=any_map_get(context_raw->node_previews,id);
		any_array_push(context_raw->node_previews_used,id);
		i32 res_x=math_floor(config_get_texture_res_x());
		i32 res_y=math_floor(config_get_texture_res_y());
		if(image==null||image->width!=res_x||image->height!=res_y){
			if(image!=null){
				iron_delete_texture(image);
			}
			image=gpu_create_render_target(res_x,res_y,tex_format_t_RGBA32);
			any_map_set(context_raw->node_previews,id,image);
		}
		parser_material_warp_passthrough=true;
		util_render_make_node_preview(ui_nodes_get_canvas_material(),node,image,group,parents);
		parser_material_warp_passthrough=false;
	}
	else if(string_equals(node->type,"BAKE_CURVATURE")){
		string_t * id=parser_material_node_name(node,parents);
		gpu_texture_t * image=any_map_get(context_raw->node_previews,id);
		any_array_push(context_raw->node_previews_used,id);
		i32 res_x=math_floor(config_get_texture_res_x());
		i32 res_y=math_floor(config_get_texture_res_y());
		if(image==null||image->width!=res_x||image->height!=res_y){
			if(image!=null){
				iron_delete_texture(image);
			}
			image=gpu_create_render_target(res_x,res_y,tex_format_t_R8);
			any_map_set(context_raw->node_previews,id,image);
		}
		if(render_path_paint_live_layer==null){
			gc_unroot(render_path_paint_live_layer);render_path_paint_live_layer=slot_layer_create("_live",layer_slot_type_t_LAYER,null);gc_root(render_path_paint_live_layer);
		}
		i32 _space=ui_header_worktab->position;
		workspace_tool_t _tool=context_raw->tool;
		bake_type_t _bake_type=context_raw->bake_type;
		ui_header_worktab->position=space_type_t_SPACE3D;
		context_raw->tool=workspace_tool_t_BAKE;
		context_raw->bake_type=bake_type_t_CURVATURE;
		parser_material_bake_passthrough=true;
		gc_unroot(parser_material_start_node);parser_material_start_node=node;gc_root(parser_material_start_node);
		gc_unroot(parser_material_start_group);parser_material_start_group=group;gc_root(parser_material_start_group);
		gc_unroot(parser_material_start_parents);parser_material_start_parents=parents;gc_root(parser_material_start_parents);
		make_material_parse_paint_material(false);
		parser_material_bake_passthrough=false;
		gc_unroot(parser_material_start_node);parser_material_start_node=null;
		gc_unroot(parser_material_start_group);parser_material_start_group=null;
		gc_unroot(parser_material_start_parents);parser_material_start_parents=null;
		context_raw->pdirty=1;
		render_path_paint_use_live_layer(true);
		render_path_paint_commands_paint(false);
		render_path_paint_dilate(true,false);
		render_path_paint_use_live_layer(false);
		context_raw->pdirty=0;
		ui_header_worktab->position=_space;
		context_raw->tool=_tool;
		context_raw->bake_type=_bake_type;
		make_material_parse_paint_material(false);
		any_map_t * rts=render_path_render_targets;
		render_target_t * texpaint_live=any_map_get(rts,"texpaint_live");
		draw_begin(image,false,0);
		draw_image(texpaint_live->_image,0,0);
		draw_end();
	}
}

parse_node_preview_result_t * make_material_parse_node_preview_material(ui_node_t * node,ui_node_canvas_t * group,ui_node_t_array_t * parents){
	if(node->outputs->length==0){
		return null;
	}
	material_t * sdata=GC_ALLOC_INIT(material_t, {.name="Material",.canvas=ui_nodes_get_canvas_material()});
	material_context_t * mcon_raw=GC_ALLOC_INIT(material_context_t, {.name="mesh",.bind_textures=any_array_create_from_raw((any[]){},0)});
	node_shader_context_t * con=make_node_preview_run(sdata,mcon_raw,node,group,parents);
	bool compile_error=false;
	shader_context_t * scon;
	shader_context_t * _scon=shader_context_create(con->data);
	if(_scon==null){
		compile_error=true;
	}
	scon=_scon;
	if(compile_error){
		return null;
	}
	material_context_t * mcon=material_context_create(mcon_raw);
	parse_node_preview_result_t * result=GC_ALLOC_INIT(parse_node_preview_result_t, {.scon=scon,.mcon=mcon});
	return result;
}

void make_material_parse_brush(){
	parser_logic_parse(context_raw->brush->canvas);
}

string_t * make_material_blend_mode(node_shader_t * kong,i32 blending,string_t * cola,string_t * colb,string_t * opac){
	if(blending==blend_type_t_MIX){
		return string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_DARKEN){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", min3("),cola),", "),colb),"), "),opac),")");
	}
	else if(blending==blend_type_t_MULTIPLY){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," * "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_BURN){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", float3(1.0, 1.0, 1.0) - (float3(1.0, 1.0, 1.0) - "),cola),") / "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_LIGHTEN){
		return string_join(string_join(string_join(string_join(string_join(string_join("max3(",cola),", "),colb)," * "),opac),")");
	}
	else if(blending==blend_type_t_SCREEN){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(float3(1.0, 1.0, 1.0) - (float3(1.0 - ",opac),", 1.0 - "),opac),", 1.0 - "),opac),") + "),opac)," * (float3(1.0, 1.0, 1.0) - "),colb),")) * (float3(1.0, 1.0, 1.0) - "),cola),"))");
	}
	else if(blending==blend_type_t_DODGE){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," / (float3(1.0, 1.0, 1.0) - "),colb),"), "),opac),")");
	}
	else if(blending==blend_type_t_ADD){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," + "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_OVERLAY){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", float3( \
			"),cola),".r < 0.5 ? 2.0 * "),cola),".r * "),colb),".r : 1.0 - 2.0 * (1.0 - "),cola),".r) * (1.0 - "),colb),".r), \
			"),cola),".g < 0.5 ? 2.0 * "),cola),".g * "),colb),".g : 1.0 - 2.0 * (1.0 - "),cola),".g) * (1.0 - "),colb),".g), \
			"),cola),".b < 0.5 ? 2.0 * "),cola),".b * "),colb),".b : 1.0 - 2.0 * (1.0 - "),cola),".b) * (1.0 - "),colb),".b) \
		), "),opac),")");
	}
	else if(blending==blend_type_t_SOFT_LIGHT){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("((1.0 - ",opac),") * "),cola)," + "),opac)," * ((float3(1.0, 1.0, 1.0) - "),cola),") * "),colb)," * "),cola)," + "),cola)," * (float3(1.0, 1.0, 1.0) - (float3(1.0, 1.0, 1.0) - "),colb),") * (float3(1.0, 1.0, 1.0) - "),cola),"))))");
	}
	else if(blending==blend_type_t_LINEAR_LIGHT){
		return string_join(string_join(string_join(string_join(string_join(string_join("(",cola)," + "),opac)," * (float3(2.0, 2.0, 2.0) * ("),colb)," - float3(0.5, 0.5, 0.5))))");
	}
	else if(blending==blend_type_t_DIFFERENCE){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", abs3("),cola)," - "),colb),"), "),opac),")");
	}
	else if(blending==blend_type_t_SUBTRACT){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," - "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_DIVIDE){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("float3(1.0 - ",opac),", 1.0 - "),opac),", 1.0 - "),opac),") * "),cola)," + float3("),opac),", "),opac),", "),opac),") * "),cola)," / "),colb),"");
	}
	else if(blending==blend_type_t_HUE){
		node_shader_add_function(kong,str_hue_sat);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", hsv_to_rgb(float3(rgb_to_hsv("),colb),").r, rgb_to_hsv("),cola),").g, rgb_to_hsv("),cola),").b)), "),opac),")");
	}
	else if(blending==blend_type_t_SATURATION){
		node_shader_add_function(kong,str_hue_sat);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", hsv_to_rgb(float3(rgb_to_hsv("),cola),").r, rgb_to_hsv("),colb),").g, rgb_to_hsv("),cola),").b)), "),opac),")");
	}
	else if(blending==blend_type_t_COLOR){
		node_shader_add_function(kong,str_hue_sat);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", hsv_to_rgb(float3(rgb_to_hsv("),colb),").r, rgb_to_hsv("),colb),").g, rgb_to_hsv("),cola),").b)), "),opac),")");
	}
	else {
		node_shader_add_function(kong,str_hue_sat);
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", hsv_to_rgb(float3(rgb_to_hsv("),cola),").r, rgb_to_hsv("),cola),").g, rgb_to_hsv("),colb),").b)), "),opac),")");
	}
}

string_t * make_material_blend_mode_mask(i32 blending,string_t * cola,string_t * colb,string_t * opac){
	if(blending==blend_type_t_MIX){
		return string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_DARKEN){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", min3("),cola),", "),colb),"), "),opac),")");
	}
	else if(blending==blend_type_t_MULTIPLY){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," * "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_BURN){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", 1.0 - (1.0 - "),cola),") / "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_LIGHTEN){
		return string_join(string_join(string_join(string_join(string_join(string_join("max3(",cola),", "),colb)," * "),opac),")");
	}
	else if(blending==blend_type_t_SCREEN){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(1.0 - ((1.0 - ",opac),") + "),opac)," * (1.0 - "),colb),")) * (1.0 - "),cola),"))");
	}
	else if(blending==blend_type_t_DODGE){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," / (1.0 - "),colb),"), "),opac),")");
	}
	else if(blending==blend_type_t_ADD){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," + "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_OVERLAY){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," < 0.5 ? 2.0 * "),cola)," * "),colb)," : 1.0 - 2.0 * (1.0 - "),cola),") * (1.0 - "),colb),"), "),opac),")");
	}
	else if(blending==blend_type_t_SOFT_LIGHT){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("((1.0 - ",opac),") * "),cola)," + "),opac)," * ((1.0 - "),cola),") * "),colb)," * "),cola)," + "),cola)," * (1.0 - (1.0 - "),colb),") * (1.0 - "),cola),"))))");
	}
	else if(blending==blend_type_t_LINEAR_LIGHT){
		return string_join(string_join(string_join(string_join(string_join(string_join("(",cola)," + "),opac)," * (2.0 * ("),colb)," - 0.5)))");
	}
	else if(blending==blend_type_t_DIFFERENCE){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", abs3("),cola)," - "),colb),"), "),opac),")");
	}
	else if(blending==blend_type_t_SUBTRACT){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),cola)," - "),colb),", "),opac),")");
	}
	else if(blending==blend_type_t_DIVIDE){
		return string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join(string_join("(1.0 - ",opac),") * "),cola)," + "),opac)," * "),cola)," / "),colb),"");
	}
	else {
		return string_join(string_join(string_join(string_join(string_join(string_join("lerp3(",cola),", "),colb),", "),opac),")");
	}
}

f32 make_material_get_displace_strength(){
	vec4_t sc=context_main_object()->base->transform->scale;
	return config_raw->displace_strength*0.02*sc.x;
}

void make_material_delete_context(shader_context_t * c){
	sys_notify_on_next_frame(&make_material_delete_context_232067	,c);
}

void make_material_delete_context_232067(shader_context_t * c){
shader_context_delete(c);
}

node_shader_context_t * make_mesh_run(material_t * data,i32 layer_pass){
	string_t * context_id=layer_pass==0?"mesh":string_join("mesh",i32_to_string(layer_pass));
	shader_context_t * props=GC_ALLOC_INIT(shader_context_t, {.name=context_id,.depth_write=layer_pass==0?true:false,.compare_mode=layer_pass==0?"less":"equal",.cull_mode=(context_raw->cull_backfaces||layer_pass>0)?"clockwise":"none",.vertex_elements=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_element_t, {.name="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="nor",.data="short2norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="tex",.data="short2norm"}),},3),.color_attachments=any_array_create_from_raw((any[]){"RGBA64","RGBA64","RGBA64",},3),.depth_attachment="D32"});
	node_shader_context_t * con_mesh=node_shader_context_create(data,props);
	node_shader_t * kong=node_shader_context_make_kong(con_mesh);
	node_shader_add_out(kong,"tex_coord: float2");
	kong->frag_wvpposition=true;
	node_shader_add_constant(kong,"VP: float4x4","_view_proj_matrix");
	kong->frag_wposition=true;
	i32 texture_count=0;
	f32 displace_strength=make_material_get_displace_strength();
	if(make_material_height_used&&displace_strength>0.0){
		kong->vert_n=true;
		node_shader_write_vert(kong,"var height: float = 0.0;");
		i32 num_layers=0;
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			if(!slot_layer_is_visible(l)||!l->paint_height||!slot_layer_is_layer(l)){
				continue;
			}
			if(num_layers>16){
				break;
			}
			num_layers++;
			texture_count++;
			node_shader_add_texture(kong,string_join("texpaint_pack_vert",i32_to_string(l->id)),string_join("_texpaint_pack_vert",i32_to_string(l->id)));
			node_shader_write_vert(kong,string_join(string_join("height += sample_lod(texpaint_pack_vert",i32_to_string(l->id)),", sampler_linear, input.tex, 0.0).a;"));
			slot_layer_t_array_t * masks=slot_layer_get_masks(l,true);
			if(masks!=null){
				for(i32 i=0;i<masks->length;++i){
					slot_layer_t * m=masks->buffer[i];
					if(!slot_layer_is_visible(m)){
						continue;
					}
					texture_count++;
					node_shader_add_texture(kong,string_join("texpaint_vert",i32_to_string(m->id)),string_join("_texpaint_vert",i32_to_string(m->id)));
					node_shader_write_vert(kong,string_join(string_join("height *= sample_lod(texpaint_vert",i32_to_string(m->id)),", sampler_linear, input.tex, 0.0).r;"));
				}
			}
		}
		node_shader_write_vert(kong,string_join(string_join(string_join(string_join(string_join(string_join("output.wposition += wnormal * float3(height, height, height) * float3(",f32_to_string(displace_strength)),", "),f32_to_string(displace_strength)),", "),f32_to_string(displace_strength)),");"));
	}
	node_shader_write_vert(kong,"output.pos = constants.VP * float4(output.wposition.xyz, 1.0);");
	node_shader_write_vert(kong,"output.tex_coord = input.tex;");
	node_shader_write_attrib_frag(kong,"var tex_coord: float2 = input.tex_coord;");
	kong->frag_out="float4[3]";
	kong->frag_n=true;
	node_shader_add_function(kong,str_pack_float_int16);
	if(context_raw->tool==workspace_tool_t_COLORID){
		texture_count++;
		node_shader_add_texture(kong,"texcolorid","_texcolorid");
		node_shader_write_frag(kong,"output[0] = float4(n.xy, 1.0, pack_f32_i16(0.0, uint(0)));");
		node_shader_write_frag(kong,"var idcol: float3 = pow3(sample_lod(texcolorid, sampler_linear, tex_coord, 0.0).rgb, float3(2.2, 2.2, 2.2));");
		node_shader_write_frag(kong,"output[1] = float4(idcol.rgb, 1.0);");
	}
	else {
		node_shader_add_function(kong,str_octahedron_wrap);
		node_shader_add_function(kong,str_cotangent_frame);
		if(layer_pass>0){
			node_shader_add_texture(kong,"gbuffer0",null);
			node_shader_add_texture(kong,"gbuffer1",null);
			node_shader_add_texture(kong,"gbuffer2",null);
			node_shader_write_frag(kong,"var fragcoord: float2 = float2(input.wvpposition.x / input.wvpposition.w, input.wvpposition.y / input.wvpposition.w) * 0.5 + 0.5;");
			node_shader_write_frag(kong,"fragcoord.y = 1.0 - fragcoord.y;");
			node_shader_write_frag(kong,"var gbuffer0_sample: float4 = sample_lod(gbuffer0, sampler_linear, fragcoord, 0.0);");
			node_shader_write_frag(kong,"var gbuffer1_sample: float4 = sample_lod(gbuffer1, sampler_linear, fragcoord, 0.0);");
			node_shader_write_frag(kong,"var gbuffer2_sample: float4 = sample_lod(gbuffer2, sampler_linear, fragcoord, 0.0);");
			node_shader_write_frag(kong,"var basecol: float3 = gbuffer0_sample.rgb;");
			node_shader_write_frag(kong,"var roughness: float = gbuffer2_sample.g;");
			node_shader_write_frag(kong,"var metallic: float = gbuffer2_sample.b;");
			node_shader_write_frag(kong,"var occlusion: float = gbuffer2_sample.r;");
			node_shader_write_frag(kong,"var opacity: float = 1.0;//gbuffer0_sample.a;");
			node_shader_write_frag(kong,"var matid: float = gbuffer1_sample.a;");
			node_shader_write_frag(kong,"var ntex: float3 = gbuffer1_sample.rgb;");
			node_shader_write_frag(kong,"var height: float = gbuffer2_sample.a;");
		}
		else {
			node_shader_write_frag(kong,"var basecol: float3 = float3(0.0, 0.0, 0.0);");
			node_shader_write_frag(kong,"var roughness: float = 0.0;");
			node_shader_write_frag(kong,"var metallic: float = 0.0;");
			node_shader_write_frag(kong,"var occlusion: float = 1.0;");
			node_shader_write_frag(kong,"var opacity: float = 1.0;");
			node_shader_write_frag(kong,"var matid: float = 0.0;");
			node_shader_write_frag(kong,"var ntex: float3 = float3(0.5, 0.5, 1.0);");
			node_shader_write_frag(kong,"var height: float = 0.0;");
		}
		node_shader_write_frag(kong,"var texpaint_sample: float4 = float4(0.0, 0.0, 0.0, 1.0);");
		node_shader_write_frag(kong,"var texpaint_nor_sample: float4;");
		node_shader_write_frag(kong,"var texpaint_pack_sample: float4;");
		node_shader_write_frag(kong,"var texpaint_opac: float;");
		if(make_material_height_used){
			node_shader_write_frag(kong,"var height0: float = 0.0;");
			node_shader_write_frag(kong,"var height1: float = 0.0;");
			node_shader_write_frag(kong,"var height2: float = 0.0;");
			node_shader_write_frag(kong,"var height3: float = 0.0;");
		}
		if(context_raw->draw_wireframe){
			texture_count++;
			node_shader_add_texture(kong,"texuvmap","_texuvmap");
		}
		if(context_raw->viewport_mode==viewport_mode_t_MASK&&slot_layer_get_masks(context_raw->layer,true)!=null){
			for(i32 i=0;i<slot_layer_get_masks(context_raw->layer,true)->length;++i){
				slot_layer_t * m=slot_layer_get_masks(context_raw->layer,true)->buffer[i];
				if(!slot_layer_is_visible(m)){
					continue;
				}
				texture_count++;
				i32 index=array_index_of(project_layers,m);
				node_shader_add_texture(kong,string_join("texpaint_view_mask",i32_to_string(m->id)),string_join("_texpaint",i32_to_string(index)));
			}
		}
		if(context_raw->viewport_mode==viewport_mode_t_LIT&&context_raw->render_mode==render_mode_t_FORWARD){
			texture_count+=7;
			node_shader_add_texture(kong,"senvmap_brdf","$brdf.k");
			node_shader_add_texture(kong,"senvmap_radiance","_envmap_radiance");
			node_shader_add_texture(kong,"senvmap_radiance0","_envmap_radiance0");
			node_shader_add_texture(kong,"senvmap_radiance1","_envmap_radiance1");
			node_shader_add_texture(kong,"senvmap_radiance2","_envmap_radiance2");
			node_shader_add_texture(kong,"senvmap_radiance3","_envmap_radiance3");
			node_shader_add_texture(kong,"senvmap_radiance4","_envmap_radiance4");
		}
		make_mesh_layer_pass_count=1;
		slot_layer_t_array_t * layers=any_array_create_from_raw((any[]){},0);
		i32 start_count=texture_count;
		bool is_material_tool=context_raw->tool==workspace_tool_t_MATERIAL;
		for(i32 i=0;i<project_layers->length;++i){
			slot_layer_t * l=project_layers->buffer[i];
			if(is_material_tool&&l!=context_raw->layer){
				continue;
			}
			if(!slot_layer_is_layer(l)||!slot_layer_is_visible(l)){
				continue;
			}
			i32 count=3;
			slot_layer_t_array_t * masks=slot_layer_get_masks(l,true);
			if(masks!=null){
				count+=masks->length;
			}
			texture_count+=count;
			if(texture_count>=GPU_MAX_TEXTURES-3){
				texture_count=start_count+count+3;
				make_mesh_layer_pass_count++;
			}
			if(layer_pass==make_mesh_layer_pass_count-1){
				any_array_push(layers,l);
			}
		}
		bool last_pass=layer_pass==make_mesh_layer_pass_count-1;
		for(i32 i=0;i<layers->length;++i){
			slot_layer_t * l=layers->buffer[i];
			if(slot_layer_get_object_mask(l)>0){
				node_shader_add_constant(kong,"uid: int","_uid");
				if(slot_layer_get_object_mask(l)>project_paint_objects->length){
					mesh_object_t_array_t * visibles=project_get_atlas_objects(slot_layer_get_object_mask(l));
					node_shader_write_frag(kong,"if (");
					for(i32 i=0;i<visibles->length;++i){
						if(i>0){
							node_shader_write_frag(kong," || ");
						}
						i32 uid=visibles->buffer[i]->base->uid;
						node_shader_write_frag(kong,string_join(i32_to_string(uid)," == constants.uid"));
					}
					node_shader_write_frag(kong,") {");
				}
				else {
					i32 uid=project_paint_objects->buffer[slot_layer_get_object_mask(l)-1]->base->uid;
					node_shader_write_frag(kong,string_join(string_join("if (",i32_to_string(uid))," == constants.uid) {"));
				}
			}
			node_shader_add_texture(kong,string_join("texpaint",i32_to_string(l->id)),null);
			node_shader_write_frag(kong,string_join(string_join("texpaint_sample = sample_lod(texpaint",i32_to_string(l->id)),", sampler_linear, tex_coord, 0.0);"));
			node_shader_write_frag(kong,"texpaint_opac = texpaint_sample.a;");
			slot_layer_t_array_t * masks=slot_layer_get_masks(l,true);
			if(masks!=null){
				bool has_visible=false;
				for(i32 i=0;i<masks->length;++i){
					slot_layer_t * m=masks->buffer[i];
					if(slot_layer_is_visible(m)){
						has_visible=true;
						break;
					}
				}
				if(has_visible){
					string_t * texpaint_mask=string_join("texpaint_mask",i32_to_string(l->id));
					node_shader_write_frag(kong,string_join(string_join("var ",texpaint_mask),": float = 0.0;"));
					for(i32 i=0;i<masks->length;++i){
						slot_layer_t * m=masks->buffer[i];
						if(!slot_layer_is_visible(m)){
							continue;
						}
						node_shader_add_texture(kong,string_join("texpaint",i32_to_string(m->id)),null);
						node_shader_write_frag(kong,"{");
						node_shader_write_frag(kong,string_join(string_join(string_join(string_join("var texpaint_mask_sample",i32_to_string(m->id)),": float = sample_lod(texpaint"),i32_to_string(m->id)),", sampler_linear, tex_coord, 0.0).r;"));
						f32 opac=slot_layer_get_opacity(m);
						string_t * mask=make_material_blend_mode_mask(m->blending,texpaint_mask,string_join("texpaint_mask_sample",i32_to_string(m->id)),string_join(string_join("float(",f32_to_string(opac)),")"));
						node_shader_write_frag(kong,string_join(string_join(string_join(texpaint_mask," = "),mask),";"));
						node_shader_write_frag(kong,"}");
					}
					node_shader_write_frag(kong,string_join(string_join("texpaint_opac *= clamp(",texpaint_mask),", 0.0, 1.0);"));
				}
			}
			if(slot_layer_get_opacity(l)<1){
				f32 opac=slot_layer_get_opacity(l);
				node_shader_write_frag(kong,string_join(string_join("texpaint_opac *= ",f32_to_string(opac)),";"));
			}
			if(l->paint_base){
				if(l==project_layers->buffer[0]){
					node_shader_write_frag(kong,"basecol = texpaint_sample.rgb * texpaint_opac;");
				}
				else {
					node_shader_write_frag(kong,string_join(string_join("basecol = ",make_material_blend_mode(kong,l->blending,"basecol","texpaint_sample.rgb","texpaint_opac")),";"));
				}
			}
			if(l->paint_nor||make_material_emis_used){
				node_shader_add_texture(kong,string_join("texpaint_nor",i32_to_string(l->id)),null);
				node_shader_write_frag(kong,string_join(string_join("texpaint_nor_sample = sample_lod(texpaint_nor",i32_to_string(l->id)),", sampler_linear, tex_coord, 0.0);"));
				if(make_material_emis_used){
					node_shader_write_frag(kong,"if (texpaint_opac > 0.0) {");
					node_shader_add_constant(kong,"texpaint_size: float2","_texpaint_size");
					node_shader_write_frag(kong,string_join(string_join("	var texpaint_nor_raw: float4 = texpaint_nor",i32_to_string(l->id)),"[uint2(uint(tex_coord.x * constants.texpaint_size.x), uint(tex_coord.y * constants.texpaint_size.y))];"));
					node_shader_write_frag(kong,"	matid = texpaint_nor_raw.a;");
					node_shader_write_frag(kong,"}");
				}
				if(l->paint_nor){
					if(l->paint_nor_blend){
						node_shader_write_frag(kong,"{");
						node_shader_write_frag(kong,"var n1: float3 = ntex * float3(2.0, 2.0, 2.0) - float3(1.0, 1.0, 1.0);");
						node_shader_write_frag(kong,"var n2: float3 = lerp3(float3(0.5, 0.5, 1.0), texpaint_nor_sample.rgb, texpaint_opac) * float3(2.0, 2.0, 2.0) - float3(1.0, 1.0, 1.0);");
						node_shader_write_frag(kong,"ntex = normalize(float3(n1.xy + n2.xy, n1.z * n2.z)) * float3(0.5, 0.5, 0.5) + float3(0.5, 0.5, 0.5);");
						node_shader_write_frag(kong,"}");
					}
					else {
						node_shader_write_frag(kong,"ntex = lerp3(ntex, texpaint_nor_sample.rgb, texpaint_opac);");
					}
				}
			}
			if(l->paint_occ||l->paint_rough||l->paint_met||(l->paint_height&&make_material_height_used)){
				node_shader_add_texture(kong,string_join("texpaint_pack",i32_to_string(l->id)),null);
				node_shader_write_frag(kong,string_join(string_join("texpaint_pack_sample = sample_lod(texpaint_pack",i32_to_string(l->id)),", sampler_linear, tex_coord, 0.0);"));
				if(l->paint_occ){
					node_shader_write_frag(kong,"occlusion = lerp(occlusion, texpaint_pack_sample.r, texpaint_opac);");
				}
				if(l->paint_rough){
					node_shader_write_frag(kong,"roughness = lerp(roughness, texpaint_pack_sample.g, texpaint_opac);");
				}
				if(l->paint_met){
					node_shader_write_frag(kong,"metallic = lerp(metallic, texpaint_pack_sample.b, texpaint_opac);");
				}
				if(l->paint_height&&make_material_height_used){
					string_t * assign=l->paint_height_blend?"+=":"=";
					node_shader_write_frag(kong,string_join(string_join("height ",assign)," texpaint_pack_sample.a * texpaint_opac;"));
					node_shader_write_frag(kong,"{");
					node_shader_add_constant(kong,"texpaint_size: float2","_texpaint_size");
					node_shader_write_frag(kong,"var tex_step: float = 1.0 / constants.texpaint_size.x;");
					node_shader_write_frag(kong,string_join(string_join(string_join(string_join("height0 ",assign)," sample_lod(texpaint_pack"),i32_to_string(l->id)),", sampler_linear, float2(tex_coord.x - tex_step, tex_coord.y), 0.0).a * texpaint_opac;"));
					node_shader_write_frag(kong,string_join(string_join(string_join(string_join("height1 ",assign)," sample_lod(texpaint_pack"),i32_to_string(l->id)),", sampler_linear, float2(tex_coord.x + tex_step, tex_coord.y), 0.0).a * texpaint_opac;"));
					node_shader_write_frag(kong,string_join(string_join(string_join(string_join("height2 ",assign)," sample_lod(texpaint_pack"),i32_to_string(l->id)),", sampler_linear, float2(tex_coord.x, tex_coord.y - tex_step), 0.0).a * texpaint_opac;"));
					node_shader_write_frag(kong,string_join(string_join(string_join(string_join("height3 ",assign)," sample_lod(texpaint_pack"),i32_to_string(l->id)),", sampler_linear, float2(tex_coord.x, tex_coord.y + tex_step), 0.0).a * texpaint_opac;"));
					node_shader_write_frag(kong,"}");
				}
			}
			if(slot_layer_get_object_mask(l)>0){
				node_shader_write_frag(kong,"}");
			}
		}
		if(last_pass&&context_raw->draw_texels){
			node_shader_add_constant(kong,"texpaint_size: float2","_texpaint_size");
			node_shader_write_frag(kong,"var texel0: float2 = tex_coord * constants.texpaint_size * 0.01;");
			node_shader_write_frag(kong,"var texel1: float2 = tex_coord * constants.texpaint_size * 0.1;");
			node_shader_write_frag(kong,"var texel2: float2 = tex_coord * constants.texpaint_size;");
			node_shader_write_frag(kong,"var texel0xmod: float = float(int(texel0.x)) % 2.0;");
			node_shader_write_frag(kong,"var texel0ymod: float = float(int(texel0.y)) % 2.0;");
			node_shader_write_frag(kong,"var texel1xmod: float = float(int(texel1.x)) % 2.0;");
			node_shader_write_frag(kong,"var texel1ymod: float = float(int(texel1.y)) % 2.0;");
			node_shader_write_frag(kong,"var texel2xmod: float = float(int(texel2.x)) % 2.0;");
			node_shader_write_frag(kong,"var texel2ymod: float = float(int(texel2.y)) % 2.0;");
			node_shader_write_frag(kong,"if (texel0xmod == texel0ymod) { basecol = basecol * 0.9; }");
			node_shader_write_frag(kong,"if (texel1xmod == texel1ymod) { basecol = basecol * 0.9; }");
			node_shader_write_frag(kong,"if (texel2xmod == texel2ymod) { basecol = basecol * 0.9; }");
		}
		if(last_pass&&context_raw->draw_wireframe){
			node_shader_write_frag(kong,"var wireframe: float = sample_lod(texuvmap, sampler_linear, tex_coord, 0.0).a;");
			node_shader_write_frag(kong,"basecol = basecol * (1.0 - wireframe * 0.25);");
			node_shader_write_frag(kong,"roughness = max(roughness, wireframe);");
		}
		if(make_material_height_used){
			node_shader_write_frag(kong,"if (height > 0.0) {");
			node_shader_write_frag(kong,"var height_dx: float = height0 - height1;");
			node_shader_write_frag(kong,"var height_dy: float = height2 - height3;");
			node_shader_write_frag(kong,"var n1: float3 = ntex * float3(2.0, 2.0, 2.0) - float3(1.0, 1.0, 1.0);");
			node_shader_write_frag(kong,"var n2: float3 = normalize(float3(height_dx * 16.0, height_dy * 16.0, 1.0));");
			node_shader_write_frag(kong,"ntex = normalize(float3(n1.xy + n2.xy, n1.z * n2.z)) * float3(0.5, 0.5, 0.5) + float3(0.5, 0.5, 0.5);");
			node_shader_write_frag(kong,"}");
		}
		if(!last_pass){
			node_shader_write_frag(kong,"output[0] = float4(basecol, opacity);");
			node_shader_write_frag(kong,"output[1] = float4(ntex, matid);");
			node_shader_write_frag(kong,"output[2] = float4(occlusion, roughness, metallic, height);");
			parser_material_finalize(con_mesh);
			con_mesh->data->shader_from_source=true;
			gpu_create_shaders_from_kong(node_shader_get(kong),ADDRESS(con_mesh->data->vertex_shader),ADDRESS(con_mesh->data->fragment_shader),ADDRESS(con_mesh->data->_->vertex_shader_size),ADDRESS(con_mesh->data->_->fragment_shader_size));
			return con_mesh;
		}
		kong->frag_vvec=true;
		node_shader_write_frag(kong,"var TBN: float3x3 = cotangent_frame(n, vvec, tex_coord);");
		node_shader_write_frag(kong,"n = ntex * float3(2.0, 2.0, 2.0) - float3(1.0, 1.0, 1.0);");
		node_shader_write_frag(kong,"n.y = -n.y;");
		node_shader_write_frag(kong,"n = normalize(TBN * n);");
		if(context_raw->viewport_mode==viewport_mode_t_LIT||context_raw->viewport_mode==viewport_mode_t_PATH_TRACE){
			node_shader_write_frag(kong,"basecol = pow3(basecol, float3(2.2, 2.2, 2.2));");
			if(context_raw->viewport_shader!=null){
				node_shader_write_frag(kong,"var output_color: float3;");
				js_call_ptr(context_raw->viewport_shader,kong);
				node_shader_write_frag(kong,"output[1] = float4(output_color, 1.0);");
			}
			else if(context_raw->render_mode==render_mode_t_FORWARD&&context_raw->viewport_mode!=viewport_mode_t_PATH_TRACE){
				kong->frag_wposition=true;
				node_shader_write_frag(kong,"var albedo: float3 = lerp3(basecol, float3(0.0, 0.0, 0.0), metallic);");
				node_shader_write_frag(kong,"var f0: float3 = lerp3(float3(0.04, 0.04, 0.04), basecol, metallic);");
				kong->frag_vvec=true;
				node_shader_write_frag(kong,"var dotnv: float = max(0.0, dot(n, vvec));");
				node_shader_write_frag(kong,"var brdf_coord: float2 = float2(roughness, 1.0 - dotnv) * 256.0;");
				node_shader_write_frag(kong,"var env_brdf: float4 = senvmap_brdf[uint2(uint(brdf_coord.x), uint(brdf_coord.y))];");
				node_shader_add_constant(kong,"envmap_data: float4","_envmap_data");
				node_shader_write_frag(kong,"var wreflect: float3 = reflect(-vvec, n);");
				node_shader_add_function(kong,str_envmap_equirect);
				node_shader_add_function(kong,str_envmap_sample);
				node_shader_write_frag(kong,"var envlod: float = roughness * 5.0;");
				node_shader_write_frag(kong,"var lod0: float = floor(envlod);");
				node_shader_write_frag(kong,"var lod1: float = ceil(envlod);");
				node_shader_write_frag(kong,"var lodf: float = envlod - lod0;");
				node_shader_write_frag(kong,"var envmap_coord: float2 = envmap_equirect(wreflect, constants.envmap_data.x);");
				node_shader_write_frag(kong,"var lodc0: float3 = envmap_sample(lod0, envmap_coord);");
				node_shader_write_frag(kong,"var lodc1: float3 = envmap_sample(lod1, envmap_coord);");
				node_shader_write_frag(kong,"var prefiltered_color: float3 = lerp3(lodc0, lodc1, lodf);");
				node_shader_add_constant(kong,"shirr0: float4","_envmap_irradiance0");
				node_shader_add_constant(kong,"shirr1: float4","_envmap_irradiance1");
				node_shader_add_constant(kong,"shirr2: float4","_envmap_irradiance2");
				node_shader_add_constant(kong,"shirr3: float4","_envmap_irradiance3");
				node_shader_add_constant(kong,"shirr4: float4","_envmap_irradiance4");
				node_shader_add_constant(kong,"shirr5: float4","_envmap_irradiance5");
				node_shader_add_constant(kong,"shirr6: float4","_envmap_irradiance6");
				node_shader_add_function(kong,str_sh_irradiance);
				node_shader_write_frag(kong,"var indirect: float3 = albedo * (sh_irradiance(float3(n.x * constants.envmap_data.z - n.y * constants.envmap_data.y, n.x * constants.envmap_data.y + n.y * constants.envmap_data.z, n.z)) / 3.14159265);");
				node_shader_write_frag(kong,"indirect = indirect + (prefiltered_color * (f0 * env_brdf.x + env_brdf.y) * 1.5);");
				node_shader_write_frag(kong,"indirect = indirect * constants.envmap_data.w * occlusion;");
				node_shader_write_frag(kong,"output[1] = float4(indirect, 1.0);");
			}
			else {
				if(make_material_emis_used){
					node_shader_write_frag(kong,"if (float(int(matid * 255.0)) % float(3) == 1.0) { basecol = basecol * 10.0; }");
				}
				node_shader_write_frag(kong,"output[1] = float4(basecol, occlusion);");
			}
		}
		else if(context_raw->viewport_mode==viewport_mode_t_BASE_COLOR&&context_raw->layer->paint_base){
			node_shader_write_frag(kong,"output[1] = float4(basecol, 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_NORMAL_MAP&&context_raw->layer->paint_nor){
			node_shader_write_frag(kong,"output[1] = float4(ntex.rgb, 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_OCCLUSION&&context_raw->layer->paint_occ){
			node_shader_write_frag(kong,"output[1] = float4(float3(occlusion, occlusion, occlusion), 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_ROUGHNESS&&context_raw->layer->paint_rough){
			node_shader_write_frag(kong,"output[1] = float4(float3(roughness, roughness, roughness), 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_METALLIC&&context_raw->layer->paint_met){
			node_shader_write_frag(kong,"output[1] = float4(float3(metallic, metallic, metallic), 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_OPACITY&&context_raw->layer->paint_opac){
			node_shader_write_frag(kong,"output[1] = float4(float3(texpaint_sample.a, texpaint_sample.a, texpaint_sample.a), 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_HEIGHT&&context_raw->layer->paint_height){
			node_shader_write_frag(kong,"output[1] = float4(float3(height, height, height), 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_EMISSION){
			node_shader_write_frag(kong,"var matid_mod: float = float(int(matid * 255.0)) % float(3);");
			node_shader_write_frag(kong,"var emis: float = 0.0; if (matid_mod == 1.0) { emis = 1.0; }");
			node_shader_write_frag(kong,"output[1] = float4(float3(emis, emis, emis), 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_SUBSURFACE){
			node_shader_write_frag(kong,"var matid_mod: float = float(int(matid * 255.0)) % float(3);");
			node_shader_write_frag(kong,"var subs: float = 0.0; if (matid_mod == 2.0) { subs = 1.0; }");
			node_shader_write_frag(kong,"output[1] = float4(float3(subs, subs, subs), 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_TEXCOORD){
			node_shader_write_frag(kong,"output[1] = float4(tex_coord, 0.0, 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_OBJECT_NORMAL){
			kong->frag_nattr=true;
			node_shader_write_frag(kong,"output[1] = float4(input.nattr, 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_MATERIAL_ID){
			i32 id=context_raw->layer->id;
			node_shader_add_texture(kong,string_join("texpaint_nor",i32_to_string(id)),null);
			node_shader_add_constant(kong,"texpaint_size: float2","_texpaint_size");
			node_shader_write_frag(kong,"var sample_matid_coord: float2 = tex_coord * constants.texpaint_size;");
			node_shader_write_frag(kong,string_join(string_join("var sample_matid4: float4 = texpaint_nor",i32_to_string(id)),"[uint2(uint(sample_matid_coord.x), uint(sample_matid_coord.y))];"));
			node_shader_write_frag(kong,"var sample_matid: float = sample_matid4.a + 1.0 / 255.0;");
			node_shader_write_frag(kong,"var matid_r: float = frac(sin(dot(float2(sample_matid, sample_matid * 20.0), float2(12.9898, 78.233))) * 43758.5453);");
			node_shader_write_frag(kong,"var matid_g: float = frac(sin(dot(float2(sample_matid * 20.0, sample_matid), float2(12.9898, 78.233))) * 43758.5453);");
			node_shader_write_frag(kong,"var matid_b: float = frac(sin(dot(float2(sample_matid, sample_matid * 40.0), float2(12.9898, 78.233))) * 43758.5453);");
			node_shader_write_frag(kong,"output[1] = float4(matid_r, matid_g, matid_b, 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_OBJECT_ID){
			node_shader_add_constant(kong,"object_id: float","_object_id");
			node_shader_write_frag(kong,"var obid: float = constants.object_id + 1.0 / 255.0;");
			node_shader_write_frag(kong,"var id_r: float = frac(sin(dot(float2(obid, obid * 20.0), float2(12.9898, 78.233))) * 43758.5453);");
			node_shader_write_frag(kong,"var id_g: float = frac(sin(dot(float2(obid * 20.0, obid), float2(12.9898, 78.233))) * 43758.5453);");
			node_shader_write_frag(kong,"var id_b: float = frac(sin(dot(float2(obid, obid * 40.0), float2(12.9898, 78.233))) * 43758.5453);");
			node_shader_write_frag(kong,"output[1] = float4(id_r, id_g, id_b, 1.0);");
		}
		else if(context_raw->viewport_mode==viewport_mode_t_MASK&&(slot_layer_get_masks(context_raw->layer,true)!=null||slot_layer_is_mask(context_raw->layer))){
			if(slot_layer_is_mask(context_raw->layer)){
				i32 id=context_raw->layer->id;
				node_shader_write_frag(kong,string_join(string_join("var mask_view: float = sample_lod(texpaint",i32_to_string(id)),", sampler_linear, tex_coord, 0.0).r;"));
			}
			else {
				node_shader_write_frag(kong,"var mask_view: float = 0.0;");
				for(i32 i=0;i<slot_layer_get_masks(context_raw->layer,true)->length;++i){
					slot_layer_t * m=slot_layer_get_masks(context_raw->layer,true)->buffer[i];
					if(!slot_layer_is_visible(m)){
						continue;
					}
					node_shader_write_frag(kong,string_join(string_join(string_join(string_join("var mask_sample",i32_to_string(m->id)),": float = sample_lod(texpaint_view_mask"),i32_to_string(m->id)),", sampler_linear, tex_coord, 0.0).r;"));
					f32 opac=slot_layer_get_opacity(m);
					string_t * mask=make_material_blend_mode_mask(m->blending,"mask_view",string_join("mask_sample",i32_to_string(m->id)),string_join(string_join("float(",f32_to_string(opac)),")"));
					node_shader_write_frag(kong,string_join(string_join("mask_view = ",mask),";"));
				}
			}
			node_shader_write_frag(kong,"output[1] = float4(mask_view, mask_view, mask_view, 1.0);");
		}
		else {
			node_shader_write_frag(kong,"output[1] = float4(1.0, 0.0, 1.0, 1.0);");
		}
		if(context_raw->viewport_mode!=viewport_mode_t_LIT&&context_raw->viewport_mode!=viewport_mode_t_PATH_TRACE){
			node_shader_write_frag(kong,"output[1].rgb = pow3(output[1].rgb, float3(2.2, 2.2, 2.2));");
		}
		node_shader_write_frag(kong,"n = n / (abs(n.x) + abs(n.y) + abs(n.z));");
		node_shader_write_frag(kong,"if (n.z < 0.0) { n.xy = octahedron_wrap(n.xy); }");
		node_shader_write_frag(kong,"output[0] = float4(n.xy, roughness, pack_f32_i16(metallic, uint(float(int(matid * 255.0)) % float(3))));");
	}
	node_shader_write_frag(kong,"output[2] = float4(0.0, 0.0, tex_coord.xy);");
	parser_material_finalize(con_mesh);
	con_mesh->data->shader_from_source=true;
	gpu_create_shaders_from_kong(node_shader_get(kong),ADDRESS(con_mesh->data->vertex_shader),ADDRESS(con_mesh->data->fragment_shader),ADDRESS(con_mesh->data->_->vertex_shader_size),ADDRESS(con_mesh->data->_->fragment_shader_size));
	return con_mesh;
}

node_shader_context_t * make_mesh_preview_run(material_t * data,material_context_t * matcon){
	string_t * context_id="mesh";
	shader_context_t * props=GC_ALLOC_INIT(shader_context_t, {.name=context_id,.depth_write=true,.compare_mode="less",.cull_mode="clockwise",.vertex_elements=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_element_t, {.name="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="nor",.data="short2norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="tex",.data="short2norm"}),},3),.color_attachments=any_array_create_from_raw((any[]){"RGBA64","RGBA64","RGBA64",},3),.depth_attachment="D32"});
	node_shader_context_t * con_mesh=node_shader_context_create(data,props);
	node_shader_t * kong=node_shader_context_make_kong(con_mesh);
	string_t * pos="input.pos";
	node_shader_add_constant(kong,"WVP: float4x4","_world_view_proj_matrix");
	node_shader_write_attrib_vert(kong,string_join(string_join("output.pos = constants.WVP * float4(",pos),".xyz, 1.0);"));
	f32 sc=context_raw->brush_scale*context_raw->brush_nodes_scale;
	string_t * brush_scale=string_join(f32_to_string(sc),"");
	node_shader_add_out(kong,"tex_coord: float2");
	node_shader_write_attrib_vert(kong,string_join(string_join("output.tex_coord = input.tex * float(",brush_scale),");"));
	node_shader_write_attrib_frag(kong,"var tex_coord: float2 = input.tex_coord;");
	bool decal=context_raw->decal_preview;
	parser_material_sample_keep_aspect=decal;
	gc_unroot(parser_material_sample_uv_scale);parser_material_sample_uv_scale=string_copy(brush_scale);gc_root(parser_material_sample_uv_scale);
	parser_material_parse_height=make_material_height_used;
	parser_material_parse_height_as_channel=true;
	shader_out_t * sout=parser_material_parse(ui_nodes_get_canvas_material(),con_mesh,kong,matcon);
	parser_material_parse_height=false;
	parser_material_parse_height_as_channel=false;
	parser_material_sample_keep_aspect=false;
	string_t * base=sout->out_basecol;
	string_t * rough=sout->out_roughness;
	string_t * met=sout->out_metallic;
	string_t * occ=sout->out_occlusion;
	string_t * opac=sout->out_opacity;
	string_t * height=sout->out_height;
	string_t * nortan=parser_material_out_normaltan;
	node_shader_write_frag(kong,string_join(string_join("var basecol: float3 = pow3(",base),", float3(2.2, 2.2, 2.2));"));
	node_shader_write_frag(kong,string_join(string_join("var roughness: float = ",rough),";"));
	node_shader_write_frag(kong,string_join(string_join("var metallic: float = ",met),";"));
	node_shader_write_frag(kong,string_join(string_join("var occlusion: float = ",occ),";"));
	node_shader_write_frag(kong,string_join(string_join("var opacity: float = ",opac),";"));
	node_shader_write_frag(kong,string_join(string_join("var nortan: float3 = ",nortan),";"));
	node_shader_write_frag(kong,string_join(string_join("var height: float = ",height),";"));
	if(decal){
		if(context_raw->tool==workspace_tool_t_TEXT){
			node_shader_add_texture(kong,"textexttool","_textexttool");
			node_shader_write_frag(kong,string_join(string_join("opacity *= sample_lod(textexttool, sampler_linear, tex_coord / float(",brush_scale),"), 0.0).r;"));
		}
	}
	if(decal){
		f32 opac=make_mesh_preview_opacity_discard_decal;
		node_shader_write_frag(kong,string_join(string_join("if (opacity < ",f32_to_string(opac)),") { discard; }"));
	}
	kong->frag_out="float4[3]";
	kong->frag_n=true;
	node_shader_add_function(kong,str_pack_float_int16);
	node_shader_add_function(kong,str_cotangent_frame);
	node_shader_add_function(kong,str_octahedron_wrap);
	if(make_material_height_used){
		node_shader_write_frag(kong,"if (height > 0.0) {");
		node_shader_write_frag(kong,"var height_dx: float = ddx(height * 2.0);");
		node_shader_write_frag(kong,"var height_dy: float = ddy(height * 2.0);");
		node_shader_write_frag(kong,"var n1: float3 = nortan * float3(2.0, 2.0, 2.0) - float3(1.0, 1.0, 1.0);");
		node_shader_write_frag(kong,"var n2: float3 = normalize(float3(height_dx * 16.0, height_dy * 16.0, 1.0));");
		node_shader_write_frag(kong,"nortan = normalize(float3(n1.xy + n2.xy, n1.z * n2.z)) * float3(0.5, 0.5, 0.5) + float3(0.5, 0.5, 0.5);");
		node_shader_write_frag(kong,"}");
	}
	if(decal){
	}
	else {
		kong->frag_vvec=true;
		node_shader_write_frag(kong,"var TBN: float3x3 = cotangent_frame(n, vvec, tex_coord);");
		node_shader_write_frag(kong,"n = nortan * 2.0 - 1.0;");
		node_shader_write_frag(kong,"n.y = -n.y;");
		node_shader_write_frag(kong,"n = normalize(TBN * n);");
	}
	node_shader_write_frag(kong,"n = n / (abs(n.x) + abs(n.y) + abs(n.z));");
	node_shader_write_frag(kong,"if (n.z < 0.0) { n.xy = octahedron_wrap(n.xy); }");
	if(decal){
		node_shader_write_frag(kong,"output[0] = float4(n.x, n.y, roughness, pack_f32_i16(metallic, uint(0)));");
		node_shader_write_frag(kong,"output[1] = float4(basecol, occlusion);");
	}
	else {
		node_shader_write_frag(kong,"output[0] = float4(n.x, n.y, lerp(1.0, roughness, opacity), pack_f32_i16(lerp(1.0, metallic, opacity), uint(0)));");
		node_shader_write_frag(kong,"output[1] = float4(lerp3(float3(0.0, 0.0, 0.0), basecol, opacity), occlusion);");
	}
	node_shader_write_frag(kong,"output[2] = float4(0.0, 0.0, 0.0, 0.0);");
	parser_material_finalize(con_mesh);
	con_mesh->data->shader_from_source=true;
	gpu_create_shaders_from_kong(node_shader_get(kong),ADDRESS(con_mesh->data->vertex_shader),ADDRESS(con_mesh->data->fragment_shader),ADDRESS(con_mesh->data->_->vertex_shader_size),ADDRESS(con_mesh->data->_->fragment_shader_size));
	return con_mesh;
}

node_shader_context_t * make_node_preview_run(material_t * data,material_context_t * matcon,ui_node_t * node,ui_node_canvas_t * group,ui_node_t_array_t * parents){
	string_t * context_id="mesh";
	shader_context_t * props=GC_ALLOC_INIT(shader_context_t, {.name=context_id,.depth_write=false,.compare_mode="always",.cull_mode="clockwise",.vertex_elements=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_element_t, {.name="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="nor",.data="short2norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="tex",.data="short2norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="col",.data="short4norm"}),},4),.color_attachments=any_array_create_from_raw((any[]){"RGBA32",},1)});
	node_shader_context_t * con_mesh=node_shader_context_create(data,props);
	con_mesh->allow_vcols=true;
	node_shader_t * kong=node_shader_context_make_kong(con_mesh);
	node_shader_write_attrib_vert(kong,"output.pos = float4(input.pos.xy * 3.0, 0.0, 1.0);");
	node_shader_write_attrib_vert(kong,"var madd: float2 = float2(0.5, 0.5);");
	node_shader_add_out(kong,"tex_coord: float2");
	node_shader_write_attrib_vert(kong,"output.tex_coord = output.pos.xy * madd + madd;");
	node_shader_write_attrib_vert(kong,"output.tex_coord.y = 1.0 - output.tex_coord.y;");
	node_shader_write_attrib_frag(kong,"var tex_coord: float2 = input.tex_coord;");
	parser_material_init();
	gc_unroot(parser_material_canvases);parser_material_canvases=any_array_create_from_raw((any[]){context_raw->material->canvas,},1);gc_root(parser_material_canvases);
	gc_unroot(parser_material_nodes);parser_material_nodes=context_raw->material->canvas->nodes;gc_root(parser_material_nodes);
	gc_unroot(parser_material_links);parser_material_links=context_raw->material->canvas->links;gc_root(parser_material_links);
	if(group!=null){
		parser_material_push_group(group);
		gc_unroot(parser_material_parents);parser_material_parents=parents;gc_root(parser_material_parents);
	}
	ui_node_link_t_array_t * links=parser_material_links;
	ui_node_link_t * link=GC_ALLOC_INIT(ui_node_link_t, {.id=ui_next_link_id(links),.from_id=node->id,.from_socket=context_raw->node_preview_socket,.to_id=-1,.to_socket=-1});
	any_array_push(links,link);
	gc_unroot(parser_material_con);parser_material_con=con_mesh;gc_root(parser_material_con);
	gc_unroot(parser_material_kong);parser_material_kong=kong;gc_root(parser_material_kong);
	gc_unroot(parser_material_matcon);parser_material_matcon=matcon;gc_root(parser_material_matcon);
	parser_material_transform_color_space=false;
	string_t * res=parser_material_write_result(link);
	parser_material_transform_color_space=true;
	string_t * st=node->outputs->buffer[link->from_socket]->type;
	if(!string_equals(st,"RGB")&&!string_equals(st,"RGBA")&&!string_equals(st,"VECTOR")){
		res=string_copy(parser_material_to_vec3(res));
	}
	array_remove(links,link);
	kong->frag_out="float4";
	node_shader_write_frag(kong,string_join(string_join("var basecol: float3 = ",res),";"));
	node_shader_write_frag(kong,"output = float4(basecol.rgb, 1.0);");
	parser_material_finalize(con_mesh);
	con_mesh->data->shader_from_source=true;
	gpu_create_shaders_from_kong(node_shader_get(kong),ADDRESS(con_mesh->data->vertex_shader),ADDRESS(con_mesh->data->fragment_shader),ADDRESS(con_mesh->data->_->vertex_shader_size),ADDRESS(con_mesh->data->_->fragment_shader_size));
	return con_mesh;
}

bool make_paint_is_raytraced_bake(){
	return context_raw->bake_type==bake_type_t_INIT;
}

string_t_array_t * make_paint_color_attachments(){
	if(context_raw->tool==workspace_tool_t_COLORID){
		string_t_array_t * res=any_array_create_from_raw((any[]){"RGBA32",},1);
		return res;
	}
	if(context_raw->tool==workspace_tool_t_PICKER&&context_raw->pick_pos_nor_tex){
		string_t_array_t * res=any_array_create_from_raw((any[]){"RGBA128","RGBA128",},2);
		return res;
	}
	if(context_raw->tool==workspace_tool_t_PICKER||context_raw->tool==workspace_tool_t_MATERIAL){
		string_t_array_t * res=any_array_create_from_raw((any[]){"RGBA32","RGBA32","RGBA32","RGBA32",},4);
		return res;
	}
	if(context_raw->tool==workspace_tool_t_BAKE&&make_paint_is_raytraced_bake()){
		string_t_array_t * res=any_array_create_from_raw((any[]){"RGBA64","RGBA64",},2);
		return res;
	}
	tex_format_t format=base_bits_handle->position==texture_bits_t_BITS8?tex_format_t_RGBA32:base_bits_handle->position==texture_bits_t_BITS16?tex_format_t_RGBA64:tex_format_t_RGBA128;
	if(format==tex_format_t_RGBA64){
		string_t_array_t * res=any_array_create_from_raw((any[]){"RGBA64","RGBA64","RGBA64","R8",},4);
		return res;
	}
	if(format==tex_format_t_RGBA128){
		string_t_array_t * res=any_array_create_from_raw((any[]){"RGBA128","RGBA128","RGBA128","R8",},4);
		return res;
	}
	string_t_array_t * res=any_array_create_from_raw((any[]){"RGBA32","RGBA32","RGBA32","R8",},4);
	return res;
}

node_shader_context_t * make_paint_run(material_t * data,material_context_t * matcon){
	string_t * context_id="paint";
	shader_context_t * props=GC_ALLOC_INIT(shader_context_t, {.name=context_id,.depth_write=false,.compare_mode="always",.cull_mode="none",.vertex_elements=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_element_t, {.name="pos",.data="short4norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="nor",.data="short2norm"}),GC_ALLOC_INIT(vertex_element_t, {.name="tex",.data="short2norm"}),},3),.color_attachments=make_paint_color_attachments()});
	node_shader_context_t * con_paint=node_shader_context_create(data,props);
	con_paint->data->color_writes_red=u8_array_create_from_raw((u8[]){true,true,true,true,},4);
	con_paint->data->color_writes_green=u8_array_create_from_raw((u8[]){true,true,true,true,},4);
	con_paint->data->color_writes_blue=u8_array_create_from_raw((u8[]){true,true,true,true,},4);
	con_paint->data->color_writes_alpha=u8_array_create_from_raw((u8[]){true,true,true,true,},4);
	con_paint->allow_vcols=mesh_data_get_vertex_array(context_raw->paint_object->data,"col")!=null;
	node_shader_t * kong=node_shader_context_make_kong(con_paint);
	if(context_raw->tool==workspace_tool_t_BAKE&&context_raw->bake_type==bake_type_t_INIT){
		make_bake_position_normal(kong);
		con_paint->data->shader_from_source=true;
		gpu_create_shaders_from_kong(node_shader_get(kong),ADDRESS(con_paint->data->vertex_shader),ADDRESS(con_paint->data->fragment_shader),ADDRESS(con_paint->data->_->vertex_shader_size),ADDRESS(con_paint->data->_->fragment_shader_size));
		return con_paint;
	}
	if(context_raw->tool==workspace_tool_t_BAKE){
		make_bake_set_color_writes(con_paint);
	}
	if(context_raw->tool==workspace_tool_t_COLORID||context_raw->tool==workspace_tool_t_PICKER||context_raw->tool==workspace_tool_t_MATERIAL){
		make_colorid_picker_run(kong);
		con_paint->data->shader_from_source=true;
		gpu_create_shaders_from_kong(node_shader_get(kong),ADDRESS(con_paint->data->vertex_shader),ADDRESS(con_paint->data->fragment_shader),ADDRESS(con_paint->data->_->vertex_shader_size),ADDRESS(con_paint->data->_->fragment_shader_size));
		return con_paint;
	}
	bool face_fill=context_raw->tool==workspace_tool_t_FILL&&context_raw->fill_type_handle->position==fill_type_t_FACE;
	bool uv_island_fill=context_raw->tool==workspace_tool_t_FILL&&context_raw->fill_type_handle->position==fill_type_t_UV_ISLAND;
	bool decal=context_is_decal();
	node_shader_write_vert(kong,"var tpos: float2 = float2(input.tex.x * 2.0 - 1.0, (1.0 - input.tex.y) * 2.0 - 1.0);");
	node_shader_write_vert(kong,"output.pos = float4(tpos, 0.0, 1.0);");
	bool decal_layer=context_raw->layer->fill_layer!=null&&context_raw->layer->uv_type==uv_type_t_PROJECT;
	if(decal_layer){
		node_shader_add_constant(kong,"WVP: float4x4","_decal_layer_matrix");
	}
	else {
		node_shader_add_constant(kong,"WVP: float4x4","_world_view_proj_matrix");
	}
	node_shader_add_out(kong,"ndc: float4");
	node_shader_write_attrib_vert(kong,"output.ndc = constants.WVP * float4(input.pos.xyz, 1.0);");
	node_shader_write_attrib_frag(kong,"var sp: float3 = (input.ndc.xyz / input.ndc.w) * 0.5 + 0.5;");
	node_shader_write_attrib_frag(kong,"sp.y = 1.0 - sp.y;");
	node_shader_write_attrib_frag(kong,"sp.z -= 0.0001;");
	uv_type_t uv_type=context_raw->layer->fill_layer!=null?context_raw->layer->uv_type:context_raw->brush_paint;
	if(uv_type==uv_type_t_PROJECT){
		kong->frag_ndcpos=true;
	}
	node_shader_add_constant(kong,"inp: float4","_input_brush");
	node_shader_add_constant(kong,"inplast: float4","_input_brush_last");
	node_shader_add_constant(kong,"aspect_ratio: float","_aspect_ratio_window");
	node_shader_write_frag(kong,"var bsp: float2 = sp.xy * 2.0 - 1.0;");
	node_shader_write_frag(kong,"bsp.x *= constants.aspect_ratio;");
	node_shader_write_frag(kong,"bsp = bsp * 0.5 + 0.5;");
	node_shader_add_texture(kong,"gbufferD",null);
	kong->frag_out="float4[4]";
	node_shader_add_constant(kong,"brush_radius: float","_brush_radius");
	node_shader_add_constant(kong,"brush_opacity: float","_brush_opacity");
	node_shader_add_constant(kong,"brush_hardness: float","_brush_hardness");
	if(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER||context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE||context_raw->tool==workspace_tool_t_PARTICLE||decal){
		bool depth_reject=!context_raw->xray;
		if(config_raw->brush_3d&&!config_raw->brush_depth_reject){
			depth_reject=false;
		}
		bool particle=context_raw->tool==workspace_tool_t_PARTICLE;
		if(config_raw->brush_3d&&!decal&&!particle){
			if(make_material_height_used||context_raw->sym_x||context_raw->sym_y||context_raw->sym_z){
				depth_reject=false;
			}
		}
		if(depth_reject){
			node_shader_write_frag(kong,"if (sp.z > sample_lod(gbufferD, sampler_linear, sp.xy, 0.0).r - 0.00005) { discard; }");
		}
		make_brush_run(kong);
	}
	else {
		node_shader_write_frag(kong,"var dist: float = 0.0;");
		bool angle_fill=context_raw->tool==workspace_tool_t_FILL&&context_raw->fill_type_handle->position==fill_type_t_ANGLE;
		if(angle_fill){
			node_shader_add_function(kong,str_octahedron_wrap);
			node_shader_add_texture(kong,"gbuffer0",null);
			node_shader_write_frag(kong,"var g0: float2 = sample_lod(gbuffer0, sampler_linear, constants.inp.xy, 0.0).rg;");
			node_shader_write_frag(kong,"var wn: float3;");
			node_shader_write_frag(kong,"wn.z = 1.0 - abs(g0.x) - abs(g0.y);");
			node_shader_write_frag(kong,"if (wn.z >= 0.0) { wn.x = g0.x; wn.y = g0.y; } else { var f2: float2 = octahedron_wrap(g0.xy); wn.x = f2.x; wn.y = f2.y; }");
			node_shader_write_frag(kong,"wn = normalize(wn);");
			kong->frag_n=true;
			f32 angle=context_raw->brush_angle_reject_dot;
			node_shader_write_frag(kong,string_join(string_join("if (dot(wn, n) < ",f32_to_string(angle)),") { discard; }"));
		}
		bool stencil_fill=context_raw->tool==workspace_tool_t_FILL&&context_raw->brush_stencil_image!=null;
		if(stencil_fill){
			node_shader_write_frag(kong,"if (sp.z > sample_lod(gbufferD, sampler_linear, sp.xy, 0.0).r - 0.00005) { discard; }");
		}
	}
	if(context_raw->colorid_picked||face_fill||uv_island_fill){
		node_shader_add_out(kong,"tex_coord_pick: float2");
		node_shader_write_vert(kong,"output.tex_coord_pick = input.tex;");
		if(context_raw->colorid_picked){
			make_discard_color_id(kong);
		}
		if(face_fill){
			make_discard_face(kong);
		}
		else if(uv_island_fill){
			make_discard_uv_island(kong);
		}
	}
	if(context_raw->picker_mask_handle->position==picker_mask_t_MATERIAL){
		make_discard_material_id(kong);
	}
	make_texcoord_run(kong);
	if(context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE){
		node_shader_add_texture(kong,"gbuffer2",null);
		node_shader_add_constant(kong,"gbuffer_size: float2","_gbuffer_size");
		node_shader_add_texture(kong,"texpaint_undo","_texpaint_undo");
		node_shader_add_texture(kong,"texpaint_nor_undo","_texpaint_nor_undo");
		node_shader_add_texture(kong,"texpaint_pack_undo","_texpaint_pack_undo");
		if(context_raw->tool==workspace_tool_t_CLONE){
			make_clone_run(kong);
		}
		else {
			make_blur_run(kong);
		}
	}
	else {
		parser_material_parse_emission=context_raw->material->paint_emis;
		parser_material_parse_subsurface=context_raw->material->paint_subs;
		parser_material_parse_height=context_raw->material->paint_height;
		parser_material_parse_height_as_channel=true;
		uv_type_t uv_type=context_raw->layer->fill_layer!=null?context_raw->layer->uv_type:context_raw->brush_paint;
		parser_material_triplanar=uv_type==uv_type_t_TRIPLANAR&&!decal;
		parser_material_sample_keep_aspect=decal;
		gc_unroot(parser_material_sample_uv_scale);parser_material_sample_uv_scale="constants.brush_scale";gc_root(parser_material_sample_uv_scale);
		shader_out_t * sout=parser_material_parse(ui_nodes_get_canvas_material(),con_paint,kong,matcon);
		parser_material_parse_emission=false;
		parser_material_parse_subsurface=false;
		parser_material_parse_height_as_channel=false;
		parser_material_parse_height=false;
		string_t * base=sout->out_basecol;
		string_t * rough=sout->out_roughness;
		string_t * met=sout->out_metallic;
		string_t * occ=sout->out_occlusion;
		string_t * nortan=parser_material_out_normaltan;
		string_t * height=sout->out_height;
		string_t * opac=sout->out_opacity;
		string_t * emis=sout->out_emission;
		string_t * subs=sout->out_subsurface;
		node_shader_write_frag(kong,string_join(string_join("var basecol: float3 = ",base),";"));
		node_shader_write_frag(kong,string_join(string_join("var roughness: float = ",rough),";"));
		node_shader_write_frag(kong,string_join(string_join("var metallic: float = ",met),";"));
		node_shader_write_frag(kong,string_join(string_join("var occlusion: float = ",occ),";"));
		node_shader_write_frag(kong,string_join(string_join("var nortan: float3 = ",nortan),";"));
		node_shader_write_frag(kong,string_join(string_join("var height: float = ",height),";"));
		node_shader_write_frag(kong,string_join(string_join("var mat_opacity: float = ",opac),";"));
		node_shader_write_frag(kong,"var opacity: float = mat_opacity;");
		if(context_raw->layer->fill_layer==null){
			node_shader_write_frag(kong,"opacity *= constants.brush_opacity;");
		}
		if(context_raw->material->paint_emis){
			node_shader_write_frag(kong,string_join(string_join("var emis: float = ",emis),";"));
		}
		if(context_raw->material->paint_subs){
			node_shader_write_frag(kong,string_join(string_join("var subs: float = ",subs),";"));
		}
		if(!make_material_height_used&&parse_float(height)!=0.0){
			make_material_height_used=true;
			return make_paint_run(data,matcon);
		}
		make_material_emis_used=parse_float(emis)!=0.0;
		make_material_subs_used=parse_float(subs)!=0.0;
	}
	if(context_raw->brush_mask_image!=null&&context_raw->tool==workspace_tool_t_DECAL){
		node_shader_add_texture(kong,"texbrushmask","_texbrushmask");
		node_shader_write_frag(kong,"var mask_sample: float4 = sample_lod(texbrushmask, sampler_linear, uvsp, 0.0);");
		if(context_raw->brush_mask_image_is_alpha){
			node_shader_write_frag(kong,"opacity *= mask_sample.a;");
		}
		else {
			node_shader_write_frag(kong,"opacity *= mask_sample.r * mask_sample.a;");
		}
	}
	else if(context_raw->tool==workspace_tool_t_TEXT){
		node_shader_add_texture(kong,"textexttool","_textexttool");
		node_shader_write_frag(kong,"opacity *= sample_lod(textexttool, sampler_linear, uvsp, 0.0).r;");
	}
	if(context_raw->brush_stencil_image!=null&&(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER||context_raw->tool==workspace_tool_t_FILL||context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE||context_raw->tool==workspace_tool_t_PARTICLE||decal)){
		node_shader_add_texture(kong,"texbrushstencil","_texbrushstencil");
		node_shader_add_constant(kong,"texbrushstencil_size: float2","_size(_texbrushstencil)");
		node_shader_add_constant(kong,"stencil_transform: float4","_stencil_transform");
		node_shader_write_frag(kong,"var stencil_uv: float2 = (sp.xy - constants.stencil_transform.xy) / constants.stencil_transform.z * float2(constants.aspect_ratio, 1.0);");
		node_shader_write_frag(kong,"var stencil_size: float2 = constants.texbrushstencil_size;");
		node_shader_write_frag(kong,"var stencil_ratio: float = stencil_size.y / stencil_size.x;");
		node_shader_write_frag(kong,"stencil_uv -= float2(0.5 / stencil_ratio, 0.5);");
		node_shader_write_frag(kong,"stencil_uv = float2(stencil_uv.x * cos(constants.stencil_transform.w) - stencil_uv.y * sin(constants.stencil_transform.w),\
												   stencil_uv.x * sin(constants.stencil_transform.w) + stencil_uv.y * cos(constants.stencil_transform.w));");
		node_shader_write_frag(kong,"stencil_uv += float2(0.5 / stencil_ratio, 0.5);");
		node_shader_write_frag(kong,"stencil_uv.x *= stencil_ratio;");
		node_shader_write_frag(kong,"if (stencil_uv.x < 0.0 || stencil_uv.x > 1.0 || stencil_uv.y < 0.0 || stencil_uv.y > 1.0) { discard; }");
		node_shader_write_frag(kong,"var texbrushstencil_sample: float4 = sample_lod(texbrushstencil, sampler_linear, stencil_uv, 0.0);");
		if(context_raw->brush_stencil_image_is_alpha){
			node_shader_write_frag(kong,"opacity *= texbrushstencil_sample.a;");
		}
		else {
			node_shader_write_frag(kong,"opacity *= texbrushstencil_sample.r * texbrushstencil_sample.a;");
		}
	}
	if(context_raw->brush_mask_image!=null&&(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER)){
		node_shader_add_texture(kong,"texbrushmask","_texbrushmask");
		node_shader_write_frag(kong,"var binp_mask: float2 = constants.inp.xy * 2.0 - 1.0;");
		node_shader_write_frag(kong,"binp_mask.x *= constants.aspect_ratio;");
		node_shader_write_frag(kong,"binp_mask = binp_mask * 0.5 + 0.5;");
		node_shader_write_frag(kong,"var pa_mask: float2 = bsp.xy - binp_mask.xy;");
		if(context_raw->brush_directional){
			node_shader_add_constant(kong,"brush_direction: float3","_brush_direction");
			node_shader_write_frag(kong,"if (constants.brush_direction.z == 0.0) { discard; }");
			node_shader_write_frag(kong,"pa_mask = float2(pa_mask.x * constants.brush_direction.x - pa_mask.y * constants.brush_direction.y, pa_mask.x * constants.brush_direction.y + pa_mask.y * constants.brush_direction.x);");
		}
		f32 angle=context_raw->brush_angle+context_raw->brush_nodes_angle;
		if(angle!=0.0){
			node_shader_add_constant(kong,"brush_angle: float2","_brush_angle");
			node_shader_write_frag(kong,"pa_mask.xy = float2(pa_mask.x * constants.brush_angle.x - pa_mask.y * constants.brush_angle.y, pa_mask.x * constants.brush_angle.y + pa_mask.y * constants.brush_angle.x);");
		}
		node_shader_write_frag(kong,"pa_mask = pa_mask / constants.brush_radius;");
		if(config_raw->brush_3d){
			node_shader_add_constant(kong,"eye: float3","_camera_pos");
			node_shader_write_frag(kong,"pa_mask = pa_mask * (distance(constants.eye, winp.xyz) / 1.5);");
		}
		node_shader_write_frag(kong,"pa_mask = pa_mask.xy * 0.5 + 0.5;");
		node_shader_write_frag(kong,"var mask_sample: float4 = sample_lod(texbrushmask, sampler_linear, pa_mask, 0.0);");
		if(context_raw->brush_mask_image_is_alpha){
			node_shader_write_frag(kong,"opacity *= mask_sample.a;");
		}
		else {
			node_shader_write_frag(kong,"opacity *= mask_sample.r * mask_sample.a;");
		}
	}
	node_shader_write_frag(kong,"if (opacity == 0.0) { discard; }");
	if(context_raw->tool==workspace_tool_t_PARTICLE){
		make_particle_mask(kong);
	}
	else {
		node_shader_write_frag(kong,"var str: float = clamp((constants.brush_radius - dist) * constants.brush_hardness * 400.0, 0.0, 1.0) * opacity;");
	}
	kong->frag_wvpposition=true;
	node_shader_write_frag(kong,"var sample_tc: float2 = float2(input.wvpposition.x / input.wvpposition.w, input.wvpposition.y / input.wvpposition.w) * 0.5 + 0.5;");
	node_shader_write_frag(kong,"sample_tc.y = 1.0 - sample_tc.y;");
	node_shader_add_texture(kong,"paintmask",null);
	node_shader_write_frag(kong,"var sample_mask: float = sample_lod(paintmask, sampler_linear, sample_tc, 0.0).r;");
	node_shader_write_frag(kong,"str = max(str, sample_mask);");
	node_shader_add_texture(kong,"texpaint_undo","_texpaint_undo");
	node_shader_write_frag(kong,"var sample_undo: float4 = sample_lod(texpaint_undo, sampler_linear, sample_tc, 0.0);");
	f32 matid=context_raw->material->id/(float)255;
	if(context_raw->picker_mask_handle->position==picker_mask_t_MATERIAL){
		matid=context_raw->materialid_picked/(float)255;
	}
	string_t * matid_string=parser_material_vec1(matid*3.0);
	node_shader_write_frag(kong,string_join(string_join("var matid: float = ",matid_string),";"));
	if(context_raw->material->paint_emis&&make_material_emis_used){
		node_shader_write_frag(kong,"if (emis > 0.0) {");
		node_shader_write_frag(kong,"	matid += 1.0 / 255.0;");
		node_shader_write_frag(kong,"	if (str == 0.0) { discard; }");
		node_shader_write_frag(kong,"}");
	}
	else if(context_raw->material->paint_subs&&make_material_subs_used){
		node_shader_write_frag(kong,"if (subs > 0.0) {");
		node_shader_write_frag(kong,"	matid += 2.0 / 255.0;");
		node_shader_write_frag(kong,"	if (str == 0.0) { discard; }");
		node_shader_write_frag(kong,"}");
	}
	bool is_mask=slot_layer_is_mask(context_raw->layer);
	bool layered=context_raw->layer!=project_layers->buffer[0];
	if(layered&&!is_mask){
		if(context_raw->tool==workspace_tool_t_ERASER){
			node_shader_write_frag(kong,"output[0] = float4(lerp3(sample_undo.rgb, float3(0.0, 0.0, 0.0), str), sample_undo.a - str);");
			node_shader_write_frag(kong,"nortan = float3(0.5, 0.5, 1.0);");
			node_shader_write_frag(kong,"occlusion = 1.0;");
			node_shader_write_frag(kong,"roughness = 0.0;");
			node_shader_write_frag(kong,"metallic = 0.0;");
			node_shader_write_frag(kong,"matid = 0.0;");
		}
		else if(context_raw->tool==workspace_tool_t_PARTICLE||decal||context_raw->brush_mask_image!=null){
			node_shader_write_frag(kong,string_join(string_join("output[0] = float4(",make_material_blend_mode(kong,context_raw->brush_blending,"sample_undo.rgb","basecol","str")),", max(str, sample_undo.a));"));
		}
		else {
			if(context_raw->layer->fill_layer!=null){
				node_shader_write_frag(kong,string_join(string_join("output[0] = float4(",make_material_blend_mode(kong,context_raw->brush_blending,"sample_undo.rgb","basecol","opacity")),", mat_opacity);"));
			}
			else {
				node_shader_write_frag(kong,string_join(string_join("output[0] = float4(",make_material_blend_mode(kong,context_raw->brush_blending,"sample_undo.rgb","basecol","opacity")),", max(str, sample_undo.a));"));
			}
		}
		node_shader_write_frag(kong,"output[1] = float4(nortan, matid);");
		string_t * height="0.0";
		if(context_raw->material->paint_height&&make_material_height_used){
			height="height";
		}
		if(decal){
			node_shader_add_texture(kong,"texpaint_pack_undo","_texpaint_pack_undo");
			node_shader_write_frag(kong,"var sample_pack_undo: float4 = sample_lod(texpaint_pack_undo, sampler_linear, sample_tc, 0.0);");
			node_shader_write_frag(kong,string_join(string_join("output[2] = lerp4(sample_pack_undo, float4(occlusion, roughness, metallic, ",height),"), str);"));
		}
		else {
			node_shader_write_frag(kong,string_join(string_join("output[2] = float4(occlusion, roughness, metallic, ",height),");"));
		}
	}
	else {
		if(context_raw->tool==workspace_tool_t_ERASER){
			node_shader_write_frag(kong,"output[0] = float4(lerp3(sample_undo.rgb, float3(0.0, 0.0, 0.0), str), sample_undo.a - str);");
			node_shader_write_frag(kong,"output[1] = float4(0.5, 0.5, 1.0, 0.0);");
			node_shader_write_frag(kong,"output[2] = float4(1.0, 0.0, 0.0, 0.0);");
		}
		else {
			node_shader_add_texture(kong,"texpaint_nor_undo","_texpaint_nor_undo");
			node_shader_add_texture(kong,"texpaint_pack_undo","_texpaint_pack_undo");
			node_shader_write_frag(kong,"var sample_nor_undo: float4 = sample_lod(texpaint_nor_undo, sampler_linear, sample_tc, 0.0);");
			node_shader_write_frag(kong,"var sample_pack_undo: float4 = sample_lod(texpaint_pack_undo, sampler_linear, sample_tc, 0.0);");
			node_shader_write_frag(kong,string_join(string_join("output[0] = float4(",make_material_blend_mode(kong,context_raw->brush_blending,"sample_undo.rgb","basecol","str")),", max(str, sample_undo.a));"));
			node_shader_write_frag(kong,"output[1] = float4(lerp3(sample_nor_undo.rgb, nortan, str), matid);");
			if(context_raw->material->paint_height&&make_material_height_used){
				node_shader_write_frag(kong,"output[2] = lerp4(sample_pack_undo, float4(occlusion, roughness, metallic, height), str);");
			}
			else {
				node_shader_write_frag(kong,"output[2] = float4(lerp3(sample_pack_undo.rgb, float3(occlusion, roughness, metallic), str), 0.0);");
			}
		}
	}
	node_shader_write_frag(kong,"output[3] = float4(str, 0.0, 0.0, 1.0);");
	if(!context_raw->material->paint_base){
		con_paint->data->color_writes_red->buffer[0]=false;
		con_paint->data->color_writes_green->buffer[0]=false;
		con_paint->data->color_writes_blue->buffer[0]=false;
	}
	if(!context_raw->material->paint_opac){
		con_paint->data->color_writes_alpha->buffer[0]=false;
	}
	if(!context_raw->material->paint_nor){
		con_paint->data->color_writes_red->buffer[1]=false;
		con_paint->data->color_writes_green->buffer[1]=false;
		con_paint->data->color_writes_blue->buffer[1]=false;
	}
	if(!context_raw->material->paint_occ){
		con_paint->data->color_writes_red->buffer[2]=false;
	}
	if(!context_raw->material->paint_rough){
		con_paint->data->color_writes_green->buffer[2]=false;
	}
	if(!context_raw->material->paint_met){
		con_paint->data->color_writes_blue->buffer[2]=false;
	}
	if(!context_raw->material->paint_height){
		con_paint->data->color_writes_alpha->buffer[2]=false;
	}
	if(is_mask){
		con_paint->data->color_writes_green->buffer[0]=false;
		con_paint->data->color_writes_blue->buffer[0]=false;
		con_paint->data->color_writes_alpha->buffer[0]=false;
		con_paint->data->color_writes_red->buffer[1]=false;
		con_paint->data->color_writes_green->buffer[1]=false;
		con_paint->data->color_writes_blue->buffer[1]=false;
		con_paint->data->color_writes_alpha->buffer[1]=false;
		con_paint->data->color_writes_red->buffer[2]=false;
		con_paint->data->color_writes_green->buffer[2]=false;
		con_paint->data->color_writes_blue->buffer[2]=false;
		con_paint->data->color_writes_alpha->buffer[2]=false;
	}
	if(context_raw->tool==workspace_tool_t_BAKE){
		make_bake_run(con_paint,kong);
	}
	parser_material_finalize(con_paint);
	parser_material_triplanar=false;
	parser_material_sample_keep_aspect=false;
	con_paint->data->shader_from_source=true;
	gpu_create_shaders_from_kong(node_shader_get(kong),ADDRESS(con_paint->data->vertex_shader),ADDRESS(con_paint->data->fragment_shader),ADDRESS(con_paint->data->_->vertex_shader_size),ADDRESS(con_paint->data->_->fragment_shader_size));
	return con_paint;
}

void make_particle_mask(node_shader_t * kong){
	node_shader_add_out(kong,"wpos: float4");
	node_shader_add_constant(kong,"W: float4x4","_world_matrix");
	node_shader_write_attrib_vert(kong,"output.wpos = constants.W * float4(input.pos.xyz, 1.0);");
	node_shader_add_constant(kong,"particle_hit: float3","_particle_hit");
	node_shader_add_constant(kong,"particle_hit_last: float3","_particle_hit_last");
	node_shader_write_frag(kong,"var pa: float3 = input.wpos.xyz - constants.particle_hit;");
	node_shader_write_frag(kong,"var ba: float3 = constants.particle_hit_last - constants.particle_hit;");
	node_shader_write_frag(kong,"var h: float = clamp(dot(pa, ba) / dot(ba, ba), 0.0, 1.0);");
	node_shader_write_frag(kong,"dist = length(pa - ba * h) * 10.0;");
	node_shader_write_frag(kong,"if (dist > 1.0) { discard; }");
	node_shader_write_frag(kong,"var str: float = clamp(pow(1.0 / dist * constants.brush_hardness * 0.2, 4.0), 0.0, 1.0) * opacity;");
	node_shader_write_frag(kong,"if (constants.particle_hit.x == 0.0 && constants.particle_hit.y == 0.0 && constants.particle_hit.z == 0.0) { str = 0.0; }");
	node_shader_write_frag(kong,"if (str == 0.0) { discard; }");
}

void make_texcoord_run(node_shader_t * kong){
	bool fill_layer=context_raw->layer->fill_layer!=null;
	uv_type_t uv_type=fill_layer?context_raw->layer->uv_type:context_raw->brush_paint;
	bool decal=context_is_decal();
	f32 angle=context_raw->brush_angle+context_raw->brush_nodes_angle;
	f32 uv_angle=fill_layer?context_raw->layer->angle:angle;
	if(uv_type==uv_type_t_PROJECT||decal){
		node_shader_add_constant(kong,"brush_scale: float","_brush_scale");
		node_shader_write_attrib_frag(kong,"var uvsp: float2 = sp.xy;");
		if(fill_layer){
			node_shader_write_attrib_frag(kong,"if (uvsp.x < 0.0 || uvsp.y < 0.0 || uvsp.x > 1.0 || uvsp.y > 1.0) { discard; }");
			if(uv_angle!=0.0){
				node_shader_add_constant(kong,"brush_angle: float2","_brush_angle");
				node_shader_write_attrib_frag(kong,"uvsp = float2(uvsp.x * constants.brush_angle.x - uvsp.y * constants.brush_angle.y, uvsp.x * constants.brush_angle.y + uvsp.y * constants.brush_angle.x);");
			}
			kong->frag_n=true;
			node_shader_add_constant(kong,"decal_layer_nor: float3","_decal_layer_nor");
			f32 dot_angle=context_raw->brush_angle_reject_dot;
			node_shader_write_frag(kong,string_join(string_join("if (abs(dot(n, constants.decal_layer_nor) - 1.0) > ",f32_to_string(dot_angle)),") { discard; }"));
			kong->frag_wposition=true;
			node_shader_add_constant(kong,"decal_layer_loc: float3","_decal_layer_loc");
			node_shader_add_constant(kong,"decal_layer_dim: float","_decal_layer_dim");
			node_shader_write_attrib_frag(kong,"if (abs(dot(constants.decal_layer_nor, constants.decal_layer_loc - input.wposition)) > constants.decal_layer_dim) { discard; }");
		}
		else if(decal){
			node_shader_add_constant(kong,"decal_mask: float4","_decal_mask");
			node_shader_write_attrib_frag(kong,"uvsp = uvsp - constants.decal_mask.xy;");
			node_shader_write_attrib_frag(kong,"uvsp.x *= constants.aspect_ratio;");
			node_shader_write_attrib_frag(kong,"uvsp = uvsp * (0.21 / (constants.decal_mask.w * 0.9));");
			if(context_raw->brush_directional){
				node_shader_add_constant(kong,"brush_direction: float3","_brush_direction");
				node_shader_write_attrib_frag(kong,"if (constants.brush_direction.z == 0.0) { discard; }");
				node_shader_write_attrib_frag(kong,"uvsp = float2(uvsp.x * constants.brush_direction.x - uvsp.y * constants.brush_direction.y, uvsp.x * constants.brush_direction.y + uvsp.y * constants.brush_direction.x);");
			}
			if(uv_angle!=0.0){
				node_shader_add_constant(kong,"brush_angle: float2","_brush_angle");
				node_shader_write_attrib_frag(kong,"uvsp = float2(uvsp.x * constants.brush_angle.x - uvsp.y * constants.brush_angle.y, uvsp.x * constants.brush_angle.y + uvsp.y * constants.brush_angle.x);");
			}
			node_shader_add_constant(kong,"brush_scale_x: float","_brush_scale_x");
			node_shader_write_attrib_frag(kong,"uvsp.x *= constants.brush_scale_x;");
			node_shader_write_attrib_frag(kong,"uvsp += float2(0.5, 0.5);");
			node_shader_write_attrib_frag(kong,"if (uvsp.x < 0.0 || uvsp.y < 0.0 || uvsp.x > 1.0 || uvsp.y > 1.0) { discard; }");
		}
		else {
			node_shader_write_attrib_frag(kong,"uvsp.x *= constants.aspect_ratio;");
			if(uv_angle!=0.0){
				node_shader_add_constant(kong,"brush_angle: float2","_brush_angle");
				node_shader_write_attrib_frag(kong,"uvsp = float2(uvsp.x * constants.brush_angle.x - uvsp.y * constants.brush_angle.y, uvsp.x * constants.brush_angle.y + uvsp.y * constants.brush_angle.x);");
			}
		}
		node_shader_write_attrib_frag(kong,"var tex_coord: float2 = uvsp * constants.brush_scale;");
	}
	else if(uv_type==uv_type_t_UVMAP){
		node_shader_add_constant(kong,"brush_scale: float","_brush_scale");
		node_shader_add_out(kong,"tex_coord: float2");
		node_shader_write_vert(kong,"output.tex_coord = input.tex * constants.brush_scale;");
		if(uv_angle>0.0){
			node_shader_add_constant(kong,"brush_angle: float2","_brush_angle");
			node_shader_write_vert(kong,"output.tex_coord = float2(output.tex_coord.x * constants.brush_angle.x - output.tex_coord.y * constants.brush_angle.y, output.tex_coord.x * constants.brush_angle.y + output.tex_coord.y * constants.brush_angle.x);");
		}
		node_shader_write_attrib_frag(kong,"var tex_coord: float2 = input.tex_coord;");
	}
	else {
		kong->frag_wposition=true;
		kong->frag_n=true;
		node_shader_add_constant(kong,"brush_scale: float","_brush_scale");
		node_shader_write_attrib_frag(kong,"var tri_weight: float3 = input.wnormal * input.wnormal;");
		node_shader_write_attrib_frag(kong,"var tri_max: float = max(tri_weight.x, max(tri_weight.y, tri_weight.z));");
		node_shader_write_attrib_frag(kong,"tri_weight = max3(tri_weight - tri_max * 0.75, 0.0);");
		node_shader_write_attrib_frag(kong,"var tex_coord_blend: float3 = tri_weight * (1.0 / (tri_weight.x + tri_weight.y + tri_weight.z));");
		node_shader_write_attrib_frag(kong,"var tex_coord: float2 = input.wposition.yz * constants.brush_scale * 0.5;");
		node_shader_write_attrib_frag(kong,"var tex_coord1: float2 = input.wposition.xz * constants.brush_scale * 0.5;");
		node_shader_write_attrib_frag(kong,"var tex_coord2: float2 = input.wposition.xy * constants.brush_scale * 0.5;");
		if(uv_angle!=0.0){
			node_shader_add_constant(kong,"brush_angle: float2","_brush_angle");
			node_shader_write_attrib_frag(kong,"tex_coord = float2(tex_coord.x * constants.brush_angle.x - tex_coord.y * constants.brush_angle.y, tex_coord.x * constants.brush_angle.y + tex_coord.y * constants.brush_angle.x);");
			node_shader_write_attrib_frag(kong,"tex_coord1 = float2(tex_coord1.x * constants.brush_angle.x - tex_coord1.y * constants.brush_angle.y, tex_coord1.x * constants.brush_angle.y + tex_coord1.y * constants.brush_angle.x);");
			node_shader_write_attrib_frag(kong,"tex_coord2 = float2(tex_coord2.x * constants.brush_angle.x - tex_coord2.y * constants.brush_angle.y, tex_coord2.x * constants.brush_angle.y + tex_coord2.y * constants.brush_angle.x);");
		}
	}
}

void nodes_brush_init(){
	gc_unroot(nodes_brush_creates);nodes_brush_creates=any_map_create();gc_root(nodes_brush_creates);
	any_map_set(nodes_brush_creates,"brush_output_node",brush_output_node_create);
	any_map_set(nodes_brush_creates,"TEX_IMAGE",tex_image_node_create);
	any_map_set(nodes_brush_creates,"input_node",input_node_create);
	any_map_set(nodes_brush_creates,"math_node",math_node_create);
	any_map_set(nodes_brush_creates,"random_node",random_node_create);
	any_map_set(nodes_brush_creates,"separate_vector_node",separate_vector_node_create);
	any_map_set(nodes_brush_creates,"time_node",time_node_create);
	any_map_set(nodes_brush_creates,"float_node",float_node_create);
	any_map_set(nodes_brush_creates,"vector_node",vector_node_create);
	any_map_set(nodes_brush_creates,"vector_math_node",vector_math_node_create);
	nodes_brush_list_init();
}

void nodes_brush_list_init(){
	if(nodes_brush_list!=null){
		return ;
	}
	gc_unroot(nodes_brush_category0);nodes_brush_category0=any_array_create_from_raw((any[]){tex_image_node_def,input_node_def,math_node_def,random_node_def,separate_vector_node_def,time_node_def,float_node_def,vector_node_def,vector_math_node_def,},9);gc_root(nodes_brush_category0);
	gc_unroot(nodes_brush_list);nodes_brush_list=any_array_create_from_raw((any[]){nodes_brush_category0,},1);gc_root(nodes_brush_list);
}

ui_node_t * nodes_brush_create_node(string_t * node_type){
	for(i32 i=0;i<nodes_brush_list->length;++i){
		ui_node_t_array_t * c=nodes_brush_list->buffer[i];
		for(i32 i=0;i<c->length;++i){
			ui_node_t * n=c->buffer[i];
			if(string_equals(n->type,node_type)){
				ui_node_canvas_t * canvas=context_raw->brush->canvas;
				ui_nodes_t * nodes=context_raw->brush->nodes;
				ui_node_t * node=ui_nodes_make_node(n,nodes,canvas);
				any_array_push(canvas->nodes,node);
				return node;
			}
		}
	}
	return null;
}

void render_path_paint_init(){
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_blend0";
		t->width=config_get_texture_res_x();
		t->height=config_get_texture_res_y();
		t->format="R8";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_blend1";
		t->width=config_get_texture_res_x();
		t->height=config_get_texture_res_y();
		t->format="R8";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_colorid";
		t->width=1;
		t->height=1;
		t->format="RGBA32";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_picker";
		t->width=1;
		t->height=1;
		t->format="RGBA32";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_nor_picker";
		t->width=1;
		t->height=1;
		t->format="RGBA32";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_pack_picker";
		t->width=1;
		t->height=1;
		t->format="RGBA32";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_uv_picker";
		t->width=1;
		t->height=1;
		t->format="RGBA32";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_posnortex_picker0";
		t->width=1;
		t->height=1;
		t->format="RGBA128";
		render_path_create_render_target(t);
	}
		{
		render_target_t * t=render_target_create();
		t->name="texpaint_posnortex_picker1";
		t->width=1;
		t->height=1;
		t->format="RGBA128";
		render_path_create_render_target(t);
	}
	render_path_load_shader("shader_datas/copy_mrt3_pass/copy_mrt3_pass");
	render_path_load_shader("shader_datas/copy_mrt3_pass/copy_mrt3RGBA64_pass");
	render_path_load_shader("shader_datas/copy_mrt3_pass/copy_mrt3RGBA128_pass");
	render_path_load_shader("shader_datas/dilate_pass/dilate_pass");
	render_path_load_shader("shader_datas/dilate_pass/dilateRGBA64_pass");
	render_path_load_shader("shader_datas/dilate_pass/dilateRGBA128_pass");
}

void render_path_paint_draw_fullscreen_triangle(string_t * context){
	mesh_object_t * plane=scene_get_child(".Plane")->ext;
	bool _visible=plane->base->visible;
	plane->base->visible=true;
	mesh_object_render(plane,context,_render_path_bind_params);
	plane->base->visible=_visible;
	render_path_end();
}

void render_path_paint_commands_paint(bool dilation){
	i32 tid=context_raw->layer->id;
	if(context_raw->pdirty>0){
		if(context_raw->tool==workspace_tool_t_COLORID){
			render_path_set_target("texpaint_colorid",null,null,clear_flag_t_COLOR,0xff000000,0.0);
			render_path_bind_target("gbuffer2","gbuffer2");
			render_path_paint_draw_fullscreen_triangle("paint");
			ui_header_handle->redraws=2;
		}
		else if(context_raw->tool==workspace_tool_t_PICKER||context_raw->tool==workspace_tool_t_MATERIAL){
			if(context_raw->pick_pos_nor_tex){
				if(context_raw->paint2d){
					string_t_array_t * additional=any_array_create_from_raw((any[]){"gbuffer1","gbuffer2",},2);
					render_path_set_target("gbuffer0",additional,"main",clear_flag_t_NONE,0,0.0);
					render_path_draw_meshes("mesh");
				}
				string_t_array_t * additional=any_array_create_from_raw((any[]){"texpaint_posnortex_picker1",},1);
				render_path_set_target("texpaint_posnortex_picker0",additional,null,clear_flag_t_NONE,0,0.0);
				render_path_bind_target("gbuffer2","gbuffer2");
				render_path_bind_target("main","gbufferD");
				render_path_draw_meshes("paint");
				render_target_t * picker0=any_map_get(render_path_render_targets,"texpaint_posnortex_picker0");
				render_target_t * picker1=any_map_get(render_path_render_targets,"texpaint_posnortex_picker1");
				gpu_texture_t * texpaint_posnortex_picker0=picker0->_image;
				gpu_texture_t * texpaint_posnortex_picker1=picker1->_image;
				buffer_t * a=gpu_get_texture_pixels(texpaint_posnortex_picker0);
				buffer_t * b=gpu_get_texture_pixels(texpaint_posnortex_picker1);
				context_raw->posx_picked=buffer_get_f32(a,0);
				context_raw->posy_picked=buffer_get_f32(a,4);
				context_raw->posz_picked=buffer_get_f32(a,8);
				context_raw->uvx_picked=buffer_get_f32(a,12);
				context_raw->norx_picked=buffer_get_f32(b,0);
				context_raw->nory_picked=buffer_get_f32(b,4);
				context_raw->norz_picked=buffer_get_f32(b,8);
				context_raw->uvy_picked=buffer_get_f32(b,12);
			}
			else {
				string_t_array_t * additional=any_array_create_from_raw((any[]){"texpaint_nor_picker","texpaint_pack_picker","texpaint_uv_picker",},3);
				render_path_set_target("texpaint_picker",additional,null,clear_flag_t_NONE,0,0.0);
				render_path_bind_target("gbuffer2","gbuffer2");
				tid=context_raw->layer->id;
				bool use_live_layer=context_raw->tool==workspace_tool_t_MATERIAL;
				if(use_live_layer){
					render_path_paint_use_live_layer(true);
				}
				render_path_bind_target(string_join("texpaint",i32_to_string(tid)),"texpaint");
				render_path_bind_target(string_join("texpaint_nor",i32_to_string(tid)),"texpaint_nor");
				render_path_bind_target(string_join("texpaint_pack",i32_to_string(tid)),"texpaint_pack");
				render_path_paint_draw_fullscreen_triangle("paint");
				if(use_live_layer){
					render_path_paint_use_live_layer(false);
				}
				ui_header_handle->redraws=2;
				ui_base_hwnds->buffer[2]->redraws=2;
				render_target_t * texpaint_picker=any_map_get(render_path_render_targets,"texpaint_picker");
				render_target_t * texpaint_nor_picker=any_map_get(render_path_render_targets,"texpaint_nor_picker");
				render_target_t * texpaint_pack_picker=any_map_get(render_path_render_targets,"texpaint_pack_picker");
				render_target_t * texpaint_uv_picker=any_map_get(render_path_render_targets,"texpaint_uv_picker");
				buffer_t * a=gpu_get_texture_pixels(texpaint_picker->_image);
				buffer_t * b=gpu_get_texture_pixels(texpaint_nor_picker->_image);
				buffer_t * c=gpu_get_texture_pixels(texpaint_pack_picker->_image);
				buffer_t * d=gpu_get_texture_pixels(texpaint_uv_picker->_image);
				if(context_raw->color_picker_callback!=null){
					context_raw->color_picker_callback(context_raw->picked_color);
				}
				i32 i0=0;
				i32 i1=1;
				i32 i2=2;
				i32 i3=3;
				context_raw->picked_color->base=color_set_rb(context_raw->picked_color->base,buffer_get_u8(a,i0));
				context_raw->picked_color->base=color_set_gb(context_raw->picked_color->base,buffer_get_u8(a,i1));
				context_raw->picked_color->base=color_set_bb(context_raw->picked_color->base,buffer_get_u8(a,i2));
				context_raw->picked_color->normal=color_set_rb(context_raw->picked_color->normal,buffer_get_u8(b,i0));
				context_raw->picked_color->normal=color_set_gb(context_raw->picked_color->normal,buffer_get_u8(b,i1));
				context_raw->picked_color->normal=color_set_bb(context_raw->picked_color->normal,buffer_get_u8(b,i2));
				context_raw->picked_color->occlusion=buffer_get_u8(c,i0)/(float)255;
				context_raw->picked_color->roughness=buffer_get_u8(c,i1)/(float)255;
				context_raw->picked_color->metallic=buffer_get_u8(c,i2)/(float)255;
				context_raw->picked_color->height=buffer_get_u8(c,i3)/(float)255;
				context_raw->picked_color->opacity=buffer_get_u8(a,i3)/(float)255;
				context_raw->uvx_picked=buffer_get_u8(d,i0)/(float)255;
				context_raw->uvy_picked=buffer_get_u8(d,i1)/(float)255;
				if(context_raw->picker_select_material&&context_raw->color_picker_callback==null){
					i32 id=buffer_get_u8(b,3);
					i32 matid=math_floor((id-(id%3))/(float)3);
					for(i32 i=0;i<project_materials->length;++i){
						slot_material_t * m=project_materials->buffer[i];
						if(m->id==matid){
							context_set_material(m);
							context_raw->materialid_picked=matid;
							break;
						}
					}
				}
			}
		}
		else {
			string_t * texpaint=string_join("texpaint",i32_to_string(tid));
			if(context_raw->tool==workspace_tool_t_BAKE&&context_raw->brush_time==sys_delta()){
				render_path_set_target(texpaint,null,null,clear_flag_t_COLOR,0xff000000,0.0);
			}
			render_path_set_target("texpaint_blend1",null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target("texpaint_blend0","tex");
			render_path_draw_shader("shader_datas/copy_pass/copyR8_pass");
			bool is_mask=slot_layer_is_mask(context_raw->layer);
			if(is_mask){
				i32 ptid=context_raw->layer->parent->id;
				if(slot_layer_is_group(context_raw->layer->parent)){
					for(i32 i=0;i<slot_layer_get_children(context_raw->layer->parent)->length;++i){
						slot_layer_t * c=slot_layer_get_children(context_raw->layer->parent)->buffer[i];
						ptid=c->id;
						break;
					}
				}
				string_t_array_t * additional=any_array_create_from_raw((any[]){string_join("texpaint_nor",i32_to_string(ptid)),string_join("texpaint_pack",i32_to_string(ptid)),"texpaint_blend0",},3);
				render_path_set_target(texpaint,additional,null,clear_flag_t_NONE,0,0.0);
			}
			else {
				string_t_array_t * additional=any_array_create_from_raw((any[]){string_join("texpaint_nor",i32_to_string(tid)),string_join("texpaint_pack",i32_to_string(tid)),"texpaint_blend0",},3);
				render_path_set_target(texpaint,additional,null,clear_flag_t_NONE,0,0.0);
			}
			render_path_bind_target("main","gbufferD");
			if((context_raw->xray||config_raw->brush_angle_reject)&&config_raw->brush_3d){
				render_path_bind_target("gbuffer0","gbuffer0");
			}
			render_path_bind_target("texpaint_blend1","paintmask");
			if(context_raw->colorid_picked){
				render_path_bind_target("texpaint_colorid","texpaint_colorid");
			}
			bool read_tc=(context_raw->tool==workspace_tool_t_FILL&&context_raw->fill_type_handle->position==fill_type_t_FACE)||context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE;
			if(read_tc){
				render_path_bind_target("gbuffer2","gbuffer2");
			}
			render_path_draw_meshes("paint");
			if(context_raw->tool==workspace_tool_t_BAKE&&context_raw->bake_type==bake_type_t_CURVATURE&&context_raw->bake_curv_smooth>0){
				if(any_map_get(render_path_render_targets,"texpaint_blur")==null){
					render_target_t * t=render_target_create();
					t->name="texpaint_blur";
					t->width=math_floor(config_get_texture_res_x()*0.95);
					t->height=math_floor(config_get_texture_res_y()*0.95);
					t->format="RGBA32";
					render_path_create_render_target(t);
				}
				i32 blurs=math_round(context_raw->bake_curv_smooth);
				for(i32 i=0;i<blurs;++i){
					render_path_set_target("texpaint_blur",null,null,clear_flag_t_NONE,0,0.0);
					render_path_bind_target(texpaint,"tex");
					render_path_draw_shader("shader_datas/copy_pass/copy_pass");
					render_path_set_target(texpaint,null,null,clear_flag_t_NONE,0,0.0);
					render_path_bind_target("texpaint_blur","tex");
					render_path_draw_shader("shader_datas/copy_pass/copy_pass");
				}
			}
			if(dilation&&config_raw->dilate==dilate_type_t_INSTANT){
				render_path_paint_dilate(true,false);
			}
		}
	}
}

void render_path_paint_use_live_layer(bool use){
	i32 tid=context_raw->layer->id;
	i32 hid=history_undo_i-1<0?config_raw->undo_steps-1:history_undo_i-1;
	if(use){
		gc_unroot(_render_path_paint_texpaint);_render_path_paint_texpaint=any_map_get(render_path_render_targets,string_join("texpaint",i32_to_string(tid)));gc_root(_render_path_paint_texpaint);
		gc_unroot(_render_path_paint_texpaint_undo);_render_path_paint_texpaint_undo=any_map_get(render_path_render_targets,string_join("texpaint_undo",i32_to_string(hid)));gc_root(_render_path_paint_texpaint_undo);
		gc_unroot(_render_path_paint_texpaint_nor_undo);_render_path_paint_texpaint_nor_undo=any_map_get(render_path_render_targets,string_join("texpaint_nor_undo",i32_to_string(hid)));gc_root(_render_path_paint_texpaint_nor_undo);
		gc_unroot(_render_path_paint_texpaint_pack_undo);_render_path_paint_texpaint_pack_undo=any_map_get(render_path_render_targets,string_join("texpaint_pack_undo",i32_to_string(hid)));gc_root(_render_path_paint_texpaint_pack_undo);
		gc_unroot(_render_path_paint_texpaint_nor);_render_path_paint_texpaint_nor=any_map_get(render_path_render_targets,string_join("texpaint_nor",i32_to_string(tid)));gc_root(_render_path_paint_texpaint_nor);
		gc_unroot(_render_path_paint_texpaint_pack);_render_path_paint_texpaint_pack=any_map_get(render_path_render_targets,string_join("texpaint_pack",i32_to_string(tid)));gc_root(_render_path_paint_texpaint_pack);
		any_map_set(render_path_render_targets,string_join("texpaint_undo",i32_to_string(hid)),any_map_get(render_path_render_targets,string_join("texpaint",i32_to_string(tid))));
		any_map_set(render_path_render_targets,string_join("texpaint",i32_to_string(tid)),any_map_get(render_path_render_targets,"texpaint_live"));
		if(slot_layer_is_layer(context_raw->layer)){
			any_map_set(render_path_render_targets,string_join("texpaint_nor_undo",i32_to_string(hid)),any_map_get(render_path_render_targets,string_join("texpaint_nor",i32_to_string(tid))));
			any_map_set(render_path_render_targets,string_join("texpaint_pack_undo",i32_to_string(hid)),any_map_get(render_path_render_targets,string_join("texpaint_pack",i32_to_string(tid))));
			any_map_set(render_path_render_targets,string_join("texpaint_nor",i32_to_string(tid)),any_map_get(render_path_render_targets,"texpaint_nor_live"));
			any_map_set(render_path_render_targets,string_join("texpaint_pack",i32_to_string(tid)),any_map_get(render_path_render_targets,"texpaint_pack_live"));
		}
	}
	else {
		any_map_set(render_path_render_targets,string_join("texpaint",i32_to_string(tid)),_render_path_paint_texpaint);
		any_map_set(render_path_render_targets,string_join("texpaint_undo",i32_to_string(hid)),_render_path_paint_texpaint_undo);
		if(slot_layer_is_layer(context_raw->layer)){
			any_map_set(render_path_render_targets,string_join("texpaint_nor_undo",i32_to_string(hid)),_render_path_paint_texpaint_nor_undo);
			any_map_set(render_path_render_targets,string_join("texpaint_pack_undo",i32_to_string(hid)),_render_path_paint_texpaint_pack_undo);
			any_map_set(render_path_render_targets,string_join("texpaint_nor",i32_to_string(tid)),_render_path_paint_texpaint_nor);
			any_map_set(render_path_render_targets,string_join("texpaint_pack",i32_to_string(tid)),_render_path_paint_texpaint_pack);
		}
	}
	render_path_paint_live_layer_locked=use;
}

void render_path_paint_commands_live_brush(){
	workspace_tool_t tool=context_raw->tool;
	if(tool!=workspace_tool_t_BRUSH&&tool!=workspace_tool_t_ERASER&&tool!=workspace_tool_t_CLONE&&tool!=workspace_tool_t_DECAL&&tool!=workspace_tool_t_TEXT&&tool!=workspace_tool_t_BLUR&&tool!=workspace_tool_t_SMUDGE){
		return ;
	}
	if(render_path_paint_live_layer_locked){
		return ;
	}
	if(render_path_paint_live_layer==null){
		gc_unroot(render_path_paint_live_layer);render_path_paint_live_layer=slot_layer_create("_live",layer_slot_type_t_LAYER,null);gc_root(render_path_paint_live_layer);
	}
	i32 tid=context_raw->layer->id;
	if(slot_layer_is_mask(context_raw->layer)){
		render_path_set_target("texpaint_live",null,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target(string_join("texpaint",i32_to_string(tid)),"tex");
		render_path_draw_shader("shader_datas/copy_pass/copy_pass");
	}
	else {
		string_t_array_t * additional=any_array_create_from_raw((any[]){"texpaint_nor_live","texpaint_pack_live",},2);
		render_path_set_target("texpaint_live",additional,null,clear_flag_t_NONE,0,0.0);
		render_path_bind_target(string_join("texpaint",i32_to_string(tid)),"tex0");
		render_path_bind_target(string_join("texpaint_nor",i32_to_string(tid)),"tex1");
		render_path_bind_target(string_join("texpaint_pack",i32_to_string(tid)),"tex2");
		render_path_draw_shader("shader_datas/copy_mrt3_pass/copy_mrt3_pass");
	}
	render_path_paint_use_live_layer(true);
	render_path_paint_live_layer_drawn=2;
	ui_view2d_hwnd->redraws=2;
	f32 _x=context_raw->paint_vec.x;
	f32 _y=context_raw->paint_vec.y;
	if(context_raw->brush_locked){
		context_raw->paint_vec.x=(context_raw->lock_started_x-sys_x())/(float)sys_w();
		context_raw->paint_vec.y=(context_raw->lock_started_y-sys_y())/(float)sys_h();
	}
	f32 _last_x=context_raw->last_paint_vec_x;
	f32 _last_y=context_raw->last_paint_vec_y;
	i32 _pdirty=context_raw->pdirty;
	context_raw->last_paint_vec_x=context_raw->paint_vec.x;
	context_raw->last_paint_vec_y=context_raw->paint_vec.y;
	if(operator_shortcut(any_map_get(config_keymap,"brush_ruler"),shortcut_type_t_STARTED)){
		context_raw->last_paint_vec_x=context_raw->last_paint_x;
		context_raw->last_paint_vec_y=context_raw->last_paint_y;
	}
	context_raw->pdirty=2;
	render_path_paint_commands_symmetry();
	render_path_paint_commands_paint(true);
	render_path_paint_use_live_layer(false);
	context_raw->paint_vec.x=_x;
	context_raw->paint_vec.y=_y;
	context_raw->last_paint_vec_x=_last_x;
	context_raw->last_paint_vec_y=_last_y;
	context_raw->pdirty=_pdirty;
	context_raw->brush_blend_dirty=true;
}

void render_path_paint_commands_cursor(){
	if(!config_raw->brush_3d){
		return ;
	}
	bool decal_mask=context_is_decal_mask();
	workspace_tool_t tool=context_raw->tool;
	if(tool!=workspace_tool_t_BRUSH&&tool!=workspace_tool_t_ERASER&&tool!=workspace_tool_t_CLONE&&tool!=workspace_tool_t_BLUR&&tool!=workspace_tool_t_SMUDGE&&tool!=workspace_tool_t_PARTICLE&&!decal_mask){
		return ;
	}
	bool fill_layer=context_raw->layer->fill_layer!=null;
	bool group_layer=slot_layer_is_group(context_raw->layer);
	if(!base_ui_enabled||base_is_dragging||fill_layer||group_layer){
		return ;
	}
	f32 mx=context_raw->paint_vec.x;
	f32 my=1.0-context_raw->paint_vec.y;
	if(context_raw->brush_locked){
		mx=(context_raw->lock_started_x-sys_x())/(float)sys_w();
		my=1.0-(context_raw->lock_started_y-sys_y())/(float)sys_h();
	}
	f32 radius=decal_mask?context_raw->brush_decal_mask_radius:context_raw->brush_radius;
	render_path_paint_draw_cursor(mx,my,context_raw->brush_nodes_radius*radius/(float)3.4,1.0,1.0,1.0);
}

void render_path_paint_draw_cursor(f32 mx,f32 my,f32 radius,f32 tint_r,f32 tint_g,f32 tint_b){
	mesh_object_t * plane=scene_get_child(".Plane")->ext;
	mesh_data_t * geom=plane->data;
	render_path_set_target("",null,null,clear_flag_t_NONE,0,0.0);
	gpu_set_pipeline(pipes_cursor);
	render_target_t * rt=any_map_get(render_path_render_targets,"main");
	gpu_texture_t * main=rt->_image;
	gpu_set_texture(pipes_cursor_gbufferd,main);
	gpu_set_float2(pipes_cursor_mouse,mx,my);
	gpu_set_float2(pipes_cursor_tex_step,1/(float)main->width,1/(float)main->height);
	gpu_set_float(pipes_cursor_radius,radius);
	vec4_t right=vec4_norm(camera_object_right_world(scene_camera));
	gpu_set_float3(pipes_cursor_camera_right,right.x,right.y,right.z);
	gpu_set_float3(pipes_cursor_tint,tint_r,tint_g,tint_b);
	gpu_set_matrix4(pipes_cursor_vp,scene_camera->vp);
	mat4_t inv_vp=mat4_inv(scene_camera->vp);
	gpu_set_matrix4(pipes_cursor_inv_vp,inv_vp);
	gpu_set_vertex_buffer(geom->_->vertex_buffer);
	gpu_set_index_buffer(geom->_->index_buffers->buffer[0]);
	gpu_draw();
	render_path_end();
}

void render_path_paint_commands_symmetry(){
	if(context_raw->sym_x||context_raw->sym_y||context_raw->sym_z){
		context_raw->ddirty=2;
		transform_t * t=context_raw->paint_object->base->transform;
		f32 sx=t->scale.x;
		f32 sy=t->scale.y;
		f32 sz=t->scale.z;
		if(context_raw->sym_x){
			t->scale=vec4_create(-sx,sy,sz,1.0);
			transform_build_matrix(t);
			render_path_paint_commands_paint(false);
		}
		if(context_raw->sym_y){
			t->scale=vec4_create(sx,-sy,sz,1.0);
			transform_build_matrix(t);
			render_path_paint_commands_paint(false);
		}
		if(context_raw->sym_z){
			t->scale=vec4_create(sx,sy,-sz,1.0);
			transform_build_matrix(t);
			render_path_paint_commands_paint(false);
		}
		if(context_raw->sym_x&&context_raw->sym_y){
			t->scale=vec4_create(-sx,-sy,sz,1.0);
			transform_build_matrix(t);
			render_path_paint_commands_paint(false);
		}
		if(context_raw->sym_x&&context_raw->sym_z){
			t->scale=vec4_create(-sx,sy,-sz,1.0);
			transform_build_matrix(t);
			render_path_paint_commands_paint(false);
		}
		if(context_raw->sym_y&&context_raw->sym_z){
			t->scale=vec4_create(sx,-sy,-sz,1.0);
			transform_build_matrix(t);
			render_path_paint_commands_paint(false);
		}
		if(context_raw->sym_x&&context_raw->sym_y&&context_raw->sym_z){
			t->scale=vec4_create(-sx,-sy,-sz,1.0);
			transform_build_matrix(t);
			render_path_paint_commands_paint(false);
		}
		t->scale=vec4_create(sx,sy,sz,1.0);
		transform_build_matrix(t);
	}
}

bool render_path_paint_paint_enabled(){
	bool fill_layer=context_raw->layer->fill_layer!=null&&context_raw->tool!=workspace_tool_t_PICKER&&context_raw->tool!=workspace_tool_t_MATERIAL&&context_raw->tool!=workspace_tool_t_COLORID;
	bool group_layer=slot_layer_is_group(context_raw->layer);
	bool gizmo=context_raw->tool==workspace_tool_t_GIZMO;
	return !fill_layer&&!group_layer&&!context_raw->foreground_event&&!gizmo;
}

void render_path_paint_live_brush_dirty(){
	f32 mx=render_path_paint_last_x;
	f32 my=render_path_paint_last_y;
	render_path_paint_last_x=mouse_view_x();
	render_path_paint_last_y=mouse_view_y();
	if(config_raw->brush_live&&context_raw->pdirty<=0){
		bool moved=(mx!=render_path_paint_last_x||my!=render_path_paint_last_y)&&(context_in_viewport()||context_in_2d_view(view_2d_type_t_LAYER));
		if(moved||context_raw->brush_locked){
			context_raw->rdirty=2;
		}
	}
}

void render_path_paint_begin(){
	if(!render_path_paint_dilated){
		render_path_paint_dilate(config_raw->dilate==dilate_type_t_DELAYED,true);
		render_path_paint_dilated=true;
	}
	if(!render_path_paint_paint_enabled()){
		return ;
	}
	render_path_paint_push_undo_last=history_push_undo;
	if(history_push_undo&&history_undo_layers!=null){
		history_paint();
	}
	if(context_raw->paint2d){
		render_path_paint_set_plane_mesh();
	}
	if(render_path_paint_live_layer_drawn>0){
		render_path_paint_live_layer_drawn--;
	}
	if(config_raw->brush_live&&context_raw->pdirty<=0&&context_raw->ddirty<=0&&context_raw->brush_time==0){
		render_path_paint_commands_live_brush();
	}
}

void render_path_paint_end(){
	context_raw->ddirty--;
	context_raw->rdirty--;
	if(!render_path_paint_paint_enabled()){
		return ;
	}
	context_raw->pdirty--;
}

void _render_path_paint_final(){
	context_raw->bake_type=_render_path_paint_bake_type;
	make_material_parse_paint_material(true);
	context_raw->pdirty=1;
	render_path_paint_commands_paint(true);
	context_raw->pdirty=0;
	render_path_paint_baking=false;
}

void _render_path_paint_deriv(){
	context_raw->bake_type=bake_type_t_HEIGHT;
	make_material_parse_paint_material(true);
	context_raw->pdirty=1;
	render_path_paint_commands_paint(true);
	context_raw->pdirty=0;
	if(render_path_paint_push_undo_last){
		history_paint();
	}
	sys_notify_on_init(_render_path_paint_final,null);
}

bool render_path_paint_is_rt_bake(){
	return (context_raw->bake_type==bake_type_t_AO||context_raw->bake_type==bake_type_t_LIGHTMAP||context_raw->bake_type==bake_type_t_BENT_NORMAL||context_raw->bake_type==bake_type_t_THICKNESS);
}

void render_path_paint_update_bake_layer(texture_bits_t bits){
	if(base_bits_handle->position!=texture_bits_t_BITS32){
		base_bits_handle->position=bits;
		slot_layer_resize_and_set_bits(context_raw->layer);
		for(i32 i=0;i<history_undo_layers->length;++i){
			slot_layer_t * l=history_undo_layers->buffer[i];
			slot_layer_resize_and_set_bits(l);
		}
		base_bits_handle->position=texture_bits_t_BITS8;
	}
}

void render_path_paint_draw(){
	if(!render_path_paint_paint_enabled()){
		return ;
	}
	if(config_raw->brush_live&&context_raw->pdirty<=0&&context_raw->ddirty>0&&context_raw->brush_time==0){
		render_path_paint_commands_live_brush();
	}
	if(history_undo_layers!=null){
		render_path_paint_commands_symmetry();
		if(context_raw->pdirty>0){
			render_path_paint_dilated=false;
		}
		if(context_raw->tool==workspace_tool_t_BAKE){
			if(context_raw->bake_type==bake_type_t_NORMAL||context_raw->bake_type==bake_type_t_HEIGHT||context_raw->bake_type==bake_type_t_DERIVATIVE){
				if(!render_path_paint_baking&&context_raw->pdirty>0){
					render_path_paint_update_bake_layer(texture_bits_t_BITS32);
					render_path_paint_baking=true;
					_render_path_paint_bake_type=context_raw->bake_type;
					context_raw->bake_type=context_raw->bake_type==bake_type_t_NORMAL?bake_type_t_NORMAL_OBJECT:bake_type_t_POSITION;
					make_material_parse_paint_material(true);
					mesh_object_t * _paint_object=context_raw->paint_object;
					mesh_object_t * high_poly=project_paint_objects->buffer[context_raw->bake_high_poly];
					bool _visible=high_poly->base->visible;
					high_poly->base->visible=true;
					context_select_paint_object(high_poly);
					render_path_paint_commands_paint(true);
					high_poly->base->visible=_visible;
					if(render_path_paint_push_undo_last){
						history_paint();
					}
					context_select_paint_object(_paint_object);
					if(context_raw->bake_type==bake_type_t_DERIVATIVE){
						sys_notify_on_init(_render_path_paint_deriv,null);
					}
					else {
						sys_notify_on_init(_render_path_paint_final,null);
					}
				}
			}
			else if(context_raw->bake_type==bake_type_t_OBJECTID){
				i32 _layer_filter=context_raw->layer_filter;
				mesh_object_t * _paint_object=context_raw->paint_object;
				bool is_merged=context_raw->merged_object!=null;
				bool _visible=is_merged&&context_raw->merged_object->base->visible;
				context_raw->layer_filter=1;
				if(is_merged){
					context_raw->merged_object->base->visible=false;
				}
				for(i32 i=0;i<project_paint_objects->length;++i){
					mesh_object_t * p=project_paint_objects->buffer[i];
					context_select_paint_object(p);
					render_path_paint_commands_paint(true);
				}
				context_raw->layer_filter=_layer_filter;
				context_select_paint_object(_paint_object);
				if(is_merged)context_raw->merged_object->base->visible=_visible;
			}
			else if(render_path_paint_is_rt_bake()){
				bool dirty=render_path_raytrace_bake_commands(make_material_parse_paint_material);
				if(dirty)ui_header_handle->redraws=2;
				if(config_raw->dilate==dilate_type_t_INSTANT){
					render_path_paint_dilate(true,false);
				}
			}
			else {
				render_path_paint_commands_paint(true);
			}
		}
		else {
			render_path_paint_commands_paint(true);
		}
	}
	if(context_raw->brush_blend_dirty){
		context_raw->brush_blend_dirty=false;
		render_path_set_target("texpaint_blend0",null,null,clear_flag_t_COLOR,0x00000000,0.0);
		render_path_set_target("texpaint_blend1",null,null,clear_flag_t_COLOR,0x00000000,0.0);
		render_path_end();
	}
	if(context_raw->paint2d){
		render_path_paint_restore_plane_mesh();
	}
}

void render_path_paint_set_plane_mesh(){
	context_raw->paint2d_view=true;
	gc_unroot(render_path_paint_painto);render_path_paint_painto=context_raw->paint_object;gc_root(render_path_paint_painto);
	gc_unroot(render_path_paint_visibles);render_path_paint_visibles=u8_array_create_from_raw((u8[]){},0);gc_root(render_path_paint_visibles);
	for(i32 i=0;i<project_paint_objects->length;++i){
		mesh_object_t * p=project_paint_objects->buffer[i];
		u8_array_push(render_path_paint_visibles,p->base->visible);
		p->base->visible=false;
	}
	if(context_raw->merged_object!=null){
		render_path_paint_merged_object_visible=context_raw->merged_object->base->visible;
		context_raw->merged_object->base->visible=false;
	}
	camera_object_t * cam=scene_camera;
	context_raw->saved_camera=mat4_clone(cam->base->transform->local);
	render_path_paint_saved_fov=cam->data->fov;
	viewport_update_camera_type(camera_type_t_PERSPECTIVE);
	mat4_t m=mat4_identity();
	m=mat4_translate(m,0,0,0.5);
	transform_set_matrix(cam->base->transform,m);
	cam->data->fov=base_default_fov;
	camera_object_build_proj(cam,-1.0);
	camera_object_build_mat(cam);
	f32 tw=0.95*ui_view2d_pan_scale;
	f32 tx=ui_view2d_pan_x/(float)ui_view2d_ww;
	f32 ty=ui_view2d_pan_y/(float)sys_h();
	m=mat4_identity();
	m=mat4_scale(m,vec4_create(tw,tw,1,1.0));
	m=mat4_set_loc(m,vec4_create(tx,ty,0,1.0));
	mat4_t m2=mat4_identity();
	m2=mat4_inv(scene_camera->vp);
	m=mat4_mult_mat(m,m2);
	bool tiled=ui_view2d_tiled_show;
	if(tiled&&scene_get_child(".PlaneTiled")==null){
		i16_array_t * posa=i16_array_create_from_raw((i16[]){32767,0,-32767,0,10922,0,-10922,0,10922,0,-32767,0,10922,0,-10922,0,-10922,0,10922,0,-10922,0,-10922,0,-10922,0,10922,0,-32767,0,32767,0,-32767,0,10922,0,10922,0,10922,0,-10922,0,32767,0,-10922,0,10922,0,32767,0,10922,0,10922,0,32767,0,10922,0,10922,0,-10922,0,-10922,0,-32767,0,10922,0,-32767,0,-10922,0,32767,0,-10922,0,10922,0,10922,0,10922,0,-10922,0,-10922,0,-32767,0,-32767,0,-10922,0,-32767,0,-32767,0,10922,0,-32767,0,-10922,0,-10922,0,-10922,0,-32767,0,32767,0,-32767,0,32767,0,-10922,0,10922,0,-10922,0,10922,0,-10922,0,10922,0,10922,0,-10922,0,10922,0,-10922,0,10922,0,-10922,0,32767,0,-32767,0,32767,0,10922,0,10922,0,10922,0,32767,0,-10922,0,32767,0,32767,0,10922,0,32767,0,32767,0,10922,0,32767,0,-10922,0,-10922,0,-10922,0,10922,0,-32767,0,10922,0,32767,0,-10922,0,32767,0,10922,0,10922,0,10922,0,-10922,0,-32767,0,-10922,0,-10922,0,-32767,0,-10922,0,10922,0,-32767,0,10922,0,-10922,0,-10922,0,-10922,0,},216);
		i16_array_t * nora=i16_array_create_from_raw((i16[]){0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,0,-32767,},108);
		i16_array_t * texa=i16_array_create_from_raw((i16[]){32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,32767,32767,32767,0,0,0,},108);
		u32_array_t * inda=u32_array_create_from_raw((u32[]){0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,},54);
		mesh_data_t * raw=GC_ALLOC_INIT(mesh_data_t, {.name=".PlaneTiled",.vertex_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(vertex_array_t, {.attrib="pos",.values=i16_array_create_from_array(posa),.data="short4norm"}),GC_ALLOC_INIT(vertex_array_t, {.attrib="nor",.values=i16_array_create_from_array(nora),.data="short2norm"}),GC_ALLOC_INIT(vertex_array_t, {.attrib="tex",.values=i16_array_create_from_array(texa),.data="short2norm"}),},3),.index_arrays=any_array_create_from_raw((any[]){GC_ALLOC_INIT(index_array_t, {.values=u32_array_create_from_array(inda),.material=0}),},1),.scale_pos=1.5,.scale_tex=1.0});
		mesh_data_t * md=mesh_data_create(raw);
		mesh_object_t * mo=scene_get_child(".Plane")->ext;
		material_data_t_array_t * materials=mo->materials;
		mesh_object_t * o=scene_add_mesh_object(md,materials,null);
		o->base->name=".PlaneTiled";
	}
	gc_unroot(render_path_paint_planeo);render_path_paint_planeo=scene_get_child(tiled?".PlaneTiled":".Plane")->ext;gc_root(render_path_paint_planeo);
	render_path_paint_planeo->base->visible=true;
	context_raw->paint_object=render_path_paint_planeo;
	vec4_t v=vec4_create(0.0,0.0,0.0,1.0);
	v=vec4_create(m.m00,m.m01,m.m02,1.0);
	f32 sx=vec4_len(v);
	render_path_paint_planeo->base->transform->rot=quat_from_euler(-math_pi()/(float)2,0,0);
	render_path_paint_planeo->base->transform->scale=vec4_create(sx,1.0,sx,1.0);
	render_path_paint_planeo->base->transform->scale.z*=config_get_texture_res_y()/(float)config_get_texture_res_x();
	render_path_paint_planeo->base->transform->loc=vec4_create(m.m30,-m.m31,0.0,1.0);
	transform_build_matrix(render_path_paint_planeo->base->transform);
}

void render_path_paint_restore_plane_mesh(){
	context_raw->paint2d_view=false;
	render_path_paint_planeo->base->visible=false;
	render_path_paint_planeo->base->transform->loc=vec4_create(0.0,0.0,0.0,1.0);
	for(i32 i=0;i<project_paint_objects->length;++i){
		project_paint_objects->buffer[i]->base->visible=render_path_paint_visibles->buffer[i];
	}
	if(context_raw->merged_object!=null){
		context_raw->merged_object->base->visible=render_path_paint_merged_object_visible;
	}
	context_raw->paint_object=render_path_paint_painto;
	transform_set_matrix(scene_camera->base->transform,context_raw->saved_camera);
	scene_camera->data->fov=render_path_paint_saved_fov;
	viewport_update_camera_type(context_raw->camera_type);
	camera_object_build_proj(scene_camera,-1.0);
	camera_object_build_mat(scene_camera);
	render_path_base_draw_gbuffer();
}

void render_path_paint_bind_layers(){
	bool is_live=config_raw->brush_live&&render_path_paint_live_layer_drawn>0;
	bool is_material_tool=context_raw->tool==workspace_tool_t_MATERIAL;
	if(is_live||is_material_tool){
		render_path_paint_use_live_layer(true);
	}
	for(i32 i=0;i<project_layers->length;++i){
		slot_layer_t * l=project_layers->buffer[i];
		render_path_bind_target(string_join("texpaint",i32_to_string(l->id)),string_join("texpaint",i32_to_string(l->id)));
		if(slot_layer_is_layer(l)){
			render_path_bind_target(string_join("texpaint_nor",i32_to_string(l->id)),string_join("texpaint_nor",i32_to_string(l->id)));
			render_path_bind_target(string_join("texpaint_pack",i32_to_string(l->id)),string_join("texpaint_pack",i32_to_string(l->id)));
		}
	}
}

void render_path_paint_unbind_layers(){
	bool is_live=config_raw->brush_live&&render_path_paint_live_layer_drawn>0;
	bool is_material_tool=context_raw->tool==workspace_tool_t_MATERIAL;
	if(is_live||is_material_tool){
		render_path_paint_use_live_layer(false);
	}
}

void render_path_paint_dilate(bool base,bool nor_pack){
	if(config_raw->dilate_radius>0&&!context_raw->paint2d){
		util_uv_cache_dilate_map();
		layers_make_temp_img();
		i32 tid=context_raw->layer->id;
		string_t * format=base_bits_handle->position==texture_bits_t_BITS8?"RGBA32":base_bits_handle->position==texture_bits_t_BITS16?"RGBA64":"RGBA128";
		string_t * copy_pass=string_equals(format,"RGBA64")?"copyRGBA64_pass":string_equals(format,"RGBA128")?"copyRGBA128_pass":"copy_pass";
		string_t * dilate_pass=string_equals(format,"RGBA64")?"dilateRGBA64_pass":string_equals(format,"RGBA128")?"dilateRGBA128_pass":"dilate_pass";
		if(base){
			string_t * texpaint="texpaint";
			render_path_set_target("temptex0",null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target(string_join(texpaint,i32_to_string(tid)),"tex");
			render_path_draw_shader(string_join("shader_datas/copy_pass/",copy_pass));
			render_path_set_target(string_join(texpaint,i32_to_string(tid)),null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target("temptex0","tex");
			render_path_draw_shader(string_join("shader_datas/dilate_pass/",dilate_pass));
		}
		if(nor_pack&&!slot_layer_is_mask(context_raw->layer)){
			render_path_set_target("temptex0",null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target(string_join("texpaint_nor",i32_to_string(tid)),"tex");
			render_path_draw_shader(string_join("shader_datas/copy_pass/",copy_pass));
			render_path_set_target(string_join("texpaint_nor",i32_to_string(tid)),null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target("temptex0","tex");
			render_path_draw_shader(string_join("shader_datas/dilate_pass/",dilate_pass));
			render_path_set_target("temptex0",null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target(string_join("texpaint_pack",i32_to_string(tid)),"tex");
			render_path_draw_shader(string_join("shader_datas/copy_pass/",copy_pass));
			render_path_set_target(string_join("texpaint_pack",i32_to_string(tid)),null,null,clear_flag_t_NONE,0,0.0);
			render_path_bind_target("temptex0","tex");
			render_path_draw_shader(string_join("shader_datas/dilate_pass/",dilate_pass));
		}
	}
}

tab_draw_array_t_array_t * ui_base_ext_init_hwnd_tabs(){
	tab_draw_array_t * a0=any_array_create_from_raw((any[]){_draw_callback_create(tab_layers_draw),_draw_callback_create(tab_history_draw),_draw_callback_create(tab_plugins_draw),},3);
	tab_draw_array_t * a1=any_array_create_from_raw((any[]){_draw_callback_create(tab_materials_draw),_draw_callback_create(tab_brushes_draw),_draw_callback_create(tab_particles_draw),},3);
	tab_draw_array_t * a2=any_array_create_from_raw((any[]){_draw_callback_create(tab_browser_draw),_draw_callback_create(tab_textures_draw),_draw_callback_create(tab_meshes_draw),_draw_callback_create(tab_fonts_draw),_draw_callback_create(tab_swatches_draw),_draw_callback_create(tab_script_draw),_draw_callback_create(tab_console_draw),_draw_callback_create(ui_status_draw_version_tab),},8);
	tab_draw_array_t_array_t * r=any_array_create_from_raw((any[]){},0);
	any_array_push(r,a0);
	any_array_push(r,a1);
	any_array_push(r,a2);
	return r;
}

void ui_header_draw_tool_properties(ui_t * ui){
	if(context_raw->tool==workspace_tool_t_COLORID){
		ui_text(tr("Picked Color",null),ui_align_t_LEFT,0x00000000);
		if(context_raw->colorid_picked){
			render_target_t * rt=any_map_get(render_path_render_targets,"texpaint_colorid");
			_ui_image(rt->_image,0xffffffff,64,0,0,0,0);
		}
		ui->enabled=context_raw->colorid_picked;
		if(ui_button(tr("Clear",null),ui_align_t_CENTER,"")){
			context_raw->colorid_picked=false;
			ui_toolbar_handle->redraws=1;
		}
		ui->enabled=true;
		ui_text(tr("Color ID Map",null),ui_align_t_LEFT,0x00000000);
		if(project_asset_names->length>0){
			i32 cid=ui_combo(context_raw->colorid_handle,base_enum_texts("TEX_IMAGE"),tr("Color ID",null),false,ui_align_t_LEFT,true);
			if(context_raw->colorid_handle->changed){
				context_raw->ddirty=2;
				context_raw->colorid_picked=false;
				ui_toolbar_handle->redraws=1;
			}
			_ui_image(project_get_image(project_assets->buffer[cid]),0xffffffff,-1.0,0,0,0,0);
			if(ui->is_hovered){
				ui_tooltip_image(project_get_image(project_assets->buffer[cid]),256);
			}
		}
		if(ui_button(tr("Import",null),ui_align_t_CENTER,"")){
			ui_files_show(string_array_join(path_texture_formats,","),false,true,&ui_header_draw_tool_properties_246099			);
		}
		ui->enabled=context_raw->colorid_picked;
		if(ui_button(tr("To Mask",null),ui_align_t_CENTER,"")){
			if(slot_layer_is_mask(context_raw->layer)){
				context_set_layer(context_raw->layer->parent);
			}
			slot_layer_t * m=layers_new_mask(false,context_raw->layer,-1);
			sys_notify_on_next_frame(&ui_header_draw_tool_properties_246236			,m);
			history_new_white_mask();
		}
		ui->enabled=true;
	}
	else if(context_raw->tool==workspace_tool_t_PICKER||context_raw->tool==workspace_tool_t_MATERIAL){
		f32 base_r_picked=math_round(color_get_rb(context_raw->picked_color->base)/(float)255*10)/(float)10;
		f32 base_g_picked=math_round(color_get_gb(context_raw->picked_color->base)/(float)255*10)/(float)10;
		f32 base_b_picked=math_round(color_get_bb(context_raw->picked_color->base)/(float)255*10)/(float)10;
		f32 normal_r_picked=math_round(color_get_rb(context_raw->picked_color->normal)/(float)255*10)/(float)10;
		f32 normal_g_picked=math_round(color_get_gb(context_raw->picked_color->normal)/(float)255*10)/(float)10;
		f32 normal_b_picked=math_round(color_get_bb(context_raw->picked_color->normal)/(float)255*10)/(float)10;
		f32 occlusion_picked=math_round(context_raw->picked_color->occlusion*100)/(float)100;
		f32 roughness_picked=math_round(context_raw->picked_color->roughness*100)/(float)100;
		f32 metallic_picked=math_round(context_raw->picked_color->metallic*100)/(float)100;
		f32 height_picked=math_round(context_raw->picked_color->height*100)/(float)100;
		f32 opacity_picked=math_round(context_raw->picked_color->opacity*100)/(float)100;
		ui_handle_t * h=ui_handle("ui_header_ext.ts:86");
		i32 color=0xffffffff;
		color=color_set_rb(color,base_r_picked*255);
		color=color_set_gb(color,base_g_picked*255);
		color=color_set_bb(color,base_b_picked*255);
		h->color=color;
		ui_state_t state=ui_text("",0,h->color);
		if(state==ui_state_t_STARTED){
			i32 uix=ui->_x;
			i32 uiy=ui->_y;
			base_drag_off_x=-(mouse_x-uix-ui->_window_x-3);
			base_drag_off_y=-(mouse_y-uiy-ui->_window_y+1);
			gc_unroot(base_drag_swatch);base_drag_swatch=project_clone_swatch(context_raw->picked_color);gc_root(base_drag_swatch);
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Drag and drop picked color to swatches, materials, layers or to the node editor",null));
		}
		if(ui->is_hovered&&ui->input_released){
			gc_unroot(_ui_header_draw_tool_properties_h);_ui_header_draw_tool_properties_h=h;gc_root(_ui_header_draw_tool_properties_h);
			ui_menu_draw(&ui_header_draw_tool_properties_246684			,-1,-1);
		}
		if(ui_button(tr("Add Swatch",null),ui_align_t_CENTER,"")){
			swatch_color_t * new_swatch=project_clone_swatch(context_raw->picked_color);
			context_set_swatch(new_swatch);
			any_array_push(project_raw->swatches,new_swatch);
			ui_base_hwnds->buffer[2]->redraws=1;
		}
		if(ui->is_hovered){
			ui_tooltip(tr("Add picked color to swatches",null));
		}
		ui_text(string_join(string_join(string_join(string_join(string_join(string_join(string_join(tr("Base",null)," ("),f32_to_string(base_r_picked)),","),f32_to_string(base_g_picked)),","),f32_to_string(base_b_picked)),")"),ui_align_t_LEFT,0x00000000);
		ui_text(string_join(string_join(string_join(string_join(string_join(string_join(string_join(tr("Normal",null)," ("),f32_to_string(normal_r_picked)),","),f32_to_string(normal_g_picked)),","),f32_to_string(normal_b_picked)),")"),ui_align_t_LEFT,0x00000000);
		ui_text(string_join(string_join(string_join(tr("Occlusion",null)," ("),f32_to_string(occlusion_picked)),")"),ui_align_t_LEFT,0x00000000);
		ui_text(string_join(string_join(string_join(tr("Roughness",null)," ("),f32_to_string(roughness_picked)),")"),ui_align_t_LEFT,0x00000000);
		ui_text(string_join(string_join(string_join(tr("Metallic",null)," ("),f32_to_string(metallic_picked)),")"),ui_align_t_LEFT,0x00000000);
		ui_text(string_join(string_join(string_join(tr("Height",null)," ("),f32_to_string(height_picked)),")"),ui_align_t_LEFT,0x00000000);
		ui_text(string_join(string_join(string_join(tr("Opacity",null)," ("),f32_to_string(opacity_picked)),")"),ui_align_t_LEFT,0x00000000);
		ui_handle_t * h_select_mat=ui_handle("ui_header_ext.ts:131");
		if(h_select_mat->init){
			h_select_mat->selected=context_raw->picker_select_material;
		}
		context_raw->picker_select_material=ui_check(h_select_mat,tr("Select Material",null),"");
		string_t_array_t * picker_mask_combo=any_array_create_from_raw((any[]){tr("None",null),tr("Material",null),},2);
		ui_combo(context_raw->picker_mask_handle,picker_mask_combo,tr("Mask",null),true,ui_align_t_LEFT,true);
		if(context_raw->picker_mask_handle->changed){
			make_material_parse_paint_material(true);
		}
	}
	else if(context_raw->tool==workspace_tool_t_BAKE){
		ui->changed=false;
		bool baking=context_raw->pdirty>0;
		bool rt_bake=render_path_paint_is_rt_bake();
		if(baking&&ui_button(tr("Stop",null),ui_align_t_CENTER,"")){
			context_raw->pdirty=0;
			context_raw->rdirty=2;
		}
		if(!baking&&ui_button(tr("Bake",null),ui_align_t_CENTER,"")){
			context_raw->pdirty=rt_bake?context_raw->bake_samples:1;
			context_raw->rdirty=3;
			sys_notify_on_next_frame(&ui_header_draw_tool_properties_247075			,null);
			ui_base_hwnds->buffer[0]->redraws=2;
			history_push_undo=true;
			render_path_raytrace_bake_current_sample=0;
		}
		ui_handle_t * bake_handle=ui_handle("ui_header_ext.ts:163");
		if(bake_handle->init){
			bake_handle->position=context_raw->bake_type;
		}
		string_t_array_t * bakes=any_array_create_from_raw((any[]){tr("AO",null),tr("Curvature",null),tr("Normal",null),tr("Object Normal",null),tr("Height",null),tr("Derivative",null),tr("Position",null),tr("TexCoord",null),tr("Material ID",null),tr("Object ID",null),tr("Vertex Color",null),},11);
		if(gpu_raytrace_supported()){
			any_array_push(bakes,tr("Lightmap",null));
			any_array_push(bakes,tr("Bent Normal",null));
			any_array_push(bakes,tr("Thickness",null));
		}
		else {
			array_shift(bakes);
		}
		context_raw->bake_type=ui_combo(bake_handle,bakes,tr("Bake",null),false,ui_align_t_LEFT,true);
		if(!gpu_raytrace_supported()){
			context_raw->bake_type+=1;
		}
		if(rt_bake){
			ui_handle_t * samples_handle=ui_handle("ui_header_ext.ts:196");
			if(samples_handle->init){
				samples_handle->value=context_raw->bake_samples;
			}
			context_raw->bake_samples=math_floor(ui_slider(samples_handle,tr("Samples",null),1,512,true,1,true,ui_align_t_RIGHT,true));
		}
		if(context_raw->bake_type==bake_type_t_NORMAL_OBJECT||context_raw->bake_type==bake_type_t_POSITION||context_raw->bake_type==bake_type_t_BENT_NORMAL){
			ui_handle_t * bake_up_axis_handle=ui_handle("ui_header_ext.ts:207");
			if(bake_up_axis_handle->init){
				bake_up_axis_handle->position=context_raw->bake_up_axis;
			}
			string_t_array_t * bake_up_axis_combo=any_array_create_from_raw((any[]){tr("Z",null),tr("Y",null),},2);
			context_raw->bake_up_axis=ui_combo(bake_up_axis_handle,bake_up_axis_combo,tr("Up Axis",null),true,ui_align_t_LEFT,true);
		}
		if(context_raw->bake_type==bake_type_t_AO||context_raw->bake_type==bake_type_t_CURVATURE){
			ui_handle_t * bake_axis_handle=ui_handle("ui_header_ext.ts:215");
			if(bake_axis_handle->init){
				bake_axis_handle->position=context_raw->bake_axis;
			}
			string_t_array_t * bake_axis_combo=any_array_create_from_raw((any[]){tr("XYZ",null),tr("X",null),tr("Y",null),tr("Z",null),tr("-X",null),tr("-Y",null),tr("-Z",null),},7);
			context_raw->bake_axis=ui_combo(bake_axis_handle,bake_axis_combo,tr("Axis",null),true,ui_align_t_LEFT,true);
		}
		if(context_raw->bake_type==bake_type_t_AO){
			ui_handle_t * strength_handle=ui_handle("ui_header_ext.ts:223");
			if(strength_handle->init){
				strength_handle->value=context_raw->bake_ao_strength;
			}
			context_raw->bake_ao_strength=ui_slider(strength_handle,tr("Strength",null),0.0,2.0,true,100.0,true,ui_align_t_RIGHT,true);
			ui_handle_t * radius_handle=ui_handle("ui_header_ext.ts:228");
			if(radius_handle->init){
				radius_handle->value=context_raw->bake_ao_radius;
			}
			context_raw->bake_ao_radius=ui_slider(radius_handle,tr("Radius",null),0.0,2.0,true,100.0,true,ui_align_t_RIGHT,true);
			ui_handle_t * offset_handle=ui_handle("ui_header_ext.ts:233");
			if(offset_handle->init){
				offset_handle->value=context_raw->bake_ao_offset;
			}
			context_raw->bake_ao_offset=ui_slider(offset_handle,tr("Offset",null),0.0,2.0,true,100.0,true,ui_align_t_RIGHT,true);
		}
		if(rt_bake){
			f32 progress=render_path_raytrace_bake_current_sample/(float)context_raw->bake_samples;
			if(progress>1.0)progress=1.0;
			draw_set_color(ui->ops->theme->SEPARATOR_COL);
			ui_draw_rect(true,ui->_x+1,ui->_y,ui->_w-2,ui_ELEMENT_H(ui));
			draw_set_color(ui->ops->theme->HIGHLIGHT_COL);
			ui_draw_rect(true,ui->_x+1,ui->_y,(ui->_w-2)*progress,ui_ELEMENT_H(ui));
			draw_set_color(0xffffffff);
			ui_text(string_join(string_join(tr("Samples",null),": "),i32_to_string(render_path_raytrace_bake_current_sample)),ui_align_t_LEFT,0x00000000);
			ui_text(string_join(string_join(tr("Rays/pixel",null),": "),i32_to_string(render_path_raytrace_bake_rays_pix)),ui_align_t_LEFT,0x00000000);
			ui_text(string_join(string_join(tr("Rays/second",null),": "),i32_to_string(render_path_raytrace_bake_rays_sec)),ui_align_t_LEFT,0x00000000);
		}
		if(context_raw->bake_type==bake_type_t_CURVATURE){
			ui_handle_t * strength_handle=ui_handle("ui_header_ext.ts:253");
			if(strength_handle->init){
				strength_handle->value=context_raw->bake_curv_strength;
			}
			context_raw->bake_curv_strength=ui_slider(strength_handle,tr("Strength",null),0.0,2.0,true,100.0,true,ui_align_t_RIGHT,true);
			ui_handle_t * radius_handle=ui_handle("ui_header_ext.ts:258");
			if(radius_handle->init){
				radius_handle->value=context_raw->bake_curv_radius;
			}
			context_raw->bake_curv_radius=ui_slider(radius_handle,tr("Radius",null),0.0,2.0,true,100.0,true,ui_align_t_RIGHT,true);
			ui_handle_t * offset_handle=ui_handle("ui_header_ext.ts:263");
			if(offset_handle->init){
				offset_handle->value=context_raw->bake_curv_offset;
			}
			context_raw->bake_curv_offset=ui_slider(offset_handle,tr("Offset",null),-2.0,2.0,true,100.0,true,ui_align_t_RIGHT,true);
			ui_handle_t * smooth_handle=ui_handle("ui_header_ext.ts:268");
			if(smooth_handle->init){
				smooth_handle->value=context_raw->bake_curv_smooth;
			}
			context_raw->bake_curv_smooth=math_floor(ui_slider(smooth_handle,tr("Smooth",null),0,5,false,1,true,ui_align_t_RIGHT,true));
		}
		if(context_raw->bake_type==bake_type_t_NORMAL||context_raw->bake_type==bake_type_t_HEIGHT||context_raw->bake_type==bake_type_t_DERIVATIVE){
			string_t_array_t * ar=any_array_create_from_raw((any[]){},0);
			for(i32 i=0;i<project_paint_objects->length;++i){
				mesh_object_t * p=project_paint_objects->buffer[i];
				any_array_push(ar,p->base->name);
			}
			ui_handle_t * poly_handle=ui_handle("ui_header_ext.ts:280");
			if(poly_handle->init){
				poly_handle->position=context_raw->bake_high_poly;
			}
			context_raw->bake_high_poly=ui_combo(poly_handle,ar,tr("High Poly",null),false,ui_align_t_LEFT,true);
		}
		if(ui->changed){
			make_material_parse_paint_material(true);
		}
	}
	else if(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER||context_raw->tool==workspace_tool_t_FILL||context_raw->tool==workspace_tool_t_DECAL||context_raw->tool==workspace_tool_t_TEXT||context_raw->tool==workspace_tool_t_CLONE||context_raw->tool==workspace_tool_t_BLUR||context_raw->tool==workspace_tool_t_SMUDGE||context_raw->tool==workspace_tool_t_PARTICLE){
		bool decal=context_is_decal();
		bool decal_mask=context_is_decal_mask();
		if(context_raw->tool!=workspace_tool_t_FILL){
			if(decal_mask){
				context_raw->brush_decal_mask_radius=ui_slider(context_raw->brush_decal_mask_radius_handle,tr("Radius",null),0.01,2.0,true,100.0,true,ui_align_t_RIGHT,true);
				if(ui->is_hovered){
					any_map_t * vars=any_map_create();
					any_map_set(vars,"brush_radius",any_map_get(config_keymap,"brush_radius"));
					any_map_set(vars,"brush_radius_decrease",any_map_get(config_keymap,"brush_radius_decrease"));
					any_map_set(vars,"brush_radius_increase",any_map_get(config_keymap,"brush_radius_increase"));
					ui_tooltip(tr("Hold {brush_radius} and move mouse to the left or press {brush_radius_decrease} to decrease the radius\nHold {brush_radius} and move mouse to the right or press {brush_radius_increase} to increase the radius",vars));
				}
			}
			else {
				context_raw->brush_radius=ui_slider(context_raw->brush_radius_handle,tr("Radius",null),0.01,2.0,true,100.0,true,ui_align_t_RIGHT,true);
				if(ui->is_hovered){
					any_map_t * vars=any_map_create();
					any_map_set(vars,"brush_radius",any_map_get(config_keymap,"brush_radius"));
					any_map_set(vars,"brush_radius_decrease",any_map_get(config_keymap,"brush_radius_decrease"));
					any_map_set(vars,"brush_radius_increase",any_map_get(config_keymap,"brush_radius_increase"));
					ui_tooltip(tr("Hold {brush_radius} and move mouse to the left or press {brush_radius_decrease} to decrease the radius\nHold {brush_radius} and move mouse to the right or press {brush_radius_increase} to increase the radius",vars));
				}
			}
		}
		if(context_raw->tool==workspace_tool_t_DECAL||context_raw->tool==workspace_tool_t_TEXT){
			context_raw->brush_scale_x=ui_slider(context_raw->brush_scale_x_handle,tr("Scale X",null),0.01,2.0,true,100.0,true,ui_align_t_RIGHT,true);
		}
		if(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_FILL||context_raw->tool==workspace_tool_t_DECAL||context_raw->tool==workspace_tool_t_TEXT){
			ui_handle_t * brush_scale_handle=ui_handle("ui_header_ext.ts:333");
			if(brush_scale_handle->init){
				brush_scale_handle->value=context_raw->brush_scale;
			}
			context_raw->brush_scale=ui_slider(brush_scale_handle,tr("UV Scale",null),0.01,5.0,true,100.0,true,ui_align_t_RIGHT,true);
			if(brush_scale_handle->changed){
				if(context_raw->tool==workspace_tool_t_DECAL||context_raw->tool==workspace_tool_t_TEXT){
					gpu_texture_t * current=_draw_current;
					draw_end();
					util_render_make_decal_preview();
					draw_begin(current,false,0);
				}
			}
			context_raw->brush_angle=ui_slider(context_raw->brush_angle_handle,tr("Angle",null),0.0,360.0,true,1,true,ui_align_t_RIGHT,true);
			if(ui->is_hovered){
				any_map_t * vars=any_map_create();
				any_map_set(vars,"brush_angle",any_map_get(config_keymap,"brush_angle"));
				ui_tooltip(tr("Hold {brush_angle} and move mouse to the left to decrease the angle\nHold {brush_angle} and move mouse to the right to increase the angle",vars));
			}
			if(context_raw->brush_angle_handle->changed){
				make_material_parse_paint_material(true);
			}
		}
		context_raw->brush_opacity=ui_slider(context_raw->brush_opacity_handle,tr("Opacity",null),0.0,1.0,true,100.0,true,ui_align_t_RIGHT,true);
		if(ui->is_hovered){
			any_map_t * vars=any_map_create();
			any_map_set(vars,"brush_opacity",any_map_get(config_keymap,"brush_opacity"));
			ui_tooltip(tr("Hold {brush_opacity} and move mouse to the left to decrease the opacity\nHold {brush_opacity} and move mouse to the right to increase the opacity",vars));
		}
		if(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_ERASER||context_raw->tool==workspace_tool_t_CLONE||decal_mask){
			ui_handle_t * h=ui_handle("ui_header_ext.ts:367");
			if(h->init){
				h->value=context_raw->brush_hardness;
			}
			context_raw->brush_hardness=ui_slider(h,tr("Hardness",null),0.0,1.0,true,100.0,true,ui_align_t_RIGHT,true);
		}
		if(context_raw->tool!=workspace_tool_t_ERASER){
			ui_handle_t * brush_blending_handle=ui_handle("ui_header_ext.ts:375");
			if(brush_blending_handle->init){
				brush_blending_handle->value=context_raw->brush_blending;
			}
			string_t_array_t * brush_blending_combo=any_array_create_from_raw((any[]){tr("Mix",null),tr("Darken",null),tr("Multiply",null),tr("Burn",null),tr("Lighten",null),tr("Screen",null),tr("Dodge",null),tr("Add",null),tr("Overlay",null),tr("Soft Light",null),tr("Linear Light",null),tr("Difference",null),tr("Subtract",null),tr("Divide",null),tr("Hue",null),tr("Saturation",null),tr("Color",null),tr("Value",null),},18);
			context_raw->brush_blending=ui_combo(brush_blending_handle,brush_blending_combo,tr("Blending",null),false,ui_align_t_LEFT,true);
			if(brush_blending_handle->changed){
				make_material_parse_paint_material(true);
			}
		}
		if(context_raw->tool==workspace_tool_t_BRUSH||context_raw->tool==workspace_tool_t_FILL){
			ui_handle_t * paint_handle=ui_handle("ui_header_ext.ts:406");
			string_t_array_t * texcoord_combo=any_array_create_from_raw((any[]){tr("UV Map",null),tr("Triplanar",null),tr("Project",null),},3);
			context_raw->brush_paint=ui_combo(paint_handle,texcoord_combo,tr("TexCoord",null),false,ui_align_t_LEFT,true);
			if(paint_handle->changed){
				make_material_parse_paint_material(true);
			}
		}
		if(context_raw->tool==workspace_tool_t_TEXT){
			ui_handle_t * h=ui_handle("ui_header_ext.ts:414");
			h->text=string_copy(context_raw->text_tool_text);
			i32 w=ui->_w;
			if(ui->text_selected_handle==h||ui->submit_text_handle==h){
				ui->_w*=3;
			}
			context_raw->text_tool_text=string_copy(ui_text_input(h,"",ui_align_t_LEFT,true,true));
			ui->_w=w;
			if(h->changed){
				gpu_texture_t * current=_draw_current;
				draw_end();
				util_render_make_text_preview();
				util_render_make_decal_preview();
				draw_begin(current,false,0);
			}
		}
		if(context_raw->tool==workspace_tool_t_FILL){
			string_t_array_t * fill_mode_combo=any_array_create_from_raw((any[]){tr("Object",null),tr("Face",null),tr("Angle",null),tr("UV Island",null),},4);
			ui_combo(context_raw->fill_type_handle,fill_mode_combo,tr("Fill Mode",null),false,ui_align_t_LEFT,true);
			if(context_raw->fill_type_handle->changed){
				if(context_raw->fill_type_handle->position==fill_type_t_FACE){
					gpu_texture_t * current=_draw_current;
					draw_end();
					util_uv_cache_triangle_map();
					draw_begin(current,false,0);
				}
				make_material_parse_paint_material(true);
				make_material_parse_mesh_material();
			}
		}
		else {
			i32 _w=ui->_w;
			f32 sc=ui_SCALE(ui);
			bool touch_header=(config_raw->touch_ui&&config_raw->layout->buffer[layout_size_t_HEADER]==1);
			if(touch_header){
				ui->_x-=4*sc;
			}
			ui->_w=math_floor((touch_header?54:60)*sc);
			ui_handle_t * xray_handle=ui_handle("ui_header_ext.ts:458");
			if(xray_handle->init){
				xray_handle->selected=context_raw->xray;
			}
			context_raw->xray=ui_check(xray_handle,tr("X-Ray",null),"");
			if(xray_handle->changed){
				make_material_parse_paint_material(true);
			}
			ui_handle_t * sym_x_handle=ui_handle("ui_header_ext.ts:467");
			if(sym_x_handle->init){
				sym_x_handle->selected=false;
			}
			ui_handle_t * sym_y_handle=ui_handle("ui_header_ext.ts:471");
			if(sym_y_handle->init){
				sym_y_handle->selected=false;
			}
			ui_handle_t * sym_z_handle=ui_handle("ui_header_ext.ts:475");
			if(sym_z_handle->init){
				sym_z_handle->selected=false;
			}
			if(config_raw->layout->buffer[layout_size_t_HEADER]==1){
				if(config_raw->touch_ui){
					ui->_w=math_floor(19*sc);
					context_raw->sym_x=ui_check(sym_x_handle,"","");
					ui->_x-=4*sc;
					context_raw->sym_y=ui_check(sym_y_handle,"","");
					ui->_x-=4*sc;
					context_raw->sym_z=ui_check(sym_z_handle,"","");
					ui->_x-=4*sc;
					ui->_w=math_floor(40*sc);
					string_t * x=tr("X",null);
					string_t * y=tr("Y",null);
					string_t * z=tr("Z",null);
					ui_text(string_join(string_join(x,y),z),ui_align_t_LEFT,0x00000000);
				}
				else {
					ui->_w=math_floor(56*sc);
					ui_text(tr("Symmetry",null),ui_align_t_LEFT,0x00000000);
					ui->_w=math_floor(25*sc);
					context_raw->sym_x=ui_check(sym_x_handle,tr("X",null),"");
					context_raw->sym_y=ui_check(sym_y_handle,tr("Y",null),"");
					context_raw->sym_z=ui_check(sym_z_handle,tr("Z",null),"");
				}
				ui->_w=_w;
			}
			else {
				ui->_w=_w;
				context_raw->sym_x=ui_check(sym_x_handle,string_join(string_join(tr("Symmetry",null)," "),tr("X",null)),"");
				context_raw->sym_y=ui_check(sym_y_handle,string_join(string_join(tr("Symmetry",null)," "),tr("Y",null)),"");
				context_raw->sym_z=ui_check(sym_z_handle,string_join(string_join(tr("Symmetry",null)," "),tr("Z",null)),"");
			}
			if(sym_x_handle->changed||sym_y_handle->changed||sym_z_handle->changed){
				make_material_parse_paint_material(true);
			}
		}
	}
}

void ui_header_draw_tool_properties_247075(){
context_raw->layer_preview_dirty=true;
}

void ui_header_draw_tool_properties_246684(ui_t * ui){
ui_fill(0,0,ui->_w/(float)ui_SCALE(ui),ui->ops->theme->ELEMENT_H*9,ui->ops->theme->SEPARATOR_COL);
			ui->changed=false;
			ui_color_wheel(_ui_header_draw_tool_properties_h,false,-1,10*ui->ops->theme->ELEMENT_H*ui_SCALE(ui),false,null,null);
			if(ui->changed){
				ui_menu_keep_open=true;
			}
}

void ui_header_draw_tool_properties_246236(slot_layer_t * m){
_gpu_begin(m->texpaint,null,null,clear_flag_t_NONE,0,0.0);
			gpu_set_pipeline(pipes_colorid_to_mask);
			render_target_t * rt=any_map_get(render_path_render_targets,"texpaint_colorid");
			gpu_set_texture(pipes_texpaint_colorid,rt->_image);
			gpu_set_texture(pipes_tex_colorid,project_get_image(project_assets->buffer[context_raw->colorid_handle->position]));
			gpu_set_vertex_buffer(const_data_screen_aligned_vb);
			gpu_set_index_buffer(const_data_screen_aligned_ib);
			gpu_draw();
			gpu_end();
			context_raw->colorid_picked=false;
			ui_toolbar_handle->redraws=1;
			ui_header_handle->redraws=1;
			context_raw->layer_preview_dirty=true;
			layers_update_fill_layers();
}

void ui_header_draw_tool_properties_246099(string_t * path){
import_asset_run(path,-1.0,-1.0,true,false,null);
			context_raw->colorid_handle->position=project_asset_names->length-1;
			for(i32 i=0;i<project_assets->length;++i){
				asset_t * a=project_assets->buffer[i];
				if(string_equals(a->file,path)){
					context_raw->colorid_handle->position=array_index_of(project_assets,a);
				}
			}
			context_raw->ddirty=2;
			context_raw->colorid_picked=false;
			ui_toolbar_handle->redraws=1;
			ui_base_hwnds->buffer[2]->redraws=2;
}

void ui_toolbar_ext_draw_tools(ui_t * ui,gpu_texture_t * img,i32 icon_accent,string_t_array_t * keys){
	ui_toolbar_draw_tool(workspace_tool_t_BRUSH,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_ERASER,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_FILL,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_DECAL,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_TEXT,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_CLONE,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_BLUR,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_SMUDGE,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_PARTICLE,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_COLORID,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_PICKER,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_BAKE,ui,img,icon_accent,keys);
	ui_toolbar_draw_tool(workspace_tool_t_MATERIAL,ui,img,icon_accent,keys);
}

void brush_output_node_create_ext(brush_output_node_t * n){
	context_raw->brush_output_node_inst=n;
}

void brush_output_node_parse_inputs(brush_output_node_t * self){
	gpu_texture_t * last_mask=context_raw->brush_mask_image;
	gpu_texture_t * last_stencil=context_raw->brush_stencil_image;
	logic_node_value_t * input0=logic_node_input_get(self->base->inputs->buffer[0]);
	logic_node_value_t * input1=logic_node_input_get(self->base->inputs->buffer[1]);
	logic_node_value_t * input2=logic_node_input_get(self->base->inputs->buffer[2]);
	logic_node_value_t * input3=logic_node_input_get(self->base->inputs->buffer[3]);
	logic_node_value_t * input4=logic_node_input_get(self->base->inputs->buffer[4]);
	logic_node_value_t * input5=logic_node_input_get(self->base->inputs->buffer[5]);
	logic_node_value_t * input6=logic_node_input_get(self->base->inputs->buffer[6]);
	context_raw->paint_vec=input0->_vec4;
	context_raw->brush_nodes_radius=input1->_f32;
	context_raw->brush_nodes_scale=input2->_f32;
	context_raw->brush_nodes_angle=input3->_f32;
	logic_node_value_t * opac=input4;
	if(opac==null){
		opac=GC_ALLOC_INIT(logic_node_value_t, {._f32=1.0});
	}
	if(opac->_str!=null){
		context_raw->brush_mask_image_is_alpha=ends_with(opac->_str,".a");
		opac->_str=string_copy(substring(opac->_str,0,string_last_index_of(opac->_str,".")));
		context_raw->brush_nodes_opacity=1.0;
		i32 index=char_ptr_array_index_of(project_asset_names,opac->_str);
		asset_t * asset=project_assets->buffer[index];
		context_raw->brush_mask_image=project_get_image(asset);
	}
	else {
		context_raw->brush_nodes_opacity=opac->_f32;
		context_raw->brush_mask_image=null;
	}
	context_raw->brush_nodes_hardness=input5->_f32;
	logic_node_value_t * stencil=input6;
	if(stencil==null){
		stencil=GC_ALLOC_INIT(logic_node_value_t, {._f32=1.0});
	}
	if(stencil->_str!=null){
		context_raw->brush_stencil_image_is_alpha=ends_with(stencil->_str,".a");
		stencil->_str=string_copy(substring(stencil->_str,0,string_last_index_of(stencil->_str,".")));
		i32 index=char_ptr_array_index_of(project_asset_names,stencil->_str);
		asset_t * asset=project_assets->buffer[index];
		context_raw->brush_stencil_image=project_get_image(asset);
	}
	else {
		context_raw->brush_stencil_image=null;
	}
	if(last_mask!=context_raw->brush_mask_image||last_stencil!=context_raw->brush_stencil_image){
		make_material_parse_paint_material(true);
	}
	context_raw->brush_directional=self->raw->buttons->buffer[0]->default_value->buffer[0]>0.0;
}

void brush_output_node_run(brush_output_node_t * self,i32 from){
	f32 left=0.0;
	f32 right=1.0;
	f32 top=0.0;
	f32 bottom=1.0;
	if(context_raw->paint2d){
		left=1.0;
		right=(context_raw->split_view?2.0:1.0)+ui_view2d_ww/(float)base_w();
	}
	if(context_is_floating_toolbar()){
		i32 w=ui_toolbar_x()+ui_toolbar_w(false);
		left+=w/(float)sys_w();
		top+=w/(float)sys_h();
	}
	if(context_raw->last_paint_x<0||context_raw->last_paint_y<0){
		context_raw->last_paint_vec_x=context_raw->paint_vec.x;
		context_raw->last_paint_vec_y=context_raw->paint_vec.y;
	}
	if(context_raw->paint_vec.x<left||context_raw->paint_vec.x>right||context_raw->paint_vec.y<top||context_raw->paint_vec.y>bottom){
		return ;
	}
	bool fill_layer=context_raw->layer->fill_layer!=null&&context_raw->tool!=workspace_tool_t_PICKER&&context_raw->tool!=workspace_tool_t_MATERIAL&&context_raw->tool!=workspace_tool_t_COLORID;
	if(fill_layer){
		return ;
	}
	if(slot_layer_is_group(context_raw->layer)){
		return ;
	}
	if(!slot_layer_is_visible(context_raw->layer)&&!context_raw->paint2d){
		return ;
	}
	if(ui_base_ui->is_hovered||base_is_dragging||base_is_resizing||base_is_scrolling()||base_is_combo_selected()){
		return ;
	}
	brush_output_paint(self);
}

void brush_output_paint(brush_output_node_t * self){
	bool down=mouse_down("left")||pen_down("tip");
	if(down&&context_raw->tool==workspace_tool_t_COLORID&&project_assets->length>0){
		context_raw->colorid_picked=true;
		ui_toolbar_handle->redraws=1;
	}
	bool same_spot=context_raw->paint_vec.x==context_raw->last_paint_x&&context_raw->paint_vec.y==context_raw->last_paint_y;
	bool lazy=context_raw->tool==workspace_tool_t_BRUSH&&context_raw->brush_lazy_radius>0;
	if(down&&(same_spot||lazy)){
		context_raw->painted++;
	}
	else {
		context_raw->painted=0;
	}
	context_raw->last_paint_x=context_raw->paint_vec.x;
	context_raw->last_paint_y=context_raw->paint_vec.y;
	if(context_raw->tool==workspace_tool_t_PARTICLE){
		context_raw->painted=0;
	}
	if(context_raw->painted==0){
		brush_output_node_parse_inputs(self);
	}
	if(context_raw->painted<=1){
		context_raw->pdirty=1;
		context_raw->rdirty=2;
	}
}

input_node_t * input_node_create(ui_node_t * raw,f32_array_t * args){
	float_node_t * n=GC_ALLOC_INIT(float_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=input_node_get;
	if(!input_node_registered){
		input_node_registered=true;
		sys_notify_on_update(input_node_update,n);
	}
	return n;
}

void input_node_update(float_node_t * self){
	if(context_raw->split_view){
		context_raw->view_index=mouse_view_x()>base_w()/(float)2?1:0;
	}
	bool decal_mask=context_is_decal_mask_paint();
	bool lazy_paint=context_raw->brush_lazy_radius>0&&(operator_shortcut(any_map_get(config_keymap,"action_paint"),shortcut_type_t_DOWN)||operator_shortcut(string_join(string_join(any_map_get(config_keymap,"brush_ruler"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN)||decal_mask);
	f32 paint_x=mouse_view_x()/(float)sys_w();
	f32 paint_y=mouse_view_y()/(float)sys_h();
	if(mouse_started("left")){
		input_node_start_x=mouse_view_x()/(float)sys_w();
		input_node_start_y=mouse_view_y()/(float)sys_h();
	}
	if(pen_down("tip")){
		paint_x=pen_view_x()/(float)sys_w();
		paint_y=pen_view_y()/(float)sys_h();
	}
	if(pen_started("tip")){
		input_node_start_x=pen_view_x()/(float)sys_w();
		input_node_start_y=pen_view_y()/(float)sys_h();
	}
	if(operator_shortcut(string_join(string_join(any_map_get(config_keymap,"brush_ruler"),"+"),any_map_get(config_keymap,"action_paint")),shortcut_type_t_DOWN)){
		if(input_node_lock_x){
			paint_x=input_node_start_x;
		}
		if(input_node_lock_y){
			paint_y=input_node_start_y;
		}
	}
	if(context_raw->brush_lazy_radius>0){
		context_raw->brush_lazy_x=paint_x;
		context_raw->brush_lazy_y=paint_y;
	}
	if(!lazy_paint){
		input_node_coords.x=paint_x;
		input_node_coords.y=paint_y;
	}
	if(context_raw->split_view){
		context_raw->view_index=-1;
	}
	if(input_node_lock_begin){
		f32 dx=math_abs(input_node_lock_start_x-mouse_view_x());
		f32 dy=math_abs(input_node_lock_start_y-mouse_view_y());
		if(dx>1||dy>1){
			input_node_lock_begin=false;
			if(dx>dy){
				input_node_lock_y=true;
			}
			else {
				input_node_lock_x=true;
			}
		}
	}
	if(keyboard_started(any_map_get(config_keymap,"brush_ruler"))){
		input_node_lock_start_x=mouse_view_x();
		input_node_lock_start_y=mouse_view_y();
		input_node_lock_begin=true;
	}
	else if(keyboard_released(any_map_get(config_keymap,"brush_ruler"))){
		input_node_lock_x=input_node_lock_y=input_node_lock_begin=false;
	}
	if(context_raw->brush_lazy_radius>0){
		vec4_t v1=vec4_create(context_raw->brush_lazy_x*sys_w(),context_raw->brush_lazy_y*sys_h(),0.0,1.0);
		vec4_t v2=vec4_create(input_node_coords.x*sys_w(),input_node_coords.y*sys_h(),0.0,1.0);
		f32 d=vec4_dist(v1,v2);
		f32 r=context_raw->brush_lazy_radius*85;
		if(d>r){
			vec4_t v3=vec4_create(0.0,0.0,0.0,1.0);
			v3=vec4_sub(v2,v1);
			v3=vec4_norm(v3);
			v3=vec4_mult(v3,1.0-context_raw->brush_lazy_step);
			v3=vec4_mult(v3,r);
			v2=vec4_add(v1,v3);
			input_node_coords.x=v2.x/(float)sys_w();
			input_node_coords.y=v2.y/(float)sys_h();
			context_raw->painted=-1;
		}
		context_raw->last_paint_x=-1;
		context_raw->last_paint_y=-1;
	}
	context_raw->parse_brush_inputs(context_raw->brush_output_node_inst);
}

logic_node_value_t * input_node_get(input_node_t * self,i32 from){
	context_raw->brush_lazy_radius=logic_node_input_get(self->base->inputs->buffer[0])->_f32;
	context_raw->brush_lazy_step=logic_node_input_get(self->base->inputs->buffer[1])->_f32;
	logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._vec4=input_node_coords});
	return v;
}

tex_image_node_t * tex_image_node_create(ui_node_t * raw,f32_array_t * args){
	tex_image_node_t * n=GC_ALLOC_INIT(tex_image_node_t, {0});
	n->base=logic_node_create(n);
	n->base->get=tex_image_node_get;
	n->raw=raw;
	return n;
}

logic_node_value_t * tex_image_node_get(tex_image_node_t * self,i32 from){
	string_t_array_t * ar=ui_nodes_enum_texts(self->raw->type);
	i32 i=self->raw->buttons->buffer[0]->default_value->buffer[0];
	string_t * file=ar->buffer[i];
	if(from==0){
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._str=string_join(file,".rgb")});
		return v;
	}
	else {
		logic_node_value_t * v=GC_ALLOC_INIT(logic_node_value_t, {._str=string_join(file,".a")});
		return v;
	}
}

void _main(){
	iron_set_app_name(manifest_title);
	config_load();
	gc_unroot(sys_on_resize);sys_on_resize=base_on_resize;gc_root(sys_on_resize);
	gc_unroot(sys_on_w);sys_on_w=base_w;gc_root(sys_on_w);
	gc_unroot(sys_on_h);sys_on_h=base_h;gc_root(sys_on_h);
	gc_unroot(sys_on_x);sys_on_x=base_x;gc_root(sys_on_x);
	gc_unroot(sys_on_y);sys_on_y=base_y;gc_root(sys_on_y);
	config_init();
	context_init();
	sys_start(config_get_options());
	if(config_raw->layout==null){
		base_init_layout();
	}
	iron_set_app_name(manifest_title);
	sys_init();
	scene_set_active("Scene");
	uniforms_ext_init();
	render_path_base_init();
	render_path_deferred_init();
	if(context_raw->render_mode==render_mode_t_FORWARD){
		render_path_forward_init();
		gc_unroot(render_path_commands);render_path_commands=render_path_forward_commands;gc_root(render_path_commands);
	}
	else {
		gc_unroot(render_path_commands);render_path_commands=render_path_deferred_commands;gc_root(render_path_commands);
	}
	base_init();
}

